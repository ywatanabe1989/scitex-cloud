<!-- ---
!-- Timestamp: 2025-11-04 13:50:46
!-- Author: ywatanabe
!-- File: /home/ywatanabe/proj/scitex-cloud/RULES/00_DJANGO_ORGANIZATION_FULLSTACK.md
!-- --- -->

## DO NOT EDIT THIS FILE ITSELF. PLEASE WORK ON YOUR OWN TODO LIST. THIS FILE IS EDITABLE ONLY BY USER.

# Django Full-Stack Organization Guidelines - Ultimate Edition

## Philosophy

This document establishes a **complete 1:1:1:1 correspondence** across the entire Django stack:
```
Frontend:  HTML ←→ CSS ←→ TypeScript
Backend:   View ←→ Service ←→ Model
```

Every feature has corresponding files at every layer, making the codebase self-documenting through its structure.

---

## Core Principles

1. **Perfect Correspondence**: Every template has a matching view, service, and model
2. **Functional Grouping**: Organize by feature/domain, never by technical layer
3. **Self-Documenting Structure**: File paths reveal functionality
4. **No Premature Abstraction**: Extract common code only after 3 uses
5. **Enforced Through Automation**: Structure validated on every commit

---

## User Comments
1. No inline styles. No exception. Factor out to css files
2. Form follows function. Structure and rules are crucial for powerful software and maintainers.

---

## Complete Directory Structure
```
project_root/
│
├── templates/                                 # Global templates
│   ├── global_base.html                       # Base for all apps
│   └── global_base_partials/
│       ├── _header.html
│       └── _footer.html
│
├── static/                                    # Global static files
│   ├── css/
│   │   └── common/                            # All-app CSS
│   │       ├── variables.css
│   │       ├── buttons.css
│   │       └── forms.css
│   ├── js/
│   │   └── common/                            # All-app JS
│   │       ├── api.js
│   │       └── ui.js
│   └── images/
│       └── icons/
│
└── apps/
    ├── core/                                  # Utilities app
    │   ├── decorators.py
    │   ├── utils.py
    │   ├── middleware.py
    │   └── management/
    │       └── commands/
    │           ├── check_structure.py         # Structure validation
    │           └── check_backend.py           # Backend validation
    │
    └── project_app/                           # Example app
        │
        ├── models/                            # Database layer
        │   ├── __init__.py                    # Export all models
        │   │
        │   ├── repository/                    # Feature: repository
        │   │   ├── __init__.py
        │   │   ├── project.py                 # Project model
        │   │   ├── file.py                    # File model
        │   │   └── commit.py                  # Commit model
        │   │
        │   ├── pull_requests/                 # Feature: pull requests
        │   │   ├── __init__.py
        │   │   ├── pull_request.py            # PullRequest model
        │   │   └── review.py                  # Review model
        │   │
        │   └── issues/                        # Feature: issues
        │       ├── __init__.py
        │       ├── issue.py                   # Issue model
        │       └── comment.py                 # Comment model
        │
        ├── services/                          # Business logic layer
        │   ├── __init__.py                    # Export common services
        │   │
        │   ├── repository/                    # Feature: repository
        │   │   ├── __init__.py
        │   │   ├── file_service.py            # File operations
        │   │   ├── git_service.py             # Git operations
        │   │   └── diff_service.py            # Diff generation
        │   │
        │   ├── pull_requests/                 # Feature: pull requests
        │   │   ├── __init__.py
        │   │   ├── pr_service.py              # PR operations
        │   │   └── merge_service.py           # Merge logic
        │   │
        │   └── issues/                        # Feature: issues
        │       ├── __init__.py
        │       └── issue_service.py           # Issue operations
        │
        ├── views/                             # HTTP request/response layer
        │   ├── __init__.py                    # Export common views
        │   │
        │   ├── repository/                    # Feature: repository
        │   │   ├── __init__.py
        │   │   ├── browse.py                  # Browse view
        │   │   ├── file_view.py               # File view
        │   │   ├── file_edit.py               # File edit view
        │   │   └── commit_detail.py           # Commit detail view
        │   │
        │   ├── pull_requests/                 # Feature: pull requests
        │   │   ├── __init__.py
        │   │   ├── list.py                    # PR list view
        │   │   ├── detail.py                  # PR detail view
        │   │   └── form.py                    # PR form view
        │   │
        │   └── issues/                        # Feature: issues
        │       ├── __init__.py
        │       ├── list.py                    # Issue list view
        │       ├── detail.py                  # Issue detail view
        │       └── form.py                    # Issue form view
        │
        ├── api/                               # API layer (if REST/GraphQL)
        │   ├── __init__.py
        │   │
        │   ├── repository/
        │   │   ├── __init__.py
        │   │   ├── serializers.py             # DRF serializers
        │   │   └── viewsets.py                # DRF viewsets
        │   │
        │   ├── pull_requests/
        │   │   ├── __init__.py
        │   │   ├── serializers.py
        │   │   └── viewsets.py
        │   │
        │   └── issues/
        │       ├── __init__.py
        │       ├── serializers.py
        │       └── viewsets.py
        │
        ├── forms/                             # Django forms layer
        │   ├── __init__.py
        │   │
        │   ├── repository/
        │   │   ├── __init__.py
        │   │   └── file_forms.py              # File-related forms
        │   │
        │   ├── pull_requests/
        │   │   ├── __init__.py
        │   │   └── pr_forms.py                # PR forms
        │   │
        │   └── issues/
        │       ├── __init__.py
        │       └── issue_forms.py             # Issue forms
        │
        ├── tests/                             # Test layer
        │   ├── __init__.py
        │   │
        │   ├── models/                        # Model tests
        │   │   ├── test_repository.py
        │   │   ├── test_pull_requests.py
        │   │   └── test_issues.py
        │   │
        │   ├── services/                      # Service tests
        │   │   ├── test_file_service.py
        │   │   ├── test_pr_service.py
        │   │   └── test_issue_service.py
        │   │
        │   └── views/                         # View tests
        │       ├── test_browse.py
        │       ├── test_pr_list.py
        │       └── test_issue_list.py
        │
        ├── templates/project_app/             # Frontend templates
        │   ├── base/
        │   │   └── app_base.html              # App-level base
        │   │
        │   ├── shared/                        # App-wide shared partials
        │   │   ├── _sidebar.html
        │   │   ├── _tabs.html
        │   │   └── _breadcrumb.html
        │   │
        │   ├── repository/                    # Feature: repository
        │   │   ├── browse.html                # ← Corresponds to views/repository/browse.py
        │   │   ├── browse/
        │   │   │   ├── _header.html
        │   │   │   ├── _toolbar.html
        │   │   │   └── _file_tree.html
        │   │   │
        │   │   ├── file_view.html             # ← Corresponds to views/repository/file_view.py
        │   │   ├── file_edit.html             # ← Corresponds to views/repository/file_edit.py
        │   │   └── commit_detail.html         # ← Corresponds to views/repository/commit_detail.py
        │   │
        │   ├── pull_requests/                 # Feature: pull requests
        │   │   ├── list.html                  # ← Corresponds to views/pull_requests/list.py
        │   │   ├── detail.html                # ← Corresponds to views/pull_requests/detail.py
        │   │   └── form.html                  # ← Corresponds to views/pull_requests/form.py
        │   │
        │   └── issues/                        # Feature: issues
        │       ├── list.html                  # ← Corresponds to views/issues/list.py
        │       ├── detail.html                # ← Corresponds to views/issues/detail.py
        │       └── form.html                  # ← Corresponds to views/issues/form.py
        │
        ├── static/project_app/                # Frontend static files
        │   ├── css/
        │   │   ├── shared/
        │   │   │   ├── sidebar.css
        │   │   │   └── tabs.css
        │   │   │
        │   │   ├── repository/
        │   │   │   ├── browse.css             # ← Corresponds to templates/.../browse.html
        │   │   │   ├── browse/
        │   │   │   │   ├── header.css
        │   │   │   │   ├── toolbar.css
        │   │   │   │   └── file-tree.css
        │   │   │   ├── file_view.css
        │   │   │   ├── file_edit.css
        │   │   │   └── commit_detail.css
        │   │   │
        │   │   ├── pull_requests/
        │   │   │   ├── list.css
        │   │   │   ├── detail.css
        │   │   │   └── form.css
        │   │   │
        │   │   └── issues/
        │   │       ├── list.css
        │   │       ├── detail.css
        │   │       └── form.css
        │   │
        │   ├── ts/
        │   │   ├── shared/
        │   │   │   ├── Sidebar.ts
        │   │   │   └── Tabs.ts
        │   │   │
        │   │   ├── repository/
        │   │   │   ├── browse.ts              # ← Corresponds to templates/.../browse.html
        │   │   │   ├── browse/
        │   │   │   │   ├── Toolbar.ts
        │   │   │   │   └── FileTree.ts
        │   │   │   ├── file_view.ts
        │   │   │   ├── file_edit.ts
        │   │   │   └── commit_detail.ts
        │   │   │
        │   │   ├── pull_requests/
        │   │   │   ├── list.ts
        │   │   │   ├── detail.ts
        │   │   │   └── form.ts
        │   │   │
        │   │   └── issues/
        │   │       ├── list.ts
        │   │       ├── detail.ts
        │   │       └── form.ts
        │   │
        │   ├── js/                            # Compiled from ts/
        │   │   └── (mirrors ts/ structure)
        │   │
        │   ├── tsconfig.json
        │   └── icons/
        │
        ├── urls/                              # URL routing layer
        │   ├── __init__.py                    # Main URL config
        │   ├── repository.py                  # Repository URLs
        │   ├── pull_requests.py               # PR URLs
        │   └── issues.py                      # Issue URLs
        │
        ├── admin/                             # Django admin layer
        │   ├── __init__.py
        │   ├── repository.py                  # Repository admin
        │   ├── pull_requests.py               # PR admin
        │   └── issues.py                      # Issue admin
        │
        ├── migrations/                        # Database migrations
        │   └── 0001_initial.py
        │
        ├── management/                        # Management commands
        │   └── commands/
        │       └── seed_data.py
        │
        ├── apps.py                            # App configuration
        ├── signals.py                         # Django signals
        └── README.md                          # App documentation
```

---

## Perfect Correspondence Rules

### Rule 1: Complete Stack Alignment

Every feature must have files at **every layer**:
```
Feature: repository/browse

Frontend:
  templates/project_app/repository/browse.html
  static/project_app/css/repository/browse.css
  static/project_app/ts/repository/browse.ts
  static/project_app/js/repository/browse.js (compiled)

Backend:
  views/repository/browse.py
  services/repository/file_service.py (used by view)
  models/repository/project.py (used by service)
  forms/repository/file_forms.py (used by view)
  urls/repository.py (routes to view)

Testing:
  tests/views/test_browse.py
  tests/services/test_file_service.py
  tests/models/test_repository.py
```

### Rule 2: Layer Responsibilities

Each layer has **one responsibility only**:

#### Models Layer
```python
# models/repository/project.py

from django.db import models

class Project(models.Model):
    """Data structure only - no business logic"""
    name = models.CharField(max_length=200)
    description = models.TextField()
    created_at = models.DateTimeField(auto_now_add=True)
    
    class Meta:
        db_table = 'project_app_project'
        ordering = ['-created_at']
    
    def __str__(self):
        return self.name
```

**Models should:**
- Define data structure
- Have basic properties/methods
- Use `Meta` for DB configuration

**Models should NOT:**
- Contain business logic
- Make API calls
- Send emails
- Process complex data

#### Services Layer
```python
# services/repository/file_service.py

from django.core.exceptions import ValidationError
from ...models.repository import Project, File

class FileService:
    """Business logic for file operations"""
    
    @staticmethod
    def create_file(project_id, filename, content, user):
        """Create a new file with validation"""
        # Validate
        if not filename:
            raise ValidationError("Filename required")
        
        project = Project.objects.get(id=project_id)
        
        # Business logic
        file = File.objects.create(
            project=project,
            filename=filename,
            content=content,
            created_by=user
        )
        
        # Additional operations
        FileService._notify_collaborators(file)
        FileService._index_for_search(file)
        
        return file
    
    @staticmethod
    def _notify_collaborators(file):
        """Private helper method"""
        # Notification logic
        pass
    
    @staticmethod
    def _index_for_search(file):
        """Private helper method"""
        # Search indexing logic
        pass
```

**Services should:**
- Contain all business logic
- Orchestrate multiple models
- Handle validation
- Be stateless (use static methods or dependency injection)
- Be reusable across views/API/commands

**Services should NOT:**
- Handle HTTP requests/responses
- Render templates
- Access `request` object directly

#### Views Layer
```python
# views/repository/browse.py

from django.shortcuts import render, get_object_or_404
from django.contrib.auth.decorators import login_required
from django.http import JsonResponse

from ...models.repository import Project
from ...services.repository import FileService
from ...forms.repository import FileUploadForm

@login_required
def browse(request, owner, name):
    """Browse repository files - handles HTTP only"""
    project = get_object_or_404(Project, owner=owner, name=name)
    
    # Use service for business logic
    files = FileService.get_file_tree(project)
    
    # Handle form submission
    if request.method == 'POST':
        form = FileUploadForm(request.POST, request.FILES)
        if form.is_valid():
            # Delegate to service
            FileService.create_file(
                project_id=project.id,
                filename=form.cleaned_data['filename'],
                content=form.cleaned_data['content'],
                user=request.user
            )
            return JsonResponse({'status': 'success'})
    else:
        form = FileUploadForm()
    
    # Render template
    return render(request, 'project_app/repository/browse.html', {
        'project': project,
        'files': files,
        'form': form,
    })
```

**Views should:**
- Handle HTTP request/response
- Validate permissions/authentication
- Call services for business logic
- Render templates
- Be thin (< 50 lines)

**Views should NOT:**
- Contain business logic
- Directly manipulate models (use services)
- Have complex calculations

#### Forms Layer
```python
# forms/repository/file_forms.py

from django import forms
from ...models.repository import File

class FileUploadForm(forms.ModelForm):
    """Form for file upload - validation only"""
    
    class Meta:
        model = File
        fields = ['filename', 'content']
    
    def clean_filename(self):
        """Custom validation"""
        filename = self.cleaned_data['filename']
        if not filename.endswith(('.py', '.js', '.html')):
            raise forms.ValidationError("Invalid file type")
        return filename
```

**Forms should:**
- Handle form validation
- Clean/normalize data
- Define form widgets

**Forms should NOT:**
- Contain business logic
- Save data directly (views/services do this)

### Rule 3: Import Hierarchy
```
Models ← Services ← Views/Forms/API
  ↑         ↑          ↑
  └─────────┴──────────┘
     Can import from lower layers only
```

**Allowed:**
```python
# ✓ Services can import models
from ...models.repository import Project

# ✓ Views can import services
from ...services.repository import FileService

# ✓ Views can import models (for simple queries)
from ...models.repository import Project
```

**Not Allowed:**
```python
# ✗ Models cannot import services
from ...services.repository import FileService  # WRONG

# ✗ Models cannot import views
from ...views.repository import browse  # WRONG

# ✗ Services cannot import views
from ...views.repository import browse  # WRONG
```

### Rule 4: String References in Models

**Use string references to avoid circular imports:**
```python
# models/repository/project.py

class Project(models.Model):
    # ✓ String reference to model in same app
    owner = models.ForeignKey('User', on_delete=models.CASCADE)
    
    # ✓ String reference to model in another app
    organization = models.ForeignKey('organizations_app.Organization', 
                                    on_delete=models.CASCADE)
    
    # ✓ String reference to model in same feature group
    files = models.ManyToManyField('File', related_name='projects')
```
```python
# models/__init__.py - Central export point

from .repository.project import Project
from .repository.file import File
from .repository.commit import Commit
from .pull_requests.pull_request import PullRequest
from .pull_requests.review import Review
from .issues.issue import Issue
from .issues.comment import Comment

__all__ = [
    'Project',
    'File',
    'Commit',
    'PullRequest',
    'Review',
    'Issue',
    'Comment',
]
```

**Then import anywhere as:**
```python
from apps.project_app.models import Project, File
```

### Rule 5: URL Organization
```python
# urls/__init__.py

from django.urls import path, include

app_name = 'project_app'

urlpatterns = [
    path('repository/', include('apps.project_app.urls.repository')),
    path('pull-requests/', include('apps.project_app.urls.pull_requests')),
    path('issues/', include('apps.project_app.urls.issues')),
]
```
```python
# urls/repository.py

from django.urls import path
from ..views.repository import browse, file_view, file_edit, commit_detail

urlpatterns = [
    path('<str:owner>/<str:name>/', browse, name='browse'),
    path('<str:owner>/<str:name>/file/<path:filepath>/', file_view, name='file_view'),
    path('<str:owner>/<str:name>/edit/<path:filepath>/', file_edit, name='file_edit'),
    path('<str:owner>/<str:name>/commit/<str:hash>/', commit_detail, name='commit_detail'),
]
```

**URL naming convention:**
```python
# In templates
{% url 'project_app:browse' owner='user' name='repo' %}
{% url 'project_app:file_view' owner='user' name='repo' filepath='src/main.py' %}
```

### Rule 6: Testing Structure
```python
# tests/views/test_browse.py

from django.test import TestCase, Client
from django.urls import reverse
from apps.project_app.models import Project, User

class BrowseViewTest(TestCase):
    def setUp(self):
        self.client = Client()
        self.user = User.objects.create_user('testuser', 'test@test.com', 'pass')
        self.project = Project.objects.create(
            name='test-repo',
            owner=self.user
        )
    
    def test_browse_view_renders(self):
        """Test browse view returns 200"""
        self.client.login(username='testuser', password='pass')
        url = reverse('project_app:browse', kwargs={
            'owner': self.user.username,
            'name': self.project.name
        })
        response = self.client.get(url)
        self.assertEqual(response.status_code, 200)
        self.assertTemplateUsed(response, 'project_app/repository/browse.html')
    
    def test_browse_view_requires_auth(self):
        """Test browse view requires authentication"""
        url = reverse('project_app:browse', kwargs={
            'owner': self.user.username,
            'name': self.project.name
        })
        response = self.client.get(url)
        self.assertEqual(response.status_code, 302)  # Redirect to login
```
```python
# tests/services/test_file_service.py

from django.test import TestCase
from apps.project_app.models import Project, User
from apps.project_app.services.repository import FileService

class FileServiceTest(TestCase):
    def setUp(self):
        self.user = User.objects.create_user('testuser', 'test@test.com', 'pass')
        self.project = Project.objects.create(name='test-repo', owner=self.user)
    
    def test_create_file(self):
        """Test file creation through service"""
        file = FileService.create_file(
            project_id=self.project.id,
            filename='test.py',
            content='print("hello")',
            user=self.user
        )
        self.assertIsNotNone(file.id)
        self.assertEqual(file.filename, 'test.py')
    
    def test_create_file_validation(self):
        """Test file creation validation"""
        with self.assertRaises(ValidationError):
            FileService.create_file(
                project_id=self.project.id,
                filename='',  # Invalid
                content='test',
                user=self.user
            )
```
```python
# tests/models/test_repository.py

from django.test import TestCase
from apps.project_app.models import Project, User

class ProjectModelTest(TestCase):
    def setUp(self):
        self.user = User.objects.create_user('testuser', 'test@test.com', 'pass')
    
    def test_project_creation(self):
        """Test basic project creation"""
        project = Project.objects.create(
            name='test-repo',
            owner=self.user,
            description='Test project'
        )
        self.assertEqual(str(project), 'test-repo')
        self.assertEqual(project.owner, self.user)
```

### Rule 7: Admin Organization
```python
# admin/__init__.py

from django.contrib import admin
from .repository import ProjectAdmin, FileAdmin
from .pull_requests import PullRequestAdmin
from .issues import IssueAdmin

# Automatically register on import
```
```python
# admin/repository.py

from django.contrib import admin
from ..models.repository import Project, File

@admin.register(Project)
class ProjectAdmin(admin.ModelAdmin):
    list_display = ['name', 'owner', 'created_at']
    search_fields = ['name', 'description']
    list_filter = ['created_at']

@admin.register(File)
class FileAdmin(admin.ModelAdmin):
    list_display = ['filename', 'project', 'created_at']
    search_fields = ['filename', 'content']
    list_filter = ['project', 'created_at']
```

---

## File Splitting Guidelines

### When to Split
```
Single file < 200 lines:
  → Keep as single file

Single file > 300 lines:
  → Split into multiple files or subdirectories
```

### How to Split Models
```python
# Before: models.py (1000 lines)
class Project(models.Model): pass
class File(models.Model): pass
class Commit(models.Model): pass
class PullRequest(models.Model): pass
class Issue(models.Model): pass

# After: models/
models/
├── __init__.py              # Export all
├── repository/
│   ├── __init__.py
│   ├── project.py           # Project model only
│   ├── file.py              # File model only
│   └── commit.py            # Commit model only
├── pull_requests/
│   └── pull_request.py
└── issues/
    └── issue.py
```

### How to Split Services
```python
# Before: services.py (800 lines)
class ProjectService: pass
class FileService: pass
class GitService: pass

# After: services/repository/
services/repository/
├── __init__.py
├── project_service.py       # Project operations
├── file_service.py          # File operations
└── git_service.py           # Git operations
```

### How to Split Views
```python
# Before: views.py (600 lines)
def browse(request): pass
def file_view(request): pass
def file_edit(request): pass

# After: views/repository/
views/repository/
├── __init__.py
├── browse.py                # Browse view only
├── file_view.py             # File view only
└── file_edit.py             # File edit only
```

---

## Terminology Standards

| Term      | Usage                        | Location                                                  |
|-----------|------------------------------|-----------------------------------------------------------|
| `common/` | All apps                     | `static/css/common/`, `static/js/common/`                 |
| `shared/` | Multiple features in one app | `templates/xxx_app/shared/`, `static/xxx_app/css/shared/` |
| `base/`   | Base templates               | `templates/xxx_app/base/app_base.html`                    |
| `core/`   | Utility Django app           | `apps/core/`                                              |

---

## API Layer (Optional - DRF)

If using Django REST Framework:
```python
# api/repository/serializers.py

from rest_framework import serializers
from ...models.repository import Project, File

class ProjectSerializer(serializers.ModelSerializer):
    class Meta:
        model = Project
        fields = ['id', 'name', 'description', 'created_at']

class FileSerializer(serializers.ModelSerializer):
    class Meta:
        model = File
        fields = ['id', 'filename', 'content', 'created_at']
```
```python
# api/repository/viewsets.py

from rest_framework import viewsets
from rest_framework.permissions import IsAuthenticated

from ...models.repository import Project
from ...services.repository import FileService
from .serializers import ProjectSerializer

class ProjectViewSet(viewsets.ModelViewSet):
    """API for projects - thin layer over service"""
    queryset = Project.objects.all()
    serializer_class = ProjectSerializer
    permission_classes = [IsAuthenticated]
    
    def perform_create(self, serializer):
        # Delegate to service
        project = FileService.create_project(
            name=serializer.validated_data['name'],
            description=serializer.validated_data.get('description', ''),
            user=self.request.user
        )
        return project
```
```python
# api/urls.py

from rest_framework.routers import DefaultRouter
from .repository.viewsets import ProjectViewSet

router = DefaultRouter()
router.register(r'projects', ProjectViewSet)

urlpatterns = router.urls
```

---

## Automated Structure Validation

### Backend Structure Check

Create: `apps/core/management/commands/check_backend.py`
```python
from django.core.management.base import BaseCommand
from django.apps import apps
from pathlib import Path

class Command(BaseCommand):
    help = 'Check backend structure correspondence'
    
    def handle(self, *args, **options):
        errors = []
        warnings = []
        
        for app_config in apps.get_app_configs():
            if app_config.name.startswith('django.'):
                continue
            
            app_path = Path(app_config.path)
            views_dir = app_path / 'views'
            services_dir = app_path / 'services'
            models_dir = app_path / 'models'
            templates_dir = app_path / 'templates' / app_config.label
            
            # Check views directory exists
            if views_dir.exists() and views_dir.is_dir():
                for view_file in views_dir.rglob('*.py'):
                    if view_file.name == '__init__.py':
                        continue
                    
                    # Get relative path
                    rel_path = view_file.relative_to(views_dir)
                    
                    # Check corresponding template
                    template_path = templates_dir / rel_path.with_suffix('.html')
                    if not template_path.exists():
                        errors.append(
                            f'❌ {app_config.label}: View {rel_path} missing template {template_path}'
                        )
                    
                    # Check corresponding service (warning only)
                    service_path = services_dir / rel_path.parent / f"{rel_path.stem}_service.py"
                    if not service_path.exists():
                        warnings.append(
                            f'⚠️  {app_config.label}: View {rel_path} has no service {service_path}'
                        )
        
        # Output results
        if warnings:
            for warning in warnings:
                self.stdout.write(self.style.WARNING(warning))
        
        if errors:
            for error in errors:
                self.stdout.write(self.style.ERROR(error))
            raise SystemExit(1)
        else:
            self.stdout.write(self.style.SUCCESS('✅ Backend structure OK'))
```

### Complete Structure Check

Create: `apps/core/management/commands/check_structure.py`
```python
from django.core.management.base import BaseCommand
from django.core.management import call_command

class Command(BaseCommand):
    help = 'Check complete frontend and backend structure'
    
    def handle(self, *args, **options):
        self.stdout.write('Checking frontend structure...')
        call_command('check_frontend')
        
        self.stdout.write('\nChecking backend structure...')
        call_command('check_backend')
        
        self.stdout.write(self.style.SUCCESS('\n✅ Complete structure validation passed'))
```

### System Check Integration

Create: `apps/core/checks.py`
```python
from django.core.checks import Error, Warning, register
from django.apps import apps
from pathlib import Path

@register()
def check_complete_structure(app_configs, **kwargs):
    """Check both frontend and backend structure"""
    errors = []
    warnings = []
    
    for app_config in apps.get_app_configs():
        if app_config.name.startswith('django.'):
            continue
        
        app_path = Path(app_config.path)
        
        # Check frontend
        templates_dir = app_path / 'templates' / app_config.label
        if templates_dir.exists():
            css_dir = app_path / 'static' / app_config.label / 'css'
            ts_dir = app_path / 'static' / app_config.label / 'ts'
            
            for html in templates_dir.rglob('*.html'):
                if html.stem.startswith('_') or 'base' in html.parts:
                    continue
                
                rel = html.relative_to(templates_dir)
                css = css_dir / rel.with_suffix('.css')
                ts = ts_dir / rel.with_suffix('.ts')
                
                if not css.exists():
                    errors.append(Error(
                        f'{app_config.label}: Missing CSS for {html.name}',
                        hint=f'Create {css}',
                        id=f'{app_config.label}.E001',
                    ))
        
        # Check backend
        views_dir = app_path / 'views'
        if views_dir.exists():
            for view_file in views_dir.rglob('*.py'):
                if view_file.name == '__init__.py':
                    continue
                
                rel = view_file.relative_to(views_dir)
                template = templates_dir / rel.with_suffix('.html')
                
                if not template.exists():
                    errors.append(Error(
                        f'{app_config.label}: Missing template for view {view_file.name}',
                        hint=f'Create {template}',
                        id=f'{app_config.label}.E002',
                    ))
    
    return errors + warnings
```

### Usage
```bash
# Check everything
python manage.py check_structure

# Check on runserver (automatic)
python manage.py runserver

# Check before commit (git hook)
# .git/hooks/pre-commit
#!/bin/bash
python manage.py check_structure || exit 1
```

---

## Best Practices Summary

### DO ✓

1. **Maintain Perfect Correspondence**
   - Every template has a view
   - Every view uses a service
   - Every service uses models

2. **Keep Layers Thin**
   - Views < 50 lines
   - Services focused on one domain
   - Models only data structure

3. **Follow Import Hierarchy**
   - Models ← Services ← Views
   - Never import upwards

4. **Use String References**
   - Forward references in models
   - Avoid circular imports

5. **Split When Large**
   - Files > 300 lines → split
   - Features > 5 files → subdirectory

6. **Write Tests**
   - Test models, services, views separately
   - Aim for 80%+ coverage

7. **Validate Structure**
   - Run `check_structure` regularly
   - Enable in CI/CD pipeline

### DON'T ✗

1. **Mix Responsibilities**
   - Business logic in views
   - HTTP handling in services
   - Complex logic in models

2. **Skip Layers**
   - Views calling models directly (for complex operations)
   - Templates with business logic

3. **Create Premature Abstractions**
   - Extract common code only after 3 uses
   - Don't predict future needs

4. **Ignore Structure Validation**
   - Always check before commit
   - Fix violations immediately

5. **Use Unclear Names**
   - `utils.py` without context
   - `helpers.py` as dumping ground

---

## Migration Guide

### From Monolithic Structure
```
Before:
  models.py (1500 lines)
  views.py (2000 lines)
  services.py (1000 lines)

After:
  models/repository/project.py
  models/pull_requests/pull_request.py
  views/repository/browse.py
  services/repository/file_service.py
```

### Migration Steps

1. **Create New Structure**
```bash
   mkdir -p models/repository models/pull_requests
   mkdir -p views/repository views/pull_requests
   mkdir -p services/repository services/pull_requests
```

2. **Move Models**
```python
   # Cut from models.py
   class Project(models.Model): pass
   
   # Paste to models/repository/project.py
   from django.db import models
   class Project(models.Model): pass
```

3. **Update Imports**
```python
   # Old
   from .models import Project
   
   # New
   from .models.repository import Project
   # or
   from .models import Project  # if exported in __init__.py
```

4. **Move Services**
```python
   # Cut from services.py
   class FileService: pass
   
   # Paste to services/repository/file_service.py
```

5. **Move Views**
```python
   # Cut from views.py
   def browse(request): pass
   
   # Paste to views/repository/browse.py
```

6. **Update URLs**
```python
   # Old
   from .views import browse
   
   # New
   from .views.repository import browse
```

7. **Archive Old Files**
```bash
   mkdir legacy
   mv models.py legacy/models_old.py
   mv views.py legacy/views_old.py
```

8. **Run Tests**
```bash
   python manage.py test
```

9. **Validate Structure**
```bash
   python manage.py check_structure
```

---

## Complete Example: Repository Browse Feature

### Directory Structure
```
apps/project_app/
├── models/repository/
│   ├── __init__.py
│   └── project.py
├── services/repository/
│   ├── __init__.py
│   └── file_service.py
├── views/repository/
│   ├── __init__.py
│   └── browse.py
├── forms/repository/
│   ├── __init__.py
│   └── file_forms.py
├── tests/
│   ├── models/
│   │   └── test_repository.py
│   ├── services/
│   │   └── test_file_service.py
│   └── views/
│       └── test_browse.py
├── templates/project_app/repository/
│   └── browse.html
├── static/project_app/
│   ├── css/repository/
│   │   └── browse.css
│   └── ts/repository/
│       └── browse.ts
└── urls/
    └── repository.py
```

### Implementation
```python
# models/repository/project.py
from django.db import models
from django.contrib.auth import get_user_model

User = get_user_model()

class Project(models.Model):
    name = models.CharField(max_length=200)
    description = models.TextField(blank=True)
    owner = models.ForeignKey(User, on_delete=models.CASCADE, related_name='projects')
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'project_app_project'
        ordering = ['-created_at']
        unique_together = [['owner', 'name']]
    
    def __str__(self):
        return f"{self.owner.username}/{self.name}"
```
```python
# services/repository/file_service.py
from django.core.exceptions import ValidationError
from ...models.repository import Project

class FileService:
    @staticmethod
    def get_file_tree(project):
        """Get hierarchical file structure for project"""
        # Business logic here
        files = []
        # ... implementation
        return files
    
    @staticmethod
    def validate_filename(filename):
        """Validate filename"""
        if not filename or len(filename) > 255:
            raise ValidationError("Invalid filename")
        return True
```
```python
# views/repository/browse.py
from django.shortcuts import render, get_object_or_404
from django.contrib.auth.decorators import login_required

from ...models.repository import Project
from ...services.repository import FileService

@login_required
def browse(request, owner, name):
    """Browse repository files"""
    project = get_object_or_404(Project, owner__username=owner, name=name)
    files = FileService.get_file_tree(project)
    
    return render(request, 'project_app/repository/browse.html', {
        'project': project,
        'files': files,
    })
```
```python
# urls/repository.py
from django.urls import path
from ..views.repository import browse

urlpatterns = [
    path('<str:owner>/<str:name>/', browse, name='browse'),
]
```
```django
<!-- templates/project_app/repository/browse.html -->
{% extends 'project_app/base/app_base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'project_app/css/repository/browse.css' %}">
{% endblock %}

{% block content %}
<div class="browse-container">
    <h1>{{ project.name }}</h1>
    <div class="file-tree">
        {% for file in files %}
            <div class="file-item">{{ file.name }}</div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script type="module" src="{% static 'project_app/js/repository/browse.js' %}"></script>
{% endblock %}
```
```css
/* static/project_app/css/repository/browse.css */
@import url('/static/css/common/variables.css');

.browse-container {
    padding: 2rem;
}

.file-tree {
    margin-top: 1rem;
}

.file-item {
    padding: 0.5rem;
    border-bottom: 1px solid var(--border-color);
}
```
```typescript
// static/project_app/ts/repository/browse.ts
import { api } from '/static/js/common/api.js';

class BrowsePage {
    constructor() {
        this.init();
    }
    
    private init(): void {
        console.log('Browse page initialized');
        this.setupFileTree();
    }
    
    private setupFileTree(): void {
        // File tree logic
    }
}

document.addEventListener('DOMContentLoaded', () => {
    new BrowsePage();
});
```
```python
# tests/views/test_browse.py
from django.test import TestCase, Client
from django.urls import reverse
from django.contrib.auth import get_user_model

from apps.project_app.models import Project

User = get_user_model()

class BrowseViewTest(TestCase):
    def setUp(self):
        self.client = Client()
        self.user = User.objects.create_user('testuser', 'test@test.com', 'pass')
        self.project = Project.objects.create(name='test-repo', owner=self.user)
    
    def test_browse_view_success(self):
        self.client.login(username='testuser', password='pass')
        url = reverse('project_app:browse', kwargs={
            'owner': self.user.username,
            'name': self.project.name
        })
        response = self.client.get(url)
        self.assertEqual(response.status_code, 200)
        self.assertContains(response, 'test-repo')
```

---

## Summary

This structure provides:

1. **Perfect Clarity**: File location reveals exact functionality
2. **Complete Separation**: Each layer has single responsibility
3. **Easy Navigation**: Find anything in < 5 seconds
4. **Simple Testing**: Test each layer independently
5. **Team Scale**: New developers productive in hours
6. **Validated Automatically**: Structure enforced by tooling

**This is the ultimate Django organization. Follow it strictly for maintainable, scalable applications.**

---

## Quick Reference

### File Naming
```
Templates:     browse.html
CSS:           browse.css
TypeScript:    browse.ts
JavaScript:    browse.js (compiled)
View:          browse.py
Service:       file_service.py
Model:         project.py
Test:          test_browse.py
```

### Directory Naming
```
Shared:        shared/
Base:          base/
Common:        common/
Feature:       repository/, pull_requests/, issues/
```

### Import Patterns
```python
# Models
from apps.project_app.models import Project

# Services
from apps.project_app.services.repository import FileService

# Views (in URLs)
from apps.project_app.views.repository import browse
```

### Command Reference
```bash
# Validate structure
python manage.py check_structure

# Test everything
python manage.py test

# Run server (auto-validates)
python manage.py runserver

# Compile TypeScript
cd apps/project_app/static/project_app/
tsc --watch
```

---

**This document is the single source of truth for Django organization. Follow it. Enforce it. Maintain it.**

<!-- EOF -->