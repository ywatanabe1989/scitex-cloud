{% extends 'scholar_app/scholar_base.html' %}

{% load static %}

{% block title %}BibTeX Job #{{ job.id }} - SciTeX Scholar{% endblock %}

{% block extra_css %}
<style>
  .status-badge {
    display: inline-block;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.9rem;
  }

  .status-pending { background: #e2e8f0; color: #475569; }
  .status-processing { background: #dbeafe; color: #1e40af; }
  .status-completed { background: #d1fae5; color: #065f46; }
  .status-failed { background: #fee2e2; color: #991b1b; }
</style>
{% endblock %}

{% block search_content %}
<div class="container" style="max-width: 1000px; margin: 3rem auto; padding: 2rem;">

  <!-- Header -->
  <div style="margin-bottom: 2rem;">
    <a href="{% url 'scholar_app:bibtex_enrichment' %}" style="color: #667eea; text-decoration: none; font-weight: 600;">
      <i class="fas fa-arrow-left"></i> Back to BibTeX Enrichment
    </a>
    <h1 style="color: #1e293b; font-size: 2rem; margin-top: 1rem;">
      Enrichment Job #{{ job.id|slice:":8" }}
    </h1>
  </div>

  <!-- Status Card -->
  <div style="background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 2px 12px rgba(0,0,0,0.08); margin-bottom: 2rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
      <h2 style="color: #1e293b; font-size: 1.5rem; margin: 0;">
        <i class="fas fa-info-circle"></i> Job Status
      </h2>
      <span class="status-badge status-{{ job.status }}">
        {% if job.status == 'completed' %}
        <i class="fas fa-check-circle"></i> Completed
        {% elif job.status == 'processing' %}
        <i class="fas fa-spinner fa-spin"></i> Processing
        {% elif job.status == 'failed' %}
        <i class="fas fa-times-circle"></i> Failed
        {% else %}
        <i class="fas fa-clock"></i> Pending
        {% endif %}
      </span>
    </div>

    <!-- Progress Bar -->
    <div style="margin-bottom: 1.5rem;">
      <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
        <span style="font-weight: 600; color: #1e293b;">Progress</span>
        <span style="color: #64748b;">{{ job.get_progress_percentage }}%</span>
      </div>
      <div style="background: #e2e8f0; border-radius: 8px; height: 12px; overflow: hidden;">
        <div style="background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); height: 100%; width: {{ job.get_progress_percentage }}%; transition: width 0.3s;"></div>
      </div>
      <div style="margin-top: 0.5rem; color: #64748b; font-size: 0.9rem;">
        {{ job.processed_papers }} / {{ job.total_papers }} papers processed
        {% if job.failed_papers > 0 %}
        ({{ job.failed_papers }} failed)
        {% endif %}
      </div>
    </div>

    <!-- Job Details -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
      <div>
        <div style="color: #64748b; font-size: 0.85rem; margin-bottom: 0.25rem;">Input File</div>
        <div style="color: #1e293b; font-weight: 600;">{{ job.input_file.name|slice:"-40:" }}</div>
      </div>

      {% if job.project %}
      <div>
        <div style="color: #64748b; font-size: 0.85rem; margin-bottom: 0.25rem;">Project</div>
        <div style="color: #667eea; font-weight: 600;">
          <i class="fas fa-folder"></i> {{ job.project.name }}
        </div>
      </div>
      {% elif job.project_name %}
      <div>
        <div style="color: #64748b; font-size: 0.85rem; margin-bottom: 0.25rem;">Project Label</div>
        <div style="color: #1e293b; font-weight: 600;">{{ job.project_name }}</div>
      </div>
      {% endif %}

      <div>
        <div style="color: #64748b; font-size: 0.85rem; margin-bottom: 0.25rem;">Workers</div>
        <div style="color: #1e293b; font-weight: 600;">{{ job.num_workers }}</div>
      </div>

      <div>
        <div style="color: #64748b; font-size: 0.85rem; margin-bottom: 0.25rem;">Duration</div>
        <div style="color: #1e293b; font-weight: 600;">{{ job.get_duration_display }}</div>
      </div>

      <div>
        <div style="color: #64748b; font-size: 0.85rem; margin-bottom: 0.25rem;">Started</div>
        <div style="color: #1e293b; font-weight: 600;">
          {% if job.started_at %}
          {{ job.started_at|date:"M d, H:i" }}
          {% else %}
          Not started
          {% endif %}
        </div>
      </div>

      <div>
        <div style="color: #64748b; font-size: 0.85rem; margin-bottom: 0.25rem;">Completed</div>
        <div style="color: #1e293b; font-weight: 600;">
          {% if job.completed_at %}
          {{ job.completed_at|date:"M d, H:i" }}
          {% else %}
          In progress...
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Error Message -->
  {% if job.status == 'failed' and job.error_message %}
  <div style="background: #fee2e2; border-left: 4px solid #ef4444; border-radius: 8px; padding: 1.5rem; margin-bottom: 2rem;">
    <h3 style="color: #991b1b; margin-bottom: 0.5rem;">
      <i class="fas fa-exclamation-triangle"></i> Error
    </h3>
    <p style="color: #7f1d1d; margin: 0;">{{ job.error_message }}</p>
  </div>
  {% endif %}

  <!-- Gitea Integration Status -->
  {% if job.project and job.status == 'completed' %}
  <div style="background: {% if job.enrichment_summary.gitea_commit %}#d1fae5{% else %}#fef3c7{% endif %}; border-left: 4px solid {% if job.enrichment_summary.gitea_commit %}#10b981{% else %}#f59e0b{% endif %}; border-radius: 8px; padding: 1.5rem; margin-bottom: 2rem;">
    <h3 style="color: {% if job.enrichment_summary.gitea_commit %}#065f46{% else %}#92400e{% endif %}; margin-bottom: 0.5rem;">
      <i class="fas fa-{% if job.enrichment_summary.gitea_commit %}check-circle{% else %}exclamation-circle{% endif %}"></i>
      Gitea Version Control
    </h3>

    {% if job.enrichment_summary.gitea_commit %}
    <p style="color: #065f46; margin: 0 0 0.5rem 0;">
      ✓ Enriched bibliography successfully committed to Gitea repository
    </p>
    <div style="background: rgba(255, 255, 255, 0.5); border-radius: 6px; padding: 0.75rem; margin-top: 0.75rem;">
      <div style="color: #047857; font-size: 0.9rem;">
        <strong>Commit Message:</strong><br>
        <code style="color: #065f46;">{{ job.enrichment_summary.gitea_message }}</code>
      </div>
      <div style="color: #047857; font-size: 0.9rem; margin-top: 0.5rem;">
        <strong>Location:</strong><br>
        <code style="color: #065f46;">/references/references.bib</code>
      </div>
      {% if job.project.gitea_repo_url %}
      <div style="margin-top: 0.75rem;">
        <a href="{{ job.project.gitea_repo_url }}" target="_blank" style="color: #667eea; text-decoration: none; font-weight: 600;">
          <i class="fas fa-external-link-alt"></i> View in Gitea Repository
        </a>
      </div>
      {% endif %}
    </div>
    {% else %}
    <p style="color: #92400e; margin: 0;">
      ⚠ Auto-commit to Gitea failed. You can still download the enriched file manually.
    </p>
    {% if job.enrichment_summary.gitea_error %}
    <div style="background: rgba(255, 255, 255, 0.5); border-radius: 6px; padding: 0.75rem; margin-top: 0.75rem;">
      <div style="color: #92400e; font-size: 0.85rem;">
        <strong>Error:</strong> {{ job.enrichment_summary.gitea_error }}
      </div>
    </div>
    {% endif %}
    {% endif %}
  </div>
  {% endif %}

  <!-- Download Button -->
  {% if job.status == 'completed' and job.output_file %}
  <div style="text-align: center;">
    <a
      href="{% url 'scholar_app:bibtex_download_enriched' job.id %}"
      style="display: inline-block; padding: 1rem 2rem; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 1.1rem; transition: transform 0.2s;"
      onmouseover="this.style.transform='translateY(-2px)'"
      onmouseout="this.style.transform='translateY(0)'"
    >
      <i class="fas fa-download"></i> Download Enriched BibTeX
    </a>
  </div>
  {% endif %}

</div>

<!-- Auto-refresh for processing jobs -->
{% if job.status == 'processing' or job.status == 'pending' %}
<script>
  setTimeout(function() {
    location.reload();
  }, 5000); // Refresh every 5 seconds
</script>
{% endif %}
{% endblock %}
