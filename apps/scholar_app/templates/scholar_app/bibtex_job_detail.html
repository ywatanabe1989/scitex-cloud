{% extends 'scholar_app/scholar_base.html' %}
{% load static %}
{% block title
    %}
    BibTeX Job #{{ job.id }} - SciTeX Scholar
{% endblock %}
{% block extra_css %}
    <style>
  .status-badge {
    display: inline-block;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.9rem;
  }

  .status-pending {
    background: var(--color-canvas-subtle);
    color: var(--color-fg-muted);
  }
  .status-processing {
    background: rgba(var(--info-color-rgb, 107, 143, 179), 0.15);
    color: var(--info-color);
  }
  .status-completed {
    background: rgba(var(--success-color-rgb, 74, 155, 126), 0.15);
    color: var(--success-color);
  }
  .status-failed {
    background: rgba(var(--error-color-rgb, 166, 115, 115), 0.15);
    color: var(--error-color);
  }
    </style>
{% endblock %}
{% block search_content %}
    <div class="container"
         style="max-width: 1000px;
                margin: 3rem auto;
                padding: 2rem"
         data-job-id="{{ job.id }}"
         data-job-status="{{ job.status }}"
         data-started-at="{% if job.started_at %}{{ job.started_at|date:'c' }}{% endif %}">
        <!-- Header -->
        <div style="margin-bottom: 2rem">
            <a href="{% url 'scholar_app:bibtex_enrichment' %}"
               style="color: var(--color-accent-fg);
                      text-decoration: none;
                      font-weight: 600">
                <i class="fas fa-arrow-left"></i> Back to BibTeX Enrichment
            </a>
            <h1 style="color: var(--color-fg-default);
                       font-size: 2rem;
                       margin-top: 1rem">Enrichment Job #{{ job.id|slice:":8" }}</h1>
        </div>
        <!-- Status Card -->
        <div style="background: var(--color-canvas-default);
                    border-radius: 12px;
                    padding: 2rem;
                    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
                    border: 1px solid var(--color-border-default);
                    margin-bottom: 2rem">
            <div style="display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 1.5rem">
                <h2 style="color: var(--color-fg-default); font-size: 1.5rem; margin: 0">
                    <i class="fas fa-info-circle"></i> Job Status
                </h2>
                <span class="status-badge status-{{ job.status }}">
                    {% if job.status == 'completed' %}
                        <i class="fas fa-check-circle"></i> Completed
                    {% elif job.status ==
                        'processing' %}
                        <i class="fas fa-spinner fa-spin"></i> Processing {%
                        elif job.status == 'failed' %}
                        <i class="fas fa-times-circle"></i> Failed
                    {% else %}
                        <i class="fas fa-clock"></i> Pending
                    {% endif %}
                </span>
            </div>
            <!-- Progress Bar -->
            <div style="margin-bottom: 1.5rem">
                <div style="display: flex;
                            justify-content: space-between;
                            margin-bottom: 0.5rem">
                    <span style="font-weight: 600; color: var(--color-fg-default)">Progress</span>
                    <span style="color: var(--color-fg-muted)">{{ job.get_progress_percentage }}%</span>
                </div>
                <div style="background: var(--color-border-default);
                            border-radius: 8px;
                            height: 12px;
                            overflow: hidden">
                    <div style="background: var(--scitex-color-03);
                                height: 100%;
                                width: {{ job.get_progress_percentage }}%;
                                transition: width 0.3s"></div>
                </div>
                <div style="margin-top: 0.5rem;
                            color: var(--color-fg-muted);
                            font-size: 0.9rem">
                    {{ job.processed_papers }} / {{ job.total_papers }} papers processed {%
                    if job.failed_papers > 0 %} ({{ job.failed_papers }} failed)
                {% endif %}
            </div>
        </div>
        <!-- Job Details -->
        <div style="display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                    gap: 1.5rem">
            <div>
                <div style="color: var(--color-fg-muted);
                            font-size: 0.85rem;
                            margin-bottom: 0.25rem">Input File</div>
                <div style="color: var(--color-fg-default); font-weight: 600">{{ job.input_file.name|slice:"-40:" }}</div>
                <div style="color: var(--color-fg-subtle);
                            font-size: 0.75rem;
                            margin-top: 0.25rem">{{ job.get_input_file_size_display }}</div>
            </div>
            {% if job.output_file %}
                <div>
                    <div style="color: var(--color-fg-muted);
                                font-size: 0.85rem;
                                margin-bottom: 0.25rem">Output File</div>
                    <div style="color: var(--color-fg-default); font-weight: 600">{{ job.output_file.name|slice:"-40:" }}</div>
                    <div style="color: var(--color-fg-subtle);
                                font-size: 0.75rem;
                                margin-top: 0.25rem">{{ job.get_output_file_size_display }}</div>
                </div>
            {% endif %}
            {% if job.project %}
                <div>
                    <div style="color: var(--color-fg-muted);
                                font-size: 0.85rem;
                                margin-bottom: 0.25rem">Project</div>
                    <div style="color: var(--scitex-color-03); font-weight: 600">
                        <i class="fas fa-folder"></i> {{ job.project.name }}
                    </div>
                </div>
            {% elif job.project_name %}
                <div>
                    <div style="color: var(--color-fg-muted);
                                font-size: 0.85rem;
                                margin-bottom: 0.25rem">Project Label</div>
                    <div style="color: var(--color-fg-default); font-weight: 600">{{ job.project_name }}</div>
                </div>
            {% endif %}
            <div>
                <div style="color: var(--color-fg-muted);
                            font-size: 0.85rem;
                            margin-bottom: 0.25rem">Configuration</div>
                <div style="color: var(--color-fg-default); font-weight: 600">
                    {{ job.num_workers }} workers
                    {% if job.browser_mode == 'none' or
                        job.browser_mode == 'api_only' %}
                        <span style="color: var(--success-color);
                                     font-size: 0.75rem;
                                     margin-left: 0.5rem">
                            <i class="fas fa-bolt"></i> API-only
                        </span>
                    {% endif %}
                </div>
            </div>
            <div>
                <div style="color: var(--color-fg-muted);
                            font-size: 0.85rem;
                            margin-bottom: 0.25rem">Duration</div>
                <div style="color: var(--color-fg-default); font-weight: 600">
                    <span id="elapsed-time">{{ job.get_duration_display }}</span>
                </div>
            </div>
            <div>
                <div style="color: var(--color-fg-muted);
                            font-size: 0.85rem;
                            margin-bottom: 0.25rem">Started</div>
                <div style="color: var(--color-fg-default); font-weight: 600">
                    {% if job.started_at %}
                        {{ job.started_at|date:"M d, H:i" }}
                    {% else
                        %}
                        Not started
                    {% endif %}
                </div>
            </div>
            <div>
                <div style="color: var(--color-fg-muted);
                            font-size: 0.85rem;
                            margin-bottom: 0.25rem">Completed</div>
                <div style="color: var(--color-fg-default); font-weight: 600">
                    {% if job.completed_at %}
                        {{ job.completed_at|date:"M d, H:i" }} {%
                        else %} In progress...
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <!-- Error Message -->
    {% if job.status == 'failed' and job.error_message %}
        <div style="background: var(--color-danger-subtle);
                    border-left: 4px solid var(--error-color);
                    border-radius: 8px;
                    padding: 1.5rem;
                    margin-bottom: 2rem">
            <h3 style="color: var(--color-danger-emphasis); margin-bottom: 0.5rem">
                <i class="fas fa-exclamation-triangle"></i> Error
            </h3>
            <p style="color: var(--color-danger-fg); margin: 0">{{ job.error_message }}</p>
        </div>
    {% endif %}
    <!-- Processing Log (Real-time) -->
    {% if job.status == 'processing' or job.status == 'completed' or job.status ==
        'failed' %}
        <div style="background: var(--color-canvas-default);
                    border-radius: 12px;
                    padding: 2rem;
                    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
                    border: 1px solid var(--color-border-default);
                    margin-bottom: 2rem">
            <div style="display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 1rem">
                <h2 style="color: var(--color-fg-default); font-size: 1.5rem; margin: 0">
                    <i class="fas fa-terminal"></i> Processing Log
                </h2>
                <div style="display: flex; gap: 0.5rem">
                    <button id="copy-log-btn"
                            style="background: var(--color-btn-bg);
                                   border: 1px solid var(--color-border-default);
                                   border-radius: 6px;
                                   padding: 0.5rem 1rem;
                                   cursor: pointer;
                                   color: var(--color-fg-default);
                                   font-weight: 600;
                                   transition: all 0.2s"
                            title="Copy log to clipboard">
                        <i class="fas fa-copy"></i> Copy Log
                    </button>
                    <button id="toggle-log-size"
                            style="background: none;
                                   border: 1px solid var(--color-border-default);
                                   border-radius: 6px;
                                   padding: 0.5rem;
                                   cursor: pointer;
                                   color: var(--color-fg-muted)"
                            title="Expand/Collapse log">
                        <i class="fas fa-expand-alt"></i>
                    </button>
                </div>
            </div>
            <pre id="processing-log" style=" background: #0a0f1a; color: #00ff00; padding: 1.5rem; border-radius: 8px; overflow-y: auto; max-height: 400px; font-size: 0.875rem; line-height: 1.3; margin: 0; font-family: &quot;Courier New&quot;, monospace; white-space: pre-wrap; ">
{% if job.processing_log %}{{ job.processing_log }}{% else %}Waiting for processing to start...{% endif %}</pre>
        </div>
    {% endif %}
    <!-- Gitea Integration Status -->
    {% if job.project and job.status == 'completed' %}
        <div style="background: {% if job.enrichment_summary.gitea_commit %}var(--color-success-subtle){% else %}rgba(var(--warning-color-rgb, 184, 149, 106), 0.15){% endif %};
                    border-left: 4px solid {% if job.enrichment_summary.gitea_commit %}var(--success-color){% else %}var(--warning-color){% endif %};
                    border-radius: 8px;
                    padding: 1.5rem;
                    margin-bottom: 2rem">
            <h3 style="color: {% if job.enrichment_summary.gitea_commit %}var(--color-success-emphasis){% else %}var(--warning-color){% endif %};
                       margin-bottom: 0.5rem">
                <i class="fas fa-{% if job.enrichment_summary.gitea_commit %}check-circle{% else %}exclamation-circle{% endif %}"></i>
                Gitea Version Control
            </h3>
            {% if job.enrichment_summary.gitea_commit %}
                <p style="color: var(--color-success-fg); margin: 0 0 0.5rem 0">
                    ✓ Enriched bibliography successfully committed to Gitea repository
                </p>
                <div style="background: var(--color-canvas-subtle);
                            border-radius: 6px;
                            padding: 0.75rem;
                            margin-top: 0.75rem">
                    <div style="color: var(--color-success-fg); font-size: 0.9rem">
                        <strong>Commit Message:</strong>
                        <br />
                        <code style="color: var(--color-success-emphasis)">{{ job.enrichment_summary.gitea_message }}</code>
                    </div>
                    <div style="color: var(--color-success-fg);
                                font-size: 0.9rem;
                                margin-top: 0.5rem">
                        <strong>Location:</strong>
                        <br />
                        <code style="color: var(--color-success-emphasis)">/references/references.bib</code>
                    </div>
                    {% if job.project.gitea_repo_url %}
                        <div style="margin-top: 0.75rem">
                            <a href="{{ job.project.gitea_repo_url }}"
                               target="_blank"
                               style="color: var(--color-accent-fg);
                                      text-decoration: none;
                                      font-weight: 600">
                                <i class="fas fa-external-link-alt"></i> View in Gitea Repository
                            </a>
                        </div>
                    {% endif %}
                </div>
            {% else %}
                <p style="color: var(--warning-color); margin: 0">
                    ⚠ Auto-commit to Gitea failed. You can still download the enriched file
                    manually.
                </p>
                {% if job.enrichment_summary.gitea_error %}
                    <div style="background: var(--color-canvas-subtle);
                                border-radius: 6px;
                                padding: 0.75rem;
                                margin-top: 0.75rem">
                        <div style="color: var(--warning-color); font-size: 0.85rem">
                            <strong>Error:</strong> {{ job.enrichment_summary.gitea_error }}
                        </div>
                    </div>
                {% endif %}
            {% endif %}
        </div>
    {% endif %}
    <!-- Download Button -->
    {% if job.status == 'completed' and job.output_file %}
        <div style="text-align: center">
            {% if job.get_output_file_size == 0 %}
                <!-- Warning for empty output file -->
                <div style="background: rgba(var(--warning-color-rgb, 184, 149, 106), 0.15);
                            border: 2px solid var(--warning-color);
                            border-radius: 12px;
                            padding: 2rem;
                            margin-bottom: 2rem;
                            max-width: 600px;
                            margin-left: auto;
                            margin-right: auto">
                    <div style="font-size: 2rem;
                                color: var(--warning-color);
                                margin-bottom: 1rem">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h3 style="color: var(--warning-color);
                               margin-bottom: 0.75rem;
                               font-size: 1.25rem">Output File is Empty</h3>
                    <p style="color: var(--color-fg-default); margin: 0; line-height: 1.6">
                        The enrichment process completed, but the output file is empty (0
                        bytes). This usually means no BibTeX entries were found in the input
                        file or there was an issue during processing. Please check the
                        processing log above for more details.
                    </p>
                    <div style="margin-top: 1rem;
                                padding-top: 1rem;
                                border-top: 1px solid var(--warning-color)">
                        <div style="color: var(--color-fg-muted); font-size: 0.9rem">
                            <strong>Debugging info:</strong>
                            <br />
                            Input file: {{ job.get_input_file_size_display }}
                            <br />
                            Output file: {{ job.get_output_file_size_display }}
                            <br />
                            Papers found: {{ job.total_papers }}
                        </div>
                    </div>
                </div>
            {% else %}
                <!-- Normal download button -->
                <a href="{% url 'scholar_app:bibtex_download_enriched' job.id %}"
                   download
                   style="display: inline-block;
                          padding: 1rem 2rem;
                          background: var(--success-color);
                          color: var(--white);
                          border-radius: 8px;
                          text-decoration: none;
                          font-weight: 600;
                          font-size: 1.1rem;
                          transition: transform 0.2s, background-color 0.2s"
                   onmouseover="this.style.background='var(--color-success-emphasis)'; this.style.transform='translateY(-2px)'"
                   onmouseout="this.style.background='var(--success-color)'; this.style.transform='translateY(0)'">
                    <i class="fas fa-download"></i> Download Enriched BibTeX ({{
                    job.get_output_file_size_display }})
                </a>
                <div style="color: var(--color-fg-muted);
                            margin-top: 1rem;
                            font-size: 0.9rem">
                    {{ job.total_papers }} entries, {{ job.processed_papers }} enriched
                </div>
            {% endif %}
        </div>
    {% endif %}
</div>
<!-- Job Detail UI Script -->
<script type="module"
        src="{% static 'scholar_app/js/bibtex/job-detail-ui.js' %}"></script>
{% endblock %}
