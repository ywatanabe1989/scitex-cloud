{% extends "scholar_app/scholar_base.html" %}
{% load static %}

{% block title %}SciTeX Scholar - Literature Search{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/components/hero.css' %}">
<link rel="stylesheet" href="{% static 'css/common/scitex-components.css' %}">
<link rel="stylesheet" href="{% static 'css/common/terminal-log.css' %}">
<link rel="stylesheet" href="{% static 'css/common.css' %}">
<link rel="stylesheet" href="{% static 'scholar_app/styles/scholar-index.css' %}">
{% endblock %}

{% block extra_js %}

{% endblock %}

{% block content %}
<!-- Split-Screen Layout -->
<div class="container u-mt-2 u-mb-3">
    <div class="split-container" id="splitContainer">
        {% include "scholar_app/index_partials/enrich.html" %}

        {% include "scholar_app/index_partials/search.html" %}
    </div>

                    <div>
                        <h5 class="mb-0">Search Results</h5>
                        <small class="text-muted" id="searchResultsText">
                            Found {{ results|length }} result{{ results|length|pluralize }} for "{{ query }}" 
                            {% if results %}
                                <span id="sourceDisplay">from selected sources</span>
                            {% endif %}
                        </small>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        
                        <div>
                            <small class="text-muted">Sort by:</small>
                            <select name="sort_by" class="form-select form-select-sm d-inline-block w-auto ms-2" id="sortSelect">
                                <option value="relevance" {% if request.GET.sort_by == 'relevance' or not request.GET.sort_by %}selected{% endif %}>Most Relevant</option>
                                <option value="date" {% if request.GET.sort_by == 'date' %}selected{% endif %}>Most Recent</option>
                                <option value="citations" {% if request.GET.sort_by == 'citations' %}selected{% endif %}>Most Cited</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- API Key Alert -->
                {% if missing_api_keys %}
                <div class="alert alert-warning alert-dismissible fade show mb-3" role="alert">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-key me-2 text-warning"></i>
                        <div class="flex-grow-1">
                            <strong>Improve Your Search Performance!</strong><br>
                            <small>Missing API keys for: <strong>{{ missing_api_keys|join:", "|title }}</strong>. 
                            Add them for higher rate limits and more comprehensive results.</small>
                        </div>
                        <a href="{% url 'scholar_app:api_keys' %}" class="btn btn-warning btn-sm ms-2">
                            <i class="fas fa-plus"></i> Add API Keys
                        </a>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endif %}
                
                <!-- Progressive Loading Status -->
                <div id="progressiveLoadingStatus" class="u-hidden">
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="d-flex flex-wrap gap-3 align-items-center">
                                <div class="progress-source" data-source="pubmed">
                                    <span class="badge bg-secondary">PubMed</span>
                                    <div class="spinner-border spinner-border-sm ms-2" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <span class="count ms-1">0</span>
                                </div>
                                <div class="progress-source" data-source="google_scholar">
                                    <span class="badge bg-secondary">Google Scholar</span>
                                    <div class="spinner-border spinner-border-sm ms-2" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <span class="count ms-1">0</span>
                                </div>
                                <div class="progress-source" data-source="arxiv">
                                    <span class="badge bg-secondary">arXiv</span>
                                    <div class="spinner-border spinner-border-sm ms-2" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <span class="count ms-1">0</span>
                                </div>
                                <div class="progress-source" data-source="semantic">
                                    <span class="badge bg-secondary">Semantic Scholar</span>
                                    <div class="spinner-border spinner-border-sm ms-2" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <span class="count ms-1">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Progressive Results Container -->
                <div id="progressiveResults" class="u-hidden"></div>

                <!-- Search Results -->
                {% for result in results %}
                <div class="result-card" data-paper-id="{{ result.id }}" data-title="{{ result.title }}" data-authors="{{ result.authors }}" data-year="{{ result.year }}" data-journal="{{ result.journal|default:'Unknown Journal' }}" data-doi="{{ result.doi|default:'' }}" data-pmid="{{ result.pmid|default:'' }}" data-arxiv-id="{{ result.arxiv_id|default:'' }}" data-external-url="{{ result.external_url|default:'' }}" data-source="{{ result.source|default:'' }}">
                    <h6 class="result-title">
                        <a href="#" class="text-decoration-none" onclick="viewOnWeb(this)">
                            {{ result.title }}
                        </a>
                    </h6>
                    <div class="result-authors">
                        {{ result.authors }}
                    </div>
                    <div class="d-flex align-items-center mt-2 flex-wrap">
                        <span class="year-badge me-2">{{ result.year }}</span>
                        {% if result.is_open_access %}
                        <span class="open-access me-2">Open Access</span>
                        {% endif %}
                        {% if result.impact_factor %}
                        <span class="badge bg-warning text-dark me-2 u-text-muted-xs">
                            IF: {{ result.impact_factor }}
                        </span>
                        {% endif %}
                        <small class="text-muted">
                            {{ result.journal|default:"Unknown Journal" }}
                            {% if result.citations and result.citations > 0 %}
                                ‚Ä¢ <strong>{{ result.citations }} citations</strong>
                                {% if result.citation_source %}
                                    <span class="badge bg-light text-dark" style="font-size: 0.6rem;" title="Citation data source">{{ result.citation_source|upper }}</span>
                                {% endif %}
                            {% elif result.citations == 0 %}
                                ‚Ä¢ <span class="text-muted">0 citations</span>
                            {% else %}
                                ‚Ä¢ <span class="text-muted">Citations unavailable</span>
                            {% endif %}
                            {% if result.pmid %}
                                ‚Ä¢ PMID: {{ result.pmid }}
                            {% endif %}
                        </small>
                        {% if result.source %}
                        <span class="badge bg-info ms-2 u-text-muted-xs">{{ result.source|upper }}</span>
                        {% endif %}
                    </div>
                    
                    <!-- Abstract Section -->
                    <div class="result-snippet mt-2">
                        <div class="abstract-preview">
                            {% if result.full_abstract and result.full_abstract|length > 200 %}
                                <span class="abstract-short">{{ result.snippet|default:"No abstract available." }}</span>
                                <span class="abstract-full u-hidden">{{ result.full_abstract }}</span>
                                <a href="#" class="abstract-toggle text-primary ms-2 u-text-xs">[Show full abstract]</a>
                            {% else %}
                                {{ result.snippet|default:"No abstract available." }}
                            {% endif %}
                        </div>
                    </div>
                    <div class="mt-3">
                        {% if result.pdf_url %}
                        <a href="{{ result.pdf_url }}" class="btn btn-outline-success btn-sm me-2" target="_blank">
                            üìÑ Download PDF
                        </a>
                        {% else %}
                        <span class="btn btn-outline-secondary btn-sm me-2 disabled">
                            üìÑ No PDF
                        </span>
                        {% endif %}
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-info btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                üìù Export Citation
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="exportCitation(this, 'bibtex')">
                                    <i class="fas fa-file-code"></i> BibTeX (.bib)
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="exportCitation(this, 'ris')">
                                    <i class="fas fa-file-text"></i> RIS (.ris)
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="exportCitation(this, 'endnote')">
                                    <i class="fas fa-file-alt"></i> EndNote (.enw)
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="exportCitation(this, 'csv')">
                                    <i class="fas fa-table"></i> CSV (.csv)
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" onclick="showBibTeX(this)">
                                    <i class="fas fa-eye"></i> Quick Preview
                                </a></li>
                            </ul>
                        </div>
                        <a href="#" class="btn btn-outline-warning btn-sm me-2" onclick="saveToLibrary(this)">
                            ‚≠ê Add to Library
                        </a>
                        {% if user.is_authenticated %}
                        <a href="{% url 'scholar_app:paper_annotations' result.id %}" class="btn btn-outline-success btn-sm me-2">
                            üí¨ Annotate
                        </a>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}

                <!-- Simple Pagination -->
                <div class="text-center mt-4">
                    <nav>
                        <ul class="pagination justify-content-center">
                            <li class="page-item disabled">
                                <span class="page-link">Previous</span>
                            </li>
                            <li class="page-item active">
                                <span class="page-link">1</span>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="#">2</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="#">3</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="#">Next</a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    {% else %}
        <!-- <\!-- Quick Examples -\->
         !-- <div class="row justify-content-center">
         !--     <div class="col-lg-8 text-center">
         !--         <div class="mt-4">
         !--             <p class="mb-3">Try searching for:</p>
         !--             <div class="d-flex flex-wrap justify-content-center gap-2">
         !--                 <a href="?q=neural mechanisms visual attention" class="btn btn-outline-primary btn-sm">neural mechanisms visual attention</a>
         !--                 <a href="?q=machine learning neuroscience" class="btn btn-outline-primary btn-sm">machine learning neuroscience</a>
         !--                 <a href="?q=fMRI attention networks" class="btn btn-outline-primary btn-sm">fMRI attention networks</a>
         !--                 <a href="?q=computational vision models" class="btn btn-outline-primary btn-sm">computational vision models</a>
         !--             </div>
         !--         </div>
         !--     </div>
         !-- </div> -->
    {% endif %}
</div>

<!-- Configuration for JavaScript -->
<script>
// Django template variables for JavaScript
window.SCHOLAR_CONFIG = {
    urls: {
        bibtexUpload: '{% url "scholar_app:bibtex_upload" %}',
        resourceStatus: '{% url "scholar_app:bibtex_resource_status" %}'
    },
    user: {
        isAuthenticated: {% if user.is_authenticated %}true{% else %}false{% endif %}
    }
};
</script>
<!-- Panel Toggle Functionality -->
<script src="{% static 'scholar_app/scripts/panel-toggle.js' %}"></script>
<!-- Main Scholar Index Functionality -->
<script src="{% static 'scholar_app/scripts/scholar-index-main.js' %}"></script>

{% endblock %}

