{% extends "scholar_app/scholar_base.html" %}
{% load static %}

{% block title %}SciTeX Scholar - Literature Search{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/common.css' %}">
<link rel="stylesheet" href="{% static 'scholar_app/css/index.css' %}">
<link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css" rel="stylesheet">
{% endblock %}

{% block extra_js %}

{% endblock %}

{% block content %}
<!-- Vertical Tab Layout -->
<div class="u-mt-2 u-mb-3">
  <div class="vertical-tab-container" style="width: 100%;">
    <!-- Vertical Tab Navigation -->
    <div class="scitex-tabs" style="padding: 0 2rem;">
      <a href="#bibtex" class="scitex-tab tab-link" data-tab="bibtex">
        <i class="fas fa-file-code"></i>
        <span>BibTeX Enrichment</span>
      </a>
      <a href="#search" class="scitex-tab tab-link" data-tab="search">
        <i class="fas fa-search"></i>
        <span>Literature Search</span>
      </a>
    </div>

    <!-- Tab Content Container -->
    <div class="vertical-tab-content-container" style="width: 100%; overflow-x: auto; overflow-y: visible;">
      <!-- BibTeX Enrichment Tab -->
      <div class="vertical-tab-content {% if active_tab == 'bibtex' %}active{% endif %}" id="bibtex-tab" data-tab="bibtex" style="width: 100%; overflow: visible;">
        {% include "scholar_app/bibtex_partials/enrich.html" %}
      </div>

      <!-- Literature Search Tab -->
      <div class="vertical-tab-content {% if active_tab == 'search' %}active{% endif %}" id="search-tab" data-tab="search">
        {% include "scholar_app/search_partials/search.html" with show_results=True %}
      </div>
    </div>
  </div>
</div>

<!-- Configuration for JavaScript -->
<script>
  // Django template variables for JavaScript
  window.SCHOLAR_CONFIG = {
  urls: {
  bibtexUpload: '{% url "scholar_app:bibtex_upload" %}',
  resourceStatus: '{% url "scholar_app:bibtex_resource_status" %}',
  scitexSearch: '{% url "scholar_app:api_scitex_search" %}',
  scitexCapabilities: '{% url "scholar_app:api_scitex_capabilities" %}'
  },
  user: {
  isAuthenticated: {% if user.is_authenticated %}true{% else %}false{% endif %}
  }
  };

  // Set user projects for save functionality
  window.userProjects = [
    {% for project in user_projects %}
    {
      id: {{ project.id }},
      name: "{{ project.name|escapejs }}"
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];

  // Set current project if available
  window.currentProject = {% if current_project %}{ id: {{ current_project.id }}, name: "{{ current_project.name|escapejs }}" }{% else %}null{% endif %};

  {% if query and results %}
  // Serialize Django search results for swarm plots
  window.SCHOLAR_SEARCH_RESULTS = [
    {% for result in results %}
    {
      title: "{{ result.title|escapejs }}",
      year: {% if result.year %}{{ result.year }}{% else %}null{% endif %},
      citations: {% if result.citations %}{{ result.citations }}{% else %}0{% endif %},
      impact_factor: {% if result.impact_factor %}{{ result.impact_factor }}{% else %}null{% endif %},
      authors: "{{ result.authors|escapejs }}",
      journal: "{{ result.journal|escapejs }}",
      url: "{{ result.url|escapejs }}"
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];

  // Initialize swarm plots when DOM is ready
  document.addEventListener('DOMContentLoaded', function() {
    console.log('[Scholar Index] Initializing swarm plots with', window.SCHOLAR_SEARCH_RESULTS.length, 'Django results');

    // Wait for SwarmPlots module to load
    if (window.SwarmPlots) {
      window.SwarmPlots.init(window.SCHOLAR_SEARCH_RESULTS);
    } else {
      // If not loaded yet, wait a bit
      setTimeout(function() {
        if (window.SwarmPlots) {
          window.SwarmPlots.init(window.SCHOLAR_SEARCH_RESULTS);
        } else {
          console.warn('[Scholar Index] SwarmPlots module not available');
        }
      }, 500);
    }
  });
  {% endif %}
</script>
<!-- Common Scripts -->
<script src="{% static 'scholar_app/scripts/common/project-selector.js' %}"></script>
<script src="{% static 'scholar_app/scripts/common/init-tabs.js' %}"></script>
<!-- External Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"></script>
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js" charset="utf-8"></script>
<!-- BibTeX Scripts -->
<script src="{% static 'scholar_app/scripts/bibtex/bibtex-enrichment.js' %}"></script>
<script src="{% static 'scholar_app/scripts/bibtex/queue-management.js' %}?v=20251027-fix-polling-debug"></script>
<!-- Search Scripts -->
<script src="{% static 'scholar_app/scripts/search/nouislider-init.js' %}"></script>
<script src="{% static 'scholar_app/scripts/search/panel-toggle.js' %}"></script>
<script src="{% static 'scholar_app/scripts/search/scitex-search.js' %}?v=20251027-fix-infinite-loop"></script>
<script src="{% static 'scholar_app/scripts/search/advanced-sorting.js' %}"></script>
<script src="{% static 'scholar_app/scripts/search/drag-sort.js' %}"></script>
<script src="{% static 'scholar_app/scripts/search/swarm-plots.js' %}?v=20251022-dynamic"></script>
<script src="{% static 'scholar_app/scripts/search/scholar-index-main.js' %}"></script>
<script src="{% static 'scholar_app/scripts/search/seekbar-integration.js' %}"></script>

{% endblock %}

