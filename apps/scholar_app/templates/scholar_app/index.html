{% extends "scholar_app/scholar_base.html" %}
{% load static %}

{% block title %}SciTeX Scholar - Literature Search{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/components/hero.css' %}">
<link rel="stylesheet" href="{% static 'css/common/scitex-components.css' %}">
<link rel="stylesheet" href="{% static 'css/common/terminal-log.css' %}">
<link rel="stylesheet" href="{% static 'css/common.css' %}">
<link rel="stylesheet" href="{% static 'scholar_app/styles/scholar-index.css' %}">
{% endblock %}

{% block extra_js %}

{% endblock %}

{% block content %}
<!-- Split-Screen Layout -->
<div class="container u-mt-2 u-mb-3">
    <div class="split-container" id="splitContainer">
        {% include "scholar_app/index_partials/enrich.html" %}

        {% include "scholar_app/index_partials/search.html" %}
    </div>

    <!-- Results Section Below Split Container -->
    <div class="container">
        {% if has_results %}
            <!-- Search Results -->
            <div class="row justify-content-center">
                <div class="col-lg-10">
                    <!-- Results Header -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <i class="fas fa-search"></i> <span class="panel-title">Literature Search</span>
                </div>
                <i class="fas fa-expand-alt toggle-icon"></i>
            </div>
            <div class="panel-content">
                <div class="search-card-inner">
                    <form id="literatureSearchForm" method="get" action="{% url 'scholar_app:simple_search' %}">
                        <div class="input-group input-group-lg">
                            <input type="text" name="q" class="form-control search-input" 
                                   placeholder="Enter keywords here..."
                                   value="{{ query }}" autofocus>
                            <button type="submit" class="btn search-btn" id="searchButton">
                                üîç Search
                            </button>
                        </div>
                        
                        <div class="mt-3">
                            <!-- Advanced Filters Toggle -->
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <small style="color: var(--color-fg-default); font-weight: 600;">Filters:</small>
                                <button type="button" class="btn btn-outline-secondary btn-sm" id="toggleAdvancedFilters" style="border-color: var(--scitex-color-05); color: var(--color-fg-default); background: var(--color-canvas-subtle);">
                                    <i class="fas fa-sliders-h"></i> Advanced Filters
                                </button>
                            </div>

                            <!-- Basic Filters -->
                            <div id="basicFilters" class="row g-3 mb-3">
                                <!-- Source Selection -->
                                <div class="col-md-6">
                                    <label class="form-label fw-bold u-text-default">Search Sources:</label>
                                    <div class="d-flex flex-wrap gap-2">
                                        <div class="scitex-toggle-wrapper">
                                            <input class="scitex-toggle all-sources-toggle" type="checkbox" id="source_all_toggle" {% if not request.GET.source_pubmed and not request.GET.source_google_scholar and not request.GET.source_arxiv and not request.GET.source_semantic %}checked{% endif %}>
                                            <label class="scitex-toggle-label" for="source_all_toggle">All Sources</label>
                                        </div>
                                        <div class="scitex-toggle-wrapper">
                                            <input class="scitex-toggle source-toggle" type="checkbox" name="source_pubmed" id="source_pubmed" value="pubmed" {% if request.GET.source_pubmed %}checked{% endif %}>
                                            <label class="scitex-toggle-label" for="source_pubmed">PubMed</label>
                                        </div>
                                        <div class="scitex-toggle-wrapper">
                                            <input class="scitex-toggle source-toggle" type="checkbox" name="source_google_scholar" id="source_google_scholar" value="google_scholar" {% if request.GET.source_google_scholar %}checked{% endif %}>
                                            <label class="scitex-toggle-label" for="source_google_scholar">Google Scholar</label>
                                        </div>
                                        <div class="scitex-toggle-wrapper">
                                            <input class="scitex-toggle source-toggle" type="checkbox" name="source_arxiv" id="source_arxiv" value="arxiv" {% if request.GET.source_arxiv %}checked{% endif %}>
                                            <label class="scitex-toggle-label" for="source_arxiv">arXiv</label>
                                        </div>
                                        <div class="scitex-toggle-wrapper">
                                            <input class="scitex-toggle source-toggle" type="checkbox" name="source_semantic" id="source_semantic" value="semantic" {% if request.GET.source_semantic %}checked{% endif %}>
                                            <label class="scitex-toggle-label" for="source_semantic">Semantic Scholar</label>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Quick Filters -->
                                <div class="col-md-6">
                                    <label class="form-label fw-bold u-text-default">Quick Filters:</label>
                                    <div class="d-flex flex-wrap gap-2">
                                        <div class="scitex-checkbox-wrapper">
                                            <input class="scitex-checkbox" type="checkbox" name="open_access" id="open_access" {% if request.GET.open_access %}checked{% endif %}>
                                            <label class="scitex-checkbox-label" for="open_access">Open Access Only</label>
                                        </div>
                                        <div class="scitex-checkbox-wrapper">
                                            <input class="scitex-checkbox" type="checkbox" name="recent_only" id="recent_only" {% if request.GET.recent_only %}checked{% endif %}>
                                            <label class="scitex-checkbox-label" for="recent_only">Last 5 Years</label>
                                        </div>
                                        <div class="scitex-checkbox-wrapper">
                                            <input class="scitex-checkbox" type="checkbox" name="high_impact" id="high_impact" {% if request.GET.high_impact %}checked{% endif %}>
                                            <label class="scitex-checkbox-label" for="high_impact">High Impact (IF > 5)</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Advanced Filters -->
                            <div id="advancedFilters" class="border rounded p-3 mb-3" style="display: none; background: #f8f9fa;">
                                <div class="row g-3">
                                    <!-- Year Range -->
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">Publication Year Range:</label>
                                        <div class="d-flex gap-2 align-items-center">
                                            <input type="number" name="year_from" class="form-control form-control-sm" placeholder="From" min="1900" max="2024" value="{{ request.GET.year_from }}">
                                            <span>to</span>
                                            <input type="number" name="year_to" class="form-control form-control-sm" placeholder="To" min="1900" max="2024" value="{{ request.GET.year_to }}">
                                        </div>
                                    </div>
                                    
                                    <!-- Citation Count -->
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">Minimum Citations:</label>
                                        <select name="min_citations" class="form-select form-select-sm">
                                            <option value="" {% if not request.GET.min_citations %}selected{% endif %}>Any</option>
                                            <option value="10" {% if request.GET.min_citations == '10' %}selected{% endif %}>10+</option>
                                            <option value="50" {% if request.GET.min_citations == '50' %}selected{% endif %}>50+</option>
                                            <option value="100" {% if request.GET.min_citations == '100' %}selected{% endif %}>100+</option>
                                            <option value="500" {% if request.GET.min_citations == '500' %}selected{% endif %}>500+</option>
                                            <option value="1000" {% if request.GET.min_citations == '1000' %}selected{% endif %}>1000+</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Impact Factor -->
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">Journal Impact Factor:</label>
                                        <select name="min_impact_factor" class="form-select form-select-sm">
                                            <option value="" {% if not request.GET.min_impact_factor %}selected{% endif %}>Any</option>
                                            <option value="1" {% if request.GET.min_impact_factor == '1' %}selected{% endif %}>1.0+</option>
                                            <option value="3" {% if request.GET.min_impact_factor == '3' %}selected{% endif %}>3.0+</option>
                                            <option value="5" {% if request.GET.min_impact_factor == '5' %}selected{% endif %}>5.0+</option>
                                            <option value="10" {% if request.GET.min_impact_factor == '10' %}selected{% endif %}>10.0+</option>
                                            <option value="20" {% if request.GET.min_impact_factor == '20' %}selected{% endif %}>20.0+</option>
                                        </select>
                                        <small class="text-muted">üí° Check journal rankings at <a href="https://www.scimagojr.com/journalrank.php" target="_blank" class="text-decoration-none">ScimagoJR</a></small>
                                    </div>
                                    
                                    <!-- Author Filter -->
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Author(s):</label>
                                        <input type="text" name="author" class="form-control form-control-sm" placeholder="e.g., Smith, Johnson" value="{{ request.GET.author }}">
                                        <small class="text-muted">Separate multiple authors with commas</small>
                                    </div>
                                    
                                    <!-- Journal Filter -->
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Journal:</label>
                                        <input type="text" name="journal" class="form-control form-control-sm" placeholder="e.g., Nature, Science" value="{{ request.GET.journal }}">
                                        <small class="text-muted">Journal name or partial name</small>
                                    </div>
                                    
                                    <!-- Document Type -->
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">Document Type:</label>
                                        <select name="doc_type" class="form-select form-select-sm">
                                            <option value="" {% if not request.GET.doc_type %}selected{% endif %}>All Types</option>
                                            <option value="article" {% if request.GET.doc_type == 'article' %}selected{% endif %}>Research Article</option>
                                            <option value="review" {% if request.GET.doc_type == 'review' %}selected{% endif %}>Review</option>
                                            <option value="preprint" {% if request.GET.doc_type == 'preprint' %}selected{% endif %}>Preprint</option>
                                            <option value="conference" {% if request.GET.doc_type == 'conference' %}selected{% endif %}>Conference Paper</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Study Type -->
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">Study Type:</label>
                                        <select name="study_type" class="form-select form-select-sm">
                                            <option value="" {% if not request.GET.study_type %}selected{% endif %}>Any</option>
                                            <option value="clinical_trial" {% if request.GET.study_type == 'clinical_trial' %}selected{% endif %}>Clinical Trial</option>
                                            <option value="meta_analysis" {% if request.GET.study_type == 'meta_analysis' %}selected{% endif %}>Meta-Analysis</option>
                                            <option value="systematic_review" {% if request.GET.study_type == 'systematic_review' %}selected{% endif %}>Systematic Review</option>
                                            <option value="case_study" {% if request.GET.study_type == 'case_study' %}selected{% endif %}>Case Study</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Language -->
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">Language:</label>
                                        <select name="language" class="form-select form-select-sm">
                                            <option value="" {% if not request.GET.language %}selected{% endif %}>Any Language</option>
                                            <option value="english" {% if request.GET.language == 'english' %}selected{% endif %}>English</option>
                                            <option value="japanese" {% if request.GET.language == 'japanese' %}selected{% endif %}>Japanese</option>
                                            <option value="chinese" {% if request.GET.language == 'chinese' %}selected{% endif %}>Chinese</option>
                                            <option value="german" {% if request.GET.language == 'german' %}selected{% endif %}>German</option>
                                            <option value="french" {% if request.GET.language == 'french' %}selected{% endif %}>French</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Filter Actions -->
                                <div class="d-flex justify-content-between align-items-center mt-3 pt-3 border-top">
                                    <div>
                                        <button type="button" class="btn btn-outline-secondary btn-sm" id="clearFilters">
                                            <i class="fas fa-times"></i> Clear All Filters
                                        </button>
                                        {% if user.is_authenticated %}
                                        <button type="button" class="btn btn-outline-success btn-sm ms-2" id="saveSearch">
                                            <i class="fas fa-bookmark"></i> Save Search
                                        </button>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <span class="text-muted me-2">Active filters: <span id="activeFilterCount">0</span></span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Project Selection and Actions -->
                            <div class="d-flex flex-wrap gap-2 align-items-center">
                                {% if user.is_authenticated %}
                                <select name="project" class="form-select form-select-sm w-auto">
                                    <option value="">Save to project...</option>
                                    <option value="default">My Research</option>
                                    <option value="ml-project">Machine Learning Project</option>
                                    <option value="thesis">PhD Thesis</option>
                                </select>
                                <!-- Saved Searches Dropdown -->
                                <div class="dropdown">
                                    <button class="btn btn-outline-info btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="fas fa-history"></i> Saved Searches
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><h6 class="dropdown-header">Recent Searches</h6></li>
                                        <li><a class="dropdown-item" href="?q=neural+mechanisms+visual+attention">neural mechanisms visual attention</a></li>
                                        <li><a class="dropdown-item" href="?q=machine+learning+neuroscience">machine learning neuroscience</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item" href="#" onclick="showSavedSearches()"><i class="fas fa-bookmark"></i> Manage Saved Searches</a></li>
                                    </ul>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
</div>

<div class="container">
    {% if has_results %}
        <!-- Search Results -->
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <!-- Results Header -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <h5 class="mb-0">Search Results</h5>
                        <small class="text-muted" id="searchResultsText">
                            Found {{ results|length }} result{{ results|length|pluralize }} for "{{ query }}" 
                            {% if results %}
                                <span id="sourceDisplay">from selected sources</span>
                            {% endif %}
                        </small>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        
                        <div>
                            <small class="text-muted">Sort by:</small>
                            <select name="sort_by" class="form-select form-select-sm d-inline-block w-auto ms-2" id="sortSelect">
                                <option value="relevance" {% if request.GET.sort_by == 'relevance' or not request.GET.sort_by %}selected{% endif %}>Most Relevant</option>
                                <option value="date" {% if request.GET.sort_by == 'date' %}selected{% endif %}>Most Recent</option>
                                <option value="citations" {% if request.GET.sort_by == 'citations' %}selected{% endif %}>Most Cited</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- API Key Alert -->
                {% if missing_api_keys %}
                <div class="alert alert-warning alert-dismissible fade show mb-3" role="alert">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-key me-2 text-warning"></i>
                        <div class="flex-grow-1">
                            <strong>Improve Your Search Performance!</strong><br>
                            <small>Missing API keys for: <strong>{{ missing_api_keys|join:", "|title }}</strong>. 
                            Add them for higher rate limits and more comprehensive results.</small>
                        </div>
                        <a href="{% url 'scholar_app:api_keys' %}" class="btn btn-warning btn-sm ms-2">
                            <i class="fas fa-plus"></i> Add API Keys
                        </a>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endif %}
                
                <!-- Progressive Loading Status -->
                <div id="progressiveLoadingStatus" class="u-hidden">
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="d-flex flex-wrap gap-3 align-items-center">
                                <div class="progress-source" data-source="pubmed">
                                    <span class="badge bg-secondary">PubMed</span>
                                    <div class="spinner-border spinner-border-sm ms-2" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <span class="count ms-1">0</span>
                                </div>
                                <div class="progress-source" data-source="google_scholar">
                                    <span class="badge bg-secondary">Google Scholar</span>
                                    <div class="spinner-border spinner-border-sm ms-2" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <span class="count ms-1">0</span>
                                </div>
                                <div class="progress-source" data-source="arxiv">
                                    <span class="badge bg-secondary">arXiv</span>
                                    <div class="spinner-border spinner-border-sm ms-2" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <span class="count ms-1">0</span>
                                </div>
                                <div class="progress-source" data-source="semantic">
                                    <span class="badge bg-secondary">Semantic Scholar</span>
                                    <div class="spinner-border spinner-border-sm ms-2" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <span class="count ms-1">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Progressive Results Container -->
                <div id="progressiveResults" class="u-hidden"></div>

                <!-- Search Results -->
                {% for result in results %}
                <div class="result-card" data-paper-id="{{ result.id }}" data-title="{{ result.title }}" data-authors="{{ result.authors }}" data-year="{{ result.year }}" data-journal="{{ result.journal|default:'Unknown Journal' }}" data-doi="{{ result.doi|default:'' }}" data-pmid="{{ result.pmid|default:'' }}" data-arxiv-id="{{ result.arxiv_id|default:'' }}" data-external-url="{{ result.external_url|default:'' }}" data-source="{{ result.source|default:'' }}">
                    <h6 class="result-title">
                        <a href="#" class="text-decoration-none" onclick="viewOnWeb(this)">
                            {{ result.title }}
                        </a>
                    </h6>
                    <div class="result-authors">
                        {{ result.authors }}
                    </div>
                    <div class="d-flex align-items-center mt-2 flex-wrap">
                        <span class="year-badge me-2">{{ result.year }}</span>
                        {% if result.is_open_access %}
                        <span class="open-access me-2">Open Access</span>
                        {% endif %}
                        {% if result.impact_factor %}
                        <span class="badge bg-warning text-dark me-2 u-text-muted-xs">
                            IF: {{ result.impact_factor }}
                        </span>
                        {% endif %}
                        <small class="text-muted">
                            {{ result.journal|default:"Unknown Journal" }}
                            {% if result.citations and result.citations > 0 %}
                                ‚Ä¢ <strong>{{ result.citations }} citations</strong>
                                {% if result.citation_source %}
                                    <span class="badge bg-light text-dark" style="font-size: 0.6rem;" title="Citation data source">{{ result.citation_source|upper }}</span>
                                {% endif %}
                            {% elif result.citations == 0 %}
                                ‚Ä¢ <span class="text-muted">0 citations</span>
                            {% else %}
                                ‚Ä¢ <span class="text-muted">Citations unavailable</span>
                            {% endif %}
                            {% if result.pmid %}
                                ‚Ä¢ PMID: {{ result.pmid }}
                            {% endif %}
                        </small>
                        {% if result.source %}
                        <span class="badge bg-info ms-2 u-text-muted-xs">{{ result.source|upper }}</span>
                        {% endif %}
                    </div>
                    
                    <!-- Abstract Section -->
                    <div class="result-snippet mt-2">
                        <div class="abstract-preview">
                            {% if result.full_abstract and result.full_abstract|length > 200 %}
                                <span class="abstract-short">{{ result.snippet|default:"No abstract available." }}</span>
                                <span class="abstract-full u-hidden">{{ result.full_abstract }}</span>
                                <a href="#" class="abstract-toggle text-primary ms-2 u-text-xs">[Show full abstract]</a>
                            {% else %}
                                {{ result.snippet|default:"No abstract available." }}
                            {% endif %}
                        </div>
                    </div>
                    <div class="mt-3">
                        {% if result.pdf_url %}
                        <a href="{{ result.pdf_url }}" class="btn btn-outline-success btn-sm me-2" target="_blank">
                            üìÑ Download PDF
                        </a>
                        {% else %}
                        <span class="btn btn-outline-secondary btn-sm me-2 disabled">
                            üìÑ No PDF
                        </span>
                        {% endif %}
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-info btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                üìù Export Citation
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="exportCitation(this, 'bibtex')">
                                    <i class="fas fa-file-code"></i> BibTeX (.bib)
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="exportCitation(this, 'ris')">
                                    <i class="fas fa-file-text"></i> RIS (.ris)
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="exportCitation(this, 'endnote')">
                                    <i class="fas fa-file-alt"></i> EndNote (.enw)
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="exportCitation(this, 'csv')">
                                    <i class="fas fa-table"></i> CSV (.csv)
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" onclick="showBibTeX(this)">
                                    <i class="fas fa-eye"></i> Quick Preview
                                </a></li>
                            </ul>
                        </div>
                        <a href="#" class="btn btn-outline-warning btn-sm me-2" onclick="saveToLibrary(this)">
                            ‚≠ê Add to Library
                        </a>
                        {% if user.is_authenticated %}
                        <a href="{% url 'scholar_app:paper_annotations' result.id %}" class="btn btn-outline-success btn-sm me-2">
                            üí¨ Annotate
                        </a>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}

                <!-- Simple Pagination -->
                <div class="text-center mt-4">
                    <nav>
                        <ul class="pagination justify-content-center">
                            <li class="page-item disabled">
                                <span class="page-link">Previous</span>
                            </li>
                            <li class="page-item active">
                                <span class="page-link">1</span>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="#">2</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="#">3</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="#">Next</a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    {% else %}
        <!-- <\!-- Quick Examples -\->
         !-- <div class="row justify-content-center">
         !--     <div class="col-lg-8 text-center">
         !--         <div class="mt-4">
         !--             <p class="mb-3">Try searching for:</p>
         !--             <div class="d-flex flex-wrap justify-content-center gap-2">
         !--                 <a href="?q=neural mechanisms visual attention" class="btn btn-outline-primary btn-sm">neural mechanisms visual attention</a>
         !--                 <a href="?q=machine learning neuroscience" class="btn btn-outline-primary btn-sm">machine learning neuroscience</a>
         !--                 <a href="?q=fMRI attention networks" class="btn btn-outline-primary btn-sm">fMRI attention networks</a>
         !--                 <a href="?q=computational vision models" class="btn btn-outline-primary btn-sm">computational vision models</a>
         !--             </div>
         !--         </div>
         !--     </div>
         !-- </div> -->
    {% endif %}
</div>

<!-- Configuration for JavaScript -->
<script>
// Django template variables for JavaScript
window.SCHOLAR_CONFIG = {
    urls: {
        bibtexUpload: '{% url "scholar_app:bibtex_upload" %}',
        resourceStatus: '{% url "scholar_app:bibtex_resource_status" %}'
    },
    user: {
        isAuthenticated: {% if user.is_authenticated %}true{% else %}false{% endif %}
    }
};
</script>
<!-- Panel Toggle Functionality -->
<script src="{% static 'scholar_app/scripts/panel-toggle.js' %}"></script>
<!-- Main Scholar Index Functionality -->
<script src="{% static 'scholar_app/scripts/scholar-index-main.js' %}"></script>

{% endblock %}

