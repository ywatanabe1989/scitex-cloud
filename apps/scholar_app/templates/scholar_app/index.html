{% extends "scholar_app/scholar_base.html" %}
{% load static %}

{% block title %}SciTeX Scholar - Literature Search{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/components/hero.css' %}">
<link rel="stylesheet" href="{% static 'css/common/scitex-components.css' %}">
<link rel="stylesheet" href="{% static 'css/common/terminal-log.css' %}">
<link rel="stylesheet" href="{% static 'css/common.css' %}">
<link rel="stylesheet" href="{% static 'scholar_app/styles/scholar-index.css' %}">
{% endblock %}

{% block extra_js %}

{% endblock %}

{% block content %}
<!-- Split-Screen Layout -->
<div class="container u-mt-2 u-mb-3">
  <div class="split-container" id="splitContainer">
    {% include "scholar_app/index_partials/enrich.html" %}

    {% include "scholar_app/index_partials/search.html" %}
  </div>

  {% if query %}
  <div class="mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h5 class="mb-0">Search Results</h5>
        <small class="text-muted" id="searchResultsText">
          Found {{ results|length }} result{{ results|length|pluralize }} for "{{ query }}"
          {% if results %}
          <span id="sourceDisplay">from selected sources</span>
          {% endif %}
        </small>
      </div>
      <div class="d-flex align-items-center gap-2">

        <div>
          <small class="text-muted">Sort by:</small>
          <select name="sort_by" class="form-select form-select-sm d-inline-block w-auto ms-2" id="sortSelect">
            <option value="relevance" {% if request.GET.sort_by == 'relevance' or not request.GET.sort_by %}selected{% endif %}>Most Relevant</option>
            <option value="date" {% if request.GET.sort_by == 'date' %}selected{% endif %}>Most Recent</option>
            <option value="citations" {% if request.GET.sort_by == 'citations' %}selected{% endif %}>Most Cited</option>
          </select>
        </div>
      </div>
    </div>
    
    <!-- API Key Alert -->
    {% if missing_api_keys %}
    <div class="alert alert-warning alert-dismissible fade show mb-3" role="alert">
      <div class="d-flex align-items-center">
        <i class="fas fa-key me-2 text-warning"></i>
        <div class="flex-grow-1">
          <strong>Improve Your Search Performance!</strong><br>
          <small>Missing API keys for: <strong>{{ missing_api_keys|join:", "|title }}</strong>. 
            Add them for higher rate limits and more comprehensive results.</small>
        </div>
        <a href="{% url 'scholar_app:api_keys' %}" class="btn btn-warning btn-sm ms-2">
          <i class="fas fa-plus"></i> Add API Keys
        </a>
      </div>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}
    
    <!-- Progressive Loading Status -->
    <div id="progressiveLoadingStatus" class="u-hidden">
      <div class="row mb-3">
        <div class="col-12">
          <div class="d-flex flex-wrap gap-3 align-items-center">
            <div class="progress-source" data-source="pubmed">
              <span class="badge bg-secondary">PubMed</span>
              <div class="spinner-border spinner-border-sm ms-2" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <span class="count ms-1">0</span>
            </div>
            <div class="progress-source" data-source="google_scholar">
              <span class="badge bg-secondary">Google Scholar</span>
              <div class="spinner-border spinner-border-sm ms-2" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <span class="count ms-1">0</span>
            </div>
            <div class="progress-source" data-source="arxiv">
              <span class="badge bg-secondary">arXiv</span>
              <div class="spinner-border spinner-border-sm ms-2" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <span class="count ms-1">0</span>
            </div>
            <div class="progress-source" data-source="semantic">
              <span class="badge bg-secondary">Semantic Scholar</span>
              <div class="spinner-border spinner-border-sm ms-2" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <span class="count ms-1">0</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Progressive Results Container -->
    <div id="progressiveResults" class="u-hidden"></div>

    <!-- Search Results -->
    {% for result in results %}
    {% include "scholar_app/index_partials/result_card.html" %}
    {% endfor %}

    {% include "scholar_app/index_partials/pagination.html" %}
  </div>
</div>
</div>
{% else %}
<!-- <\!-- Quick Examples -\->
     !-- <div class="row justify-content-center">
     !--     <div class="col-lg-8 text-center">
     !--         <div class="mt-4">
     !--             <p class="mb-3">Try searching for:</p>
     !--             <div class="d-flex flex-wrap justify-content-center gap-2">
     !--                 <a href="?q=neural mechanisms visual attention" class="btn btn-outline-primary btn-sm">neural mechanisms visual attention</a>
     !--                 <a href="?q=machine learning neuroscience" class="btn btn-outline-primary btn-sm">machine learning neuroscience</a>
     !--                 <a href="?q=fMRI attention networks" class="btn btn-outline-primary btn-sm">fMRI attention networks</a>
     !--                 <a href="?q=computational vision models" class="btn btn-outline-primary btn-sm">computational vision models</a>
     !--             </div>
     !--         </div>
     !--     </div>
     !-- </div> -->
     {% endif %}
</div>

<!-- Configuration for JavaScript -->
<script>
  // Django template variables for JavaScript
  window.SCHOLAR_CONFIG = {
  urls: {
  bibtexUpload: '{% url "scholar_app:bibtex_upload" %}',
  resourceStatus: '{% url "scholar_app:bibtex_resource_status" %}'
  },
  user: {
  isAuthenticated: {% if user.is_authenticated %}true{% else %}false{% endif %}
  }
  };
</script>
<!-- Panel Toggle Functionality -->
<script src="{% static 'scholar_app/scripts/panel-toggle.js' %}"></script>
<!-- BibTeX Enrichment -->
<script src="{% static 'scholar_app/scripts/bibtex-enrichment.js' %}"></script>
<!-- Queue Management -->
<script src="{% static 'scholar_app/scripts/queue-management.js' %}"></script>
<!-- Main Scholar Index Functionality -->
<script src="{% static 'scholar_app/scripts/scholar-index-main.js' %}"></script>

{% endblock %}

