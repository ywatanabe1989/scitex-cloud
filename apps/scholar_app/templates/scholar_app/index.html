{% extends "scholar_app/scholar_base.html" %}
{% load static %}

{% block title %}SciTeX Scholar - Literature Search{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/components/hero.css' %}">
<link rel="stylesheet" href="{% static 'css/common/scitex-components.css' %}">
<link rel="stylesheet" href="{% static 'css/common/terminal-log.css' %}">
<link rel="stylesheet" href="{% static 'css/common.css' %}">
<link rel="stylesheet" href="{% static 'styles/scholar-index.css' %}">
{% endblock %}

{% block extra_js %}

{% endblock %}

{% block content %}
<!-- Split-Screen Layout -->
<div class="container u-mt-2 u-mb-3">
    <div class="split-container" id="splitContainer">
        <!-- LEFT PANEL: BibTeX Enrichment (Primary Feature) -->
        <div class="split-panel" id="bibtexPanel">
            <div class="panel-header" onclick="togglePanel('bibtex')">
                <div>
                    <i class="fas fa-file-code"></i> <span class="panel-title">BibTeX Enrichment</span>
                </div>
                <i class="fas fa-expand-alt toggle-icon"></i>
            </div>
            <div class="panel-content">
                <!-- Upload Form Area -->
                <div id="bibtexFormArea">
                    <!-- Helper Message with ASTA Instructions -->
                    <div style="background: linear-gradient(135deg, rgba(var(--info-color-rgb, 107, 143, 179), 0.1) 0%, rgba(var(--scitex-color-03-rgb, 80, 107, 122), 0.1) 100%); border-left: 4px solid var(--info-color); border-radius: 8px; padding: 1rem 1.25rem; margin-bottom: 1.5rem;">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <i class="fas fa-lightbulb" style="color: var(--info-color); font-size: 1.5rem;"></i>
                            <div style="flex: 1;">
                                <span style="color: var(--color-fg-muted); font-size: 0.95rem;">
                                    No BibTeX file? Find papers at <a href="https://asta.allen.ai/chat/" target="_blank" rel="noopener noreferrer" style="color: var(--info-color); font-weight: 600; text-decoration: none; border-bottom: 1px solid var(--info-color);">AI2 Asta</a><span class="tooltip-wrapper"><i class="fas fa-question-circle tooltip-trigger"></i><span class="tooltip-content"><h5 class="tooltip-header"><i class="fas fa-graduation-cap"></i> How to Use AI2 Asta</h5><div class="tooltip-image-grid"><div class="tooltip-image-item"><img src="{% static 'images/asta/asta-1.jpg' %}" alt="ASTA Step 1" onclick="window.open(this.src, '_blank')" class="tooltip-image"><p class="tooltip-caption"><strong>Step 1:</strong> Type query & search</p></div><div class="tooltip-image-item"><img src="{% static 'images/asta/asta-2.jpg' %}" alt="ASTA Step 2" onclick="window.open(this.src, '_blank')" class="tooltip-image"><p class="tooltip-caption"><strong>Step 2:</strong> Export Citations</p></div></div><p class="tooltip-footer"><i class="fas fa-university"></i> AI2 Asta is provided by Allen Institute</p></span></span> and <code style="background: rgba(var(--info-color-rgb, 107, 143, 179), 0.15); padding: 0.2rem 0.4rem; border-radius: 3px; color: var(--color-fg-default); font-size: 0.9rem;">Export All Citations</code><br>Once downloaded, enhance the .bib file by uploading below - <strong>Abstracts, URLs, citation counts, and impact factors of journals will be appended</strong>.
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Resource Monitoring Panel -->
                    <div id="resourceMonitorPanel" class="u-info-panel">
                        <div class="u-flex-between-mb">
                            <h4 class="u-heading-md">
                                <i class="fas fa-tasks"></i> Job Queue Status
                            </h4>
                            <span id="resourceRefreshTime" style="color: var(--color-fg-muted); font-size: 0.85rem;">Loading...</span>
                        </div>

                        <!-- Job Stats (simplified - removed CPU/Memory) -->
                        <div class="u-grid-2col">
                            <div class="u-stat-card">
                                <div class="u-text-muted-sm">Active Jobs</div>
                                <div style="color: var(--scitex-color-03); font-size: 1.5rem; font-weight: 700;">
                                    <span id="activeJobsCount">0</span>
                                </div>
                            </div>
                            <div class="u-stat-card">
                                <div class="u-text-muted-sm">Queued</div>
                                <div style="color: var(--warning-color); font-size: 1.5rem; font-weight: 700;">
                                    <span id="queuedJobsCount">0</span>
                                </div>
                            </div>
                        </div>

                        <!-- Active Jobs List -->
                        <div id="activeJobsList" style="display: none; margin-bottom: 1rem;">
                            <div class="u-heading-sm">
                                <i class="fas fa-cog fa-spin"></i> Active Jobs
                            </div>
                            <div id="activeJobsContent" class="u-scroll-container"></div>
                        </div>

                        <!-- Queued Jobs List -->
                        <div id="queuedJobsList" class="u-hidden">
                            <div class="u-heading-sm">
                                <i class="fas fa-hourglass-half"></i> Queued Jobs
                            </div>
                            <div id="queuedJobsContent" class="u-scroll-container"></div>
                        </div>
                    </div>

                    <form id="bibtexEnrichmentForm" method="post" action="{% url 'scholar_app:bibtex_upload' %}" enctype="multipart/form-data">
                    {% csrf_token %}

                    <!-- File Upload with instructions inside -->
                    <div class="u-mb-1_5">
                        <div id="dropZone" class="u-upload-zone">
                            <i class="fas fa-cloud-upload-alt u-upload-icon"></i>
                            <h3 style="color: var(--color-fg-default); margin-bottom: 0.5rem; font-size: 1.5rem; font-weight: 700;">
                                Upload your .bib file
                            </h3>
                            <p id="uploadMessage" style="color: var(--color-fg-muted); margin-bottom: 1rem; font-size: 1.05rem;">
                                Enrich with <strong>Abstract</strong>, <strong>URL</strong>, <strong>Citation Count</strong>, and <strong>Impact Factor</strong>
                            </p>
                            <div id="fileNameDisplay" style="display: none; color: var(--success-color); font-weight: 600; margin-bottom: 1rem; font-size: 1rem;">
                                <i class="fas fa-check-circle"></i> <span id="fileName"></span>
                            </div>
                            <input type="file" name="bibtex_file" id="bibtexFileInput" accept=".bib" required
                                   class="u-upload-input">
                        </div>
                    </div>

                    <!-- Progress Display Area (shown right under dropbox) -->
                    <div id="bibtexProgressArea" style="display: none; margin-top: 1.5rem;">
                        <!-- Progress Bar -->
                        <div class="u-mb-1_5">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span class="u-text-bold">Progress</span>
                                <span style="color: var(--color-fg-muted);" id="progressPercentage">0%</span>
                            </div>
                            <div style="background: var(--color-border-default); border-radius: 8px; height: 12px; overflow: hidden;">
                                <div id="progressBar" style="background: var(--scitex-color-03); height: 100%; width: 0%; transition: width 0.3s;"></div>
                            </div>
                            <div class="u-mt-0_5 u-text-muted" id="progressDetails">
                                0 / 0 papers processed
                            </div>
                        </div>

                        <!-- Processing Log -->
                        <div class="terminal-log-container">
                            <div class="terminal-log-container__header">
                                <h4 class="terminal-log-container__title">Processing Log</h4>
                                <button id="copyBibtexLogBtn" style="background: var(--color-btn-bg); border: 1px solid var(--color-border-default); border-radius: 6px; padding: 0.5rem 1rem; cursor: pointer; color: var(--color-fg-default); font-weight: 600; transition: all 0.2s;" title="Copy log to clipboard">
                                    <i class="fas fa-copy"></i> Copy Log
                                </button>
                            </div>
                            <pre id="processingLog" class="terminal-log terminal-log--medium">Initializing...</pre>
                        </div>

                        <!-- Download and Open URLs Buttons (always visible, disabled until completion) -->
                        <div id="downloadArea" class="u-flex-center">
                            <a id="downloadBtn" href="#" class="disabled" style="display: inline-block; padding: 1rem 2rem; background: var(--success-color); color: var(--white); border-radius: 8px; text-decoration: none; font-weight: 600; transition: opacity 0.3s, background 0.3s;">
                                <i class="fas fa-download"></i> Download Enriched BibTeX
                            </a>
                            <button id="showDiffBtn" onclick="showBibtexDiff()" disabled style="display: inline-block; padding: 1rem 2rem; background: var(--scitex-color-02); color: var(--white); border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: opacity 0.3s, background 0.3s;">
                                <i class="fas fa-code-branch"></i> Show What Enhanced
                            </button>
                            <button id="openUrlsBtn" onclick="openAllPaperUrls()" disabled style="display: inline-block; padding: 1rem 2rem; background: var(--scitex-color-04); color: var(--white); border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: opacity 0.3s, background 0.3s;">
                                <i class="fas fa-external-link-alt"></i> Open All URLs (<span id="urlCount">0</span>)
                            </button>
                        </div>

                        <!-- Diff View Modal (shown when user clicks "Show What Enhanced") -->
                        <div id="bibtexDiffModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 9999; overflow: auto;">
                            <div class="u-modal-container">
                                <button onclick="closeBibtexDiff()" class="u-close-btn">
                                    √ó
                                </button>
                                <h3 style="color: var(--color-fg-default); margin-bottom: 1rem;">
                                    <i class="fas fa-code-branch"></i> BibTeX Enhancement Comparison
                                </h3>
                                <p style="color: var(--color-fg-muted); margin-bottom: 1.5rem;">
                                    <span style="color: var(--success-color); font-weight: 600;">‚óè Green</span> = Added fields,
                                    <span style="color: var(--scitex-color-03); font-weight: 600;">‚óè Blue</span> = Original fields
                                </p>
                                <div id="bibtexDiffContent" class="u-terminal-log">
                                    Loading...
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Project Selection -->
                    {% if user.is_authenticated %}
                    <div class="u-mb-1_5">
                        <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--color-fg-default);">
                            <i class="fas fa-folder"></i> Save to project
                        </label>
                        <select name="project_id" style="display: block; width: 100%; padding: 0.75rem; border: 1px solid var(--color-border-default); border-radius: 6px; background: var(--color-canvas-default); color: var(--color-fg-default);">
                            <option value="">-- No Project --</option>
                            {% for project in user_projects %}
                            <option value="{{ project.id }}">{{ project.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}
                    </form>
                </div>
            </div>
        </div>

        <!-- LEFT PANEL: BibTeX Enrichment (Primary Feature) -->
        <div class="split-panel" id="bibtexPanel">
            <div class="panel-header" onclick="togglePanel('search')">
                <div>
                    <i class="fas fa-search"></i> <span class="panel-title">Literature Search</span>
                </div>
                <i class="fas fa-expand-alt toggle-icon"></i>
            </div>
            <div class="panel-content">
                <div class="search-card-inner">
                    <form id="literatureSearchForm" method="get" action="{% url 'scholar_app:simple_search' %}">
                        <div class="input-group input-group-lg">
                            <input type="text" name="q" class="form-control search-input" 
                                   placeholder="Enter keywords here..."
                                   value="{{ query }}" autofocus>
                            <button type="submit" class="btn search-btn" id="searchButton">
                                üîç Search
                            </button>
                        </div>
                        
                        <div class="mt-3">
                            <!-- Advanced Filters Toggle -->
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <small style="color: var(--color-fg-default); font-weight: 600;">Filters:</small>
                                <button type="button" class="btn btn-outline-secondary btn-sm" id="toggleAdvancedFilters" style="border-color: var(--scitex-color-05); color: var(--color-fg-default); background: var(--color-canvas-subtle);">
                                    <i class="fas fa-sliders-h"></i> Advanced Filters
                                </button>
                            </div>

                            <!-- Basic Filters -->
                            <div id="basicFilters" class="row g-3 mb-3">
                                <!-- Source Selection -->
                                <div class="col-md-6">
                                    <label class="form-label fw-bold u-text-default">Search Sources:</label>
                                    <div class="d-flex flex-wrap gap-2">
                                        <div class="scitex-toggle-wrapper">
                                            <input class="scitex-toggle all-sources-toggle" type="checkbox" id="source_all_toggle" {% if not request.GET.source_pubmed and not request.GET.source_google_scholar and not request.GET.source_arxiv and not request.GET.source_semantic %}checked{% endif %}>
                                            <label class="scitex-toggle-label" for="source_all_toggle">All Sources</label>
                                        </div>
                                        <div class="scitex-toggle-wrapper">
                                            <input class="scitex-toggle source-toggle" type="checkbox" name="source_pubmed" id="source_pubmed" value="pubmed" {% if request.GET.source_pubmed %}checked{% endif %}>
                                            <label class="scitex-toggle-label" for="source_pubmed">PubMed</label>
                                        </div>
                                        <div class="scitex-toggle-wrapper">
                                            <input class="scitex-toggle source-toggle" type="checkbox" name="source_google_scholar" id="source_google_scholar" value="google_scholar" {% if request.GET.source_google_scholar %}checked{% endif %}>
                                            <label class="scitex-toggle-label" for="source_google_scholar">Google Scholar</label>
                                        </div>
                                        <div class="scitex-toggle-wrapper">
                                            <input class="scitex-toggle source-toggle" type="checkbox" name="source_arxiv" id="source_arxiv" value="arxiv" {% if request.GET.source_arxiv %}checked{% endif %}>
                                            <label class="scitex-toggle-label" for="source_arxiv">arXiv</label>
                                        </div>
                                        <div class="scitex-toggle-wrapper">
                                            <input class="scitex-toggle source-toggle" type="checkbox" name="source_semantic" id="source_semantic" value="semantic" {% if request.GET.source_semantic %}checked{% endif %}>
                                            <label class="scitex-toggle-label" for="source_semantic">Semantic Scholar</label>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Quick Filters -->
                                <div class="col-md-6">
                                    <label class="form-label fw-bold u-text-default">Quick Filters:</label>
                                    <div class="d-flex flex-wrap gap-2">
                                        <div class="scitex-checkbox-wrapper">
                                            <input class="scitex-checkbox" type="checkbox" name="open_access" id="open_access" {% if request.GET.open_access %}checked{% endif %}>
                                            <label class="scitex-checkbox-label" for="open_access">Open Access Only</label>
                                        </div>
                                        <div class="scitex-checkbox-wrapper">
                                            <input class="scitex-checkbox" type="checkbox" name="recent_only" id="recent_only" {% if request.GET.recent_only %}checked{% endif %}>
                                            <label class="scitex-checkbox-label" for="recent_only">Last 5 Years</label>
                                        </div>
                                        <div class="scitex-checkbox-wrapper">
                                            <input class="scitex-checkbox" type="checkbox" name="high_impact" id="high_impact" {% if request.GET.high_impact %}checked{% endif %}>
                                            <label class="scitex-checkbox-label" for="high_impact">High Impact (IF > 5)</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Advanced Filters -->
                            <div id="advancedFilters" class="border rounded p-3 mb-3" style="display: none; background: #f8f9fa;">
                                <div class="row g-3">
                                    <!-- Year Range -->
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">Publication Year Range:</label>
                                        <div class="d-flex gap-2 align-items-center">
                                            <input type="number" name="year_from" class="form-control form-control-sm" placeholder="From" min="1900" max="2024" value="{{ request.GET.year_from }}">
                                            <span>to</span>
                                            <input type="number" name="year_to" class="form-control form-control-sm" placeholder="To" min="1900" max="2024" value="{{ request.GET.year_to }}">
                                        </div>
                                    </div>
                                    
                                    <!-- Citation Count -->
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">Minimum Citations:</label>
                                        <select name="min_citations" class="form-select form-select-sm">
                                            <option value="" {% if not request.GET.min_citations %}selected{% endif %}>Any</option>
                                            <option value="10" {% if request.GET.min_citations == '10' %}selected{% endif %}>10+</option>
                                            <option value="50" {% if request.GET.min_citations == '50' %}selected{% endif %}>50+</option>
                                            <option value="100" {% if request.GET.min_citations == '100' %}selected{% endif %}>100+</option>
                                            <option value="500" {% if request.GET.min_citations == '500' %}selected{% endif %}>500+</option>
                                            <option value="1000" {% if request.GET.min_citations == '1000' %}selected{% endif %}>1000+</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Impact Factor -->
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">Journal Impact Factor:</label>
                                        <select name="min_impact_factor" class="form-select form-select-sm">
                                            <option value="" {% if not request.GET.min_impact_factor %}selected{% endif %}>Any</option>
                                            <option value="1" {% if request.GET.min_impact_factor == '1' %}selected{% endif %}>1.0+</option>
                                            <option value="3" {% if request.GET.min_impact_factor == '3' %}selected{% endif %}>3.0+</option>
                                            <option value="5" {% if request.GET.min_impact_factor == '5' %}selected{% endif %}>5.0+</option>
                                            <option value="10" {% if request.GET.min_impact_factor == '10' %}selected{% endif %}>10.0+</option>
                                            <option value="20" {% if request.GET.min_impact_factor == '20' %}selected{% endif %}>20.0+</option>
                                        </select>
                                        <small class="text-muted">üí° Check journal rankings at <a href="https://www.scimagojr.com/journalrank.php" target="_blank" class="text-decoration-none">ScimagoJR</a></small>
                                    </div>
                                    
                                    <!-- Author Filter -->
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Author(s):</label>
                                        <input type="text" name="author" class="form-control form-control-sm" placeholder="e.g., Smith, Johnson" value="{{ request.GET.author }}">
                                        <small class="text-muted">Separate multiple authors with commas</small>
                                    </div>
                                    
                                    <!-- Journal Filter -->
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Journal:</label>
                                        <input type="text" name="journal" class="form-control form-control-sm" placeholder="e.g., Nature, Science" value="{{ request.GET.journal }}">
                                        <small class="text-muted">Journal name or partial name</small>
                                    </div>
                                    
                                    <!-- Document Type -->
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">Document Type:</label>
                                        <select name="doc_type" class="form-select form-select-sm">
                                            <option value="" {% if not request.GET.doc_type %}selected{% endif %}>All Types</option>
                                            <option value="article" {% if request.GET.doc_type == 'article' %}selected{% endif %}>Research Article</option>
                                            <option value="review" {% if request.GET.doc_type == 'review' %}selected{% endif %}>Review</option>
                                            <option value="preprint" {% if request.GET.doc_type == 'preprint' %}selected{% endif %}>Preprint</option>
                                            <option value="conference" {% if request.GET.doc_type == 'conference' %}selected{% endif %}>Conference Paper</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Study Type -->
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">Study Type:</label>
                                        <select name="study_type" class="form-select form-select-sm">
                                            <option value="" {% if not request.GET.study_type %}selected{% endif %}>Any</option>
                                            <option value="clinical_trial" {% if request.GET.study_type == 'clinical_trial' %}selected{% endif %}>Clinical Trial</option>
                                            <option value="meta_analysis" {% if request.GET.study_type == 'meta_analysis' %}selected{% endif %}>Meta-Analysis</option>
                                            <option value="systematic_review" {% if request.GET.study_type == 'systematic_review' %}selected{% endif %}>Systematic Review</option>
                                            <option value="case_study" {% if request.GET.study_type == 'case_study' %}selected{% endif %}>Case Study</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Language -->
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">Language:</label>
                                        <select name="language" class="form-select form-select-sm">
                                            <option value="" {% if not request.GET.language %}selected{% endif %}>Any Language</option>
                                            <option value="english" {% if request.GET.language == 'english' %}selected{% endif %}>English</option>
                                            <option value="japanese" {% if request.GET.language == 'japanese' %}selected{% endif %}>Japanese</option>
                                            <option value="chinese" {% if request.GET.language == 'chinese' %}selected{% endif %}>Chinese</option>
                                            <option value="german" {% if request.GET.language == 'german' %}selected{% endif %}>German</option>
                                            <option value="french" {% if request.GET.language == 'french' %}selected{% endif %}>French</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Filter Actions -->
                                <div class="d-flex justify-content-between align-items-center mt-3 pt-3 border-top">
                                    <div>
                                        <button type="button" class="btn btn-outline-secondary btn-sm" id="clearFilters">
                                            <i class="fas fa-times"></i> Clear All Filters
                                        </button>
                                        {% if user.is_authenticated %}
                                        <button type="button" class="btn btn-outline-success btn-sm ms-2" id="saveSearch">
                                            <i class="fas fa-bookmark"></i> Save Search
                                        </button>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <span class="text-muted me-2">Active filters: <span id="activeFilterCount">0</span></span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Project Selection and Actions -->
                            <div class="d-flex flex-wrap gap-2 align-items-center">
                                {% if user.is_authenticated %}
                                <select name="project" class="form-select form-select-sm w-auto">
                                    <option value="">Save to project...</option>
                                    <option value="default">My Research</option>
                                    <option value="ml-project">Machine Learning Project</option>
                                    <option value="thesis">PhD Thesis</option>
                                </select>
                                <!-- Saved Searches Dropdown -->
                                <div class="dropdown">
                                    <button class="btn btn-outline-info btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="fas fa-history"></i> Saved Searches
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><h6 class="dropdown-header">Recent Searches</h6></li>
                                        <li><a class="dropdown-item" href="?q=neural+mechanisms+visual+attention">neural mechanisms visual attention</a></li>
                                        <li><a class="dropdown-item" href="?q=machine+learning+neuroscience">machine learning neuroscience</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item" href="#" onclick="showSavedSearches()"><i class="fas fa-bookmark"></i> Manage Saved Searches</a></li>
                                    </ul>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
</div>

<div class="container">
    {% if has_results %}
        <!-- Search Results -->
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <!-- Results Header -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <h5 class="mb-0">Search Results</h5>
                        <small class="text-muted" id="searchResultsText">
                            Found {{ results|length }} result{{ results|length|pluralize }} for "{{ query }}" 
                            {% if results %}
                                <span id="sourceDisplay">from selected sources</span>
                            {% endif %}
                        </small>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        
                        <div>
                            <small class="text-muted">Sort by:</small>
                            <select name="sort_by" class="form-select form-select-sm d-inline-block w-auto ms-2" id="sortSelect">
                                <option value="relevance" {% if request.GET.sort_by == 'relevance' or not request.GET.sort_by %}selected{% endif %}>Most Relevant</option>
                                <option value="date" {% if request.GET.sort_by == 'date' %}selected{% endif %}>Most Recent</option>
                                <option value="citations" {% if request.GET.sort_by == 'citations' %}selected{% endif %}>Most Cited</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- API Key Alert -->
                {% if missing_api_keys %}
                <div class="alert alert-warning alert-dismissible fade show mb-3" role="alert">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-key me-2 text-warning"></i>
                        <div class="flex-grow-1">
                            <strong>Improve Your Search Performance!</strong><br>
                            <small>Missing API keys for: <strong>{{ missing_api_keys|join:", "|title }}</strong>. 
                            Add them for higher rate limits and more comprehensive results.</small>
                        </div>
                        <a href="{% url 'scholar_app:api_keys' %}" class="btn btn-warning btn-sm ms-2">
                            <i class="fas fa-plus"></i> Add API Keys
                        </a>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endif %}
                
                <!-- Progressive Loading Status -->
                <div id="progressiveLoadingStatus" class="u-hidden">
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="d-flex flex-wrap gap-3 align-items-center">
                                <div class="progress-source" data-source="pubmed">
                                    <span class="badge bg-secondary">PubMed</span>
                                    <div class="spinner-border spinner-border-sm ms-2" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <span class="count ms-1">0</span>
                                </div>
                                <div class="progress-source" data-source="google_scholar">
                                    <span class="badge bg-secondary">Google Scholar</span>
                                    <div class="spinner-border spinner-border-sm ms-2" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <span class="count ms-1">0</span>
                                </div>
                                <div class="progress-source" data-source="arxiv">
                                    <span class="badge bg-secondary">arXiv</span>
                                    <div class="spinner-border spinner-border-sm ms-2" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <span class="count ms-1">0</span>
                                </div>
                                <div class="progress-source" data-source="semantic">
                                    <span class="badge bg-secondary">Semantic Scholar</span>
                                    <div class="spinner-border spinner-border-sm ms-2" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <span class="count ms-1">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Progressive Results Container -->
                <div id="progressiveResults" class="u-hidden"></div>

                <!-- Search Results -->
                {% for result in results %}
                <div class="result-card" data-paper-id="{{ result.id }}" data-title="{{ result.title }}" data-authors="{{ result.authors }}" data-year="{{ result.year }}" data-journal="{{ result.journal|default:'Unknown Journal' }}" data-doi="{{ result.doi|default:'' }}" data-pmid="{{ result.pmid|default:'' }}" data-arxiv-id="{{ result.arxiv_id|default:'' }}" data-external-url="{{ result.external_url|default:'' }}" data-source="{{ result.source|default:'' }}">
                    <h6 class="result-title">
                        <a href="#" class="text-decoration-none" onclick="viewOnWeb(this)">
                            {{ result.title }}
                        </a>
                    </h6>
                    <div class="result-authors">
                        {{ result.authors }}
                    </div>
                    <div class="d-flex align-items-center mt-2 flex-wrap">
                        <span class="year-badge me-2">{{ result.year }}</span>
                        {% if result.is_open_access %}
                        <span class="open-access me-2">Open Access</span>
                        {% endif %}
                        {% if result.impact_factor %}
                        <span class="badge bg-warning text-dark me-2 u-text-muted-xs">
                            IF: {{ result.impact_factor }}
                        </span>
                        {% endif %}
                        <small class="text-muted">
                            {{ result.journal|default:"Unknown Journal" }}
                            {% if result.citations and result.citations > 0 %}
                                ‚Ä¢ <strong>{{ result.citations }} citations</strong>
                                {% if result.citation_source %}
                                    <span class="badge bg-light text-dark" style="font-size: 0.6rem;" title="Citation data source">{{ result.citation_source|upper }}</span>
                                {% endif %}
                            {% elif result.citations == 0 %}
                                ‚Ä¢ <span class="text-muted">0 citations</span>
                            {% else %}
                                ‚Ä¢ <span class="text-muted">Citations unavailable</span>
                            {% endif %}
                            {% if result.pmid %}
                                ‚Ä¢ PMID: {{ result.pmid }}
                            {% endif %}
                        </small>
                        {% if result.source %}
                        <span class="badge bg-info ms-2 u-text-muted-xs">{{ result.source|upper }}</span>
                        {% endif %}
                    </div>
                    
                    <!-- Abstract Section -->
                    <div class="result-snippet mt-2">
                        <div class="abstract-preview">
                            {% if result.full_abstract and result.full_abstract|length > 200 %}
                                <span class="abstract-short">{{ result.snippet|default:"No abstract available." }}</span>
                                <span class="abstract-full u-hidden">{{ result.full_abstract }}</span>
                                <a href="#" class="abstract-toggle text-primary ms-2 u-text-xs">[Show full abstract]</a>
                            {% else %}
                                {{ result.snippet|default:"No abstract available." }}
                            {% endif %}
                        </div>
                    </div>
                    <div class="mt-3">
                        {% if result.pdf_url %}
                        <a href="{{ result.pdf_url }}" class="btn btn-outline-success btn-sm me-2" target="_blank">
                            üìÑ Download PDF
                        </a>
                        {% else %}
                        <span class="btn btn-outline-secondary btn-sm me-2 disabled">
                            üìÑ No PDF
                        </span>
                        {% endif %}
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-info btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                üìù Export Citation
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="exportCitation(this, 'bibtex')">
                                    <i class="fas fa-file-code"></i> BibTeX (.bib)
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="exportCitation(this, 'ris')">
                                    <i class="fas fa-file-text"></i> RIS (.ris)
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="exportCitation(this, 'endnote')">
                                    <i class="fas fa-file-alt"></i> EndNote (.enw)
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="exportCitation(this, 'csv')">
                                    <i class="fas fa-table"></i> CSV (.csv)
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" onclick="showBibTeX(this)">
                                    <i class="fas fa-eye"></i> Quick Preview
                                </a></li>
                            </ul>
                        </div>
                        <a href="#" class="btn btn-outline-warning btn-sm me-2" onclick="saveToLibrary(this)">
                            ‚≠ê Add to Library
                        </a>
                        {% if user.is_authenticated %}
                        <a href="{% url 'scholar_app:paper_annotations' result.id %}" class="btn btn-outline-success btn-sm me-2">
                            üí¨ Annotate
                        </a>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}

                <!-- Simple Pagination -->
                <div class="text-center mt-4">
                    <nav>
                        <ul class="pagination justify-content-center">
                            <li class="page-item disabled">
                                <span class="page-link">Previous</span>
                            </li>
                            <li class="page-item active">
                                <span class="page-link">1</span>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="#">2</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="#">3</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="#">Next</a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    {% else %}
        <!-- <\!-- Quick Examples -\->
         !-- <div class="row justify-content-center">
         !--     <div class="col-lg-8 text-center">
         !--         <div class="mt-4">
         !--             <p class="mb-3">Try searching for:</p>
         !--             <div class="d-flex flex-wrap justify-content-center gap-2">
         !--                 <a href="?q=neural mechanisms visual attention" class="btn btn-outline-primary btn-sm">neural mechanisms visual attention</a>
         !--                 <a href="?q=machine learning neuroscience" class="btn btn-outline-primary btn-sm">machine learning neuroscience</a>
         !--                 <a href="?q=fMRI attention networks" class="btn btn-outline-primary btn-sm">fMRI attention networks</a>
         !--                 <a href="?q=computational vision models" class="btn btn-outline-primary btn-sm">computational vision models</a>
         !--             </div>
         !--         </div>
         !--     </div>
         !-- </div> -->
    {% endif %}
</div>

<!-- Configuration for JavaScript -->
<script>
// Django template variables for JavaScript
window.SCHOLAR_CONFIG = {
    urls: {
        bibtexUpload: '{% url "scholar_app:bibtex_upload" %}',
        resourceStatus: '{% url "scholar_app:bibtex_resource_status" %}'
    },
    user: {
        isAuthenticated: {% if user.is_authenticated %}true{% else %}false{% endif %}
    }
};
</script>
<!-- Panel Toggle Functionality -->
<script src="{% static 'scripts/panel-toggle.js' %}"></script>
<!-- Main Scholar Index Functionality -->
<script src="{% static 'scripts/scholar-index-main.js' %}"></script>

{% endblock %}

