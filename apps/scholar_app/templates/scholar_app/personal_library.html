{% extends "scholar_app/scholar_base.html" %}
{% load static %}

{% block title %}Personal Library - SciTeX Scholar{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/components/hero.css' %}">
<style>
    .library-hero {
        background: linear-gradient(135deg, #1a2332 0%, #34495e 100%);
        color: white;
        padding: 3rem 0;
        margin-bottom: 2rem;
    }
    .stats-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        text-align: center;
        border-left: 4px solid #1a2332;
    }
    .stats-number {
        font-size: 2rem;
        font-weight: bold;
        color: #1a2332;
    }
    .collection-card {
        background: white;
        border-radius: 12px;
        padding: 1rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border-left: 4px solid var(--collection-color, #1a2332);
        cursor: pointer;
        transition: transform 0.2s ease;
    }
    .collection-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    }
    .paper-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border-left: 4px solid #1a2332;
    }
    .paper-title {
        color: #1a2332;
        font-weight: 600;
        font-size: 1.1rem;
        margin-bottom: 0.5rem;
        text-decoration: none;
    }
    .paper-meta {
        color: #7f8c8d;
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
    }
    .reading-status {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
    }
    .status-to_read { background: #e3f2fd; color: #1976d2; }
    .status-reading { background: #fff3e0; color: #f57c00; }
    .status-read { background: #e8f5e8; color: #388e3c; }
    .status-referenced { background: #f3e5f5; color: #7b1fa2; }
    .status-favorite { background: #ffebee; color: #d32f2f; }
    
    .importance-stars {
        color: #ffc107;
    }
    .tag {
        display: inline-block;
        background: #e9ecef;
        color: #495057;
        padding: 0.25rem 0.5rem;
        border-radius: 8px;
        font-size: 0.75rem;
        margin-right: 0.25rem;
        margin-bottom: 0.25rem;
    }
    .filter-sidebar {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    .search-input {
        border: 1px solid #ced4da;
        border-radius: 8px;
        padding: 0.75rem;
        width: 100%;
        margin-bottom: 1rem;
    }
    .create-collection-btn {
        background: #28a745;
        color: white;
        border: none;
        border-radius: 8px;
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
        cursor: pointer;
        transition: background 0.2s ease;
    }
    .create-collection-btn:hover {
        background: #218838;
    }
</style>
{% endblock %}

{% block content %}
<!-- Library Hero -->
<div class="library-hero">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8 text-center">
                <h1 class="hero-title">Personal Research Library</h1>
                <p class="hero-subtitle">Organize, manage, and explore your saved research papers</p>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <!-- Library Statistics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-number">{{ total_papers }}</div>
                <div class="text-muted">Total Papers</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-number">{{ collections.count }}</div>
                <div class="text-muted">Collections</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-number">{{ status_stats.read.count }}</div>
                <div class="text-muted">Papers Read</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-number">{{ status_stats.to_read.count }}</div>
                <div class="text-muted">To Read</div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Sidebar -->
        <div class="col-lg-3">
            <div class="filter-sidebar">
                <!-- Search -->
                <h6 class="fw-bold mb-3">Search Library</h6>
                <input type="text" id="librarySearch" class="search-input" placeholder="Search papers, notes, tags...">
                
                <!-- Collections -->
                <h6 class="fw-bold mb-3 mt-4">Collections</h6>
                <div class="mb-3">
                    <button class="create-collection-btn" onclick="showCreateCollectionModal()">
                        <i class="fas fa-plus"></i> New Collection
                    </button>
                </div>
                
                <div id="collectionsFilter">
                    <div class="collection-card mb-2" data-collection-id="" onclick="filterByCollection('')">
                        <i class="fas fa-list text-muted"></i>
                        <strong class="ms-2">All Papers</strong>
                        <span class="badge bg-secondary float-end">{{ total_papers }}</span>
                    </div>
                    {% for collection in collections %}
                    <div class="collection-card mb-2" 
                         data-collection-id="{{ collection.id }}" 
                         style="--collection-color: {{ collection.color }}"
                         onclick="filterByCollection('{{ collection.id }}')">
                        <i class="{{ collection.icon }}" style="color: {{ collection.color }}"></i>
                        <strong class="ms-2">{{ collection.name }}</strong>
                        <span class="badge bg-secondary float-end">{{ collection.paper_count }}</span>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Reading Status Filter -->
                <h6 class="fw-bold mb-3 mt-4">Reading Status</h6>
                <div id="statusFilter">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="statusFilter" id="status_all" value="" checked>
                        <label class="form-check-label" for="status_all">All Status</label>
                    </div>
                    {% for status_code, status_data in status_stats.items %}
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="statusFilter" id="status_{{ status_code }}" value="{{ status_code }}">
                        <label class="form-check-label" for="status_{{ status_code }}">
                            {{ status_data.name }} ({{ status_data.count }})
                        </label>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Sort Options -->
                <h6 class="fw-bold mb-3 mt-4">Sort By</h6>
                <select id="sortSelect" class="form-select">
                    <option value="-saved_at">Recently Added</option>
                    <option value="saved_at">Oldest First</option>
                    <option value="paper__title">Title (A-Z)</option>
                    <option value="-importance_rating">Importance Rating</option>
                    <option value="-updated_at">Recently Updated</option>
                </select>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="col-lg-9">
            <!-- Papers List -->
            <div id="papersContainer">
                <!-- Papers will be loaded here -->
            </div>
            
            <!-- Loading State -->
            <div id="loadingState" class="text-center py-4" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading library papers...</p>
            </div>
            
            <!-- Empty State -->
            <div id="emptyState" class="text-center py-5" style="display: none;">
                <i class="fas fa-book-open fa-3x text-muted mb-3"></i>
                <h5>No Papers Found</h5>
                <p class="text-muted">Try adjusting your filters or <a href="{% url 'scholar_app:simple_search' %}">search for new papers</a> to add to your library.</p>
            </div>
        </div>
    </div>
</div>

<!-- Create Collection Modal -->
<div class="modal fade" id="createCollectionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Collection</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createCollectionForm">
                    <div class="mb-3">
                        <label for="collectionName" class="form-label">Collection Name</label>
                        <input type="text" class="form-control" id="collectionName" required>
                    </div>
                    <div class="mb-3">
                        <label for="collectionDescription" class="form-label">Description (Optional)</label>
                        <textarea class="form-control" id="collectionDescription" rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <label for="collectionColor" class="form-label">Color</label>
                            <input type="color" class="form-control form-control-color" id="collectionColor" value="#1a2332">
                        </div>
                        <div class="col-md-6">
                            <label for="collectionIcon" class="form-label">Icon</label>
                            <select class="form-select" id="collectionIcon">
                                <option value="fas fa-folder">üìÅ Folder</option>
                                <option value="fas fa-book">üìö Book</option>
                                <option value="fas fa-star">‚≠ê Star</option>
                                <option value="fas fa-heart">‚ù§Ô∏è Heart</option>
                                <option value="fas fa-bookmark">üîñ Bookmark</option>
                                <option value="fas fa-tag">üè∑Ô∏è Tag</option>
                                <option value="fas fa-lightbulb">üí° Ideas</option>
                                <option value="fas fa-flask">üß™ Research</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createCollection()">Create Collection</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Paper Modal -->
<div class="modal fade" id="editPaperModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Paper Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editPaperForm">
                    <input type="hidden" id="editPaperId">
                    
                    <div class="mb-3">
                        <label for="editReadingStatus" class="form-label">Reading Status</label>
                        <select class="form-select" id="editReadingStatus">
                            <option value="to_read">To Read</option>
                            <option value="reading">Currently Reading</option>
                            <option value="read">Completed</option>
                            <option value="referenced">For Reference</option>
                            <option value="favorite">Favorite</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editImportanceRating" class="form-label">Importance Rating</label>
                        <select class="form-select" id="editImportanceRating">
                            <option value="">No Rating</option>
                            <option value="1">‚≠ê 1 Star</option>
                            <option value="2">‚≠ê‚≠ê 2 Stars</option>
                            <option value="3">‚≠ê‚≠ê‚≠ê 3 Stars</option>
                            <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê 4 Stars</option>
                            <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê 5 Stars</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editPersonalNotes" class="form-label">Personal Notes</label>
                        <textarea class="form-control" id="editPersonalNotes" rows="4" placeholder="Add your thoughts, insights, or notes about this paper..."></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editTags" class="form-label">Tags</label>
                        <input type="text" class="form-control" id="editTags" placeholder="machine learning, neural networks, computer vision">
                        <small class="text-muted">Separate tags with commas</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Collections</label>
                        <div id="editCollections">
                            <!-- Collections checkboxes will be populated here -->
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="savePaperChanges()">Save Changes</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentFilters = {
    collection: '',
    status: '',
    search: '',
    sort: '-saved_at'
};

document.addEventListener('DOMContentLoaded', function() {
    loadLibraryPapers();
    
    // Set up event listeners
    document.getElementById('librarySearch').addEventListener('input', debounce(function() {
        currentFilters.search = this.value;
        loadLibraryPapers();
    }, 500));
    
    document.querySelectorAll('input[name="statusFilter"]').forEach(radio => {
        radio.addEventListener('change', function() {
            currentFilters.status = this.value;
            loadLibraryPapers();
        });
    });
    
    document.getElementById('sortSelect').addEventListener('change', function() {
        currentFilters.sort = this.value;
        loadLibraryPapers();
    });
});

function loadLibraryPapers() {
    const container = document.getElementById('papersContainer');
    const loadingState = document.getElementById('loadingState');
    const emptyState = document.getElementById('emptyState');
    
    // Show loading state
    container.style.display = 'none';
    emptyState.style.display = 'none';
    loadingState.style.display = 'block';
    
    // Build query parameters
    const params = new URLSearchParams();
    if (currentFilters.collection) params.append('collection', currentFilters.collection);
    if (currentFilters.status) params.append('status', currentFilters.status);
    if (currentFilters.search) params.append('q', currentFilters.search);
    if (currentFilters.sort) params.append('sort', currentFilters.sort);
    
    fetch(`/scholar/api/library/papers/?${params}`, {
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        loadingState.style.display = 'none';
        
        if (data.status === 'success') {
            if (data.papers.length > 0) {
                renderPapers(data.papers);
                container.style.display = 'block';
            } else {
                emptyState.style.display = 'block';
            }
        } else {
            showToast('Error loading library papers', 'danger');
            emptyState.style.display = 'block';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        loadingState.style.display = 'none';
        emptyState.style.display = 'block';
        showToast('Error loading library papers', 'danger');
    });
}

function renderPapers(papers) {
    const container = document.getElementById('papersContainer');
    
    container.innerHTML = papers.map(paper => `
        <div class="paper-card">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <h6 class="paper-title"><a href="#" onclick="viewPaperOnline('${paper.paper_id}', '${paper.external_url || paper.doi || paper.pmid}')" class="text-decoration-none text-dark">${paper.title}</a></h6>
                <div class="dropdown">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-ellipsis-h"></i>
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="editPaper('${paper.paper_id}')">
                            <i class="fas fa-edit"></i> Edit Details
                        </a></li>
                        <li><a class="dropdown-item" href="#" onclick="exportPaper('${paper.paper_id}')">
                            <i class="fas fa-download"></i> Export Citation
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="removePaper('${paper.paper_id}')">
                            <i class="fas fa-trash"></i> Remove from Library
                        </a></li>
                    </ul>
                </div>
            </div>
            
            <div class="paper-meta mb-2">
                <strong>${paper.authors}</strong> ‚Ä¢ ${paper.journal} ‚Ä¢ ${paper.year || 'Unknown Year'}
            </div>
            
            <div class="d-flex align-items-center mb-2 flex-wrap">
                <span class="reading-status status-${paper.reading_status} me-2">${paper.reading_status_display}</span>
                ${paper.importance_rating ? `<span class="importance-stars me-2">${'‚≠ê'.repeat(paper.importance_rating)}</span>` : ''}
                ${paper.collections.map(c => `<span class="badge me-1" style="background-color: ${c.color}; color: white;">${c.name}</span>`).join('')}
            </div>
            
            ${paper.personal_notes ? `<div class="text-muted mb-2"><small><strong>Notes:</strong> ${paper.personal_notes.substring(0, 150)}${paper.personal_notes.length > 150 ? '...' : ''}</small></div>` : ''}
            
            ${paper.tags.length > 0 ? `<div class="mb-2">${paper.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}</div>` : ''}
            
            <div class="d-flex gap-2 flex-wrap">
                ${paper.pdf_url ? `<a href="${paper.pdf_url}" class="btn btn-sm btn-outline-success" target="_blank"><i class="fas fa-file-pdf"></i> PDF</a>` : ''}
                ${paper.personal_pdf ? `<a href="${paper.personal_pdf}" class="btn btn-sm btn-outline-primary" target="_blank"><i class="fas fa-file-pdf"></i> My PDF</a>` : ''}
                <button class="btn btn-sm btn-outline-info" onclick="showRecommendations('${paper.paper_id}')">
                    <i class="fas fa-magic"></i> Similar Papers
                </button>
            </div>
        </div>
    `).join('');
}

function filterByCollection(collectionId) {
    currentFilters.collection = collectionId;
    loadLibraryPapers();
    
    // Update UI
    document.querySelectorAll('.collection-card').forEach(card => {
        card.classList.remove('bg-light');
    });
    document.querySelector(`[data-collection-id="${collectionId}"]`).classList.add('bg-light');
}

function showCreateCollectionModal() {
    const modal = new bootstrap.Modal(document.getElementById('createCollectionModal'));
    modal.show();
}

function createCollection() {
    const name = document.getElementById('collectionName').value.trim();
    const description = document.getElementById('collectionDescription').value.trim();
    const color = document.getElementById('collectionColor').value;
    const icon = document.getElementById('collectionIcon').value;
    
    if (!name) {
        showToast('Collection name is required', 'warning');
        return;
    }
    
    fetch('/scholar/api/library/collections/create/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            name: name,
            description: description,
            color: color,
            icon: icon
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showToast('Collection created successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('createCollectionModal')).hide();
            location.reload(); // Refresh to show new collection
        } else {
            showToast(data.message || 'Error creating collection', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error creating collection', 'danger');
    });
}

function editPaper(paperId) {
    // Load paper data into modal and show it
    fetch(`/scholar/api/library/papers/?q=${paperId}`, {
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success' && data.papers.length > 0) {
            const paper = data.papers[0];
            
            // Populate modal fields
            document.getElementById('editPaperId').value = paper.paper_id;
            document.getElementById('editReadingStatus').value = paper.reading_status;
            document.getElementById('editImportanceRating').value = paper.importance_rating || '';
            document.getElementById('editPersonalNotes').value = paper.personal_notes || '';
            document.getElementById('editTags').value = paper.tags.join(', ');
            
            // Load collections and populate checkboxes
            loadCollectionsForEdit(paper.collections);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('editPaperModal'));
            modal.show();
        } else {
            showToast('Error loading paper details', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error loading paper details', 'danger');
    });
}

function loadCollectionsForEdit(paperCollections) {
    fetch('/scholar/api/library/collections/', {
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            const container = document.getElementById('editCollections');
            const paperCollectionIds = paperCollections.map(c => c.id);
            
            container.innerHTML = data.collections.map(collection => `
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" 
                           id="collection_${collection.id}" 
                           value="${collection.id}"
                           ${paperCollectionIds.includes(collection.id) ? 'checked' : ''}>
                    <label class="form-check-label" for="collection_${collection.id}">
                        <i class="${collection.icon}" style="color: ${collection.color}"></i>
                        ${collection.name}
                    </label>
                </div>
            `).join('');
        }
    })
    .catch(error => {
        console.error('Error loading collections:', error);
    });
}

function savePaperChanges() {
    const paperId = document.getElementById('editPaperId').value;
    const selectedCollections = Array.from(document.querySelectorAll('#editCollections input:checked')).map(cb => cb.value);
    
    const updateData = {
        reading_status: document.getElementById('editReadingStatus').value,
        importance_rating: document.getElementById('editImportanceRating').value || null,
        personal_notes: document.getElementById('editPersonalNotes').value,
        tags: document.getElementById('editTags').value.split(',').map(tag => tag.trim()).filter(tag => tag),
        collection_ids: selectedCollections
    };
    
    fetch(`/scholar/api/library/papers/${paperId}/update/`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(updateData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showToast('Paper updated successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('editPaperModal')).hide();
            loadLibraryPapers(); // Refresh the papers list
        } else {
            showToast(data.message || 'Error updating paper', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error updating paper', 'danger');
    });
}

function exportPaper(paperId) {
    // Use existing export functionality
    exportCitation(document.querySelector(`[data-paper-id="${paperId}"]`), 'bibtex');
}

function removePaper(paperId) {
    if (confirm('Are you sure you want to remove this paper from your library? This action cannot be undone.')) {
        fetch(`/scholar/api/library/papers/${paperId}/remove/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showToast(data.message, 'success');
                loadLibraryPapers(); // Refresh the papers list
            } else {
                showToast(data.message || 'Error removing paper', 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Error removing paper from library', 'danger');
        });
    }
}

function showRecommendations(paperId) {
    // Create and show a modal with similar papers
    const modalId = 'recommendationsModal';
    
    // Remove existing modal if present
    const existingModal = document.getElementById(modalId);
    if (existingModal) {
        existingModal.remove();
    }
    
    // Create modal HTML
    const modalHTML = `
        <div class="modal fade" id="${modalId}" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Similar Papers</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div id="recommendationsLoading" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Finding similar papers...</p>
                        </div>
                        <div id="recommendationsContent" style="display: none;"></div>
                        <div id="recommendationsError" style="display: none;" class="text-center py-4">
                            <i class="fas fa-exclamation-triangle fa-2x text-warning mb-2"></i>
                            <p>Unable to load recommendations at this time.</p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById(modalId));
    modal.show();
    
    // Load recommendations
    fetch(`/scholar/api/recommendations/paper/${paperId}/`, {
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        const loadingEl = document.getElementById('recommendationsLoading');
        const contentEl = document.getElementById('recommendationsContent');
        const errorEl = document.getElementById('recommendationsError');
        
        loadingEl.style.display = 'none';
        
        if (data.status === 'success' && data.recommendations.length > 0) {
            contentEl.innerHTML = `
                <div class="mb-3">
                    <h6 class="text-muted">Based on: <strong>${data.paper_title}</strong></h6>
                    <p class="small text-muted">Found ${data.count} similar papers using our advanced recommendation algorithm</p>
                </div>
                
                ${data.recommendations.map(rec => `
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="card-title mb-0">${rec.title}</h6>
                                <span class="badge bg-primary ms-2">${Math.round(rec.similarity_score * 100)}% match</span>
                            </div>
                            <p class="text-muted small mb-2">
                                <strong>${rec.authors}</strong> ‚Ä¢ ${rec.journal || 'Unknown Journal'} ‚Ä¢ ${rec.publication_date ? new Date(rec.publication_date).getFullYear() : 'Unknown Year'}
                                ${rec.citation_count ? ` ‚Ä¢ ${rec.citation_count} citations` : ''}
                            </p>
                            <p class="card-text small">${rec.abstract || 'No abstract available'}</p>
                            <div class="mb-2">
                                <span class="badge bg-light text-dark">${rec.similarity_reason}</span>
                            </div>
                            <div class="d-flex gap-2">
                                ${rec.pdf_url ? `<a href="${rec.pdf_url}" class="btn btn-sm btn-outline-success" target="_blank"><i class="fas fa-file-pdf"></i> PDF</a>` : ''}
                                <button class="btn btn-sm btn-outline-primary" onclick="saveRecommendedPaper('${rec.id}')">
                                    <i class="fas fa-bookmark"></i> Save to Library
                                </button>
                                ${rec.doi ? `<a href="https://doi.org/${rec.doi}" class="btn btn-sm btn-outline-info" target="_blank"><i class="fas fa-external-link-alt"></i> DOI</a>` : ''}
                            </div>
                        </div>
                    </div>
                `).join('')}
            `;
            contentEl.style.display = 'block';
        } else {
            errorEl.innerHTML = `
                <i class="fas fa-search fa-2x text-muted mb-2"></i>
                <p>No similar papers found for this research.</p>
                <p class="small text-muted">Try viewing recommendations from the main search or browse related topics.</p>
            `;
            errorEl.style.display = 'block';
        }
    })
    .catch(error => {
        console.error('Error loading recommendations:', error);
        document.getElementById('recommendationsLoading').style.display = 'none';
        document.getElementById('recommendationsError').style.display = 'block';
    });
    
    // Clean up modal when hidden
    document.getElementById(modalId).addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

function saveRecommendedPaper(paperId) {
    // Use existing save paper functionality
    fetch('/scholar/api/save-paper/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            paper_id: paperId,
            source: 'recommendation'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showToast('Paper saved to your library!', 'success');
        } else {
            showToast(data.message || 'Error saving paper', 'warning');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error saving paper', 'danger');
    });
}

// Utility functions
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        if (toast.parentNode) {
            toast.remove();
        }
    }, 3000);
}

function viewPaperOnline(paperId, urlInfo) {
    // Determine the best web link
    let webUrl = '';
    
    if (urlInfo && urlInfo.startsWith('http')) {
        webUrl = urlInfo;
    } else if (urlInfo && urlInfo.startsWith('10.')) {
        // DOI
        webUrl = `https://doi.org/${urlInfo}`;
    } else if (urlInfo && /^\d+$/.test(urlInfo)) {
        // PMID
        webUrl = `https://pubmed.ncbi.nlm.nih.gov/${urlInfo}/`;
    } else {
        // Use Google Scholar search as fallback
        webUrl = `https://scholar.google.com/scholar?q=${encodeURIComponent(paperId)}`;
    }
    
    window.open(webUrl, '_blank');
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}