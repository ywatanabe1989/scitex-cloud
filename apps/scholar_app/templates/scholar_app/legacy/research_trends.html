{% extends "scholar_app/scholar_base.html" %}
{% load static %}
{% block title
    %}
    Research Trends - SciTeX Scholar
{% endblock %}
{% block extra_css %}
    <link rel="stylesheet" href="{% static 'shared/css/components/hero.css' %}" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
  .trends-hero {
    background: linear-gradient(135deg, #1a2332 0%, #34495e 100%);
    color: white;
    padding: 3rem 0;
    margin-bottom: 2rem;
  }
  .stats-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    text-align: center;
    border-left: 4px solid #1a2332;
    transition: transform 0.2s ease;
  }
  .stats-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
  }
  .stats-number {
    font-size: 2.5rem;
    font-weight: bold;
    color: #1a2332;
    margin-bottom: 0.5rem;
  }
  .trends-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    border-left: 4px solid #1a2332;
  }
  .trend-item {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 0.75rem;
    border-left: 3px solid #1a2332;
    transition: background 0.2s ease;
  }
  .trend-item:hover {
    background: #e9ecef;
  }
  .trend-score {
    background: #1a2332;
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: bold;
  }
  .growth-indicator {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 8px;
    font-size: 0.75rem;
    font-weight: 500;
    margin-left: 0.5rem;
  }
  .growth-emerging {
    background: #e3f2fd;
    color: #1976d2;
  }
  .growth-hot {
    background: #fff3e0;
    color: #f57c00;
  }
  .growth-established {
    background: #e8f5e8;
    color: #388e3c;
  }

  .filter-controls {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
  }
  .chart-container {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }
  .tab-content {
    background: white;
    border-radius: 0 12px 12px 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }
  .nav-tabs .nav-link {
    border: none;
    background: #f8f9fa;
    color: #1a2332;
    border-radius: 12px 12px 0 0;
    margin-right: 0.25rem;
  }
  .nav-tabs .nav-link.active {
    background: white;
    color: #1a2332;
    font-weight: 600;
  }
  .author-card {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 0.75rem;
    transition: transform 0.2s ease;
  }
  .author-card:hover {
    transform: translateX(5px);
    background: #e9ecef;
  }
  .paper-mini {
    background: white;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 0.75rem;
    border-left: 3px solid #34495e;
    box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
  }
  .loading-state {
    text-align: center;
    padding: 3rem 0;
    color: #7f8c8d;
  }
  .refresh-btn {
    background: #1a2332;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 0.5rem 1rem;
    font-size: 0.9rem;
    cursor: pointer;
    transition: background 0.2s ease;
  }
  .refresh-btn:hover {
    background: #2d3748;
    color: white;
  }
    </style>
{% endblock %}
{% block content %}
    <!-- Trends Hero -->
    <div class="trends-hero">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-8 text-center">
                    <h1 class="hero-title">Research Trends & Analytics</h1>
                    <p class="hero-subtitle">Discover trending topics, influential papers, and research insights</p>
                </div>
            </div>
        </div>
    </div>
    <div class="container">
        <!-- Statistics Overview -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number">{{ total_papers|default:0 }}</div>
                    <div class="text-muted">Total Papers</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number">{{ active_journals|default:0 }}</div>
                    <div class="text-muted">Active Journals</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number">{{ total_authors|default:0 }}</div>
                    <div class="text-muted">Authors</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number">{{ total_topics|default:0 }}</div>
                    <div class="text-muted">Research Topics</div>
                </div>
            </div>
        </div>
        <!-- Filter Controls -->
        <div class="filter-controls">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h6 class="mb-3">Time Range Analysis</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <label for="papersDays" class="form-label">Trending Papers</label>
                            <select id="papersDays" class="form-select">
                                <option value="7">Last 7 days</option>
                                <option value="30" selected>Last 30 days</option>
                                <option value="90">Last 3 months</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="topicsDays" class="form-label">Trending Topics</label>
                            <select id="topicsDays" class="form-select">
                                <option value="7">Last 7 days</option>
                                <option value="30" selected>Last 30 days</option>
                                <option value="90">Last 3 months</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="authorsDays" class="form-label">Trending Authors</label>
                            <select id="authorsDays" class="form-select">
                                <option value="30">Last 30 days</option>
                                <option value="90" selected>Last 3 months</option>
                                <option value="180">Last 6 months</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 text-end">
                    <h6 class="mb-3">Actions</h6>
                    <button class="refresh-btn" onclick="refreshAllData()">
                        <i class="fas fa-sync-alt"></i> Refresh Data
                    </button>
                </div>
            </div>
        </div>
        <!-- Analytics Charts -->
        <div class="row">
            <div class="col-lg-6">
                <div class="chart-container">
                    <h5 class="mb-3">Publication Trends</h5>
                    <canvas id="publicationChart" height="300"></canvas>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="chart-container">
                    <h5 class="mb-3">Open Access Statistics</h5>
                    <canvas id="openAccessChart" height="300"></canvas>
                </div>
            </div>
        </div>
        <!-- Trending Content Tabs -->
        <div class="row">
            <div class="col-12">
                <ul class="nav nav-tabs" id="trendTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active"
                                id="papers-tab"
                                data-bs-toggle="tab"
                                data-bs-target="#papers"
                                type="button"
                                role="tab">
                            <i class="fas fa-file-alt"></i> Trending Papers
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link"
                                id="topics-tab"
                                data-bs-toggle="tab"
                                data-bs-target="#topics"
                                type="button"
                                role="tab">
                            <i class="fas fa-tags"></i> Hot Topics
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link"
                                id="authors-tab"
                                data-bs-toggle="tab"
                                data-bs-target="#authors"
                                type="button"
                                role="tab">
                            <i class="fas fa-users"></i> Trending Authors
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link"
                                id="analytics-tab"
                                data-bs-toggle="tab"
                                data-bs-target="#analytics"
                                type="button"
                                role="tab">
                            <i class="fas fa-chart-bar"></i> Research Analytics
                        </button>
                    </li>
                </ul>
                <div class="tab-content" id="trendTabContent">
                    <!-- Trending Papers Tab -->
                    <div class="tab-pane fade show active" id="papers" role="tabpanel">
                        <div id="trendingPapersLoading" class="loading-state">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading trending papers...</p>
                        </div>
                        <div id="trendingPapersContent"></div>
                    </div>
                    <!-- Hot Topics Tab -->
                    <div class="tab-pane fade" id="topics" role="tabpanel">
                        <div id="trendingTopicsLoading" class="loading-state">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Analyzing research topics...</p>
                        </div>
                        <div id="trendingTopicsContent"></div>
                    </div>
                    <!-- Trending Authors Tab -->
                    <div class="tab-pane fade" id="authors" role="tabpanel">
                        <div id="trendingAuthorsLoading" class="loading-state">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Finding influential authors...</p>
                        </div>
                        <div id="trendingAuthorsContent"></div>
                    </div>
                    <!-- Research Analytics Tab -->
                    <div class="tab-pane fade" id="analytics" role="tabpanel">
                        <div id="researchAnalyticsLoading" class="loading-state">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Computing research analytics...</p>
                        </div>
                        <div id="researchAnalyticsContent"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block extra_js %}
    <script>
  let charts = {};

  document.addEventListener("DOMContentLoaded", function () {
    // Load initial data
    loadTrendingPapers();
    loadResearchAnalytics();

    // Set up event listeners for filter changes
    document
      .getElementById("papersDays")
      .addEventListener("change", loadTrendingPapers);
    document
      .getElementById("topicsDays")
      .addEventListener("change", loadTrendingTopics);
    document
      .getElementById("authorsDays")
      .addEventListener("change", loadTrendingAuthors);

    // Load data when tabs are clicked
    document
      .getElementById("topics-tab")
      .addEventListener("shown.bs.tab", loadTrendingTopics);
    document
      .getElementById("authors-tab")
      .addEventListener("shown.bs.tab", loadTrendingAuthors);
    document
      .getElementById("analytics-tab")
      .addEventListener("shown.bs.tab", loadResearchAnalytics);
  });

  function loadTrendingPapers() {
    const days = document.getElementById("papersDays").value;
    const loadingEl = document.getElementById("trendingPapersLoading");
    const contentEl = document.getElementById("trendingPapersContent");

    loadingEl.style.display = "block";
    contentEl.style.display = "none";

    fetch(`/scholar/api/trends/papers/?days=${days}`, {
      headers: {
        "X-CSRFToken": getCookie("csrftoken"),
      },
    })
      .then((response) => response.json())
      .then((data) => {
        loadingEl.style.display = "none";

        if (data.status === "success") {
          renderTrendingPapers(data.papers, data.period_days);
          contentEl.style.display = "block";
        } else {
          contentEl.innerHTML = `<div class="alert alert-warning">Error loading trending papers: ${data.message}</div>`;
          contentEl.style.display = "block";
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        loadingEl.style.display = "none";
        contentEl.innerHTML =
          '<div class="alert alert-danger">Error loading trending papers</div>';
        contentEl.style.display = "block";
      });
  }

  function renderTrendingPapers(papers, days) {
    const container = document.getElementById("trendingPapersContent");

    if (papers.length === 0) {
      container.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                <h5>No Trending Papers</h5>
                <p class="text-muted">No papers found in the last ${days} days. Try adjusting the time range.</p>
            </div>
        `;
      return;
    }

    container.innerHTML = `
        <div class="mb-3">
            <h6 class="text-muted">Trending papers from the last ${days} days (${papers.length} papers)</h6>
        </div>
        
        ${papers
          .map(
            (paper, index) => `
            <div class="paper-mini">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <h6 class="mb-0">${paper.title}</h6>
                    <span class="trend-score">#${index + 1}</span>
                </div>
                <p class="text-muted small mb-2">
                    <strong>${paper.authors}</strong> • ${paper.journal} • ${paper.publication_date ? new Date(paper.publication_date).getFullYear() : "Unknown Year"}
                </p>
                <p class="small mb-2">${paper.abstract}</p>
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <span class="badge bg-primary me-2">${paper.citation_count} citations</span>
                        <span class="badge bg-info me-2">${paper.view_count} views</span>
                        ${paper.is_open_access ? '<span class="badge bg-success">Open Access</span>' : ""}
                    </div>
                    <div>
                        ${paper.pdf_url ? `<a href="${paper.pdf_url}" class="btn btn-sm btn-outline-success" target="_blank"><i class="fas fa-file-pdf"></i> PDF</a>` : ""}
                        <button class="btn btn-sm btn-outline-primary ms-1" onclick="savePaper('${paper.id}')">
                            <i class="fas fa-bookmark"></i> Save
                        </button>
                    </div>
                </div>
            </div>
        `,
          )
          .join("")}
    `;
  }

  function loadTrendingTopics() {
    const days = document.getElementById("topicsDays").value;
    const loadingEl = document.getElementById("trendingTopicsLoading");
    const contentEl = document.getElementById("trendingTopicsContent");

    loadingEl.style.display = "block";
    contentEl.style.display = "none";

    fetch(`/scholar/api/trends/topics/?days=${days}`, {
      headers: {
        "X-CSRFToken": getCookie("csrftoken"),
      },
    })
      .then((response) => response.json())
      .then((data) => {
        loadingEl.style.display = "none";

        if (data.status === "success") {
          renderTrendingTopics(
            data.topics,
            data.period_days,
            data.total_analyzed_papers,
          );
          contentEl.style.display = "block";
        } else {
          contentEl.innerHTML = `<div class="alert alert-warning">Error loading topics: ${data.message}</div>`;
          contentEl.style.display = "block";
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        loadingEl.style.display = "none";
        contentEl.innerHTML =
          '<div class="alert alert-danger">Error loading trending topics</div>';
        contentEl.style.display = "block";
      });
  }

  function renderTrendingTopics(topics, days, totalPapers) {
    const container = document.getElementById("trendingTopicsContent");

    if (topics.length === 0) {
      container.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-tags fa-3x text-muted mb-3"></i>
                <h5>No Trending Topics</h5>
                <p class="text-muted">No topics found in the analyzed papers. Try adjusting the time range.</p>
            </div>
        `;
      return;
    }

    container.innerHTML = `
        <div class="mb-3">
            <h6 class="text-muted">Hot topics from the last ${days} days (analyzed ${totalPapers} papers)</h6>
        </div>
        
        ${topics
          .map(
            (topic, index) => `
            <div class="trend-item">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1">${topic.topic}</h6>
                        <small class="text-muted">${topic.paper_count} papers mentioning this topic</small>
                    </div>
                    <div>
                        <span class="growth-indicator growth-${topic.trend_category}">
                            ${topic.trend_category.charAt(0).toUpperCase() + topic.trend_category.slice(1)}
                        </span>
                        <span class="trend-score ms-2">${topic.growth_rate}%</span>
                    </div>
                </div>
            </div>
        `,
          )
          .join("")}
    `;
  }

  function loadTrendingAuthors() {
    const days = document.getElementById("authorsDays").value;
    const loadingEl = document.getElementById("trendingAuthorsLoading");
    const contentEl = document.getElementById("trendingAuthorsContent");

    loadingEl.style.display = "block";
    contentEl.style.display = "none";

    fetch(`/scholar/api/trends/authors/?days=${days}`, {
      headers: {
        "X-CSRFToken": getCookie("csrftoken"),
      },
    })
      .then((response) => response.json())
      .then((data) => {
        loadingEl.style.display = "none";

        if (data.status === "success") {
          renderTrendingAuthors(data.authors, data.period_days);
          contentEl.style.display = "block";
        } else {
          contentEl.innerHTML = `<div class="alert alert-warning">Error loading authors: ${data.message}</div>`;
          contentEl.style.display = "block";
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        loadingEl.style.display = "none";
        contentEl.innerHTML =
          '<div class="alert alert-danger">Error loading trending authors</div>';
        contentEl.style.display = "block";
      });
  }

  function renderTrendingAuthors(authors, days) {
    const container = document.getElementById("trendingAuthorsContent");

    if (authors.length === 0) {
      container.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-users fa-3x text-muted mb-3"></i>
                <h5>No Trending Authors</h5>
                <p class="text-muted">No authors found with recent publications in the last ${days} days.</p>
            </div>
        `;
      return;
    }

    container.innerHTML = `
        <div class="mb-3">
            <h6 class="text-muted">Most active authors in the last ${days} days (${authors.length} authors)</h6>
        </div>
        
        ${authors
          .map(
            (author, index) => `
            <div class="author-card">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div>
                        <h6 class="mb-1">${author.name}</h6>
                        <small class="text-muted">${author.affiliation || "Affiliation not specified"}</small>
                    </div>
                    <div class="text-end">
                        <span class="trend-score">#${index + 1}</span>
                        ${author.orcid ? `<div><small class="text-muted">ORCID: ${author.orcid}</small></div>` : ""}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-8">
                        <p class="small mb-1"><strong>Recent Publications:</strong></p>
                        ${
                          author.recent_papers.length > 0
                            ? author.recent_papers
                                .map(
                                  (paper) =>
                                    `<div class="small text-muted">• ${paper}</div>`,
                                )
                                .join("")
                            : '<div class="small text-muted">No recent papers listed</div>'
                        }
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="small">
                            <div><strong>${author.recent_papers_count}</strong> recent papers</div>
                            <div><strong>${author.total_citations}</strong> total citations</div>
                            ${author.h_index ? `<div>H-index: <strong>${author.h_index}</strong></div>` : ""}
                            <div>Avg: <strong>${author.avg_citations.toFixed(1)}</strong> citations/paper</div>
                        </div>
                    </div>
                </div>
            </div>
        `,
          )
          .join("")}
    `;
  }

  function loadResearchAnalytics() {
    const loadingEl = document.getElementById("researchAnalyticsLoading");
    const contentEl = document.getElementById("researchAnalyticsContent");

    loadingEl.style.display = "block";
    contentEl.style.display = "none";

    fetch("/scholar/api/trends/analytics/", {
      headers: {
        "X-CSRFToken": getCookie("csrftoken"),
      },
    })
      .then((response) => response.json())
      .then((data) => {
        loadingEl.style.display = "none";

        if (data.status === "success") {
          renderResearchAnalytics(data.analytics);
          updateCharts(data.analytics);
          contentEl.style.display = "block";
        } else {
          contentEl.innerHTML = `<div class="alert alert-warning">Error loading analytics: ${data.message}</div>`;
          contentEl.style.display = "block";
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        loadingEl.style.display = "none";
        contentEl.innerHTML =
          '<div class="alert alert-danger">Error loading research analytics</div>';
        contentEl.style.display = "block";
      });
  }

  function renderResearchAnalytics(analytics) {
    const container = document.getElementById("researchAnalyticsContent");

    container.innerHTML = `
        <!-- Overview Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number">${analytics.overview.total_papers}</div>
                    <div class="text-muted">Total Papers</div>
                    <small class="text-success">+${analytics.overview.recent_papers} this month</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number">${analytics.overview.total_authors}</div>
                    <div class="text-muted">Active Authors</div>
                    <small class="text-muted">${analytics.overview.active_topics} topics</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number">${analytics.citations.total_citations}</div>
                    <div class="text-muted">Total Citations</div>
                    <small class="text-muted">Avg: ${analytics.citations.average_citations}/paper</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number">${analytics.open_access.percentage}%</div>
                    <div class="text-muted">Open Access</div>
                    <small class="text-muted">${analytics.open_access.total_open_access} papers</small>
                </div>
            </div>
        </div>
        
        <!-- Top Journals -->
        <div class="row mb-4">
            <div class="col-lg-6">
                <div class="trends-card">
                    <h6 class="mb-3">Top Journals by Paper Count</h6>
                    ${analytics.top_journals
                      .slice(0, 8)
                      .map(
                        (journal, index) => `
                        <div class="trend-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${journal.name}</strong>
                                    ${journal.impact_factor ? `<small class="text-muted">(IF: ${journal.impact_factor})</small>` : ""}
                                </div>
                                <span class="badge bg-primary">${journal.paper_count} papers</span>
                            </div>
                        </div>
                    `,
                      )
                      .join("")}
                </div>
            </div>
            <div class="col-lg-6">
                <div class="trends-card">
                    <h6 class="mb-3">Document Type Distribution</h6>
                    ${analytics.document_types
                      .slice(0, 6)
                      .map(
                        (type) => `
                        <div class="trend-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${type.type.charAt(0).toUpperCase() + type.type.slice(1)}</strong>
                                </div>
                                <div>
                                    <span class="badge bg-secondary me-2">${type.percentage}%</span>
                                    <small class="text-muted">${type.count} docs</small>
                                </div>
                            </div>
                        </div>
                    `,
                      )
                      .join("")}
                </div>
            </div>
        </div>
        
        <!-- Citation Analytics -->
        <div class="trends-card">
            <h6 class="mb-3">Citation Statistics</h6>
            <div class="row">
                <div class="col-md-3 text-center">
                    <div class="display-6 text-primary">${analytics.citations.highest_cited}</div>
                    <small class="text-muted">Highest Cited Paper</small>
                </div>
                <div class="col-md-3 text-center">
                    <div class="display-6 text-info">${analytics.citations.average_citations}</div>
                    <small class="text-muted">Average Citations</small>
                </div>
                <div class="col-md-3 text-center">
                    <div class="display-6 text-success">${analytics.citations.total_citations}</div>
                    <small class="text-muted">Total Citations</small>
                </div>
                <div class="col-md-3 text-center">
                    <div class="display-6 text-warning">${analytics.overview.growth_rate.toFixed(1)}%</div>
                    <small class="text-muted">Growth Rate</small>
                </div>
            </div>
        </div>
    `;
  }

  function updateCharts(analytics) {
    // Publication Trends Chart
    const pubCtx = document.getElementById("publicationChart").getContext("2d");
    if (charts.publicationChart) {
      charts.publicationChart.destroy();
    }

    charts.publicationChart = new Chart(pubCtx, {
      type: "line",
      data: {
        labels: analytics.publication_trends.map((t) => t.year),
        datasets: [
          {
            label: "Papers Published",
            data: analytics.publication_trends.map((t) => t.papers),
            borderColor: "#1a2332",
            backgroundColor: "rgba(26, 35, 50, 0.1)",
            fill: true,
            tension: 0.4,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false,
          },
        },
        scales: {
          y: {
            beginAtZero: true,
          },
        },
      },
    });

    // Open Access Chart
    const oaCtx = document.getElementById("openAccessChart").getContext("2d");
    if (charts.openAccessChart) {
      charts.openAccessChart.destroy();
    }

    charts.openAccessChart = new Chart(oaCtx, {
      type: "doughnut",
      data: {
        labels: ["Open Access", "Subscription"],
        datasets: [
          {
            data: [
              analytics.open_access.total_open_access,
              analytics.open_access.total_papers -
                analytics.open_access.total_open_access,
            ],
            backgroundColor: ["#28a745", "#6c757d"],
            borderWidth: 0,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: "bottom",
          },
        },
      },
    });
  }

  function refreshAllData() {
    // Refresh all currently visible data
    const activeTab = document.querySelector(".nav-link.active").id;

    if (activeTab === "papers-tab") {
      loadTrendingPapers();
    } else if (activeTab === "topics-tab") {
      loadTrendingTopics();
    } else if (activeTab === "authors-tab") {
      loadTrendingAuthors();
    } else if (activeTab === "analytics-tab") {
      loadResearchAnalytics();
    }

    // Always refresh analytics for charts
    loadResearchAnalytics();

    showToast("Data refreshed successfully!", "success");
  }

  function savePaper(paperId) {
    // Use existing save paper functionality
    fetch("/scholar/api/save-paper/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCookie("csrftoken"),
      },
      body: JSON.stringify({
        paper_id: paperId,
        source: "trends",
      }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.status === "success") {
          showToast("Paper saved to your library!", "success");
        } else {
          showToast(data.message || "Error saving paper", "warning");
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        showToast("Error saving paper", "danger");
      });
  }

  // Utility functions
  function showToast(message, type = "info") {
    const toast = document.createElement("div");
    toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    toast.style.cssText =
      "top: 20px; right: 20px; z-index: 1050; min-width: 300px;";
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    document.body.appendChild(toast);

    setTimeout(() => {
      if (toast.parentNode) {
        toast.remove();
      }
    }, 3000);
  }

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === name + "=") {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
    </script>
{% endblock %}
