{% extends "scholar_app/scholar_base.html" %}
{% load static %}
{%block title%}
    SciTeX Scholar - BibTeX Enrichment
{% endblock %}
{% block extra_css %}
    <link rel="stylesheet" href="{% static 'shared/css/common.css' %}" />
    <link rel="stylesheet" href="{% static 'scholar_app/css/index.css' %}" />
    <link rel="stylesheet"
          href="{% static 'shared/css/components/terminal-log.css' %}" />
{% endblock %}
{% block content %}
    <div class="container" style="padding-bottom: 2rem">
        <div class="row">
            <div class="col-12">
                {% include "scholar_app/bibtex_partials/enrich.html" %}
            </div>
        </div>
    </div>
    <!-- AI2 Prompt Modal -->
    {% if current_project %}
        {% include "writer_app/compilation_view_partials/ai2_modal.html" %}
    {% endif %}
    <!-- Configuration for JavaScript -->
    <script>
  // Django template variables for JavaScript
  window.SCHOLAR_CONFIG = {
    urls: {
      bibtexUpload: '{% url "scholar_app:bibtex_upload" %}',
      resourceStatus: '{% url "scholar_app:bibtex_resource_status" %}',
      scitexSearch: '{% url "scholar_app:api_scitex_search" %}',
      scitexCapabilities: '{% url "scholar_app:api_scitex_capabilities" %}'
    },
    user: {
      isAuthenticated: {% if user.is_authenticated %}true{% else %}false{% endif %}
    }{% if current_project %},
    projectId: {{ current_project.id }}{% endif %}
  };
    </script>
    {% block extra_js %}
        <!-- Common Scripts -->
        <script type="module"
                src="{% static 'scholar_app/js/common/project-selector.js' %}"></script>
        <!-- BibTeX scripts are loaded from bibtex_partials/enrich.html -->
        <!-- AI2 Prompt Integration -->
        {% if current_project %}
            <script type="module">
  // Import AI2 prompt functions from writer app
  import {
    openAI2PromptModal,
    closeAI2PromptModal,
    copyAI2PromptToClipboard,
    generateAI2Prompt,
  } from "/static/writer_app/js/modules/ai2-prompt.js";

  // Make functions globally available for the modal
  window.closeAI2PromptModal = closeAI2PromptModal;

  // Wait for DOM to load
  document.addEventListener("DOMContentLoaded", () => {
    const projectId = window.SCHOLAR_CONFIG?.projectId;
    if (!projectId) {
      console.error("[Scholar AI2] No project ID available");
      return;
    }

    // Initialize button click handler
    const scholarAI2Btn = document.getElementById(
      "generate-ai2-prompt-scholar-btn",
    );
    if (scholarAI2Btn) {
      scholarAI2Btn.addEventListener("click", () => {
        console.log("[Scholar AI2] Opening AI2 prompt modal");
        openAI2PromptModal(projectId);
      });
    }

    // Initialize modal buttons
    const copyButton = document.getElementById("copyAI2PromptBtn");
    if (copyButton) {
      copyButton.addEventListener("click", () => {
        copyAI2PromptToClipboard();
      });
    }

    const regenerateButton = document.getElementById("regenerateAI2PromptBtn");
    if (regenerateButton) {
      regenerateButton.addEventListener("click", () => {
        const searchTypeInputs = document.getElementsByName("ai2SearchType");
        let searchType = "related";
        for (const input of searchTypeInputs) {
          if (input.checked) {
            searchType = input.value;
            break;
          }
        }
        generateAI2Prompt(projectId, searchType);
      });
    }

    // Handle search type radio button changes
    const searchTypeInputs = document.getElementsByName("ai2SearchType");
    for (const input of searchTypeInputs) {
      input.addEventListener("change", () => {
        generateAI2Prompt(projectId, input.value);
      });
    }

    console.log("[Scholar AI2] AI2 prompt integration initialized");
  });
            </script>
        {% endif %}
    {% endblock %}
{% endblock %}
