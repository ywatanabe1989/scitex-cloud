{% extends 'scholar_app/scholar_base.html' %}

{% load static %}

{% block title %}BibTeX Enrichment - SciTeX Scholar{% endblock %}

{% block search_content %}
<div class="container" style="max-width: 1000px; margin: 2rem auto 3rem auto; padding: 2rem;">

  <!-- Upload Form -->
  <div style="background: var(--color-canvas-default); border-radius: 12px; padding: 2.5rem; box-shadow: 0 2px 12px rgba(0,0,0,0.08); margin-bottom: 3rem; border: 1px solid var(--color-border-default);">
    <h2 style="color: var(--color-fg-default); margin-bottom: 1.5rem; font-size: 1.5rem;">
      <i class="fas fa-upload"></i> Upload BibTeX File
    </h2>

    <form method="post" action="{% url 'scholar_app:bibtex_upload' %}" enctype="multipart/form-data">
      {% csrf_token %}

      <!-- File Upload -->
      <div style="margin-bottom: 1.5rem;">
        <label for="bibtex_file" style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--color-fg-default);">
          Select BibTeX File (.bib)
        </label>

        <!-- Custom drop zone -->
        <div id="dropZone" style="
          position: relative;
          width: 100%;
          padding: 2rem;
          border: 2px dashed var(--color-border-default);
          border-radius: 8px;
          background: var(--color-canvas-subtle);
          text-align: center;
          cursor: pointer;
          transition: all 0.3s ease;
        ">
          <input
            type="file"
            name="bibtex_file"
            id="bibtex_file"
            accept=".bib"
            required
            style="position: absolute; width: 100%; height: 100%; top: 0; left: 0; opacity: 0; cursor: pointer;"
          >
          <div id="dropZoneContent">
            <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: var(--scitex-color-03); margin-bottom: 0.5rem;"></i>
            <p style="color: var(--color-fg-default); font-weight: 600; margin: 0.5rem 0;">
              Click to browse or drag & drop
            </p>
            <p style="color: var(--color-fg-muted); font-size: 0.9rem; margin: 0;">
              <i class="fas fa-info-circle"></i> BibTeX files (.bib) only
            </p>
          </div>
          <div id="fileNameDisplay" style="display: none;">
            <i class="fas fa-file-alt" style="font-size: 2rem; color: var(--success-color); margin-bottom: 0.5rem;"></i>
            <p style="color: var(--color-fg-default); font-weight: 600; margin: 0.5rem 0;">
              <span id="fileName"></span>
            </p>
            <p style="color: var(--color-fg-muted); font-size: 0.85rem; margin: 0;">
              <span id="fileSize"></span>
            </p>
            <button type="button" id="changeFileBtn" style="
              margin-top: 0.75rem;
              padding: 0.5rem 1rem;
              background: var(--color-canvas-default);
              border: 1px solid var(--color-border-default);
              border-radius: 6px;
              color: var(--color-fg-default);
              cursor: pointer;
              font-size: 0.9rem;
            ">
              <i class="fas fa-exchange-alt"></i> Change file
            </button>
          </div>
        </div>
      </div>

      <!-- Project Selection (for Gitea Integration) -->
      <div style="margin-bottom: 1.5rem;">
        <label for="project_id" style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--color-fg-default);">
          <i class="fas fa-folder"></i> Save to project (Recommended)
        </label>
        <select
          name="project_id"
          id="project_id"
          style="display: block; width: 100%; padding: 0.75rem; border: 1px solid var(--color-border-default); border-radius: 6px; background: var(--color-canvas-default); color: var(--color-fg-default);"
        >
          <option value="">-- No Project (Manual Download Only) --</option>
          {% for project in user_projects %}
          <option value="{{ project.id }}">{{ project.name }} ({{ project.slug }})</option>
          {% endfor %}
        </select>
        <small style="color: var(--color-fg-muted); display: block; margin-top: 0.5rem;">
          <i class="fas fa-info-circle"></i> Enriched .bib will be auto-committed to project's Gitea repository at <code>/references/references.bib</code>
        </small>
      </div>

      <!-- Project Name (Optional - for non-project enrichment) -->
      <div style="margin-bottom: 1.5rem;">
        <label for="project_name" style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--color-fg-default);">
          Project Label (Optional)
        </label>
        <input
          type="text"
          name="project_name"
          id="project_name"
          placeholder="e.g., my_research_notes"
          style="display: block; width: 100%; padding: 0.75rem; border: 1px solid var(--color-border-default); border-radius: 6px; background: var(--color-canvas-default); color: var(--color-fg-default);"
        >
        <small style="color: var(--color-fg-muted); display: block; margin-top: 0.5rem;">
          <i class="fas fa-tag"></i> For organizing papers (not linked to Gitea)
        </small>
      </div>

      <!-- Advanced Options -->
      <details style="margin-bottom: 1.5rem; padding: 1rem; background: var(--color-canvas-subtle); border-radius: 6px;">
        <summary style="cursor: pointer; font-weight: 600; color: var(--color-fg-default);">
          <i class="fas fa-cog"></i> Advanced Options
        </summary>

        <div style="margin-top: 1rem;">
          <!-- Number of Workers -->
          <div style="margin-bottom: 1rem;">
            <label for="num_workers" style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--color-fg-default);">
              Parallel Workers
            </label>
            <select
              name="num_workers"
              id="num_workers"
              style="display: block; width: 100%; padding: 0.75rem; border: 1px solid var(--color-border-default); border-radius: 6px; background: var(--color-canvas-default); color: var(--color-fg-default);"
            >
              <option value="2">2 workers (slower, lighter)</option>
              <option value="4" selected>4 workers (balanced)</option>
              <option value="8">8 workers (faster, requires more resources)</option>
            </select>
          </div>

        </div>
      </details>

      <!-- Submit Button -->
      <button
        type="submit"
        style="width: 100%; padding: 1rem; background: var(--color-btn-primary-bg); color: var(--color-btn-primary-text); border: 1px solid var(--color-btn-primary-border); border-radius: 8px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: transform 0.2s, background-color 0.2s;"
        onmouseover="this.style.background='var(--color-btn-primary-hover-bg)'; this.style.transform='translateY(-2px)'"
        onmouseout="this.style.background='var(--color-btn-primary-bg)'; this.style.transform='translateY(0)'"
      >
        <i class="fas fa-magic"></i> Enrich BibTeX File
      </button>
    </form>
  </div>

  <!-- Active Job Progress (Hidden by default, shown after upload) -->
  <div id="activeJobPanel" style="display: none; background: var(--color-canvas-default); border-radius: 12px; padding: 2rem; box-shadow: 0 2px 12px rgba(0,0,0,0.08); border: 1px solid var(--color-border-default); margin-bottom: 3rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
      <h2 style="color: var(--color-fg-default); font-size: 1.5rem; margin: 0;">
        <i class="fas fa-cog fa-spin"></i> <span id="jobTitle">Enrichment in Progress</span>
      </h2>
      <button id="closeJobPanel" style="background: none; border: 1px solid var(--color-border-default); border-radius: 6px; padding: 0.5rem; cursor: pointer; color: var(--color-fg-muted);">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <!-- Job Info -->
    <div style="background: var(--color-canvas-subtle); border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
        <div>
          <div style="color: var(--color-fg-muted); font-size: 0.85rem; margin-bottom: 0.25rem;">File</div>
          <div style="color: var(--color-fg-default); font-weight: 600;" id="jobFileName">-</div>
        </div>
        <div>
          <div style="color: var(--color-fg-muted); font-size: 0.85rem; margin-bottom: 0.25rem;">Status</div>
          <div style="color: var(--color-fg-default); font-weight: 600;" id="jobStatus">
            <span style="color: var(--info-color);"><i class="fas fa-clock"></i> Pending</span>
          </div>
        </div>
        <div>
          <div style="color: var(--color-fg-muted); font-size: 0.85rem; margin-bottom: 0.25rem;">Duration</div>
          <div style="color: var(--color-fg-default); font-weight: 600;" id="jobDuration">-</div>
        </div>
      </div>
    </div>

    <!-- Progress Bar -->
    <div style="margin-bottom: 1.5rem;">
      <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
        <span style="font-weight: 600; color: var(--color-fg-default);">Progress</span>
        <span style="color: var(--color-fg-muted);" id="jobProgressPercent">0%</span>
      </div>
      <div style="background: var(--color-border-default); border-radius: 8px; height: 12px; overflow: hidden;">
        <div id="jobProgressBar" style="background: var(--scitex-color-03); height: 100%; width: 0%; transition: width 0.3s;"></div>
      </div>
      <div style="margin-top: 0.5rem; color: var(--color-fg-muted); font-size: 0.9rem;" id="jobProgressText">
        0 / 0 papers processed
      </div>
    </div>

    <!-- Processing Log -->
    <div style="margin-bottom: 1.5rem;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
        <h3 style="color: var(--color-fg-default); font-size: 1.1rem; margin: 0;">
          <i class="fas fa-terminal"></i> Processing Log
        </h3>
        <button id="toggleJobLog" style="background: none; border: 1px solid var(--color-border-default); border-radius: 6px; padding: 0.5rem; cursor: pointer; color: var(--color-fg-muted);">
          <i class="fas fa-expand-alt"></i>
        </button>
      </div>
      <pre id="jobProcessingLog" style="background: #0a0f1a; color: #00ff00; padding: 1.5rem; border-radius: 8px; overflow-y: auto; max-height: 300px; font-size: 0.875rem; line-height: 1.3; margin: 0; font-family: 'Courier New', monospace; white-space: pre-wrap;">Waiting for job to start...</pre>
    </div>

    <!-- Download Button (shown when complete) -->
    <div id="jobDownloadSection" style="display: none; text-align: center; padding: 1rem; background: var(--color-success-subtle); border-radius: 8px; border: 1px solid var(--success-color);">
      <h3 style="color: var(--success-color); margin-bottom: 1rem;">
        <i class="fas fa-check-circle"></i> Enrichment Complete!
      </h3>
      <a id="jobDownloadBtn" href="#" style="display: inline-block; padding: 1rem 2rem; background: var(--success-color); color: white; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 1.1rem;">
        <i class="fas fa-download"></i> Download Enriched BibTeX
      </a>
      <div style="color: var(--color-fg-muted); margin-top: 0.5rem; font-size: 0.9rem;" id="jobDownloadInfo">
        -
      </div>
    </div>
  </div>

  <!-- What Gets Enriched -->
  <div style="background: var(--color-canvas-subtle); border-radius: 12px; padding: 2.5rem; margin-bottom: 3rem;">
    <h2 style="color: var(--color-fg-default); margin-bottom: 1.5rem; font-size: 1.5rem; text-align: center;">
      <i class="fas fa-sparkles"></i> What Gets Enriched
    </h2>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
      <div style="text-align: center;">
        <div style="font-size: 2.5rem; color: var(--scitex-color-03); margin-bottom: 0.5rem;">
          <i class="fas fa-quote-right"></i>
        </div>
        <h3 style="color: var(--color-fg-default); font-size: 1.1rem; margin-bottom: 0.5rem;">Citation Counts</h3>
        <p style="color: var(--color-fg-muted); font-size: 0.9rem;">From CrossRef, Semantic Scholar, and more</p>
      </div>

      <div style="text-align: center;">
        <div style="font-size: 2.5rem; color: var(--scitex-color-03); margin-bottom: 0.5rem;">
          <i class="fas fa-chart-line"></i>
        </div>
        <h3 style="color: var(--color-fg-default); font-size: 1.1rem; margin-bottom: 0.5rem;">Impact Factors</h3>
        <p style="color: var(--color-fg-muted); font-size: 0.9rem;">Journal metrics and rankings</p>
      </div>

      <div style="text-align: center;">
        <div style="font-size: 2.5rem; color: var(--scitex-color-03); margin-bottom: 0.5rem;">
          <i class="fas fa-file-pdf"></i>
        </div>
        <h3 style="color: var(--color-fg-default); font-size: 1.1rem; margin-bottom: 0.5rem;">PDF Downloads</h3>
        <p style="color: var(--color-fg-muted); font-size: 0.9rem;">Automatic PDF acquisition</p>
      </div>

      <div style="text-align: center;">
        <div style="font-size: 2.5rem; color: var(--scitex-color-03); margin-bottom: 0.5rem;">
          <i class="fas fa-database"></i>
        </div>
        <h3 style="color: var(--color-fg-default); font-size: 1.1rem; margin-bottom: 0.5rem;">Metadata</h3>
        <p style="color: var(--color-fg-muted); font-size: 0.9rem;">Abstract, keywords, and more</p>
      </div>
    </div>
  </div>

  <!-- Recent Jobs -->
  {% if recent_jobs %}
  <div style="background: var(--color-canvas-default); border-radius: 12px; padding: 2.5rem; box-shadow: 0 2px 12px rgba(0,0,0,0.08); border: 1px solid var(--color-border-default);">
    <h2 style="color: var(--color-fg-default); margin-bottom: 1.5rem; font-size: 1.5rem;">
      <i class="fas fa-history"></i> Recent Enrichment Jobs
    </h2>

    <div style="overflow-x: auto;">
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="background: var(--color-canvas-subtle); border-bottom: 2px solid var(--color-border-default);">
            <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--color-fg-default);">File</th>
            <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--color-fg-default);">Status</th>
            <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--color-fg-default);">Progress</th>
            <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--color-fg-default);">Created</th>
            <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--color-fg-default);">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for job in recent_jobs %}
          <tr style="border-bottom: 1px solid var(--color-border-default);">
            <td style="padding: 1rem;">
              <strong>{{ job.input_file.name|slice:"-50:" }}</strong>
              {% if job.project %}
              <br><small style="color: var(--scitex-color-03);"><i class="fas fa-folder"></i> {{ job.project.name }}</small>
              {% if job.enrichment_summary.gitea_commit %}
              <br><small style="color: var(--success-color);"><i class="fas fa-check"></i> Committed to Gitea</small>
              {% endif %}
              {% elif job.project_name %}
              <br><small style="color: var(--color-fg-muted);"><i class="fas fa-tag"></i> {{ job.project_name }}</small>
              {% endif %}
            </td>
            <td style="padding: 1rem;">
              {% if job.status == 'completed' %}
              <span style="color: var(--success-color); font-weight: 600;"><i class="fas fa-check-circle"></i> Completed</span>
              {% elif job.status == 'processing' %}
              <span style="color: var(--info-color); font-weight: 600;"><i class="fas fa-spinner fa-spin"></i> Processing</span>
              {% elif job.status == 'failed' %}
              <span style="color: var(--error-color); font-weight: 600;"><i class="fas fa-times-circle"></i> Failed</span>
              {% else %}
              <span style="color: var(--color-fg-muted); font-weight: 600;"><i class="fas fa-clock"></i> Pending</span>
              {% endif %}
            </td>
            <td style="padding: 1rem;">
              <div style="background: var(--color-border-default); border-radius: 4px; height: 8px; overflow: hidden;">
                <div style="background: var(--scitex-color-03); height: 100%; width: {{ job.get_progress_percentage }}%;"></div>
              </div>
              <small style="color: var(--color-fg-muted);">{{ job.processed_papers }}/{{ job.total_papers }} papers</small>
            </td>
            <td style="padding: 1rem; color: var(--color-fg-muted);">
              {{ job.created_at|date:"M d, Y H:i" }}
            </td>
            <td style="padding: 1rem;">
              <a href="{% url 'scholar_app:bibtex_job_detail' job.id %}" style="color: var(--color-accent-fg); text-decoration: none; font-weight: 600;">
                <i class="fas fa-eye"></i> View
              </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}

</div>

<!-- Drag & Drop and Upload Progress JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const dropZone = document.getElementById('dropZone');
  const fileInput = document.getElementById('bibtex_file');
  const dropZoneContent = document.getElementById('dropZoneContent');
  const fileNameDisplay = document.getElementById('fileNameDisplay');
  const fileName = document.getElementById('fileName');
  const fileSize = document.getElementById('fileSize');
  const changeFileBtn = document.getElementById('changeFileBtn');
  const uploadForm = document.querySelector('form');
  const submitBtn = uploadForm.querySelector('button[type="submit"]');

  // Format file size
  function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
  }

  // Validate file
  function validateFile(file) {
    if (!file.name.toLowerCase().endsWith('.bib')) {
      alert('Please select a valid BibTeX file (.bib)');
      return false;
    }
    if (file.size > 50 * 1024 * 1024) { // 50MB limit
      alert('File is too large. Maximum size is 50MB.');
      return false;
    }
    return true;
  }

  // Display file info
  function displayFileInfo(file) {
    if (!file) return;

    fileName.textContent = file.name;
    fileSize.textContent = formatFileSize(file.size);

    // Force hide/show with display style
    dropZoneContent.style.display = 'none';
    dropZoneContent.style.visibility = 'hidden';

    fileNameDisplay.style.display = 'block';
    fileNameDisplay.style.visibility = 'visible';

    dropZone.style.borderColor = 'var(--success-color)';
    dropZone.style.borderStyle = 'solid';
    dropZone.style.background = 'rgba(74, 155, 126, 0.1)';

    console.log('File selected:', file.name, file.size);
  }

  // Handle file selection
  function handleFileSelect(file) {
    if (validateFile(file)) {
      displayFileInfo(file);
    } else {
      fileInput.value = '';
    }
  }

  // File input change
  fileInput.addEventListener('change', function(e) {
    if (this.files && this.files[0]) {
      handleFileSelect(this.files[0]);
    }
  });

  // Change file button
  changeFileBtn.addEventListener('click', function(e) {
    e.preventDefault();
    e.stopPropagation();

    // Clear the file input
    fileInput.value = '';

    // Show upload zone, hide file display
    dropZoneContent.style.display = 'block';
    dropZoneContent.style.visibility = 'visible';

    fileNameDisplay.style.display = 'none';
    fileNameDisplay.style.visibility = 'hidden';

    // Reset border styling
    dropZone.style.borderColor = 'var(--color-border-default)';
    dropZone.style.borderStyle = 'dashed';
    dropZone.style.background = 'var(--color-canvas-subtle)';

    console.log('File selection cleared');
  });

  // Drag and drop events
  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, preventDefaults, false);
  });

  function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
  }

  // Highlight on drag
  ['dragenter', 'dragover'].forEach(eventName => {
    dropZone.addEventListener(eventName, function() {
      if (!fileInput.files || !fileInput.files[0]) {
        dropZone.style.borderColor = '#6B8FB3'; // scitex-color-03
        dropZone.style.borderStyle = 'solid';
        dropZone.style.background = 'rgba(107, 143, 179, 0.15)';
      }
      dropZone.style.transform = 'scale(1.01)';
      dropZone.style.boxShadow = '0 4px 16px rgba(107, 143, 179, 0.3)';
    });
  });

  ['dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, function() {
      if (!fileInput.files || !fileInput.files[0]) {
        dropZone.style.borderColor = 'var(--color-border-default)';
        dropZone.style.borderStyle = 'dashed';
        dropZone.style.background = 'var(--color-canvas-subtle)';
      }
      dropZone.style.transform = 'scale(1)';
      dropZone.style.boxShadow = 'none';
    });
  });

  // Handle drop
  dropZone.addEventListener('drop', function(e) {
    const dt = e.dataTransfer;
    const files = dt.files;

    if (files && files[0]) {
      // Set the file to the input element
      fileInput.files = files;
      handleFileSelect(files[0]);
    }
  });

  // Form submission with progress
  uploadForm.addEventListener('submit', function(e) {
    e.preventDefault();

    // Validate file is selected
    if (!fileInput.files || !fileInput.files[0]) {
      alert('Please select a BibTeX file to upload.');
      return;
    }

    // Show loading state
    const originalBtnText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
    submitBtn.style.cursor = 'not-allowed';

    // Create FormData
    const formData = new FormData(uploadForm);

    // Submit via AJAX for better feedback
    fetch(uploadForm.action, {
      method: 'POST',
      body: formData,
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP error ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      if (data.success) {
        // Show success message
        submitBtn.innerHTML = '<i class="fas fa-check-circle"></i> Upload Complete!';
        submitBtn.style.background = 'var(--success-color)';

        // Show inline progress panel instead of redirecting
        setTimeout(() => {
          showJobProgress(data.job_id, fileInput.files[0].name);

          // Reset upload form
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalBtnText;
          submitBtn.style.background = 'var(--color-btn-primary-bg)';
          submitBtn.style.cursor = 'pointer';

          // Scroll to progress panel
          document.getElementById('activeJobPanel').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 500);
      } else {
        throw new Error(data.message || 'Upload failed');
      }
    })
    .catch(error => {
      console.error('Upload error:', error);
      alert('Upload failed: ' + error.message);
      submitBtn.disabled = false;
      submitBtn.innerHTML = originalBtnText;
      submitBtn.style.cursor = 'pointer';
    });
  });

  // ============ Inline Job Progress Tracking ============

  let activeJobId = null;
  let pollingInterval = null;
  let jobStartTime = null;
  let logExpanded = false;

  // Show job progress panel
  function showJobProgress(jobId, fileName) {
    activeJobId = jobId;
    jobStartTime = new Date();

    const panel = document.getElementById('activeJobPanel');
    const jobFileNameEl = document.getElementById('jobFileName');
    const jobProcessingLog = document.getElementById('jobProcessingLog');

    // Update UI
    jobFileNameEl.textContent = fileName;
    jobProcessingLog.textContent = 'Starting enrichment job...\n';
    panel.style.display = 'block';

    // Start polling for status
    startJobPolling();
  }

  // Start polling for job status
  function startJobPolling() {
    if (pollingInterval) clearInterval(pollingInterval);

    // Poll immediately, then every 2 seconds
    pollJobStatus();
    pollingInterval = setInterval(pollJobStatus, 2000);
  }

  // Poll job status
  function pollJobStatus() {
    if (!activeJobId) return;

    fetch(`/scholar/api/bibtex/job/${activeJobId}/status/`)
      .then(response => {
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return response.json();
      })
      .then(data => {
        updateJobUI(data);

        // Stop polling if job is complete or failed
        if (data.status === 'completed' || data.status === 'failed') {
          if (pollingInterval) {
            clearInterval(pollingInterval);
            pollingInterval = null;
          }
        }
      })
      .catch(error => {
        console.error('[Job Polling Error]:', error);
      });
  }

  // Update job UI with latest data
  function updateJobUI(data) {
    // Update status
    const jobStatus = document.getElementById('jobStatus');
    const jobTitle = document.getElementById('jobTitle');
    const titleIcon = jobTitle.previousElementSibling;

    if (data.status === 'completed') {
      jobStatus.innerHTML = '<span style="color: var(--success-color);"><i class="fas fa-check-circle"></i> Completed</span>';
      jobTitle.textContent = 'Enrichment Complete';
      titleIcon.className = 'fas fa-check-circle';
      titleIcon.style.animation = 'none';
      document.getElementById('jobDownloadSection').style.display = 'block';
      document.getElementById('jobDownloadBtn').href = `/scholar/bibtex/job/${activeJobId}/download/`;
      document.getElementById('jobDownloadInfo').textContent = `${data.total_papers} entries, ${data.processed_papers} enriched`;
    } else if (data.status === 'processing') {
      jobStatus.innerHTML = '<span style="color: var(--info-color);"><i class="fas fa-spinner fa-spin"></i> Processing</span>';
      jobTitle.textContent = 'Enrichment in Progress';
    } else if (data.status === 'failed') {
      jobStatus.innerHTML = '<span style="color: var(--error-color);"><i class="fas fa-times-circle"></i> Failed</span>';
      jobTitle.textContent = 'Enrichment Failed';
      titleIcon.className = 'fas fa-times-circle';
      titleIcon.style.animation = 'none';
    }

    // Update progress
    const progressPercent = data.progress_percentage || 0;
    document.getElementById('jobProgressBar').style.width = `${progressPercent}%`;
    document.getElementById('jobProgressPercent').textContent = `${progressPercent}%`;

    let progressText = `${data.processed_papers || 0} / ${data.total_papers || 0} papers processed`;
    if (data.failed_papers > 0) {
      progressText += ` (${data.failed_papers} failed)`;
    }
    document.getElementById('jobProgressText').textContent = progressText;

    // Update duration
    if (jobStartTime) {
      const now = new Date();
      const elapsedSec = Math.floor((now - jobStartTime) / 1000);
      let durationText;
      if (elapsedSec < 60) {
        durationText = `${elapsedSec}s`;
      } else if (elapsedSec < 3600) {
        const min = Math.floor(elapsedSec / 60);
        const sec = elapsedSec % 60;
        durationText = `${min}m ${sec}s`;
      } else {
        const hr = Math.floor(elapsedSec / 3600);
        const min = Math.floor((elapsedSec % 3600) / 60);
        durationText = `${hr}h ${min}m`;
      }
      document.getElementById('jobDuration').textContent = durationText;
    }

    // Update log
    if (data.log) {
      const logEl = document.getElementById('jobProcessingLog');
      logEl.textContent = data.log;
      // Auto-scroll to bottom
      logEl.scrollTop = logEl.scrollHeight;
    }
  }

  // Close job panel
  document.getElementById('closeJobPanel').addEventListener('click', function() {
    document.getElementById('activeJobPanel').style.display = 'none';
    if (pollingInterval) {
      clearInterval(pollingInterval);
      pollingInterval = null;
    }
    activeJobId = null;
  });

  // Toggle log size
  document.getElementById('toggleJobLog').addEventListener('click', function() {
    const logEl = document.getElementById('jobProcessingLog');
    logExpanded = !logExpanded;

    if (logExpanded) {
      logEl.style.maxHeight = '600px';
      this.innerHTML = '<i class="fas fa-compress-alt"></i>';
    } else {
      logEl.style.maxHeight = '300px';
      this.innerHTML = '<i class="fas fa-expand-alt"></i>';
    }
  });
});
</script>
{% endblock %}
