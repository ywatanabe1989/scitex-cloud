<div class="result-card" data-paper-id="{{ result.id }}" data-title="{{ result.title }}" data-authors="{{ result.authors }}" data-year="{{ result.year }}" data-citations="{{ result.citation_count|default:'0' }}" data-impact-factor="{{ result.impact_factor|default:'0' }}" data-journal="{{ result.journal|default:'Unknown Journal' }}" data-doi="{{ result.doi|default:'' }}" data-pmid="{{ result.pmid|default:'' }}" data-arxiv-id="{{ result.arxiv_id|default:'' }}" data-external-url="{{ result.external_url|default:'' }}" data-source="{{ result.source|default:'' }}">
    <div class="d-flex align-items-start gap-2">
        <div class="form-check mt-1">
            <input class="form-check-input paper-select-checkbox" type="checkbox" id="select_{{ result.id }}" data-paper-id="{{ result.id }}" data-doi="{{ result.doi|default:'' }}" data-title="{{ result.title }}">
            <label class="form-check-label" for="select_{{ result.id }}"></label>
        </div>
        <div class="flex-grow-1">
            <h6 class="result-title mb-0">
                <a href="{% if result.doi %}https://doi.org/{{ result.doi }}{% elif result.external_url %}{{ result.external_url }}{% elif result.pmid %}https://pubmed.ncbi.nlm.nih.gov/{{ result.pmid }}/{% elif result.arxiv_id %}https://arxiv.org/abs/{{ result.arxiv_id }}{% else %}https://scholar.google.com/scholar?q={{ result.title|urlencode }}{% endif %}"
                   class="text-decoration-none"
                   target="_blank"
                   onclick="return viewOnWeb(this, event)">
                    {{ result.title }}
                </a>
            </h6>
        </div>
    </div>
    <div class="result-authors">
        {{ result.authors }}
    </div>
    <div class="d-flex align-items-center mt-2 flex-wrap">
        <span class="year-badge me-2">{{ result.year }}</span>
        {% if result.is_open_access %}
        <span class="open-access me-2">Open Access</span>
        {% endif %}
        {% if result.impact_factor %}
        <span class="badge impact-factor-badge me-2 u-text-muted-xs">
            IF: {{ result.impact_factor }}
        </span>
        {% endif %}
        <small class="text-muted">
            <em>{{ result.journal|default:"Unknown Journal" }}</em>
            {% if result.citation_count and result.citation_count > 0 %}
                â€¢ <strong><span class="citation-count" data-count="{{ result.citation_count }}">{{ result.citation_count|stringformat:"d" }}</span> citations</strong>
                {% if result.citation_source %}
                    <span class="badge bg-light text-dark" style="font-size: 0.6rem;" title="Citation data source">{{ result.citation_source|upper }}</span>
                {% endif %}
            {% elif result.citation_count == 0 %}
                â€¢ <span class="text-muted">0 citations</span>
            {% else %}
                â€¢ <span class="text-muted">Citations unavailable</span>
            {% endif %}
            {% if result.pmid %}
                â€¢ PMID: {{ result.pmid }}
            {% endif %}
        </small>
        {% if result.source_engines %}
            {% for engine in result.source_engines %}
            <span class="badge bg-info ms-1 u-text-muted-xs" title="Found by {{ engine }}">{{ engine|upper }}</span>
            {% endfor %}
        {% elif result.source %}
        <span class="badge bg-info ms-2 u-text-muted-xs" title="Source">{{ result.source|upper }}</span>
        {% endif %}
    </div>

    <!-- Abstract Section with Multi-Mode Toggle -->
    <div class="result-snippet mt-2">
        <div class="abstract-preview" data-abstract-id="{{ result.id }}" data-mode="all">
            {% if result.full_abstract %}
                <span class="abstract-full">{{ result.full_abstract }}</span>
                <span class="abstract-short">{{ result.snippet|default:"No abstract available." }}</span>
            {% else %}
                <span class="abstract-full">No abstract available.</span>
                <span class="abstract-short">No abstract available.</span>
            {% endif %}
        </div>
        <div class="abstract-controls mt-1">
            <button type="button" class="abstract-toggle-btn" onclick="toggleAbstractMode(this, '{{ result.id }}', 'all')" title="Show full abstract">
                <i class="fas fa-file-alt"></i> All
            </button>
            <button type="button" class="abstract-toggle-btn" onclick="toggleAbstractMode(this, '{{ result.id }}', 'truncated')" title="Show truncated abstract">
                <i class="fas fa-ellipsis-h"></i> Truncated
            </button>
            <button type="button" class="abstract-toggle-btn" onclick="toggleAbstractMode(this, '{{ result.id }}', 'none')" title="Hide abstract">
                <i class="fas fa-eye-slash"></i> None
            </button>
        </div>
    </div>
    {% if user.is_authenticated %}
    <div class="mt-3">
        <a href="{% url 'scholar_app:paper_annotations' result.id %}" class="btn btn-outline-success btn-sm me-2">
            ðŸ’¬ Annotate
        </a>
    </div>
    {% endif %}
</div>
