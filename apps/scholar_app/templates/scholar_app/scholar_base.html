{% extends 'global_base.html' %}
{% load static %}
{% block meta_description %}Advanced semantic search for scientific literature{% endblock %}
{% block extra_css %}
    <!-- Workspace colors CSS for consistent theming -->
    <link rel="stylesheet" href="{% static 'shared/css/primitives/colors.css' %}" />
    <!-- Hero gradients CSS -->
    <link rel="stylesheet" href="{% static 'shared/css/components/hero.css' %}" />
    <!-- Workspace files tree CSS -->
    <link rel="stylesheet" href="{% static 'shared/css/components/workspace-files-tree.css' %}?v=20251130b" />
    <!-- Panel resizer CSS -->
    <link rel="stylesheet" href="{% static 'shared/css/components/panel-resizer.css' %}" />
    <!-- App-specific CSS - Modular common styles -->
    <link rel="stylesheet" href="{% static 'scholar_app/css/common/01-workspace-colors.css' %}?v=1764328804" />
    <link rel="stylesheet" href="{% static 'scholar_app/css/common/02-layout-system.css' %}?v=1764328804" />
    <link rel="stylesheet" href="{% static 'scholar_app/css/common/03-badge-system.css' %}?v=1764328804" />
    <link rel="stylesheet" href="{% static 'scholar_app/css/common/04-card-components.css' %}?v=1764328804" />
    <link rel="stylesheet" href="{% static 'scholar_app/css/common/05-utilities.css' %}?v=1764328804" />
    <link rel="stylesheet" href="{% static 'scholar_app/css/common/06-ui-components.css' %}?v=1764328804" />
    <link rel="stylesheet" href="{% static 'scholar_app/css/common/07-workspace-layout.css' %}?v=1764328804" />
    <!-- Workspace colors - responsive to theme -->
    <style>
    /* Scholar workspace colors - uses CSS variables for theme responsiveness */
    body.scholar-page,
    body.workspace-page.scholar-page,
    .scholar-page {
        background: var(--workspace-bg-primary, var(--color-canvas-default)) !important;
    }
    body.scholar-page #main-content,
    body.scholar-page .scholar-workspace {
        background: var(--workspace-bg-primary, var(--color-canvas-default)) !important;
    }
    .scholar-sidebar,
    .scholar-main,
    .scholar-properties {
        background: var(--workspace-bg-primary, var(--color-canvas-default)) !important;
    }
    .scholar-sidebar .sidebar-header,
    .scholar-main .pane-header,
    .scholar-properties .properties-header {
        background: var(--workspace-bg-secondary, var(--color-canvas-subtle)) !important;
        border-color: var(--color-border-default) !important;
    }
    .scholar-sidebar .sidebar-content,
    .scholar-main .pane-content,
    .scholar-properties .properties-content {
        background: var(--workspace-bg-primary, var(--color-canvas-default)) !important;
    }
    .bibtex-card,
    .bibtex-tile {
        background: var(--workspace-bg-secondary, var(--color-canvas-subtle)) !important;
        border-color: var(--color-border-default) !important;
        border-radius: 0 !important;
    }
    .bibtex-card__header,
    .bibtex-tile__header {
        background: var(--workspace-bg-tertiary, var(--color-canvas-inset)) !important;
        border-color: var(--color-border-default) !important;
    }
    .bibtex-dropzone {
        background: var(--workspace-bg-primary, var(--color-canvas-default)) !important;
        border-color: var(--color-border-default) !important;
        border-radius: 0 !important;
    }
    .bibtex-tile__title i,
    .bibtex-card__title i,
    .pane-header h5 i,
    .properties-header h5 i,
    .sidebar-header h5 i {
        color: var(--scitex-color-03, var(--workspace-icon-primary)) !important;
    }
    .bibtex-status-item {
        background: var(--workspace-bg-primary, var(--color-canvas-default)) !important;
        border-radius: 0 !important;
    }
    .terminal-log {
        background: var(--workspace-bg-primary, var(--color-canvas-default)) !important;
        border-radius: 0 !important;
    }
    /* Hide footer on scholar workspace */
    body.scholar-page footer {
        display: none !important;
    }
    </style>
{% endblock %}
{% block content %}
    <!-- Three-panel layout always active for workspace consistency -->
    <div class="scholar-workspace">
        <!-- Left sidebar: File tree (only with project) -->
        <aside class="scholar-sidebar {% if not current_project %}collapsed{% endif %}" id="scholar-sidebar">
            <div class="sidebar-header">
                <h5><i class="fas fa-folder-open"></i> Files</h5>
                <button class="sidebar-toggle" id="sidebar-toggle" title="Toggle sidebar">
                    <i class="fas fa-chevron-left"></i>
                </button>
            </div>
            <div class="sidebar-content" id="file-tree">
                {% if current_project %}
                <!-- WorkspaceFilesTree will render here -->
                <div class="wft-loading">Loading...</div>
                {% else %}
                <div class="sidebar-no-project">
                    <p class="text-muted">Select a project to browse files</p>
                </div>
                {% endif %}
            </div>
        </aside>
        <!-- Sidebar resizer -->
        <div class="panel-resizer" id="sidebar-resizer"></div>
        <!-- Main content area -->
        <main class="scholar-main">
            <div class="pane-header">
                <h5><i class="fas fa-file-code"></i> BibTeX Enrichment</h5>
                <div class="pane-header-actions">
                    {% block pane_header_actions %}{% endblock %}
                </div>
            </div>
            <div class="pane-content">
                {% block search_content %}{% endblock %}
            </div>
        </main>
        <!-- Main resizer -->
        <div class="panel-resizer" id="main-resizer"></div>
        <!-- Right properties panel -->
        <aside class="scholar-properties" id="scholar-properties">
            <div class="properties-header">
                <h5><i class="fas fa-tasks"></i> Status</h5>
                <button class="properties-toggle" id="properties-toggle" title="Toggle properties">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            <div class="properties-content" id="scholar-status-panel">
                {% block status_content %}
                <!-- Default status content - can be overridden -->
                <p class="text-muted">Status information</p>
                {% endblock %}
            </div>
        </aside>
    </div>
{% endblock %}

{% block extra_js %}
    {{ block.super }}
    <!-- Panel resizer manager -->
    <script src="{% static 'scholar_app/js/scholar-resizer-manager.js' %}"></script>
    {% if current_project %}
    <script type="module">
        // Initialize WorkspaceFilesTree for scholar mode
        import { WorkspaceFilesTree } from '{% static "shared/js/components/workspace-files-tree/WorkspaceFilesTree.js" %}';

        document.addEventListener('DOMContentLoaded', async () => {
            const tree = new WorkspaceFilesTree({
                mode: 'scholar',
                containerId: 'file-tree',
                username: '{{ current_project.owner.username }}',
                slug: '{{ current_project.slug }}',
                showFolderActions: true,
                showGitStatus: false,
                onFileSelect: (path, item) => {
                    console.log('[Scholar] File selected:', path);
                    // Handle file selection - e.g., open PDF viewer, load BibTeX
                    if (path.endsWith('.pdf')) {
                        window.open(`/{{ current_project.owner.username }}/{{ current_project.slug }}/files/${path}`, '_blank');
                    } else if (path.endsWith('.bib')) {
                        // Could trigger BibTeX import
                        console.log('BibTeX file selected:', path);
                    }
                }
            });
            await tree.initialize();

            // Expose tree globally for BibTeX enrichment to trigger refresh
            window.scholarWorkspaceTree = tree;

            // Sidebar toggle
            const toggleBtn = document.getElementById('sidebar-toggle');
            const sidebar = document.getElementById('scholar-sidebar');
            if (toggleBtn && sidebar) {
                toggleBtn.addEventListener('click', () => {
                    sidebar.classList.toggle('collapsed');
                    toggleBtn.querySelector('i').classList.toggle('fa-chevron-left');
                    toggleBtn.querySelector('i').classList.toggle('fa-chevron-right');
                });
            }

            // Properties panel toggle
            const propsToggleBtn = document.getElementById('properties-toggle');
            const propsPanel = document.getElementById('scholar-properties');
            if (propsToggleBtn && propsPanel) {
                propsToggleBtn.addEventListener('click', () => {
                    propsPanel.classList.toggle('collapsed');
                    propsToggleBtn.querySelector('i').classList.toggle('fa-chevron-right');
                    propsToggleBtn.querySelector('i').classList.toggle('fa-chevron-left');
                });
            }
        });
    </script>
    {% endif %}
{% endblock %}
