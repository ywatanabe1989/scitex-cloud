{% extends "base.html" %}
{% load static %}
{% block extra_css %}
    <link rel="stylesheet" href="{% static 'shared/css/components/hero.css' %}" />
    <style>
  .scholar-card {
    background: var(--color-canvas-default);
    border-radius: 12px;
    padding: 2.5rem;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
    border: 1px solid var(--color-border-default);
    margin-bottom: 2rem;
  }
  .feature-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-top: 2rem;
  }
  .feature-card {
    text-align: center;
    padding: 1.5rem;
    background: var(--color-canvas-subtle);
    border-radius: 8px;
    border: 1px solid var(--color-border-default);
  }
    </style>
{% endblock %}
{% block content %}
    <section class="hero-section hero-silverish-ai-light">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-8 text-center">
                    <img src="{% static 'shared/images/icons_svg/scitex-scholar-icon.svg' %}"
                         alt="Scholar"
                         width="80"
                         height="80"
                         class="mb-4" />
                    <h1 class="hero-title">{{ project.name }} - Scholar</h1>
                    <p class="hero-subtitle">Literature Search & Reference Management</p>
                </div>
            </div>
        </div>
    </section>
    <section class="py-5">
        <div class="container" style="max-width: 1000px">
            <!-- BibTeX Enrichment Section -->
            <div class="scholar-card">
                <h2 style="color: var(--scitex-color-03);
                           font-size: 1.8rem;
                           margin-bottom: 1rem">
                    <i class="fas fa-file-code"></i> BibTeX Enrichment
                </h2>
                <p style="color: var(--color-fg-muted); margin-bottom: 2rem">
                    Upload your BibTeX file and get it enriched with citation counts, impact
                    factors, PDFs, and abstracts. The enriched bibliography will be
                    automatically committed to this project's Gitea repository.
                </p>
                <!-- Upload Form -->
                <form method="post"
                      action="{% url 'scholar_app:bibtex_upload' %}"
                      enctype="multipart/form-data">
                    {% csrf_token %}
                    <!-- Hidden field for pre-selected project -->
                    <input type="hidden" name="project_id" value="{{ project.id }}" />
                    <!-- File Upload -->
                    <div style="margin-bottom: 1.5rem">
                        <label for="bibtex_file"
                               style="display: block;
                                      font-weight: 600;
                                      margin-bottom: 0.5rem;
                                      color: var(--color-fg-default)">Select BibTeX File (.bib)</label>
                        <input type="file"
                               name="bibtex_file"
                               id="bibtex_file"
                               accept=".bib"
                               required
                               class="form-control"
                               style="padding: 0.75rem;
                                      border: 2px dashed var(--color-border-default);
                                      border-radius: 8px;
                                      background: var(--color-canvas-default);
                                      color: var(--color-fg-default)" />
                        <small class="text-muted d-block mt-2">
                            <i class="fas fa-info-circle"></i> Will be saved to
                            <code>/references/references.bib</code> in Gitea
                        </small>
                    </div>
                    <!-- Advanced Options -->
                    <details style="margin-bottom: 1.5rem;
                                    padding: 1rem;
                                    background: var(--color-canvas-subtle);
                                    border-radius: 6px">
                        <summary style="cursor: pointer;
                                        font-weight: 600;
                                        color: var(--color-fg-default)">
                            <i class="fas fa-cog"></i> Advanced Options
                        </summary>
                        <div style="margin-top: 1rem">
                            <div style="margin-bottom: 1rem">
                                <label for="num_workers" class="form-label">Parallel Workers</label>
                                <select name="num_workers" id="num_workers" class="form-select">
                                    <option value="2">2 workers (slower, lighter)</option>
                                    <option value="4" selected>4 workers (balanced)</option>
                                    <option value="8">8 workers (faster, requires more resources)</option>
                                </select>
                            </div>
                            <div>
                                <label for="browser_mode" class="form-label">Browser Mode</label>
                                <select name="browser_mode" id="browser_mode" class="form-select">
                                    <option value="stealth" selected>Stealth (recommended)</option>
                                    <option value="interactive">Interactive</option>
                                </select>
                            </div>
                        </div>
                    </details>
                    <!-- Submit Button -->
                    <button type="submit"
                            class="btn btn-primary w-100"
                            style="padding: 1rem;
                                   font-size: 1.1rem;
                                   background: var(--color-btn-primary-bg);
                                   color: var(--color-btn-primary-text);
                                   border: 1px solid var(--color-btn-primary-border)"
                            onmouseover="this.style.background='var(--color-btn-primary-hover-bg)'"
                            onmouseout="this.style.background='var(--color-btn-primary-bg)'">
                        <i class="fas fa-magic"></i> Enrich BibTeX File for {{ project.name }}
                    </button>
                </form>
            </div>
            <!-- What Gets Enriched -->
            <div style="background: var(--color-canvas-subtle);
                        border-radius: 12px;
                        padding: 2.5rem;
                        margin-bottom: 2rem">
                <h3 style="color: var(--color-fg-default);
                           margin-bottom: 1.5rem;
                           text-align: center">
                    <i class="fas fa-sparkles"></i> What Gets Enriched
                </h3>
                <div class="feature-grid">
                    <div class="feature-card">
                        <div style="font-size: 2.5rem;
                                    color: var(--scitex-color-03);
                                    margin-bottom: 0.5rem">
                            <i class="fas fa-quote-right"></i>
                        </div>
                        <h4 style="color: var(--color-fg-default);
                                   font-size: 1.1rem;
                                   margin-bottom: 0.5rem">Citation Counts</h4>
                        <p style="color: var(--color-fg-muted); font-size: 0.9rem; margin: 0">From CrossRef, Semantic Scholar</p>
                    </div>
                    <div class="feature-card">
                        <div style="font-size: 2.5rem;
                                    color: var(--scitex-color-03);
                                    margin-bottom: 0.5rem">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <h4 style="color: var(--color-fg-default);
                                   font-size: 1.1rem;
                                   margin-bottom: 0.5rem">Impact Factors</h4>
                        <p style="color: var(--color-fg-muted); font-size: 0.9rem; margin: 0">Journal metrics and rankings</p>
                    </div>
                    <div class="feature-card">
                        <div style="font-size: 2.5rem;
                                    color: var(--scitex-color-03);
                                    margin-bottom: 0.5rem">
                            <i class="fas fa-file-pdf"></i>
                        </div>
                        <h4 style="color: var(--color-fg-default);
                                   font-size: 1.1rem;
                                   margin-bottom: 0.5rem">PDF Downloads</h4>
                        <p style="color: var(--color-fg-muted); font-size: 0.9rem; margin: 0">Automatic PDF acquisition</p>
                    </div>
                    <div class="feature-card">
                        <div style="font-size: 2.5rem;
                                    color: var(--scitex-color-03);
                                    margin-bottom: 0.5rem">
                            <i class="fas fa-align-left"></i>
                        </div>
                        <h4 style="color: var(--color-fg-default);
                                   font-size: 1.1rem;
                                   margin-bottom: 0.5rem">Abstracts</h4>
                        <p style="color: var(--color-fg-muted); font-size: 0.9rem; margin: 0">Full paper abstracts for AI context</p>
                    </div>
                </div>
            </div>
            <!-- Recent Enrichment Jobs for This Project -->
            {% if recent_jobs %}
                <div class="scholar-card">
                    <h3 style="color: #1e293b; margin-bottom: 1.5rem; font-size: 1.5rem">
                        <i class="fas fa-history"></i> Recent Enrichment Jobs
                    </h3>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>File</th>
                                    <th>Status</th>
                                    <th>Progress</th>
                                    <th>Gitea</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for job in recent_jobs %}
                                    <tr>
                                        <td>
                                            <strong>{{ job.input_file.name|slice:"-30:" }}</strong>
                                        </td>
                                        <td>
                                            {% if job.status == 'completed' %}
                                                <span class="badge bg-success"><i class="fas fa-check-circle"></i> Completed</span>
                                            {% elif job.status == 'processing' %}
                                                <span class="badge bg-primary"><i class="fas fa-spinner fa-spin"></i> Processing</span>
                                            {% elif job.status == 'failed' %}
                                                <span class="badge bg-danger"><i class="fas fa-times-circle"></i> Failed</span>
                                            {% else %}
                                                <span class="badge bg-secondary"><i class="fas fa-clock"></i> Pending</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <small>{{ job.processed_papers }}/{{ job.total_papers }}</small>
                                        </td>
                                        <td>
                                            {% if job.enrichment_summary.gitea_commit %}
                                                <span style="color: #10b981"><i class="fas fa-check"></i></span>
                                            {% elif job.status == 'completed' %}
                                                <span style="color: #f59e0b"><i class="fas fa-exclamation-triangle"></i></span>
                                            {% else %}
                                                <span style="color: #94a3b8">-</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-muted">
                                            <small>{{ job.created_at|date:"M d, H:i" }}</small>
                                        </td>
                                        <td>
                                            <a href="{% url 'scholar_app:bibtex_job_detail' job.id %}"
                                               class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-eye"></i> View
                                            </a>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            {% endif %}
            <!-- Gitea Repository Link -->
            {% if project.gitea_repo_url %}
                <div class="alert alert-info"
                     style="border-left: 4px solid var(--scitex-color-03)">
                    <h5>
                        <i class="fas fa-code-branch"></i> Version Control
                    </h5>
                    <p class="mb-2">Your enriched bibliography is version controlled in Gitea:</p>
                    <a href="{{ project.gitea_repo_url }}/src/branch/develop/references/references.bib"
                       target="_blank"
                       class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-external-link-alt"></i> View references.bib in Gitea
                    </a>
                </div>
            {% endif %}
        </div>
    </section>
{% endblock %}
