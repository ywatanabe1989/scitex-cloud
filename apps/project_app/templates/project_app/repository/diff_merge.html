{% extends 'global_base.html' %}
{% load static %}
{% block title %}
    Diff & Merge - {{ project.name }}
{% endblock %}
{% block extra_css %}
    <link rel="stylesheet"
          href="{% static 'project_app/css/project_app.css' %}" />
    <link rel="stylesheet"
          href="{% static 'project_app/css/shared/buttons.css' %}" />
    <link rel="stylesheet"
          href="{% static 'project_app/css/repository/commit_detail.css' %}" />
    <link rel="stylesheet"
          href="{% static 'project_app/css/repository/diff_merge.css' %}" />
{% endblock %}
{% block content %}
    <div class="container-fluid diff-merge-container">
        <!-- Breadcrumb Navigation -->
        <div class="breadcrumb-nav">
            <a href="/{{ project.owner.username }}/">{{ project.owner.username }}</a>
            <span class="breadcrumb-separator">/</span>
            <a href="/{{ project.owner.username }}/{{ project.slug }}/">{{ project.name }}</a>
            <span class="breadcrumb-separator">/</span>
            <span style="color: var(--color-fg-default)">diff & merge</span>
        </div>
        <!-- Page Header -->
        <div class="diff-merge-header">
            <h1 class="page-title">
                <svg width="24"
                     height="24"
                     viewBox="0 0 16 16"
                     fill="currentColor"
                     style="display: inline-block; vertical-align: text-bottom; margin-right: 0.5rem">
                    <path d="M8.75 1.75a.75.75 0 0 0-1.5 0v1.5h-2.5a.75.75 0 0 0 0 1.5h2.5v4h-2.5a.75.75 0 0 0 0 1.5h2.5v1.5a.75.75 0 0 0 1.5 0v-1.5h2.5a.75.75 0 0 0 0-1.5h-2.5v-4h2.5a.75.75 0 0 0 0-1.5h-2.5v-1.5Z">
                    </path>
                </svg>
                Diff & Merge
            </h1>
            <p class="page-description">Compare and merge files from your repository, uploads, or direct input</p>
        </div>
        <!-- Input Section -->
        <div class="diff-input-section">
            <!-- Left Side -->
            <div class="diff-input-panel left-panel">
                <div class="panel-header">
                    <h3>Left Side</h3>
                    <div class="panel-actions">
                        <button class="btn btn-sm" id="left-select-from-repo">
                            <svg width="16"
                                 height="16"
                                 viewBox="0 0 16 16"
                                 fill="currentColor">
                                <path d="M2 2.5A2.5 2.5 0 0 1 4.5 0h8.75a.75.75 0 0 1 .75.75v12.5a.75.75 0 0 1-.75.75h-2.5a.75.75 0 0 1 0-1.5h1.75v-2h-8a1 1 0 0 0-.714 1.7.75.75 0 1 1-1.072 1.05A2.495 2.495 0 0 1 2 11.5Zm10.5-1h-8a1 1 0 0 0-1 1v6.708A2.486 2.486 0 0 1 4.5 9h8ZM5 12.25a.25.25 0 0 1 .25-.25h3.5a.25.25 0 0 1 .25.25v3.25a.25.25 0 0 1-.4.2l-1.45-1.087a.249.249 0 0 0-.3 0L5.4 15.7a.25.25 0 0 1-.4-.2Z">
                                </path>
                            </svg>
                            From Repo
                        </button>
                        <button class="btn btn-sm" id="left-upload-file">
                            <svg width="16"
                                 height="16"
                                 viewBox="0 0 16 16"
                                 fill="currentColor">
                                <path d="M2.75 14A1.75 1.75 0 0 1 1 12.25v-2.5a.75.75 0 0 1 1.5 0v2.5c0 .138.112.25.25.25h10.5a.25.25 0 0 0 .25-.25v-2.5a.75.75 0 0 1 1.5 0v2.5A1.75 1.75 0 0 1 13.25 14Z"></path>
                                <path d="M11.78 4.72a.749.749 0 1 1-1.06 1.06L8.75 3.811V9.5a.75.75 0 0 1-1.5 0V3.811L5.28 5.78a.749.749 0 1 1-1.06-1.06l3.25-3.25a.749.749 0 0 1 1.06 0l3.25 3.25Z">
                                </path>
                            </svg>
                            Upload
                        </button>
                        <button class="btn btn-sm" id="left-clear">
                            <svg width="16"
                                 height="16"
                                 viewBox="0 0 16 16"
                                 fill="currentColor">
                                <path d="M11 1.75V3h2.25a.75.75 0 0 1 0 1.5H2.75a.75.75 0 0 1 0-1.5H5V1.75C5 .784 5.784 0 6.75 0h2.5C10.216 0 11 .784 11 1.75ZM4.496 6.675l.66 6.6a.25.25 0 0 0 .249.225h5.19a.25.25 0 0 0 .249-.225l.66-6.6a.75.75 0 0 1 1.492.149l-.66 6.6A1.748 1.748 0 0 1 10.595 15h-5.19a1.75 1.75 0 0 1-1.741-1.575l-.66-6.6a.75.75 0 1 1 1.492-.15ZM6.5 1.75V3h3V1.75a.25.25 0 0 0-.25-.25h-2.5a.25.25 0 0 0-.25.25Z">
                                </path>
                            </svg>
                            Clear
                        </button>
                    </div>
                </div>
                <div class="drop-zone" id="left-drop-zone">
                    <div class="drop-zone-placeholder">
                        <svg width="48"
                             height="48"
                             viewBox="0 0 16 16"
                             fill="currentColor"
                             style="opacity: 0.3">
                            <path d="M2.75 14A1.75 1.75 0 0 1 1 12.25v-2.5a.75.75 0 0 1 1.5 0v2.5c0 .138.112.25.25.25h10.5a.25.25 0 0 0 .25-.25v-2.5a.75.75 0 0 1 1.5 0v2.5A1.75 1.75 0 0 1 13.25 14Z"></path>
                            <path d="M11.78 4.72a.749.749 0 1 1-1.06 1.06L8.75 3.811V9.5a.75.75 0 0 1-1.5 0V3.811L5.28 5.78a.749.749 0 1 1-1.06-1.06l3.25-3.25a.749.749 0 0 1 1.06 0l3.25 3.25Z">
                            </path>
                        </svg>
                        <p>Drop file here, or click to upload</p>
                    </div>
                    <textarea class="content-editor"
                              id="left-content"
                              placeholder="Paste or type content here..."></textarea>
                </div>
                <div class="file-info" id="left-file-info" style="display: none;">
                    <span class="filename"></span>
                    <span class="filesize"></span>
                </div>
                <input type="file" id="left-file-input" style="display: none;" />
            </div>
            <!-- Right Side -->
            <div class="diff-input-panel right-panel">
                <div class="panel-header">
                    <h3>Right Side</h3>
                    <div class="panel-actions">
                        <button class="btn btn-sm" id="right-select-from-repo">
                            <svg width="16"
                                 height="16"
                                 viewBox="0 0 16 16"
                                 fill="currentColor">
                                <path d="M2 2.5A2.5 2.5 0 0 1 4.5 0h8.75a.75.75 0 0 1 .75.75v12.5a.75.75 0 0 1-.75.75h-2.5a.75.75 0 0 1 0-1.5h1.75v-2h-8a1 1 0 0 0-.714 1.7.75.75 0 1 1-1.072 1.05A2.495 2.495 0 0 1 2 11.5Zm10.5-1h-8a1 1 0 0 0-1 1v6.708A2.486 2.486 0 0 1 4.5 9h8ZM5 12.25a.25.25 0 0 1 .25-.25h3.5a.25.25 0 0 1 .25.25v3.25a.25.25 0 0 1-.4.2l-1.45-1.087a.249.249 0 0 0-.3 0L5.4 15.7a.25.25 0 0 1-.4-.2Z">
                                </path>
                            </svg>
                            From Repo
                        </button>
                        <button class="btn btn-sm" id="right-upload-file">
                            <svg width="16"
                                 height="16"
                                 viewBox="0 0 16 16"
                                 fill="currentColor">
                                <path d="M2.75 14A1.75 1.75 0 0 1 1 12.25v-2.5a.75.75 0 0 1 1.5 0v2.5c0 .138.112.25.25.25h10.5a.25.25 0 0 0 .25-.25v-2.5a.75.75 0 0 1 1.5 0v2.5A1.75 1.75 0 0 1 13.25 14Z"></path>
                                <path d="M11.78 4.72a.749.749 0 1 1-1.06 1.06L8.75 3.811V9.5a.75.75 0 0 1-1.5 0V3.811L5.28 5.78a.749.749 0 1 1-1.06-1.06l3.25-3.25a.749.749 0 0 1 1.06 0l3.25 3.25Z">
                                </path>
                            </svg>
                            Upload
                        </button>
                        <button class="btn btn-sm" id="right-clear">
                            <svg width="16"
                                 height="16"
                                 viewBox="0 0 16 16"
                                 fill="currentColor">
                                <path d="M11 1.75V3h2.25a.75.75 0 0 1 0 1.5H2.75a.75.75 0 0 1 0-1.5H5V1.75C5 .784 5.784 0 6.75 0h2.5C10.216 0 11 .784 11 1.75ZM4.496 6.675l.66 6.6a.25.25 0 0 0 .249.225h5.19a.25.25 0 0 0 .249-.225l.66-6.6a.75.75 0 0 1 1.492.149l-.66 6.6A1.748 1.748 0 0 1 10.595 15h-5.19a1.75 1.75 0 0 1-1.741-1.575l-.66-6.6a.75.75 0 1 1 1.492-.15ZM6.5 1.75V3h3V1.75a.25.25 0 0 0-.25-.25h-2.5a.25.25 0 0 0-.25.25Z">
                                </path>
                            </svg>
                            Clear
                        </button>
                    </div>
                </div>
                <div class="drop-zone" id="right-drop-zone">
                    <div class="drop-zone-placeholder">
                        <svg width="48"
                             height="48"
                             viewBox="0 0 16 16"
                             fill="currentColor"
                             style="opacity: 0.3">
                            <path d="M2.75 14A1.75 1.75 0 0 1 1 12.25v-2.5a.75.75 0 0 1 1.5 0v2.5c0 .138.112.25.25.25h10.5a.25.25 0 0 0 .25-.25v-2.5a.75.75 0 0 1 1.5 0v2.5A1.75 1.75 0 0 1 13.25 14Z"></path>
                            <path d="M11.78 4.72a.749.749 0 1 1-1.06 1.06L8.75 3.811V9.5a.75.75 0 0 1-1.5 0V3.811L5.28 5.78a.749.749 0 1 1-1.06-1.06l3.25-3.25a.749.749 0 0 1 1.06 0l3.25 3.25Z">
                            </path>
                        </svg>
                        <p>Drop file here, or click to upload</p>
                    </div>
                    <textarea class="content-editor"
                              id="right-content"
                              placeholder="Paste or type content here..."></textarea>
                </div>
                <div class="file-info" id="right-file-info" style="display: none;">
                    <span class="filename"></span>
                    <span class="filesize"></span>
                </div>
                <input type="file" id="right-file-input" style="display: none;" />
            </div>
        </div>
        <!-- Action Buttons -->
        <div class="diff-actions">
            <button class="btn btn-primary" id="compute-diff">
                <svg width="16"
                     height="16"
                     viewBox="0 0 16 16"
                     fill="currentColor"
                     style="margin-right: 0.5rem">
                    <path d="M8.75 1.75a.75.75 0 0 0-1.5 0v1.5h-2.5a.75.75 0 0 0 0 1.5h2.5v4h-2.5a.75.75 0 0 0 0 1.5h2.5v1.5a.75.75 0 0 0 1.5 0v-1.5h2.5a.75.75 0 0 0 0-1.5h-2.5v-4h2.5a.75.75 0 0 0 0-1.5h-2.5v-1.5Z">
                    </path>
                </svg>
                Compute Diff
            </button>
            <button class="btn" id="merge-left" style="display: none;">
                <svg width="16"
                     height="16"
                     viewBox="0 0 16 16"
                     fill="currentColor"
                     style="margin-right: 0.5rem">
                    <path d="M9.78 12.78a.75.75 0 0 1-1.06 0L4.47 8.53a.75.75 0 0 1 0-1.06l4.25-4.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042L6.06 8l3.72 3.72a.75.75 0 0 1 0 1.06Z">
                    </path>
                </svg>
                Use Left
            </button>
            <button class="btn" id="merge-right" style="display: none;">
                Use Right
                <svg width="16"
                     height="16"
                     viewBox="0 0 16 16"
                     fill="currentColor"
                     style="margin-left: 0.5rem">
                    <path d="M6.22 3.22a.75.75 0 0 1 1.06 0l4.25 4.25a.75.75 0 0 1 0 1.06l-4.25 4.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042L9.94 8 6.22 4.28a.75.75 0 0 1 0-1.06Z">
                    </path>
                </svg>
            </button>
            <button class="btn" id="merge-manual" style="display: none;">
                <svg width="16"
                     height="16"
                     viewBox="0 0 16 16"
                     fill="currentColor"
                     style="margin-right: 0.5rem">
                    <path d="M1.5 3.25a2.25 2.25 0 1 1 3 2.122v5.256a2.251 2.251 0 1 1-1.5 0V5.372A2.25 2.25 0 0 1 1.5 3.25Zm5.677-.177L9.573.677A.25.25 0 0 1 10 .854V2.5h1A2.5 2.5 0 0 1 13.5 5v5.628a2.251 2.251 0 1 1-1.5 0V5a1 1 0 0 0-1-1h-1v1.646a.25.25 0 0 1-.427.177L7.177 3.427a.25.25 0 0 1 0-.354ZM3.75 2.5a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5Zm0 9.5a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5Zm8.25.75a.75.75 0 1 0 1.5 0 .75.75 0 0 0-1.5 0Z">
                    </path>
                </svg>
                Merge with Conflicts
            </button>
            <button class="btn" id="download-merged" style="display: none;">
                <svg width="16"
                     height="16"
                     viewBox="0 0 16 16"
                     fill="currentColor"
                     style="margin-right: 0.5rem">
                    <path d="M2.75 14A1.75 1.75 0 0 1 1 12.25v-2.5a.75.75 0 0 1 1.5 0v2.5c0 .138.112.25.25.25h10.5a.25.25 0 0 0 .25-.25v-2.5a.75.75 0 0 1 1.5 0v2.5A1.75 1.75 0 0 1 13.25 14Z"></path>
                    <path d="M7.25 7.689V2a.75.75 0 0 1 1.5 0v5.689l1.97-1.969a.749.749 0 1 1 1.06 1.06l-3.25 3.25a.749.749 0 0 1-1.06 0L4.22 6.78a.749.749 0 1 1 1.06-1.06l1.97 1.969Z">
                    </path>
                </svg>
                Download
            </button>
        </div>
        <!-- Results Section -->
        <div id="diff-results" style="display: none;">
            <!-- Statistics -->
            <div class="file-changes-summary">
                <div class="file-count">Comparison Results</div>
                <div class="changes-stats">
                    <span class="additions" id="stats-additions">+0 additions</span>
                    <span class="deletions" id="stats-deletions">-0 deletions</span>
                </div>
            </div>
            <!-- Diff Display -->
            <div class="file-diff">
                <div class="file-diff-header">
                    <div class="file-path" id="diff-header-text">Unified Diff</div>
                </div>
                <div class="file-diff-body">
                    <table class="diff-table">
                        <tbody id="diff-table-body">
                            <!-- Diff lines will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- Merge Results Section -->
        <div id="merge-results" style="display: none;">
            <div class="file-diff">
                <div class="file-diff-header">
                    <div class="file-path">Merged Content</div>
                    <button class="btn btn-sm" id="copy-merged">
                        <svg width="16"
                             height="16"
                             viewBox="0 0 16 16"
                             fill="currentColor">
                            <path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path>
                            <path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z">
                            </path>
                        </svg>
                        Copy
                    </button>
                </div>
                <div class="file-diff-body">
                    <pre id="merged-content-display"></pre>
                </div>
            </div>
        </div>
    </div>
    <!-- File Browser Modal (for selecting from repo) -->
    <div id="file-browser-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Select File from Repository</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="file-browser-tree">
                    <!-- File tree will be loaded here -->
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block extra_js %}
    <script src="{% static 'project_app/js/components/DiffMerge.js' %}"></script>
    <script>
    // Initialize DiffMerge component
    document.addEventListener('DOMContentLoaded', function() {
        const diffMerge = new DiffMerge({
            username: '{{ project.owner.username }}',
            slug: '{{ project.slug }}',
            apiBaseUrl: '/{{ project.owner.username }}/{{ project.slug }}/'
        });
    });
    </script>
{% endblock %}
