{% extends 'base.html' %}
{% load static %}

{% block title %}Create Project - SciTeX Cloud{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/common/buttons.css' %}">
<style>
.create-form {
    background: white;
    border: 1px solid #e5e5e5;
    border-radius: 8px;
    padding: 2rem;
    max-width: 800px;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
}

.form-control {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 1rem;
}

.form-control:focus {
    outline: none;
    border-color: #007acc;
    box-shadow: 0 0 0 2px rgba(0, 122, 204, 0.25);
}

textarea.form-control {
    resize: vertical;
    min-height: 120px;
}

.breadcrumb {
    margin-bottom: 1.5rem;
}

.breadcrumb a {
    color: #007acc;
    text-decoration: none;
}

.breadcrumb a:hover {
    text-decoration: underline;
}

.form-actions {
    display: flex;
    gap: 1rem;
    margin-top: 2rem;
}

.help-text {
    font-size: 0.85rem;
    color: #666;
    margin-top: 0.25rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Breadcrumb -->
    <nav class="breadcrumb">
        <a href="/{{ user.username }}/projects/">Projects</a> / Create New Project
    </nav>

    <h1>Create New Repository</h1>

    <div class="create-form">
        <form method="post">
            {% csrf_token %}

            <div class="form-group">
                <label for="name">Repository Name *</label>
                <input type="text" class="form-control" id="name" name="name" required
                       placeholder="my-research-project" autocomplete="off">
                <div id="name-availability" style="margin-top: 0.5rem; font-size: 0.9rem; display: none;">
                    <span id="availability-icon"></span>
                    <span id="availability-message"></span>
                </div>
                <div class="help-text">Choose a clear name (lowercase, hyphens for spaces).</div>
            </div>

            <div class="form-group">
                <label for="description">Description (Optional)</label>
                <textarea class="form-control" id="description" name="description" rows="2"
                          placeholder="Brief description..."></textarea>
            </div>

            <div class="form-group">
                <label style="display: block; margin-bottom: 0.75rem; font-weight: 500;">
                    Initialize Repository
                </label>

                <!-- Radio buttons for initialization options -->
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <!-- Option 1: Create new -->
                    <div style="display: flex; align-items: start; gap: 0.75rem;">
                        <input type="radio" id="init_gitea" name="init_type" value="gitea" checked
                               style="margin-top: 0.25rem; width: 18px; height: 18px; cursor: pointer;">
                        <div style="flex: 1;">
                            <label for="init_gitea" style="margin-bottom: 0.25rem; cursor: pointer; font-weight: 500;">
                                Create new
                            </label>
                            <div class="help-text">
                                Start with an empty repository
                            </div>
                        </div>
                    </div>

                    <!-- Option 2: Import existing -->
                    <div style="display: flex; align-items: start; gap: 0.75rem;">
                        <input type="radio" id="init_github" name="init_type" value="github"
                               style="margin-top: 0.25rem; width: 18px; height: 18px; cursor: pointer;">
                        <div style="flex: 1;">
                            <label for="init_github" style="margin-bottom: 0.25rem; cursor: pointer; font-weight: 500;">
                                Import from GitHub/GitLab
                            </label>
                            <div class="help-text">
                                Bring your existing repository into SciTeX
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Import URL Input -->
                <div id="github_url_input" style="display: none; margin-top: 1rem; margin-left: 2.25rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.95rem;">
                        Repository URL
                    </label>
                    <input type="text" name="git_url" id="github_url" class="form-control"
                           placeholder="https://github.com/username/repository or git@github.com:username/repo.git"
                           style="max-width: 600px;">
                    <div class="help-text" style="margin-top: 0.5rem;">
                        Both formats supported:<br>
                        â€¢ HTTPS: <code>https://github.com/username/repo</code><br>
                        â€¢ SSH: <code>git@github.com:username/repo.git</code>
                    </div>

                    <label style="display: block; margin: 0.75rem 0 0.5rem 0; font-weight: 500; font-size: 0.95rem;">
                        Access Token (Optional - for private repos)
                    </label>
                    <input type="password" name="github_token" id="github_token" class="form-control"
                           placeholder="Leave empty to use saved token from profile settings"
                           style="max-width: 600px;">
                    <div class="help-text" style="margin-top: 0.5rem;">
                        {% if user.profile.github_token %}
                            âœ… Using saved token from <a href="{% url 'profile_app:profile_edit' %}">profile settings</a>
                        {% else %}
                            ðŸ’¡ <a href="{% url 'profile_app:profile_edit' %}">Save token in profile</a> to avoid entering it each time<br>
                        {% endif %}
                        Create token:
                        <a href="https://github.com/settings/tokens" target="_blank">GitHub</a> |
                        <a href="https://gitlab.com/-/profile/personal_access_tokens" target="_blank">GitLab</a>
                    </div>
                </div>

                <!-- Git URL Input (for Git cloning) -->
                <div id="git_url_input" style="display: none; margin-top: 1rem; margin-left: 2.25rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.95rem;">
                        Repository URL
                    </label>
                    <input type="text" name="git_url" id="git_url" class="form-control"
                           placeholder="https://github.com/username/repository.git or git@github.com:username/repository.git"
                           style="max-width: 600px;">
                    <div class="help-text" style="margin-top: 0.5rem;">
                        Enter the repository URL in HTTPS or SSH format:
                        <br>â€¢ HTTPS: <code style="font-size: 0.85rem;">https://github.com/user/repo.git</code>
                        <br>â€¢ SSH: <code style="font-size: 0.85rem;">git@github.com:user/repo.git</code> (requires <a href="/profile/settings/ssh-keys/" target="_blank">SSH key setup</a>)
                    </div>
                </div>

                <!-- Template Type Selector (hidden by default) -->
                <div id="template_type_selector" style="display: none; margin-top: 1rem; margin-left: 2.25rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.95rem;">
                        Template Type
                    </label>
                    <select name="template_type" class="form-control" style="max-width: 600px;" id="template_select">
                        {% for template in available_templates %}
                        <option value="{{ template.id }}" {% if forloop.first %}selected{% endif %}>
                            {{ template.name }} - {{ template.description }}
                        </option>
                        {% endfor %}
                    </select>
                    <div class="help-text" style="margin-top: 0.5rem;" id="template_info">
                        Select the type of template that best fits your project needs.
                    </div>

                    <!-- Template details (shown when hovering/selecting) -->
                    {% for template in available_templates %}
                    <div class="template-details" data-template-id="{{ template.id }}" style="display: none; margin-top: 0.75rem; padding: 1rem; background: #f8f9fa; border-radius: 4px; border-left: 3px solid #007acc;">
                        <div style="font-weight: 500; margin-bottom: 0.5rem;">{{ template.name }}</div>
                        <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.75rem;">{{ template.use_case }}</div>
                        <div style="font-size: 0.85rem; color: #666;">
                            <strong>Features:</strong>
                            <ul style="margin: 0.5rem 0 0 1.5rem; padding: 0;">
                                {% for feature in template.features %}
                                <li>{{ feature }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        <div style="margin-top: 0.5rem; font-size: 0.85rem;">
                            <a href="{{ template.github_url }}" target="_blank" style="color: #007acc;">
                                View template on GitHub â†’
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <script>
                // Handle initialization type selection
                const initTypeRadios = document.querySelectorAll('input[name="init_type"]');
                const templateSelector = document.getElementById('template_type_selector');
                const gitUrlInput = document.getElementById('git_url_input');
                const gitUrlField = document.getElementById('git_url');

                const githubUrlInput = document.getElementById('github_url_input');
                const githubUrlField = document.getElementById('github_url');

                // Helper function to extract repo name from URL
                function extractRepoNameFromUrl(url) {
                    if (!url) return '';
                    url = url.trim();
                    // Remove .git suffix
                    if (url.endsWith('.git')) {
                        url = url.slice(0, -4);
                    }
                    // Extract last part of path
                    const parts = url.replace(/\/$/, '').split('/');
                    return parts[parts.length - 1] || '';
                }

                // Auto-fill name from Git URL
                if (githubUrlField) {
                    githubUrlField.addEventListener('blur', function() {
                        const url = this.value.trim();
                        if (url && !nameInput.value.trim()) {
                            const repoName = extractRepoNameFromUrl(url);
                            if (repoName) {
                                nameInput.value = repoName;
                                nameInput.dispatchEvent(new Event('input'));
                            }
                        }
                    });
                }

                initTypeRadios.forEach(radio => {
                    radio.addEventListener('change', function() {
                        // Hide all conditional fields
                        if (githubUrlInput) githubUrlInput.style.display = 'none';

                        // Show import fields only for GitHub import
                        if (this.value === 'github') {
                            if (githubUrlInput) {
                                githubUrlInput.style.display = 'block';
                                githubUrlField.setAttribute('required', 'required');
                            }
                        } else {
                            // Create new: no extra fields needed
                            if (githubUrlField) githubUrlField.removeAttribute('required');
                        }
                    });
                });

                // Real-time name availability checking
                let nameCheckTimeout;
                const nameInput = document.getElementById('name');
                const availabilityDiv = document.getElementById('name-availability');
                const availabilityIcon = document.getElementById('availability-icon');
                const availabilityMessage = document.getElementById('availability-message');

                nameInput?.addEventListener('input', function() {
                    const name = this.value.trim();

                    // Clear previous timeout
                    clearTimeout(nameCheckTimeout);

                    // Hide availability if empty
                    if (!name) {
                        availabilityDiv.style.display = 'none';
                        return;
                    }

                    // Show checking state
                    availabilityDiv.style.display = 'block';
                    availabilityIcon.textContent = 'â³';
                    availabilityMessage.textContent = ' Checking availability...';
                    availabilityMessage.style.color = '#666';

                    // Debounce: wait 500ms after user stops typing
                    nameCheckTimeout = setTimeout(async () => {
                        try {
                            const response = await fetch(`/project/api/check-name/?name=${encodeURIComponent(name)}`);
                            const data = await response.json();

                            if (data.available) {
                                availabilityIcon.textContent = 'âœ“';
                                availabilityMessage.textContent = ' ' + data.message;
                                availabilityMessage.style.color = '#28a745';
                            } else {
                                availabilityIcon.textContent = 'âœ—';
                                availabilityMessage.textContent = ' ' + data.message;
                                availabilityMessage.style.color = '#dc3545';
                            }
                        } catch (error) {
                            console.error('Error checking name availability:', error);
                            availabilityDiv.style.display = 'none';
                        }
                    }, 500);
                });

                // Show template details on selection change
                document.getElementById('template_select')?.addEventListener('change', function() {
                    // Hide all template details
                    document.querySelectorAll('.template-details').forEach(el => el.style.display = 'none');
                    // Show selected template details
                    const selectedId = this.value;
                    const detailsEl = document.querySelector(`.template-details[data-template-id="${selectedId}"]`);
                    if (detailsEl) {
                        detailsEl.style.display = 'block';
                    }
                });

                // Show first template details by default when checkbox is checked
                document.getElementById('initialize_template')?.addEventListener('change', function() {
                    if (this.checked && document.getElementById('template_select')) {
                        const firstTemplateId = document.getElementById('template_select').value;
                        const detailsEl = document.querySelector(`.template-details[data-template-id="${firstTemplateId}"]`);
                        if (detailsEl) {
                            detailsEl.style.display = 'block';
                        }
                    }
                });
                </script>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary">Create Repository</button>
                <a href="/{{ user.username }}/projects/" class="btn btn-secondary">Cancel</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}