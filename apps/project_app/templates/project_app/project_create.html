{% extends 'base.html' %}
{% load static %}

{% block title %}Create Project - SciTeX Cloud{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/common.css' %}">
<style>
/* Container centering */
.create-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 2rem 1rem;
}

/* Form card */
.create-form {
    background: var(--bg-page);
    border: 2px solid var(--border-default);
    border-radius: 8px;
    padding: 2rem;
}

[data-theme="dark"] .create-form {
    background: var(--bg-surface);
    border-color: var(--border-default);
}

/* Textarea sizing */
textarea.form-control {
    resize: vertical;
    min-height: 120px;
}

/* Breadcrumb */
.breadcrumb {
    margin-bottom: 1.5rem;
    color: var(--text-secondary);
}

.breadcrumb a {
    color: var(--scitex-color-04);
    text-decoration: none;
}

.breadcrumb a:hover {
    text-decoration: underline;
    color: var(--scitex-color-03);
}

/* Form actions */
.form-actions {
    display: flex;
    gap: 1rem;
    margin-top: 2rem;
}

/* Help text */
.help-text {
    font-size: 0.875rem;
    color: var(--text-secondary);
    margin-top: 0.25rem;
}

[data-theme="dark"] .help-text {
    color: var(--scitex-color-05);
}

/* Page title */
h1 {
    color: var(--text-primary);
    margin-bottom: 1.5rem;
}

/* Code tags in help text */
.help-text code {
    background: var(--bg-surface);
    padding: 0.2rem 0.4rem;
    border-radius: 3px;
    font-size: 0.85rem;
    color: var(--scitex-color-04);
}

[data-theme="dark"] .help-text code {
    background: var(--scitex-color-01);
    color: var(--scitex-color-05);
}

/* Availability message colors */
#name-availability {
    font-size: 0.9rem;
}
</style>
{% endblock %}

{% block content %}
<div class="create-container">
    <!-- Breadcrumb -->
    <nav class="breadcrumb">
        <a href="/{{ user.username }}/projects/">Projects</a> / Create New Project
    </nav>

    <h1>Create New Repository</h1>

    <div class="create-form">
        <form method="post">
            {% csrf_token %}

            <div class="form-group">
                <label class="form-label" for="name">Repository Name *</label>
                <input type="text" class="form-control" id="name" name="name" required
                       placeholder="my-research-project"
                       autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       spellcheck="false"
                       data-form-type="other"
                       data-lpignore="true"
                       role="presentation">
                <div id="name-availability" style="margin-top: 0.5rem; display: none;">
                    <span id="availability-icon"></span>
                    <span id="availability-message"></span>
                </div>
                <div class="help-text">Choose a clear name (lowercase, hyphens for spaces).</div>
            </div>

            <div class="form-group">
                <label class="form-label" for="description">Description (Optional)</label>
                <textarea class="form-control" id="description" name="description" rows="2"
                          placeholder="Brief description..."></textarea>
            </div>

            <div class="form-group">
                <label class="form-label" style="display: block; margin-bottom: 0.75rem;">
                    Initialize Repository
                </label>

                <!-- Radio buttons for initialization options -->
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <!-- Option 1: Create new -->
                    <div style="display: flex; align-items: start; gap: 0.75rem;">
                        <input type="radio" id="init_gitea" name="init_type" value="gitea" checked
                               style="margin-top: 0.25rem; width: 18px; height: 18px; cursor: pointer;">
                        <div style="flex: 1;">
                            <label for="init_gitea" style="margin-bottom: 0.25rem; cursor: pointer; font-weight: 500;">
                                Create new
                            </label>
                            <div class="help-text">
                                Start with an empty repository
                            </div>
                        </div>
                    </div>

                    <!-- Option 2: Import existing -->
                    <div style="display: flex; align-items: start; gap: 0.75rem;">
                        <input type="radio" id="init_github" name="init_type" value="github"
                               style="margin-top: 0.25rem; width: 18px; height: 18px; cursor: pointer;">
                        <div style="flex: 1;">
                            <label for="init_github" style="margin-bottom: 0.25rem; cursor: pointer; font-weight: 500;">
                                Import from GitHub/GitLab
                            </label>
                            <div class="help-text">
                                Bring your existing repository into SciTeX
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Import URL Input -->
                <div id="github_url_input" style="display: none; margin-top: 1rem; margin-left: 2.25rem;">
                    <label class="form-label" for="github_url">
                        Repository URL
                    </label>
                    <input type="text" name="git_url" id="github_url" class="form-control"
                           placeholder="https://github.com/username/repository or git@github.com:username/repo.git"
                           style="max-width: 600px;">
                    <div class="help-text" style="margin-top: 0.5rem;">
                        Both formats supported:<br>
                        â€¢ HTTPS: <code>https://github.com/username/repo</code><br>
                        â€¢ SSH: <code>git@github.com:username/repo.git</code>
                    </div>

                    <label class="form-label" for="github_token" style="margin-top: 0.75rem;">
                        Access Token (Optional - for private repos)
                    </label>
                    <input type="password" name="github_token" id="github_token" class="form-control"
                           placeholder="Leave empty to use saved token from profile settings"
                           style="max-width: 600px;">
                    <div class="help-text" style="margin-top: 0.5rem;">
                        {% if user.profile.github_token %}
                            âœ… Using saved token from <a href="{% url 'accounts_app:profile_edit' %}">profile settings</a>
                        {% else %}
                            ðŸ’¡ <a href="{% url 'accounts_app:profile_edit' %}">Save token in profile</a> to avoid entering it each time<br>
                        {% endif %}
                        Create token:
                        <a href="https://github.com/settings/tokens" target="_blank">GitHub</a> |
                        <a href="https://gitlab.com/-/profile/personal_access_tokens" target="_blank">GitLab</a>
                    </div>
                </div>

                <!-- Git URL Input (for Git cloning) -->
                <div id="git_url_input" style="display: none; margin-top: 1rem; margin-left: 2.25rem;">
                    <label class="form-label" for="git_url">
                        Repository URL
                    </label>
                    <input type="text" name="git_url" id="git_url" class="form-control"
                           placeholder="https://github.com/username/repository.git or git@github.com:username/repository.git"
                           style="max-width: 600px;">
                    <div class="help-text" style="margin-top: 0.5rem;">
                        Enter the repository URL in HTTPS or SSH format:
                        <br>â€¢ HTTPS: <code>https://github.com/user/repo.git</code>
                        <br>â€¢ SSH: <code>git@github.com:user/repo.git</code> (requires <a href="/profile/settings/ssh-keys/" target="_blank">SSH key setup</a>)
                    </div>
                </div>

                <!-- Template Type Selector (hidden by default) -->
                <div id="template_type_selector" style="display: none; margin-top: 1rem; margin-left: 2.25rem;">
                    <label class="form-label" for="template_select">
                        Template Type
                    </label>
                    <select name="template_type" class="form-control" style="max-width: 600px;" id="template_select">
                        {% for template in available_templates %}
                        <option value="{{ template.id }}" {% if forloop.first %}selected{% endif %}>
                            {{ template.name }} - {{ template.description }}
                        </option>
                        {% endfor %}
                    </select>
                    <div class="help-text" style="margin-top: 0.5rem;" id="template_info">
                        Select the type of template that best fits your project needs.
                    </div>

                    <!-- Template details (shown when hovering/selecting) -->
                    {% for template in available_templates %}
                    <div class="template-details" data-template-id="{{ template.id }}" style="display: none; margin-top: 0.75rem; padding: 1rem; background: #f8f9fa; border-radius: 4px; border-left: 3px solid #007acc;">
                        <div style="font-weight: 500; margin-bottom: 0.5rem;">{{ template.name }}</div>
                        <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.75rem;">{{ template.use_case }}</div>
                        <div style="font-size: 0.85rem; color: #666;">
                            <strong>Features:</strong>
                            <ul style="margin: 0.5rem 0 0 1.5rem; padding: 0;">
                                {% for feature in template.features %}
                                <li>{{ feature }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        <div style="margin-top: 0.5rem; font-size: 0.85rem;">
                            <a href="{{ template.github_url }}" target="_blank" style="color: #007acc;">
                                View template on GitHub â†’
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <script>
                // Handle initialization type selection
                const initTypeRadios = document.querySelectorAll('input[name="init_type"]');
                const templateSelector = document.getElementById('template_type_selector');
                const gitUrlInput = document.getElementById('git_url_input');
                const gitUrlField = document.getElementById('git_url');

                const githubUrlInput = document.getElementById('github_url_input');
                const githubUrlField = document.getElementById('github_url');

                // Helper function to extract repo name from URL
                function extractRepoNameFromUrl(url) {
                    if (!url) return '';
                    url = url.trim();
                    // Remove .git suffix
                    if (url.endsWith('.git')) {
                        url = url.slice(0, -4);
                    }
                    // Extract last part of path
                    const parts = url.replace(/\/$/, '').split('/');
                    return parts[parts.length - 1] || '';
                }

                // Auto-fill name from Git URL
                if (githubUrlField) {
                    githubUrlField.addEventListener('blur', function() {
                        const url = this.value.trim();
                        if (url && !nameInput.value.trim()) {
                            const repoName = extractRepoNameFromUrl(url);
                            if (repoName) {
                                nameInput.value = repoName;
                                nameInput.dispatchEvent(new Event('input'));
                            }
                        }
                    });
                }

                initTypeRadios.forEach(radio => {
                    radio.addEventListener('change', function() {
                        // Hide all conditional fields
                        if (githubUrlInput) githubUrlInput.style.display = 'none';

                        // Show import fields only for GitHub import
                        if (this.value === 'github') {
                            if (githubUrlInput) {
                                githubUrlInput.style.display = 'block';
                                githubUrlField.setAttribute('required', 'required');
                            }
                        } else {
                            // Create new: no extra fields needed
                            if (githubUrlField) githubUrlField.removeAttribute('required');
                        }
                    });
                });

                // Real-time name availability checking
                let nameCheckTimeout;
                let isNameAvailable = false;  // Track availability state
                const nameInput = document.getElementById('name');
                const availabilityDiv = document.getElementById('name-availability');
                const availabilityIcon = document.getElementById('availability-icon');
                const availabilityMessage = document.getElementById('availability-message');
                const form = document.querySelector('form');
                const submitButton = document.querySelector('.btn-primary');

                // Prevent form submission if name is not available
                form?.addEventListener('submit', function(e) {
                    const name = nameInput?.value.trim();
                    if (!name) {
                        e.preventDefault();
                        alert('Please enter a project name');
                        return false;
                    }
                    if (!isNameAvailable) {
                        e.preventDefault();
                        alert('Please choose an available project name. The current name is already taken or invalid.');
                        return false;
                    }
                });

                nameInput?.addEventListener('input', function() {
                    const name = this.value.trim();

                    // Clear previous timeout
                    clearTimeout(nameCheckTimeout);

                    // Hide availability if empty
                    if (!name) {
                        availabilityDiv.style.display = 'none';
                        isNameAvailable = false;
                        if (submitButton) {
                            submitButton.disabled = true;
                            submitButton.style.opacity = '0.5';
                            submitButton.style.cursor = 'not-allowed';
                        }
                        return;
                    }

                    // While typing, disable submit button
                    isNameAvailable = false;
                    if (submitButton) {
                        submitButton.disabled = true;
                        submitButton.style.opacity = '0.5';
                        submitButton.style.cursor = 'not-allowed';
                    }


                    // Show checking state
                    availabilityDiv.style.display = 'block';
                    availabilityIcon.textContent = 'â³';
                    availabilityMessage.textContent = ' Checking availability...';
                    availabilityMessage.style.color = '#666';

                    // Debounce: wait 500ms after user stops typing
                    nameCheckTimeout = setTimeout(async () => {
                        try {
                            const response = await fetch(`/project/api/check-name/?name=${encodeURIComponent(name)}`);
                            const data = await response.json();

                            if (data.available) {
                                isNameAvailable = true;
                                availabilityIcon.textContent = 'âœ“';
                                availabilityMessage.textContent = ' ' + data.message;
                                availabilityMessage.style.color = '#28a745';
                                // Re-enable submit button
                                if (submitButton) {
                                    submitButton.disabled = false;
                                    submitButton.style.opacity = '1';
                                    submitButton.style.cursor = 'pointer';
                                }
                            } else {
                                isNameAvailable = false;
                                availabilityIcon.textContent = 'âœ—';
                                availabilityMessage.textContent = ' ' + data.message;
                                availabilityMessage.style.color = '#dc3545';
                                // Disable submit button
                                if (submitButton) {
                                    submitButton.disabled = true;
                                    submitButton.style.opacity = '0.5';
                                    submitButton.style.cursor = 'not-allowed';
                                }
                            }
                        } catch (error) {
                            console.error('Error checking name availability:', error);
                            availabilityDiv.style.display = 'none';
                        }
                    }, 500);
                });

                // Show template details on selection change
                document.getElementById('template_select')?.addEventListener('change', function() {
                    // Hide all template details
                    document.querySelectorAll('.template-details').forEach(el => el.style.display = 'none');
                    // Show selected template details
                    const selectedId = this.value;
                    const detailsEl = document.querySelector(`.template-details[data-template-id="${selectedId}"]`);
                    if (detailsEl) {
                        detailsEl.style.display = 'block';
                    }
                });

                // Show first template details by default when checkbox is checked
                document.getElementById('initialize_template')?.addEventListener('change', function() {
                    if (this.checked && document.getElementById('template_select')) {
                        const firstTemplateId = document.getElementById('template_select').value;
                        const detailsEl = document.querySelector(`.template-details[data-template-id="${firstTemplateId}"]`);
                        if (detailsEl) {
                            detailsEl.style.display = 'block';
                        }
                    }
                });

                // Aggressive autofill prevention for repository name field
                // Multiple strategies to prevent username from autofilling into repo name
                (function() {
                    const nameInput = document.getElementById('name');
                    if (nameInput) {
                        // Strategy 1: Make it readonly initially (browsers don't autofill readonly fields)
                        nameInput.setAttribute('readonly', 'readonly');

                        // Strategy 2: Clear any autofilled value immediately
                        const clearAutofill = function() {
                            // Check if the field was autofilled (common indicator: the value matches username)
                            // We clear it to prevent unwanted autofill
                            if (nameInput.value && nameInput.matches(':-webkit-autofill')) {
                                nameInput.value = '';
                            }
                        };

                        // Run clear check multiple times as browsers autofill at different moments
                        setTimeout(clearAutofill, 50);
                        setTimeout(clearAutofill, 100);
                        setTimeout(clearAutofill, 200);

                        // Strategy 3: Remove readonly when user interacts
                        nameInput.addEventListener('focus', function() {
                            nameInput.removeAttribute('readonly');
                        }, { once: true });

                        nameInput.addEventListener('click', function() {
                            nameInput.removeAttribute('readonly');
                        }, { once: true });

                        // Strategy 4: Also remove readonly after delay to allow interaction
                        setTimeout(function() {
                            nameInput.removeAttribute('readonly');
                        }, 500);
                    }
                })();
                </script>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary">Create Repository</button>
                <a href="/{{ user.username }}/projects/" class="btn btn-secondary">Cancel</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}