{% extends "base.html" %}
{% load static %}

{% block title %}{{ breadcrumb_path }} - {{ project.name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/common/buttons.css' %}">
<style>
/* GitHub-style repository header */
.repo-header {
    padding: 1.5rem 0;
    border-bottom: 1px solid var(--color-border-default);
}

.repo-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--color-accent-fg);
    text-decoration: none;
}

.repo-title:hover {
    text-decoration: underline;
}

/* GitHub-style tab navigation */
.repo-tabs {
    display: flex;
    gap: 0;
    border-bottom: 1px solid var(--color-border-default);
    margin-bottom: 1.5rem;
    overflow-x: auto;
}

.repo-tab {
    padding: 0.5rem 1rem;
    color: var(--color-fg-muted);
    text-decoration: none;
    border-bottom: 2px solid transparent;
    white-space: nowrap;
}

.repo-tab:hover {
    color: var(--color-fg-default);
    border-bottom-color: var(--color-border-default);
}

.repo-tab.active {
    color: var(--color-fg-default);
    border-bottom-color: var(--tab-active-border);
    font-weight: 600;
}

/* Breadcrumb */
.breadcrumb-nav {
    margin-bottom: 1rem;
}

.breadcrumb {
    background: none;
    padding: 0;
    margin: 0;
}

.breadcrumb-item a {
    color: var(--color-accent-fg);
    text-decoration: none;
}

.breadcrumb-item a:hover {
    text-decoration: underline;
}

/* File browser table */
.file-browser {
    border: 1px solid var(--color-border-default);
    border-radius: 6px;
    overflow: hidden;
}

.file-browser table {
    width: 100%;
    margin: 0;
    border-collapse: collapse;
}

.file-browser th {
    background: var(--color-canvas-subtle);
    padding: 0.5rem 1rem;
    text-align: left;
    font-weight: 600;
    color: var(--color-fg-default);
    border-bottom: 1px solid var(--color-border-default);
}

.file-browser td {
    padding: 0.5rem 1rem;
    border-top: 1px solid var(--color-border-default);
}

.file-browser tr:hover {
    background: var(--color-canvas-subtle);
}

.file-name {
    color: var(--color-accent-fg);
    text-decoration: none;
    font-weight: 500;
}

.file-name:hover {
    text-decoration: underline;
}

.empty-directory {
    text-align: center;
    padding: 3rem;
    color: var(--color-fg-muted);
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid" style="max-width: 1280px;">
    <!-- Repository Header with Breadcrumb -->
    <div class="repo-header">
        <div style="display: flex; align-items: center; gap: 0.5rem;">
            <a href="/{{ project.owner.username }}/" style="color: var(--color-accent-fg); text-decoration: none; font-weight: 400;">
                {{ project.owner.username }}
            </a>
            <span style="color: var(--color-fg-muted);">/</span>
            <a href="/{{ project.owner.username }}/{{ project.slug }}/" class="repo-title">
                {{ project.name }}
            </a>
            {% for breadcrumb in breadcrumbs %}
                {% if breadcrumb.name != project.name %}
                    <span style="color: var(--color-fg-muted);">/</span>
                    {% if forloop.last %}
                        <span style="font-weight: 600; color: var(--color-fg-default);">{{ breadcrumb.name }}</span>
                    {% else %}
                        <a href="{{ breadcrumb.url }}" style="color: var(--color-accent-fg); text-decoration: none;">
                            {{ breadcrumb.name }}
                        </a>
                    {% endif %}
                {% endif %}
            {% endfor %}
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="repo-tabs" style="justify-content: space-between;">
        <div style="display: flex;">
            <a href="/{{ project.owner.username }}/{{ project.slug }}/" class="repo-tab">
                üìÑ Code
            </a>
            <a href="/{{ project.owner.username }}/{{ project.slug }}?mode=scholar" class="repo-tab">
            üìö Scholar
        </a>
        <a href="/{{ project.owner.username }}/{{ project.slug }}?mode=code" class="repo-tab">
            üíª Code
        </a>
        <a href="/{{ project.owner.username }}/{{ project.slug }}?mode=viz" class="repo-tab">
            üìä Viz
        </a>
        <a href="/{{ project.owner.username }}/{{ project.slug }}?mode=writer" class="repo-tab">
            ‚úçÔ∏è Writer
        </a>
        <a href="/{{ project.owner.username }}/{{ project.slug }}/settings/" class="repo-tab">
            ‚öôÔ∏è Settings
        </a>
        </div>
        <button onclick="copyDirToClipboard()" class="btn btn-sm btn-outline-primary" style="margin: 0.25rem;">
            üìã Copy All Files
        </button>
    </div>

    <!-- Directory Contents -->
    {% if contents %}
    <div class="file-browser">
        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th style="width: 200px;">Last modified</th>
                </tr>
            </thead>
            <tbody>
                {% for item in contents %}
                <tr>
                    <td>
                        {% if item.type == 'directory' %}
                            <a href="/{{ project.owner.username }}/{{ project.slug }}/{{ item.path }}/" class="file-name">
                                üìÅ {{ item.name }}
                            </a>
                        {% else %}
                            <a href="/{{ project.owner.username }}/{{ project.slug }}/blob/{{ item.path }}" class="file-name">
                                üìÑ {{ item.name }}
                            </a>
                        {% endif %}
                    </td>
                    <td class="text-muted">
                        {% if item.modified %}
                            {{ item.modified|date:"M j, Y" }}
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-directory">
        <i class="fas fa-folder-open fa-3x mb-3" style="opacity: 0.3;"></i>
        <h4>Empty Directory</h4>
        <p>This directory doesn't contain any files or folders yet.</p>
    </div>
    {% endif %}
</div>

<script>
async function copyDirToClipboard() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '‚è≥ Loading...';
    btn.disabled = true;

    try {
        // Call API to get concatenated content
        const response = await fetch('/{{ project.owner.username }}/{{ project.slug }}/api/concatenate/{{ breadcrumb_path }}');
        const data = await response.json();

        if (data.success) {
            await navigator.clipboard.writeText(data.content);
            btn.innerHTML = `‚úì Copied ${data.file_count} files!`;
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }, 3000);
        } else {
            alert('Error: ' + data.error);
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    } catch (err) {
        alert('Failed to copy: ' + err);
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}
</script>
{% endblock %}
