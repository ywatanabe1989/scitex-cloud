{% extends "base.html" %}
{% load static %}

{% block title %}{{ breadcrumb_path }} - {{ project.name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/common/buttons.css' %}">
<style>
/* GitHub-style repository header */
.repo-header {
    padding: 1.5rem 0;
    border-bottom: 1px solid var(--color-border-default);
}

.repo-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--color-accent-fg);
    text-decoration: none;
}

.repo-title:hover {
    text-decoration: underline;
}

/* Tab navigation now uses standardized .scitex-tabs component from design system */
.repo-tabs {
    margin-bottom: 1.5rem;
}

/* Breadcrumb */
.breadcrumb-nav {
    margin-bottom: 1rem;
}

.breadcrumb {
    background: none;
    padding: 0;
    margin: 0;
}

.breadcrumb-item a {
    color: var(--color-accent-fg);
    text-decoration: none;
}

.breadcrumb-item a:hover {
    text-decoration: underline;
}

/* File browser table - GitHub style */
.file-browser {
    border: 2px solid var(--color-border-default);
    border-radius: 6px;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
}

.file-browser table {
    width: 100%;
    margin: 0;
    border-collapse: collapse;
}

.file-browser th {
    background: var(--color-canvas-subtle);
    padding: 6px 12px;
    text-align: left;
    font-weight: 600;
    font-size: 12px;
    color: var(--color-fg-muted);
    border-bottom: 1px solid var(--color-border-default);
}

.file-browser tbody tr {
    cursor: pointer;
    transition: box-shadow 0.2s ease;
    border-top: 1px solid var(--color-border-default);
}

.file-browser tbody tr:hover {
    box-shadow: inset 0 0 0 2px var(--color-accent-emphasis);
}

.file-browser td {
    padding: 6px 12px;
    font-size: 14px;
    vertical-align: middle;
}

.file-browser td:first-child {
    width: 40%;
}

.file-browser td:nth-child(2) {
    width: 45%;
}

.file-browser td:last-child {
    width: 15%;
    text-align: right;
}

.file-name {
    color: var(--color-accent-fg);
    text-decoration: none;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 6px;
}

.file-name:hover {
    text-decoration: underline;
}

.file-browser .commit-message {
    color: var(--color-fg-default);
    font-size: 12px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
    display: flex;
    align-items: center;
    gap: 6px;
}

.file-browser .commit-message a {
    color: var(--color-fg-default);
    text-decoration: none;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    flex: 1;
}

.file-browser .commit-message a:hover {
    color: var(--color-accent-fg);
    text-decoration: underline;
}

.file-browser .commit-hash {
    font-family: ui-monospace, 'Cascadia Code', monospace;
    font-size: 12px;
    color: var(--color-fg-muted);
    background: var(--color-neutral-muted);
    padding: 2px 6px;
    border-radius: 6px;
    text-decoration: none;
    white-space: nowrap;
    flex-shrink: 0;
    position: relative;
}

.file-browser .commit-hash:hover {
    color: var(--color-accent-fg);
    background: var(--color-accent-subtle);
}

.file-browser .commit-hash::before {
    content: attr(data-hash);
    position: absolute;
    bottom: calc(100% + 8px);
    left: 50%;
    transform: translateX(-50%);
    background: var(--color-canvas-overlay);
    color: var(--color-fg-on-emphasis);
    padding: 6px 10px;
    border-radius: 6px;
    font-size: 11px;
    white-space: nowrap;
    z-index: 1000;
    border: 1px solid var(--color-border-default);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
}

.file-browser .commit-hash:hover::before {
    opacity: 1;
}

.file-browser .commit-hash::after {
    content: '';
    position: absolute;
    bottom: calc(100% + 2px);
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 6px solid transparent;
    border-right: 6px solid transparent;
    border-top: 6px solid var(--color-canvas-overlay);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
}

.file-browser .commit-hash:hover::after {
    opacity: 1;
}

.file-browser .commit-time {
    color: var(--color-fg-muted);
    font-size: 12px;
    white-space: nowrap;
}

.empty-directory {
    text-align: center;
    padding: 3rem;
    color: var(--color-fg-muted);
}

/* GitHub-style layout with sidebar on LEFT */
.repo-layout {
    display: grid;
    grid-template-columns: 296px 1fr;  /* Sidebar first, then main content */
    gap: 24px;
    margin-top: 1.5rem;
}

.repo-main {
    min-width: 0;
}

.repo-sidebar {
    position: sticky;
    top: 80px;
    align-self: start;
}

/* Sidebar sections */
.sidebar-section {
    border: 1px solid var(--color-border-default);
    border-radius: 6px;
    padding: 16px;
    margin-bottom: 16px;
    background: var(--color-canvas-default);
}

.sidebar-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--color-fg-default);
    text-transform: uppercase;
    margin-bottom: 12px;
    letter-spacing: 0.5px;
}

.sidebar-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 4px 0;
    font-size: 13px;
    color: var(--color-fg-muted);
}

.sidebar-item strong {
    color: var(--color-fg-default);
}

.sidebar-link {
    color: var(--color-accent-fg);
    text-decoration: none;
    font-size: 13px;
    display: block;
    padding: 4px 0;
}

.sidebar-link:hover {
    text-decoration: underline;
}

/* File tree styles */
.file-tree-item {
    padding: 2px 0;
    cursor: pointer;
    color: var(--color-fg-default);
    border-radius: 4px;
    transition: background 0.2s;
    font-size: 13px;
}

.file-tree-item:hover {
    background: var(--color-canvas-subtle);
}

.file-tree-item.active {
    background: var(--color-accent-subtle);
    font-weight: 600;
}

.file-tree-folder {
    color: var(--color-fg-default);
    display: flex;
    align-items: center;
    gap: 4px;
}

.file-tree-file {
    color: var(--color-fg-muted);
    display: flex;
    align-items: center;
    gap: 4px;
}

.file-tree-icon {
    width: 16px;
    height: 16px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

.file-tree-icon svg,
.icon-folder,
.icon-file {
    width: 18px;
    height: 18px;
}

.icon-folder,
.file-tree-folder .file-tree-icon {
    color: var(--scitex-color-04);
}

.icon-file,
.file-tree-file .file-tree-icon {
    color: var(--text-secondary);
}
}

.file-tree-chevron {
    width: 12px;
    height: 12px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    color: var(--color-fg-muted);
    transition: transform 0.2s;
    cursor: pointer;
}

.file-tree-chevron.expanded {
    transform: rotate(90deg);
}

.file-tree-children {
    display: none;
}

.file-tree-children.expanded {
    display: block;
}

/* Split button dropdown fix */
.btn-group {
    position: relative;
}

.btn-group .dropdown-menu {
    z-index: 9999 !important;
    background: var(--color-canvas-default);
    border: 1px solid var(--color-border-default);
    border-radius: 6px;
    box-shadow: 0 8px 16px rgba(0,0,0,0.2);
    min-width: 200px;
    position: absolute;
    top: 100%;
    right: 0;
    margin-top: 4px;
}

.btn-group .dropdown-item {
    color: var(--color-fg-default);
    padding: 8px 16px;
    white-space: nowrap;
}

.btn-group .dropdown-item:hover {
    background: var(--color-canvas-subtle);
    color: var(--color-fg-default);
}

@media (max-width: 1024px) {
    .repo-layout {
        grid-template-columns: 1fr;
    }

    .repo-sidebar {
        position: static;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid" style="max-width: 1280px;">
    <!-- Repository Header with Breadcrumb -->
    <div class="repo-header">
        <div style="display: flex; align-items: center; gap: 0.5rem;">
            <a href="/{{ project.owner.username }}/" style="color: var(--color-accent-fg); text-decoration: none; font-weight: 400;">
                {{ project.owner.username }}
            </a>
            <span style="color: var(--color-fg-muted);">/</span>
            <a href="/{{ project.owner.username }}/{{ project.slug }}/" class="repo-title">
                {{ project.name }}
            </a>
            {% for breadcrumb in breadcrumbs %}
                {% if breadcrumb.name != project.name %}
                    <span style="color: var(--color-fg-muted);">/</span>
                    {% if forloop.last %}
                        <span style="font-weight: 600; color: var(--color-fg-default);">{{ breadcrumb.name }}</span>
                    {% else %}
                        <a href="{{ breadcrumb.url }}" style="color: var(--color-accent-fg); text-decoration: none;">
                            {{ breadcrumb.name }}
                        </a>
                    {% endif %}
                {% endif %}
            {% endfor %}
        </div>
    </div>

    <!-- Repository Tab Navigation (GitHub-style) -->
    <div class="repo-tabs">
        <div class="scitex-tabs" style="display: flex; gap: 1.5rem;">
            <!-- <a href="/{{ project.owner.username }}/{{ project.slug }}/"
             !--    class="scitex-tab scitex-tab-active">
             !--     <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="display: inline-block; vertical-align: text-bottom;">
             !--         <path d="M2 2.5A2.5 2.5 0 0 1 4.5 0h8.75a.75.75 0 0 1 .75.75v12.5a.75.75 0 0 1-.75.75h-2.5a.75.75 0 0 1 0-1.5h1.75v-2h-8a1 1 0 0 0-.714 1.7.75.75 0 1 1-1.072 1.05A2.495 2.495 0 0 1 2 11.5Zm10.5-1h-8a1 1 0 0 0-1 1v6.708A2.486 2.486 0 0 1 4.5 9h8ZM5 12.25a.25.25 0 0 1 .25-.25h3.5a.25.25 0 0 1 .25.25v3.25a.25.25 0 0 1-.4.2l-1.45-1.087a.249.249 0 0 0-.3 0L5.4 15.7a.25.25 0 0 1-.4-.2Z"/>
             !--     </svg>
             !--     Code
             !-- </a> -->
            <a href="/{{ project.owner.username }}/{{ project.slug }}/issues/"
               class="scitex-tab"
               title="Track issues and bugs">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="display: inline-block; vertical-align: text-bottom;">
                    <path d="M8 9.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z"/>
                    <path d="M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0ZM1.5 8a6.5 6.5 0 1 0 13 0 6.5 6.5 0 0 0-13 0Z"/>
                </svg>
                Issues
            </a>
            <a href="/{{ project.owner.username }}/{{ project.slug }}/pulls/"
               class="scitex-tab"
               title="Review code changes">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="display: inline-block; vertical-align: text-bottom;">
                    <path d="M1.5 3.25a2.25 2.25 0 1 1 3 2.122v5.256a2.251 2.251 0 1 1-1.5 0V5.372A2.25 2.25 0 0 1 1.5 3.25Zm5.677-.177L9.573.677A.25.25 0 0 1 10 .854V2.5h1A2.5 2.5 0 0 1 13.5 5v5.628a2.251 2.251 0 1 1-1.5 0V5a1 1 0 0 0-1-1h-1v1.646a.25.25 0 0 1-.427.177L7.177 3.427a.25.25 0 0 1 0-.354ZM3.75 2.5a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5Zm0 9.5a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5Zm8.25.75a.75.75 0 1 0 1.5 0 .75.75 0 0 0-1.5 0Z"/>
                </svg>
                Pull requests
            </a>
            <a href="/{{ project.owner.username }}/{{ project.slug }}/settings/"
               class="scitex-tab"
               title="Repository settings">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="display: inline-block; vertical-align: text-bottom;">
                    <path d="M8 0a8.2 8.2 0 0 1 .701.031C9.444.095 9.99.645 10.16 1.29l.288 1.107c.018.066.079.158.212.224.231.114.454.243.668.386.123.082.233.09.299.071l1.103-.303c.644-.176 1.392.021 1.82.63.27.385.506.792.704 1.218.315.675.111 1.422-.364 1.891l-.814.806c-.049.048-.098.147-.088.294.016.257.016.515 0 .772-.01.147.038.246.088.294l.814.806c.475.469.679 1.216.364 1.891a7.977 7.977 0 0 1-.704 1.217c-.428.61-1.176.807-1.82.63l-1.102-.302c-.067-.019-.177-.011-.3.071a5.909 5.909 0 0 1-.668.386c-.133.066-.194.158-.211.224l-.29 1.106c-.168.646-.715 1.196-1.458 1.26a8.006 8.006 0 0 1-1.402 0c-.743-.064-1.289-.614-1.458-1.26l-.289-1.106c-.018-.066-.079-.158-.212-.224a5.738 5.738 0 0 1-.668-.386c-.123-.082-.233-.09-.299-.071l-1.103.303c-.644.176-1.392-.021-1.82-.63a8.12 8.12 0 0 1-.704-1.218c-.315-.675-.111-1.422.363-1.891l.815-.806c.05-.048.098-.147.088-.294a6.214 6.214 0 0 1 0-.772c.01-.147-.038-.246-.088-.294l-.815-.806C.635 6.045.431 5.298.746 4.623a7.92 7.92 0 0 1 .704-1.217c.428-.61 1.176-.807 1.82-.63l1.102.302c.067.019.177.011.3-.071.214-.143.437-.272.668-.386.133-.066.194-.158.211-.224l.29-1.106C6.009.645 6.556.095 7.299.03 7.53.01 7.764 0 8 0Zm-.571 1.525c-.036.003-.108.036-.137.146l-.289 1.105c-.147.561-.549.967-.998 1.189-.173.086-.36.159-.558.217-.473.138-.96.072-1.384-.234l-1.103-.303c-.109-.03-.175.016-.195.045-.22.312-.412.644-.573.99-.014.031-.021.11.059.19l.815.806c.411.406.562.957.53 1.456a4.709 4.709 0 0 0 0 .582c.032.499-.119 1.05-.53 1.456l-.815.806c-.081.08-.073.159-.059.19.162.346.353.677.573.989.02.03.085.076.195.046l1.102-.303c.424-.306.91-.372 1.383-.234.198.058.386.131.559.217.449.222.851.628.998 1.189l.289 1.105c.029.109.101.143.137.146a6.6 6.6 0 0 0 1.142 0c.036-.003.108-.036.137-.146l.289-1.105c.147-.561.549-.967.998-1.189.173-.086.36-.159.558-.217.473-.138.96-.072 1.384.234l1.103.303c.109.029.175-.016.195-.045.22-.313.411-.644.573-.990.014-.031.021-.11-.059-.19l-.815-.806c-.411-.406-.562-.957-.53-1.456a4.709 4.709 0 0 0 0-.582c-.032-.499.119-1.05.53-1.456l.815-.806c.081-.08.073-.159.059-.19a6.464 6.464 0 0 0-.573-.989c-.02-.03-.085-.076-.195-.046l-1.102.303c-.424.306-.91.372-1.383.234a4.97 4.97 0 0 0-.559-.217c-.449-.222-.851-.628-.998-1.189l-.289-1.105c-.029-.11-.101-.143-.137-.146a6.6 6.6 0 0 0-1.142 0ZM11 8a3 3 0 1 1-6 0 3 3 0 0 1 6 0ZM9.5 8a1.5 1.5 0 1 0-3.001.001A1.5 1.5 0 0 0 9.5 8Z"/>
                </svg>
                Settings
            </a>
        </div>
    </div>

    <!-- File Browser Toolbar (GitHub-style) -->
    <div class="file-browser-toolbar" style="display: flex; justify-content: space-between; align-items: center; margin-top: 16px; margin-bottom: 16px;">
        <div style="display: flex; gap: 8px; align-items: center;">
            <!-- Go to file search -->
            <div style="position: relative;">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--color-fg-muted); pointer-events: none;">
                    <path d="M10.68 11.74a6 6 0 0 1-7.922-8.982 6 6 0 0 1 8.982 7.922l3.04 3.04a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215ZM11.5 7a4.5 4.5 0 1 0-8.999.001A4.5 4.5 0 0 0 11.5 7Z"/>
                </svg>
                <input type="text"
                       placeholder="Go to file"
                       id="goto-file-input"
                       style="padding: 5px 12px 5px 32px; border: 1px solid var(--color-border-default); border-radius: 6px; background: var(--color-canvas-default); color: var(--color-fg-default); font-size: 12px; width: 180px; transition: all 0.2s;"
                       onfocus="this.style.borderColor='var(--color-accent-fg)'; this.style.width='250px';"
                       onblur="this.style.borderColor='var(--color-border-default)'; this.style.width='180px';">
            </div>
        </div>

        <div style="display: flex; gap: 8px; align-items: center;">
            <!-- Add File Button (Moved to right side) -->
            <div class="btn-group">
                <button type="button" class="btn btn-sm repo-action-btn" style="display: flex; align-items: center; gap: 4px;" onclick="toggleAddFileDropdown()">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M7.75 2a.75.75 0 0 1 .75.75V7h4.25a.75.75 0 0 1 0 1.5H8.5v4.25a.75.75 0 0 1-1.5 0V8.5H2.75a.75.75 0 0 1 0-1.5H7V2.75A.75.75 0 0 1 7.75 2Z"/>
                    </svg>
                    Add file
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="opacity: 0.6;">
                        <path d="M4.427 7.427l3.396 3.396a.25.25 0 00.354 0l3.396-3.396A.25.25 0 0011.396 7H4.604a.25.25 0 00-.177.427z"/>
                    </svg>
                </button>
                <div id="add-file-dropdown" class="dropdown-menu" style="display: none; position: absolute; right: 0; z-index: 9999; background: var(--color-canvas-default); border: 1px solid var(--color-border-default); border-radius: 6px; box-shadow: 0 8px 16px rgba(0,0,0,0.2); min-width: 200px; margin-top: 4px;">
                    <a href="/{{ project.owner.username }}/{{ project.slug }}/new-file/" class="dropdown-item" style="padding: 8px 16px; display: block; color: var(--color-fg-default); text-decoration: none;">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="display: inline-block; vertical-align: text-bottom; margin-right: 4px;">
                            <path d="M2 1.75C2 .784 2.784 0 3.75 0h6.586c.464 0 .909.184 1.237.513l2.914 2.914c.329.328.513.773.513 1.237v9.586A1.75 1.75 0 0 1 13.25 16h-9.5A1.75 1.75 0 0 1 2 14.25Zm1.75-.25a.25.25 0 0 0-.25.25v12.5c0 .138.112.25.25.25h9.5a.25.25 0 0 0 .25-.25V6h-2.75A1.75 1.75 0 0 1 9 4.25V1.5Zm6.75.062V4.25c0 .138.112.25.25.25h2.688l-.011-.013-2.914-2.914-.013-.011Z"/>
                        </svg>
                        Create new file
                    </a>
                    <a href="/{{ project.owner.username }}/{{ project.slug }}/upload/" class="dropdown-item" style="padding: 8px 16px; display: block; color: var(--color-fg-default); text-decoration: none;">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="display: inline-block; vertical-align: text-bottom; margin-right: 4px;">
                            <path d="M2.75 14A1.75 1.75 0 0 1 1 12.25v-2.5a.75.75 0 0 1 1.5 0v2.5c0 .138.112.25.25.25h10.5a.25.25 0 0 0 .25-.25v-2.5a.75.75 0 0 1 1.5 0v2.5A1.75 1.75 0 0 1 13.25 14Z"/>
                            <path d="M11.78 4.72a.749.749 0 1 1-1.06 1.06L8.75 3.811V9.5a.75.75 0 0 1-1.5 0V3.811L5.28 5.78a.749.749 0 1 1-1.06-1.06l3.25-3.25a.749.749 0 0 1 1.06 0l3.25 3.25Z"/>
                        </svg>
                        Upload files
                    </a>
                </div>
            </div>
            <!-- Copy Concatenated Text Button -->
            <div class="btn-group">
                <button onclick="copyProjectToClipboard()" class="btn btn-sm" id="copy-project-btn" style="background: var(--color-canvas-default); border: 1px solid var(--color-border-default); color: var(--color-fg-default); border-radius: 6px; padding: 5px 12px; font-size: 12px; font-weight: 600;">
                    Copy Concatenated
                </button>
                <button class="btn btn-sm dropdown-toggle-split" type="button" onclick="toggleCopyDropdown()" style="background: var(--color-canvas-default); border: 1px solid var(--color-border-default); border-left: none; color: var(--color-fg-default); border-radius: 0 6px 6px 0; padding: 5px 8px;">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="opacity: 0.6;">
                        <path d="M4.427 7.427l3.396 3.396a.25.25 0 00.354 0l3.396-3.396A.25.25 0 0011.396 7H4.604a.25.25 0 00-.177.427z"/>
                    </svg>
                </button>
                <div id="copy-dropdown" class="dropdown-menu" style="display: none; position: absolute; z-index: 9999; background: var(--color-canvas-default); border: 1px solid var(--color-border-default); border-radius: 6px; box-shadow: 0 8px 16px rgba(0,0,0,0.2); min-width: 200px; margin-top: 4px; right: 0;">
                    <a class="dropdown-item" href="#" onclick="event.preventDefault(); copyProjectToClipboard();" style="padding: 8px 16px; display: block; color: var(--color-fg-default); text-decoration: none;">Copy Concatenated Text</a>
                    <a class="dropdown-item" href="#" onclick="event.preventDefault(); downloadProjectAsFile();" style="padding: 8px 16px; display: block; color: var(--color-fg-default); text-decoration: none;">Download Concatenated Text</a>
                </div>
            </div>

            <!-- More Options Button -->
            <button type="button" class="btn btn-sm" style="background: var(--color-canvas-default); border: 1px solid var(--color-border-default); color: var(--color-fg-default); border-radius: 6px; padding: 5px 8px; font-size: 12px; font-weight: 600;" onclick="toggleMoreDropdown()">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M8 9a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3ZM1.5 9a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Zm13 0a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z"/>
                </svg>
            </button>
            <div id="more-dropdown" class="dropdown-menu" style="display: none; position: absolute; z-index: 9999; background: var(--color-canvas-default); border: 1px solid var(--color-border-default); border-radius: 6px; box-shadow: 0 8px 16px rgba(0,0,0,0.2); min-width: 200px; margin-top: 4px; right: 0;">
                <a href="#" class="dropdown-item" style="padding: 8px 16px; display: block; color: var(--color-fg-default); text-decoration: none;">About this repository</a>
                <a href="#" class="dropdown-item" style="padding: 8px 16px; display: block; color: var(--color-fg-default); text-decoration: none;">View all branches</a>
                <div style="border-top: 1px solid var(--color-border-default); margin: 4px 0;"></div>
                <a href="#" class="dropdown-item" style="padding: 8px 16px; display: block; color: var(--color-fg-default); text-decoration: none;">Manage topics</a>
            </div>
        </div>
    </div>

    <!-- Main Content Area with Sidebar -->
    <div class="repo-layout">
        <!-- Sidebar (LEFT side like GitHub) - File Tree Navigation -->
        <aside class="repo-sidebar">
            <!-- File Tree -->
            <div class="sidebar-section">
                <div class="sidebar-title">
                    <a href="/{{ project.owner.username }}/{{ project.slug }}/" style="color: var(--color-fg-default); text-decoration: none;">
                        {{ project.name }}
                    </a>
                </div>
                <div id="file-tree" style="font-size: 12px;">
                    <!-- File tree will be loaded here -->
                    <div class="tree-loading" style="color: var(--color-fg-muted); padding: 1rem;">
                        <i class="fas fa-spinner fa-spin"></i> Loading file tree...
                    </div>
                </div>
            </div>

            <!-- About Section - Hidden by default to match GitHub style -->
            <!-- Metadata can be accessed via project settings or a collapsible section if needed -->
        </aside>

        <!-- Main Content (RIGHT side) -->
        <div class="repo-main">
            <!-- Directory Contents - GitHub Style -->
            {% if contents %}
            <div class="file-browser">
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Last commit message</th>
                            <th>Last commit date</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in contents %}
                        <tr data-href="{% if item.type == 'directory' %}/{{ project.owner.username }}/{{ project.slug }}/{{ item.path }}/{% else %}/{{ project.owner.username }}/{{ project.slug }}/blob/{{ item.path }}{% endif %}" class="clickable-row">
                            <td>
                                {% if item.type == 'directory' %}
                                    <a href="/{{ project.owner.username }}/{{ project.slug }}/{{ item.path }}/" class="file-name" onclick="event.stopPropagation();">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" class="icon-folder"><path fill="currentColor" d="M1.75 1A1.75 1.75 0 0 0 0 2.75v10.5C0 14.216.784 15 1.75 15h12.5A1.75 1.75 0 0 0 16 13.25v-8.5A1.75 1.75 0 0 0 14.25 3H7.5a.25.25 0 0 1-.2-.1l-.9-1.2C6.07 1.26 5.55 1 5 1H1.75Z"></path></svg>
                                        {{ item.name }}
                                    </a>
                                {% else %}
                                    <a href="/{{ project.owner.username }}/{{ project.slug }}/blob/{{ item.path }}" class="file-name" onclick="event.stopPropagation();">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" class="icon-file"><path fill="currentColor" d="M2 1.75C2 .784 2.784 0 3.75 0h6.586c.464 0 .909.184 1.237.513l2.914 2.914c.329.328.513.773.513 1.237v9.586A1.75 1.75 0 0 1 13.25 16h-9.5A1.75 1.75 0 0 1 2 14.25Zm1.75-.25a.25.25 0 0 0-.25.25v12.5c0 .138.112.25.25.25h9.5a.25.25 0 0 0 .25-.25V6h-2.75A1.75 1.75 0 0 1 9 4.25V1.5Zm6.75.062V4.25c0 .138.112.25.25.25h2.688l-.011-.013-2.914-2.914-.013-.011Z"></path></svg>
                                        {{ item.name }}
                                    </a>
                                {% endif %}
                            </td>
                            <td class="commit-message">
                                {% if item.message %}
                                    {% if item.hash %}
                                        <a href="/{{ project.owner.username }}/{{ project.slug }}/commit/{{ item.hash }}/" onclick="event.stopPropagation();" title="{{ item.message }}">{{ item.message }}</a>
                                        <a href="/{{ project.owner.username }}/{{ project.slug }}/commit/{{ item.hash }}/" class="commit-hash" data-hash="{{ item.hash }}" onclick="event.stopPropagation();">{{ item.hash|slice:":7" }}</a>
                                    {% else %}
                                        {{ item.message }}
                                    {% endif %}
                                {% else %}
                                    <span style="color: var(--color-fg-muted);">No commit message</span>
                                {% endif %}
                            </td>
                            <td class="commit-time">
                                {% if item.time_ago %}{{ item.time_ago }}{% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="empty-directory">
                <i class="fas fa-folder-open fa-3x mb-3" style="opacity: 0.3;"></i>
                <h4>Empty Directory</h4>
                <p>This directory doesn't contain any files or folders yet.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
// Build file tree for sidebar
async function loadFileTree() {
    try {
        const response = await fetch('/{{ project.owner.username }}/{{ project.slug }}/api/file-tree/');
        const data = await response.json();

        if (data.success) {
            const treeContainer = document.getElementById('file-tree');
            treeContainer.innerHTML = buildTreeHTML(data.tree, '{{ project.owner.username }}', '{{ project.slug }}');
        } else {
            document.getElementById('file-tree').innerHTML = '<div style="color: var(--color-fg-muted); padding: 0.5rem;">Error loading file tree</div>';
        }
    } catch (err) {
        console.error('Failed to load file tree:', err);
        document.getElementById('file-tree').innerHTML = '<div style="color: var(--color-fg-muted); padding: 0.5rem;">Error loading file tree</div>';
    }
}

function buildTreeHTML(items, username, slug, level = 0) {
    let html = '';
    const indent = level * 16;
    const currentPath = window.location.pathname;

    items.forEach((item, index) => {
        const itemPath = `/${username}/${slug}/${item.path}${item.type === 'directory' ? '/' : ''}`;
        const isActive = currentPath.includes(item.path);
        const icon = item.type === 'directory' ? '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" class="icon-folder"><path fill="currentColor" d="M1.75 1A1.75 1.75 0 0 0 0 2.75v10.5C0 14.216.784 15 1.75 15h12.5A1.75 1.75 0 0 0 16 13.25v-8.5A1.75 1.75 0 0 0 14.25 3H7.5a.25.25 0 0 1-.2-.1l-.9-1.2C6.07 1.26 5.55 1 5 1H1.75Z"></path></svg>' : '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" class="icon-file"><path fill="currentColor" d="M2 1.75C2 .784 2.784 0 3.75 0h6.586c.464 0 .909.184 1.237.513l2.914 2.914c.329.328.513.773.513 1.237v9.586A1.75 1.75 0 0 1 13.25 16h-9.5A1.75 1.75 0 0 1 2 14.25Zm1.75-.25a.25.25 0 0 0-.25.25v12.5c0 .138.112.25.25.25h9.5a.25.25 0 0 0 .25-.25V6h-2.75A1.75 1.75 0 0 1 9 4.25V1.5Zm6.75.062V4.25c0 .138.112.25.25.25h2.688l-.011-.013-2.914-2.914-.013-.011Z"></path></svg>';
        const hasChildren = item.children && item.children.length > 0;
        const itemId = `tree-${item.path.replace(/\//g, '-')}`;  // Unique ID based on path

        // Item row
        html += `<div class="file-tree-item ${isActive ? 'active' : ''}" style="padding-left: ${indent}px;">`;

        if (item.type === 'directory') {
            html += `<a href="${itemPath}" class="file-tree-folder" style="text-decoration: none; color: var(--color-fg-default);">`;

            // Chevron for folders with children
            if (hasChildren) {
                html += `<span class="file-tree-chevron ${level === 0 ? 'expanded' : ''}" onclick="toggleFolder('${itemId}'); return false;">â–¸</span>`;
            } else {
                html += `<span style="width: 12px; display: inline-block;"></span>`;
            }

            html += `<span class="file-tree-icon">${icon}</span><span>${item.name}</span>`;
            html += `</a>`;
        } else {
            html += `<a href="/${username}/${slug}/blob/${item.path}" class="file-tree-file" style="text-decoration: none; color: var(--color-fg-muted);">`;
            html += `<span style="width: 12px; display: inline-block;"></span>`;
            html += `<span class="file-tree-icon">${icon}</span><span>${item.name}</span>`;
            html += `</a>`;
        }

        html += `</div>`;

        // Children container - render ALL children
        if (hasChildren) {
            const isExpanded = level === 0;  // Auto-expand root level only
            html += `<div id="${itemId}" class="file-tree-children ${isExpanded ? 'expanded' : ''}">`;
            html += buildTreeHTML(item.children, username, slug, level + 1);  // Recursively build all children
            html += `</div>`;
        }
    });

    return html;
}

function toggleFolder(folderId) {
    const folder = document.getElementById(folderId);
    const chevron = event.target;

    if (folder.classList.contains('expanded')) {
        folder.classList.remove('expanded');
        chevron.classList.remove('expanded');
    } else {
        folder.classList.add('expanded');
        chevron.classList.add('expanded');
    }

    event.stopPropagation();
    event.preventDefault();
}

// Make table rows clickable
document.addEventListener('DOMContentLoaded', function() {
    console.log('Page loaded - initializing file tree and dropdown');
    loadFileTree();

    // Add click handlers to table rows
    const clickableRows = document.querySelectorAll('.clickable-row');
    clickableRows.forEach(row => {
        row.addEventListener('click', function(e) {
            // Don't navigate if clicking on a link directly
            if (e.target.tagName === 'A' || e.target.closest('a')) {
                return;
            }
            const href = this.getAttribute('data-href');
            if (href) {
                window.location.href = href;
            }
        });
    });

    // Debug and manually initialize Bootstrap dropdown
    const dropdownToggle = document.querySelector('.dropdown-toggle-split');
    const dropdownMenu = document.querySelector('.dropdown-menu');

    if (dropdownToggle && dropdownMenu) {
        console.log('Dropdown elements found - setting up manual toggle');

        // Manual dropdown toggle (in case Bootstrap JS isn't working)
        dropdownToggle.addEventListener('click', function(e) {
            console.log('Dropdown toggle clicked!');
            e.preventDefault();
            e.stopPropagation();

            const isVisible = dropdownMenu.style.display === 'block';
            dropdownMenu.style.display = isVisible ? 'none' : 'block';
            console.log('Dropdown visibility toggled to:', dropdownMenu.style.display);
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!dropdownToggle.contains(e.target) && !dropdownMenu.contains(e.target)) {
                dropdownMenu.style.display = 'none';
            }
        });
    } else {
        console.warn('Dropdown elements not found:', {dropdownToggle, dropdownMenu});
    }
});

// Toolbar dropdown functions
function toggleBranchDropdown() {
    const dropdown = document.getElementById('branch-dropdown');
    const isVisible = dropdown.style.display === 'block';
    closeAllDropdowns();
    dropdown.style.display = isVisible ? 'none' : 'block';
}

function toggleAddFileDropdown() {
    const dropdown = document.getElementById('add-file-dropdown');
    const isVisible = dropdown.style.display === 'block';
    closeAllDropdowns();
    dropdown.style.display = isVisible ? 'none' : 'block';
}

function toggleCopyDropdown() {
    const dropdown = document.getElementById('copy-dropdown');
    const isVisible = dropdown.style.display === 'block';
    closeAllDropdowns();
    dropdown.style.display = isVisible ? 'none' : 'block';
}

function toggleCodeDropdown() {
    const dropdown = document.getElementById('code-dropdown');
    const isVisible = dropdown.style.display === 'block';
    closeAllDropdowns();
    dropdown.style.display = isVisible ? 'none' : 'block';
}

function toggleMoreDropdown() {
    const dropdown = document.getElementById('more-dropdown');
    const isVisible = dropdown.style.display === 'block';
    closeAllDropdowns();
    dropdown.style.display = isVisible ? 'none' : 'block';
}

function closeAllDropdowns() {
    document.querySelectorAll('.file-browser-toolbar .dropdown-menu').forEach(dropdown => {
        dropdown.style.display = 'none';
    });
}

// Close dropdowns when clicking outside
document.addEventListener('click', function(e) {
    if (!e.target.closest('.file-browser-toolbar .btn-group')) {
        closeAllDropdowns();
    }
});

// Copy to clipboard helper
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        console.log('Copied to clipboard:', text);
    }).catch(err => {
        console.error('Failed to copy:', err);
    });
}

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Switch branch via API
async function switchBranch(branch) {
    console.log('Switching to branch:', branch);

    try {
        // Call the branch switching API
        const response = await fetch('/{{ project.owner.username }}/{{ project.slug }}/api/switch-branch/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ branch: branch })
        });

        const data = await response.json();

        if (data.success) {
            // Reload page to show files from new branch
            window.location.reload();
        } else {
            alert('Failed to switch branch: ' + data.error);
        }
    } catch (error) {
        console.error('Error switching branch:', error);
        alert('Failed to switch branch: ' + error.message);
    }
}

// Add hover effects to dropdown items
document.addEventListener('DOMContentLoaded', function() {
    const dropdownItems = document.querySelectorAll('.file-browser-toolbar .dropdown-item');
    dropdownItems.forEach(item => {
        item.addEventListener('mouseenter', function() {
            this.style.background = 'var(--color-canvas-subtle)';
        });
        item.addEventListener('mouseleave', function() {
            this.style.background = 'transparent';
        });
    });
});

async function copyProjectToClipboard() {
    console.log('copyProjectToClipboard() called');
    const btn = document.getElementById('copy-project-btn');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" style="vertical-align: text-bottom; margin-right: 4px;"><path fill="#6c8ba0" d="M2.75 0a.75.75 0 0 0 0 1.5h.75v1.25a4.75 4.75 0 0 0 1.9 3.8l.333.25c.134.1.134.3 0 .4l-.333.25a4.75 4.75 0 0 0-1.9 3.8v1.25h-.75a.75.75 0 0 0 0 1.5h10.5a.75.75 0 0 0 0-1.5h-.75v-1.25a4.75 4.75 0 0 0-1.9-3.8l-.333-.25a.25.25 0 0 1 0-.4l.333-.25a4.75 4.75 0 0 0 1.9-3.8V1.5h.75a.75.75 0 0 0 0-1.5H2.75Zm7.25 9v3.25h-4V9a3.25 3.25 0 0 1 1.3-2.6l.333-.25a1.75 1.75 0 0 0 0-2.8l-.333-.25A3.25 3.25 0 0 1 6 1.5V0h4v1.5a3.25 3.25 0 0 1-1.3 2.6l-.333.25a1.75 1.75 0 0 0 0 2.8l.333.25A3.25 3.25 0 0 1 10 9.75Z"/></svg> Loading...';
    btn.disabled = true;

    try {
        // Call API to get concatenated content
        console.log('Fetching concatenated content...');
        const response = await fetch('/{{ project.owner.username }}/{{ project.slug }}/api/concatenate/{{ breadcrumb_path }}');
        const data = await response.json();
        console.log('API response:', data);

        if (data.success) {
            await navigator.clipboard.writeText(data.content);
            btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" style="vertical-align: text-bottom; margin-right: 4px;"><path fill="#6c8ba0" fill-rule="evenodd" d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"/></svg> Copied ${data.file_count} files!`;
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }, 3000);
        } else {
            alert('Error: ' + data.error);
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    } catch (err) {
        alert('Failed to copy: ' + err);
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

async function downloadProjectAsFile() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" style="vertical-align: text-bottom; margin-right: 4px;"><path fill="#6c8ba0" d="M2.75 0a.75.75 0 0 0 0 1.5h.75v1.25a4.75 4.75 0 0 0 1.9 3.8l.333.25c.134.1.134.3 0 .4l-.333.25a4.75 4.75 0 0 0-1.9 3.8v1.25h-.75a.75.75 0 0 0 0 1.5h10.5a.75.75 0 0 0 0-1.5h-.75v-1.25a4.75 4.75 0 0 0-1.9-3.8l-.333-.25a.25.25 0 0 1 0-.4l.333-.25a4.75 4.75 0 0 0 1.9-3.8V1.5h.75a.75.75 0 0 0 0-1.5H2.75Zm7.25 9v3.25h-4V9a3.25 3.25 0 0 1 1.3-2.6l.333-.25a1.75 1.75 0 0 0 0-2.8l-.333-.25A3.25 3.25 0 0 1 6 1.5V0h4v1.5a3.25 3.25 0 0 1-1.3 2.6l-.333.25a1.75 1.75 0 0 0 0 2.8l.333.25A3.25 3.25 0 0 1 10 9.75Z"/></svg> Preparing download...';

    try {
        // Call API to get concatenated content
        const response = await fetch('/{{ project.owner.username }}/{{ project.slug }}/api/concatenate/{{ breadcrumb_path }}');
        const data = await response.json();

        if (data.success) {
            // Create a blob and download it
            const blob = new Blob([data.content], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;

            // Generate filename based on project and path
            const dirName = '{{ breadcrumb_path }}'.split('/').filter(x => x).pop() || '{{ project.slug }}';
            a.download = `${dirName}_all_files.txt`;

            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" style="vertical-align: text-bottom; margin-right: 4px;"><path fill="#6c8ba0" fill-rule="evenodd" d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"/></svg> Downloaded ${data.file_count} files!`;
            setTimeout(() => {
                btn.innerHTML = originalText;
            }, 3000);
        } else {
            alert('Error: ' + data.error);
            btn.innerHTML = originalText;
        }
    } catch (err) {
        alert('Failed to download: ' + err);
        btn.innerHTML = originalText;
    }
}

async function copyDirToClipboard() {
    console.log('copyDirToClipboard() called');
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" style="vertical-align: text-bottom; margin-right: 4px;"><path fill="#6c8ba0" d="M2.75 0a.75.75 0 0 0 0 1.5h.75v1.25a4.75 4.75 0 0 0 1.9 3.8l.333.25c.134.1.134.3 0 .4l-.333.25a4.75 4.75 0 0 0-1.9 3.8v1.25h-.75a.75.75 0 0 0 0 1.5h10.5a.75.75 0 0 0 0-1.5h-.75v-1.25a4.75 4.75 0 0 0-1.9-3.8l-.333-.25a.25.25 0 0 1 0-.4l.333-.25a4.75 4.75 0 0 0 1.9-3.8V1.5h.75a.75.75 0 0 0 0-1.5H2.75Zm7.25 9v3.25h-4V9a3.25 3.25 0 0 1 1.3-2.6l.333-.25a1.75 1.75 0 0 0 0-2.8l-.333-.25A3.25 3.25 0 0 1 6 1.5V0h4v1.5a3.25 3.25 0 0 1-1.3 2.6l-.333.25a1.75 1.75 0 0 0 0 2.8l.333.25A3.25 3.25 0 0 1 10 9.75Z"/></svg> Loading...';
    btn.disabled = true;

    try {
        // Call API to get concatenated content
        console.log('Fetching concatenated content...');
        const response = await fetch('/{{ project.owner.username }}/{{ project.slug }}/api/concatenate/{{ breadcrumb_path }}');
        const data = await response.json();
        console.log('API response:', data);

        if (data.success) {
            await navigator.clipboard.writeText(data.content);
            btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" style="vertical-align: text-bottom; margin-right: 4px;"><path fill="#6c8ba0" fill-rule="evenodd" d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"/></svg> Copied ${data.file_count} files!`;
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }, 3000);
        } else {
            alert('Error: ' + data.error);
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    } catch (err) {
        alert('Failed to copy: ' + err);
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

async function downloadDirAsFile() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" style="vertical-align: text-bottom; margin-right: 4px;"><path fill="#6c8ba0" d="M2.75 0a.75.75 0 0 0 0 1.5h.75v1.25a4.75 4.75 0 0 0 1.9 3.8l.333.25c.134.1.134.3 0 .4l-.333.25a4.75 4.75 0 0 0-1.9 3.8v1.25h-.75a.75.75 0 0 0 0 1.5h10.5a.75.75 0 0 0 0-1.5h-.75v-1.25a4.75 4.75 0 0 0-1.9-3.8l-.333-.25a.25.25 0 0 1 0-.4l.333-.25a4.75 4.75 0 0 0 1.9-3.8V1.5h.75a.75.75 0 0 0 0-1.5H2.75Zm7.25 9v3.25h-4V9a3.25 3.25 0 0 1 1.3-2.6l.333-.25a1.75 1.75 0 0 0 0-2.8l-.333-.25A3.25 3.25 0 0 1 6 1.5V0h4v1.5a3.25 3.25 0 0 1-1.3 2.6l-.333.25a1.75 1.75 0 0 0 0 2.8l.333.25A3.25 3.25 0 0 1 10 9.75Z"/></svg> Preparing download...';
    btn.disabled = true;

    try {
        // Call API to get concatenated content
        const response = await fetch('/{{ project.owner.username }}/{{ project.slug }}/api/concatenate/{{ breadcrumb_path }}');
        const data = await response.json();

        if (data.success) {
            // Create a blob and download it
            const blob = new Blob([data.content], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;

            // Generate filename based on project and path
            const dirName = '{{ breadcrumb_path }}'.split('/').filter(x => x).pop() || '{{ project.slug }}';
            a.download = `${dirName}_all_files.txt`;

            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" style="vertical-align: text-bottom; margin-right: 4px;"><path fill="#6c8ba0" fill-rule="evenodd" d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"/></svg> Downloaded ${data.file_count} files!`;
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }, 3000);
        } else {
            alert('Error: ' + data.error);
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    } catch (err) {
        alert('Failed to download: ' + err);
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}
</script>
{% endblock %}
