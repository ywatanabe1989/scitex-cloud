{% extends 'base.html' %}
{% load static %}

{% block title %}{{ project.name }} - SciTeX Cloud{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/common/buttons.css' %}">
<style>
/* GitHub-style repository header - Theme-aware */
.repo-header {
    padding: 1.5rem 0;
    border-bottom: 1px solid var(--color-border-default);
}

.repo-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--color-accent-fg);  /* SciTeX brand color */
    text-decoration: none;
}

.repo-title:hover {
    text-decoration: underline;
}

.repo-description {
    color: var(--color-fg-muted);
    margin-top: 0.5rem;
}

/* Tab navigation now uses standardized .scitex-tabs component from design system */
.repo-tabs {
    margin-bottom: 1.5rem;
}

/* File browser table - GitHub style */
.file-browser {
    border: 1px solid var(--color-border-default);
    border-radius: 6px;
    overflow: hidden;
    margin-bottom: 1.5rem;
    background: var(--color-canvas-default);
}

.file-browser table {
    width: 100%;
    margin: 0;
    border-collapse: collapse;
}

.file-browser th {
    background: var(--color-neutral-muted);
    padding: 6px 12px;
    text-align: left;
    font-weight: 600;
    font-size: 12px;
    color: var(--color-fg-muted);
    border-bottom: 1px solid var(--color-border-default);
}

.file-browser tbody tr {
    cursor: pointer;
    transition: background-color 0.05s ease;
    border-top: 1px solid var(--color-border-default);
}

.file-browser tbody tr:hover {
    background: var(--color-neutral-muted);
}

.file-browser td {
    padding: 6px 12px;
    font-size: 14px;
    color: var(--color-fg-default);
    vertical-align: middle;
}

.file-name {
    color: var(--color-accent-fg);
    text-decoration: none;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 6px;
}

.file-name:hover {
    text-decoration: underline;
}










.file-browser .commit-message {
    color: var(--color-fg-default);
    font-size: 12px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
    display: flex;
    align-items: center;
    gap: 6px;
}

.file-browser .commit-message a {
    color: var(--color-fg-default);
    text-decoration: none;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    flex: 1;
}

.file-browser .commit-message a:hover {
    color: var(--color-accent-fg);
    text-decoration: underline;
}

.file-browser .commit-hash {
    font-family: ui-monospace, 'Cascadia Code', monospace;
    font-size: 12px;
    color: var(--color-fg-muted);
    background: var(--color-neutral-muted);
    padding: 2px 6px;
    border-radius: 6px;
    text-decoration: none;
    white-space: nowrap;
    flex-shrink: 0;
    position: relative;
}

.file-browser .commit-hash:hover {
    color: var(--color-accent-fg);
    background: var(--color-accent-subtle);
}

.file-browser .commit-hash::before {
    content: attr(data-hash);
    position: absolute;
    bottom: calc(100% + 8px);
    left: 50%;
    transform: translateX(-50%);
    background: var(--color-canvas-overlay);
    color: var(--color-fg-on-emphasis);
    padding: 6px 10px;
    border-radius: 6px;
    font-size: 11px;
    white-space: nowrap;
    z-index: 1000;
    border: 1px solid var(--color-border-default);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
}

.file-browser .commit-hash:hover::before {
    opacity: 1;
}

.file-browser .commit-hash::after {
    content: '';
    position: absolute;
    bottom: calc(100% + 2px);
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 6px solid transparent;
    border-right: 6px solid transparent;
    border-top: 6px solid var(--color-canvas-overlay);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
}

.file-browser .commit-hash:hover::after {
    opacity: 1;
}

.file-browser .commit-time {
    color: var(--color-fg-muted);
    font-size: 12px;
    white-space: nowrap;
}

.file-browser td:first-child {
    width: 40%;
}

.file-browser td:nth-child(2) {
    width: 45%;
}

.file-browser td:last-child {
    width: 15%;
    text-align: right;
}


/* README rendering - Theme-aware */
.readme-container {
    border: 1px solid var(--color-border-default);
    border-radius: 6px;
    padding: 2rem;
    background: var(--color-canvas-default);
    color: var(--color-fg-default);
}

.readme-header {
    padding-bottom: 0.5rem;
    margin-bottom: 1rem;
    border-bottom: 1px solid var(--color-border-default);
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--color-fg-default);
}

.readme-content {
    line-height: 1.6;
}

.readme-content h1,
.readme-content h2,
.readme-content h3 {
    margin-top: 1.5rem;
    margin-bottom: 1rem;
    font-weight: 600;
    line-height: 1.25;
    color: var(--color-fg-default);
}

.readme-content h1 {
    font-size: 2em;
    padding-bottom: 0.3em;
}

.readme-content h2 {
    font-size: 1.5em;
    padding-bottom: 0.3em;
}

.readme-content code {
    background: var(--color-neutral-muted);
    color: var(--color-fg-default);
    padding: 0.2em 0.4em;
    border-radius: 6px;
    font-family: ui-monospace, monospace;
    font-size: 85%;
}

.readme-content pre {
    background: var(--color-neutral-muted);
    padding: 1rem;
    border-radius: 6px;
    overflow-x: auto;
}

.readme-content pre code {
    background: none;
    padding: 0;
}

/* Lists and directory structures - no borders */
.readme-content ul,
.readme-content ol {
    padding-left: 2em;
    margin: 0.5em 0;
}

.readme-content li {
    margin: 0.25em 0;
    border: none !important;  /* Remove any borders from list items */
}

.readme-content p {
    margin: 1em 0;
    color: var(--color-fg-default);
}

.readme-content a {
    color: var(--color-accent-fg);
}

.readme-content a:hover {
    text-decoration: underline;
}

/* Remove borders from h3, h4, h5, h6 */
.readme-content h3,
.readme-content h4,
.readme-content h5,
.readme-content h6 {
    margin-top: 1.5rem;
    margin-bottom: 1rem;
    font-weight: 600;
    color: var(--color-fg-default);
    border: none !important;  /* No borders for smaller headings */
}

/* Button overrides for theme support */
.btn-outline-primary {
    color: var(--color-accent-fg) !important;
    border-color: var(--color-accent-fg) !important;
    background: transparent !important;
}

.btn-outline-primary:hover {
    color: #ffffff !important;
    background: var(--color-accent-fg) !important;
    border-color: var(--color-accent-fg) !important;
}

[data-theme="dark"] .btn-outline-primary {
    color: var(--scitex-color-06) !important;  /* Light bluish */
    border-color: var(--scitex-color-05) !important;
}

[data-theme="dark"] .btn-outline-primary:hover {
    color: #ffffff !important;
    background: var(--scitex-color-04) !important;
    border-color: var(--scitex-color-04) !important;
}

/* Text muted helper */
.text-muted {
    color: var(--color-fg-muted) !important;
}

/* GitHub-style repo action buttons */
.repo-action-btn {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 5px 12px;
    font-size: 12px;
    font-weight: 500;
    line-height: 20px;
    white-space: nowrap;
    background: var(--color-canvas-default);
    border: 1px solid var(--color-border-default);
    border-radius: 6px;
    color: var(--color-fg-default);
    cursor: pointer;
    transition: all 0.2s ease;
}

/* Fix dropdown positioning */
.btn-group {
    position: relative;
    display: inline-block;
}

.repo-action-btn:hover {
    background: var(--color-neutral-muted);
    border-color: var(--color-fg-muted);
}

.repo-action-btn:active {
    background: var(--color-canvas-default);
    transform: scale(0.97);
}

.repo-action-btn.active {
    background: var(--color-accent-emphasis);
    color: #ffffff;
    border-color: var(--color-accent-emphasis);
}

.repo-action-icon {
    fill: currentColor;
    vertical-align: text-bottom;
}

.repo-action-count {
    display: inline-flex;
    min-width: 20px;
    padding: 0 6px;
    font-size: 12px;
    font-weight: 500;
    background: var(--color-neutral-muted);
    border: 1px solid var(--color-border-default);
    border-radius: 2em;
    margin-left: 2px;
}

/* GitHub-style layout with sidebar on LEFT */
.repo-layout {
    display: grid;
    grid-template-columns: 296px 1fr;  /* Sidebar first, then main content */
    gap: 24px;
    margin-top: 1.5rem;
    transition: grid-template-columns 0.3s ease;
}

.repo-layout.sidebar-collapsed {
    grid-template-columns: 48px 1fr;  /* Collapsed width */
}

.repo-layout.sidebar-expanded {
    grid-template-columns: 380px 1fr;  /* Expanded width - larger than default */
}

.repo-main {
    min-width: 0;
}

.repo-sidebar {
    position: sticky;
    top: 80px;
    align-self: start;
    overflow: hidden;
    transition: all 0.3s ease;
}

.repo-sidebar.collapsed {
    width: 48px;
}

.repo-sidebar.expanded {
    width: 380px;
}

/* Sidebar toggle button */
.sidebar-toggle-btn {
    position: absolute;
    top: 12px;
    right: 12px;
    width: 28px;
    height: 28px;
    border: 1px solid var(--color-border-default);
    border-radius: 6px;
    background: var(--color-canvas-default);
    color: var(--color-fg-muted);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    z-index: 10;
}

.sidebar-toggle-btn:hover {
    background: var(--color-neutral-muted);
    color: var(--color-accent-fg);
    border-color: var(--color-accent-fg);
    transform: scale(1.05);
}

.sidebar-toggle-btn:active {
    transform: scale(0.95);
}

.sidebar-toggle-icon {
    transition: transform 0.3s ease;
    font-size: 14px;
}

.repo-sidebar.collapsed .sidebar-toggle-icon {
    transform: rotate(180deg);
}

/* Sidebar sections */
.sidebar-section {
    border: 1px solid var(--color-border-default);
    border-radius: 6px;
    padding: 16px;
    margin-bottom: 16px;
    background: var(--color-canvas-default);
    position: relative;
    transition: all 0.3s ease;
}

.repo-sidebar.collapsed .sidebar-section {
    padding: 8px;
    border: none;
    background: transparent;
}

.sidebar-section.collapsible {
    cursor: pointer;
}

.sidebar-section.collapsible:hover {
    border-color: var(--color-accent-fg);
    background: var(--color-neutral-muted);
}

.sidebar-section.section-collapsed .sidebar-content {
    display: none;
}

.sidebar-title {
    font-size: 12px;
    font-weight: 600;
    color: var(--color-fg-default);
    text-transform: uppercase;
    margin-bottom: 12px;
    letter-spacing: 0.5px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    transition: all 0.2s ease;
}

.sidebar-title:hover {
    color: var(--color-accent-fg);
}

.repo-sidebar.collapsed .sidebar-title {
    writing-mode: vertical-rl;
    text-orientation: mixed;
    margin: 0;
    font-size: 10px;
}

.sidebar-section-chevron {
    font-size: 10px;
    transition: transform 0.2s ease;
    color: var(--color-fg-muted);
}

.sidebar-section.section-collapsed .sidebar-section-chevron {
    transform: rotate(-90deg);
}

.repo-sidebar.collapsed .sidebar-section-chevron {
    display: none;
}

.sidebar-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 8px;
    font-size: 12px;
    color: var(--color-fg-muted);
    border-radius: 4px;
    transition: all 0.2s ease;
    margin: 2px 0;
}

.sidebar-item:hover {
    background: var(--color-neutral-muted);
    color: var(--color-fg-default);
}

.sidebar-item strong {
    color: var(--color-fg-default);
}

.repo-sidebar.collapsed .sidebar-item {
    display: none;
}

.sidebar-link {
    color: var(--color-accent-fg);
    text-decoration: none;
    font-size: 12px;
    display: block;
    padding: 6px 8px;
    border-radius: 4px;
    transition: all 0.2s ease;
}

.sidebar-link:hover {
    text-decoration: none;
    background: var(--color-neutral-muted);
    color: var(--color-accent-fg);
    transform: translateX(2px);
}

.repo-sidebar.collapsed .sidebar-link {
    display: none;
}

.sidebar-content {
    transition: opacity 0.3s ease;
}

.repo-sidebar.collapsed .sidebar-content {
    opacity: 0;
    display: none;
}

/* File tree styles */
.file-tree-item {
    padding: 4px 6px;
    cursor: pointer;
    color: var(--color-fg-default);
    border-radius: 4px;
    transition: all 0.2s ease;
    margin: 1px 0;
}

.file-tree-item:hover {
    background: var(--color-neutral-muted);
}

.file-tree-item.active {
    background: var(--color-accent-subtle);
    font-weight: 600;
}

.repo-sidebar.collapsed .file-tree-item {
    display: none;
}

.file-tree-folder {
    color: var(--color-fg-default);
    display: flex;
    align-items: center;
    gap: 4px;
    transition: all 0.2s ease;
}

.file-tree-folder:hover {
    color: var(--color-accent-fg);
    transform: translateX(2px);
}

.file-tree-file {
    color: var(--color-fg-muted);
    display: flex;
    align-items: center;
    gap: 4px;
    transition: all 0.2s ease;
}

.file-tree-file:hover {
    color: var(--color-accent-fg);
    transform: translateX(2px);
}

.file-tree-icon {
    width: 16px;
    height: 16px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

.file-tree-icon svg,
.icon-folder,
.icon-file {
    width: 16px;
    height: 16px;
}

.icon-folder,
.file-tree-folder .file-tree-icon {
    color: var(--scitex-color-04);
}

.icon-file,
.file-tree-file .file-tree-icon {
    color: var(--text-secondary);
}
}

.file-tree-chevron {
    width: 12px;
    height: 12px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    color: var(--color-fg-muted);
    transition: transform 0.2s;
    cursor: pointer;
}

.file-tree-chevron.expanded {
    transform: rotate(90deg);
}

.file-tree-children {
    display: none;
}

.file-tree-children.expanded {
    display: block;
}

/* Split button dropdown fix */
.btn-group {
    position: relative;
}

.btn-group .dropdown-menu {
    z-index: 9999 !important;
    background: var(--color-canvas-default);
    border: 1px solid var(--color-border-default);
    border-radius: 6px;
    box-shadow: 0 8px 16px rgba(0,0,0,0.2);
    min-width: 200px;
    position: absolute;
    top: 100%;
    right: 0;
    margin-top: 4px;
}

.btn-group .dropdown-item {
    color: var(--color-fg-default);
    padding: 6px 12px;
    white-space: nowrap;
}

.btn-group .dropdown-item:hover {
    background: var(--color-neutral-muted);
    color: var(--color-fg-default);
}

@media (max-width: 1024px) {
    .repo-layout {
        grid-template-columns: 1fr;
    }

    .repo-layout.sidebar-collapsed,
    .repo-layout.sidebar-expanded {
        grid-template-columns: 1fr;
    }

    .repo-sidebar {
        position: static;
        width: 100% !important;
    }

    .repo-sidebar.collapsed {
        display: none;
    }

    .sidebar-toggle-btn {
        position: fixed;
        top: 80px;
        left: 16px;
        z-index: 1000;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid" style="max-width: 1280px;">
    <!-- Repository Header -->
    <div class="repo-header">
        <div style="display: flex; align-items: center; justify-content: space-between; gap: 1rem;">
            <!-- Left: User / Repo + Branch Selector -->
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <a href="/{{ project.owner.username }}/" style="color: var(--color-accent-fg); text-decoration: none; font-weight: 400;">
                    {{ project.owner.username }}
                </a>
                <span style="color: var(--color-fg-muted);">/</span>
                <a href="/{{ project.owner.username }}/{{ project.slug }}/" class="repo-title">
                    {{ project.name }}
                </a>

                <!-- Branch Selector Dropdown -->
                <div class="btn-group" style="margin-left: 0.5rem;">
                    <button class="repo-action-btn" id="branch-dropdown-btn-header" type="button" onclick="toggleBranchDropdown()">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="display: inline-block; vertical-align: text-bottom;">
                            <path d="M9.5 3.25a2.25 2.25 0 1 1 3 2.122V6A2.5 2.5 0 0 1 10 8.5H6a1 1 0 0 0-1 1v1.128a2.251 2.251 0 1 1-1.5 0V5.372a2.25 2.25 0 1 1 1.5 0v1.836A2.493 2.493 0 0 1 6 7h4a1 1 0 0 0 1-1v-.628A2.25 2.25 0 0 1 9.5 3.25Zm-6 0a.75.75 0 1 0 1.5 0 .75.75 0 0 0-1.5 0Zm8.25-.75a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5ZM4.25 12a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5Z"/>
                        </svg>
                        <span style="font-weight: 600;">develop</span>
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="display: inline-block; vertical-align: text-bottom; margin-left: 4px;">
                            <path d="m4.427 7.427 3.396 3.396a.25.25 0 0 0 .354 0l3.396-3.396A.25.25 0 0 0 11.396 7H4.604a.25.25 0 0 0-.177.427Z"/>
                        </svg>
                    </button>
                    <div class="dropdown-menu" id="branch-dropdown-menu" style="display: none; position: absolute; top: 100%; left: 0; margin-top: 4px; background: var(--color-canvas-default); border: 1px solid var(--color-border-default); border-radius: 6px; box-shadow: 0 8px 16px rgba(0,0,0,0.2); min-width: 250px; z-index: 1000;">
                        <div style="padding: 8px;">
                            <input type="text" placeholder="Find or create a branch..." style="width: 100%; padding: 5px 12px; border: 1px solid var(--color-border-default); border-radius: 6px; background: var(--color-neutral-muted); color: var(--color-fg-default);">
                        </div>
                        <div style="padding: 8px 0; border-top: 1px solid var(--color-border-default);">
                            <div style="padding: 4px 16px; font-size: 12px; font-weight: 600; color: var(--color-fg-muted);">Branches</div>
                            <a href="#" style="display: block; padding: 6px 12px; color: var(--color-fg-default); text-decoration: none; font-size: 14px;" onmouseover="this.style.background='var(--color-canvas-subtle)'" onmouseout="this.style.background='transparent'">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="display: inline-block; vertical-align: text-bottom; margin-right: 4px; color: var(--color-success-fg);">
                                    <path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"/>
                                </svg>
                                <strong>develop</strong> (default)
                            </a>
                            <a href="#" style="display: block; padding: 6px 12px; color: var(--color-fg-default); text-decoration: none; font-size: 14px;" onmouseover="this.style.background='var(--color-canvas-subtle)'" onmouseout="this.style.background='transparent'">main</a>
                        </div>
                    </div>
                </div>

                <!-- Branch/Tags count links (GitHub-style) -->
                <div style="display: flex; gap: 0.5rem; margin-left: 0.5rem;">
                    <a href="/{{ project.owner.username }}/{{ project.slug }}/branches/" style="color: var(--color-fg-muted); text-decoration: none; font-size: 12px; display: flex; align-items: center; gap: 4px;" onmouseover="this.style.color='var(--color-accent-fg)'" onmouseout="this.style.color='var(--color-fg-muted)'">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="display: inline-block; vertical-align: text-bottom;">
                            <path d="M9.5 3.25a2.25 2.25 0 1 1 3 2.122V6A2.5 2.5 0 0 1 10 8.5H6a1 1 0 0 0-1 1v1.128a2.251 2.251 0 1 1-1.5 0V5.372a2.25 2.25 0 1 1 1.5 0v1.836A2.493 2.493 0 0 1 6 7h4a1 1 0 0 0 1-1v-.628A2.25 2.25 0 0 1 9.5 3.25Zm-6 0a.75.75 0 1 0 1.5 0 .75.75 0 0 0-1.5 0Zm8.25-.75a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5ZM4.25 12a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5Z"/>
                        </svg>
                        <strong>1</strong> Branch
                    </a>
                    <a href="/{{ project.owner.username }}/{{ project.slug }}/tags/" style="color: var(--color-fg-muted); text-decoration: none; font-size: 12px; display: flex; align-items: center; gap: 4px;" onmouseover="this.style.color='var(--color-accent-fg)'" onmouseout="this.style.color='var(--color-fg-muted)'">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="display: inline-block; vertical-align: text-bottom;">
                            <path d="M1 7.775V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 0 1 0 2.474l-5.026 5.026a1.75 1.75 0 0 1-2.474 0l-6.25-6.25A1.752 1.752 0 0 1 1 7.775Zm1.5 0c0 .066.026.13.073.177l6.25 6.25a.25.25 0 0 0 .354 0l5.025-5.025a.25.25 0 0 0 0-.354l-6.25-6.25a.25.25 0 0 0-.177-.073H2.75a.25.25 0 0 0-.25.25ZM6 5a1 1 0 1 1 0 2 1 1 0 0 1 0-2Z"/>
                        </svg>
                        <strong>0</strong> Tags
                    </a>
                </div>
            </div>

            <!-- Right: Action Buttons (Watch, Star, Fork) -->
            <div style="display: flex; gap: 0.5rem; align-items: center;">
                <!-- Watch Button -->
                <button class="repo-action-btn" id="watch-btn" onclick="handleWatch(event)">
                    <svg class="repo-action-icon" viewBox="0 0 16 16" width="16" height="16">
                        <path d="M8 2c1.981 0 3.671.992 4.933 2.078 1.27 1.091 2.187 2.345 2.637 3.023a1.62 1.62 0 0 1 0 1.798c-.45.678-1.367 1.932-2.637 3.023C11.67 13.008 9.981 14 8 14c-1.981 0-3.671-.992-4.933-2.078C1.797 10.83.88 9.576.43 8.898a1.62 1.62 0 0 1 0-1.798c.45-.677 1.367-1.931 2.637-3.022C4.33 2.992 6.019 2 8 2ZM1.679 7.932a.12.12 0 0 0 0 .136c.411.622 1.241 1.75 2.366 2.717C5.176 11.758 6.527 12.5 8 12.5c1.473 0 2.825-.742 3.955-1.715 1.124-.967 1.954-2.096 2.366-2.717a.12.12 0 0 0 0-.136c-.412-.621-1.242-1.75-2.366-2.717C10.824 4.242 9.473 3.5 8 3.5c-1.473 0-2.825.742-3.955 1.715-1.124.967-1.954 2.096-2.366 2.717ZM8 10a2 2 0 1 1-.001-3.999A2 2 0 0 1 8 10Z"></path>
                    </svg>
                    <span>Watch</span>
                    <span class="repo-action-count" id="watch-count">0</span>
                </button>

                <!-- Star Button -->
                <button class="repo-action-btn" id="star-btn" onclick="handleStar(event)">
                    <svg class="repo-action-icon" viewBox="0 0 16 16" width="16" height="16">
                        <path d="M8 .25a.75.75 0 0 1 .673.418l1.882 3.815 4.21.612a.75.75 0 0 1 .416 1.279l-3.046 2.97.719 4.192a.751.751 0 0 1-1.088.791L8 12.347l-3.766 1.98a.75.75 0 0 1-1.088-.79l.72-4.194L.818 6.374a.75.75 0 0 1 .416-1.28l4.21-.611L7.327.668A.75.75 0 0 1 8 .25Z"></path>
                    </svg>
                    <span>Star</span>
                    <span class="repo-action-count" id="star-count">0</span>
                </button>

                <!-- Fork Button -->
                <button class="repo-action-btn" id="fork-btn" onclick="handleFork(event)">
                    <svg class="repo-action-icon" viewBox="0 0 16 16" width="16" height="16">
                        <path d="M5 5.372v.878c0 .414.336.75.75.75h4.5a.75.75 0 0 0 .75-.75v-.878a2.25 2.25 0 1 1 1.5 0v.878a2.25 2.25 0 0 1-2.25 2.25h-1.5v2.128a2.251 2.251 0 1 1-1.5 0V8.5h-1.5A2.25 2.25 0 0 1 3.5 6.25v-.878a2.25 2.25 0 1 1 1.5 0ZM5 3.25a.75.75 0 1 0-1.5 0 .75.75 0 0 0 1.5 0Zm6.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Zm-3 8.75a.75.75 0 1 0-1.5 0 .75.75 0 0 0 1.5 0Z"></path>
                    </svg>
                    <span>Fork</span>
                    <span class="repo-action-count" id="fork-count">0</span>
                </button>
            </div>
        </div>
        {% if project.description %}
        <div class="repo-description">{{ project.description }}</div>
        {% endif %}
    </div>

    
    <!-- Repository Tab Navigation (GitHub-style) -->
    <div class="repo-tabs" style="display: flex; justify-content: space-between; align-items: center; margin-top: 0;">
        <div class="scitex-tabs" style="display: flex; gap: 1.5rem;">
            <!-- <a href="/{{ project.owner.username }}/{{ project.slug }}/"
             !--    class="scitex-tab scitex-tab-active">
             !--     <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="display: inline-block; vertical-align: text-bottom;">
             !--         <path d="M2 2.5A2.5 2.5 0 0 1 4.5 0h8.75a.75.75 0 0 1 .75.75v12.5a.75.75 0 0 1-.75.75h-2.5a.75.75 0 0 1 0-1.5h1.75v-2h-8a1 1 0 0 0-.714 1.7.75.75 0 1 1-1.072 1.05A2.495 2.495 0 0 1 2 11.5Zm10.5-1h-8a1 1 0 0 0-1 1v6.708A2.486 2.486 0 0 1 4.5 9h8ZM5 12.25a.25.25 0 0 1 .25-.25h3.5a.25.25 0 0 1 .25.25v3.25a.25.25 0 0 1-.4.2l-1.45-1.087a.249.249 0 0 0-.3 0L5.4 15.7a.25.25 0 0 1-.4-.2Z"/>
             !--     </svg>
             !--     Code
             !-- </a> -->
            <a href="/{{ project.owner.username }}/{{ project.slug }}/issues/"
               class="scitex-tab"
               title="Track issues and bugs">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="display: inline-block; vertical-align: text-bottom;">
                    <path d="M8 9.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z"/>
                    <path d="M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0ZM1.5 8a6.5 6.5 0 1 0 13 0 6.5 6.5 0 0 0-13 0Z"/>
                </svg>
                Issues
            </a>
            <a href="/{{ project.owner.username }}/{{ project.slug }}/pulls/"
               class="scitex-tab"
               title="Review code changes">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="display: inline-block; vertical-align: text-bottom;">
                    <path d="M1.5 3.25a2.25 2.25 0 1 1 3 2.122v5.256a2.251 2.251 0 1 1-1.5 0V5.372A2.25 2.25 0 0 1 1.5 3.25Zm5.677-.177L9.573.677A.25.25 0 0 1 10 .854V2.5h1A2.5 2.5 0 0 1 13.5 5v5.628a2.251 2.251 0 1 1-1.5 0V5a1 1 0 0 0-1-1h-1v1.646a.25.25 0 0 1-.427.177L7.177 3.427a.25.25 0 0 1 0-.354ZM3.75 2.5a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5Zm0 9.5a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5Zm8.25.75a.75.75 0 1 0 1.5 0 .75.75 0 0 0-1.5 0Z"/>
                </svg>
                Pull requests
            </a>
            <a href="/{{ project.owner.username }}/{{ project.slug }}/settings/"
               class="scitex-tab"
               title="Repository settings">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="display: inline-block; vertical-align: text-bottom;">
                    <path d="M8 0a8.2 8.2 0 0 1 .701.031C9.444.095 9.99.645 10.16 1.29l.288 1.107c.018.066.079.158.212.224.231.114.454.243.668.386.123.082.233.09.299.071l1.103-.303c.644-.176 1.392.021 1.82.63.27.385.506.792.704 1.218.315.675.111 1.422-.364 1.891l-.814.806c-.049.048-.098.147-.088.294.016.257.016.515 0 .772-.01.147.038.246.088.294l.814.806c.475.469.679 1.216.364 1.891a7.977 7.977 0 0 1-.704 1.217c-.428.61-1.176.807-1.82.63l-1.102-.302c-.067-.019-.177-.011-.3.071a5.909 5.909 0 0 1-.668.386c-.133.066-.194.158-.211.224l-.29 1.106c-.168.646-.715 1.196-1.458 1.26a8.006 8.006 0 0 1-1.402 0c-.743-.064-1.289-.614-1.458-1.26l-.289-1.106c-.018-.066-.079-.158-.212-.224a5.738 5.738 0 0 1-.668-.386c-.123-.082-.233-.09-.299-.071l-1.103.303c-.644.176-1.392-.021-1.82-.63a8.12 8.12 0 0 1-.704-1.218c-.315-.675-.111-1.422.363-1.891l.815-.806c.05-.048.098-.147.088-.294a6.214 6.214 0 0 1 0-.772c.01-.147-.038-.246-.088-.294l-.815-.806C.635 6.045.431 5.298.746 4.623a7.92 7.92 0 0 1 .704-1.217c.428-.61 1.176-.807 1.82-.63l1.102.302c.067.019.177.011.3-.071.214-.143.437-.272.668-.386.133-.066.194-.158.211-.224l.29-1.106C6.009.645 6.556.095 7.299.03 7.53.01 7.764 0 8 0Zm-.571 1.525c-.036.003-.108.036-.137.146l-.289 1.105c-.147.561-.549.967-.998 1.189-.173.086-.36.159-.558.217-.473.138-.96.072-1.384-.234l-1.103-.303c-.109-.03-.175.016-.195.045-.22.312-.412.644-.573.99-.014.031-.021.11.059.19l.815.806c.411.406.562.957.53 1.456a4.709 4.709 0 0 0 0 .582c.032.499-.119 1.05-.53 1.456l-.815.806c-.081.08-.073.159-.059.19.162.346.353.677.573.989.02.03.085.076.195.046l1.102-.303c.424-.306.91-.372 1.383-.234.198.058.386.131.559.217.449.222.851.628.998 1.189l.289 1.105c.029.109.101.143.137.146a6.6 6.6 0 0 0 1.142 0c.036-.003.108-.036.137-.146l.289-1.105c.147-.561.549-.967.998-1.189.173-.086.36-.159.558-.217.473-.138.96-.072 1.384.234l1.103.303c.109.029.175-.016.195-.045.22-.313.411-.644.573-.990.014-.031.021-.11-.059-.19l-.815-.806c-.411-.406-.562-.957-.53-1.456a4.709 4.709 0 0 0 0-.582c-.032-.499.119-1.05.53-1.456l.815-.806c.081-.08.073-.159.059-.19a6.464 6.464 0 0 0-.573-.989c-.02-.03-.085-.076-.195-.046l-1.102.303c-.424.306-.91.372-1.383.234a4.97 4.97 0 0 0-.559-.217c-.449-.222-.851-.628-.998-1.189l-.289-1.105c-.029-.11-.101-.143-.137-.146a6.6 6.6 0 0 0-1.142 0ZM11 8a3 3 0 1 1-6 0 3 3 0 0 1 6 0ZM9.5 8a1.5 1.5 0 1 0-3.001.001A1.5 1.5 0 0 0 9.5 8Z"/>
                </svg>
                Settings
            </a>
        </div>
    </div>


    <!-- Toolbar: Add File + Actions (GitHub-style) -->
    <div style="display: flex; gap: 0.5rem; align-items: center; padding: 1rem 0; border-bottom: 1px solid var(--color-border-default);">
        <!-- Go to file search (GitHub-style) -->
        <div style="position: relative;">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--color-fg-muted); pointer-events: none;">
                <path d="M10.68 11.74a6 6 0 0 1-7.922-8.982 6 6 0 0 1 8.982 7.922l3.04 3.04a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215ZM11.5 7a4.5 4.5 0 1 0-8.999.001A4.5 4.5 0 0 0 11.5 7Z"/>
            </svg>
            <input type="text"
                   placeholder="Go to file"
                   id="goto-file-input"
                   style="padding: 5px 12px 5px 32px; border: 1px solid var(--color-border-default); border-radius: 6px; background: var(--color-canvas-default); color: var(--color-fg-default); font-size: 14px; width: 180px; transition: all 0.2s;"
                   onfocus="this.style.borderColor='var(--color-accent-fg)'; this.style.width='250px';"
                   onblur="this.style.borderColor='var(--color-border-default)'; this.style.width='180px';">
        </div>

        <div style="flex: 1;"></div>

        <!-- Add File Dropdown -->
        <div class="btn-group">
            <button class="repo-action-btn" id="add-file-btn" type="button" onclick="toggleAddFileDropdown()">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="display: inline-block; vertical-align: text-bottom;">
                    <path d="M7.75 2a.75.75 0 0 1 .75.75V7h4.25a.75.75 0 0 1 0 1.5H8.5v4.25a.75.75 0 0 1-1.5 0V8.5H2.75a.75.75 0 0 1 0-1.5H7V2.75A.75.75 0 0 1 7.75 2Z"/>
                </svg>
                Add file
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="display: inline-block; vertical-align: text-bottom; margin-left: 4px;">
                    <path d="m4.427 7.427 3.396 3.396a.25.25 0 0 0 .354 0l3.396-3.396A.25.25 0 0 0 11.396 7H4.604a.25.25 0 0 0-.177.427Z"/>
                </svg>
            </button>
            <div class="dropdown-menu" id="add-file-dropdown" style="display: none; position: absolute; top: 100%; right: 0; margin-top: 4px; background: var(--color-canvas-default); border: 1px solid var(--color-border-default); border-radius: 6px; box-shadow: 0 8px 16px rgba(0,0,0,0.2); min-width: 200px; z-index: 1000;">
                <a href="/{{ project.owner.username }}/{{ project.slug }}/new-file/" class="dropdown-item" style="display: block; padding: 6px 12px; color: var(--color-fg-default); text-decoration: none;" onmouseover="this.style.background='var(--color-canvas-subtle)'" onmouseout="this.style.background='transparent'">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="display: inline-block; vertical-align: text-bottom; margin-right: 4px;">
                        <path d="M2 1.75C2 .784 2.784 0 3.75 0h6.586c.464 0 .909.184 1.237.513l2.914 2.914c.329.328.513.773.513 1.237v9.586A1.75 1.75 0 0 1 13.25 16h-9.5A1.75 1.75 0 0 1 2 14.25Zm1.75-.25a.25.25 0 0 0-.25.25v12.5c0 .138.112.25.25.25h9.5a.25.25 0 0 0 .25-.25V6h-2.75A1.75 1.75 0 0 1 9 4.25V1.5Zm6.75.062V4.25c0 .138.112.25.25.25h2.688l-.011-.013-2.914-2.914-.013-.011Z"/>
                    </svg>
                    Create new file
                </a>
                <a href="/{{ project.owner.username }}/{{ project.slug }}/upload/" class="dropdown-item" style="display: block; padding: 6px 12px; color: var(--color-fg-default); text-decoration: none;" onmouseover="this.style.background='var(--color-canvas-subtle)'" onmouseout="this.style.background='transparent'">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="display: inline-block; vertical-align: text-bottom; margin-right: 4px;">
                        <path d="M2.75 14A1.75 1.75 0 0 1 1 12.25v-2.5a.75.75 0 0 1 1.5 0v2.5c0 .138.112.25.25.25h10.5a.25.25 0 0 0 .25-.25v-2.5a.75.75 0 0 1 1.5 0v2.5A1.75 1.75 0 0 1 13.25 14Z"/>
                        <path d="M11.78 4.72a.749.749 0 1 1-1.06 1.06L8.75 3.811V9.5a.75.75 0 0 1-1.5 0V3.811L5.28 5.78a.749.749 0 1 1-1.06-1.06l3.25-3.25a.749.749 0 0 1 1.06 0l3.25 3.25Z"/>
                    </svg>
                    Upload files
                </a>
            </div>
        </div>

        <!-- Copy Concatenated Text Button -->
        <div class="btn-group" style="margin: 0;">
            <button onclick="copyProjectToClipboard()" class="repo-action-btn" id="copy-project-btn">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="display: inline-block; vertical-align: text-bottom;">
                    <path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"/>
                    <path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"/>
                </svg>
                Copy
            </button>
            <button class="repo-action-btn dropdown-toggle-split" type="button" onclick="toggleCopyDropdown()">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="display: inline-block; vertical-align: text-bottom;">
                    <path d="m4.427 7.427 3.396 3.396a.25.25 0 0 0 .354 0l3.396-3.396A.25.25 0 0 0 11.396 7H4.604a.25.25 0 0 0-.177.427Z"/>
                </svg>
            </button>
            <div class="dropdown-menu" id="copy-dropdown" style="display: none; position: absolute; top: 100%; right: 0; margin-top: 4px; background: var(--color-canvas-default); border: 1px solid var(--color-border-default); border-radius: 6px; box-shadow: 0 8px 16px rgba(0,0,0,0.2); min-width: 250px; z-index: 1000;">
                <a href="#" class="dropdown-item" onclick="event.preventDefault(); copyProjectToClipboard();" style="display: block; padding: 6px 12px; color: var(--color-fg-default); text-decoration: none;" onmouseover="this.style.background='var(--color-canvas-subtle)'" onmouseout="this.style.background='transparent'">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="display: inline-block; vertical-align: text-bottom; margin-right: 4px;">
                        <path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"/>
                        <path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"/>
                    </svg>
                    Copy concatenated text
                </a>
                <a href="#" class="dropdown-item" onclick="event.preventDefault(); downloadProjectAsFile();" style="display: block; padding: 6px 12px; color: var(--color-fg-default); text-decoration: none;" onmouseover="this.style.background='var(--color-canvas-subtle)'" onmouseout="this.style.background='transparent'">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="display: inline-block; vertical-align: text-bottom; margin-right: 4px;">
                        <path d="M2.75 14A1.75 1.75 0 0 1 1 12.25v-2.5a.75.75 0 0 1 1.5 0v2.5c0 .138.112.25.25.25h10.5a.25.25 0 0 0 .25-.25v-2.5a.75.75 0 0 1 1.5 0v2.5A1.75 1.75 0 0 1 13.25 14Z"/>
                        <path d="M7.25 7.689V2a.75.75 0 0 1 1.5 0v5.689l1.97-1.969a.749.749 0 1 1 1.06 1.06l-3.25 3.25a.749.749 0 0 1-1.06 0L4.22 6.78a.749.749 0 1 1 1.06-1.06l1.97 1.969Z"/>
                    </svg>
                    Download concatenated text
                </a>
            </div>
        </div>
    </div>
    
    <!-- Main Content Area (No Sidebar) -->
    <div class="repo-layout" id="repo-layout" style="display: block;">
        <!-- <\!-- Main Content (Full Width) -\->
         !--     <div class="sidebar-section collapsible" id="about-section">
         !--         <div class="sidebar-title" onclick="toggleSidebarSection('about-section')">
         !--             <span>About</span>
         !--             <span class="sidebar-section-chevron">â–¼</span>
         !--         </div>
         !--         <div class="sidebar-content">
         !--             {% if project.description %}
         !--             <p style="font-size: 12px; color: var(--color-fg-default); margin-bottom: 12px;">
         !--                 {{ project.description }}
         !--             </p>
         !--             {% endif %}
         !--             <div class="sidebar-item">
         !--                 <i class="fas fa-user" style="color: var(--color-fg-muted);"></i>
         !--                 <a href="/{{ project.owner.username }}/" class="sidebar-link" style="padding: 0;">{{ project.owner.username }}</a>
         !--             </div>
         !--             <div class="sidebar-item">
         !--                 <i class="fas fa-calendar" style="color: var(--color-fg-muted);"></i>
         !--                 <span>Created {{ project.created_at|date:"M j, Y" }}</span>
         !--             </div>
         !--             <div class="sidebar-item">
         !--                 <i class="fas fa-clock" style="color: var(--color-fg-muted);"></i>
         !--                 <span>Updated {{ project.updated_at|date:"M j, Y" }}</span>
         !--             </div>
         !--         </div>
         !--     </div> -->
        </aside>

        <!-- Main Content (RIGHT side) -->
        <div class="repo-main">
            <!-- Empty State with Create from Template button -->
            {% if not directories and not files and not readme_html %}
            <div class="readme-container" style="text-align: center; padding: 3rem 2rem;">
                <h3 style="color: var(--color-fg-default); margin-bottom: 1rem;">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="24" height="24" style="display: inline-block; vertical-align: text-bottom; margin-right: 8px;">
                        <path fill="currentColor" d="M1.75 1A1.75 1.75 0 0 0 0 2.75v10.5C0 14.216.784 15 1.75 15h12.5A1.75 1.75 0 0 0 16 13.25v-8.5A1.75 1.75 0 0 0 14.25 3H7.5a.25.25 0 0 1-.2-.1l-.9-1.2C6.07 1.26 5.55 1 5 1H1.75Z"></path>
                    </svg>
                    Empty Project
                </h3>
                <p style="color: var(--color-fg-muted); margin-bottom: 2rem;">
                    This project doesn't have any files yet. Get started by creating a template structure or uploading your files.
                </p>
                <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                    <form method="POST" action="/{{ project.owner.username }}/{{ project.slug }}/create-from-template/" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-primary">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="display: inline-block; vertical-align: text-bottom; margin-right: 4px;">
                                <path d="M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0ZM1.5 8a6.5 6.5 0 1 0 13 0 6.5 6.5 0 0 0-13 0Zm7.25-3.25v2.992l2.028.812a.75.75 0 0 1-.557 1.392l-2.5-1A.751.751 0 0 1 7.25 8V4.75a.75.75 0 0 1 1.5 0Z"/>
                            </svg>
                            Create from Template
                        </button>
                    </form>
                    <a href="/{{ project.owner.username }}/{{ project.slug }}/settings/" class="btn btn-outline-primary">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="display: inline-block; vertical-align: text-bottom; margin-right: 4px;">
                            <path d="M8 0a8.2 8.2 0 0 1 .701.031C9.444.095 9.99.645 10.16 1.29l.288 1.107c.018.066.079.158.212.224.231.114.454.243.668.386.123.082.233.09.299.071l1.103-.303c.644-.176 1.392.021 1.82.63.27.385.506.792.704 1.218.315.675.111 1.422-.364 1.891l-.814.806c-.049.048-.098.147-.088.294.016.257.016.515 0 .772-.01.147.038.246.088.294l.814.806c.475.469.679 1.216.364 1.891a7.977 7.977 0 0 1-.704 1.217c-.428.61-1.176.807-1.82.63l-1.102-.302c-.067-.019-.177-.011-.3.071a5.909 5.909 0 0 1-.668.386c-.133.066-.194.158-.211.224l-.29 1.106c-.168.646-.715 1.196-1.458 1.26a8.006 8.006 0 0 1-1.402 0c-.743-.064-1.289-.614-1.458-1.26l-.289-1.106c-.018-.066-.079-.158-.212-.224a5.738 5.738 0 0 1-.668-.386c-.123-.082-.233-.09-.299-.071l-1.103.303c-.644.176-1.392-.021-1.82-.63a8.12 8.12 0 0 1-.704-1.218c-.315-.675-.111-1.422.363-1.891l.815-.806c.05-.048.098-.147.088-.294a6.214 6.214 0 0 1 0-.772c.01-.147-.038-.246-.088-.294l-.815-.806C.635 6.045.431 5.298.746 4.623a7.92 7.92 0 0 1 .704-1.217c.428-.61 1.176-.807 1.82-.63l1.102.302c.067.019.177.011.3-.071.214-.143.437-.272.668-.386.133-.066.194-.158.211-.224l.29-1.106C6.009.645 6.556.095 7.299.03 7.53.01 7.764 0 8 0Zm-.571 1.525c-.036.003-.108.036-.137.146l-.289 1.105c-.147.561-.549.967-.998 1.189-.173.086-.36.159-.558.217-.473.138-.96.072-1.384-.234l-1.103-.303c-.109-.03-.175.016-.195.045-.22.312-.412.644-.573.99-.014.031-.021.11.059.19l.815.806c.411.406.562.957.53 1.456a4.709 4.709 0 0 0 0 .582c.032.499-.119 1.05-.53 1.456l-.815.806c-.081.08-.073.159-.059.19.162.346.353.677.573.989.02.03.085.076.195.046l1.102-.303c.424-.306.91-.372 1.383-.234.198.058.386.131.559.217.449.222.851.628.998 1.189l.289 1.105c.029.109.101.143.137.146a6.6 6.6 0 0 0 1.142 0c.036-.003.108-.036.137-.146l.289-1.105c.147-.561.549-.967.998-1.189.173-.086.36-.159.558-.217.473-.138.96-.072 1.384.234l1.103.303c.109.029.175-.016.195-.045.22-.313.411-.644.573-.990.014-.031.021-.11-.059-.19l-.815-.806c-.411-.406-.562-.957-.53-1.456a4.709 4.709 0 0 0 0-.582c-.032-.499.119-1.05.53-1.456l.815-.806c.081-.08.073-.159.059-.19a6.464 6.464 0 0 0-.573-.989c-.02-.03-.085-.076-.195-.046l-1.102.303c-.424.306-.91.372-1.383.234a4.97 4.97 0 0 0-.559-.217c-.449-.222-.851-.628-.998-1.189l-.289-1.105c-.029-.11-.101-.143-.137-.146a6.6 6.6 0 0 0-1.142 0ZM11 8a3 3 0 1 1-6 0 3 3 0 0 1 6 0ZM9.5 8a1.5 1.5 0 1 0-3.001.001A1.5 1.5 0 0 0 9.5 8Z"/>
                        </svg>
                        Project Settings
                    </a>
                </div>
                <p style="color: var(--color-fg-muted); margin-top: 2rem; font-size: 0.875rem;">
                    The template will create a complete SciTeX research project structure with directories for scripts, data, docs, results, and configuration files.
                </p>
            </div>
            {% endif %}

            <!-- File Browser - GitHub Style -->
            {% if directories or files %}
            <div class="file-browser" style="border: 1px solid var(--color-border-default); border-radius: 6px; overflow: hidden;">
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Last commit message</th>
                            <th>Last commit date</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for dir in directories %}
                        <tr data-href="/{{ project.owner.username }}/{{ project.slug }}/{{ dir.path }}/" class="clickable-row">
                            <td>
                                <a href="/{{ project.owner.username }}/{{ project.slug }}/{{ dir.path }}/" class="file-name" onclick="event.stopPropagation();">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" class="icon-folder"><path fill="currentColor" d="M1.75 1A1.75 1.75 0 0 0 0 2.75v10.5C0 14.216.784 15 1.75 15h12.5A1.75 1.75 0 0 0 16 13.25v-8.5A1.75 1.75 0 0 0 14.25 3H7.5a.25.25 0 0 1-.2-.1l-.9-1.2C6.07 1.26 5.55 1 5 1H1.75Z"></path></svg>
                                    {{ dir.name }}
                                </a>
                            </td>
                            <td class="commit-message">
                                {% if dir.message %}
                                    {% if dir.hash %}
                                        <a href="/{{ project.owner.username }}/{{ project.slug }}/commit/{{ dir.hash }}/" onclick="event.stopPropagation();" title="{{ dir.message }}">{{ dir.message }}</a>
                                        <a href="/{{ project.owner.username }}/{{ project.slug }}/commit/{{ dir.hash }}/" class="commit-hash" data-hash="{{ dir.hash }}" onclick="event.stopPropagation();">{{ dir.hash|slice:":7" }}</a>
                                    {% else %}
                                        {{ dir.message }}
                                    {% endif %}
                                {% else %}
                                    <span style="color: var(--color-fg-muted);">No commit message</span>
                                {% endif %}
                            </td>
                            <td class="commit-time">
                                {% if dir.time_ago %}{{ dir.time_ago }}{% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                        {% for file in files %}
                        <tr data-href="/{{ project.owner.username }}/{{ project.slug }}/blob/{{ file.path }}" class="clickable-row">
                            <td>
                                <a href="/{{ project.owner.username }}/{{ project.slug }}/blob/{{ file.path }}" class="file-name" onclick="event.stopPropagation();">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" class="icon-file"><path fill="currentColor" d="M2 1.75C2 .784 2.784 0 3.75 0h6.586c.464 0 .909.184 1.237.513l2.914 2.914c.329.328.513.773.513 1.237v9.586A1.75 1.75 0 0 1 13.25 16h-9.5A1.75 1.75 0 0 1 2 14.25Zm1.75-.25a.25.25 0 0 0-.25.25v12.5c0 .138.112.25.25.25h9.5a.25.25 0 0 0 .25-.25V6h-2.75A1.75 1.75 0 0 1 9 4.25V1.5Zm6.75.062V4.25c0 .138.112.25.25.25h2.688l-.011-.013-2.914-2.914-.013-.011Z"></path></svg>
                                    {{ file.name }}
                                </a>
                            </td>
                            <td class="commit-message">
                                {% if file.message %}
                                    {% if file.hash %}
                                        <a href="/{{ project.owner.username }}/{{ project.slug }}/commit/{{ file.hash }}/" onclick="event.stopPropagation();" title="{{ file.message }}">{{ file.message }}</a>
                                        <a href="/{{ project.owner.username }}/{{ project.slug }}/commit/{{ file.hash }}/" class="commit-hash" data-hash="{{ file.hash }}" onclick="event.stopPropagation();">{{ file.hash|slice:":7" }}</a>
                                    {% else %}
                                        {{ file.message }}
                                    {% endif %}
                                {% else %}
                                    <span style="color: var(--color-fg-muted);">No commit message</span>
                                {% endif %}
                            </td>
                            <td class="commit-time">
                                {% if file.time_ago %}{{ file.time_ago }}{% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}

            <!-- README.md -->
            {% if readme_html %}
            <div class="readme-container">
                <div class="readme-header">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="display: inline-block; vertical-align: text-bottom;">
                        <path d="M0 1.75C0 .784.784 0 1.75 0h12.5C15.216 0 16 .784 16 1.75v12.5A1.75 1.75 0 0 1 14.25 16H1.75A1.75 1.75 0 0 1 0 14.25Zm1.75-.25a.25.25 0 0 0-.25.25v12.5c0 .138.112.25.25.25h12.5a.25.25 0 0 0 .25-.25V1.75a.25.25 0 0 0-.25-.25Zm6.5 3.5v8.2a.2.2 0 0 1-.2.2H3.3a.2.2 0 0 1-.2-.2V11h.7c.2 0 .4-.1.5-.2l.5-.5a.8.8 0 0 1 .6-.2h1.2V5h-1c-.3 0-.5-.2-.5-.5v-.5c0-.3.2-.5.5-.5h3.5c.3 0 .5.2.5.5v.5c0 .3-.2.5-.5.5Z"/>
                    </svg>
                    README.md
                </div>
                <div class="readme-content">
                    {{ readme_html|safe }}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
// Sidebar state management
const SIDEBAR_STATE_KEY = 'scitex-sidebar-state';
const SIDEBAR_SECTIONS_KEY = 'scitex-sidebar-sections';

// Initialize sidebar state from localStorage
function initializeSidebar() {
    const sidebar = document.getElementById('repo-sidebar');
    const repoLayout = document.getElementById('repo-layout');
    const savedState = localStorage.getItem(SIDEBAR_STATE_KEY);

    console.log('Initializing sidebar. Saved state:', savedState);

    // Always start collapsed by default (per GitHub style), ignore saved state initially
    sidebar.classList.add('collapsed');
    repoLayout.classList.add('sidebar-collapsed');
    console.log('Sidebar initialized as collapsed (default)');

    // Clear the expanded state if it was saved
    if (savedState === 'expanded') {
        localStorage.setItem(SIDEBAR_STATE_KEY, 'collapsed');
    }

    // Restore section states
    const savedSections = localStorage.getItem(SIDEBAR_SECTIONS_KEY);
    if (savedSections) {
        try {
            const sections = JSON.parse(savedSections);
            Object.keys(sections).forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section && sections[sectionId] === 'collapsed') {
                    section.classList.add('section-collapsed');
                }
            });
        } catch (e) {
            console.error('Error restoring section states:', e);
        }
    }
}

// Toggle entire sidebar
function toggleSidebar() {
    const sidebar = document.getElementById('repo-sidebar');
    const repoLayout = document.getElementById('repo-layout');

    if (sidebar.classList.contains('collapsed')) {
        // Expand sidebar
        sidebar.classList.remove('collapsed');
        sidebar.classList.add('expanded');
        repoLayout.classList.remove('sidebar-collapsed');
        repoLayout.classList.add('sidebar-expanded');
        localStorage.setItem(SIDEBAR_STATE_KEY, 'expanded');
        console.log('Sidebar expanded');
    } else {
        // Collapse sidebar
        sidebar.classList.remove('expanded');
        sidebar.classList.add('collapsed');
        repoLayout.classList.remove('sidebar-expanded');
        repoLayout.classList.add('sidebar-collapsed');
        localStorage.setItem(SIDEBAR_STATE_KEY, 'collapsed');
        console.log('Sidebar collapsed');
    }
}

// Toggle individual sidebar section
function toggleSidebarSection(sectionId) {
    const sidebar = document.getElementById('repo-sidebar');

    // Don't toggle sections when sidebar is collapsed
    if (sidebar.classList.contains('collapsed')) {
        return;
    }

    const section = document.getElementById(sectionId);
    if (!section) return;

    section.classList.toggle('section-collapsed');

    // Save section states
    saveSectionStates();
}

// Save all section states to localStorage
function saveSectionStates() {
    const sections = {
        'file-tree-section': document.getElementById('file-tree-section').classList.contains('section-collapsed') ? 'collapsed' : 'expanded',
        'about-section': document.getElementById('about-section').classList.contains('section-collapsed') ? 'collapsed' : 'expanded'
    };
    localStorage.setItem(SIDEBAR_SECTIONS_KEY, JSON.stringify(sections));
}

// Build file tree for sidebar
async function loadFileTree() {
    try {
        const response = await fetch('/{{ project.owner.username }}/{{ project.slug }}/api/file-tree/');
        const data = await response.json();

        if (data.success) {
            const treeContainer = document.getElementById('file-tree');
            treeContainer.innerHTML = buildTreeHTML(data.tree, '{{ project.owner.username }}', '{{ project.slug }}');
        } else {
            document.getElementById('file-tree').innerHTML = '<div style="color: var(--color-fg-muted); padding: 0.5rem;">Error loading file tree</div>';
        }
    } catch (err) {
        console.error('Failed to load file tree:', err);
        document.getElementById('file-tree').innerHTML = '<div style="color: var(--color-fg-muted); padding: 0.5rem;">Error loading file tree</div>';
    }
}

function buildTreeHTML(items, username, slug, level = 0) {
    let html = '';
    const indent = level * 16;
    const currentPath = window.location.pathname;

    items.forEach((item, index) => {
        const itemPath = `/${username}/${slug}/${item.path}${item.type === 'directory' ? '/' : ''}`;
        const isActive = currentPath.includes(item.path);
        const icon = item.type === 'directory' ? '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" class="icon-folder"><path fill="currentColor" d="M1.75 1A1.75 1.75 0 0 0 0 2.75v10.5C0 14.216.784 15 1.75 15h12.5A1.75 1.75 0 0 0 16 13.25v-8.5A1.75 1.75 0 0 0 14.25 3H7.5a.25.25 0 0 1-.2-.1l-.9-1.2C6.07 1.26 5.55 1 5 1H1.75Z"></path></svg>' : '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" class="icon-file"><path fill="currentColor" d="M2 1.75C2 .784 2.784 0 3.75 0h6.586c.464 0 .909.184 1.237.513l2.914 2.914c.329.328.513.773.513 1.237v9.586A1.75 1.75 0 0 1 13.25 16h-9.5A1.75 1.75 0 0 1 2 14.25Zm1.75-.25a.25.25 0 0 0-.25.25v12.5c0 .138.112.25.25.25h9.5a.25.25 0 0 0 .25-.25V6h-2.75A1.75 1.75 0 0 1 9 4.25V1.5Zm6.75.062V4.25c0 .138.112.25.25.25h2.688l-.011-.013-2.914-2.914-.013-.011Z"></path></svg>';
        const hasChildren = item.children && item.children.length > 0;
        const itemId = `tree-${item.path.replace(/\//g, '-')}`;  // Unique ID based on path

        // Item row
        html += `<div class="file-tree-item ${isActive ? 'active' : ''}" style="padding-left: ${indent}px;">`;

        if (item.type === 'directory') {
            html += `<a href="${itemPath}" class="file-tree-folder" style="text-decoration: none; color: var(--color-fg-default);">`;

            // Chevron for folders with children
            if (hasChildren) {
                html += `<span class="file-tree-chevron ${level === 0 ? 'expanded' : ''}" onclick="toggleFolder('${itemId}'); return false;">â–¸</span>`;
            } else {
                html += `<span style="width: 12px; display: inline-block;"></span>`;
            }

            html += `<span class="file-tree-icon">${icon}</span><span>${item.name}</span>`;
            html += `</a>`;
        } else {
            html += `<a href="/${username}/${slug}/blob/${item.path}" class="file-tree-file" style="text-decoration: none; color: var(--color-fg-muted);">`;
            html += `<span style="width: 12px; display: inline-block;"></span>`;
            html += `<span class="file-tree-icon">${icon}</span><span>${item.name}</span>`;
            html += `</a>`;
        }

        html += `</div>`;

        // Children container - render ALL children
        if (hasChildren) {
            const isExpanded = level === 0;  // Auto-expand root level only
            html += `<div id="${itemId}" class="file-tree-children ${isExpanded ? 'expanded' : ''}">`;
            html += buildTreeHTML(item.children, username, slug, level + 1);  // Recursively build all children
            html += `</div>`;
        }
    });

    return html;
}

function toggleFolder(folderId) {
    const folder = document.getElementById(folderId);
    const chevron = event.target;

    if (folder.classList.contains('expanded')) {
        folder.classList.remove('expanded');
        chevron.classList.remove('expanded');
    } else {
        folder.classList.add('expanded');
        chevron.classList.add('expanded');
    }

    event.stopPropagation();
    event.preventDefault();
}

// Load file tree on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('Page loaded - initializing sidebar, file tree and dropdown');

    // Initialize sidebar state
    initializeSidebar();

    // Load file tree
    loadFileTree();

    // Make table rows clickable
    const clickableRows = document.querySelectorAll('.clickable-row');
    clickableRows.forEach(row => {
        row.addEventListener('click', function(e) {
            // Don't navigate if clicking on a link directly
            if (e.target.tagName === 'A' || e.target.closest('a')) {
                return;
            }
            const href = this.getAttribute('data-href');
            if (href) {
                window.location.href = href;
            }
        });
    });

    // Manual dropdown toggle for split button
    const dropdownToggle = document.querySelector('.dropdown-toggle-split');
    const dropdownMenu = document.querySelector('.dropdown-menu');

    if (dropdownToggle && dropdownMenu) {
        console.log('Dropdown elements found - setting up manual toggle');

        dropdownToggle.addEventListener('click', function(e) {
            console.log('Dropdown toggle clicked!');
            e.preventDefault();
            e.stopPropagation();

            const isVisible = dropdownMenu.style.display === 'block';
            dropdownMenu.style.display = isVisible ? 'none' : 'block';
            console.log('Dropdown visibility toggled to:', dropdownMenu.style.display);
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!dropdownToggle.contains(e.target) && !dropdownMenu.contains(e.target)) {
                dropdownMenu.style.display = 'none';
            }
        });
    } else {
        console.warn('Dropdown elements not found:', {dropdownToggle, dropdownMenu});
    }
});

async function copyProjectToClipboard() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = 'â³ Loading...';
    btn.disabled = true;

    try {
        const response = await fetch('/{{ project.owner.username }}/{{ project.slug }}/api/concatenate/');
        const data = await response.json();

        if (data.success) {
            await navigator.clipboard.writeText(data.content);
            btn.innerHTML = `âœ“ Copied ${data.file_count} files!`;
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }, 3000);
        } else {
            alert('Error: ' + data.error);
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    } catch (err) {
        alert('Failed to copy: ' + err);
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

async function downloadProjectAsFile() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = 'â³ Preparing download...';
    btn.disabled = true;

    try {
        const response = await fetch('/{{ project.owner.username }}/{{ project.slug }}/api/concatenate/');
        const data = await response.json();

        if (data.success) {
            // Create a blob and download it
            const blob = new Blob([data.content], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `{{ project.slug }}_all_files.txt`;

            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            btn.innerHTML = `âœ“ Downloaded ${data.file_count} files!`;
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }, 3000);
        } else {
            alert('Error: ' + data.error);
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    } catch (err) {
        alert('Failed to download: ' + err);
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

// =============================================================================
// Watch/Star/Fork Action Handlers
// =============================================================================

// Load initial stats on page load
document.addEventListener('DOMContentLoaded', function() {
    loadProjectStats();
});

async function loadProjectStats() {
    try {
        const response = await fetch('/{{ project.owner.username }}/{{ project.slug }}/api/stats/');
        const data = await response.json();

        if (data.success) {
            // Update counts
            document.getElementById('watch-count').textContent = data.stats.watch_count;
            document.getElementById('star-count').textContent = data.stats.star_count;
            document.getElementById('fork-count').textContent = data.stats.fork_count;

            // Update button states
            if (data.user_status.is_watching) {
                document.getElementById('watch-btn').classList.add('active');
            }
            if (data.user_status.is_starred) {
                document.getElementById('star-btn').classList.add('active');
            }
        }
    } catch (error) {
        console.error('Failed to load project stats:', error);
    }
}

async function handleWatch(event) {
    const btn = event.currentTarget;
    const isWatching = btn.classList.contains('active');

    try {
        const response = await fetch('/{{ project.owner.username }}/{{ project.slug }}/api/watch/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        });

        const data = await response.json();

        if (data.success) {
            // Toggle active state
            if (data.is_watching) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }

            // Update count
            document.getElementById('watch-count').textContent = data.watch_count;

            // Show notification
            showNotification(data.message, 'success');
        } else {
            showNotification(data.error || 'Failed to update watch status', 'error');
        }
    } catch (error) {
        console.error('Error toggling watch:', error);
        showNotification('Failed to update watch status', 'error');
    }
}

async function handleStar(event) {
    const btn = event.currentTarget;
    const isStarred = btn.classList.contains('active');

    try {
        const response = await fetch('/{{ project.owner.username }}/{{ project.slug }}/api/star/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        });

        const data = await response.json();

        if (data.success) {
            // Toggle active state
            if (data.is_starred) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }

            // Update count
            document.getElementById('star-count').textContent = data.star_count;

            // Show notification
            showNotification(data.message, 'success');
        } else {
            showNotification(data.error || 'Failed to update star status', 'error');
        }
    } catch (error) {
        console.error('Error toggling star:', error);
        showNotification('Failed to update star status', 'error');
    }
}

async function handleFork(event) {
    if (!confirm('Fork this repository? This will create a copy under your account.')) {
        return;
    }

    const btn = event.currentTarget;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span>Forking...</span>';

    try {
        const response = await fetch('/{{ project.owner.username }}/{{ project.slug }}/api/fork/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        });

        const data = await response.json();

        if (data.success) {
            // Update count
            document.getElementById('fork-count').textContent = data.fork_count;

            // Show success message and redirect
            showNotification(data.message, 'success');
            setTimeout(() => {
                window.location.href = data.forked_project.url;
            }, 1500);
        } else {
            showNotification(data.error || 'Failed to fork repository', 'error');
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    } catch (error) {
        console.error('Error forking project:', error);
        showNotification('Failed to fork repository', 'error');
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

// Helper function to show notifications
function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 24px;
        background: ${type === 'success' ? 'var(--color-success-emphasis)' : type === 'error' ? 'var(--color-danger-emphasis)' : 'var(--color-accent-emphasis)'};
        color: white;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 10000;
        animation: slideIn 0.3s ease;
    `;

    document.body.appendChild(notification);

    // Remove after 3 seconds
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// =============================================================================
// Toolbar Dropdown Functions
// =============================================================================

function toggleBranchDropdown() {
    const dropdown = document.getElementById('branch-dropdown-menu');
    const isVisible = dropdown.style.display === 'block';

    // Close all other dropdowns
    closeAllDropdowns();

    dropdown.style.display = isVisible ? 'none' : 'block';
    console.log('Branch dropdown toggled:', dropdown.style.display);
}

function toggleAddFileDropdown() {
    const dropdown = document.getElementById('add-file-dropdown');
    const isVisible = dropdown.style.display === 'block';

    // Close all other dropdowns
    closeAllDropdowns();

    dropdown.style.display = isVisible ? 'none' : 'block';
    console.log('Add file dropdown toggled:', dropdown.style.display);
}

function toggleCodeDropdown() {
    const dropdown = document.getElementById('code-dropdown');
    const isVisible = dropdown.style.display === 'block';

    // Close all other dropdowns
    closeAllDropdowns();

    dropdown.style.display = isVisible ? 'none' : 'block';
    console.log('Code dropdown toggled:', dropdown.style.display);
}

function toggleCopyDropdown() {
    const dropdown = document.getElementById('copy-dropdown');
    const isVisible = dropdown.style.display === 'block';

    // Close all other dropdowns
    closeAllDropdowns();

    dropdown.style.display = isVisible ? 'none' : 'block';
    console.log('Copy dropdown toggled:', dropdown.style.display);
}

function closeAllDropdowns() {
    const dropdowns = ['branch-dropdown-menu', 'add-file-dropdown', 'code-dropdown', 'copy-dropdown'];
    dropdowns.forEach(id => {
        const dropdown = document.getElementById(id);
        if (dropdown && dropdown.style.display === 'block') {
            dropdown.style.display = 'none';
        }
    });
}

function copyCloneUrl() {
    const input = document.getElementById('clone-url');
    navigator.clipboard.writeText(input.value).then(() => {
        const btn = event.target.closest('button');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"/></svg>';
        setTimeout(() => {
            btn.innerHTML = originalHTML;
        }, 2000);
    }).catch(err => {
        console.error('Failed to copy:', err);
    });
}

function downloadProjectZip() {
    // Placeholder for ZIP download functionality
    alert('ZIP download functionality coming soon!');
}

// Close dropdowns when clicking outside
document.addEventListener('click', function(e) {
    // Check if click is on any dropdown button or within dropdown content
    const clickedButton = e.target.closest('button');
    const isDropdownButton = clickedButton && (
        clickedButton.id === 'branch-dropdown-btn-header' ||
        clickedButton.id === 'add-file-btn' ||
        clickedButton.onclick === toggleCodeDropdown ||
        clickedButton.onclick === toggleCopyDropdown ||
        clickedButton.classList.contains('dropdown-toggle-split')
    );
    const isDropdownContent = e.target.closest('.dropdown-menu');

    if (!isDropdownButton && !isDropdownContent) {
        closeAllDropdowns();
    }
});
</script>
<style>
@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOut {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}
</style>
{% endblock %}
