{% extends "base.html" %}
{% load static %}

{% block title %}Pull Requests - {{ project.name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'project_app/css/project_app.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid" style="max-width: 1280px;">
    <!-- Repository Header -->
    <div style="padding: 1.5rem 0; border-bottom: 1px solid var(--color-border-default);">
        <div style="display: flex; align-items: center; gap: 0.5rem;">
            <a href="/{{ project.owner.username }}/" style="color: var(--color-accent-fg); text-decoration: none; font-weight: 400;">
                {{ project.owner.username }}
            </a>
            <span style="color: var(--color-fg-muted);">/</span>
            <a href="/{{ project.owner.username }}/{{ project.slug }}/" style="font-size: 1.25rem; font-weight: 600; color: var(--color-accent-fg); text-decoration: none;">
                {{ project.name }}
            </a>
        </div>
        {% if project.description %}
        <div style="color: var(--color-fg-muted); margin-top: 0.5rem;">{{ project.description }}</div>
        {% endif %}
    </div>

    <!-- Repository Tab Navigation (GitHub-style) -->
    <div style="margin-bottom: 1.5rem;">
        <div class="scitex-tabs">
            <a href="/{{ project.owner.username }}/{{ project.slug }}/"
               class="scitex-tab">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="display: inline-block; vertical-align: text-bottom;">
                    <path d="M2 2.5A2.5 2.5 0 0 1 4.5 0h8.75a.75.75 0 0 1 .75.75v12.5a.75.75 0 0 1-.75.75h-2.5a.75.75 0 0 1 0-1.5h1.75v-2h-8a1 1 0 0 0-.714 1.7.75.75 0 1 1-1.072 1.05A2.495 2.495 0 0 1 2 11.5Zm10.5-1h-8a1 1 0 0 0-1 1v6.708A2.486 2.486 0 0 1 4.5 9h8ZM5 12.25a.25.25 0 0 1 .25-.25h3.5a.25.25 0 0 1 .25.25v3.25a.25.25 0 0 1-.4.2l-1.45-1.087a.249.249 0 0 0-.3 0L5.4 15.7a.25.25 0 0 1-.4-.2Z"/>
                </svg>
                Code
            </a>
            <a href="/{{ project.owner.username }}/{{ project.slug }}/issues/"
               class="scitex-tab"
               title="Track issues and bugs">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="display: inline-block; vertical-align: text-bottom;">
                    <path d="M8 9.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z"/>
                    <path d="M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0ZM1.5 8a6.5 6.5 0 1 0 13 0 6.5 6.5 0 0 0-13 0Z"/>
                </svg>
                Issues
            </a>
            <a href="/{{ project.owner.username }}/{{ project.slug }}/pulls/"
               class="scitex-tab scitex-tab-active"
               title="Review code changes">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="display: inline-block; vertical-align: text-bottom;">
                    <path d="M1.5 3.25a2.25 2.25 0 1 1 3 2.122v5.256a2.251 2.251 0 1 1-1.5 0V5.372A2.25 2.25 0 0 1 1.5 3.25Zm5.677-.177L9.573.677A.25.25 0 0 1 10 .854V2.5h1A2.5 2.5 0 0 1 13.5 5v5.628a2.251 2.251 0 1 1-1.5 0V5a1 1 0 0 0-1-1h-1v1.646a.25.25 0 0 1-.427.177L7.177 3.427a.25.25 0 0 1 0-.354ZM3.75 2.5a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5Zm0 9.5a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5Zm8.25.75a.75.75 0 1 0 1.5 0 .75.75 0 0 0-1.5 0Z"/>
                </svg>
                Pull requests
            </a>
            <a href="/{{ project.owner.username }}/{{ project.slug }}/settings/"
               class="scitex-tab"
               title="Repository settings">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="display: inline-block; vertical-align: text-bottom;">
                    <path d="M8 0a8.2 8.2 0 0 1 .701.031C9.444.095 9.99.645 10.16 1.29l.288 1.107c.018.066.079.158.212.224.231.114.454.243.668.386.123.082.233.09.299.071l1.103-.303c.644-.176 1.392.021 1.82.63.27.385.506.792.704 1.218.315.675.111 1.422-.364 1.891l-.814.806c-.049.048-.098.147-.088.294.016.257.016.515 0 .772-.01.147.038.246.088.294l.814.806c.475.469.679 1.216.364 1.891a7.977 7.977 0 0 1-.704 1.217c-.428.61-1.176.807-1.82.63l-1.102-.302c-.067-.019-.177-.011-.3.071a5.909 5.909 0 0 1-.668.386c-.133.066-.194.158-.211.224l-.29 1.106c-.168.646-.715 1.196-1.458 1.26a8.006 8.006 0 0 1-1.402 0c-.743-.064-1.289-.614-1.458-1.26l-.289-1.106c-.018-.066-.079-.158-.212-.224a5.738 5.738 0 0 1-.668-.386c-.123-.082-.233-.09-.299-.071l-1.103.303c-.644.176-1.392-.021-1.82-.63a8.12 8.12 0 0 1-.704-1.218c-.315-.675-.111-1.422.363-1.891l.815-.806c.05-.048.098-.147.088-.294a6.214 6.214 0 0 1 0-.772c.01-.147-.038-.246-.088-.294l-.815-.806C.635 6.045.431 5.298.746 4.623a7.92 7.92 0 0 1 .704-1.217c.428-.61 1.176-.807 1.82-.63l1.102.302c.067.019.177.011.3-.071.214-.143.437-.272.668-.386.133-.066.194-.158.211-.224l.29-1.106C6.009.645 6.556.095 7.299.03 7.53.01 7.764 0 8 0Zm-.571 1.525c-.036.003-.108.036-.137.146l-.289 1.105c-.147.561-.549.967-.998 1.189-.173.086-.36.159-.558.217-.473.138-.96.072-1.384-.234l-1.103-.303c-.109-.03-.175.016-.195.045-.22.312-.412.644-.573.99-.014.031-.021.11.059.19l.815.806c.411.406.562.957.53 1.456a4.709 4.709 0 0 0 0 .582c.032.499-.119 1.05-.53 1.456l-.815.806c-.081.08-.073.159-.059.19.162.346.353.677.573.989.02.03.085.076.195.046l1.102-.303c.424-.306.91-.372 1.383-.234.198.058.386.131.559.217.449.222.851.628.998 1.189l.289 1.105c.029.109.101.143.137.146a6.6 6.6 0 0 0 1.142 0c.036-.003.108-.036.137-.146l.289-1.105c.147-.561.549-.967.998-1.189.173-.086.36-.159.558-.217.473-.138.96-.072 1.384.234l1.103.303c.109.029.175-.016.195-.045.22-.313.411-.644.573-.990.014-.031.021-.11-.059-.19l-.815-.806c-.411-.406-.562-.957-.53-1.456a4.709 4.709 0 0 0 0-.582c-.032-.499.119-1.05.53-1.456l.815-.806c.081-.08.073-.159.059-.19a6.464 6.464 0 0 0-.573-.989c-.02-.03-.085-.076-.195-.046l-1.102.303c-.424.306-.91.372-1.383.234a4.97 4.97 0 0 0-.559-.217c-.449-.222-.851-.628-.998-1.189l-.289-1.105c-.029-.11-.101-.143-.137-.146a6.6 6.6 0 0 0-1.142 0ZM11 8a3 3 0 1 1-6 0 3 3 0 0 1 6 0ZM9.5 8a1.5 1.5 0 1 0-3.001.001A1.5 1.5 0 0 0 9.5 8Z"/>
                </svg>
                Settings
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <!-- PR filters and new button -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div class="btn-group" role="group">
                    <a href="?state=open" class="btn btn-sm {% if state_filter == 'open' %}btn-primary{% else %}btn-outline-secondary{% endif %}">
                        <i class="bi bi-circle"></i> Open <span class="badge bg-secondary">{{ open_count }}</span>
                    </a>
                    <a href="?state=closed" class="btn btn-sm {% if state_filter == 'closed' %}btn-outline-secondary{% endif %}">
                        <i class="bi bi-x-circle"></i> Closed <span class="badge bg-secondary">{{ closed_count }}</span>
                    </a>
                    <a href="?state=merged" class="btn btn-sm {% if state_filter == 'merged' %}btn-outline-secondary{% endif %}">
                        <i class="bi bi-check2-circle"></i> Merged <span class="badge bg-secondary">{{ merged_count }}</span>
                    </a>
                </div>

                {% if can_create %}
                <a href="{% url 'user_projects:pr_create' project.owner.username project.slug %}" class="btn btn-success">
                    <i class="bi bi-plus-lg"></i> New pull request
                </a>
                {% endif %}
            </div>

            <!-- Advanced filters -->
            <div class="card mb-3">
                <div class="card-body">
                    <form method="get" class="row g-3">
                        <input type="hidden" name="state" value="{{ state_filter }}">

                        <div class="col-md-3">
                            <label class="form-label">Author</label>
                            <input type="text" name="author" class="form-control form-control-sm"
                                   value="{{ author_filter }}" placeholder="Filter by author">
                        </div>

                        <div class="col-md-3">
                            <label class="form-label">Reviewer</label>
                            <input type="text" name="reviewer" class="form-control form-control-sm"
                                   value="{{ reviewer_filter }}" placeholder="Filter by reviewer">
                        </div>

                        <div class="col-md-3">
                            <label class="form-label">Label</label>
                            <select name="label" class="form-select form-select-sm">
                                <option value="">All labels</option>
                                {% for label in labels %}
                                <option value="{{ label.name }}" {% if label_filter == label.name %}selected{% endif %}>
                                    {{ label.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-3">
                            <label class="form-label">Sort by</label>
                            <div class="input-group input-group-sm">
                                <select name="sort" class="form-select">
                                    <option value="created" {% if sort_by == 'created' %}selected{% endif %}>Created</option>
                                    <option value="updated" {% if sort_by == 'updated' %}selected{% endif %}>Updated</option>
                                    <option value="comments" {% if sort_by == 'comments' %}selected{% endif %}>Comments</option>
                                </select>
                                <select name="direction" class="form-select">
                                    <option value="desc" {% if direction == 'desc' %}selected{% endif %}>Newest</option>
                                    <option value="asc" {% if direction == 'asc' %}selected{% endif %}>Oldest</option>
                                </select>
                                <button type="submit" class="btn btn-primary">Apply</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- PR list -->
            {% if prs %}
            <div class="list-group">
                {% for pr in prs %}
                <a href="{% url 'user_projects:pr_detail' project.owner.username project.slug pr.number %}"
                   class="list-group-item list-group-item-action">
                    <div class="d-flex w-100 justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-2">
                                <!-- PR state icon -->
                                {% if pr.state == 'open' %}
                                <i class="bi bi-circle text-success me-2"></i>
                                {% elif pr.state == 'merged' %}
                                <i class="bi bi-check2-circle text-primary me-2"></i>
                                {% else %}
                                <i class="bi bi-x-circle text-danger me-2"></i>
                                {% endif %}

                                <!-- PR title -->
                                <h6 class="mb-0">{{ pr.title }}</h6>

                                <!-- Draft badge -->
                                {% if pr.is_draft %}
                                <span class="badge bg-secondary ms-2">Draft</span>
                                {% endif %}

                                <!-- Labels -->
                                {% for label in pr.labels %}
                                <span class="badge ms-2" style="background-color: {{ label.color }}">
                                    {{ label }}
                                </span>
                                {% endfor %}
                            </div>

                            <!-- PR metadata -->
                            <small class="text-muted">
                                #{{ pr.number }} opened
                                <time datetime="{{ pr.created_at|date:'c' }}" title="{{ pr.created_at }}">
                                    {{ pr.created_at|timesince }} ago
                                </time>
                                by <strong>{{ pr.author.username }}</strong>

                                {% if pr.state == 'merged' %}
                                    - Merged by <strong>{{ pr.merged_by.username }}</strong>
                                    <time datetime="{{ pr.merged_at|date:'c' }}">{{ pr.merged_at|timesince }} ago</time>
                                {% elif pr.state == 'closed' %}
                                    - Closed
                                    <time datetime="{{ pr.closed_at|date:'c' }}">{{ pr.closed_at|timesince }} ago</time>
                                {% endif %}
                            </small>

                            <!-- Branch info -->
                            <div class="mt-1">
                                <small class="text-muted font-monospace">
                                    <i class="bi bi-git"></i>
                                    {{ pr.source_branch }} â†’ {{ pr.target_branch }}
                                </small>
                            </div>
                        </div>

                        <!-- PR stats -->
                        <div class="text-end ms-3">
                            {% if pr.comment_count > 0 %}
                            <span class="badge bg-light text-dark me-2">
                                <i class="bi bi-chat"></i> {{ pr.comment_count }}
                            </span>
                            {% endif %}

                            {% if pr.review_count > 0 %}
                            <span class="badge bg-light text-dark">
                                <i class="bi bi-check-circle"></i> {{ pr.review_count }}
                            </span>
                            {% endif %}

                            <!-- Conflict indicator -->
                            {% if pr.has_conflicts %}
                            <span class="badge bg-danger ms-2">
                                <i class="bi bi-exclamation-triangle"></i> Conflicts
                            </span>
                            {% endif %}
                        </div>
                    </div>
                </a>
                {% endfor %}
            </div>

            <!-- Pagination -->
            {% if page_obj.has_other_pages %}
            <nav class="mt-4">
                <ul class="pagination justify-content-center">
                    {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}&state={{ state_filter }}&sort={{ sort_by }}&direction={{ direction }}">Previous</a>
                    </li>
                    {% endif %}

                    {% for num in page_obj.paginator.page_range %}
                    <li class="page-item {% if page_obj.number == num %}active{% endif %}">
                        <a class="page-link" href="?page={{ num }}&state={{ state_filter }}&sort={{ sort_by }}&direction={{ direction }}">{{ num }}</a>
                    </li>
                    {% endfor %}

                    {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}&state={{ state_filter }}&sort={{ sort_by }}&direction={{ direction }}">Next</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}

            {% else %}
            <!-- No PRs -->
            <div class="text-center py-5">
                <i class="bi bi-git-pull-request" style="font-size: 4rem; color: #ccc;"></i>
                <h4 class="mt-3">No pull requests found</h4>
                <p class="text-muted">
                    {% if state_filter == 'open' %}
                    There are no open pull requests.
                    {% elif state_filter == 'closed' %}
                    There are no closed pull requests.
                    {% elif state_filter == 'merged' %}
                    There are no merged pull requests.
                    {% else %}
                    There are no pull requests in this project.
                    {% endif %}
                </p>
                {% if can_create %}
                <a href="{% url 'user_projects:pr_create' project.owner.username project.slug %}" class="btn btn-primary mt-3">
                    <i class="bi bi-plus-lg"></i> Create your first pull request
                </a>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>


{% endblock %}
