<!-- PR Description -->
<div class="comment-box mb-3">
    <div class="comment-header">
        <strong>{{ pr.author.username }}</strong> commented
        <time datetime="{{ pr.created_at|date:'c' }}" class="text-muted">
            {{ pr.created_at|timesince }} ago
        </time>
    </div>
    <div class="comment-body">
        {% if pr.description %}
        <div class="markdown-content">
            {{ pr.description|linebreaks }}
        </div>
        {% else %}
        <p class="text-muted">No description provided.</p>
        {% endif %}
    </div>
</div>

<!-- Timeline (comments and events) -->
<div class="timeline">
    {% for item in timeline %}
    <div class="timeline-item">
        {% if not item.event_type %}
        <!-- Comment -->
        <div class="timeline-icon bg-primary text-white">
            <i class="bi bi-chat"></i>
        </div>
        <div class="comment-box">
            <div class="comment-header">
                <strong>{{ item.author.username }}</strong> commented
                <time datetime="{{ item.created_at|date:'c' }}" class="text-muted">
                    {{ item.created_at|timesince }} ago
                </time>
                {% if item.edited %}
                <span class="badge bg-secondary">edited</span>
                {% endif %}
            </div>
            <div class="comment-body">
                {{ item.content|linebreaks }}

                <!-- Inline comment context -->
                {% if item.is_inline %}
                <div class="alert alert-info small mt-2">
                    <i class="bi bi-file-earmark-code"></i>
                    <code>{{ item.file_path }}:{{ item.line_number }}</code>
                </div>
                {% endif %}

                <!-- Threaded replies -->
                {% if item.replies.all %}
                <div class="ms-4 mt-2">
                    {% for reply in item.replies.all %}
                    <div class="comment-box mb-2">
                        <div class="comment-header">
                            <strong>{{ reply.author.username }}</strong> replied
                            <time datetime="{{ reply.created_at|date:'c' }}" class="text-muted">
                                {{ reply.created_at|timesince }} ago
                            </time>
                        </div>
                        <div class="comment-body">
                            {{ reply.content|linebreaks }}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>

        {% else %}
        <!-- Event -->
        <div class="timeline-icon bg-secondary text-white">
            <i class="bi bi-{{ item.event_type|default:'circle' }}"></i>
        </div>
        <div class="text-muted">
            <strong>{{ item.actor.username }}</strong>
            {% if item.event_type == 'opened' %}
            opened this pull request
            {% elif item.event_type == 'closed' %}
            closed this pull request
            {% elif item.event_type == 'reopened' %}
            reopened this pull request
            {% elif item.event_type == 'merged' %}
            merged this pull request
            {% elif item.event_type == 'reviewed' %}
            reviewed this pull request
            {% elif item.event_type == 'commit' %}
            added commits
            {% elif item.event_type == 'label' %}
            changed labels
            {% elif item.event_type == 'assignee' %}
            changed assignees
            {% elif item.event_type == 'reviewer' %}
            changed reviewers
            {% endif %}
            <time datetime="{{ item.created_at|date:'c' }}">
                {{ item.created_at|timesince }} ago
            </time>
        </div>
        {% endif %}
    </div>
    {% empty %}
    <p class="text-muted">No activity yet</p>
    {% endfor %}
</div>

<!-- Reviews -->
{% if pr.reviews.all %}
<div class="mt-4">
    <h5>Reviews</h5>
    {% for review in pr.reviews.all %}
    <div class="comment-box mb-3">
        <div class="comment-header">
            <strong>{{ review.reviewer.username }}</strong>
            {% if review.state == 'approved' %}
            <span class="badge bg-success">Approved</span>
            {% elif review.state == 'changes_requested' %}
            <span class="badge bg-warning">Changes requested</span>
            {% else %}
            <span class="badge bg-secondary">Commented</span>
            {% endif %}
            <time datetime="{{ review.created_at|date:'c' }}" class="text-muted ms-2">
                {{ review.created_at|timesince }} ago
            </time>
        </div>
        {% if review.content %}
        <div class="comment-body">
            {{ review.content|linebreaks }}
        </div>
        {% endif %}
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Add comment form -->
{% if user.is_authenticated and project.can_view %}
<div class="mt-4">
    <h5>Leave a comment</h5>
    <form id="commentForm"
          data-comment-url="{% url 'user_projects:pr_comment_create' project.owner.username project.slug pr.number %}"
          data-review-url="{% url 'user_projects:pr_review_submit' project.owner.username project.slug pr.number %}">
        <textarea name="content" class="form-control mb-2" rows="4"
                  placeholder="Add your comment here..."></textarea>
        <div class="d-flex justify-content-between">
            <button type="button" class="btn btn-secondary" onclick="submitComment()">
                <i class="bi bi-chat"></i> Comment
            </button>

            {% if not is_author and project.can_view %}
            <div class="btn-group">
                <button type="button" class="btn btn-success" onclick="submitReview('approved')">
                    <i class="bi bi-check-circle"></i> Approve
                </button>
                <button type="button" class="btn btn-warning" onclick="submitReview('changes_requested')">
                    <i class="bi bi-x-circle"></i> Request changes
                </button>
            </div>
            {% endif %}
        </div>
    </form>
</div>
{% endif %}

{% load static %}
<script src="{% static 'project_app/js/pr_conversation.js' %}"></script>
