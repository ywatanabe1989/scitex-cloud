<!-- Highlight.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js"></script>

<script>
// Theme configuration
const DARK_THEMES = ['dracula', 'monokai', 'nord', 'atom-one-dark', 'github-dark', 'vs2015'];
const LIGHT_THEMES = ['atom-one-light', 'github', 'stackoverflow-light', 'default', 'xcode'];

// Default themes
let codeThemePreferences = {
    light: 'atom-one-light',
    dark: 'nord'
};

// Store original code content
let originalCodeContent = null;

// Helper function to escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Load theme preferences from database
async function loadCodeThemePreferences() {
    try {
        const response = await fetch('/auth/api/get-theme/');
        const data = await response.json();
        if (data.code_theme_light && data.code_theme_dark) {
            codeThemePreferences = {
                light: data.code_theme_light,
                dark: data.code_theme_dark
            };
        }
    } catch (error) {
        console.warn('Failed to load code theme preferences:', error);
    }
}

// Save theme preferences to database
async function saveCodeThemePreferences() {
    try {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || getCookie('csrftoken');
        const response = await fetch('/auth/api/save-theme/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                code_theme_light: codeThemePreferences.light,
                code_theme_dark: codeThemePreferences.dark
            })
        });
        const data = await response.json();
        if (data.success) {
            console.log('Code theme preferences saved:', codeThemePreferences);
        }
    } catch (error) {
        console.warn('Failed to save code theme preferences:', error);
    }
}

// Switch highlight.js theme
function switchHighlightTheme(themeName, reHighlight = false) {
    // Disable all themes
    document.querySelectorAll('.hljs-theme').forEach(link => {
        link.disabled = true;
    });

    // Enable selected theme
    const themeLink = document.querySelector(`.hljs-theme[data-theme-name="${themeName}"]`);
    if (themeLink) {
        themeLink.disabled = false;
        console.log('Switched to highlight theme:', themeName);

        // Re-highlight code if requested
        if (reHighlight && originalCodeContent) {
            const pre = document.querySelector('.file-content pre');
            if (pre) {
                // Restore original code (escaped)
                pre.innerHTML = `<code id="code-content" class="language-{{ language }}">${escapeHtml(originalCodeContent)}</code>`;
                const newCodeBlock = pre.querySelector('#code-content');
                if (newCodeBlock) {
                    // Re-apply highlighting
                    hljs.highlightElement(newCodeBlock);
                    hljs.lineNumbersBlock(newCodeBlock);
                }
            }
        }
    }
}

// Update theme based on current site theme (light/dark)
function updateHighlightTheme() {
    const currentSiteTheme = document.documentElement.getAttribute('data-theme') || 'dark';
    const preferredTheme = codeThemePreferences[currentSiteTheme];
    switchHighlightTheme(preferredTheme);
}

// Handle scroll shadows
function updateScrollShadows(container) {
    const scrollTop = container.scrollTop;
    const scrollHeight = container.scrollHeight;
    const clientHeight = container.clientHeight;
    const scrollBottom = scrollHeight - scrollTop - clientHeight;

    // Add/remove classes based on scroll position
    if (scrollTop > 0) {
        container.classList.add('scrolled-top');
    } else {
        container.classList.remove('scrolled-top');
    }

    if (scrollBottom > 0) {
        container.classList.add('scrolled-bottom');
    } else {
        container.classList.remove('scrolled-bottom');
    }
}

// Initialize syntax highlighting with line numbers
document.addEventListener('DOMContentLoaded', async function() {
    // Store original code content before highlighting
    const codeBlock = document.getElementById('code-content');
    if (codeBlock) {
        originalCodeContent = codeBlock.textContent;
    }

    // Load preferences from database
    await loadCodeThemePreferences();

    // Set initial theme
    updateHighlightTheme();

    // Apply highlighting
    if (codeBlock) {
        hljs.highlightElement(codeBlock);
        hljs.lineNumbersBlock(codeBlock);
    }

    // Setup scroll shadow handlers
    const fileContent = document.querySelector('.file-content');
    if (fileContent) {
        // Initial check
        updateScrollShadows(fileContent);

        // Update on scroll
        fileContent.addEventListener('scroll', function() {
            updateScrollShadows(fileContent);
        });

        // Update on resize
        window.addEventListener('resize', function() {
            updateScrollShadows(fileContent);
        });
    }

    // Listen for site theme changes (light/dark toggle)
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'data-theme') {
                const newSiteTheme = document.documentElement.getAttribute('data-theme') || 'dark';
                const preferredTheme = codeThemePreferences[newSiteTheme];

                // Switch theme and re-highlight
                switchHighlightTheme(preferredTheme, true);

                console.log(`Site theme changed to ${newSiteTheme}, code theme: ${preferredTheme}`);
            }
        });
    });

    observer.observe(document.documentElement, {
        attributes: true,
        attributeFilter: ['data-theme']
    });
});

function copyToClipboard() {
    const content = document.querySelector('.file-content')?.innerText ||
                   document.querySelector('.markdown-body')?.innerText || '';

    navigator.clipboard.writeText(content).then(() => {
        const btn = event.target;
        const originalText = btn.innerHTML;
        const checkIcon = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" class="octicon octicon-16" style="vertical-align: text-bottom; margin-right: 4px;"><path fill="currentColor" d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path></svg>';
        btn.innerHTML = `${checkIcon} Copied!`;
        setTimeout(() => { btn.innerHTML = originalText; }, 2000);
    }).catch(err => {
        alert('Failed to copy: ' + err);
    });
}

function showCode() {
    document.getElementById('markdownPreview').style.display = 'none';
    document.getElementById('markdownCode').style.display = 'block';
    document.getElementById('codeBtn').classList.add('active');
    document.getElementById('previewBtn').classList.remove('active');
}

function showPreview() {
    document.getElementById('markdownPreview').style.display = 'block';
    document.getElementById('markdownCode').style.display = 'none';
    document.getElementById('codeBtn').classList.remove('active');
    document.getElementById('previewBtn').classList.add('active');
}

// Branch selector dropdown
function toggleBranchDropdown(event) {
    event.stopPropagation();
    const dropdown = document.getElementById('branchDropdown');
    dropdown.classList.toggle('show');
}

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
    const dropdown = document.getElementById('branchDropdown');
    const branchSelector = document.querySelector('.branch-selector');

    if (dropdown && branchSelector && !branchSelector.contains(event.target)) {
        dropdown.classList.remove('show');
    }
});

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Switch branch via API
async function switchBranch(branch) {
    console.log('Switching to branch:', branch);

    try {
        // Call the branch switching API
        const response = await fetch('/{{ project.owner.username }}/{{ project.slug }}/api/switch-branch/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ branch: branch })
        });

        const data = await response.json();

        if (data.success) {
            // Reload page to show file from new branch
            window.location.reload();
        } else {
            alert('Failed to switch branch: ' + data.error);
        }
    } catch (error) {
        console.error('Error switching branch:', error);
        alert('Failed to switch branch: ' + error.message);
    }
}
</script>
