<!-- Git Clone Button Component -->
<div class="git-clone-button-container">
    <div class="btn-group">
        <button type="button" class="btn btn-code-success" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="fas fa-code me-2"></i>Code
            <i class="fas fa-caret-down ms-2"></i>
        </button>
        <div class="dropdown-menu dropdown-menu-end p-0" style="min-width: 400px;">
            <!-- Tabs Navigation -->
            <ul class="nav nav-tabs code-dropdown-tabs px-3 pt-3" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="local-tab" data-bs-toggle="tab" data-bs-target="#local-panel" type="button" role="tab">
                        <i class="fas fa-desktop me-2"></i>Local
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="workspace-tab" data-bs-toggle="tab" data-bs-target="#workspace-panel" type="button" role="tab">
                        <i class="fas fa-terminal me-2"></i>Workspace
                    </button>
                </li>
            </ul>

            <!-- Tabs Content -->
            <div class="tab-content p-3">
                <!-- Local Tab -->
                <div class="tab-pane fade show active" id="local-panel" role="tabpanel">
                    <!-- Clone Section Header -->
                    <div class="mb-3">
                        <h6 class="code-dropdown-header">
                            <i class="fas fa-clone me-2"></i>Clone
                        </h6>
                    </div>

                    <!-- HTTPS -->
                    <div class="mb-3">
                        <div class="d-flex align-items-center justify-content-between mb-2">
                            <label class="form-label mb-0 fw-bold">HTTPS</label>
                        </div>
                        <div class="input-group input-group-sm">
                            <input type="text"
                                   class="form-control font-monospace"
                                   value="{{ gitea_https_url }}"
                                   id="gitea-https-url"
                                   readonly>
                            <button class="btn btn-outline-secondary"
                                    type="button"
                                    onclick="copyToClipboard('gitea-https-url')"
                                    title="Copy HTTPS URL">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>

                    <!-- SSH -->
                    <div class="mb-3">
                        <div class="d-flex align-items-center justify-content-between mb-2">
                            <label class="form-label mb-0 fw-bold">SSH</label>
                            <small class="text-muted">SSH key required</small>
                        </div>
                        <div class="input-group input-group-sm">
                            <input type="text"
                                   class="form-control font-monospace"
                                   value="{{ gitea_ssh_url }}"
                                   id="gitea-ssh-url"
                                   readonly>
                            <button class="btn btn-outline-secondary"
                                    type="button"
                                    onclick="copyToClipboard('gitea-ssh-url')"
                                    title="Copy SSH URL">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <div class="mt-2 p-2 rounded ssh-key-notice">
                            <small class="d-block">
                                <i class="fas fa-info-circle me-1"></i>
                                <strong>SSH key authentication only.</strong>
                                <a href="/accounts/settings/ssh-keys/" target="_blank" class="text-decoration-none ssh-key-link">
                                    Add your SSH key →
                                </a>
                            </small>
                        </div>
                    </div>

                    <!-- SciTeX CLI -->
                    <div class="mb-3">
                        <div class="d-flex align-items-center justify-content-between mb-2">
                            <label class="form-label mb-0 fw-bold">SciTeX Cloud CLI</label>
                        </div>
                        <div class="code-cli-command">
                            <code>scitex clone {{ project.owner.username }}/{{ project.slug }}</code>
                            <button class="btn btn-sm btn-outline-secondary"
                                    type="button"
                                    onclick="copyToClipboard('scitex-cli-command')"
                                    title="Copy CLI command">
                                <i class="fas fa-copy"></i>
                            </button>
                            <input type="hidden" id="scitex-cli-command" value="scitex clone {{ project.owner.username }}/{{ project.slug }}">
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="fas fa-book me-1"></i>
                                <a href="/docs/scitex-cli/" target="_blank" class="text-decoration-none">Learn about SciTeX CLI →</a>
                            </small>
                        </div>
                    </div>

                    <!-- Divider -->
                    <hr class="dropdown-divider">

                    <!-- Download ZIP -->
                    <div>
                        <a class="dropdown-item" href="{{ download_zip_url }}">
                            <i class="fas fa-download me-2"></i>Download ZIP
                        </a>
                    </div>
                </div>

                <!-- Workspace Tab -->
                <div class="tab-pane fade" id="workspace-panel" role="tabpanel">
                    <div class="workspace-tab-content">
                        <div class="workspace-empty-state">
                            <svg width="48" height="48" viewBox="0 0 16 16" fill="currentColor" class="workspace-icon mb-3">
                                <path d="M0 1.75C0 .784.784 0 1.75 0h12.5C15.216 0 16 .784 16 1.75v9.5A1.75 1.75 0 0 1 14.25 13H8.06l-2.573 2.573A1.458 1.458 0 0 1 3 14.543V13H1.75A1.75 1.75 0 0 1 0 11.25Zm1.75-.25a.25.25 0 0 0-.25.25v9.5c0 .138.112.25.25.25h2a.75.75 0 0 1 .75.75v2.19l2.72-2.72a.749.749 0 0 1 .53-.22h6.5a.25.25 0 0 0 .25-.25v-9.5a.25.25 0 0 0-.25-.25Zm7 2.25v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 9a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"/>
                            </svg>
                            <h6 class="mb-2">No workspaces</h6>
                            <p class="text-muted mb-3">You don't have any workspaces with this repository checked out</p>

                            <button class="btn btn-success mb-3" onclick="openWorkspace()">
                                <i class="fas fa-terminal me-2"></i>Open in Workspace
                            </button>

                            <div class="workspace-ssh-info p-3 rounded">
                                <h6 class="mb-2">
                                    <i class="fas fa-key me-2"></i>Direct SSH Access
                                </h6>
                                <p class="small text-muted mb-2">Connect directly to your workspace via SSH:</p>
                                <div class="input-group input-group-sm mb-2">
                                    <input type="text"
                                           class="form-control font-monospace"
                                           value="ssh {{ project.owner.username }}@workspace.scitex.cloud"
                                           id="workspace-ssh-url"
                                           readonly>
                                    <button class="btn btn-outline-secondary"
                                            type="button"
                                            onclick="copyToClipboard('workspace-ssh-url')"
                                            title="Copy SSH command">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    SSH key required.
                                    <a href="/accounts/settings/ssh-keys/" target="_blank" class="text-decoration-none">
                                        Manage SSH keys →
                                    </a>
                                </small>
                            </div>

                            <div class="mt-3">
                                <small class="text-muted">
                                    <a href="/docs/workspaces/" target="_blank" class="text-decoration-none">
                                        Learn more about workspaces →
                                    </a>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function copyToClipboard(elementId) {
    const input = document.getElementById(elementId);
    input.select();
    input.setSelectionRange(0, 99999); // For mobile devices

    // Copy to clipboard
    navigator.clipboard.writeText(input.value).then(function() {
        // Show success feedback
        const button = input.nextElementSibling;
        const originalHTML = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check"></i>';
        button.classList.remove('btn-outline-secondary');
        button.classList.add('btn-success');

        setTimeout(function() {
            button.innerHTML = originalHTML;
            button.classList.remove('btn-success');
            button.classList.add('btn-outline-secondary');
        }, 2000);
    }).catch(function(err) {
        console.error('Failed to copy:', err);
        alert('Failed to copy to clipboard');
    });
}

function openWorkspace() {
    // Redirect to workspace for this project
    window.location.href = '/code/workspace/';
}

// Initialize Bootstrap dropdown - wait for Bootstrap to load
(function initDropdown() {
    const dropdownButton = document.querySelector('.git-clone-button-container .btn-code-success');

    if (!dropdownButton) {
        // Button not in DOM yet, retry
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initDropdown);
        }
        return;
    }

    if (typeof bootstrap !== 'undefined' && bootstrap.Dropdown) {
        // Bootstrap is loaded, initialize dropdown
        new bootstrap.Dropdown(dropdownButton);
        console.log('[CloneButton] Dropdown initialized');
    } else {
        // Bootstrap not loaded yet, wait for it
        setTimeout(initDropdown, 100);
    }
})();
</script>

<style>
/* Code Button - Theme-responsive success color */
.git-clone-button-container .btn-code-success {
    display: flex;
    align-items: center;
    background-color: var(--success-color);
    border-color: var(--success-color);
    color: #ffffff;
    font-weight: 500;
    transition: all 0.2s ease;
}

.git-clone-button-container .btn-code-success:hover {
    background-color: var(--workspace-icon-hover);
    border-color: var(--workspace-icon-hover);
    color: #ffffff;
}

[data-theme="dark"] .git-clone-button-container .btn-code-success {
    background-color: var(--success-color);
    border-color: var(--success-color);
    color: var(--bg-page);
}

[data-theme="dark"] .git-clone-button-container .btn-code-success:hover {
    background-color: var(--workspace-icon-hover);
    border-color: var(--workspace-icon-hover);
    color: var(--bg-page);
}

/* Dropdown Menu */
.git-clone-button-container .dropdown-menu {
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    border: 1px solid var(--color-border-default);
    background-color: var(--color-canvas-default);
}

[data-theme="dark"] .git-clone-button-container .dropdown-menu {
    background-color: var(--workspace-bg-secondary);
    border-color: var(--workspace-border-default);
}

/* Tabs Navigation */
.git-clone-button-container .code-dropdown-tabs {
    border-bottom: 1px solid var(--color-border-default);
    margin-bottom: 0;
}

[data-theme="dark"] .git-clone-button-container .code-dropdown-tabs {
    border-bottom-color: var(--workspace-border-default);
}

.git-clone-button-container .code-dropdown-tabs .nav-link {
    color: var(--color-fg-muted);
    border: none;
    border-bottom: 2px solid transparent;
    padding: 8px 16px;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s ease;
}

.git-clone-button-container .code-dropdown-tabs .nav-link:hover {
    color: var(--color-fg-default);
    border-bottom-color: var(--color-border-default);
}

.git-clone-button-container .code-dropdown-tabs .nav-link.active {
    color: var(--success-color);
    border-bottom-color: var(--success-color);
    background-color: transparent;
}

[data-theme="dark"] .git-clone-button-container .code-dropdown-tabs .nav-link.active {
    color: var(--success-color);
    border-bottom-color: var(--success-color);
}

/* Form Controls */
.git-clone-button-container .form-control {
    font-size: 13px;
    background-color: var(--color-canvas-subtle);
    border-color: var(--color-border-default);
    color: var(--color-fg-default);
}

[data-theme="dark"] .git-clone-button-container .form-control {
    background-color: var(--workspace-bg-primary);
    border-color: var(--workspace-border-default);
    color: var(--text-primary);
}

/* Headers */
.git-clone-button-container .code-dropdown-header {
    font-size: 14px;
    font-weight: 600;
    color: var(--color-fg-default);
    padding: 0;
    margin: 0;
}

[data-theme="dark"] .git-clone-button-container .code-dropdown-header {
    color: var(--text-primary);
}

/* Dropdown Items */
.git-clone-button-container .dropdown-item {
    padding: 8px 12px;
    font-size: 14px;
    color: var(--color-fg-default);
}

.git-clone-button-container .dropdown-item:hover {
    background-color: var(--color-accent-subtle);
}

[data-theme="dark"] .git-clone-button-container .dropdown-item:hover {
    background-color: var(--workspace-bg-tertiary);
}

/* SSH Key Notice */
.git-clone-button-container .ssh-key-notice {
    background-color: rgba(74, 155, 126, 0.05);
    border-left: 3px solid var(--success-color);
}

[data-theme="dark"] .git-clone-button-container .ssh-key-notice {
    background-color: rgba(107, 168, 154, 0.1);
    border-left-color: var(--success-color);
}

.git-clone-button-container .ssh-key-link {
    color: var(--success-color);
    font-weight: 500;
}

[data-theme="dark"] .git-clone-button-container .ssh-key-link {
    color: var(--success-color);
}

.git-clone-button-container .ssh-key-link:hover {
    text-decoration: underline !important;
}

/* SciTeX CLI Command Display */
.git-clone-button-container .code-cli-command {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 12px;
    background-color: var(--color-canvas-subtle);
    border: 1px solid var(--color-border-default);
    border-radius: 6px;
}

[data-theme="dark"] .git-clone-button-container .code-cli-command {
    background-color: var(--workspace-bg-primary);
    border-color: var(--workspace-border-default);
}

.git-clone-button-container .code-cli-command code {
    flex: 1;
    font-family: 'JetBrains Mono', monospace;
    font-size: 13px;
    color: var(--color-fg-default);
}

[data-theme="dark"] .git-clone-button-container .code-cli-command code {
    color: var(--text-primary);
}

/* Workspace Empty State */
.git-clone-button-container .workspace-empty-state {
    text-align: center;
    padding: 20px;
}

.git-clone-button-container .workspace-icon {
    color: var(--color-fg-muted);
    opacity: 0.5;
}

.git-clone-button-container .workspace-ssh-info {
    background-color: var(--color-canvas-subtle);
    border: 1px solid var(--color-border-default);
    text-align: left;
}

[data-theme="dark"] .git-clone-button-container .workspace-ssh-info {
    background-color: var(--workspace-bg-primary);
    border-color: var(--workspace-border-default);
}

/* Success Button in Workspace Tab */
.git-clone-button-container .workspace-tab-content .btn-success {
    background-color: var(--success-color);
    border-color: var(--success-color);
    color: #ffffff;
}

.git-clone-button-container .workspace-tab-content .btn-success:hover {
    background-color: var(--workspace-icon-hover);
    border-color: var(--workspace-icon-hover);
    color: #ffffff;
}

[data-theme="dark"] .git-clone-button-container .workspace-tab-content .btn-success {
    background-color: var(--success-color);
    border-color: var(--success-color);
    color: var(--bg-page);
}

[data-theme="dark"] .git-clone-button-container .workspace-tab-content .btn-success:hover {
    background-color: var(--workspace-icon-hover);
    border-color: var(--workspace-icon-hover);
    color: var(--bg-page);
}
</style>
