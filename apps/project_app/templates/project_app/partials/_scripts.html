<script>
// Build file tree for sidebar
async function loadFileTree() {
    try {
        const response = await fetch('/{{ project.owner.username }}/{{ project.slug }}/api/file-tree/');
        const data = await response.json();

        if (data.success) {
            const treeContainer = document.getElementById('file-tree');
            treeContainer.innerHTML = buildTreeHTML(data.tree, '{{ project.owner.username }}', '{{ project.slug }}');
        } else {
            document.getElementById('file-tree').innerHTML = '<div style="color: var(--color-fg-muted); padding: 0.5rem;">Error loading file tree</div>';
        }
    } catch (err) {
        console.error('Failed to load file tree:', err);
        document.getElementById('file-tree').innerHTML = '<div style="color: var(--color-fg-muted); padding: 0.5rem;">Error loading file tree</div>';
    }
}

function buildTreeHTML(items, username, slug, level = 0) {
    let html = '';
    const indent = level * 16;
    const currentPath = window.location.pathname;

    items.forEach((item, index) => {
        const itemPath = `/${username}/${slug}/${item.path}${item.type === 'directory' ? '/' : ''}`;
        const isActive = currentPath.includes(item.path);
        const icon = item.type === 'directory' ? '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" class="icon-folder"><path fill="currentColor" d="M1.75 1A1.75 1.75 0 0 0 0 2.75v10.5C0 14.216.784 15 1.75 15h12.5A1.75 1.75 0 0 0 16 13.25v-8.5A1.75 1.75 0 0 0 14.25 3H7.5a.25.25 0 0 1-.2-.1l-.9-1.2C6.07 1.26 5.55 1 5 1H1.75Z"></path></svg>' : '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" class="icon-file"><path fill="currentColor" d="M2 1.75C2 .784 2.784 0 3.75 0h6.586c.464 0 .909.184 1.237.513l2.914 2.914c.329.328.513.773.513 1.237v9.586A1.75 1.75 0 0 1 13.25 16h-9.5A1.75 1.75 0 0 1 2 14.25Zm1.75-.25a.25.25 0 0 0-.25.25v12.5c0 .138.112.25.25.25h9.5a.25.25 0 0 0 .25-.25V6h-2.75A1.75 1.75 0 0 1 9 4.25V1.5Zm6.75.062V4.25c0 .138.112.25.25.25h2.688l-.011-.013-2.914-2.914-.013-.011Z"></path></svg>';
        const hasChildren = item.children && item.children.length > 0;
        const itemId = `tree-${item.path.replace(/\//g, '-')}`;  // Unique ID based on path

        // Item row
        html += `<div class="file-tree-item ${isActive ? 'active' : ''}" style="padding-left: ${indent}px;">`;

        if (item.type === 'directory') {
            html += `<a href="${itemPath}" class="file-tree-folder" style="text-decoration: none; color: var(--color-fg-default);">`;

            // Chevron for folders with children
            if (hasChildren) {
                html += `<span class="file-tree-chevron ${level === 0 ? 'expanded' : ''}" onclick="toggleFolder('${itemId}'); return false;">â–¸</span>`;
            } else {
                html += `<span style="width: 12px; display: inline-block;"></span>`;
            }

            html += `<span class="file-tree-icon">${icon}</span><span>${item.name}</span>`;
            html += `</a>`;
        } else {
            html += `<a href="/${username}/${slug}/blob/${item.path}" class="file-tree-file" style="text-decoration: none; color: var(--color-fg-muted);">`;
            html += `<span style="width: 12px; display: inline-block;"></span>`;
            html += `<span class="file-tree-icon">${icon}</span><span>${item.name}</span>`;
            html += `</a>`;
        }

        html += `</div>`;

        // Children container - render ALL children
        if (hasChildren) {
            const isExpanded = level === 0;  // Auto-expand root level only
            html += `<div id="${itemId}" class="file-tree-children ${isExpanded ? 'expanded' : ''}">`;
            html += buildTreeHTML(item.children, username, slug, level + 1);  // Recursively build all children
            html += `</div>`;
        }
    });

    return html;
}

function toggleFolder(folderId) {
    const folder = document.getElementById(folderId);
    const chevron = event.target;

    if (folder.classList.contains('expanded')) {
        folder.classList.remove('expanded');
        chevron.classList.remove('expanded');
    } else {
        folder.classList.add('expanded');
        chevron.classList.add('expanded');
    }

    event.stopPropagation();
    event.preventDefault();
}

// Make table rows clickable
document.addEventListener('DOMContentLoaded', function() {
    console.log('Page loaded - initializing file tree and dropdown');
    loadFileTree();

    // Add click handlers to table rows
    const clickableRows = document.querySelectorAll('.clickable-row');
    clickableRows.forEach(row => {
        row.addEventListener('click', function(e) {
            // Don't navigate if clicking on a link directly
            if (e.target.tagName === 'A' || e.target.closest('a')) {
                return;
            }
            const href = this.getAttribute('data-href');
            if (href) {
                window.location.href = href;
            }
        });
    });

    // Debug and manually initialize Bootstrap dropdown
    const dropdownToggle = document.querySelector('.dropdown-toggle-split');
    const dropdownMenu = document.querySelector('.dropdown-menu');

    if (dropdownToggle && dropdownMenu) {
        console.log('Dropdown elements found - setting up manual toggle');

        // Manual dropdown toggle (in case Bootstrap JS isn't working)
        dropdownToggle.addEventListener('click', function(e) {
            console.log('Dropdown toggle clicked!');
            e.preventDefault();
            e.stopPropagation();

            const isVisible = dropdownMenu.style.display === 'block';
            dropdownMenu.style.display = isVisible ? 'none' : 'block';
            console.log('Dropdown visibility toggled to:', dropdownMenu.style.display);
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!dropdownToggle.contains(e.target) && !dropdownMenu.contains(e.target)) {
                dropdownMenu.style.display = 'none';
            }
        });
    } else {
        console.warn('Dropdown elements not found:', {dropdownToggle, dropdownMenu});
    }
});

// Toolbar dropdown functions
function toggleBranchDropdown() {
    const dropdown = document.getElementById('branch-dropdown');
    const isVisible = dropdown.style.display === 'block';
    closeAllDropdowns();
    dropdown.style.display = isVisible ? 'none' : 'block';
}

function toggleAddFileDropdown() {
    const dropdown = document.getElementById('add-file-dropdown');
    const isVisible = dropdown.style.display === 'block';
    closeAllDropdowns();
    dropdown.style.display = isVisible ? 'none' : 'block';
}

function toggleCopyDropdown() {
    const dropdown = document.getElementById('copy-dropdown');
    const isVisible = dropdown.style.display === 'block';
    closeAllDropdowns();
    dropdown.style.display = isVisible ? 'none' : 'block';
}

function toggleCodeDropdown() {
    const dropdown = document.getElementById('code-dropdown');
    const isVisible = dropdown.style.display === 'block';
    closeAllDropdowns();
    dropdown.style.display = isVisible ? 'none' : 'block';
}

function toggleMoreDropdown() {
    const dropdown = document.getElementById('more-dropdown');
    const isVisible = dropdown.style.display === 'block';
    closeAllDropdowns();
    dropdown.style.display = isVisible ? 'none' : 'block';
}

function closeAllDropdowns() {
    document.querySelectorAll('.file-browser-toolbar .dropdown-menu').forEach(dropdown => {
        dropdown.style.display = 'none';
    });
}

// Close dropdowns when clicking outside
document.addEventListener('click', function(e) {
    if (!e.target.closest('.file-browser-toolbar .btn-group')) {
        closeAllDropdowns();
    }
});

// Copy to clipboard helper
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        console.log('Copied to clipboard:', text);
    }).catch(err => {
        console.error('Failed to copy:', err);
    });
}

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Switch branch via API
async function switchBranch(branch) {
    console.log('Switching to branch:', branch);

    try {
        // Call the branch switching API
        const response = await fetch('/{{ project.owner.username }}/{{ project.slug }}/api/switch-branch/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ branch: branch })
        });

        const data = await response.json();

        if (data.success) {
            // Reload page to show files from new branch
            window.location.reload();
        } else {
            alert('Failed to switch branch: ' + data.error);
        }
    } catch (error) {
        console.error('Error switching branch:', error);
        alert('Failed to switch branch: ' + error.message);
    }
}

// Add hover effects to dropdown items
document.addEventListener('DOMContentLoaded', function() {
    const dropdownItems = document.querySelectorAll('.file-browser-toolbar .dropdown-item');
    dropdownItems.forEach(item => {
        item.addEventListener('mouseenter', function() {
            this.style.background = 'var(--color-canvas-subtle)';
        });
        item.addEventListener('mouseleave', function() {
            this.style.background = 'transparent';
        });
    });
});

async function copyProjectToClipboard() {
    console.log('copyProjectToClipboard() called');
    const btn = document.getElementById('copy-project-btn');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" style="vertical-align: text-bottom; margin-right: 4px;"><path fill="#6c8ba0" d="M2.75 0a.75.75 0 0 0 0 1.5h.75v1.25a4.75 4.75 0 0 0 1.9 3.8l.333.25c.134.1.134.3 0 .4l-.333.25a4.75 4.75 0 0 0-1.9 3.8v1.25h-.75a.75.75 0 0 0 0 1.5h10.5a.75.75 0 0 0 0-1.5h-.75v-1.25a4.75 4.75 0 0 0-1.9-3.8l-.333-.25a.25.25 0 0 1 0-.4l.333-.25a4.75 4.75 0 0 0 1.9-3.8V1.5h.75a.75.75 0 0 0 0-1.5H2.75Zm7.25 9v3.25h-4V9a3.25 3.25 0 0 1 1.3-2.6l.333-.25a1.75 1.75 0 0 0 0-2.8l-.333-.25A3.25 3.25 0 0 1 6 1.5V0h4v1.5a3.25 3.25 0 0 1-1.3 2.6l-.333.25a1.75 1.75 0 0 0 0 2.8l.333.25A3.25 3.25 0 0 1 10 9.75Z"/></svg> Loading...';
    btn.disabled = true;

    try {
        // Call API to get concatenated content
        console.log('Fetching concatenated content...');
        const response = await fetch('/{{ project.owner.username }}/{{ project.slug }}/api/concatenate/{{ breadcrumb_path }}');
        const data = await response.json();
        console.log('API response:', data);

        if (data.success) {
            await navigator.clipboard.writeText(data.content);
            btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" style="vertical-align: text-bottom; margin-right: 4px;"><path fill="#6c8ba0" fill-rule="evenodd" d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"/></svg> Copied ${data.file_count} files!`;
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }, 3000);
        } else {
            alert('Error: ' + data.error);
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    } catch (err) {
        alert('Failed to copy: ' + err);
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

async function downloadProjectAsFile() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" style="vertical-align: text-bottom; margin-right: 4px;"><path fill="#6c8ba0" d="M2.75 0a.75.75 0 0 0 0 1.5h.75v1.25a4.75 4.75 0 0 0 1.9 3.8l.333.25c.134.1.134.3 0 .4l-.333.25a4.75 4.75 0 0 0-1.9 3.8v1.25h-.75a.75.75 0 0 0 0 1.5h10.5a.75.75 0 0 0 0-1.5h-.75v-1.25a4.75 4.75 0 0 0-1.9-3.8l-.333-.25a.25.25 0 0 1 0-.4l.333-.25a4.75 4.75 0 0 0 1.9-3.8V1.5h.75a.75.75 0 0 0 0-1.5H2.75Zm7.25 9v3.25h-4V9a3.25 3.25 0 0 1 1.3-2.6l.333-.25a1.75 1.75 0 0 0 0-2.8l-.333-.25A3.25 3.25 0 0 1 6 1.5V0h4v1.5a3.25 3.25 0 0 1-1.3 2.6l-.333.25a1.75 1.75 0 0 0 0 2.8l.333.25A3.25 3.25 0 0 1 10 9.75Z"/></svg> Preparing download...';

    try {
        // Call API to get concatenated content
        const response = await fetch('/{{ project.owner.username }}/{{ project.slug }}/api/concatenate/{{ breadcrumb_path }}');
        const data = await response.json();

        if (data.success) {
            // Create a blob and download it
            const blob = new Blob([data.content], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;

            // Generate filename based on project and path
            const dirName = '{{ breadcrumb_path }}'.split('/').filter(x => x).pop() || '{{ project.slug }}';
            a.download = `${dirName}_all_files.txt`;

            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" style="vertical-align: text-bottom; margin-right: 4px;"><path fill="#6c8ba0" fill-rule="evenodd" d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"/></svg> Downloaded ${data.file_count} files!`;
            setTimeout(() => {
                btn.innerHTML = originalText;
            }, 3000);
        } else {
            alert('Error: ' + data.error);
            btn.innerHTML = originalText;
        }
    } catch (err) {
        alert('Failed to download: ' + err);
        btn.innerHTML = originalText;
    }
}

async function copyDirToClipboard() {
    console.log('copyDirToClipboard() called');
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" style="vertical-align: text-bottom; margin-right: 4px;"><path fill="#6c8ba0" d="M2.75 0a.75.75 0 0 0 0 1.5h.75v1.25a4.75 4.75 0 0 0 1.9 3.8l.333.25c.134.1.134.3 0 .4l-.333.25a4.75 4.75 0 0 0-1.9 3.8v1.25h-.75a.75.75 0 0 0 0 1.5h10.5a.75.75 0 0 0 0-1.5h-.75v-1.25a4.75 4.75 0 0 0-1.9-3.8l-.333-.25a.25.25 0 0 1 0-.4l.333-.25a4.75 4.75 0 0 0 1.9-3.8V1.5h.75a.75.75 0 0 0 0-1.5H2.75Zm7.25 9v3.25h-4V9a3.25 3.25 0 0 1 1.3-2.6l.333-.25a1.75 1.75 0 0 0 0-2.8l-.333-.25A3.25 3.25 0 0 1 6 1.5V0h4v1.5a3.25 3.25 0 0 1-1.3 2.6l-.333.25a1.75 1.75 0 0 0 0 2.8l.333.25A3.25 3.25 0 0 1 10 9.75Z"/></svg> Loading...';
    btn.disabled = true;

    try {
        // Call API to get concatenated content
        console.log('Fetching concatenated content...');
        const response = await fetch('/{{ project.owner.username }}/{{ project.slug }}/api/concatenate/{{ breadcrumb_path }}');
        const data = await response.json();
        console.log('API response:', data);

        if (data.success) {
            await navigator.clipboard.writeText(data.content);
            btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" style="vertical-align: text-bottom; margin-right: 4px;"><path fill="#6c8ba0" fill-rule="evenodd" d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"/></svg> Copied ${data.file_count} files!`;
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }, 3000);
        } else {
            alert('Error: ' + data.error);
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    } catch (err) {
        alert('Failed to copy: ' + err);
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

async function downloadDirAsFile() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" style="vertical-align: text-bottom; margin-right: 4px;"><path fill="#6c8ba0" d="M2.75 0a.75.75 0 0 0 0 1.5h.75v1.25a4.75 4.75 0 0 0 1.9 3.8l.333.25c.134.1.134.3 0 .4l-.333.25a4.75 4.75 0 0 0-1.9 3.8v1.25h-.75a.75.75 0 0 0 0 1.5h10.5a.75.75 0 0 0 0-1.5h-.75v-1.25a4.75 4.75 0 0 0-1.9-3.8l-.333-.25a.25.25 0 0 1 0-.4l.333-.25a4.75 4.75 0 0 0 1.9-3.8V1.5h.75a.75.75 0 0 0 0-1.5H2.75Zm7.25 9v3.25h-4V9a3.25 3.25 0 0 1 1.3-2.6l.333-.25a1.75 1.75 0 0 0 0-2.8l-.333-.25A3.25 3.25 0 0 1 6 1.5V0h4v1.5a3.25 3.25 0 0 1-1.3 2.6l-.333.25a1.75 1.75 0 0 0 0 2.8l.333.25A3.25 3.25 0 0 1 10 9.75Z"/></svg> Preparing download...';
    btn.disabled = true;

    try {
        // Call API to get concatenated content
        const response = await fetch('/{{ project.owner.username }}/{{ project.slug }}/api/concatenate/{{ breadcrumb_path }}');
        const data = await response.json();

        if (data.success) {
            // Create a blob and download it
            const blob = new Blob([data.content], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;

            // Generate filename based on project and path
            const dirName = '{{ breadcrumb_path }}'.split('/').filter(x => x).pop() || '{{ project.slug }}';
            a.download = `${dirName}_all_files.txt`;

            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" style="vertical-align: text-bottom; margin-right: 4px;"><path fill="#6c8ba0" fill-rule="evenodd" d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"/></svg> Downloaded ${data.file_count} files!`;
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }, 3000);
        } else {
            alert('Error: ' + data.error);
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    } catch (err) {
        alert('Failed to download: ' + err);
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}
</script>
