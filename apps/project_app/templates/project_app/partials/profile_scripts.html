{% load static %}
<script>
// Simple client-side repository search
document.getElementById('repo-search')?.addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const repoItems = document.querySelectorAll('.repo-item');

    repoItems.forEach(item => {
        const repoName = item.querySelector('.repo-name').textContent.toLowerCase();
        const repoDesc = item.querySelector('.repo-description')?.textContent.toLowerCase() || '';

        if (repoName.includes(searchTerm) || repoDesc.includes(searchTerm)) {
            item.style.display = '';
        } else {
            item.style.display = 'none';
        }
    });
});

// Follow/Unfollow functionality
async function toggleFollow() {
    const btn = document.getElementById('follow-btn');
    const isFollowing = btn.innerHTML.includes('Following');
    const username = '{{ profile_user.username }}';

    const endpoint = isFollowing
        ? `/social/api/unfollow/${username}/`
        : `/social/api/follow/${username}/`;

    try {
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            }
        });

        const data = await response.json();

        if (data.success) {
            // Toggle button state
            if (isFollowing) {
                btn.innerHTML = '<i class="fas fa-user-plus"></i> Follow';
            } else {
                btn.innerHTML = '<i class="fas fa-user-check"></i> Following';
            }

            // Update follower count
            const followerCount = document.querySelector('.profile-stat strong');
            if (followerCount) {
                followerCount.textContent = data.followers_count;
            }
        } else {
            alert(data.error || 'Failed to update follow status');
        }
    } catch (err) {
        console.error('Follow error:', err);
        alert('Failed to update follow status');
    }
}

// Star/Unstar repository functionality
async function toggleStar(btn) {
    const isStarred = btn.innerHTML.includes('Unstar');
    const username = btn.dataset.username;
    const slug = btn.dataset.slug;

    const endpoint = isStarred
        ? `/social/api/unstar/${username}/${slug}/`
        : `/social/api/star/${username}/${slug}/`;

    const originalHTML = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '‚è≥ ...';

    try {
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            }
        });

        const data = await response.json();

        if (data.success) {
            // Toggle button state
            if (isStarred) {
                btn.innerHTML = '<img src="{% static "project_app/icons/star.svg" %}" alt="" style="width: 14px; height: 14px; vertical-align: text-bottom; margin-right: 4px;">Star';
            } else {
                btn.innerHTML = '<img src="{% static "project_app/icons/star.svg" %}" alt="" style="width: 14px; height: 14px; vertical-align: text-bottom; margin-right: 4px;">Unstar';
            }
        } else {
            alert(data.error || 'Failed to update star status');
            btn.innerHTML = originalHTML;
        }
    } catch (err) {
        console.error('Star error:', err);
        alert('Failed to update star status');
        btn.innerHTML = originalHTML;
    } finally {
        btn.disabled = false;
    }
}
</script>
