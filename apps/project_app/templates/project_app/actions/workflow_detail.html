{% extends 'base.html' %}
{% load static %}

{% block title %}{{ workflow.name }} - Actions - {{ project.name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/common/buttons.css' %}">
<style>
.workflow-header {
    padding: 1.5rem 0;
    border-bottom: 1px solid var(--color-border-default);
}

.workflow-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--color-fg-default);
    display: flex;
    align-items: center;
    gap: 1rem;
}

.workflow-actions {
    display: flex;
    gap: 0.5rem;
}

.workflow-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    margin: 1.5rem 0;
}

.stat-card {
    padding: 1rem;
    border: 1px solid var(--color-border-default);
    border-radius: 6px;
    background: var(--color-canvas-default);
}

.stat-value {
    font-size: 1.5rem;
    font-weight: 600;
}

.stat-label {
    font-size: 0.875rem;
    color: var(--color-fg-muted);
    margin-top: 0.25rem;
}

.runs-section {
    margin-top: 2rem;
}

.run-item {
    padding: 1rem;
    border: 1px solid var(--color-border-default);
    border-radius: 6px;
    margin-bottom: 0.5rem;
    background: var(--color-canvas-default);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.run-info {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.run-status-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.875rem;
    font-weight: 500;
}

.run-status-badge.success {
    background: var(--color-success-subtle);
    color: var(--color-success-fg);
}

.run-status-badge.failure {
    background: var(--color-danger-subtle);
    color: var(--color-danger-fg);
}

.run-status-badge.in_progress {
    background: var(--color-accent-subtle);
    color: var(--color-accent-fg);
}

.yaml-viewer {
    margin-top: 2rem;
    border: 1px solid var(--color-border-default);
    border-radius: 6px;
    overflow: hidden;
}

.yaml-viewer-header {
    padding: 0.75rem 1rem;
    background: var(--color-canvas-subtle);
    border-bottom: 1px solid var(--color-border-default);
    font-weight: 600;
}

.yaml-viewer-content {
    padding: 1rem;
    background: var(--color-canvas-default);
    overflow-x: auto;
}

.yaml-viewer-content pre {
    margin: 0;
    font-family: 'Monaco', 'Courier New', monospace;
    font-size: 0.875rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Breadcrumbs -->
    <nav aria-label="breadcrumb" style="margin-top: 1rem;">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'user_projects:detail' project.owner.username project.slug %}">{{ project.name }}</a></li>
            <li class="breadcrumb-item"><a href="{% url 'user_projects:actions_list' project.owner.username project.slug %}">Actions</a></li>
            <li class="breadcrumb-item active">{{ workflow.name }}</li>
        </ol>
    </nav>

    <!-- Workflow Header -->
    <div class="workflow-header">
        <div class="d-flex justify-content-between align-items-start">
            <div class="workflow-title">
                <i class="bi bi-lightning-charge"></i>
                {{ workflow.name }}
                {% if not workflow.enabled %}
                <span class="badge bg-secondary">Disabled</span>
                {% endif %}
            </div>

            {% if project.can_edit %}
            <div class="workflow-actions">
                <button class="btn btn-primary" onclick="triggerWorkflow()">
                    <i class="bi bi-play-circle"></i> Run workflow
                </button>
                <a href="{% url 'user_projects:workflow_edit' project.owner.username project.slug workflow.id %}" class="btn btn-secondary">
                    <i class="bi bi-pencil"></i> Edit
                </a>
                <button class="btn btn-secondary" onclick="toggleWorkflow()">
                    <i class="bi bi-toggle-on"></i> {% if workflow.enabled %}Disable{% else %}Enable{% endif %}
                </button>
                <a href="{% url 'user_projects:workflow_delete' project.owner.username project.slug workflow.id %}" class="btn btn-danger">
                    <i class="bi bi-trash"></i> Delete
                </a>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Statistics -->
    <div class="workflow-stats">
        <div class="stat-card">
            <div class="stat-value">{{ stats.total_runs }}</div>
            <div class="stat-label">Total runs</div>
        </div>
        <div class="stat-card">
            <div class="stat-value text-success">{{ stats.successful }}</div>
            <div class="stat-label">Successful</div>
        </div>
        <div class="stat-card">
            <div class="stat-value text-danger">{{ stats.failed }}</div>
            <div class="stat-label">Failed</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ stats.success_rate }}%</div>
            <div class="stat-label">Success rate</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ stats.avg_duration }}s</div>
            <div class="stat-label">Avg duration</div>
        </div>
    </div>

    <!-- Recent Runs -->
    <div class="runs-section">
        <h2 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem;">Recent runs</h2>

        {% if runs %}
            {% for run in runs %}
            <a href="{% url 'user_projects:workflow_run_detail' project.owner.username project.slug run.id %}" style="text-decoration: none; color: inherit;">
                <div class="run-item">
                    <div class="run-info">
                        <span class="run-status-badge {{ run.conclusion|default:run.status }}">
                            {% if run.conclusion == 'success' %}
                                <i class="bi bi-check-circle-fill"></i> Success
                            {% elif run.conclusion == 'failure' %}
                                <i class="bi bi-x-circle-fill"></i> Failure
                            {% elif run.status == 'in_progress' %}
                                <i class="bi bi-arrow-repeat"></i> In progress
                            {% else %}
                                <i class="bi bi-circle"></i> {{ run.status|title }}
                            {% endif %}
                        </span>
                        <div>
                            <div style="font-weight: 500;">{{ run.workflow.name }} #{{ run.run_number }}</div>
                            <div style="font-size: 0.875rem; color: var(--color-fg-muted);">
                                {{ run.trigger_event|title }} on <code>{{ run.branch|default:"main" }}</code>
                                {% if run.trigger_user %}
                                by {{ run.trigger_user.username }}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div style="text-align: right; color: var(--color-fg-muted); font-size: 0.875rem;">
                        <div>{{ run.created_at|timesince }} ago</div>
                        {% if run.duration_seconds %}
                        <div>{{ run.duration_seconds }}s</div>
                        {% endif %}
                    </div>
                </div>
            </a>
            {% endfor %}

            <!-- Pagination -->
            {% if runs.has_other_pages %}
            <nav aria-label="Page navigation" style="margin-top: 1rem;">
                <ul class="pagination justify-content-center">
                    {% if runs.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ runs.previous_page_number }}">Previous</a>
                    </li>
                    {% endif %}

                    <li class="page-item disabled">
                        <span class="page-link">Page {{ runs.number }} of {{ runs.paginator.num_pages }}</span>
                    </li>

                    {% if runs.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ runs.next_page_number }}">Next</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        {% else %}
            <div class="empty-state" style="text-align: center; padding: 3rem; color: var(--color-fg-muted);">
                <div style="font-size: 3rem; margin-bottom: 1rem;">
                    <i class="bi bi-inbox"></i>
                </div>
                <h3>No runs yet</h3>
                <p>This workflow has not been run yet.</p>
                {% if project.can_edit %}
                <button class="btn btn-primary" onclick="triggerWorkflow()">
                    <i class="bi bi-play-circle"></i> Run workflow now
                </button>
                {% endif %}
            </div>
        {% endif %}
    </div>

    <!-- YAML Viewer -->
    <div class="yaml-viewer">
        <div class="yaml-viewer-header">
            <i class="bi bi-file-code"></i> Workflow definition
        </div>
        <div class="yaml-viewer-content">
            <pre><code>{{ workflow.yaml_content }}</code></pre>
        </div>
    </div>
</div>

<script>
function triggerWorkflow() {
    if (!confirm('Run this workflow now?')) {
        return;
    }

    fetch("{% url 'user_projects:workflow_trigger' project.owner.username project.slug workflow.id %}", {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.href = data.run_url;
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error triggering workflow: ' + error);
    });
}

function toggleWorkflow() {
    fetch("{% url 'user_projects:workflow_enable_disable' project.owner.username project.slug workflow.id %}", {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error toggling workflow: ' + error);
    });
}
</script>
{% endblock %}
