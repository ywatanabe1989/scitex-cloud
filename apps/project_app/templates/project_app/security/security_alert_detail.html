{% extends 'project_app/project_detail.html' %}

{% block title %}{{ alert.title }} - Security - {{ project.name }}{% endblock %}

{% block project_content %}
<div class="container-fluid mt-4">
    <a href="{% url 'user_projects:security_alerts' project.owner.username project.slug %}" class="btn btn-sm btn-outline-secondary mb-3">‚Üê Back to alerts</a>

    <div class="card">
        <div class="card-header">
            <h3>
                {{ alert.title }}
                <span class="badge bg-{{ alert.get_severity_badge_class }} ms-2">{{ alert.get_severity_display }}</span>
                <span class="badge bg-secondary ms-1">{{ alert.get_alert_type_display }}</span>
            </h3>
        </div>
        <div class="card-body">
            <div class="mb-4">
                <h5>Description</h5>
                <p>{{ alert.description }}</p>
            </div>

            {% if alert.affected_package %}
            <div class="mb-4">
                <h5>Affected Package</h5>
                <p><strong>{{ alert.affected_package }}</strong> version <code>{{ alert.affected_version }}</code></p>
                {% if alert.fixed_version %}
                <p class="text-success">Fixed in version: <code>{{ alert.fixed_version }}</code></p>
                {% endif %}
            </div>
            {% endif %}

            {% if alert.cve_id %}
            <div class="mb-4">
                <h5>CVE ID</h5>
                <p><a href="https://nvd.nist.gov/vuln/detail/{{ alert.cve_id }}" target="_blank">{{ alert.cve_id }}</a></p>
            </div>
            {% endif %}

            {% if alert.file_path %}
            <div class="mb-4">
                <h5>Location</h5>
                <p>File: <code>{{ alert.file_path }}</code>{% if alert.line_number %} (Line {{ alert.line_number }}){% endif %}</p>
            </div>
            {% endif %}

            <div class="mb-4">
                <h5>Status</h5>
                <p>
                    {% if alert.status == 'open' %}
                        <span class="badge bg-danger">Open</span>
                    {% elif alert.status == 'fixed' %}
                        <span class="badge bg-success">Fixed</span>
                    {% elif alert.status == 'dismissed' %}
                        <span class="badge bg-secondary">Dismissed</span>
                        {% if alert.dismissed_reason %}
                        <p class="mt-2">Reason: {{ alert.dismissed_reason }}</p>
                        {% endif %}
                    {% endif %}
                </p>
            </div>

            {% if project.can_edit user %}
            <div class="mt-4">
                {% if alert.status == 'open' %}
                <button class="btn btn-warning" onclick="dismissAlert()">Dismiss Alert</button>
                {% if alert.fix_available %}
                <button class="btn btn-primary" onclick="createFixPR()">Create Fix PR</button>
                {% endif %}
                {% elif alert.status == 'dismissed' %}
                <button class="btn btn-primary" onclick="reopenAlert()">Reopen Alert</button>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function dismissAlert() {
    const reason = prompt('Reason for dismissing this alert (optional):');
    if (reason !== null) {
        fetch('{% url "user_projects:api_dismiss_alert" project.owner.username project.slug alert.id %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'reason=' + encodeURIComponent(reason)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Failed to dismiss alert: ' + (data.error || 'Unknown error'));
            }
        });
    }
}

function reopenAlert() {
    fetch('{% url "user_projects:api_reopen_alert" project.owner.username project.slug alert.id %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Failed to reopen alert: ' + (data.error || 'Unknown error'));
        }
    });
}

function createFixPR() {
    alert('Automatic fix PR creation is not yet implemented');
}
</script>
{% endblock %}
