{% extends 'global_base.html' %}
{% load static %}
{% block title %}
    Security
    Alerts - {{ project.name }}
{% endblock %}
{% block extra_css %}
    <link rel="stylesheet"
          href="{% static 'project_app/css/project_app.css' %}" />
    <link rel="stylesheet"
          href="{% static 'project_app/css/shared/buttons.css' %}" />
{% endblock %}
{% block content %}
    <div class="container-fluid" style="max-width: 1280px">
        {% include 'project_app/repository/browse_partials/browse_header.html' %}
        {% include 'project_app/repository/browse_partials/browse_tabs.html' with active_tab='security' %}
        {% include 'project_app/security_overview_partials/security_overview_tabs.html' with active_tab='alerts' %}
        <h2 class="mb-3">Security Alerts</h2>
        <!-- Filters -->
        <div class="card mb-3">
            <div class="card-body">
                <form method="get" class="row g-3">
                    <div class="col-md-3">
                        <label for="statusFilter" class="form-label">Status</label>
                        <select name="status"
                                id="statusFilter"
                                class="form-select"
                                onchange="this.form.submit()">
                            <option value="all" {% if status_filter == "all" %}selected{% endif %}>All</option>
                            <option value="open" {% if status_filter == "open" %}selected{% endif %}>Open</option>
                            <option value="fixed" {% if status_filter == "fixed" %}selected{% endif %}>Fixed</option>
                            <option value="dismissed" {% if status_filter == "dismissed" %}selected{% endif %}>Dismissed</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="severityFilter" class="form-label">Severity</label>
                        <select name="severity"
                                id="severityFilter"
                                class="form-select"
                                onchange="this.form.submit()">
                            <option value="all" {% if severity_filter == "all" %}selected{% endif %}>All</option>
                            <option value="critical" {% if severity_filter == "critical" %}selected{% endif %}>Critical</option>
                            <option value="high" {% if severity_filter == "high" %}selected{% endif %}>High</option>
                            <option value="medium" {% if severity_filter == "medium" %}selected{% endif %}>Medium</option>
                            <option value="low" {% if severity_filter == "low" %}selected{% endif %}>Low</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="typeFilter" class="form-label">Type</label>
                        <select name="type"
                                id="typeFilter"
                                class="form-select"
                                onchange="this.form.submit()">
                            <option value="all" {% if alert_type_filter == "all" %}selected{% endif %}>All</option>
                            <option value="dependency" {% if alert_type_filter == "dependency" %}selected{% endif %}>Dependency</option>
                            <option value="secret" {% if alert_type_filter == "secret" %}selected{% endif %}>Secret</option>
                            <option value="code" {% if alert_type_filter == "code" %}selected{% endif %}>Code</option>
                            <option value="outdated" {% if alert_type_filter == "outdated" %}selected{% endif %}>Outdated</option>
                        </select>
                    </div>
                </form>
            </div>
        </div>
        <!-- Alert List -->
        <div class="card">
            <div class="card-body p-0">
                {% if page_obj %}
                    {% for alert in page_obj %}
                        <div class="border-bottom p-3">
                            <div class="d-flex">
                                <div class="flex-shrink-0 me-3">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="#cf222e">
                                        <path fill-rule="evenodd" d="M8.22 1.754a.25.25 0 00-.44 0L1.698 13.132a.25.25 0 00.22.368h12.164a.25.25 0 00.22-.368L8.22 1.754zm-1.763-.707c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0114.082 15H1.918a1.75 1.75 0 01-1.543-2.575L6.457 1.047zM9 11a1 1 0 11-2 0 1 1 0 012 0zm-.25-5.25a.75.75 0 00-1.5 0v2.5a.75.75 0 001.5 0v-2.5z">
                                        </path>
                                    </svg>
                                </div>
                                <div class="flex-grow-1">
                                    <h5>
                                        <a href="{% url 'user_projects:security_alert_detail' project.owner.username project.slug alert.id %}"
                                           class="text-decoration-none">{{ alert.title }}</a>
                                        <span class="badge bg-{{ alert.get_severity_badge_class }} ms-2">{{ alert.get_severity_display }}</span>
                                        <span class="badge bg-secondary ms-1">{{ alert.get_alert_type_display }}</span>
                                    </h5>
                                    <p class="mb-1 text-muted">{{ alert.description|truncatewords:30 }}</p>
                                    {% if alert.affected_package %}
                                        <p class="mb-1 small">
                                            <strong>Package:</strong> {{ alert.affected_package }} {{
                                            alert.affected_version }}
                                        </p>
                                    {% endif %}
                                    {% if alert.fixed_version %}
                                        <p class="mb-1 small text-success">
                                            <strong>Fixed in:</strong> {{ alert.fixed_version }}
                                        </p>
                                    {% endif %}
                                    <p class="small text-muted">
                                        Opened {{ alert.created_at|timesince }} ago
                                        {% if alert.status == 'dismissed' %}
                                            â€¢ Dismissed by {{ alert.dismissed_by.username }}
                                        {% endif %}
                                    </p>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="p-5 text-center text-muted">
                            <svg width="48" height="48" viewBox="0 0 16 16" fill="currentColor">
                                <path d="M8 1.5c-2.363 0-4 1.69-4 3.75 0 .984.424 1.625.984 2.304l.214.253c.223.264.47.556.673.848.284.411.537.896.621 1.49a.75.75 0 01-1.484.211c-.04-.282-.163-.547-.37-.847a8.695 8.695 0 00-.542-.68c-.084-.1-.173-.205-.268-.32C3.201 7.75 2.5 6.766 2.5 5.25 2.5 2.31 4.863 0 8 0s5.5 2.31 5.5 5.25c0 1.516-.701 2.5-1.328 3.259-.095.115-.184.22-.268.319-.207.245-.383.453-.541.681-.208.3-.33.565-.37.847a.75.75 0 01-1.485-.212c.084-.593.337-1.078.621-1.489.203-.292.45-.584.673-.848.075-.088.147-.173.213-.253.561-.679.985-1.32.985-2.304 0-2.06-1.637-3.75-4-3.75zM6 15.25a.75.75 0 01.75-.75h2.5a.75.75 0 010 1.5h-2.5a.75.75 0 01-.75-.75zM5.75 12.5a.75.75 0 000 1.5h4.5a.75.75 0 000-1.5h-4.5z">
                                </path>
                            </svg>
                            <p class="mt-3">No security alerts found</p>
                        </div>
                    {% endif %}
                </div>
            </div>
            <!-- Pagination -->
            {% if page_obj.has_other_pages %}
                <nav class="mt-3">
                    <ul class="pagination justify-content-center">
                        {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link"
                                   href="?page={{ page_obj.previous_page_number }}&status={{ status_filter }}&severity={{ severity_filter }}&type={{ alert_type_filter }}">Previous</a>
                            </li>
                        {% endif %}
                        <li class="page-item disabled">
                            <span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages
                            }}</span>
                        </li>
                        {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link"
                                   href="?page={{ page_obj.next_page_number }}&status={{ status_filter }}&severity={{ severity_filter }}&type={{ alert_type_filter }}">Next</a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            {% endif %}
        </div>
    {% endblock %}
