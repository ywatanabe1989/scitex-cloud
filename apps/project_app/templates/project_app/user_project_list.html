{% extends 'base.html' %}
{% load static %}

{% block title %}{{ profile_user.username }} - SciTeX Cloud{% endblock %}

{% block extra_css %}
<style>
/* GitHub-inspired layout */
body {
    background-color: var(--color-canvas-default);
    color: var(--color-fg-default);
}

.profile-page {
    max-width: 1280px;
    margin: 0 auto;
    padding: 32px 16px;
}

.profile-layout {
    display: grid;
    grid-template-columns: 296px 1fr;
    gap: 24px;
}

/* Left sidebar - Profile info */
.profile-sidebar {
    position: sticky;
    top: 24px;
    align-self: start;
}

.profile-avatar {
    width: 296px;
    height: 296px;
    border-radius: 50%;
    border: 1px solid var(--color-border-default);
    background: var(--color-canvas-subtle);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 8rem;
    font-weight: 300;
    color: var(--color-accent-fg);
    margin-bottom: 16px;
    overflow: hidden;
}

.profile-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.profile-names {
    margin-bottom: 16px;
}

.profile-fullname {
    font-size: 26px;
    font-weight: 600;
    line-height: 1.25;
    color: var(--color-fg-default);
    margin-bottom: 4px;
}

.profile-username {
    font-size: 20px;
    font-weight: 300;
    line-height: 24px;
    color: var(--color-fg-muted);
}

.profile-username::before {
    content: '@';
}

.profile-bio {
    margin-bottom: 16px;
    font-size: 14px;
    line-height: 1.5;
    color: var(--color-fg-default);
}

.profile-meta {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 16px;
}

.profile-meta-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    color: var(--color-fg-muted);
}

.profile-meta-item i {
    width: 16px;
    color: var(--color-fg-muted);
}

.profile-stats {
    display: flex;
    gap: 16px;
    margin-top: 16px;
    font-size: 14px;
}

.profile-stat {
    color: var(--color-fg-muted);
}

.profile-stat strong {
    color: var(--color-fg-default);
    font-weight: 600;
}

/* Right content area */
.profile-content {
    min-width: 0;
}

/* Navigation tabs */
.profile-nav {
    display: flex;
    gap: 16px;
    border-bottom: 1px solid var(--color-border-muted);
    margin-bottom: 24px;
}

.profile-nav-item {
    padding: 12px 8px;
    color: var(--color-fg-muted);
    text-decoration: none;
    border-bottom: 2px solid transparent;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 8px;
}

.profile-nav-item:hover {
    color: var(--color-fg-default);
    border-bottom-color: var(--color-border-default);
}

.profile-nav-item.active {
    color: var(--color-fg-default);
    border-bottom-color: var(--tab-active-border);
}

.nav-counter {
    background: var(--color-canvas-subtle);
    color: var(--color-fg-default);
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
}

/* Repository section */
.repo-section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

.repo-search {
    display: flex;
    gap: 8px;
}

.repo-search input {
    background: var(--color-canvas-default);
    border: 1px solid var(--color-border-default);
    border-radius: 6px;
    padding: 5px 12px;
    color: var(--color-fg-default);
    font-size: 14px;
}

.repo-search input::placeholder {
    color: var(--color-fg-muted);
}

.repo-search input:focus {
    outline: none;
    border-color: var(--color-accent-fg);
}

/* Repository list */
.repo-list {
    display: flex;
    flex-direction: column;
    gap: 24px;
}

.repo-item {
    border-bottom: 1px solid var(--color-border-muted);
    padding-bottom: 24px;
}

.repo-item:last-child {
    border-bottom: none;
}

.repo-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
}

.repo-name {
    font-size: 20px;
    font-weight: 600;
    color: var(--color-accent-fg);
    text-decoration: none;
    transition: text-decoration 0.1s ease;
}

.repo-name:hover {
    text-decoration: underline;
}

.repo-visibility {
    font-size: 12px;
    padding: 2px 8px;
    border-radius: 12px;
    border: 1px solid var(--color-border-default);
    color: var(--color-fg-muted);
    font-weight: 500;
}

.repo-description {
    color: var(--color-fg-muted);
    font-size: 14px;
    margin-bottom: 12px;
    line-height: 1.5;
}

.repo-meta {
    display: flex;
    align-items: center;
    gap: 16px;
    font-size: 12px;
    color: var(--color-fg-muted);
}

.repo-meta-item {
    display: flex;
    align-items: center;
    gap: 4px;
}

.language-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
}

/* Empty state */
.empty-state {
    text-align: center;
    padding: 48px 24px;
    background: var(--color-canvas-default);
    border: 1px solid var(--color-border-muted);
    border-radius: 6px;
    margin-top: 24px;
}

.empty-state-icon {
    font-size: 48px;
    color: var(--color-border-default);
    margin-bottom: 16px;
}

.empty-state h3 {
    color: var(--color-fg-default);
    font-size: 24px;
    margin-bottom: 8px;
}

.empty-state p {
    color: var(--color-fg-muted);
    font-size: 14px;
    margin-bottom: 24px;
}

/* Buttons */
.btn-edit-profile {
    width: 100%;
    background: var(--color-btn-bg);
    color: var(--color-btn-text);
    border: 1px solid var(--color-btn-border);
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    text-decoration: none;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.2s ease;
    margin-bottom: 16px;
}

.btn-edit-profile:hover {
    background: var(--color-btn-hover-bg);
    border-color: var(--color-btn-hover-border);
    text-decoration: none;
    color: var(--color-btn-text);
}

.btn-new-repo {
    background: var(--color-btn-primary-bg);
    color: var(--color-btn-primary-text);
    border: 1px solid var(--color-btn-primary-border);
    padding: 5px 16px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: background 0.2s ease;
}

.btn-new-repo:hover {
    background: var(--color-btn-primary-hover-bg);
    color: var(--color-btn-primary-text);
}

/* Pagination */
.pagination-link {
    padding: 8px 16px;
    background: var(--color-btn-bg);
    color: var(--color-fg-default);
    border-radius: 6px;
    text-decoration: none;
    transition: all 0.2s ease;
}

.pagination-link:hover {
    background: var(--color-btn-hover-bg);
    text-decoration: none;
}

.pagination-info {
    padding: 8px 16px;
    color: var(--color-fg-muted);
}

/* Responsive */
@media (max-width: 768px) {
    .profile-layout {
        grid-template-columns: 1fr;
    }

    .profile-sidebar {
        position: static;
    }

    .profile-avatar {
        width: 200px;
        height: 200px;
        font-size: 5rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="profile-page">
    <div class="profile-layout">
        <!-- Left Sidebar - Profile Info -->
        <aside class="profile-sidebar">
            <div class="profile-avatar">
                {% if profile_user.profile.avatar %}
                    <img src="{{ profile_user.profile.avatar.url }}" alt="{{ profile_user.username }}">
                {% else %}
                    {{ profile_user.username|slice:":1"|upper }}
                {% endif %}
            </div>

            <div class="profile-names">
                <div class="profile-fullname">
                    {{ profile_user.get_full_name|default:profile_user.username }}
                </div>
                <div class="profile-username">{{ profile_user.username }}</div>
            </div>

            {% if user.is_authenticated and user == profile_user %}
            <a href="{% url 'accounts_app:profile_edit' %}" class="btn-edit-profile">
                <i class="fas fa-cog"></i>
                Edit profile
            </a>
            {% elif user.is_authenticated %}
            <button id="follow-btn" class="btn-edit-profile" onclick="toggleFollow()">
                {% if is_following %}
                    <i class="fas fa-user-check"></i>
                    Following
                {% else %}
                    <i class="fas fa-user-plus"></i>
                    Follow
                {% endif %}
            </button>
            {% endif %}

            {% if profile_user.profile.bio %}
            <div class="profile-bio">
                {{ profile_user.profile.bio }}
            </div>
            {% endif %}

            <div class="profile-meta">
                {% if profile_user.profile.institution %}
                <div class="profile-meta-item">
                    <i class="fas fa-university"></i>
                    <span>{{ profile_user.profile.institution }}</span>
                </div>
                {% endif %}
                {% if profile_user.profile.location %}
                <div class="profile-meta-item">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>{{ profile_user.profile.location }}</span>
                </div>
                {% endif %}
                {% if profile_user.email %}
                <div class="profile-meta-item">
                    <i class="fas fa-envelope"></i>
                    <span>{{ profile_user.email }}</span>
                </div>
                {% endif %}
            </div>

            <div class="profile-stats">
                <div class="profile-stat">
                    <strong>{{ followers_count }}</strong> <a href="#" style="color: var(--color-fg-muted); text-decoration: none;">followers</a>
                </div>
                <div class="profile-stat">
                    <strong>{{ following_count }}</strong> <a href="#" style="color: var(--color-fg-muted); text-decoration: none;">following</a>
                </div>
            </div>

            <div class="profile-stats" style="margin-top: 8px;">
                <div class="profile-stat">
                    <strong>{{ projects.paginator.count }}</strong> repositories
                </div>
            </div>
        </aside>

        <!-- Right Content Area -->
        <main class="profile-content">
            <!-- Navigation Tabs -->
            <nav class="profile-nav">
                <a href="?tab=overview" class="profile-nav-item {% if active_tab == 'overview' %}active{% endif %}">
                    <i class="fas fa-book"></i>
                    Overview
                </a>
                <a href="?tab=repositories" class="profile-nav-item {% if active_tab == 'repositories' %}active{% endif %}">
                    <i class="fas fa-book-open"></i>
                    Repositories
                    <span class="nav-counter">{{ projects.paginator.count }}</span>
                </a>
                <a href="?tab=projects" class="profile-nav-item {% if active_tab == 'projects' %}active{% endif %}">
                    <i class="fas fa-table"></i>
                    Projects
                    <span class="nav-counter">0</span>
                </a>
                <a href="?tab=stars" class="profile-nav-item {% if active_tab == 'stars' %}active{% endif %}">
                    <i class="fas fa-star"></i>
                    Stars
                    <span class="nav-counter">0</span>
                </a>
            </nav>

            {% block profile_content %}
            <!-- Repository Section Header -->
            <div class="repo-section-header">
                <div class="repo-search">
                    <input type="text" placeholder="Find a repository..." id="repo-search">
                </div>
                {% if user.is_authenticated and user == profile_user %}
                <a href="{% url 'project_create' %}" class="btn-new-repo">
                    <i class="fas fa-book"></i>
                    New
                </a>
                {% endif %}
            </div>

            <!-- Repository List -->
            {% if projects %}
            <div class="repo-list">
                {% for project in projects %}
                <article class="repo-item">
                    <div class="repo-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <a href="{{ project.get_absolute_url }}" class="repo-name">
                                {{ project.name }}
                            </a>
                            <span class="repo-visibility">
                                {% if project.visibility == 'private' %}
                                    <img src="{% static 'project_app/icons/lock.svg' %}" alt="" style="width: 14px; height: 14px; vertical-align: text-bottom; margin-right: 4px;">Private
                                {% else %}
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="14" height="14" style="vertical-align: text-bottom; margin-right: 4px;"><path fill="#6c8ba0" d="M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0ZM1.5 8a6.5 6.5 0 1 0 13 0 6.5 6.5 0 0 0-13 0Zm6.5-3a.75.75 0 0 1 .75.75v4.5a.75.75 0 0 1-1.5 0v-4.5A.75.75 0 0 1 8 5Zm0-2.5a.875.875 0 1 1 0 1.75.875.875 0 0 1 0-1.75Z"/></svg>Public
                                {% endif %}
                            </span>
                        </div>
                        {% if user.is_authenticated %}
                        <button class="star-btn" data-username="{{ project.owner.username }}" data-slug="{{ project.slug }}" onclick="toggleStar(this)" style="background: transparent; border: 1px solid var(--color-border-default); color: var(--color-fg-default); padding: 4px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; transition: all 0.2s;">
                            <img src="{% static 'project_app/icons/star.svg' %}" alt="" style="width: 14px; height: 14px; vertical-align: text-bottom; margin-right: 4px;">Star
                        </button>
                        {% endif %}
                    </div>

                    {% if project.description %}
                    <p class="repo-description">
                        {{ project.description|truncatewords:30 }}
                    </p>
                    {% endif %}

                    <div class="repo-meta">
                        <span class="repo-meta-item">
                            <span class="language-dot" style="background-color: #3572A5;"></span>
                            <span>Python</span>
                        </span>
                        <span class="repo-meta-item">
                            Updated {{ project.updated_at|timesince }} ago
                        </span>
                    </div>
                </article>
                {% endfor %}
            </div>

            <!-- Pagination -->
            {% if projects.has_other_pages %}
            <nav aria-label="Repository pagination" style="margin-top: 32px;">
                <div style="display: flex; justify-content: center; gap: 8px;">
                    {% if projects.has_previous %}
                    <a href="?page={{ projects.previous_page_number }}" class="pagination-link">
                        Previous
                    </a>
                    {% endif %}

                    <span class="pagination-info">
                        {{ projects.number }} / {{ projects.paginator.num_pages }}
                    </span>

                    {% if projects.has_next %}
                    <a href="?page={{ projects.next_page_number }}" class="pagination-link">
                        Next
                    </a>
                    {% endif %}
                </div>
            </nav>
            {% endif %}
            {% else %}
            <!-- Empty State -->
            <div class="empty-state">
                <div class="empty-state-icon">
                    <i class="fas fa-book-open"></i>
                </div>
                <h3>{{ profile_user.username }} doesn't have any public repositories yet.</h3>
                {% if user.is_authenticated and user == profile_user %}
                <p>Create your first repository to start building with SciTeX.</p>
                <a href="{% url 'project_create' %}" class="btn-new-repo">
                    <i class="fas fa-book"></i>
                    Create a new repository
                </a>
                {% endif %}
            </div>
            {% endif %}
            {% endblock profile_content %}
        </main>
    </div>
</div>

<script>
// Simple client-side repository search
document.getElementById('repo-search')?.addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const repoItems = document.querySelectorAll('.repo-item');

    repoItems.forEach(item => {
        const repoName = item.querySelector('.repo-name').textContent.toLowerCase();
        const repoDesc = item.querySelector('.repo-description')?.textContent.toLowerCase() || '';

        if (repoName.includes(searchTerm) || repoDesc.includes(searchTerm)) {
            item.style.display = '';
        } else {
            item.style.display = 'none';
        }
    });
});

// Follow/Unfollow functionality
async function toggleFollow() {
    const btn = document.getElementById('follow-btn');
    const isFollowing = btn.innerHTML.includes('Following');
    const username = '{{ profile_user.username }}';

    const endpoint = isFollowing
        ? `/social/api/unfollow/${username}/`
        : `/social/api/follow/${username}/`;

    try {
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            }
        });

        const data = await response.json();

        if (data.success) {
            // Toggle button state
            if (isFollowing) {
                btn.innerHTML = '<i class="fas fa-user-plus"></i> Follow';
            } else {
                btn.innerHTML = '<i class="fas fa-user-check"></i> Following';
            }

            // Update follower count
            const followerCount = document.querySelector('.profile-stat strong');
            if (followerCount) {
                followerCount.textContent = data.followers_count;
            }
        } else {
            alert(data.error || 'Failed to update follow status');
        }
    } catch (err) {
        console.error('Follow error:', err);
        alert('Failed to update follow status');
    }
}

// Star/Unstar repository functionality
async function toggleStar(btn) {
    const isStarred = btn.innerHTML.includes('Unstar');
    const username = btn.dataset.username;
    const slug = btn.dataset.slug;

    const endpoint = isStarred
        ? `/social/api/unstar/${username}/${slug}/`
        : `/social/api/star/${username}/${slug}/`;

    const originalHTML = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '‚è≥ ...';

    try {
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            }
        });

        const data = await response.json();

        if (data.success) {
            // Toggle button state
            if (isStarred) {
                btn.innerHTML = '<img src="{% static "project_app/icons/star.svg" %}" alt="" style="width: 14px; height: 14px; vertical-align: text-bottom; margin-right: 4px;">Star';
            } else {
                btn.innerHTML = '<img src="{% static "project_app/icons/star.svg" %}" alt="" style="width: 14px; height: 14px; vertical-align: text-bottom; margin-right: 4px;">Unstar';
            }
        } else {
            alert(data.error || 'Failed to update star status');
            btn.innerHTML = originalHTML;
        }
    } catch (err) {
        console.error('Star error:', err);
        alert('Failed to update star status');
        btn.innerHTML = originalHTML;
    } finally {
        btn.disabled = false;
    }
}
</script>
{% endblock %}
