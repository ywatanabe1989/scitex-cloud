{% extends 'global_base.html' %}
{% load static %}

{% block title %}Repository Maintenance - SciTeX Cloud{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/common/buttons.css' %}">
<style>
.maintenance-container {
    max-width: 1200px;
    margin: 2rem auto;
    padding: 0 1rem;
}

.maintenance-header {
    margin-bottom: 3rem;
}

.maintenance-header h1 {
    font-size: 2rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--color-fg-default);
}

.maintenance-header p {
    color: var(--color-fg-muted);
    font-size: 1rem;
}

/* Status cards */
.health-status {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin-bottom: 3rem;
}

.health-card {
    background: var(--color-canvas-default);
    border: 1px solid var(--color-border-default);
    border-radius: 0.5rem;
    padding: 1.5rem;
    text-align: center;
}

.health-card-value {
    font-size: 2rem;
    font-weight: 700;
    color: var(--color-fg-default);
    margin-bottom: 0.5rem;
}

.health-card-label {
    font-size: 0.875rem;
    color: var(--color-fg-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.health-card.critical {
    border-color: #da3633;
    background-color: rgba(218, 54, 51, 0.05);
}

.health-card.warning {
    border-color: #d4a574;
    background-color: rgba(212, 165, 116, 0.05);
}

.health-card.success {
    border-color: #1a7f3a;
    background-color: rgba(26, 127, 58, 0.05);
}

/* Loading state */
.loading-spinner {
    display: inline-block;
    width: 1rem;
    height: 1rem;
    border: 2px solid var(--color-border-default);
    border-top-color: var(--color-accent-fg);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin-right: 0.5rem;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Issues list */
.issues-section {
    margin-bottom: 3rem;
}

.issues-section h2 {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 1rem;
    color: var(--color-fg-default);
}

.issues-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.issue-item {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    padding: 1.5rem;
    background: var(--color-canvas-default);
    border: 1px solid var(--color-border-default);
    border-radius: 0.5rem;
}

.issue-header {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
}

.issue-status-columns {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid var(--color-border-default);
}

.status-column {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.status-label {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    color: var(--color-fg-muted);
    letter-spacing: 0.05em;
}

.status-value {
    font-size: 0.875rem;
    color: var(--color-fg-default);
    font-family: monospace;
    word-break: break-all;
}

.issue-icon {
    font-size: 1.5rem;
    margin-top: 0.125rem;
    flex-shrink: 0;
}

.issue-icon.healthy { color: #1a7f3a; }
.issue-icon.critical { color: #da3633; }
.issue-icon.warning { color: #d4a574; }

.issue-content {
    flex: 1;
    min-width: 0;
}

.issue-title {
    font-weight: 600;
    color: var(--color-fg-default);
    word-break: break-all;
}

.issue-name {
    font-family: monospace;
    background: var(--color-canvas-subtle);
    padding: 0.125rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.875rem;
}

.issue-message {
    font-size: 0.875rem;
    color: var(--color-fg-muted);
    margin-top: 0.25rem;
}

.issue-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    margin-top: 0.75rem;
}

.issue-button {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
    border: 1px solid var(--color-border-default);
    border-radius: 0.25rem;
    background: var(--color-canvas-subtle);
    color: var(--color-fg-default);
    cursor: pointer;
    transition: all 0.2s;
}

.issue-button:hover {
    background: var(--color-canvas-default);
    border-color: var(--color-accent-fg);
    color: var(--color-accent-fg);
}

.issue-button.delete {
    color: #da3633;
    border-color: #da3633;
}

.issue-button.delete:hover {
    background: rgba(218, 54, 51, 0.1);
}

.issue-button.sync {
    color: #0969da;
    border-color: #0969da;
}

.issue-button.sync:hover {
    background: rgba(9, 105, 218, 0.1);
}

.issue-button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.issue-status {
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.status-processing {
    background: rgba(9, 105, 218, 0.1);
    color: #0969da;
}

.status-success {
    background: rgba(26, 127, 58, 0.1);
    color: #1a7f3a;
}

.status-error {
    background: rgba(218, 54, 51, 0.1);
    color: #da3633;
}

/* Empty state */
.empty-state {
    text-align: center;
    padding: 3rem 1rem;
}

.empty-state-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
}

.empty-state-title {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--color-fg-default);
}

.empty-state-message {
    color: var(--color-fg-muted);
}

/* Modal/Dialog */
.confirmation-dialog {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
}

.confirmation-dialog.show {
    display: flex;
}

.dialog-content {
    background: var(--color-canvas-default);
    border-radius: 0.5rem;
    padding: 2rem;
    max-width: 500px;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
}

.dialog-title {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 1rem;
    color: var(--color-fg-default);
}

.dialog-message {
    color: var(--color-fg-muted);
    margin-bottom: 1.5rem;
    line-height: 1.5;
}

.dialog-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
}

.dialog-button {
    padding: 0.5rem 1rem;
    border-radius: 0.25rem;
    border: none;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s;
}

.dialog-button.cancel {
    background: var(--color-canvas-subtle);
    color: var(--color-fg-default);
    border: 1px solid var(--color-border-default);
}

.dialog-button.cancel:hover {
    background: var(--color-canvas-default);
    border-color: var(--color-accent-fg);
}

.dialog-button.confirm {
    background: #da3633;
    color: white;
}

.dialog-button.confirm:hover {
    background: #bf2626;
}

/* Error message */
.error-message {
    background: rgba(218, 54, 51, 0.1);
    border: 1px solid #da3633;
    color: #da3633;
    padding: 1rem;
    border-radius: 0.5rem;
    margin-bottom: 1rem;
}

.error-message strong {
    font-weight: 600;
}
</style>
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="maintenance-container">
    <!-- Header -->
    <div class="maintenance-header">
        <h1>Repository Maintenance</h1>
        <p>Monitor and manage the health of your Git repositories</p>
    </div>

    <!-- Error message -->
    <div id="error-message" class="error-message" style="display: none;">
        <strong>Error:</strong> <span id="error-text"></span>
    </div>

    <!-- Health status cards -->
    <div class="health-status" id="health-status">
        <div class="health-card">
            <div class="loading-spinner"></div>
            <div class="health-card-label">Loading...</div>
        </div>
    </div>

    <!-- Issues list -->
    <div class="issues-section">
        <h2>Repository Status</h2>
        <div class="issues-list" id="issues-list">
            <div style="text-align: center; padding: 2rem; color: var(--color-fg-muted);">
                <div class="loading-spinner"></div>
                Loading repository information...
            </div>
        </div>
    </div>
</div>

<!-- Confirmation dialog -->
<div class="confirmation-dialog" id="confirmation-dialog">
    <div class="dialog-content">
        <div class="dialog-title">Confirm Action</div>
        <div class="dialog-message" id="dialog-message"></div>
        <div class="dialog-actions">
            <button type="button" class="dialog-button cancel" id="dialog-cancel" onclick="closeDialog()">Cancel</button>
            <button type="button" class="dialog-button confirm" id="dialog-confirm" onclick="executeAction()">Confirm</button>
        </div>
    </div>
</div>

<script>
const username = "{{ username }}";
let healthData = null;
let pendingAction = null;

// Load repository health status
function loadRepositoryHealth() {
    fetch(`/${username}/api/repository-health/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                healthData = data;
                renderHealthStatus(data);
                renderIssues(data);
            } else {
                showError(data.error || "Failed to load repository health");
            }
        })
        .catch(error => {
            console.error("Error:", error);
            showError("Failed to connect to server");
        });
}

function renderHealthStatus(data) {
    const stats = data.stats;
    const html = `
        <div class="health-card success">
            <div class="health-card-value">${stats.healthy_count}</div>
            <div class="health-card-label">Healthy</div>
        </div>
        <div class="health-card ${stats.warnings > 0 ? 'warning' : 'success'}">
            <div class="health-card-value">${stats.warnings}</div>
            <div class="health-card-label">Warnings</div>
        </div>
        <div class="health-card ${stats.critical_issues > 0 ? 'critical' : 'success'}">
            <div class="health-card-value">${stats.critical_issues}</div>
            <div class="health-card-label">Critical</div>
        </div>
        <div class="health-card">
            <div class="health-card-value">${stats.total_django_projects}</div>
            <div class="health-card-label">Total Projects</div>
        </div>
    `;
    document.getElementById("health-status").innerHTML = html;
}

function renderIssues(data) {
    const issues = data.issues;

    if (issues.length === 0) {
        document.getElementById("issues-list").innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">âœ“</div>
                <div class="empty-state-title">All repositories are healthy!</div>
                <div class="empty-state-message">No synchronization issues detected</div>
            </div>
        `;
        return;
    }

    const html = issues.map(issue => {
        const icon = issue.is_healthy ? 'âœ“' : (issue.is_critical ? 'âœ—' : 'âš ');
        const iconClass = issue.is_healthy ? 'healthy' : (issue.is_critical ? 'critical' : 'warning');
        const name = issue.project_slug || issue.gitea_name;

        // Determine status for three columns
        let localStatus = 'â€”';
        let djangoStatus = 'â€”';
        let giteaStatus = 'â€”';
        let issueTypeDisplay = '';

        if (issue.issue_type === 'healthy') {
            localStatus = 'âœ“ Local';
            djangoStatus = 'âœ“ Project';
            giteaStatus = 'âœ“ Repository';
            issueTypeDisplay = 'In sync';
        } else if (issue.issue_type === 'orphaned_in_gitea') {
            localStatus = 'â€”';
            djangoStatus = 'â€”';
            giteaStatus = 'âœ“ Repository';
            issueTypeDisplay = 'Orphaned in Gitea';
        } else if (issue.issue_type === 'missing_in_gitea') {
            localStatus = '?';
            djangoStatus = 'âœ“ Project';
            giteaStatus = 'âœ— Missing';
            issueTypeDisplay = 'Repository missing';
        } else if (issue.issue_type === 'missing_directory') {
            localStatus = 'âœ— Missing';
            djangoStatus = 'âœ“ Project';
            giteaStatus = 'âœ“ Repository';
            issueTypeDisplay = 'Local directory missing';
        }

        let actions = '';

        if (issue.issue_type === 'orphaned_in_gitea') {
            actions = `
                <button class="issue-button sync" onclick="confirmRestore('${escapeHtml(name)}')">
                    â†º Restore Project
                </button>
            `;
        } else if (issue.issue_type === 'missing_in_gitea' || issue.issue_type === 'missing_directory') {
            actions = `
                <button class="issue-button sync" onclick="confirmSync('${escapeHtml(name)}')">
                    ðŸ”„ Sync Repository
                </button>
            `;
        }

        return `
            <div class="issue-item">
                <div class="issue-header">
                    <div class="issue-icon ${iconClass}">${icon}</div>
                    <div class="issue-content" style="flex: 1;">
                        <div class="issue-title">
                            <span class="issue-name">${escapeHtml(name)}</span>
                            <span style="margin-left: 0.5rem; color: var(--color-fg-muted);">${issueTypeDisplay}</span>
                        </div>
                        <div style="font-size: 0.875rem; color: var(--color-fg-muted); margin-top: 0.25rem;">
                            ${issue.message}
                        </div>
                    </div>
                </div>
                <div class="issue-status-columns">
                    <div class="status-column">
                        <div class="status-label">Local</div>
                        <div class="status-value">${localStatus}</div>
                    </div>
                    <div class="status-column">
                        <div class="status-label">Django Project</div>
                        <div class="status-value">${djangoStatus}</div>
                    </div>
                    <div class="status-column">
                        <div class="status-label">Gitea Repository</div>
                        <div class="status-value">${giteaStatus}</div>
                    </div>
                </div>
                <div class="issue-actions">
                    ${actions}
                </div>
            </div>
        `;
    }).join('');

    document.getElementById("issues-list").innerHTML = html;
}

function confirmRestore(repositoryName) {
    pendingAction = {
        type: 'restore',
        name: repositoryName,
        projectName: repositoryName  // Default to repo name
    };

    const dialog = document.getElementById("confirmation-dialog");
    const projectNameId = 'restore-project-name-input';

    document.getElementById("dialog-message").innerHTML = `
        <p>Restore this orphaned repository by creating a new project?</p>
        <p style="margin: 1rem 0; font-family: monospace; background: var(--color-canvas-subtle); padding: 0.5rem; border-radius: 0.25rem; word-break: break-all;">
            ${escapeHtml(repositoryName)}
        </p>
        <div style="margin: 1rem 0;">
            <label for="${projectNameId}" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">
                Project name for restored repository:
            </label>
            <input type="text" id="${projectNameId}" value="${escapeHtml(repositoryName)}"
                   style="width: 100%; padding: 0.5rem; border: 1px solid var(--color-border-default);
                   border-radius: 0.25rem; background: var(--color-canvas-subtle); color: var(--color-fg-default);">
        </div>
        <p><strong>Note:</strong> This will create a new Django project linked to the existing Gitea repository and clone it to your local filesystem.</p>
    `;

    dialog.classList.add("show");

    // Focus the input and set up event listener
    setTimeout(() => {
        const input = document.getElementById(projectNameId);
        if (input) {
            input.focus();
            input.addEventListener("keypress", (e) => {
                if (e.key === 'Enter') {
                    executeAction();
                }
            });
        }
    }, 100);
}

function confirmDelete(repositoryName) {
    pendingAction = {
        type: 'delete',
        name: repositoryName
    };

    const dialog = document.getElementById("confirmation-dialog");
    document.getElementById("dialog-message").innerHTML = `
        <p>Are you sure you want to delete this orphaned repository?</p>
        <p style="margin: 1rem 0; font-family: monospace; background: var(--color-canvas-subtle); padding: 0.5rem; border-radius: 0.25rem; word-break: break-all;">
            ${escapeHtml(repositoryName)}
        </p>
        <p><strong>Warning:</strong> This action cannot be undone. The repository will be permanently deleted from Gitea.</p>
    `;

    dialog.classList.add("show");
}

function confirmSync(projectSlug) {
    pendingAction = {
        type: 'sync',
        name: projectSlug
    };

    const dialog = document.getElementById("confirmation-dialog");
    document.getElementById("dialog-message").innerHTML = `
        <p>Sync this repository with Gitea?</p>
        <p style="margin: 1rem 0; font-family: monospace; background: var(--color-canvas-subtle); padding: 0.5rem; border-radius: 0.25rem; word-break: break-all;">
            ${escapeHtml(projectSlug)}
        </p>
        <p>This will re-clone the repository from Gitea if the local directory is missing.</p>
    `;

    dialog.classList.add("show");
}

function closeDialog() {
    document.getElementById("confirmation-dialog").classList.remove("show");
    pendingAction = null;
}

function executeAction() {
    if (!pendingAction) return;

    const { type, name } = pendingAction;

    if (type === 'restore') {
        // Get the project name from the input field
        const input = document.getElementById('restore-project-name-input');
        if (input) {
            pendingAction.projectName = input.value.trim();
        }
        closeDialog();
        restoreRepository(name, pendingAction.projectName);
    } else {
        closeDialog();
        if (type === 'delete') {
            deleteRepository(name);
        } else if (type === 'sync') {
            syncRepository(name);
        }
    }
}

function deleteRepository(repositoryName) {
    const body = JSON.stringify({ gitea_name: repositoryName });

    fetch(`/${username}/api/repository-cleanup/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: body
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reload health status
            setTimeout(loadRepositoryHealth, 500);
        } else {
            showError(data.message || data.error);
        }
    })
    .catch(error => {
        console.error("Error:", error);
        showError("Failed to delete repository");
    });
}

function syncRepository(projectSlug) {
    const body = JSON.stringify({ project_slug: projectSlug });

    fetch(`/${username}/api/repository-sync/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: body
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reload health status
            setTimeout(loadRepositoryHealth, 500);
        } else {
            showError(data.message || data.error);
        }
    })
    .catch(error => {
        console.error("Error:", error);
        showError("Failed to sync repository");
    });
}

function restoreRepository(repositoryName, projectName) {
    const body = JSON.stringify({
        gitea_name: repositoryName,
        project_name: projectName
    });

    console.log("Restoring repository:", repositoryName, "as project:", projectName);
    console.log("CSRF Token:", getCSRFToken());

    fetch(`/${username}/api/repository-restore/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: body
    })
    .then(response => {
        console.log("Response status:", response.status);
        return response.json();
    })
    .then(data => {
        console.log("Response data:", data);
        if (data.success) {
            // Redirect to the newly created project
            if (data.project_id) {
                const slugifiedName = projectName
                    .toLowerCase()
                    .replace(/\s+/g, '-')
                    .replace(/[^\w\-]/g, '');
                console.log("Redirecting to:", `/${username}/${slugifiedName}/`);
                setTimeout(() => {
                    window.location.href = `/${username}/${slugifiedName}/`;
                }, 500);
            } else {
                // Fallback: just reload the health page
                console.log("Reloading health page");
                setTimeout(loadRepositoryHealth, 500);
            }
        } else {
            console.error("API Error:", data);
            showError(data.message || data.error);
        }
    })
    .catch(error => {
        console.error("Error:", error);
        showError("Failed to restore repository");
    });
}

function showError(message) {
    const errorEl = document.getElementById("error-message");
    document.getElementById("error-text").textContent = message;
    errorEl.style.display = "block";
    setTimeout(() => {
        errorEl.style.display = "none";
    }, 5000);
}

function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
}

function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
}

// Dialog backdrop click to close
document.getElementById("confirmation-dialog").addEventListener("click", (e) => {
    if (e.target === document.getElementById("confirmation-dialog")) {
        closeDialog();
    }
});

// Load on page load
document.addEventListener("DOMContentLoaded", loadRepositoryHealth);
</script>
{% endblock %}
