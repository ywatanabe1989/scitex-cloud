{% extends "scholar_app/base.html" %}
{% load static %}

{% block title %}SciTeX Scholar - Literature Search{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'common/css/hero-gradients.css' %}">
<style>
    .search-hero {
        background: linear-gradient(135deg, #1a2332 0%, #34495e 100%);
        color: white;
        padding: 4rem 0;
        margin-bottom: 2rem;
    }
    .search-card {
        background: rgba(255,255,255,0.98);
        border-radius: 20px;
        padding: 2rem;
        backdrop-filter: blur(10px);
        box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        border: 1px solid rgba(255,255,255,0.3);
    }
    .search-input {
        border: 1px solid #ced4da;
        border-radius: 15px;
        padding: 1rem 1.5rem;
        font-size: 1.1rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        background: white;
    }
    .search-input:focus {
        border-color: #506b7a;
        box-shadow: 0 0 0 0.2rem rgba(80, 107, 122, 0.25);
    }
    .search-btn {
        border-radius: 15px;
        padding: 1rem 2rem;
        font-weight: 600;
        background: #1a2332;
        border: none;
        color: white;
    }
    .search-btn:hover {
        background: #2d3748;
        color: white;
    }
    .result-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border-left: 4px solid #1a2332;
    }
    .result-title {
        color: #1a2332;
        font-weight: 600;
        font-size: 1.1rem;
        margin-bottom: 0.5rem;
        text-decoration: none;
    }
    .result-title:hover {
        color: #34495e;
    }
    .result-authors {
        color: #7f8c8d;
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
    }
    .result-snippet {
        color: #34495e;
        font-size: 0.9rem;
        line-height: 1.5;
        margin-top: 1rem;
    }
    .simple-filter {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    .year-badge {
        background: #e9ecef;
        color: #495057;
        padding: 0.25rem 0.5rem;
        border-radius: 8px;
        font-size: 0.8rem;
    }
    .open-access {
        background: #28a745;
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 8px;
        font-size: 0.8rem;
    }
    .abstract-full {
        line-height: 1.5;
    }
    .abstract-toggle {
        cursor: pointer;
        text-decoration: none !important;
    }
    .abstract-toggle:hover {
        text-decoration: underline !important;
    }
</style>
{% endblock %}

{% block content %}
<!-- Super Simple Search -->
<div class="hero-section hero-silverish-ai-light hero-scholar">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="text-center mb-4">
                    <h1 class="hero-title">SciTeX Scholar</h1>
                    <p class="hero-subtitle">AI-Powered Literature Discovery & Analysis</p>
                </div>
                
                <div class="search-card">
                    <form method="get">
                        <div class="input-group input-group-lg">
                            <input type="text" name="q" class="form-control search-input" 
                                   placeholder="neural mechanisms of visual attention"
                                   value="{{ query }}" autofocus>
                            <button type="submit" class="btn search-btn" id="searchButton">
                                üîç Search Web
                            </button>
                            <button type="button" class="btn search-btn ms-2" id="progressiveSearchButton" style="display: none;">
                                ‚ö° Progressive Search
                            </button>
                        </div>
                        
                        <div class="mt-3">
                            <!-- Advanced Filters Toggle -->
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <small class="text-muted">Filters:</small>
                                <button type="button" class="btn btn-outline-primary btn-sm" id="toggleAdvancedFilters">
                                    <i class="fas fa-sliders-h"></i> Advanced Filters
                                </button>
                            </div>
                            
                            <!-- Basic Filters -->
                            <div id="basicFilters" class="row g-3 mb-3">
                                <!-- Source Selection -->
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Search Sources:</label>
                                    <div class="d-flex flex-wrap gap-2">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="sources" id="sources_all" value="all" {% if sources == 'all' or not sources %}checked{% endif %}>
                                            <label class="form-check-label" for="sources_all">All Sources</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="sources" id="sources_arxiv" value="arxiv" {% if sources == 'arxiv' %}checked{% endif %}>
                                            <label class="form-check-label" for="sources_arxiv">arXiv</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="sources" id="sources_pubmed" value="pubmed" {% if sources == 'pubmed' %}checked{% endif %}>
                                            <label class="form-check-label" for="sources_pubmed">PubMed</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="sources" id="sources_semantic" value="semantic" {% if sources == 'semantic' %}checked{% endif %}>
                                            <label class="form-check-label" for="sources_semantic">Semantic Scholar</label>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Quick Filters -->
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Quick Filters:</label>
                                    <div class="d-flex flex-wrap gap-2">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="open_access" id="open_access" {% if request.GET.open_access %}checked{% endif %}>
                                            <label class="form-check-label" for="open_access">Open Access Only</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="recent_only" id="recent_only" {% if request.GET.recent_only %}checked{% endif %}>
                                            <label class="form-check-label" for="recent_only">Last 5 Years</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="high_impact" id="high_impact" {% if request.GET.high_impact %}checked{% endif %}>
                                            <label class="form-check-label" for="high_impact">High Impact (IF > 5)</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Advanced Filters -->
                            <div id="advancedFilters" class="border rounded p-3 mb-3" style="display: none; background: #f8f9fa;">
                                <div class="row g-3">
                                    <!-- Year Range -->
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">Publication Year Range:</label>
                                        <div class="d-flex gap-2 align-items-center">
                                            <input type="number" name="year_from" class="form-control form-control-sm" placeholder="From" min="1900" max="2024" value="{{ request.GET.year_from }}">
                                            <span>to</span>
                                            <input type="number" name="year_to" class="form-control form-control-sm" placeholder="To" min="1900" max="2024" value="{{ request.GET.year_to }}">
                                        </div>
                                    </div>
                                    
                                    <!-- Citation Count -->
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">Minimum Citations:</label>
                                        <select name="min_citations" class="form-select form-select-sm">
                                            <option value="" {% if not request.GET.min_citations %}selected{% endif %}>Any</option>
                                            <option value="10" {% if request.GET.min_citations == '10' %}selected{% endif %}>10+</option>
                                            <option value="50" {% if request.GET.min_citations == '50' %}selected{% endif %}>50+</option>
                                            <option value="100" {% if request.GET.min_citations == '100' %}selected{% endif %}>100+</option>
                                            <option value="500" {% if request.GET.min_citations == '500' %}selected{% endif %}>500+</option>
                                            <option value="1000" {% if request.GET.min_citations == '1000' %}selected{% endif %}>1000+</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Impact Factor -->
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">Journal Impact Factor:</label>
                                        <select name="min_impact_factor" class="form-select form-select-sm">
                                            <option value="" {% if not request.GET.min_impact_factor %}selected{% endif %}>Any</option>
                                            <option value="1" {% if request.GET.min_impact_factor == '1' %}selected{% endif %}>1.0+</option>
                                            <option value="3" {% if request.GET.min_impact_factor == '3' %}selected{% endif %}>3.0+</option>
                                            <option value="5" {% if request.GET.min_impact_factor == '5' %}selected{% endif %}>5.0+</option>
                                            <option value="10" {% if request.GET.min_impact_factor == '10' %}selected{% endif %}>10.0+</option>
                                            <option value="20" {% if request.GET.min_impact_factor == '20' %}selected{% endif %}>20.0+</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Author Filter -->
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Author(s):</label>
                                        <input type="text" name="author" class="form-control form-control-sm" placeholder="e.g., Smith, Johnson" value="{{ request.GET.author }}">
                                        <small class="text-muted">Separate multiple authors with commas</small>
                                    </div>
                                    
                                    <!-- Journal Filter -->
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Journal:</label>
                                        <input type="text" name="journal" class="form-control form-control-sm" placeholder="e.g., Nature, Science" value="{{ request.GET.journal }}">
                                        <small class="text-muted">Journal name or partial name</small>
                                    </div>
                                    
                                    <!-- Document Type -->
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">Document Type:</label>
                                        <select name="doc_type" class="form-select form-select-sm">
                                            <option value="" {% if not request.GET.doc_type %}selected{% endif %}>All Types</option>
                                            <option value="article" {% if request.GET.doc_type == 'article' %}selected{% endif %}>Research Article</option>
                                            <option value="review" {% if request.GET.doc_type == 'review' %}selected{% endif %}>Review</option>
                                            <option value="preprint" {% if request.GET.doc_type == 'preprint' %}selected{% endif %}>Preprint</option>
                                            <option value="conference" {% if request.GET.doc_type == 'conference' %}selected{% endif %}>Conference Paper</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Study Type -->
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">Study Type:</label>
                                        <select name="study_type" class="form-select form-select-sm">
                                            <option value="" {% if not request.GET.study_type %}selected{% endif %}>Any</option>
                                            <option value="clinical_trial" {% if request.GET.study_type == 'clinical_trial' %}selected{% endif %}>Clinical Trial</option>
                                            <option value="meta_analysis" {% if request.GET.study_type == 'meta_analysis' %}selected{% endif %}>Meta-Analysis</option>
                                            <option value="systematic_review" {% if request.GET.study_type == 'systematic_review' %}selected{% endif %}>Systematic Review</option>
                                            <option value="case_study" {% if request.GET.study_type == 'case_study' %}selected{% endif %}>Case Study</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Language -->
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">Language:</label>
                                        <select name="language" class="form-select form-select-sm">
                                            <option value="" {% if not request.GET.language %}selected{% endif %}>Any Language</option>
                                            <option value="english" {% if request.GET.language == 'english' %}selected{% endif %}>English</option>
                                            <option value="japanese" {% if request.GET.language == 'japanese' %}selected{% endif %}>Japanese</option>
                                            <option value="chinese" {% if request.GET.language == 'chinese' %}selected{% endif %}>Chinese</option>
                                            <option value="german" {% if request.GET.language == 'german' %}selected{% endif %}>German</option>
                                            <option value="french" {% if request.GET.language == 'french' %}selected{% endif %}>French</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Filter Actions -->
                                <div class="d-flex justify-content-between align-items-center mt-3 pt-3 border-top">
                                    <div>
                                        <button type="button" class="btn btn-outline-secondary btn-sm" id="clearFilters">
                                            <i class="fas fa-times"></i> Clear All Filters
                                        </button>
                                        {% if user.is_authenticated %}
                                        <button type="button" class="btn btn-outline-success btn-sm ms-2" id="saveSearch">
                                            <i class="fas fa-bookmark"></i> Save Search
                                        </button>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <span class="text-muted me-2">Active filters: <span id="activeFilterCount">0</span></span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Project Selection and Actions -->
                            <div class="d-flex flex-wrap gap-2 align-items-center">
                                {% if user.is_authenticated %}
                                <select name="project" class="form-select form-select-sm w-auto">
                                    <option value="">Save to project...</option>
                                    <option value="default">My Research</option>
                                    <option value="ml-project">Machine Learning Project</option>
                                    <option value="thesis">PhD Thesis</option>
                                </select>
                                <!-- Saved Searches Dropdown -->
                                <div class="dropdown">
                                    <button class="btn btn-outline-info btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="fas fa-history"></i> Saved Searches
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><h6 class="dropdown-header">Recent Searches</h6></li>
                                        <li><a class="dropdown-item" href="?q=neural+mechanisms+visual+attention">neural mechanisms visual attention</a></li>
                                        <li><a class="dropdown-item" href="?q=machine+learning+neuroscience">machine learning neuroscience</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item" href="#" onclick="showSavedSearches()"><i class="fas fa-bookmark"></i> Manage Saved Searches</a></li>
                                    </ul>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    {% if has_results %}
        <!-- Search Results -->
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <!-- Results Header -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <h5 class="mb-0">Search Results</h5>
                        <small class="text-muted">
                            Found {{ results|length }} result{{ results|length|pluralize }} for "{{ query }}" 
                            {% if results %}
                                from web databases (arXiv, PubMed, Semantic Scholar)
                            {% endif %}
                        </small>
                    </div>
                    <div>
                        <small class="text-muted">Sort by:</small>
                        <select name="sort_by" class="form-select form-select-sm d-inline-block w-auto ms-2" id="sortSelect">
                            <option value="relevance" {% if request.GET.sort_by == 'relevance' or not request.GET.sort_by %}selected{% endif %}>Most Relevant</option>
                            <option value="date" {% if request.GET.sort_by == 'date' %}selected{% endif %}>Most Recent</option>
                            <option value="citations" {% if request.GET.sort_by == 'citations' %}selected{% endif %}>Most Cited</option>
                        </select>
                    </div>
                </div>
                
                <!-- Progressive Loading Status -->
                <div id="progressiveLoadingStatus" style="display: none;">
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="d-flex flex-wrap gap-3 align-items-center">
                                <div class="progress-source" data-source="arxiv">
                                    <span class="badge bg-secondary">arXiv</span>
                                    <div class="spinner-border spinner-border-sm ms-2" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <span class="count ms-1">0</span>
                                </div>
                                <div class="progress-source" data-source="pubmed">
                                    <span class="badge bg-secondary">PubMed</span>
                                    <div class="spinner-border spinner-border-sm ms-2" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <span class="count ms-1">0</span>
                                </div>
                                <div class="progress-source" data-source="semantic">
                                    <span class="badge bg-secondary">Semantic Scholar</span>
                                    <div class="spinner-border spinner-border-sm ms-2" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <span class="count ms-1">0</span>
                                </div>
                                <div class="progress-source" data-source="pmc">
                                    <span class="badge bg-secondary">PMC</span>
                                    <div class="spinner-border spinner-border-sm ms-2" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <span class="count ms-1">0</span>
                                </div>
                                <div class="progress-source" data-source="doaj">
                                    <span class="badge bg-secondary">DOAJ</span>
                                    <div class="spinner-border spinner-border-sm ms-2" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <span class="count ms-1">0</span>
                                </div>
                                <div class="progress-source" data-source="biorxiv">
                                    <span class="badge bg-secondary">bioRxiv</span>
                                    <div class="spinner-border spinner-border-sm ms-2" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <span class="count ms-1">0</span>
                                </div>
                                <div class="progress-source" data-source="plos">
                                    <span class="badge bg-secondary">PLOS</span>
                                    <div class="spinner-border spinner-border-sm ms-2" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <span class="count ms-1">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Progressive Results Container -->
                <div id="progressiveResults" style="display: none;"></div>

                <!-- Search Results -->
                {% for result in results %}
                <div class="result-card" data-paper-id="{{ result.id }}" data-title="{{ result.title }}" data-authors="{{ result.authors }}" data-year="{{ result.year }}" data-journal="{{ result.journal|default:'Unknown Journal' }}">
                    <h6 class="result-title">
                        <a href="#" class="text-decoration-none">
                            {{ result.title }}
                        </a>
                    </h6>
                    <div class="result-authors">
                        {{ result.authors }}
                    </div>
                    <div class="d-flex align-items-center mt-2 flex-wrap">
                        <span class="year-badge me-2">{{ result.year }}</span>
                        {% if result.is_open_access %}
                        <span class="open-access me-2">Open Access</span>
                        {% endif %}
                        {% if result.impact_factor %}
                        <span class="badge bg-warning text-dark me-2" style="font-size: 0.7rem;">
                            IF: {{ result.impact_factor }}
                        </span>
                        {% endif %}
                        <small class="text-muted">
                            {{ result.journal|default:"Unknown Journal" }}
                            {% if result.citations and result.citations > 0 %}
                                ‚Ä¢ <strong>{{ result.citations }} citations</strong>
                            {% endif %}
                            {% if result.pmid %}
                                ‚Ä¢ PMID: {{ result.pmid }}
                            {% endif %}
                        </small>
                        {% if result.source %}
                        <span class="badge bg-info ms-2" style="font-size: 0.7rem;">{{ result.source|upper }}</span>
                        {% endif %}
                    </div>
                    
                    <!-- Abstract Section -->
                    <div class="result-snippet mt-2">
                        <div class="abstract-preview">
                            {% if result.full_abstract and result.full_abstract|length > 200 %}
                                <span class="abstract-short">{{ result.snippet|default:"No abstract available." }}</span>
                                <span class="abstract-full" style="display: none;">{{ result.full_abstract }}</span>
                                <a href="#" class="abstract-toggle text-primary ms-2" style="font-size: 0.9rem;">[Show full abstract]</a>
                            {% else %}
                                {{ result.snippet|default:"No abstract available." }}
                            {% endif %}
                        </div>
                    </div>
                    <div class="mt-3">
                        <a href="#" class="btn btn-outline-primary btn-sm me-2" onclick="viewOnWeb(this)">
                            üåê View Online
                        </a>
                        {% if result.pdf_url %}
                        <a href="{{ result.pdf_url }}" class="btn btn-outline-success btn-sm me-2" target="_blank">
                            üìÑ Download PDF
                        </a>
                        {% else %}
                        <span class="btn btn-outline-secondary btn-sm me-2 disabled">
                            üìÑ No PDF
                        </span>
                        {% endif %}
                        <a href="#" class="btn btn-outline-info btn-sm me-2" onclick="showBibTeX(this)">
                            üìù Citation
                        </a>
                        <a href="#" class="btn btn-outline-warning btn-sm me-2" onclick="saveToLibrary(this)">
                            ‚≠ê Add to Library
                        </a>
                        <a href="#" class="btn btn-outline-dark btn-sm" onclick="uploadMyFiles(this)">
                            üìÇ Attach Files
                        </a>
                    </div>
                </div>
                {% endfor %}

                <!-- Simple Pagination -->
                <div class="text-center mt-4">
                    <nav>
                        <ul class="pagination justify-content-center">
                            <li class="page-item disabled">
                                <span class="page-link">Previous</span>
                            </li>
                            <li class="page-item active">
                                <span class="page-link">1</span>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="#">2</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="#">3</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="#">Next</a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    {% else %}
        <!-- Quick Examples -->
        <div class="row justify-content-center">
            <div class="col-lg-8 text-center">
                <div class="mt-4">
                    <p class="mb-3">Try searching for:</p>
                    <div class="d-flex flex-wrap justify-content-center gap-2">
                        <a href="?q=neural mechanisms visual attention" class="btn btn-outline-primary btn-sm">neural mechanisms visual attention</a>
                        <a href="?q=machine learning neuroscience" class="btn btn-outline-primary btn-sm">machine learning neuroscience</a>
                        <a href="?q=fMRI attention networks" class="btn btn-outline-primary btn-sm">fMRI attention networks</a>
                        <a href="?q=computational vision models" class="btn btn-outline-primary btn-sm">computational vision models</a>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Simple search functionality
    const form = document.querySelector('form');
    const searchInput = document.querySelector('input[name="q"]');
    const progressiveSearchButton = document.getElementById('progressiveSearchButton');
    const progressiveLoadingStatus = document.getElementById('progressiveLoadingStatus');
    const progressiveResults = document.getElementById('progressiveResults');
    
    // Advanced filters functionality
    const toggleAdvancedFilters = document.getElementById('toggleAdvancedFilters');
    const advancedFilters = document.getElementById('advancedFilters');
    const clearFiltersBtn = document.getElementById('clearFilters');
    const saveSearchBtn = document.getElementById('saveSearch');
    
    // Toggle advanced filters
    if (toggleAdvancedFilters) {
        toggleAdvancedFilters.addEventListener('click', function() {
            if (advancedFilters.style.display === 'none') {
                advancedFilters.style.display = 'block';
                this.innerHTML = '<i class="fas fa-sliders-h"></i> Hide Advanced Filters';
                this.classList.remove('btn-outline-primary');
                this.classList.add('btn-primary');
            } else {
                advancedFilters.style.display = 'none';
                this.innerHTML = '<i class="fas fa-sliders-h"></i> Advanced Filters';
                this.classList.remove('btn-primary');
                this.classList.add('btn-outline-primary');
            }
        });
    }
    
    // Clear all filters
    if (clearFiltersBtn) {
        clearFiltersBtn.addEventListener('click', function() {
            // Reset all filter inputs
            document.querySelectorAll('#advancedFilters input, #advancedFilters select').forEach(input => {
                if (input.type === 'checkbox' || input.type === 'radio') {
                    input.checked = false;
                } else {
                    input.value = '';
                }
            });
            
            // Reset basic filters
            document.querySelectorAll('#basicFilters input[type="checkbox"]').forEach(input => {
                input.checked = false;
            });
            
            // Reset to "All Sources"
            document.getElementById('sources_all').checked = true;
            
            updateActiveFilterCount();
        });
    }
    
    // Save search functionality
    if (saveSearchBtn) {
        saveSearchBtn.addEventListener('click', function() {
            const query = searchInput.value.trim();
            if (!query) {
                alert('Please enter a search query first.');
                return;
            }
            
            const searchName = prompt('Enter a name for this saved search:', query.substring(0, 50));
            if (!searchName) return;
            
            // Collect all active filters
            const filters = {};
            document.querySelectorAll('#advancedFilters input, #advancedFilters select, #basicFilters input[type="checkbox"], input[name="sources"]:checked').forEach(input => {
                if (input.name && input.value && ((input.type === 'checkbox' && input.checked) || (input.type === 'radio' && input.checked) || (input.type !== 'checkbox' && input.type !== 'radio'))) {
                    filters[input.name] = input.value;
                }
            });
            
            // Save to backend
            fetch('/scholar/api/save-search/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    name: searchName,
                    query: query,
                    filters: filters
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Search saved successfully!');
                } else {
                    alert(data.message || 'Error saving search');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error saving search. Please try again.');
            });
        });
    }
    
    // Update active filter count
    function updateActiveFilterCount() {
        let count = 0;
        
        // Count advanced filters
        document.querySelectorAll('#advancedFilters input, #advancedFilters select').forEach(input => {
            if (input.name && input.value && ((input.type === 'checkbox' && input.checked) || (input.type !== 'checkbox' && input.type !== 'radio'))) {
                count++;
            }
        });
        
        // Count basic filters (excluding "All Sources")
        document.querySelectorAll('#basicFilters input[type="checkbox"]:checked').forEach(() => count++);
        const selectedSource = document.querySelector('input[name="sources"]:checked');
        if (selectedSource && selectedSource.value !== 'all') {
            count++;
        }
        
        const activeFilterCountEl = document.getElementById('activeFilterCount');
        if (activeFilterCountEl) {
            activeFilterCountEl.textContent = count;
        }
    }
    
    // Monitor filter changes
    document.querySelectorAll('#advancedFilters input, #advancedFilters select, #basicFilters input, input[name="sources"]').forEach(input => {
        input.addEventListener('change', updateActiveFilterCount);
        input.addEventListener('input', updateActiveFilterCount);
    });
    
    // Initial filter count
    updateActiveFilterCount();
    
    // Auto-submit on filter changes
    document.querySelectorAll('#basicFilters input[type="checkbox"], input[name="sources"]').forEach(input => {
        input.addEventListener('change', function() {
            if (searchInput.value.trim()) {
                form.submit();
            }
        });
    });
    
    // Show progressive search option if query exists
    if (searchInput.value.trim()) {
        progressiveSearchButton.style.display = 'inline-block';
    }
    
    // Progressive search functionality
    progressiveSearchButton.addEventListener('click', function() {
        const query = searchInput.value.trim();
        if (!query) return;
        
        // Hide regular results and show progressive interface
        const regularResults = document.querySelectorAll('.result-card');
        regularResults.forEach(card => card.style.display = 'none');
        
        // Show progressive interface
        progressiveLoadingStatus.style.display = 'block';
        progressiveResults.style.display = 'block';
        progressiveResults.innerHTML = '';
        
        // Reset progress indicators
        document.querySelectorAll('.progress-source').forEach(source => {
            const badge = source.querySelector('.badge');
            const spinner = source.querySelector('.spinner-border');
            const count = source.querySelector('.count');
            
            badge.className = 'badge bg-secondary';
            spinner.style.display = 'inline-block';
            count.textContent = '0';
        });
        
        // Start progressive search
        startProgressiveSearch(query);
    });
    
    // Progressive search implementation
    function startProgressiveSearch(query) {
        const searchSources = [
            { name: 'arxiv', endpoint: '/scholar/api/search/arxiv/', maxResults: 50 },
            { name: 'pubmed', endpoint: '/scholar/api/search/pubmed/', maxResults: 50 },
            { name: 'semantic', endpoint: '/scholar/api/search/semantic/', maxResults: 10 },
            { name: 'pmc', endpoint: '/scholar/api/search/pmc/', maxResults: 50 },
            { name: 'doaj', endpoint: '/scholar/api/search/doaj/', maxResults: 25 },
            { name: 'biorxiv', endpoint: '/scholar/api/search/biorxiv/', maxResults: 25 },
            { name: 'plos', endpoint: '/scholar/api/search/plos/', maxResults: 25 }
        ];
        
        // Search each source in parallel
        searchSources.forEach(source => {
            searchSource(source, query);
        });
    }
    
    function searchSource(source, query) {
        const url = `${source.endpoint}?q=${encodeURIComponent(query)}&max_results=${source.maxResults}`;
        const progressSource = document.querySelector(`[data-source="${source.name}"]`);
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Update progress indicator
                    const badge = progressSource.querySelector('.badge');
                    const spinner = progressSource.querySelector('.spinner-border');
                    const count = progressSource.querySelector('.count');
                    
                    badge.className = 'badge bg-success';
                    spinner.style.display = 'none';
                    count.textContent = data.count;
                    
                    // Add results to progressive container
                    data.results.forEach(result => {
                        addResultToProgressive(result);
                    });
                } else {
                    // Handle error
                    handleSearchError(source.name, data.error || 'Unknown error');
                }
            })
            .catch(error => {
                handleSearchError(source.name, error.message);
            });
    }
    
    function addResultToProgressive(result) {
        const resultCard = createResultCard(result);
        progressiveResults.appendChild(resultCard);
        
        // Animate the new result
        resultCard.style.opacity = '0';
        resultCard.style.transform = 'translateY(20px)';
        setTimeout(() => {
            resultCard.style.transition = 'all 0.3s ease';
            resultCard.style.opacity = '1';
            resultCard.style.transform = 'translateY(0)';
        }, 50);
    }
    
    function createResultCard(result) {
        const cardDiv = document.createElement('div');
        cardDiv.className = 'result-card';
        cardDiv.setAttribute('data-paper-id', result.id || '');
        cardDiv.setAttribute('data-title', result.title || '');
        cardDiv.setAttribute('data-authors', result.authors || '');
        cardDiv.setAttribute('data-year', result.year || '');
        cardDiv.setAttribute('data-journal', result.journal || 'Unknown Journal');
        
        cardDiv.innerHTML = `
            <h6 class="result-title">
                <a href="#" class="text-decoration-none">
                    ${result.title || 'Unknown Title'}
                </a>
            </h6>
            <div class="result-authors">
                ${result.authors || 'Unknown Authors'}
            </div>
            <div class="d-flex align-items-center mt-2 flex-wrap">
                <span class="year-badge me-2">${result.year || '2024'}</span>
                ${result.is_open_access ? '<span class="open-access me-2">Open Access</span>' : ''}
                ${result.impact_factor ? `<span class="badge bg-warning text-dark me-2" style="font-size: 0.7rem;">IF: ${result.impact_factor}</span>` : ''}
                <small class="text-muted">
                    ${result.journal || 'Unknown Journal'}
                    ${result.citations && result.citations > 0 ? `‚Ä¢ <strong>${result.citations} citations</strong>` : ''}
                    ${result.pmid ? `‚Ä¢ PMID: ${result.pmid}` : ''}
                </small>
                ${result.source ? `<span class="badge bg-info ms-2" style="font-size: 0.7rem;">${result.source.toUpperCase()}</span>` : ''}
            </div>
            <div class="result-snippet mt-2">
                <div class="abstract-preview">
                    ${result.abstract && result.abstract.length > 200 ? 
                        `<span class="abstract-short">${result.abstract.substring(0, 200)}...</span>
                         <span class="abstract-full" style="display: none;">${result.abstract}</span>
                         <a href="#" class="abstract-toggle text-primary ms-2" style="font-size: 0.9rem;">[Show full abstract]</a>` :
                        (result.abstract || 'No abstract available.')
                    }
                </div>
            </div>
            <div class="mt-3">
                <a href="#" class="btn btn-outline-primary btn-sm me-2" onclick="viewOnWeb(this)">
                    üåê View Online
                </a>
                ${result.pdf_url ? 
                    `<a href="${result.pdf_url}" class="btn btn-outline-success btn-sm me-2" target="_blank">üìÑ Download PDF</a>` :
                    '<span class="btn btn-outline-secondary btn-sm me-2 disabled">üìÑ No PDF</span>'
                }
                <a href="#" class="btn btn-outline-info btn-sm me-2" onclick="showBibTeX(this)">
                    üìù Citation
                </a>
                <a href="#" class="btn btn-outline-warning btn-sm me-2" onclick="saveToLibrary(this)">
                    ‚≠ê Add to Library
                </a>
                <a href="#" class="btn btn-outline-dark btn-sm" onclick="uploadMyFiles(this)">
                    üìÇ Attach Files
                </a>
            </div>
        `;
        
        // Add event listeners for abstract toggle
        const abstractToggle = cardDiv.querySelector('.abstract-toggle');
        if (abstractToggle) {
            abstractToggle.addEventListener('click', function(e) {
                e.preventDefault();
                const abstractPreview = this.closest('.abstract-preview');
                const shortAbstract = abstractPreview.querySelector('.abstract-short');
                const fullAbstract = abstractPreview.querySelector('.abstract-full');
                
                if (fullAbstract.style.display === 'none') {
                    shortAbstract.style.display = 'none';
                    fullAbstract.style.display = 'inline';
                    this.textContent = '[Show less]';
                } else {
                    shortAbstract.style.display = 'inline';
                    fullAbstract.style.display = 'none';
                    this.textContent = '[Show full abstract]';
                }
            });
        }
        
        return cardDiv;
    }
    
    function handleSearchError(sourceName, errorMessage) {
        const progressSource = document.querySelector(`[data-source="${sourceName}"]`);
        const badge = progressSource.querySelector('.badge');
        const spinner = progressSource.querySelector('.spinner-border');
        const count = progressSource.querySelector('.count');
        
        badge.className = 'badge bg-danger';
        spinner.style.display = 'none';
        count.textContent = 'Error';
        
        console.error(`${sourceName} search failed:`, errorMessage);
    }
    
    // Auto-submit when project filter changes (but not sort)
    document.querySelectorAll('select[name="project"]').forEach(select => {
        select.addEventListener('change', function() {
            if (searchInput.value.trim()) {
                form.submit();
            }
        });
    });
    
    // Handle sort functionality
    const sortSelect = document.getElementById('sortSelect');
    if (sortSelect) {
        sortSelect.addEventListener('change', function() {
            if (searchInput.value.trim()) {
                form.submit();
            }
        });
    }
    
    // Auto-submit when source selection changes
    document.querySelectorAll('input[name="sources"]').forEach(radio => {
        radio.addEventListener('change', function() {
            if (searchInput.value.trim()) {
                form.submit();
            }
        });
    });
    
    // Handle abstract toggle functionality
    document.querySelectorAll('.abstract-toggle').forEach(toggle => {
        toggle.addEventListener('click', function(e) {
            e.preventDefault();
            const abstractPreview = this.closest('.abstract-preview');
            const shortAbstract = abstractPreview.querySelector('.abstract-short');
            const fullAbstract = abstractPreview.querySelector('.abstract-full');
            
            if (fullAbstract.style.display === 'none') {
                // Show full abstract
                shortAbstract.style.display = 'none';
                fullAbstract.style.display = 'inline';
                this.textContent = '[Show less]';
            } else {
                // Show short abstract
                shortAbstract.style.display = 'inline';
                fullAbstract.style.display = 'none';
                this.textContent = '[Show full abstract]';
            }
        });
    });
    
    // Save Search functionality
    const saveSearchButton = document.getElementById('saveSearch');
    if (saveSearchButton) {
        saveSearchButton.addEventListener('click', function() {
            const form = document.querySelector('form');
            const formData = new FormData(form);
            
            // Get current search query
            const query = formData.get('q');
            if (!query || !query.trim()) {
                alert('Please enter a search query first');
                return;
            }
            
            // Get search name from user
            const searchName = prompt('Enter a name for this saved search:', query.substring(0, 50));
            if (!searchName) return;
            
            // Collect all active filters
            const filters = {};
            formData.forEach((value, key) => {
                if (value && key !== 'q') {
                    filters[key] = value;
                }
            });
            
            // Send save request
            fetch('/scholar/api/save-search/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    name: searchName,
                    query: query.trim(),
                    filters: filters,
                    email_alerts: false,
                    alert_frequency: 'never'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Search saved successfully!');
                } else {
                    alert('Error saving search: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error saving search');
            });
        });
    }
    
    // Functions are defined globally to work with onclick handlers
    
});

// Global function for managing saved searches
function showSavedSearches() {
    fetch('/scholar/api/saved-searches/', {
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            displaySavedSearchesModal(data.searches);
        } else {
            alert('Error loading saved searches');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error loading saved searches');
    });
}

function displaySavedSearchesModal(searches) {
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); z-index: 1000; display: flex;
        align-items: center; justify-content: center;
    `;
    
    const searchList = searches.map(search => `
        <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
            <div>
                <strong>${search.name}</strong><br>
                <small class="text-muted">Query: ${search.query}</small><br>
                <small class="text-muted">Saved: ${new Date(search.created_at).toLocaleDateString()}</small>
            </div>
            <div>
                <button class="btn btn-sm btn-outline-primary me-2" onclick="loadSavedSearch('${search.id}')">
                    <i class="fas fa-search"></i> Load
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteSavedSearch('${search.id}')">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `).join('');
    
    modal.innerHTML = `
        <div style="background: white; padding: 2rem; border-radius: 8px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5>Saved Searches</h5>
                <button class="btn btn-close" onclick="this.closest('div[style*=\"position: fixed\"]').remove()"></button>
            </div>
            <div class="saved-searches-list">
                ${searches.length > 0 ? searchList : '<p class="text-muted text-center">No saved searches yet.</p>'}
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
    });
}

function loadSavedSearch(searchId) {
    fetch(`/scholar/api/saved-searches/${searchId}/`, {
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            const search = data.search;
            
            // Load query
            document.querySelector('input[name="q"]').value = search.query;
            
            // Load filters
            Object.entries(search.filters).forEach(([name, value]) => {
                const input = document.querySelector(`[name="${name}"]`);
                if (input) {
                    if (input.type === 'checkbox' || input.type === 'radio') {
                        if (input.value === value) {
                            input.checked = true;
                        }
                    } else {
                        input.value = value;
                    }
                }
            });
            
            // Submit the form
            document.querySelector('form').submit();
            
            // Close modal
            document.querySelector('div[style*="position: fixed"]').remove();
        } else {
            alert('Error loading saved search');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error loading saved search');
    });
}

function deleteSavedSearch(searchId) {
    if (!confirm('Are you sure you want to delete this saved search?')) return;
    
    fetch(`/scholar/api/saved-searches/${searchId}/`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Refresh the modal
            showSavedSearches();
        } else {
            alert('Error deleting saved search');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error deleting saved search');
    });
}

// Global functions for file handling
function viewOnWeb(btn) {
    const resultCard = btn.closest('.result-card');
    const paperTitle = resultCard.dataset.title;
    const pmid = resultCard.querySelector('.text-muted')?.textContent.match(/PMID: (\d+)/)?.[1];
    
    // Try to determine the best web link
    let webUrl = '';
    if (pmid) {
        webUrl = `https://pubmed.ncbi.nlm.nih.gov/${pmid}/`;
    } else {
        // Search on Google Scholar as fallback
        webUrl = `https://scholar.google.com/scholar?q=${encodeURIComponent(paperTitle)}`;
    }
    
    window.open(webUrl, '_blank');
}

function showBibTeX(btn) {
    const resultCard = btn.closest('.result-card');
    const paperTitle = resultCard.dataset.title;
    const authors = resultCard.dataset.authors;
    const year = resultCard.dataset.year;
    const journal = resultCard.dataset.journal;
    
    // Get citation from backend
    const params = new URLSearchParams({
        title: paperTitle,
        authors: authors,
        year: year,
        journal: journal
    });
    
    fetch('/scholar/api/get-citation/?' + params)
    .then(response => response.json())
    .then(data => {
        const bibtex = data.bibtex;
        
        // Create a modal-like display for BibTeX
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000; display: flex;
            align-items: center; justify-content: center;
        `;
        
        modal.innerHTML = `
            <div style="background: white; padding: 2rem; border-radius: 8px; max-width: 600px; width: 90%;">
                <h5>BibTeX Citation</h5>
                <textarea readonly style="width: 100%; height: 200px; font-family: monospace; font-size: 12px; border: 1px solid #ddd; padding: 1rem;">${bibtex}</textarea>
                <div class="mt-3">
                    <button class="btn btn-primary me-2" onclick="navigator.clipboard.writeText(\`${bibtex.replace(/`/g, '\\`')}\`).then(() => alert('Copied to clipboard!'))">Copy to Clipboard</button>
                    <button class="btn btn-secondary" onclick="this.closest('div[style*=\\"position: fixed\\"]').remove()">Close</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error generating citation. Please try again.');
    });
}

function saveToLibrary(btn) {
    const resultCard = btn.closest('.result-card');
    const paperId = resultCard.dataset.paperId;
    const paperTitle = resultCard.dataset.title;
    const projectSelect = document.querySelector('select[name="project"]');
    const selectedProject = projectSelect ? projectSelect.value : '';
    
    // Send save request to backend
    fetch('/scholar/api/save-paper/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            paper_id: paperId,
            title: paperTitle,
            project: selectedProject
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Visual feedback
            btn.innerHTML = '‚≠ê In Library';
            btn.classList.remove('btn-outline-warning');
            btn.classList.add('btn-warning');
            alert(data.message);
        } else {
            alert(data.message || 'Error saving paper');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error saving paper. Please try again.');
    });
}

function generateBibTeX(btn) {
    const resultCard = btn.closest('.result-card');
    const paperTitle = resultCard.dataset.title;
    const authors = resultCard.dataset.authors;
    const year = resultCard.dataset.year;
    const journal = resultCard.dataset.journal;
    
    // Get citation from backend
    const params = new URLSearchParams({
        title: paperTitle,
        authors: authors,
        year: year,
        journal: journal
    });
    
    fetch('/scholar/api/get-citation/?' + params)
    .then(response => response.json())
    .then(data => {
        const bibtex = data.bibtex;
        
        // Copy to clipboard
        navigator.clipboard.writeText(bibtex).then(() => {
            alert('BibTeX citation copied to clipboard!\n\n' + bibtex);
        }).catch(() => {
            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = bibtex;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            alert('BibTeX citation copied to clipboard!\n\n' + bibtex);
        });
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error generating citation. Please try again.');
    });
}

function uploadMyFiles(btn) {
    const resultCard = btn.closest('.result-card');
    const paperId = resultCard.dataset.paperId;
    const paperTitle = resultCard.dataset.title;
    
    // Create file input dialog
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.multiple = true;
    fileInput.accept = '.pdf,.bib,.bibtex';
    
    fileInput.onchange = function(e) {
        const files = Array.from(e.target.files);
        
        if (files.length === 0) return;
        
        // Upload each file
        const uploadPromises = files.map(file => {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('paper_id', paperId);
            formData.append('file_type', file.name.toLowerCase().endsWith('.pdf') ? 'pdf' : 'bibtex');
            
            return fetch('/scholar/api/upload-file/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: formData
            }).then(response => response.json());
        });
        
        Promise.all(uploadPromises)
        .then(results => {
            const successCount = results.filter(r => r.status === 'success').length;
            if (successCount > 0) {
                // Visual feedback
                btn.innerHTML = '‚úì Uploaded';
                btn.classList.remove('btn-outline-success');
                btn.classList.add('btn-success');
                alert(`Successfully uploaded ${successCount} file(s) for: ${paperTitle}`);
            } else {
                alert('Error uploading files. Please try again.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error uploading files. Please try again.');
        });
    };
    
    fileInput.click();
}

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}