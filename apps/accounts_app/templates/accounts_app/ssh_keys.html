{% extends "settings_base.html" %}
{% load static %}
{% block title %}
    SSH Keys -
    Settings - SciTeX Cloud
{% endblock %}
{% block extra_css %}
    <link rel="stylesheet" href="{% static 'shared/css/layouts/settings-layout.css' %}" />
    <link rel="stylesheet" href="{% static 'accounts_app/css/ssh_keys.css' %}">
{% endblock %}

{% block content %}
  <div class="settings-header">
    <div>
      <h1>SSH Keys</h1>
      <p class="settings-subtitle">Manage your SSH keys for secure access</p>
    </div>
  </div>

  <div class="settings-content">
    <!-- Add New Key Section -->
    <div class="add-key-section">
      <h2>Add New SSH Key</h2>
      <form method="post" enctype="multipart/form-data" id="uploadKeyForm">
        {% csrf_token %}

        <!-- Key Name Input -->
        <div class="form-group">
          <label for="key_name">Key Name</label>
          <input
            type="text"
            id="key_name"
            name="key_name"
            class="form-control"
            placeholder="e.g., My Laptop"
            required
          />
        </div>

        <!-- Public Key Input (textarea) -->
        <div class="form-group">
          <label for="public_key_text">Public Key</label>
          <textarea
            id="public_key_text"
            name="public_key_text"
            class="form-control key-textarea"
            placeholder="Paste your public key here (e.g., ssh-rsa AAAAB3...)"
            rows="6"
          ></textarea>
        </div>

        <!-- OR File Upload -->
        <div class="form-group">
          <label for="public_key_file">Or Upload Public Key File</label>
          <input
            type="file"
            id="public_key_file"
            name="public_key_file"
            class="form-control-file"
            accept=".pub"
          />
          <small class="form-text">
            Upload your public key file (e.g., id_rsa.pub, id_ed25519.pub)
          </small>
        </div>

        <button type="submit" class="btn btn-primary">
          <i class="fas fa-plus"></i> Add Key
        </button>
      </form>
    </div>

    <!-- Existing Keys Section -->
    <div class="existing-keys-section">
      <h2>Your SSH Keys</h2>

      {% if keys %}
        <div class="keys-list">
          {% for key in keys %}
            <div class="key-card">
              <div class="key-header">
                <div class="key-info">
                  <h3 class="key-name">{{ key.name }}</h3>
                  <div class="key-fingerprint">
                    <i class="fas fa-fingerprint"></i>
                    <code>{{ key.fingerprint }}</code>
                  </div>
                </div>
                <div class="key-actions">
                  <form method="post" action="{% url 'accounts_app:delete_ssh_key' key.id %}" class="delete-key-form">
                    {% csrf_token %}
                    <button
                      type="submit"
                      class="btn btn-danger btn-sm"
                      onclick="return confirm('Are you sure you want to delete this SSH key?');"
                    >
                      <i class="fas fa-trash"></i> Delete
                    </button>
                  </form>
                </div>
              </div>

              <div class="key-metadata">
                <div class="key-meta-item">
                  <i class="fas fa-calendar-plus"></i>
                  <span>Added: {{ key.created_at|date:"M d, Y" }}</span>
                </div>
                <div class="key-meta-item">
                  <i class="fas fa-clock"></i>
                  <span>Last used: {% if key.last_used_at %}{{ key.last_used_at|date:"M d, Y H:i" }}{% else %}Never{% endif %}</span>
                </div>
              </div>

              <details class="key-details">
                <summary>View Public Key</summary>
                <div class="key-public-content">
                  <pre><code>{{ key.public_key }}</code></pre>
                  <button class="btn btn-secondary btn-sm copy-btn" onclick="copyToClipboard('{{ key.id }}')">
                    <i class="fas fa-copy"></i> Copy
                  </button>
                </div>
              </details>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="empty-state">
          <i class="fas fa-key fa-3x"></i>
          <p>No SSH keys added yet.</p>
          <p class="text-muted">Add your first SSH key above to get started.</p>
        </div>
      {% endif %}
    </div>

    <!-- How to Generate SSH Keys -->
    <div class="help-section">
      <h2>How to Generate SSH Keys</h2>
      <div class="help-content">
        <div class="help-step">
          <h3><i class="fas fa-1"></i> Generate a new SSH key pair</h3>
          <pre><code>ssh-keygen -t ed25519 -C "your_email@example.com"</code></pre>
          <p class="help-description">
            This creates a new SSH key using the Ed25519 algorithm. Press Enter to accept the default file location.
          </p>
        </div>

        <div class="help-step">
          <h3><i class="fas fa-2"></i> Copy your public key</h3>
          <pre><code>cat ~/.ssh/id_ed25519.pub</code></pre>
          <p class="help-description">
            Display your public key and copy the entire output. This is what you'll paste above.
          </p>
        </div>

        <div class="help-step">
          <h3><i class="fas fa-3"></i> Add the key to SciTeX</h3>
          <p class="help-description">
            Paste your public key in the form above, give it a descriptive name, and click "Add Key".
          </p>
        </div>

        <div class="help-note">
          <i class="fas fa-exclamation-triangle"></i>
          <strong>Important:</strong> Never share your private key (id_ed25519). Only upload the public key (id_ed25519.pub).
        </div>
      </div>
    </div>
  </div>

<script src="{% static 'accounts_app/js/ssh_keys.js' %}"></script>
{% endblock %}
