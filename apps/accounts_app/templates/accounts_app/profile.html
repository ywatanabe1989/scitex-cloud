{% extends "global_base.html" %}
{% load static %}
{% block title %}
    My Profile -
    SciTeX
{% endblock %}
{% block extra_css %}
    <style>
  .profile-header {
    background-color: var(--scitex-color-07);
    padding: 2rem 0;
    margin-bottom: 2rem;
  }

  .profile-avatar {
    width: 120px;
    height: 120px;
    background-color: var(--scitex-color-05);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 3rem;
    color: white;
    margin: 0 auto 1rem;
  }

  .profile-section {
    background-color: white;
    border-radius: 8px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .profile-field {
    margin-bottom: 1.5rem;
  }

  .profile-label {
    font-weight: 600;
    color: var(--scitex-color-02);
    margin-bottom: 0.5rem;
  }

  .profile-value {
    color: var(--text-color);
  }

  .edit-mode .profile-value {
    display: none;
  }

  .edit-mode .profile-input {
    display: block;
  }

  .profile-input {
    display: none;
  }

  .stats-card {
    background-color: var(--scitex-color-07);
    border-radius: 8px;
    padding: 1.5rem;
    text-align: center;
    margin-bottom: 1rem;
  }

  .stats-number {
    font-size: 2rem;
    font-weight: bold;
    color: var(--scitex-color-02);
  }

  .stats-label {
    color: var(--scitex-color-03);
    font-size: 0.9rem;
  }
    </style>
{% endblock %}
{% block content %}
    <div class="profile-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-2">
                    <div class="profile-avatar">{{ user.first_name|first|upper }}{{ user.last_name|first|upper }}</div>
                </div>
                <div class="col-md-10">
                    <h1>{{ user.get_full_name|default:user.username }}</h1>
                    <p class="text-muted mb-0">Member since {{ user.date_joined|date:"M Y" }}</p>
                    {% if profile.academic_title %}<p class="mb-0">{{ profile.academic_title }}</p>{% endif %}
                </div>
            </div>
        </div>
    </div>
    <div class="container">
        <div class="row">
            <!-- Profile Information -->
            <div class="col-md-8">
                <div class="profile-section">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2>Profile Information</h2>
                        <button class="btn btn-outline-primary"
                                id="editProfileBtn"
                                onclick="toggleEditMode()">
                            <i class="fas fa-edit"></i> Edit Profile
                        </button>
                    </div>
                    <form id="profileForm"
                          method="post"
                          action="{% url'core:api-user-profile' %}">
                        {% csrf_token %}
                        <div class="row">
                            <div class="col-md-6">
                                <div class="profile-field">
                                    <div class="profile-label">First Name</div>
                                    <div class="profile-value">{{ user.first_name|default:"Not set" }}</div>
                                    <input type="text"
                                           name="first_name"
                                           class="form-control profile-input"
                                           value="{{ user.first_name }}" />
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="profile-field">
                                    <div class="profile-label">Last Name</div>
                                    <div class="profile-value">{{ user.last_name|default:"Not set" }}</div>
                                    <input type="text"
                                           name="last_name"
                                           class="form-control profile-input"
                                           value="{{ user.last_name }}" />
                                </div>
                            </div>
                        </div>
                        <div class="profile-field">
                            <div class="profile-label">Email</div>
                            <div class="profile-value">{{ user.email }}</div>
                            <input type="email"
                                   name="email"
                                   class="form-control profile-input"
                                   value="{{ user.email }}" />
                        </div>
                        <div class="profile-field">
                            <div class="profile-label">Academic Title</div>
                            <div class="profile-value">{{ profile.academic_title|default:"Not set" }}</div>
                            <select name="academic_title" class="form-control profile-input">
                                <option value="">Select title</option>
                                <option
                                    value="undergraduate"
                                    {% if profile.academic_title == "undergraduate" %}selected{% endif %}
                                    >Undergraduate Student</option>
                                <option
                                    value="graduate"
                                    {% if profile.academic_title == "graduate" %}selected{% endif %}
                                    >Graduate Student</option>
                                <option
                                    value="phd_candidate"
                                    {% if profile.academic_title == "phd_candidate" %}selected{% endif %}
                                    >PhD Candidate</option>
                                <option
                                    value="postdoc"
                                    {% if profile.academic_title == "postdoc" %}selected{% endif %}
                                    >Postdoctoral Researcher</option>
                                <option
                                    value="professor"
                                    {% if profile.academic_title == "professor" %}selected{% endif %}
                                    >Professor</option>
                                <option
                                    value="researcher"
                                    {% if profile.academic_title == "researcher" %}selected{% endif %}
                                    >Research Scientist</option>
                            </select>
                        </div>
                        <div class="profile-field">
                            <div class="profile-label">Institution</div>
                            <div class="profile-value">{{ profile.institution|default:"Not set" }}</div>
                            <input type="text"
                                   name="institution"
                                   class="form-control profile-input"
                                   value="{{ profile.institution }}" />
                        </div>
                        <div class="profile-field">
                            <div class="profile-label">Department</div>
                            <div class="profile-value">{{ profile.department|default:"Not set" }}</div>
                            <input type="text"
                                   name="department"
                                   class="form-control profile-input"
                                   value="{{ profile.department }}" />
                        </div>
                        <div class="profile-field">
                            <div class="profile-label">Research Interests</div>
                            <div class="profile-value">{{ profile.research_interests|default:"Not set" }}</div>
                            <textarea name="research_interests" class="form-control profile-input" rows="3">
{{ profile.research_interests }}</textarea>
                        </div>
                        <div class="profile-field">
                            <div class="profile-label">Bio</div>
                            <div class="profile-value">{{ profile.bio|default:"Not set" }}</div>
                            <textarea name="bio" class="form-control profile-input" rows="4">
{{ profile.bio }}</textarea>
                        </div>
                        <div class="edit-actions" style="display: none">
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                            <button type="button" class="btn btn-secondary" onclick="cancelEdit()">Cancel</button>
                        </div>
                    </form>
                </div>
                <!-- Account Settings -->
                <div class="profile-section">
                    <h2>Account Settings</h2>
                    <div class="profile-field">
                        <div class="profile-label">Username</div>
                        <div class="profile-value">{{ user.username }}</div>
                    </div>
                    <div class="profile-field">
                        <div class="profile-label">Account Status</div>
                        <div class="profile-value">
                            <span class="badge bg-success">Active</span>
                        </div>
                    </div>
                    <div class="mt-3">
                        <a href="{% url 'auth_app:forgot-password' %}"
                           class="btn btn-outline-secondary">
                            <i class="fas fa-key"></i> Change Password
                        </a>
                    </div>
                    <hr class="my-4" />
                    <div class="profile-field">
                        <div class="profile-label text-danger">Danger Zone</div>
                        <p class="text-muted small mb-3">
                            Once you delete your account, there is no going back. Please be
                            certain.
                        </p>
                        <a href="{% url 'auth_app:delete-account' %}"
                           class="btn btn-outline-danger">
                            <i class="fas fa-trash-alt"></i> Delete Account
                        </a>
                    </div>
                </div>
            </div>
            <!-- Stats and Activity -->
            <div class="col-md-4">
                <!-- Allocated Resources -->
                <div class="profile-section">
                    <h3>
                        <i class="fas fa-server"></i> Allocated Resources
                    </h3>

                    <!-- Projects Breakdown -->
                    <div class="stats-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <div class="stats-number" style="color: white;">{{ resources.total_projects }}</div>
                        <div class="stats-label" style="color: rgba(255,255,255,0.9);">Total Projects</div>
                        <div style="margin-top: 0.5rem; font-size: 0.85rem; color: rgba(255,255,255,0.8);">
                            <div><i class="fas fa-folder"></i> {{ resources.local_projects }} Local</div>
                            <div><i class="fas fa-cloud"></i> {{ resources.remote_projects }} Remote</div>
                        </div>
                    </div>

                    <!-- Storage Usage -->
                    <div class="stats-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <div class="stats-number" style="color: white;">{{ resources.storage_used }}</div>
                        <div class="stats-label" style="color: rgba(255,255,255,0.9);">Storage Used</div>
                        <div style="margin-top: 0.5rem; font-size: 0.85rem; color: rgba(255,255,255,0.8);">
                            <i class="fas fa-database"></i> Local projects only
                        </div>
                    </div>

                    <!-- SSH Credentials -->
                    <div class="stats-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <div class="stats-number" style="color: white;">{{ resources.total_ssh_keys }}</div>
                        <div class="stats-label" style="color: rgba(255,255,255,0.9);">SSH Keys</div>
                        <div style="margin-top: 0.5rem; font-size: 0.85rem; color: rgba(255,255,255,0.8);">
                            <div><i class="fas fa-terminal"></i> {{ resources.workspace_ssh_keys }} Workspace</div>
                            <div><i class="fab fa-git-alt"></i> {{ resources.git_ssh_keys }} Git</div>
                        </div>
                    </div>

                    <!-- Remote Credentials -->
                    {% if resources.remote_credentials > 0 %}
                    <div class="stats-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                        <div class="stats-number" style="color: white;">{{ resources.remote_credentials }}</div>
                        <div class="stats-label" style="color: rgba(255,255,255,0.9);">Remote Credentials</div>
                        <div style="margin-top: 0.5rem; font-size: 0.85rem; color: rgba(255,255,255,0.8);">
                            <i class="fas fa-key"></i> For remote projects
                        </div>
                    </div>
                    {% endif %}

                    <!-- Active Services -->
                    {% if resources.active_services > 0 %}
                    <div class="stats-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                        <div class="stats-number" style="color: white;">{{ resources.active_services }}</div>
                        <div class="stats-label" style="color: rgba(255,255,255,0.9);">Active Services</div>
                        <div style="margin-top: 0.5rem; font-size: 0.85rem; color: rgba(255,255,255,0.8);">
                            <i class="fas fa-cogs"></i> TensorBoard, Jupyter, etc.
                        </div>
                    </div>
                    {% endif %}

                    <!-- Collaborations -->
                    <div class="stats-card" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">
                        <div class="stats-number" style="color: #333;">{{ resources.total_collaborations }}</div>
                        <div class="stats-label" style="color: #666;">Collaborations</div>
                        <div style="margin-top: 0.5rem; font-size: 0.85rem; color: #666;">
                            <i class="fas fa-users"></i> Projects you collaborate on
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div style="margin-top: 1.5rem;">
                        <a href="{% url 'accounts_app:ssh_keys' %}" class="btn btn-outline-primary btn-sm w-100 mb-2">
                            <i class="fas fa-key"></i> Manage SSH Keys
                        </a>
                        <a href="{% url 'user_projects:create' %}" class="btn btn-outline-success btn-sm w-100">
                            <i class="fas fa-plus"></i> Create New Project
                        </a>
                    </div>
                </div>
                <div class="profile-section">
                    <h3>Privacy Settings</h3>
                    <div class="form-check mb-2">
                        <input
                            class="form-check-input"
                            type="checkbox"
                            id="publicProfile"
                            {% if profile.is_public %}checked{% endif %}
                            />
                            <label class="form-check-label" for="publicProfile">Make profile public</label>
                        </div>
                        <div class="form-check mb-2">
                            <input
                                class="form-check-input"
                                type="checkbox"
                                id="showEmail"
                                {% if profile.show_email %}checked{% endif %}
                                />
                                <label class="form-check-label" for="showEmail">Show email to other users</label>
                            </div>
                            <div class="form-check mb-2">
                                <input
                                    class="form-check-input"
                                    type="checkbox"
                                    id="allowMessages"
                                    {% if profile.allow_messages %}checked{% endif %}
                                    />
                                    <label class="form-check-label" for="allowMessages">Allow messages from other users</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endblock %}
            {% block extra_js %}
                <script>
  function toggleEditMode() {
    document.querySelector(".profile-section").classList.add("edit-mode");
    document.querySelector(".edit-actions").style.display = "block";
    document.getElementById("editProfileBtn").style.display = "none";
  }

  function cancelEdit() {
    document.querySelector(".profile-section").classList.remove("edit-mode");
    document.querySelector(".edit-actions").style.display = "none";
    document.getElementById("editProfileBtn").style.display = "block";
  }

  // Handle form submission
  document
    .getElementById("profileForm")
    .addEventListener("submit", async function (e) {
      e.preventDefault();

      const formData = new FormData(this);
      const data = Object.fromEntries(formData);

      try {
        const response = await fetch(this.action, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": data.csrfmiddlewaretoken,
            "X-Requested-With": "XMLHttpRequest",
          },
          body: JSON.stringify(data),
        });

        if (response.ok) {
          const result = await response.json();
          if (result.success) {
            // Update the displayed values
            document.querySelectorAll(".profile-field").forEach((field) => {
              const input = field.querySelector(".profile-input");
              const value = field.querySelector(".profile-value");
              if (input && value) {
                value.textContent = input.value || "Not set";
              }
            });

            cancelEdit();

            // Show success message
            const alert = document.createElement("div");
            alert.className = "alert-banner alert-banner-success";
            alert.style.marginBottom = "var(--spacing-md)";
            alert.innerHTML = `
          <div class="warning-banner-container">
            <div class="warning-banner-content">
              <i class="warning-banner-icon fas fa-check-circle"></i>
              <div class="warning-banner-text">
                <div class="warning-banner-description">Profile updated successfully!</div>
              </div>
            </div>
          </div>
        `;
            document.querySelector(".profile-section").prepend(alert);

            // Remove alert after 3 seconds
            setTimeout(() => alert.remove(), 3000);
          }
        }
      } catch (error) {
        console.error("Error updating profile:", error);
      }
    });

  // Handle privacy settings
  // TODO: Re-enable when API endpoint is created
  // document.querySelectorAll('.form-check-input').forEach(checkbox => {
  //   checkbox.addEventListener('change', async function() {
  //     const setting = this.id;
  //     const value = this.checked;
  //
  //     try {
  //       const response = await fetch('{% url "accounts_app:profile_edit" %}', {
  //         method: 'PATCH',
  //         headers: {
  //           'Content-Type': 'application/json',
  //           'X-CSRFToken': '{{ csrf_token }}',
  //           'X-Requested-With': 'XMLHttpRequest'
  //         },
  //         body: JSON.stringify({
  //           [setting]: value
  //         })
  //       });
  //
  //       if (response.ok) {
  //         console.log('Privacy setting updated');
  //       }
  //     } catch (error) {
  //       console.error('Error updating privacy setting:', error);
  //     }
  //   });
  // });
                </script>
            {% endblock %}
