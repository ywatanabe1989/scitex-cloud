{% extends 'global_base.html' %}
{% load static %}

{% block title %}Remote Credentials - Settings - SciTeX Cloud{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'shared/css/layouts/settings-layout.css' %}" />
<style>
  /* Remote credentials page-specific styles */
  .settings-content {
    max-width: 900px;
  }

  .credential-card {
    border: 1px solid var(--color-border-default);
    border-radius: 6px;
    padding: 1.5rem;
    background: var(--color-canvas-default);
    margin-bottom: 1.5rem;
  }

  .credential-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 1rem;
  }

  .credential-name {
    font-size: 18px;
    font-weight: 600;
    color: var(--color-fg-default);
    margin: 0 0 0.25rem 0;
  }

  .credential-host {
    font-size: 14px;
    color: var(--color-fg-muted);
    font-family: 'SF Mono', Monaco, monospace;
  }

  .credential-details {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
    margin: 1rem 0;
    padding: 1rem;
    background: var(--color-canvas-subtle);
    border-radius: 6px;
  }

  .detail-item {
    display: flex;
    flex-direction: column;
  }

  .detail-label {
    font-size: 12px;
    color: var(--color-fg-muted);
    margin-bottom: 0.25rem;
  }

  .detail-value {
    font-size: 14px;
    color: var(--color-fg-default);
    font-family: 'SF Mono', Monaco, monospace;
  }

  .credential-actions {
    display: flex;
    gap: 0.5rem;
  }

  .form-card {
    border: 1px solid var(--color-border-default);
    border-radius: 6px;
    padding: 1.5rem;
    background: var(--color-canvas-subtle);
    margin-bottom: 2rem;
  }

  .form-group {
    margin-bottom: 1.5rem;
  }

  .form-label {
    display: block;
    font-size: 14px;
    font-weight: 600;
    color: var(--color-fg-default);
    margin-bottom: 0.5rem;
  }

  .form-input,
  .form-textarea {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid var(--color-border-default);
    border-radius: 6px;
    background: var(--color-canvas-default);
    color: var(--color-fg-default);
    font-size: 14px;
    font-family: inherit;
  }

  .form-textarea {
    font-family: 'SF Mono', Monaco, monospace;
    min-height: 120px;
    resize: vertical;
  }

  .form-help {
    font-size: 12px;
    color: var(--color-fg-muted);
    margin-top: 0.25rem;
  }

  .status-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
  }

  .status-active {
    background: #28a745;
    color: white;
  }

  .status-inactive {
    background: var(--color-bg-muted);
    color: var(--color-fg-muted);
  }

  .empty-state {
    text-align: center;
    padding: 3rem 2rem;
    color: var(--color-fg-muted);
  }

  .empty-state-icon {
    font-size: 48px;
    margin-bottom: 1rem;
    opacity: 0.5;
  }

  .btn-test {
    background: var(--color-btn-bg);
    color: var(--color-btn-text);
    border: 1px solid var(--color-btn-border);
  }

  .btn-test:hover {
    background: var(--color-btn-hover-bg);
  }

  .btn-delete {
    background: #d73a49;
    color: white;
    border: 1px solid #d73a49;
  }

  .btn-delete:hover {
    background: #cb2431;
  }

  .toggle-form-btn {
    margin-bottom: 2rem;
  }

  #addCredentialForm {
    display: none;
  }

  #addCredentialForm.show {
    display: block;
  }
</style>
{% endblock %}

{% block content %}
<div class="settings-layout">
  <aside class="settings-sidebar">
    <nav class="settings-nav">
      <a href="{% url 'accounts_app:profile_edit' %}" class="settings-nav-item">
        <svg class="octicon" height="16" width="16" viewBox="0 0 16 16">
          <path d="M8 8a3 3 0 100-6 3 3 0 000 6zm2-3a2 2 0 11-4 0 2 2 0 014 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z"></path>
        </svg>
        Profile
      </a>
      <a href="{% url 'accounts_app:account' %}" class="settings-nav-item">
        <svg class="octicon" height="16" width="16" viewBox="0 0 16 16">
          <path d="M8 0a8 8 0 110 16A8 8 0 018 0zM1.5 8a6.5 6.5 0 1113 0 6.5 6.5 0 01-13 0z"></path>
          <path d="M8 3.5a4.5 4.5 0 000 9 4.5 4.5 0 000-9zM4 8a4 4 0 118 0 4 4 0 01-8 0z"></path>
        </svg>
        Account
      </a>
      <a href="{% url 'accounts_app:appearance' %}" class="settings-nav-item">
        <svg class="octicon" height="16" width="16" viewBox="0 0 16 16">
          <path d="M8 0a8 8 0 110 16A8 8 0 018 0zM1.5 8a6.5 6.5 0 1113 0 6.5 6.5 0 01-13 0z"></path>
        </svg>
        Appearance
      </a>
      <a href="{% url 'accounts_app:git_integrations' %}" class="settings-nav-item">
        <svg class="octicon" height="16" width="16" viewBox="0 0 16 16">
          <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path>
        </svg>
        Integrations
      </a>
      <a href="{% url 'accounts_app:ssh_keys' %}" class="settings-nav-item">
        <svg class="octicon" height="16" width="16" viewBox="0 0 16 16">
          <path d="M10.5 0a5.499 5.499 0 104.383 8.823l-2.006 2.006a1.5 1.5 0 11-2.122-2.122l2.006-2.006A5.5 5.5 0 0010.5 0zm0 1.5a4 4 0 110 8 4 4 0 010-8z"></path>
        </svg>
        SSH Keys
      </a>
      <a href="{% url 'accounts_app:remote_credentials' %}" class="settings-nav-item active">
        <svg class="octicon" height="16" width="16" viewBox="0 0 16 16">
          <path d="M2 2.5A2.5 2.5 0 014.5 0h8.75a.75.75 0 01.75.75v12.5a.75.75 0 01-.75.75h-2.5a.75.75 0 110-1.5h1.75v-2h-8a1 1 0 00-.714 1.7.75.75 0 01-1.072 1.05A2.495 2.495 0 012 11.5v-9zm10.5-1V9h-8c-.356 0-.694.074-1 .208V2.5a1 1 0 011-1h8zM5 12.25v3.25a.25.25 0 00.4.2l1.45-1.087a.25.25 0 01.3 0L8.6 15.7a.25.25 0 00.4-.2v-3.25a.25.25 0 00-.25-.25h-3.5a.25.25 0 00-.25.25z"></path>
        </svg>
        Remote Credentials
      </a>
      <a href="{% url 'accounts_app:api_keys' %}" class="settings-nav-item">
        <svg class="octicon" height="16" width="16" viewBox="0 0 16 16">
          <path d="M6.5 5.5a4 4 0 112.731 3.795.75.75 0 00-.768.18L7.44 10.5H6.25a.75.75 0 00-.75.75v1.19l-.06.06H4.25a.75.75 0 00-.75.75v1.19l-.06.06H1.75a.25.25 0 01-.25-.25v-1.69l5.024-5.023a.75.75 0 00.181-.768A3.995 3.995 0 016.5 5.5zm4-5.5a5.5 5.5 0 00-5.348 6.788L.22 11.72a.75.75 0 00-.22.53v2C0 15.216.784 16 1.75 16h2a.75.75 0 00.53-.22l.5-.5a.75.75 0 00.22-.53V14h.75a.75.75 0 00.53-.22l.5-.5a.75.75 0 00.22-.53V12h.75a.75.75 0 00.53-.22l.932-.932A5.5 5.5 0 1010.5 0zm.5 6a1 1 0 100-2 1 1 0 000 2z"></path>
        </svg>
        API Keys
      </a>
    </nav>
  </aside>

  <main class="settings-content">
    <div class="settings-header">
      <h1 class="settings-title">Remote Credentials</h1>
      <p class="settings-subtitle">
        Manage SSH credentials for accessing remote systems (HPC clusters, cloud instances, personal servers)
      </p>
    </div>

    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">
          {{ message }}
        </div>
      {% endfor %}
    {% endif %}

    <!-- Add New Credential Button -->
    <button class="btn btn-primary toggle-form-btn" onclick="toggleAddForm()">
      <svg class="octicon" height="16" width="16" viewBox="0 0 16 16">
        <path d="M7.75 2a.75.75 0 01.75.75V7h4.25a.75.75 0 110 1.5H8.5v4.25a.75.75 0 11-1.5 0V8.5H2.75a.75.75 0 010-1.5H7V2.75A.75.75 0 017.75 2z"></path>
      </svg>
      Add Remote Credential
    </button>

    <!-- Add Credential Form (Hidden by default) -->
    <div id="addCredentialForm" class="form-card">
      <h3 style="margin-top: 0;">New Remote Credential</h3>
      <form method="POST">
        {% csrf_token %}
        <input type="hidden" name="action" value="add">

        <div class="form-group">
          <label class="form-label" for="name">Name*</label>
          <input type="text"
                 class="form-input"
                 id="name"
                 name="name"
                 placeholder="e.g., Spartan HPC, AWS Server"
                 required>
          <p class="form-help">A friendly name to identify this remote system</p>
        </div>

        <div class="form-group">
          <label class="form-label" for="ssh_host">SSH Host*</label>
          <input type="text"
                 class="form-input"
                 id="ssh_host"
                 name="ssh_host"
                 placeholder="e.g., hpc.example.com or 192.168.1.100"
                 required>
          <p class="form-help">Hostname or IP address of the remote system</p>
        </div>

        <div class="form-group">
          <label class="form-label" for="ssh_port">SSH Port</label>
          <input type="number"
                 class="form-input"
                 id="ssh_port"
                 name="ssh_port"
                 value="22"
                 min="1"
                 max="65535">
          <p class="form-help">SSH port (default: 22)</p>
        </div>

        <div class="form-group">
          <label class="form-label" for="ssh_username">SSH Username*</label>
          <input type="text"
                 class="form-input"
                 id="ssh_username"
                 name="ssh_username"
                 placeholder="e.g., {{ user.username }}"
                 required>
          <p class="form-help">Your username on the remote system</p>
        </div>

        <div class="form-group">
          <label class="form-label" for="ssh_public_key">SSH Public Key*</label>
          <textarea class="form-textarea"
                    id="ssh_public_key"
                    name="ssh_public_key"
                    placeholder="ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQ..."
                    required></textarea>
          <p class="form-help">
            Paste your SSH public key (id_rsa.pub). The corresponding private key must be placed at the location shown after creation.
          </p>
        </div>

        <div style="display: flex; gap: 0.5rem;">
          <button type="submit" class="btn btn-primary">Add Credential</button>
          <button type="button" class="btn" onclick="toggleAddForm()">Cancel</button>
        </div>
      </form>
    </div>

    <!-- Saved Credentials List -->
    <h3>Saved Credentials</h3>

    {% if credentials %}
      {% for credential in credentials %}
        <div class="credential-card">
          <div class="credential-header">
            <div>
              <h3 class="credential-name">
                {{ credential.name }}
                {% if credential.is_active %}
                  <span class="status-badge status-active">Active</span>
                {% else %}
                  <span class="status-badge status-inactive">Inactive</span>
                {% endif %}
              </h3>
              <p class="credential-host">
                {{ credential.ssh_username }}@{{ credential.ssh_host }}:{{ credential.ssh_port }}
              </p>
            </div>
          </div>

          <div class="credential-details">
            <div class="detail-item">
              <span class="detail-label">SSH Key Fingerprint</span>
              <span class="detail-value">{{ credential.ssh_key_fingerprint }}</span>
            </div>

            <div class="detail-item">
              <span class="detail-label">Private Key Path</span>
              <span class="detail-value">{{ credential.private_key_path }}</span>
            </div>

            <div class="detail-item">
              <span class="detail-label">Created</span>
              <span class="detail-value">{{ credential.created_at|date:"Y-m-d H:i" }}</span>
            </div>

            <div class="detail-item">
              <span class="detail-label">Last Used</span>
              <span class="detail-value">
                {% if credential.last_used_at %}
                  {{ credential.last_used_at|date:"Y-m-d H:i" }}
                {% else %}
                  Never
                {% endif %}
              </span>
            </div>
          </div>

          <div class="credential-actions">
            <form method="POST" style="display: inline;">
              {% csrf_token %}
              <input type="hidden" name="action" value="test">
              <input type="hidden" name="credential_id" value="{{ credential.id }}">
              <button type="submit" class="btn btn-sm btn-test">
                <svg class="octicon" height="16" width="16" viewBox="0 0 16 16">
                  <path d="M8 4a4 4 0 100 8 4 4 0 000-8z"></path>
                </svg>
                Test Connection
              </button>
            </form>

            <form method="POST"
                  style="display: inline;"
                  onsubmit="return confirm('Are you sure you want to delete this credential?');">
              {% csrf_token %}
              <input type="hidden" name="action" value="delete">
              <input type="hidden" name="credential_id" value="{{ credential.id }}">
              <button type="submit" class="btn btn-sm btn-delete">
                <svg class="octicon" height="16" width="16" viewBox="0 0 16 16">
                  <path d="M11 1.75V3h2.25a.75.75 0 010 1.5H2.75a.75.75 0 010-1.5H5V1.75C5 .784 5.784 0 6.75 0h2.5C10.216 0 11 .784 11 1.75zM4.496 6.675a.75.75 0 10-1.492.15l.66 6.6A1.75 1.75 0 005.405 15h5.19c.9 0 1.652-.681 1.741-1.576l.66-6.6a.75.75 0 00-1.492-.149l-.66 6.6a.25.25 0 01-.249.225h-5.19a.25.25 0 01-.249-.225l-.66-6.6z"></path>
                </svg>
                Delete
              </button>
            </form>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <div class="empty-state">
        <div class="empty-state-icon">üåê</div>
        <h3>No remote credentials yet</h3>
        <p>Add a credential to connect to HPC clusters, cloud instances, or personal servers</p>
      </div>
    {% endif %}

    <div class="settings-section" style="margin-top: 3rem; padding-top: 2rem; border-top: 1px solid var(--color-border-default);">
      <h3>About Remote Credentials</h3>
      <p style="color: var(--color-fg-muted); font-size: 14px;">
        Remote credentials allow you to create projects that mount remote filesystems via SSH.
        This provides TRAMP-like access to files on HPC clusters, cloud servers, or personal machines
        without storing data locally.
      </p>
      <ul style="color: var(--color-fg-muted); font-size: 14px;">
        <li>Files are accessed on-demand via SSHFS (no local copy)</li>
        <li>Automatic mount/unmount for privacy</li>
        <li>No Git support on remote projects (prevents confusion)</li>
        <li>Slower than local projects but privacy-preserving</li>
      </ul>
    </div>
  </main>
</div>

<script>
function toggleAddForm() {
  const form = document.getElementById('addCredentialForm');
  form.classList.toggle('show');
}
</script>
{% endblock %}
