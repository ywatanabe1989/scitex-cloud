{% extends 'global_base.html' %}
{% load static %}

{% block title %}Settings - SciTeX Cloud{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/common/settings-layout.css' %}">
<style>
/* Profile edit page-specific styles */

.settings-header {
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--color-border-default);
}

.settings-title {
    font-size: 24px;
    font-weight: 600;
    color: var(--color-fg-default);
    margin-bottom: 4px;
}

.settings-subtitle {
    font-size: 14px;
    color: var(--color-fg-muted);
}

/* Form Sections */
.form-section {
    background: var(--color-canvas-default);
    border: 1px solid var(--color-border-default);
    border-radius: 6px;
    padding: 24px;
    margin-bottom: 24px;
}

.form-section-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--color-fg-default);
    margin-bottom: 16px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--color-border-default);
}

.form-group {
    margin-bottom: 16px;
}

.form-group label {
    display: block;
    font-size: 14px;
    font-weight: 600;
    color: var(--color-fg-default);
    margin-bottom: 8px;
}

.form-group input[type="text"],
.form-group input[type="email"],
.form-group input[type="url"],
.form-group textarea {
    width: 100%;
    background: var(--color-canvas-inset);
    border: 1px solid var(--color-border-muted);
    border-radius: 6px;
    padding: 8px 12px;
    color: var(--color-fg-default);
    font-size: 14px;
    transition: all 0.2s ease;
    font-family: inherit;
}

.form-group input:focus,
.form-group textarea:focus {
    outline: none;
    border-color: var(--color-accent-fg);
    box-shadow: 0 0 0 3px rgba(var(--scitex-color-05-rgb), 0.1);
}

.form-group textarea {
    resize: vertical;
    min-height: 100px;
}

.form-help {
    font-size: 12px;
    color: var(--color-fg-muted);
    margin-top: 4px;
}

/* Avatar Upload */
.avatar-upload {
    display: flex;
    align-items: start;
    gap: 24px;
}

.avatar-preview {
    width: 128px;
    height: 128px;
    border-radius: 50%;
    background: var(--color-canvas-subtle);
    border: 1px solid var(--color-border-muted);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 3rem;
    color: var(--color-accent-fg);
    overflow: hidden;
}

.avatar-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.avatar-upload-controls {
    flex: 1;
}

.file-input-wrapper {
    position: relative;
    display: inline-block;
}

.file-input-wrapper input[type="file"] {
    position: absolute;
    opacity: 0;
    width: 0;
    height: 0;
}

.file-input-label {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    background: var(--color-btn-bg);
    border: 1px solid var(--color-btn-border);
    border-radius: 6px;
    color: var(--color-btn-text);
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s ease;
}

[data-theme="dark"] .file-input-label {
    border-color: var(--scitex-color-05);
    opacity: 0.9;
}

.file-input-label:hover {
    background: var(--color-btn-hover-bg);
    border-color: var(--color-btn-hover-border);
}

[data-theme="dark"] .file-input-label:hover {
    opacity: 1;
    border-color: var(--scitex-color-06);
}

/* Buttons */
.btn-save {
    background: var(--color-btn-primary-bg);
    color: var(--color-btn-primary-text);
    border: 1px solid var(--color-btn-primary-border);
    padding: 8px 20px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.2s ease;
}

.btn-save:hover {
    background: var(--color-btn-primary-hover-bg);
}

.btn-cancel {
    background: transparent;
    color: var(--color-fg-default);
    border: 1px solid var(--color-border-muted);
    padding: 8px 20px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
    display: inline-block;
}

.btn-cancel:hover {
    background: var(--color-btn-hover-bg);
    border-color: var(--color-btn-hover-border);
    text-decoration: none;
}

.form-actions {
    display: flex;
    gap: 12px;
    padding-top: 16px;
}

/* Responsive */
@media (max-width: 768px) {
    .settings-layout {
        grid-template-columns: 1fr;
    }

    .settings-nav {
        display: flex;
        overflow-x: auto;
    }

    .settings-nav-item {
        white-space: nowrap;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="settings-page">
    <div class="settings-layout">
        <!-- Left Navigation -->
        <aside class="settings-nav">
            <a href="{% url 'accounts_app:profile_edit' %}" class="settings-nav-item active">
                <i class="fas fa-user"></i>
                <span>Public profile</span>
            </a>
            <a href="{% url 'accounts_app:account' %}" class="settings-nav-item">
                <i class="fas fa-shield-alt"></i>
                <span>Account</span>
            </a>
            <a href="{% url 'accounts_app:appearance' %}" class="settings-nav-item">
                <i class="fas fa-palette"></i>
                <span>Appearance</span>
            </a>

            <div style="height: 1px; background: var(--color-border-default); margin: 12px 8px;"></div>

            <a href="{% url 'accounts_app:git_integrations' %}" class="settings-nav-item">
                <i class="fab fa-git-alt"></i>
                <span>Git integrations</span>
            </a>
            <a href="{% url 'accounts_app:ssh_keys' %}" class="settings-nav-item">
                <i class="fas fa-key"></i>
                <span>SSH and GPG keys</span>
            </a>
            <a href="{% url 'accounts_app:api_keys' %}" class="settings-nav-item">
                <i class="fas fa-code"></i>
                <span>API keys</span>
            </a>
        </aside>

        <!-- Right Content -->
        <main class="settings-content">
            <div class="settings-header">
                <h1 class="settings-title">Public profile</h1>
                <p class="settings-subtitle">
                    This information will be displayed publicly on your profile at
                    <a href="/{{ user.username }}/">/{{ user.username }}/</a>
                </p>
            </div>

            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}

                <!-- Profile Picture -->
                <div class="form-section">
                    <h2 class="form-section-title">Profile picture</h2>
                    <div class="avatar-upload">
                        <div class="avatar-preview">
                            {% if profile.avatar %}
                                <img src="{{ profile.avatar.url }}" alt="{{ user.username }}">
                            {% else %}
                                {{ user.username|slice:":1"|upper }}
                            {% endif %}
                        </div>
                        <div class="avatar-upload-controls">
                            <div class="file-input-wrapper">
                                <input type="file" name="avatar" id="avatar-input" accept="image/*">
                                <label for="avatar-input" class="file-input-label">
                                    <i class="fas fa-upload"></i>
                                    <span>Upload new picture</span>
                                </label>
                            </div>
                            <p class="form-help" style="margin-top: 8px;">
                                Max size: 2MB. Recommended: 500x500px square image.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Basic Information -->
                <div class="form-section">
                    <h2 class="form-section-title">Basic information</h2>

                    <div class="form-group">
                        <label for="username">Username</label>
                        <input type="text" id="username" value="{{ user.username }}" disabled>
                        <p class="form-help">Username cannot be changed</p>
                    </div>

                    <div class="form-group">
                        <label for="first_name">First name</label>
                        <input type="text" id="first_name" name="first_name" value="{{ user.first_name }}">
                    </div>

                    <div class="form-group">
                        <label for="last_name">Last name</label>
                        <input type="text" id="last_name" name="last_name" value="{{ user.last_name }}">
                    </div>

                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email" value="{{ user.email }}" required>
                    </div>

                    <div class="form-group">
                        <label for="bio">Bio</label>
                        <textarea id="bio" name="bio" placeholder="Tell us about yourself...">{{ profile.bio }}</textarea>
                        <p class="form-help">Brief description for your profile. Markdown is not supported.</p>
                    </div>
                </div>

                <!-- Location & Institution -->
                <div class="form-section">
                    <h2 class="form-section-title">Location & Affiliation</h2>

                    <div class="form-group">
                        <label for="location">Location</label>
                        <input type="text" id="location" name="location" value="{{ profile.location }}" placeholder="e.g., Tokyo, Japan" autocomplete="off">
                        <input type="hidden" id="timezone" name="timezone" value="{{ profile.timezone }}">
                        <div id="location-suggestions" class="location-suggestions"></div>
                        <p class="form-help">
                            {% if profile.timezone %}
                                <i class="fas fa-clock"></i> Timezone: <strong>{{ profile.timezone }}</strong>
                            {% else %}
                                Start typing to see location suggestions
                            {% endif %}
                        </p>
                    </div>

                    <div class="form-group">
                        <label for="institution">Institution</label>
                        <input type="text" id="institution" name="institution" value="{{ profile.institution }}" placeholder="e.g., The University of Tokyo">
                    </div>
                </div>

                <!-- Links -->
                <div class="form-section">
                    <h2 class="form-section-title">Links</h2>

                    <div class="form-group">
                        <label for="website">Website</label>
                        <input type="url" id="website" name="website" value="{{ profile.website }}" placeholder="https://your-website.com">
                    </div>

                    <div class="form-group">
                        <label for="twitter">Twitter</label>
                        <input type="text" id="twitter" name="twitter" value="{{ profile.twitter }}" placeholder="username (without @)">
                    </div>

                    <div class="form-group">
                        <label for="google_scholar">Google Scholar</label>
                        <input type="url" id="google_scholar" name="google_scholar" value="{{ profile.google_scholar }}" placeholder="https://scholar.google.com/citations?user=...">
                    </div>

                    <div class="form-group">
                        <label for="orcid">ORCID</label>
                        <input type="text" id="orcid" name="orcid" value="{{ profile.orcid }}" placeholder="0000-0000-0000-0000">
                        <p class="form-help">Your ORCID identifier (e.g., 0000-0001-2345-6789)</p>
                    </div>

                </div>

                <!-- Actions -->
                <div class="form-actions">
                    <button type="submit" class="btn-save">
                        <i class="fas fa-check"></i>
                        Save changes
                    </button>
                    <a href="/{{ user.username }}/" class="btn-cancel">Cancel</a>
                </div>
            </form>
        </main>
    </div>
</div>

<style>
.location-suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    z-index: 1000;
    background: var(--color-canvas-default);
    border: 1px solid var(--color-border-default);
    border-radius: 6px;
    margin-top: 4px;
    max-height: 300px;
    overflow-y: auto;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    display: none;
}

.location-suggestions.show {
    display: block;
}

.location-suggestion-item {
    padding: 10px 12px;
    cursor: pointer;
    border-bottom: 1px solid var(--color-border-muted);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.location-suggestion-item:last-child {
    border-bottom: none;
}

.location-suggestion-item:hover {
    background: var(--color-canvas-subtle);
}

.location-city {
    font-weight: 500;
    color: var(--color-fg-default);
}

.location-timezone {
    font-size: 12px;
    color: var(--color-fg-muted);
    font-family: monospace;
}

.form-group {
    position: relative;
}
</style>

<script>
// Preview avatar before upload
document.getElementById('avatar-input')?.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.querySelector('.avatar-preview');
            preview.innerHTML = `<img src="${e.target.result}" alt="Avatar preview">`;
        };
        reader.readAsDataURL(file);
    }
});

// Location autocomplete with timezone
(function() {
    const locationInput = document.getElementById('location');
    const timezoneInput = document.getElementById('timezone');
    const suggestionsDiv = document.getElementById('location-suggestions');
    let citiesData = [];

    // Load cities/timezones data
    fetch('/static/data/cities_timezones.json')
        .then(response => response.json())
        .then(data => {
            citiesData = data;
        })
        .catch(err => console.error('Failed to load cities data:', err));

    // Show suggestions on input
    locationInput.addEventListener('input', function(e) {
        const query = e.target.value.trim().toLowerCase();

        if (query.length < 2) {
            suggestionsDiv.classList.remove('show');
            return;
        }

        // Filter cities matching query
        const matches = citiesData.filter(item =>
            item.city.toLowerCase().includes(query)
        ).slice(0, 10); // Limit to 10 results

        if (matches.length === 0) {
            suggestionsDiv.classList.remove('show');
            return;
        }

        // Render suggestions
        suggestionsDiv.innerHTML = matches.map(item => `
            <div class="location-suggestion-item" data-city="${item.city}" data-timezone="${item.timezone}">
                <span class="location-city">${item.city}</span>
                <span class="location-timezone"><i class="fas fa-clock"></i> ${item.timezone}</span>
            </div>
        `).join('');

        suggestionsDiv.classList.add('show');

        // Add click handlers
        suggestionsDiv.querySelectorAll('.location-suggestion-item').forEach(item => {
            item.addEventListener('click', function() {
                const city = this.dataset.city;
                const timezone = this.dataset.timezone;

                locationInput.value = city;
                timezoneInput.value = timezone;
                suggestionsDiv.classList.remove('show');

                // Update help text
                const helpText = locationInput.parentElement.querySelector('.form-help');
                helpText.innerHTML = `<i class="fas fa-clock"></i> Timezone: <strong>${timezone}</strong>`;
            });
        });
    });

    // Hide suggestions when clicking outside
    document.addEventListener('click', function(e) {
        if (!locationInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
            suggestionsDiv.classList.remove('show');
        }
    });

    // Handle keyboard navigation
    locationInput.addEventListener('keydown', function(e) {
        const items = suggestionsDiv.querySelectorAll('.location-suggestion-item');
        if (items.length === 0) return;

        let currentIndex = Array.from(items).findIndex(item => item.classList.contains('active'));

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            if (currentIndex < items.length - 1) {
                items[currentIndex]?.classList.remove('active');
                items[currentIndex + 1].classList.add('active');
            } else {
                items[currentIndex]?.classList.remove('active');
                items[0].classList.add('active');
            }
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            if (currentIndex > 0) {
                items[currentIndex].classList.remove('active');
                items[currentIndex - 1].classList.add('active');
            } else {
                items[currentIndex]?.classList.remove('active');
                items[items.length - 1].classList.add('active');
            }
        } else if (e.key === 'Enter') {
            e.preventDefault();
            const activeItem = suggestionsDiv.querySelector('.location-suggestion-item.active');
            if (activeItem) {
                activeItem.click();
            } else if (items.length > 0) {
                items[0].click();
            }
        } else if (e.key === 'Escape') {
            suggestionsDiv.classList.remove('show');
        }
    });
})();
</script>
{% endblock %}
