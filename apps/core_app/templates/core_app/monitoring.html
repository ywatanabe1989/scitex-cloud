{% extends 'base.html' %}
{% load static %}

{% block title %}System Monitoring - SciTeX Cloud{% endblock %}

{% block extra_css %}
<style>
/* Monitoring Dashboard Styles */
.monitoring-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem;
}

.monitoring-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.status-indicator {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.status-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    animation: pulse 2s infinite;
}

.status-dot.healthy {
    background: #10b981;
}

.status-dot.warning {
    background: #f59e0b;
}

.status-dot.critical {
    background: #ef4444;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

/* Metrics Grid */
.metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.metric-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.metric-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.metric-title {
    font-weight: 600;
    color: var(--text-color);
}

.metric-value {
    font-size: 2rem;
    font-weight: bold;
    color: var(--scitex-color-01);
}

.metric-unit {
    font-size: 0.875rem;
    color: var(--text-color-secondary);
    margin-left: 0.25rem;
}

.metric-chart {
    height: 100px;
    margin-top: 1rem;
}

/* Real-time Chart */
.chart-container {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
}

.chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.time-range-selector {
    display: flex;
    gap: 0.5rem;
}

.time-range-btn {
    padding: 0.25rem 0.75rem;
    border: 1px solid var(--scitex-color-06);
    background: white;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
}

.time-range-btn:hover,
.time-range-btn.active {
    background: var(--scitex-color-07);
    border-color: var(--scitex-color-04);
}

/* Service Status */
.services-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
}

.service-card {
    background: white;
    border-radius: 8px;
    padding: 1rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.service-icon {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
}

.service-icon.healthy {
    background: #d1fae5;
    color: #065f46;
}

.service-icon.warning {
    background: #fef3c7;
    color: #92400e;
}

.service-icon.critical {
    background: #fee2e2;
    color: #991b1b;
}

.service-info h4 {
    margin: 0;
    font-size: 1rem;
}

.service-info p {
    margin: 0;
    font-size: 0.875rem;
    color: var(--text-color-secondary);
}

/* Activity Log */
.activity-log {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    max-height: 400px;
    overflow-y: auto;
}

.log-entry {
    display: flex;
    gap: 1rem;
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--scitex-color-06);
}

.log-entry:last-child {
    border-bottom: none;
}

.log-time {
    font-size: 0.875rem;
    color: var(--text-color-secondary);
    min-width: 80px;
}

.log-level {
    padding: 0.125rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
}

.log-level.info {
    background: #dbeafe;
    color: #1e40af;
}

.log-level.warning {
    background: #fef3c7;
    color: #92400e;
}

.log-level.error {
    background: #fee2e2;
    color: #991b1b;
}

.log-message {
    flex: 1;
    font-size: 0.875rem;
}
</style>
{% endblock %}

{% block content %}
<div class="monitoring-container">
    <div class="monitoring-header">
        <div>
            <h1>System Monitoring</h1>
            <p class="text-muted">Real-time system health and performance metrics</p>
        </div>
        <div class="status-indicator">
            <span class="status-dot healthy"></span>
            <span>All Systems Operational</span>
        </div>
    </div>
    
    <!-- Key Metrics -->
    <div class="metrics-grid">
        <div class="metric-card">
            <div class="metric-header">
                <span class="metric-title">Active Users</span>
                <i class="fas fa-users text-primary"></i>
            </div>
            <div class="metric-value">
                <span id="active-users">{{ metrics.active_users|default:0 }}</span>
            </div>
            <div class="metric-chart" id="users-sparkline"></div>
        </div>
        
        <div class="metric-card">
            <div class="metric-header">
                <span class="metric-title">API Requests</span>
                <i class="fas fa-exchange-alt text-info"></i>
            </div>
            <div class="metric-value">
                <span id="api-requests">{{ metrics.api_requests|default:0 }}</span>
                <span class="metric-unit">/min</span>
            </div>
            <div class="metric-chart" id="requests-sparkline"></div>
        </div>
        
        <div class="metric-card">
            <div class="metric-header">
                <span class="metric-title">CPU Usage</span>
                <i class="fas fa-microchip text-warning"></i>
            </div>
            <div class="metric-value">
                <span id="cpu-usage">{{ metrics.cpu_usage|default:0 }}</span>
                <span class="metric-unit">%</span>
            </div>
            <div class="metric-chart" id="cpu-sparkline"></div>
        </div>
        
        <div class="metric-card">
            <div class="metric-header">
                <span class="metric-title">Memory Usage</span>
                <i class="fas fa-memory text-success"></i>
            </div>
            <div class="metric-value">
                <span id="memory-usage">{{ metrics.memory_usage|default:0 }}</span>
                <span class="metric-unit">GB</span>
            </div>
            <div class="metric-chart" id="memory-sparkline"></div>
        </div>
    </div>
    
    <!-- Real-time Chart -->
    <div class="chart-container">
        <div class="chart-header">
            <h3>System Performance</h3>
            <div class="time-range-selector">
                <button class="time-range-btn active" data-range="1h">1H</button>
                <button class="time-range-btn" data-range="6h">6H</button>
                <button class="time-range-btn" data-range="24h">24H</button>
                <button class="time-range-btn" data-range="7d">7D</button>
            </div>
        </div>
        <canvas id="performance-chart" height="100"></canvas>
    </div>
    
    <div class="row">
        <div class="col-lg-6">
            <!-- Service Status -->
            <div class="chart-container">
                <h3>Service Status</h3>
                <div class="services-grid mt-3">
                    <div class="service-card">
                        <div class="service-icon healthy">
                            <i class="fas fa-server"></i>
                        </div>
                        <div class="service-info">
                            <h4>Web Server</h4>
                            <p>Response time: 45ms</p>
                        </div>
                    </div>
                    
                    <div class="service-card">
                        <div class="service-icon healthy">
                            <i class="fas fa-database"></i>
                        </div>
                        <div class="service-info">
                            <h4>Database</h4>
                            <p>Connections: 23/100</p>
                        </div>
                    </div>
                    
                    <div class="service-card">
                        <div class="service-icon healthy">
                            <i class="fas fa-hdd"></i>
                        </div>
                        <div class="service-info">
                            <h4>Storage</h4>
                            <p>Usage: 45.2GB/500GB</p>
                        </div>
                    </div>
                    
                    <div class="service-card">
                        <div class="service-icon warning">
                            <i class="fas fa-network-wired"></i>
                        </div>
                        <div class="service-info">
                            <h4>Redis Cache</h4>
                            <p>Memory: 85% used</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-6">
            <!-- Activity Log -->
            <div class="activity-log">
                <h3 class="mb-3">Recent Activity</h3>
                <div id="activity-log-entries">
                    {% for log in recent_logs %}
                    <div class="log-entry">
                        <span class="log-time">{{ log.time }}</span>
                        <span class="log-level {{ log.level }}">{{ log.level|upper }}</span>
                        <span class="log-message">{{ log.message }}</span>
                    </div>
                    {% empty %}
                    <p class="text-muted">No recent activity</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Initialize performance chart
const ctx = document.getElementById('performance-chart').getContext('2d');
const performanceChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: [],
        datasets: [{
            label: 'CPU %',
            data: [],
            borderColor: 'rgb(59, 130, 246)',
            tension: 0.4
        }, {
            label: 'Memory GB',
            data: [],
            borderColor: 'rgb(16, 185, 129)',
            tension: 0.4
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// WebSocket connection for real-time updates
let ws;
function connectWebSocket() {
    ws = new WebSocket(`ws://${window.location.host}/ws/monitoring/`);
    
    ws.onmessage = function(e) {
        const data = JSON.parse(e.data);
        updateMetrics(data);
    };
    
    ws.onclose = function() {
        // Reconnect after 5 seconds
        setTimeout(connectWebSocket, 5000);
    };
}

// Update metrics in real-time
function updateMetrics(data) {
    // Update metric values
    if (data.active_users !== undefined) {
        document.getElementById('active-users').textContent = data.active_users;
    }
    if (data.api_requests !== undefined) {
        document.getElementById('api-requests').textContent = data.api_requests;
    }
    if (data.cpu_usage !== undefined) {
        document.getElementById('cpu-usage').textContent = data.cpu_usage.toFixed(1);
    }
    if (data.memory_usage !== undefined) {
        document.getElementById('memory-usage').textContent = data.memory_usage.toFixed(1);
    }
    
    // Update chart
    if (data.timestamp && data.cpu_usage && data.memory_usage) {
        performanceChart.data.labels.push(new Date(data.timestamp).toLocaleTimeString());
        performanceChart.data.datasets[0].data.push(data.cpu_usage);
        performanceChart.data.datasets[1].data.push(data.memory_usage);
        
        // Keep only last 20 data points
        if (performanceChart.data.labels.length > 20) {
            performanceChart.data.labels.shift();
            performanceChart.data.datasets.forEach(dataset => {
                dataset.data.shift();
            });
        }
        
        performanceChart.update();
    }
    
    // Update activity log
    if (data.log_entry) {
        addLogEntry(data.log_entry);
    }
}

function addLogEntry(entry) {
    const logContainer = document.getElementById('activity-log-entries');
    const logEntry = document.createElement('div');
    logEntry.className = 'log-entry';
    logEntry.innerHTML = `
        <span class="log-time">${entry.time}</span>
        <span class="log-level ${entry.level}">${entry.level.toUpperCase()}</span>
        <span class="log-message">${entry.message}</span>
    `;
    logContainer.insertBefore(logEntry, logContainer.firstChild);
    
    // Keep only last 50 entries
    while (logContainer.children.length > 50) {
        logContainer.removeChild(logContainer.lastChild);
    }
}

// Time range selector
document.querySelectorAll('.time-range-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.time-range-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        // TODO: Load data for selected time range
    });
});

// Initialize WebSocket connection
// connectWebSocket();

// Simulate real-time updates for demo
setInterval(() => {
    const mockData = {
        active_users: Math.floor(Math.random() * 50) + 100,
        api_requests: Math.floor(Math.random() * 100) + 50,
        cpu_usage: Math.random() * 30 + 20,
        memory_usage: Math.random() * 2 + 3,
        timestamp: new Date().toISOString()
    };
    updateMetrics(mockData);
}, 3000);
</script>
{% endblock %}