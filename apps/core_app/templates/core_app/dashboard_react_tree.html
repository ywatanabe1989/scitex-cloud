{% extends "base_global.html" %}
{% load static %}

{% block title %}SciTeX Dashboard{% endblock %}

{% block meta_description %}Advanced file management dashboard with React Complex Tree interface for scientific research projects.{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'common/css/hero-gradients.css' %}">
<style>
  .dashboard-container {
    display: flex;
    height: calc(100vh - 120px);
    margin-top: 2rem;
  }
  
  .file-tree-panel {
    width: 300px;
    min-width: 250px;
    max-width: 500px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    margin-right: 1rem;
    overflow: hidden;
    resize: horizontal;
  }
  
  .file-tree-header {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    padding: 1rem;
    border-bottom: 1px solid #ddd;
    font-weight: 600;
    color: #495057;
  }
  
  .file-tree-container {
    height: calc(100% - 60px);
    overflow: auto;
    padding: 0.5rem;
  }
  
  .content-panel {
    flex: 1;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }
  
  .content-header {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    padding: 1rem;
    border-bottom: 1px solid #ddd;
    display: flex;
    justify-content: between;
    align-items: center;
  }
  
  .content-body {
    flex: 1;
    padding: 1rem;
    overflow: auto;
  }
  
  .file-item {
    display: flex;
    align-items: center;
    padding: 0.5rem;
    margin: 0.25rem 0;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    user-select: none;
  }
  
  .file-item:hover {
    background: #f8f9fa;
  }
  
  .file-item.selected {
    background: #e3f2fd;
    border-left: 3px solid #2196f3;
  }
  
  .file-item.focused {
    outline: 2px solid #2196f3;
    outline-offset: -2px;
  }
  
  .file-icon {
    width: 20px;
    height: 20px;
    margin-right: 0.5rem;
    flex-shrink: 0;
  }
  
  .expand-button {
    width: 16px;
    height: 16px;
    margin-right: 0.25rem;
    border: none;
    background: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 3px;
    transition: all 0.2s ease;
  }
  
  .expand-button:hover {
    background: #e0e0e0;
  }
  
  .expand-button svg {
    width: 12px;
    height: 12px;
    transition: transform 0.2s ease;
  }
  
  .expand-button.expanded svg {
    transform: rotate(90deg);
  }
  
  .file-name {
    font-size: 0.9rem;
    color: #333;
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .file-size {
    font-size: 0.75rem;
    color: #666;
    margin-left: 0.5rem;
  }
  
  .loading-indicator {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    color: #666;
  }
  
  .loading-spinner {
    width: 20px;
    height: 20px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #333;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-right: 0.5rem;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  .welcome-screen {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    text-align: center;
    color: #666;
  }
  
  .welcome-icon {
    width: 64px;
    height: 64px;
    margin-bottom: 1rem;
    opacity: 0.5;
  }
  
  .file-content {
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.85rem;
    line-height: 1.5;
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 6px;
    border: 1px solid #e9ecef;
    overflow-x: auto;
    white-space: pre-wrap;
  }
  
  .recommendations-panel {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 8px;
    padding: 1.5rem;
    border: 1px solid #e0e0e0;
  }
  
  .recommendation-card {
    background: white;
    border-radius: 8px;
    padding: 1rem;
    border: 1px solid #e9ecef;
    transition: all 0.2s ease;
    height: 100%;
    text-align: center;
  }
  
  .recommendation-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  
  .rec-icon {
    font-size: 2rem;
    color: #495057;
    margin-bottom: 0.5rem;
  }
  
  .recommendation-card h6 {
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: #212529;
  }
  
  .recommendation-card p {
    font-size: 0.85rem;
    margin-bottom: 1rem;
  }
  
  .toolbar {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }
  
  .toolbar-btn {
    padding: 0.5rem 1rem;
    border: 1px solid #ddd;
    background: white;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85rem;
    transition: all 0.2s ease;
  }
  
  .toolbar-btn:hover {
    background: #f8f9fa;
    border-color: #bbb;
  }
  
  .toolbar-btn.active {
    background: #007bff;
    color: white;
    border-color: #007bff;
  }
</style>
{% endblock %}

{% block content %}
<!-- CSRF Token for JavaScript -->
{% csrf_token %}

<!-- Hero Section -->
<section class="hero-section hero-silverish-ai-light">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-8 text-center">
        <h1 class="hero-title">SciTeX Dashboard</h1>
        <p class="hero-subtitle">File Manager for your research projects</p>
      </div>
    </div>
  </div>
</section>

<div class="container-fluid">
  <div class="dashboard-container">
    <!-- File Tree Panel -->
    <div class="file-tree-panel">
      <div class="file-tree-header">
        <i class="fas fa-folder me-2"></i>Project Files
      </div>
      <div class="file-tree-container" id="fileTreeContainer">
        <div class="loading-indicator">
          <div class="loading-spinner"></div>
          Loading file tree...
        </div>
      </div>
    </div>
    
    <!-- Content Panel -->
    <div class="content-panel">
      <div class="content-header">
        <div>
          <h5 class="mb-0" id="contentTitle">Welcome to SciTeX Dashboard</h5>
          <small class="text-muted" id="contentSubtitle">Select a file to view its contents</small>
        </div>
        <div class="toolbar">
          <button class="toolbar-btn" id="newProjectBtn" title="Create new project (Ctrl+Shift+N)">
            <i class="fas fa-plus me-1"></i>New Project
          </button>
          <button class="toolbar-btn" id="cloneGitHubBtn" title="Clone from GitHub repository">
            <i class="fab fa-github me-1"></i>Clone from GitHub
          </button>
          <button class="toolbar-btn" id="refreshBtn" title="Refresh file tree (F5)">
            <i class="fas fa-sync me-1"></i>Refresh
          </button>
          <button class="toolbar-btn" id="writerBtn" title="Open SciTeX Writer for selected project">
            <i class="fas fa-edit me-1"></i>Writer
          </button>
        </div>
      </div>
      <div class="content-body" id="contentBody">
        <!-- Smart Recommendations Panel -->
        {% if recommendations %}
        <div class="recommendations-panel mb-4">
          <h5 class="mb-3"><i class="fas fa-lightbulb me-2"></i>Recommended for You</h5>
          <div class="row">
            {% for rec in recommendations %}
            <div class="col-md-4 mb-3">
              <div class="recommendation-card">
                <div class="rec-icon">
                  <i class="{{ rec.icon }}"></i>
                </div>
                <h6>{{ rec.title }}</h6>
                <p class="text-muted small">{{ rec.description }}</p>
                {% if rec.action_url %}
                <a href="{{ rec.action_url }}" class="btn btn-sm btn-outline-primary">
                  {{ rec.type|title }}
                </a>
                {% endif %}
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
        {% endif %}
        
        <div class="welcome-screen">
          <i class="fas fa-folder-open welcome-icon"></i>
          <h4>File Manager</h4>
          <p>Select a directory from the tree to browse files</p>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// React Complex Tree implementation for SciTeX Dashboard
class SciTeXFileManager {
  constructor() {
    this.fileTree = {};
    this.expandedItems = new Set(['root', 'projects']);
    this.selectedItems = new Set();
    this.focusedItem = null;
    this.currentContent = null;
    this.flatItemList = [];  // For keyboard navigation
    this.currentFocusIndex = -1;  // Current focus position in flatItemList
    
    this.init();
  }
  
  async init() {
    await this.loadFileTree();
    this.setupEventListeners();
    this.renderTree();
  }
  
  async loadFileTree() {
    try {
      // Add cache busting to ensure fresh data
      const timestamp = new Date().getTime();
      const response = await fetch(`/core/api/v1/filesystem/tree/?t=${timestamp}`, {
        method: 'GET',
        credentials: 'same-origin',
        cache: 'no-cache'
      });
      
      const data = await response.json();
      
      if (data.success) {
        this.fileTree = data.fileTree;
        this.expandedItems = new Set(data.expandedItems || ['root', 'projects']);
        console.log('File tree loaded with', Object.keys(this.fileTree).length, 'items');
        console.log('Full fileTree object:', this.fileTree);
        console.log('Projects found:', this.fileTree.projects?.children || []);
        console.log('Root exists:', !!this.fileTree.root);
        console.log('Projects exists:', !!this.fileTree.projects);
      } else {
        console.error('Failed to load file tree:', data.error);
        this.showError('Failed to load file tree: ' + data.error);
      }
    } catch (error) {
      console.error('Error loading file tree:', error);
      this.showError('Network error while loading file tree');
    }
  }
  
  setupEventListeners() {
    // Toolbar buttons
    document.getElementById('newProjectBtn').addEventListener('click', () => this.createNewProject());
    document.getElementById('cloneGitHubBtn').addEventListener('click', () => this.cloneFromGitHub());
    document.getElementById('refreshBtn').addEventListener('click', () => this.refresh());
    document.getElementById('writerBtn').addEventListener('click', () => this.openWriter());
    
    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => this.handleKeyboardShortcut(e));
    
    // Make the file tree container focusable for keyboard navigation
    const fileTreeContainer = document.getElementById('fileTreeContainer');
    fileTreeContainer.setAttribute('tabindex', '0');
    fileTreeContainer.style.outline = 'none';
  }
  
  renderTree() {
    const container = document.getElementById('fileTreeContainer');
    console.log('=== RENDER TREE START ===');
    console.log('FileTree keys:', Object.keys(this.fileTree));
    console.log('Root exists:', !!this.fileTree.root);
    
    if (!this.fileTree.root) {
      console.warn('No root found in fileTree:', this.fileTree);
      container.innerHTML = '<div class="loading-indicator">No files found</div>';
      return;
    }
    
    console.log('Root item:', this.fileTree.root);
    if (this.fileTree.projects) {
      console.log('Projects item:', this.fileTree.projects);
      console.log('Projects children:', this.fileTree.projects.children);
    }
    
    container.innerHTML = '';
    this.flatItemList = [];  // Reset for keyboard navigation
    this.renderItem('root', container, 0);
    this.updateKeyboardFocus();
    console.log('=== RENDER TREE END ===');
  }
  
  renderItem(itemId, container, depth) {
    const item = this.fileTree[itemId];
    console.log(`Rendering item: ${itemId}`, item);
    if (!item) {
      console.warn(`Item not found: ${itemId}`);
      return;
    }
    
    // Add to flat list for keyboard navigation
    this.flatItemList.push({
      id: itemId,
      depth: depth,
      type: item.type,
      name: item.name
    });
    
    const div = document.createElement('div');
    div.className = 'file-item';
    div.style.paddingLeft = `${depth * 20 + 8}px`;
    div.dataset.itemId = itemId;
    div.setAttribute('tabindex', '-1');  // Make focusable but not in tab order
    
    if (this.selectedItems.has(itemId)) {
      div.classList.add('selected');
    }
    if (this.focusedItem === itemId) {
      div.classList.add('focused');
    }
    
    const isFolder = item.type === 'folder';
    const isExpanded = this.expandedItems.has(itemId);
    
    // Expand button for folders
    if (isFolder) {
      const expandBtn = document.createElement('button');
      expandBtn.className = 'expand-button';
      if (isExpanded) expandBtn.classList.add('expanded');
      expandBtn.innerHTML = '<svg fill="currentColor" viewBox="0 0 20 20"><path d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"/></svg>';
      expandBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        this.toggleExpand(itemId);
      });
      div.appendChild(expandBtn);
    } else {
      // Empty space for non-folders
      const spacer = document.createElement('div');
      spacer.style.width = '16px';
      spacer.style.marginRight = '0.25rem';
      div.appendChild(spacer);
    }
    
    // File icon
    const icon = document.createElement('i');
    icon.className = `fas ${this.getFileIcon(item)} file-icon`;
    div.appendChild(icon);
    
    // File name
    const name = document.createElement('span');
    name.className = 'file-name';
    name.textContent = item.name;
    div.appendChild(name);
    
    // File size for files
    if (!isFolder && item.size) {
      const size = document.createElement('span');
      size.className = 'file-size';
      size.textContent = this.formatFileSize(item.size);
      div.appendChild(size);
    }
    
    // Click handler
    div.addEventListener('click', (e) => {
      this.handleItemClick(itemId, e.ctrlKey || e.metaKey);
    });
    
    container.appendChild(div);
    
    // Render children if expanded
    if (isFolder && isExpanded && item.children) {
      item.children.forEach(childId => {
        this.renderItem(childId, container, depth + 1);
      });
    }
  }
  
  getFileIcon(item) {
    if (item.type === 'folder') {
      return this.expandedItems.has(item.id) ? 'fa-folder-open' : 'fa-folder';
    }
    
    const iconMap = {
      'python': 'fa-file-code',
      'javascript': 'fa-file-code',
      'json': 'fa-file-code',
      'text': 'fa-file-alt',
      'markdown': 'fa-file-alt',
      'image': 'fa-file-image',
      'pdf': 'fa-file-pdf',
      'excel': 'fa-file-excel',
      'word': 'fa-file-word',
      'powerpoint': 'fa-file-powerpoint',
      'archive': 'fa-file-archive'
    };
    
    return iconMap[item.type] || 'fa-file';
  }
  
  formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
  }
  
  toggleExpand(itemId) {
    if (this.expandedItems.has(itemId)) {
      this.expandedItems.delete(itemId);
    } else {
      this.expandedItems.add(itemId);
    }
    this.renderTree();
  }
  
  handleItemClick(itemId, isMultiSelect) {
    const item = this.fileTree[itemId];
    
    // Handle folder expansion
    if (item.type === 'folder') {
      this.toggleExpand(itemId);
    }
    
    // Handle selection
    if (!isMultiSelect) {
      this.selectedItems.clear();
    }
    
    if (this.selectedItems.has(itemId)) {
      this.selectedItems.delete(itemId);
    } else {
      this.selectedItems.add(itemId);
    }
    
    this.focusedItem = itemId;
    
    // Load file content if it's a file
    if (item.type !== 'folder') {
      this.loadFileContent(itemId);
    }
    
    this.renderTree();
  }
  
  async loadFileContent(fileId) {
    try {
      const response = await fetch(`/core/api/v1/filesystem/content/${fileId}/`, {
        method: 'GET',
        credentials: 'same-origin'
      });
      
      const data = await response.json();
      
      if (data.success) {
        this.displayFileContent(data.content, data.fileName);
      } else {
        this.showError('Failed to load file content: ' + data.error);
      }
    } catch (error) {
      console.error('Error loading file content:', error);
      this.showError('Network error while loading file content');
    }
  }
  
  displayFileContent(content, fileName) {
    const titleEl = document.getElementById('contentTitle');
    const subtitleEl = document.getElementById('contentSubtitle');
    const bodyEl = document.getElementById('contentBody');
    
    titleEl.textContent = fileName;
    subtitleEl.textContent = `${content.length} characters`;
    
    bodyEl.innerHTML = `
      <div class="file-content">${this.escapeHtml(content)}</div>
    `;
  }
  
  escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  
  showError(message) {
    const bodyEl = document.getElementById('contentBody');
    bodyEl.innerHTML = `
      <div class="alert alert-danger">
        <i class="fas fa-exclamation-triangle me-2"></i>
        ${message}
      </div>
    `;
  }
  
  getCsrfToken() {
    const token = document.querySelector('[name=csrfmiddlewaretoken]');
    return token ? token.value : '';
  }
  
  // Placeholder methods for toolbar actions
  createNewFile() {
    const name = prompt('Enter file name:');
    if (name) {
      console.log('Creating new file:', name);
      // TODO: Implement file creation API call
    }
  }
  
  createNewFolder() {
    const name = prompt('Enter folder name:');
    if (name) {
      console.log('Creating new folder:', name);
      // TODO: Implement folder creation API call
    }
  }
  
  async refresh() {
    console.log('Manual refresh triggered - clearing cache and reloading...');
    this.fileTree = {};
    this.expandedItems = new Set(['root', 'projects']);
    await this.loadFileTree();
    this.renderTree();
    console.log('Manual refresh completed');
  }
  
  createNewProject() {
    // Create a simple modal for project creation
    const modal = document.createElement('div');
    modal.className = 'modal fade show';
    modal.style.display = 'block';
    modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
    modal.innerHTML = `
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Create New Project</h5>
            <button type="button" class="btn-close" onclick="this.closest('.modal').remove()"></button>
          </div>
          <div class="modal-body">
            <form id="newProjectForm">
              <div class="mb-3">
                <label for="projectName" class="form-label">Project Name</label>
                <input type="text" class="form-control" id="projectName" required>
              </div>
              <div class="mb-3">
                <label for="projectDescription" class="form-label">Description</label>
                <textarea class="form-control" id="projectDescription" rows="3"></textarea>
              </div>
              <div class="mb-3">
                <label for="projectHypotheses" class="form-label">Research Hypotheses</label>
                <textarea class="form-control" id="projectHypotheses" rows="2"></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
            <button type="button" class="btn btn-primary" id="submitProjectBtn">Create Project</button>
          </div>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    // Add event listener for the submit button
    document.getElementById('submitProjectBtn').addEventListener('click', () => {
      this.submitNewProject();
    });
    
    document.getElementById('projectName').focus();
  }
  
  async submitNewProject() {
    const name = document.getElementById('projectName').value.trim();
    const description = document.getElementById('projectDescription').value.trim();
    const hypotheses = document.getElementById('projectHypotheses').value.trim();
    
    console.log('Creating project:', { name, description, hypotheses });
    
    if (!name) {
      alert('Project name is required');
      return;
    }
    
    try {
      const requestData = {
        name: name,
        description: description || `Research project: ${name}`,
        hypotheses: hypotheses || 'Research hypotheses to be defined',
        create_default_structure: true
      };
      
      console.log('Request data:', requestData);
      
      const response = await fetch('/core/api/v1/projects/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': this.getCsrfToken()
        },
        credentials: 'same-origin',
        body: JSON.stringify(requestData)
      });
      
      console.log('Response status:', response.status);
      const data = await response.json();
      console.log('Response data:', data);
      
      if (data.success) {
        // Close modal
        document.querySelector('.modal').remove();
        
        console.log('Project created successfully:', data.project);
        
        // Check if name was changed for uniqueness
        let successMessage = `Project "${data.project.name}" created successfully!`;
        if (data.name_changed) {
          successMessage = `Project created successfully! Name changed from "${data.original_name}" to "${data.final_name}" to ensure uniqueness.`;
        }
        
        // Clear the file tree cache and reload completely
        this.fileTree = {};
        this.expandedItems = new Set(['root', 'projects']);
        
        // Add a small delay to ensure database write is complete
        setTimeout(async () => {
          // Refresh file tree to show new project
          await this.loadFileTree();
          this.renderTree();
          
          // Show success message
          this.showSuccessMessage(successMessage);
          
          console.log('Project created and file tree refreshed');
        }, 100);
      } else {
        // Handle specific error types
        if (data.error && data.error.includes('already exists')) {
          alert('Project name already exists. Please choose a different name.');
        } else {
          alert('Error creating project: ' + (data.error || 'Unknown error'));
        }
      }
    } catch (error) {
      console.error('Error creating project:', error);
      alert('Network error while creating project: ' + error.message);
    }
  }
  
  cloneFromGitHub() {
    // Create a modal for GitHub cloning
    const modal = document.createElement('div');
    modal.className = 'modal fade show';
    modal.style.display = 'block';
    modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
    modal.innerHTML = `
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Clone from GitHub</h5>
            <button type="button" class="btn-close" onclick="this.closest('.modal').remove()"></button>
          </div>
          <div class="modal-body">
            <form id="cloneGitHubForm">
              <div class="mb-3">
                <label for="githubUrl" class="form-label">Git Repository URL</label>
                <input type="text" class="form-control" id="githubUrl" 
                       placeholder="git@github.com:username/repository.git or https://github.com/username/repository" required>
                <div class="form-text">Enter SSH (git@github.com:user/repo.git) or HTTPS (https://github.com/user/repo) URL</div>
              </div>
              <div class="mb-3">
                <label for="cloneProjectName" class="form-label">Project Name</label>
                <input type="text" class="form-control" id="cloneProjectName" required>
                <div class="form-text">This will be auto-filled from the repository name</div>
              </div>
              <div class="mb-3">
                <label for="cloneDescription" class="form-label">Description (Optional)</label>
                <textarea class="form-control" id="cloneDescription" rows="2"></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
            <button type="button" class="btn btn-primary" id="submitCloneBtn">Clone Repository</button>
          </div>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    // Add event listener for the submit button
    document.getElementById('submitCloneBtn').addEventListener('click', () => {
      this.submitCloneProject();
    });
    
    // Auto-fill project name when URL changes
    document.getElementById('githubUrl').addEventListener('input', (e) => {
      const url = e.target.value;
      const match = url.match(/github\.com\/[^\/]+\/([^\/\.]+)/);
      if (match) {
        document.getElementById('cloneProjectName').value = match[1];
      }
    });
    
    document.getElementById('githubUrl').focus();
  }
  
  async submitCloneProject() {
    const githubUrl = document.getElementById('githubUrl').value.trim();
    const name = document.getElementById('cloneProjectName').value.trim();
    const description = document.getElementById('cloneDescription').value.trim();
    
    if (!githubUrl || !name) {
      alert('GitHub URL and project name are required');
      return;
    }
    
    try {
      const response = await fetch('/core/api/v1/projects/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': this.getCsrfToken()
        },
        credentials: 'same-origin',
        body: JSON.stringify({
          name: name,
          description: description || `Cloned from ${githubUrl}`,
          hypotheses: 'Research hypotheses from cloned repository',
          source_code_url: githubUrl,
          create_default_structure: true
        })
      });
      
      const data = await response.json();
      
      if (data.success) {
        // Close modal
        document.querySelector('.modal').remove();
        
        console.log('Project cloned successfully:', data.project);
        
        // Check if name was changed for uniqueness
        let successMessage = `Project "${data.project.name}" cloned successfully from GitHub!`;
        if (data.name_changed) {
          successMessage = `Project cloned successfully! Name changed from "${data.original_name}" to "${data.final_name}" to ensure uniqueness.`;
        }
        
        // Clear the file tree cache and reload completely
        this.fileTree = {};
        this.expandedItems = new Set(['root', 'projects']);
        
        // Add a small delay to ensure all operations are complete
        setTimeout(async () => {
          // Refresh file tree to show new project
          await this.loadFileTree();
          this.renderTree();
          
          // Show success message
          this.showSuccessMessage(successMessage);
          
          console.log('Project cloned and file tree refreshed');
        }, 200);
      } else {
        // Handle specific error types
        if (data.error && data.error.includes('already exists')) {
          alert('Project name already exists. Please choose a different name.');
        } else {
          alert('Error cloning project: ' + data.error);
        }
      }
    } catch (error) {
      console.error('Error cloning project:', error);
      alert('Network error while cloning project');
    }
  }
  
  showSuccessMessage(message) {
    const bodyEl = document.getElementById('contentBody');
    bodyEl.innerHTML = `
      <div class="alert alert-success">
        <i class="fas fa-check-circle me-2"></i>
        ${message}
      </div>
      <div class="welcome-screen">
        <i class="fas fa-folder-open welcome-icon"></i>
        <h4>File Manager</h4>
        <p>Select a directory from the tree to browse files</p>
      </div>
    `;
  }
  
  showKeyboardShortcuts() {
    const modal = document.createElement('div');
    modal.className = 'modal fade show';
    modal.style.display = 'block';
    modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
    modal.innerHTML = `
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Keyboard Shortcuts</h5>
            <button type="button" class="btn-close" onclick="this.closest('.modal').remove()"></button>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-md-6">
                <h6><i class="fas fa-keyboard me-2"></i>File Operations</h6>
                <ul class="list-unstyled">
                  <li><strong>F2</strong> - Rename selected item</li>
                  <li><strong>Delete</strong> - Delete selected items</li>
                  <li><strong>F5</strong> - Refresh file tree</li>
                  <li><strong>Escape</strong> - Clear selection</li>
                  <li><strong>H / F1</strong> - Show this help</li>
                </ul>
              </div>
              <div class="col-md-6">
                <h6><i class="fas fa-plus-circle me-2"></i>Project Actions</h6>
                <ul class="list-unstyled">
                  <li><strong>Ctrl+Shift+N</strong> - Create new project</li>
                  <li><strong>Ctrl+Click</strong> - Multi-select items</li>
                </ul>
                
                <h6 class="mt-3"><i class="fas fa-info-circle me-2"></i>Navigation</h6>
                <ul class="list-unstyled">
                  <li><strong>↑↓</strong> - Navigate up/down items</li>
                  <li><strong>→</strong> - Expand folder or move to child</li>
                  <li><strong>←</strong> - Collapse folder or move to parent</li>
                  <li><strong>Enter</strong> - Open file or expand/collapse folder</li>
                  <li><strong>Tab</strong> - Focus file tree</li>
                </ul>
              </div>
            </div>
            <div class="alert alert-info mt-3">
              <i class="fas fa-lightbulb me-2"></i>
              <strong>Tip:</strong> Use Tab to focus the file tree, then navigate with arrow keys. All shortcuts work when the file manager is active. Completely keyboard-driven workflow!
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" onclick="this.closest('.modal').remove()">Got it!</button>
          </div>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
  }
  
  renameItem(itemId) {
    const item = this.fileTree[itemId];
    const newName = prompt('Enter new name:', item.name);
    if (newName && newName !== item.name) {
      console.log('Renaming item:', itemId, 'to', newName);
      // TODO: Implement rename API call
    }
  }
  
  deleteSelectedItems() {
    if (this.selectedItems.size === 0) {
      alert('No items selected for deletion');
      return;
    }
    
    const selectedItemsArray = Array.from(this.selectedItems);
    const itemNames = selectedItemsArray.map(itemId => this.fileTree[itemId]?.name).filter(Boolean);
    
    if (confirm(`Delete ${this.selectedItems.size} selected item(s)?\n\nItems: ${itemNames.join(', ')}`)) {
      console.log('Deleting items:', selectedItemsArray);
      // TODO: Implement delete API call
      alert('Delete functionality will be implemented in a future update');
    }
  }
  
  handleKeyboardShortcut(e) {
    // Prevent shortcuts when typing in input fields
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
      return;
    }
    
    // F2 - Rename selected item
    if (e.key === 'F2') {
      e.preventDefault();
      if (this.focusedItem) {
        this.renameItem(this.focusedItem);
      } else if (this.selectedItems.size === 1) {
        const itemId = Array.from(this.selectedItems)[0];
        this.renameItem(itemId);
      } else {
        alert('Please select a single item to rename');
      }
    }
    
    // Delete - Delete selected items
    else if (e.key === 'Delete') {
      e.preventDefault();
      this.deleteSelectedItems();
    }
    
    // Ctrl+Shift+N - Create new project
    else if (e.ctrlKey && e.shiftKey && e.key === 'N') {
      e.preventDefault();
      this.createNewProject();
    }
    
    // F5 - Refresh file tree
    else if (e.key === 'F5') {
      e.preventDefault();
      this.refresh();
    }
    
    // Ctrl+E - Open Writer for selected project
    else if (e.ctrlKey && e.key === 'e') {
      e.preventDefault();
      this.openWriter();
    }
    
    // Escape - Clear selection
    else if (e.key === 'Escape') {
      e.preventDefault();
      this.selectedItems.clear();
      this.focusedItem = null;
      this.renderTree();
    }
    
    // Arrow keys for navigation
    else if (e.key === 'ArrowDown') {
      e.preventDefault();
      this.navigateDown();
    }
    else if (e.key === 'ArrowUp') {
      e.preventDefault();
      this.navigateUp();
    }
    else if (e.key === 'ArrowRight') {
      e.preventDefault();
      this.navigateRight();
    }
    else if (e.key === 'ArrowLeft') {
      e.preventDefault();
      this.navigateLeft();
    }
    
    // Enter - Open/expand focused item
    else if (e.key === 'Enter') {
      e.preventDefault();
      if (this.focusedItem) {
        this.activateItem(this.focusedItem);
      }
    }
    
    // Tab - Focus file tree container
    else if (e.key === 'Tab' && !e.shiftKey) {
      if (document.activeElement !== document.getElementById('fileTreeContainer')) {
        e.preventDefault();
        this.focusFileTree();
      }
    }
    
    // H or F1 - Show keyboard shortcuts help
    else if (e.key === 'h' || e.key === 'H' || e.key === 'F1') {
      e.preventDefault();
      this.showKeyboardShortcuts();
    }
  }
  
  // Keyboard navigation methods
  updateKeyboardFocus() {
    if (this.focusedItem && this.flatItemList.length > 0) {
      this.currentFocusIndex = this.flatItemList.findIndex(item => item.id === this.focusedItem);
    } else if (this.flatItemList.length > 0 && this.currentFocusIndex === -1) {
      this.currentFocusIndex = 0;
      this.focusedItem = this.flatItemList[0].id;
    }
  }
  
  navigateDown() {
    if (this.flatItemList.length === 0) return;
    
    this.currentFocusIndex = Math.min(this.currentFocusIndex + 1, this.flatItemList.length - 1);
    this.focusedItem = this.flatItemList[this.currentFocusIndex].id;
    this.renderTree();
    this.scrollToFocusedItem();
  }
  
  navigateUp() {
    if (this.flatItemList.length === 0) return;
    
    this.currentFocusIndex = Math.max(this.currentFocusIndex - 1, 0);
    this.focusedItem = this.flatItemList[this.currentFocusIndex].id;
    this.renderTree();
    this.scrollToFocusedItem();
  }
  
  navigateRight() {
    if (!this.focusedItem) return;
    
    const item = this.fileTree[this.focusedItem];
    if (item && item.type === 'folder') {
      if (!this.expandedItems.has(this.focusedItem)) {
        // Expand folder
        this.expandedItems.add(this.focusedItem);
        this.renderTree();
      } else if (item.children && item.children.length > 0) {
        // Move to first child
        this.navigateDown();
      }
    }
  }
  
  navigateLeft() {
    if (!this.focusedItem) return;
    
    const item = this.fileTree[this.focusedItem];
    if (item && item.type === 'folder' && this.expandedItems.has(this.focusedItem)) {
      // Collapse folder
      this.expandedItems.delete(this.focusedItem);
      this.renderTree();
    } else {
      // Move to parent
      const currentIndex = this.flatItemList.findIndex(item => item.id === this.focusedItem);
      if (currentIndex > 0) {
        const currentDepth = this.flatItemList[currentIndex].depth;
        for (let i = currentIndex - 1; i >= 0; i--) {
          if (this.flatItemList[i].depth < currentDepth) {
            this.currentFocusIndex = i;
            this.focusedItem = this.flatItemList[i].id;
            this.renderTree();
            this.scrollToFocusedItem();
            break;
          }
        }
      }
    }
  }
  
  activateItem(itemId) {
    const item = this.fileTree[itemId];
    if (!item) return;
    
    if (item.type === 'folder') {
      this.toggleExpand(itemId);
    } else {
      // Load file content and select the item
      this.selectedItems.clear();
      this.selectedItems.add(itemId);
      this.loadFileContent(itemId);
      this.renderTree();
    }
  }
  
  scrollToFocusedItem() {
    if (!this.focusedItem) return;
    
    const focusedElement = document.querySelector(`[data-item-id="${this.focusedItem}"]`);
    if (focusedElement) {
      focusedElement.scrollIntoView({
        behavior: 'smooth',
        block: 'nearest'
      });
    }
  }
  
  focusFileTree() {
    const container = document.getElementById('fileTreeContainer');
    container.focus();
    
    // If no item is focused, focus the first item
    if (!this.focusedItem && this.flatItemList.length > 0) {
      this.currentFocusIndex = 0;
      this.focusedItem = this.flatItemList[0].id;
      this.renderTree();
    }
  }
  
  openWriter() {
    // Get selected project
    let projectId = null;
    let projectName = null;
    
    // Check if focused item is a project
    if (this.focusedItem && this.fileTree[this.focusedItem]) {
      const item = this.fileTree[this.focusedItem];
      if (item.type === 'project' && item.project_id) {
        projectId = item.project_id;
        projectName = item.name;
      }
    }
    
    // Check selected items for a project
    if (!projectId) {
      for (const itemId of this.selectedItems) {
        const item = this.fileTree[itemId];
        if (item && item.type === 'project' && item.project_id) {
          projectId = item.project_id;
          projectName = item.name;
          break;
        }
      }
    }
    
    if (projectId) {
      // Open SciTeX Writer for the selected project
      const writerUrl = `/writer/project/${projectId}/`;
      console.log(`Opening SciTeX Writer for project: ${projectName} (ID: ${projectId})`);
      window.open(writerUrl, '_blank');
    } else {
      alert('Please select a project to open in SciTeX Writer');
    }
  }
}

// Initialize the file manager when the DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
  window.fileManager = new SciTeXFileManager();
});
</script>
{% endblock %}