{% extends "writer_app/base_writer.html" %}
{% load static %}

{% block title %}SciTeX Writer - Collaborative Editor{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/components/hero.css' %}">
<link rel="stylesheet" href="{% static 'writer_app/css/collaborative-editor.css' %}">
{% endblock %}

{% block content %}
<!-- Hidden data attributes for JavaScript -->
<div class="hidden-data">
    <span data-manuscript-id="{{ manuscript.id }}" id="manuscript-data"></span>
    <span data-user-id="{{ user.id }}" id="user-data"></span>
    <span data-username="{{ user.username }}" id="username-data"></span>
</div>

<div class="writer-container">
    <!-- Header with collaboration status -->
    <div class="writer-header hero-gradient-silverish">
        <div class="container">
            <button class="collaboration-toggle" id="collaboration-toggle">
                <i class="fas fa-users"></i> Enable Collaboration
            </button>
            <h1 class="manuscript-title">{{ manuscript.title }}</h1>
            <div class="manuscript-meta">
                <span>Last modified: {{ manuscript.updated_at|date:"M d, Y H:i" }}</span>
                <div class="collab-status hidden" id="collab-status">
                    <div class="collab-indicator"></div>
                    <span>Live collaboration active</span>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Action bar -->
        <div class="action-bar">
            <div class="row">
                <div class="col-md-12">
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="autoSave()">
                            <i class="fas fa-save"></i> Save Draft
                        </button>
                        <button class="btn btn-secondary" onclick="exportJSON()">
                            <i class="fas fa-download"></i> Export
                        </button>
                        <button class="btn btn-secondary" onclick="showLatexView()">
                            <i class="fas fa-code"></i> LaTeX View
                        </button>
                        <button class="btn btn-secondary" onclick="compileManuscript()">
                            <i class="fas fa-file-pdf"></i> Compile PDF
                        </button>
                        <button class="btn btn-secondary" onclick="openVersionControl()">
                            <i class="fas fa-code-branch"></i> Version Control
                        </button>
                        <button class="btn btn-secondary" onclick="createVersion()">
                            <i class="fas fa-tag"></i> Save Version
                        </button>

                        <div class="collaboration-info hidden" id="collaboration-info">
                            <span id="active-users-count">0 users online</span>
                            <span id="last-save-time">Auto-saved just now</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Progress Overview -->
        <div class="progress-overview">
            <h3><i class="fas fa-chart-line"></i> Writing Progress</h3>
            <div class="progress-grid">
                <div class="progress-item">
                    <div class="progress-number" id="total-words">0</div>
                    <div class="progress-label">Total Words</div>
                </div>
                <div class="progress-item">
                    <div class="progress-number" id="sections-completed">0/6</div>
                    <div class="progress-label">Sections</div>
                </div>
                <div class="progress-item">
                    <div class="progress-number" id="citations-count">0</div>
                    <div class="progress-label">Citations</div>
                </div>
                <div class="progress-item">
                    <div class="progress-number" id="completion-percentage">0%</div>
                    <div class="progress-label">Complete</div>
                </div>
            </div>
        </div>

        <!-- Abstract Section -->
        <div class="manuscript-section collaborative-section" data-section="abstract">
            <div class="section-header-collaborative">
                <div>
                    <h3 class="section-title">
                        <i class="fas fa-file-alt"></i> Abstract
                    </h3>
                </div>
                <div class="section-collaboration-info">
                    <div class="section-stats">
                        <span class="word-count" id="abstract-count">0 words</span>
                    </div>
                    <div class="collaboration-badges" id="abstract-badges"></div>
                </div>
            </div>
            <div class="collaborative-section">
                <textarea 
                    class="text-editor" 
                    id="section-abstract"
                    placeholder="Write your abstract here... (150-300 words recommended)"
                    rows="8"
                >{{ manuscript.abstract }}</textarea>
                <div class="section-help">
                    <strong>Abstract Guidelines:</strong> Summarize your research question, methods, key findings, and conclusions. Keep it concise and focused.
                </div>
                <div class="collaborative-help hidden">
                    <i class="fas fa-users"></i> <strong>Collaborative Mode:</strong> This section is being edited in real-time. You can see other users' cursors and changes as they type.
                </div>
            </div>
        </div>

        <!-- Introduction Section -->
        <div class="manuscript-section collaborative-section" data-section="introduction">
            <div class="section-header-collaborative">
                <div>
                    <h3 class="section-title">
                        <i class="fas fa-lightbulb"></i> Introduction
                    </h3>
                </div>
                <div class="section-collaboration-info">
                    <div class="section-stats">
                        <span class="word-count" id="introduction-count">0 words</span>
                    </div>
                    <div class="collaboration-badges" id="introduction-badges"></div>
                </div>
            </div>
            <div class="collaborative-section">
                <textarea 
                    class="text-editor" 
                    id="section-introduction"
                    placeholder="Introduce your research topic, provide background, and state your research questions..."
                    rows="12"
                ></textarea>
                <div class="section-help">
                    <strong>Introduction Structure:</strong> Start with broad context, narrow to your specific topic, review relevant literature, identify gaps, and present your research questions/hypotheses.
                </div>
            </div>
        </div>

        <!-- Methods Section -->
        <div class="manuscript-section collaborative-section" data-section="methods">
            <div class="section-header-collaborative">
                <div>
                    <h3 class="section-title">
                        <i class="fas fa-cogs"></i> Methods
                    </h3>
                </div>
                <div class="section-collaboration-info">
                    <div class="section-stats">
                        <span class="word-count" id="methods-count">0 words</span>
                    </div>
                    <div class="collaboration-badges" id="methods-badges"></div>
                </div>
            </div>
            <div class="collaborative-section">
                <textarea 
                    class="text-editor" 
                    id="section-methods"
                    placeholder="Describe your research methodology, data collection, and analysis procedures..."
                    rows="12"
                ></textarea>
                <div class="section-help">
                    <strong>Methods Content:</strong> Include study design, participants/materials, procedures, data collection methods, and statistical analysis plans. Provide sufficient detail for replication.
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="manuscript-section collaborative-section" data-section="results">
            <div class="section-header-collaborative">
                <div>
                    <h3 class="section-title">
                        <i class="fas fa-chart-bar"></i> Results
                    </h3>
                </div>
                <div class="section-collaboration-info">
                    <div class="section-stats">
                        <span class="word-count" id="results-count">0 words</span>
                    </div>
                    <div class="collaboration-badges" id="results-badges"></div>
                </div>
            </div>
            <div class="collaborative-section">
                <textarea 
                    class="text-editor" 
                    id="section-results"
                    placeholder="Present your findings objectively, with supporting data and statistics..."
                    rows="12"
                ></textarea>
                <div class="section-help">
                    <strong>Results Presentation:</strong> Report findings without interpretation. Use tables, figures, and statistics to support your text. Present results in logical order.
                </div>
            </div>
        </div>

        <!-- Discussion Section -->
        <div class="manuscript-section collaborative-section" data-section="discussion">
            <div class="section-header-collaborative">
                <div>
                    <h3 class="section-title">
                        <i class="fas fa-comments"></i> Discussion
                    </h3>
                </div>
                <div class="section-collaboration-info">
                    <div class="section-stats">
                        <span class="word-count" id="discussion-count">0 words</span>
                    </div>
                    <div class="collaboration-badges" id="discussion-badges"></div>
                </div>
            </div>
            <div class="collaborative-section">
                <textarea 
                    class="text-editor" 
                    id="section-discussion"
                    placeholder="Interpret your results, discuss implications, and acknowledge limitations..."
                    rows="12"
                ></textarea>
                <div class="section-help">
                    <strong>Discussion Elements:</strong> Interpret results, compare with previous research, discuss implications, acknowledge limitations, and suggest future research directions.
                </div>
            </div>
        </div>

        <!-- Conclusion Section -->
        <div class="manuscript-section collaborative-section" data-section="conclusion">
            <div class="section-header-collaborative">
                <div>
                    <h3 class="section-title">
                        <i class="fas fa-flag-checkered"></i> Conclusion
                    </h3>
                </div>
                <div class="section-collaboration-info">
                    <div class="section-stats">
                        <span class="word-count" id="conclusion-count">0 words</span>
                    </div>
                    <div class="collaboration-badges" id="conclusion-badges"></div>
                </div>
            </div>
            <div class="collaborative-section">
                <textarea 
                    class="text-editor" 
                    id="section-conclusion"
                    placeholder="Summarize key findings and their broader significance..."
                    rows="8"
                ></textarea>
                <div class="section-help">
                    <strong>Conclusion Focus:</strong> Briefly summarize key findings, highlight main contributions, and discuss broader significance without repeating the abstract.
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'writer_app/js/collaborative-editor.js' %}"></script>
<script>
// Enhanced modular editor with collaboration features
let isCollaborationEnabled = false;
let currentManuscript = {
    id: {{ manuscript.id }},
    sections: ['abstract', 'introduction', 'methods', 'results', 'discussion', 'conclusion']
};

// Initialize editor
document.addEventListener('DOMContentLoaded', function() {
    initializeEditor();
    setupCollaborationToggle();
    setupAutoSave();
    updateWordCounts();
});

function initializeEditor() {
    // Setup word count tracking for all sections
    currentManuscript.sections.forEach(section => {
        const textarea = document.getElementById(`section-${section}`);
        if (textarea) {
            textarea.addEventListener('input', function() {
                updateWordCount(section);
                updateProgress();
                markAsModified();
            });
        }
    });
    
    // Initial word count update
    setTimeout(updateWordCounts, 100);
}

function setupCollaborationToggle() {
    const toggle = document.getElementById('collaboration-toggle');
    const status = document.getElementById('collab-status');
    const info = document.getElementById('collaboration-info');
    
    toggle.addEventListener('click', function() {
        if (!isCollaborationEnabled) {
            enableCollaboration();
        } else {
            disableCollaboration();
        }
    });
}

function enableCollaboration() {
    isCollaborationEnabled = true;
    const toggle = document.getElementById('collaboration-toggle');
    const status = document.getElementById('collab-status');
    const info = document.getElementById('collaboration-info');

    toggle.classList.add('active');
    toggle.innerHTML = '<i class="fas fa-users"></i> Collaboration Active';
    status.classList.remove('hidden');
    info.classList.remove('hidden');

    // Show collaborative help sections
    document.querySelectorAll('.collaborative-help').forEach(help => {
        help.classList.remove('hidden');
    });

    // Add collaborative styling to editors
    document.querySelectorAll('.text-editor').forEach(editor => {
        editor.classList.add('collaborative-editing');
    });

    // Initialize WebSocket collaboration if available
    if (window.collaborativeEditor) {
        console.log('Collaborative editing enabled');
    }
}

function disableCollaboration() {
    isCollaborationEnabled = false;
    const toggle = document.getElementById('collaboration-toggle');
    const status = document.getElementById('collab-status');
    const info = document.getElementById('collaboration-info');

    toggle.classList.remove('active');
    toggle.innerHTML = '<i class="fas fa-users"></i> Enable Collaboration';
    status.classList.add('hidden');
    info.classList.add('hidden');

    // Hide collaborative help sections
    document.querySelectorAll('.collaborative-help').forEach(help => {
        help.classList.add('hidden');
    });

    // Remove collaborative styling from editors
    document.querySelectorAll('.text-editor').forEach(editor => {
        editor.classList.remove('collaborative-editing');
    });

    // Disconnect WebSocket collaboration if available
    if (window.collaborativeEditor) {
        window.collaborativeEditor.destroy();
        console.log('Collaborative editing disabled');
    }
}

function updateWordCount(section) {
    const textarea = document.getElementById(`section-${section}`);
    const countElement = document.getElementById(`${section}-count`);
    
    if (textarea && countElement) {
        const wordCount = textarea.value.trim().split(/\s+/).filter(word => word.length > 0).length;
        countElement.textContent = `${wordCount} words`;
        
        // Update section badge
        updateSectionBadge(section, wordCount);
    }
}

function updateSectionBadge(section, wordCount) {
    const badgesContainer = document.getElementById(`${section}-badges`);
    if (!badgesContainer) return;
    
    // Clear existing badges
    badgesContainer.innerHTML = '';
    
    // Add word count badge
    if (wordCount > 0) {
        const badge = document.createElement('span');
        badge.className = 'collaboration-badge active';
        badge.innerHTML = `<i class="fas fa-edit"></i> ${wordCount} words`;
        badgesContainer.appendChild(badge);
    }
    
    // Add collaboration badges if enabled
    if (isCollaborationEnabled) {
        const collabBadge = document.createElement('span');
        collabBadge.className = 'collaboration-badge editing';
        collabBadge.innerHTML = `<i class="fas fa-users"></i> Live`;
        badgesContainer.appendChild(collabBadge);
    }
}

function updateWordCounts() {
    currentManuscript.sections.forEach(section => {
        updateWordCount(section);
    });
    updateProgress();
}

function updateProgress() {
    let totalWords = 0;
    let sectionsCompleted = 0;
    
    currentManuscript.sections.forEach(section => {
        const textarea = document.getElementById(`section-${section}`);
        if (textarea) {
            const wordCount = textarea.value.trim().split(/\s+/).filter(word => word.length > 0).length;
            totalWords += wordCount;
            if (wordCount > 0) sectionsCompleted++;
        }
    });
    
    const completionPercentage = Math.round((sectionsCompleted / currentManuscript.sections.length) * 100);
    
    // Update progress display
    document.getElementById('total-words').textContent = totalWords;
    document.getElementById('sections-completed').textContent = `${sectionsCompleted}/${currentManuscript.sections.length}`;
    document.getElementById('completion-percentage').textContent = `${completionPercentage}%`;
}

function autoSave() {
    const data = {};
    currentManuscript.sections.forEach(section => {
        const textarea = document.getElementById(`section-${section}`);
        if (textarea) {
            data[section] = textarea.value;
        }
    });
    
    // Save to localStorage
    localStorage.setItem(`manuscript_${currentManuscript.id}`, JSON.stringify(data));
    
    // Update save time
    const saveTime = document.getElementById('last-save-time');
    if (saveTime) {
        saveTime.textContent = 'Auto-saved just now';
    }
    
    console.log('Manuscript auto-saved');
}

function setupAutoSave() {
    // Auto-save every 30 seconds
    setInterval(autoSave, 30000);
    
    // Save on page unload
    window.addEventListener('beforeunload', autoSave);
}

function exportJSON() {
    const data = {
        manuscript_id: currentManuscript.id,
        sections: {},
        exported_at: new Date().toISOString()
    };
    
    currentManuscript.sections.forEach(section => {
        const textarea = document.getElementById(`section-${section}`);
        if (textarea) {
            data.sections[section] = textarea.value;
        }
    });
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `manuscript_${currentManuscript.id}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

function showLatexView() {
    alert('LaTeX view coming soon! This will show the generated LaTeX code for your manuscript.');
}

function compileManuscript() {
    alert('PDF compilation coming soon! This will generate a PDF from your manuscript.');
}

function openVersionControl() {
    window.location.href = `/writer/version-control/${currentManuscript.id}/`;
}

function createVersion() {
    const commitMessage = prompt('Enter a commit message for this version:');
    if (!commitMessage) return;
    
    const versionTag = prompt('Enter an optional version tag (e.g., "Draft 1", "Final Version"):') || '';
    
    // First auto-save current content
    autoSave();
    
    const formData = {
        commit_message: commitMessage,
        version_tag: versionTag,
        branch_name: 'main',
        is_major: false
    };
    
    fetch(`/writer/api/version/${currentManuscript.id}/create/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Version created successfully: v${data.version.version_number}`);
            updateLastSaveTime('Version saved');
        } else {
            alert('Error creating version: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error creating version');
    });
}

function updateLastSaveTime(message) {
    const saveTime = document.getElementById('last-save-time');
    if (saveTime) {
        saveTime.textContent = message || 'Auto-saved just now';
    }
}

// Utility function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function markAsModified() {
    // Visual indication that document has unsaved changes
    document.title = '● ' + document.title.replace('● ', '');
}

// Load saved content on page load
window.addEventListener('load', function() {
    const saved = localStorage.getItem(`manuscript_${currentManuscript.id}`);
    if (saved) {
        try {
            const data = JSON.parse(saved);
            currentManuscript.sections.forEach(section => {
                const textarea = document.getElementById(`section-${section}`);
                if (textarea && data[section]) {
                    textarea.value = data[section];
                }
            });
            updateWordCounts();
        } catch (e) {
            console.error('Error loading saved content:', e);
        }
    }
});
</script>
{% endblock %}
