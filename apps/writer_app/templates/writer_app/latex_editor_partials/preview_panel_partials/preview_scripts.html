<script>
  document.addEventListener('DOMContentLoaded', function() {
  // Initialize CodeMirror
  const editor = CodeMirror.fromTextArea(document.getElementById('latex-editor'), {
  mode: 'stex',
  theme: 'github',
  lineNumbers: true,
  autoCloseBrackets: true,
  matchBrackets: true,
  lineWrapping: true,
  indentUnit: 2
  });

  // Elements
  const compileBtn = document.getElementById('compile-btn');
  const saveBtn = document.getElementById('save-btn');
  const statusIndicator = document.getElementById('status-indicator');
  const compileStatus = document.getElementById('compile-status');
  const previewContent = document.getElementById('preview-content');
  const previewPanel = document.getElementById('preview-panel');
  const togglePreviewBtn = document.getElementById('toggle-preview');
  const templateSelect = document.getElementById('template-select');
  const documentTitle = document.getElementById('document-title');
  
  let currentJobId = null;
  let statusCheckInterval = null;
  let previewVisible = true;

  // Template content
  const templates = {
  article: `\\documentclass[12pt]{article}
  \\usepackage[utf8]{inputenc}
  \\usepackage{amsmath}
  \\usepackage{graphicx}
  \\usepackage[margin=1in]{geometry}
  \\usepackage{cite}

  \\title{Your Article Title}
  \\author{Your Name\\\\Your Institution}
  \\date{\\today}

  \\begin{document}

  \\maketitle

  \\begin{abstract}
  Write your abstract here...
  \\end{abstract}

  \\section{Introduction}
  Introduction content...

  \\section{Related Work}
  Related work...

  \\section{Methodology}
  Methodology...

  \\section{Results}
  Results...

  \\section{Conclusion}
  Conclusion...

  \\bibliographystyle{plain}
  \\bibliography{references}

  \\end{document}`,
  
  conference: `\\documentclass[conference]{IEEEtran}
  \\usepackage{amsmath}
  \\usepackage{graphicx}
  \\usepackage{cite}

  \\title{Your Conference Paper Title}
  \\author{\\IEEEauthorblockN{Your Name}
  \\IEEEauthorblockA{Your Institution\\\\
  Email: your.email@institution.edu}}

  \\begin{document}

  \\maketitle

  \\begin{abstract}
  Conference paper abstract...
  \\end{abstract}

  \\section{Introduction}
  Introduction...

  \\section{Related Work}
  Related work...

  \\section{Approach}
  Your approach...

  \\section{Evaluation}
  Evaluation...

  \\section{Conclusion}
  Conclusion...

  \\bibliographystyle{IEEEtran}
  \\bibliography{references}

  \\end{document}`,
  
  thesis: `\\documentclass[12pt]{report}
  \\usepackage[utf8]{inputenc}
  \\usepackage{amsmath}
  \\usepackage{graphicx}
  \\usepackage[margin=1in]{geometry}

  \\title{Chapter Title}
  \\author{Your Name}
  \\date{\\today}

  \\begin{document}

  \\chapter{Chapter Title}

  \\section{Introduction}
  Chapter introduction...

  \\section{Background}
  Background information...

  \\section{Main Content}
  Main content...

  \\section{Summary}
  Chapter summary...

  \\end{document}`,
  
  letter: `\\documentclass{letter}
  \\usepackage[utf8]{inputenc}

  \\signature{Your Name}
  \\address{Your Address\\\\City, State ZIP}

  \\begin{document}

  \\begin{letter}{Recipient Name\\\\Recipient Address\\\\City, State ZIP}

  \\opening{Dear Sir/Madam,}

  Your letter content here...

  \\closing{Sincerely,}

  \\end{letter}

  \\end{document}`
  };

  // Template selection
  templateSelect.addEventListener('change', function() {
  const template = this.value;
  if (template && templates[template]) {
  if (confirm('This will replace your current content. Continue?')) {
  editor.setValue(templates[template]);
  documentTitle.value = template.charAt(0).toUpperCase() + template.slice(1) + ' Document';
  } else {
  this.value = '';
  }
  }
  });

  // Toggle preview panel
  togglePreviewBtn.addEventListener('click', function() {
  previewVisible = !previewVisible;
  previewPanel.style.display = previewVisible ? 'flex' : 'none';
  this.innerHTML = previewVisible ? 
  '<i class="fas fa-eye-slash me-1"></i>Hide Preview' : 
  '<i class="fas fa-eye me-1"></i>Show Preview';
  });

  // Save draft
  saveBtn.addEventListener('click', function() {
  // Auto-save functionality
  updateStatus('Saving...', 'text-warning');
  setTimeout(() => {
  updateStatus('Saved', 'text-success');
  setTimeout(() => updateStatus('Ready', 'text-success'), 2000);
  }, 500);
  });

  // Compile document
  compileBtn.addEventListener('click', function() {
  const content = editor.getValue().trim();
  const title = documentTitle.value.trim() || 'Quick Document';
  
  if (!content) {
  alert('Please enter some LaTeX content to compile.');
  return;
  }

  // Update UI
  compileBtn.disabled = true;
  compileBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Compiling...';
  updateStatus('Compiling...', 'text-warning');
  updateCompileStatus('Compilation started...', 'running');

  // Send compile request
  fetch('{% url "writer:quick-compile" %}', {
  method: 'POST',
  headers: {
  'Content-Type': 'application/json',
  'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
  },
  body: JSON.stringify({
  content: content,
  title: title
  })
  })
  .then(response => response.json())
  .then(data => {
  if (data.success) {
  currentJobId = data.job_id;
  startStatusChecking();
  } else {
  handleError(data.error || 'Compilation failed');
  }
  })
  .catch(error => {
  handleError('Network error: ' + error.message);
  });
  });

  // Status checking
  function startStatusChecking() {
  if (statusCheckInterval) {
  clearInterval(statusCheckInterval);
  }

  statusCheckInterval = setInterval(function() {
  if (!currentJobId) return;

  fetch(`{% url "writer:compilation-status" job_id="__JOB_ID__" %}`.replace('__JOB_ID__', currentJobId))
  .then(response => response.json())
  .then(data => {
  updateJobStatus(data);
  
  if (data.status === 'completed' || data.status === 'failed') {
  clearInterval(statusCheckInterval);
  resetCompileUI();
  
  if (data.status === 'completed' && data.pdf_url) {
  showPDFPreview(data.pdf_url);
  updateCompileStatus('✓ Compilation successful!', 'success');
  updateStatus('Compiled', 'text-success');
  }
  }
  })
  .catch(error => {
  console.error('Status check error:', error);
  });
  }, 1000);
  }

  function updateJobStatus(data) {
  const message = `${data.status} (${data.progress}%)`;
  updateCompileStatus(message, data.status);
  }

  function showPDFPreview(pdfUrl) {
  previewContent.innerHTML = `
  <iframe src="${pdfUrl}" width="100%" height="100%" class="iframe-borderless"></iframe>
  `;
  }

  function resetCompileUI() {
  compileBtn.disabled = false;
  compileBtn.innerHTML = '<i class="fas fa-play me-2"></i>Compile PDF';
  currentJobId = null;
  }

  function handleError(message) {
  updateStatus('Error', 'text-danger');
  updateCompileStatus('✗ ' + message, 'error');
  resetCompileUI();
  }

  function updateStatus(text, className) {
  statusIndicator.innerHTML = `<i class="fas fa-circle ${className} me-1"></i>${text}`;
  }

  function updateCompileStatus(text, type) {
  compileStatus.textContent = text;
  compileStatus.className = `compile-status ${type}`;
  }

  // Auto-save on content change
  let saveTimeout;
  editor.on('change', function() {
  clearTimeout(saveTimeout);
  updateStatus('Unsaved changes', 'text-warning');
  saveTimeout = setTimeout(() => {
  updateStatus('Ready', 'text-success');
  }, 3000);
  });
  });
</script>

