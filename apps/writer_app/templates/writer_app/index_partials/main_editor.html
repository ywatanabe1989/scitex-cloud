<!-- Main Editor -->
<div class="writer-main" id="editor-main">
  <!-- Sticky Toolbar -->
  <div class="writer-toolbar-sticky">
    <div class="toolbar-left">
      <!-- Document Type & Section Selectors (Project selected from global header) -->
      <div class="horizontal-selector-group">
        <div class="horizontal-selector">
          <label for="doctype-selector" class="selector-label"><i class="fas fa-file-alt me-1"></i></label>
          <select id="doctype-selector" class="form-select form-select-sm">
            <option value="shared">Shared</option>
            <option value="manuscript" selected>Manuscript</option>
            <option value="supplementary">Supplementary</option>
            <option value="revision">Revision</option>
          </select>
        </div>
        <div class="horizontal-selector">
          <label for="texfile-selector" class="selector-label"><i class="fas fa-file-code me-1"></i></label>
          <select id="texfile-selector" class="form-select form-select-sm">
          </select>
        </div>
      </div>
    </div>

    <div class="toolbar-center">
      <!-- Editor Tools: Undo/Redo -->
      <button id="undo-btn" class="btn btn-sm btn-outline-secondary" title="Undo (Ctrl+Z)">
        <i class="fas fa-undo"></i>
      </button>
      <button id="redo-btn" class="btn btn-sm btn-outline-secondary" title="Redo (Ctrl+Y)">
        <i class="fas fa-redo"></i>
      </button>
    </div>

    <div class="toolbar-right">
      <!-- Compile Button -->
      <button id="compile-btn-toolbar" class="btn btn-sm btn-primary" title="Compile Manuscript PDF">
        <i class="fas fa-file-pdf me-1"></i><span id="compile-btn-text">Compile Manuscript PDF</span>
      </button>

      <!-- Download PDF Button -->
      <a id="download-pdf-toolbar" href="#" download class="btn btn-sm btn-outline-secondary" title="Download PDF" style="display: none;">
        <i class="fas fa-download"></i>
      </a>
    </div>
  </div>

  <div class="writer-editor">
    <!-- Split View Only -->
    <div class="editor-content-wrapper">
      <!-- Split View -->
      <div id="editor-view-split" class="editor-view split-view active">
        <div class="latex-panel">
          <div class="panel-header">
            <div class="header-left">
              <span><i class="fas fa-code me-1"></i><span id="editor-section-title">LaTeX Source</span></span>
              <!-- Word count indicator -->
              <div class="word-count-inline">
                <i class="fas fa-pencil-alt"></i>
                <span id="current-word-count">0</span>
              </div>
              <!-- Save Status Indicator -->
              <div id="save-status" class="save-status-inline">
                <i class="fas fa-check-circle text-success"></i>
                <span class="status-text">Saved</span>
              </div>
              <!-- Git Commit Button -->
              <button id="git-commit-btn" class="btn btn-sm btn-outline-primary"
                      title="Create git commit for current changes"
                      style="font-size: 0.75rem; padding: 0.25rem 0.5rem;">
                <i class="fas fa-code-branch me-1"></i>Commit
              </button>
              <!-- Keyboard Shortcuts Button -->
              <button id="shortcuts-btn" class="btn btn-sm btn-outline-secondary"
                      title="View keyboard shortcuts"
                      data-bs-toggle="modal"
                      data-bs-target="#shortcuts-modal"
                      style="font-size: 0.75rem; padding: 0.25rem 0.5rem;">
                <i class="fas fa-keyboard"></i>
              </button>
            </div>
            <div class="header-right">
              <!-- Font Size Selector -->
              <label for="font-size-selector" class="form-label" style="font-size: 0.75rem; margin: 0; display: flex; align-items: center; gap: 0.25rem;">
                <i class="fas fa-text-height"></i>
                <span class="visually-hidden">Font Size</span>
              </label>
              <select id="font-size-selector" class="form-select form-select-sm" style="min-width: 70px; font-size: 0.75rem;" aria-label="Font Size">
                <option value="10">10px</option>
                <option value="11">11px</option>
                <option value="12">12px</option>
                <option value="13">13px</option>
                <option value="14" selected>14px</option>
                <option value="15">15px</option>
                <option value="16">16px</option>
                <option value="17">17px</option>
                <option value="18">18px</option>
                <option value="19">19px</option>
                <option value="20">20px</option>
              </select>
              <!-- Keybinding Selector - Hidden (not working with Monaco) -->
              <label for="keybinding-selector" class="form-label" style="font-size: 0.75rem; margin: 0; display: none; align-items: center; gap: 0.25rem;">
                <i class="fas fa-keyboard"></i>
                <span class="visually-hidden">Keybinding</span>
              </label>
              <select id="keybinding-selector" class="form-select form-select-sm" style="width: auto; font-size: 0.75rem; display: none;" aria-label="Keybinding">
                <option value="default">Keymap: Default</option>
              </select>
              <!-- Theme Selector - Hidden, using vs-dark -->
              <label for="theme-selector" class="form-label" style="font-size: 0.75rem; margin: 0; display: none; align-items: center; gap: 0.25rem;">
                <i class="fas fa-palette"></i>
                <span class="visually-hidden">Theme</span>
              </label>
              <select id="theme-selector" class="form-select form-select-sm" style="width: auto; font-size: 0.75rem; display: none;" aria-label="Theme">
                <option value="vs-dark" selected>Dark</option>
              </select>
            </div>
          </div>
          <textarea id="latex-editor-textarea" class="latex-editor-textarea" placeholder="LaTeX code..."></textarea>
        </div>
        <!-- Resizable Panel Divider -->
        <div class="panel-resizer" id="panel-resizer" title="Drag to resize panels"></div>
        <div class="preview-panel">
          <div class="panel-header" id="preview-panel-header">
            <div class="header-left">
              <i class="fas fa-eye me-1"></i><span id="preview-title">Manuscript Abstract PDF</span>
            </div>
            <div class="header-right">
              <!-- Zoom Controls (PDF only) -->
              <div class="pdf-zoom-controls" style="display: none; gap: 0.25rem; align-items: center;">
                <button id="pdf-zoom-out-btn" class="btn btn-sm btn-outline-secondary" title="Zoom Out (Ctrl+-)">
                  <i class="fas fa-minus"></i>
                </button>
                <span id="pdf-zoom-indicator" style="font-size: 0.75rem; min-width: 35px; text-align: center;">100%</span>
                <button id="pdf-zoom-in-btn" class="btn btn-sm btn-outline-secondary" title="Zoom In (Ctrl++)">
                  <i class="fas fa-plus"></i>
                </button>
                <div style="width: 1px; height: 20px; background: var(--color-border-default); margin: 0 0.25rem;"></div>
                <button id="pdf-fit-width-btn" class="btn btn-sm btn-outline-secondary" title="Fit to Width">
                  <i class="fas fa-arrows-alt-h"></i>
                </button>
                <button id="pdf-reset-zoom-btn" class="btn btn-sm btn-outline-secondary" title="Reset Zoom (Ctrl+0)">
                  <i class="fas fa-search"></i>
                </button>
                <div style="width: 1px; height: 20px; background: var(--color-border-default); margin: 0 0.25rem;"></div>
                <button id="pdf-color-mode-btn" class="btn btn-sm btn-outline-secondary" title="PDF Theme: Light (Click to cycle)">
                  <i class="fas fa-sun"></i>
                  <span class="theme-label" style="margin-left: 0.25rem; font-size: 0.7rem;">Light</span>
                </button>
              </div>

              <!-- Auto Preview Checkbox -->
              <div class="auto-preview-control-panel">
                <input type="checkbox" id="auto-preview-checkbox-panel" class="form-check-input" checked>
                <label for="auto-preview-checkbox-panel" class="form-check-label" style="margin: 0; font-size: 0.7rem; cursor: pointer;">
                  <i class="fas fa-magic me-1"></i>Auto (5s)
                </label>
              </div>
              <!-- Preview/Reload Button -->
              <button id="preview-btn-panel" class="preview-btn-inline" title="Refresh PDF Preview">
                <i class="fas fa-sync-alt"></i>
              </button>
              <!-- Background compilation status indicator -->
              <div id="background-compile-status" class="status-indicator" style="opacity: 0; transition: opacity 0.3s;"></div>
              <!-- Countdown indicator -->
              <div id="compile-countdown-indicator" class="countdown-indicator" style="opacity: 0; transition: opacity 0.3s;"></div>
            </div>
          </div>
          <div id="text-preview" class="text-preview"></div>
          </div>
      </div>
    </div>

    <!-- Inline Compilation Output (Initially Hidden) -->
    <div id="compilation-output" class="compilation-output" style="display: none;">
      <div class="compilation-output-header">
        <div>
          <i class="fas fa-terminal me-2"></i>Compilation Output
        </div>
        <button id="close-compilation-output" class="btn btn-sm btn-outline-secondary">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div id="compilation-log-inline" class="compilation-log-inline">
        Click "Compile" to start compilation...
      </div>
    </div>

    <!-- Compilation Panel (hidden by default) -->
    <div id="compilation-panel" class="split-editor" style="display: none;">
      <!-- Horizontal: Compile Button & Log -->
      <div class="compilation-grid">
        <!-- Left: Compile/Stop Button -->
        <div class="compilation-buttons">
          <button id="compile-btn-panel" class="btn btn-primary w-100 btn-lg mb-2">
            <i class="fas fa-file-pdf me-2"></i>Compile PDF
          </button>
          <button id="quick-compile-btn-panel" class="btn btn-outline-primary w-100 mb-2">
            <i class="fas fa-bolt me-2"></i>Quick Compile (text only)
          </button>
          <button id="stop-compile-btn" class="btn btn-danger w-100" style="display: none;">
            <i class="fas fa-stop me-2"></i>Stop
          </button>
        </div>

        <!-- Right: Log Viewer (fills available space) -->
        <div id="compilation-log-panel" class="compilation-log-panel">Click "Compile PDF" to start compilation...</div>
      </div>

      <!-- Side-by-Side PDFs with Outlines -->
      <div class="pdf-comparison-grid">
        <!-- Manuscript PDF (Left) -->
        <div class="flex-column">
          <div class="flex-center-between mb-2">
            <h6 style="color: var(--color-fg-default); margin: 0;">
              <i class="fas fa-file-pdf text-danger me-2"></i>Manuscript
            </h6>
            <div>
              <button id="toggle-outline-main" class="btn btn-sm btn-outline-secondary me-1" title="Toggle outline">
                <i class="fas fa-list"></i>
              </button>
              <a id="pdf-view-link-panel" href="#" target="_blank" class="btn btn-sm btn-outline-primary">
                <i class="fas fa-external-link-alt"></i>
              </a>
              <a id="pdf-download-link-panel" href="#" download class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-download"></i>
              </a>
            </div>
          </div>
          <div class="pdf-pdf-container">
            <div id="pdf-outline-main" class="pdf-outline-panel">
              <div class="pdf-outline-title">Outline</div>
              <div id="pdf-outline-items-main"></div>
            </div>
            <div id="pdf-viewer-panel" style="flex: 1; border: 1px solid var(--color-border-default); border-radius: 4px; background: white;">
              <div class="pdf-viewer-loading">
                <i class="fas fa-spinner fa-spin me-2"></i>Loading PDF...
              </div>
            </div>
          </div>
        </div>

        <!-- Diff PDF (Right) -->
        <div class="flex-column">
          <div class="flex-center-between mb-2">
            <h6 style="color: var(--color-fg-default); margin: 0;">
              <i class="fas fa-code-branch text-info me-2"></i>Diff PDF (Changes)
            </h6>
            <div>
              <button id="toggle-outline-diff" class="btn btn-sm btn-outline-secondary me-1" title="Toggle outline" style="display: none;">
                <i class="fas fa-list"></i>
              </button>
              <a id="diff-pdf-view-link-panel" href="#" target="_blank" class="btn btn-sm btn-outline-primary">
                <i class="fas fa-external-link-alt"></i>
              </a>
              <a id="diff-pdf-download-link-panel" href="#" download class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-download"></i>
              </a>
            </div>
          </div>
          <div class="pdf-pdf-container">
            <div id="pdf-outline-diff" class="pdf-outline-panel">
              <div class="pdf-outline-title">Outline</div>
              <div id="pdf-outline-items-diff"></div>
            </div>
            <div style="flex: 1; position: relative;">
              <div id="diff-pdf-placeholder" style="width: 100%; height: 100%; border: 1px solid var(--color-border-default); border-radius: 4px; background: var(--color-canvas-subtle); display: flex; align-items: center; justify-content: center; color: var(--color-fg-muted); position: absolute;">
                <div style="text-align: center;">
                  <i class="fas fa-info-circle fa-2x mb-3"></i>
                  <p>Diff PDF will appear after compilation</p>
                  <small>Shows tracked changes from previous version</small>
                </div>
              </div>
              <div id="diff-pdf-viewer-panel" style="width: 100%; height: 100%; border: 1px solid var(--color-border-default); border-radius: 4px; background: white; display: none;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Git Commit Modal -->
<div class="modal fade" id="git-commit-modal" tabindex="-1" aria-labelledby="git-commit-modal-label" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="git-commit-modal-label">
          <i class="fas fa-code-branch me-2"></i>Commit Changes
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="commit-message-input" class="form-label">Commit Message</label>
          <textarea
            id="commit-message-input"
            class="form-control"
            rows="3"
            placeholder="Describe your changes..."
            required></textarea>
          <div class="form-text">
            <i class="fas fa-info-circle me-1"></i>
            Auto-saved changes will be committed to git history
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label">Current Section</label>
          <div id="commit-section-info" class="text-muted">
            <i class="fas fa-file-alt me-1"></i><span id="commit-current-section">-</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" id="confirm-commit-btn" class="btn btn-primary">
          <i class="fas fa-check me-1"></i>Commit
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Keyboard Shortcuts Modal -->
<div class="modal fade" id="shortcuts-modal" tabindex="-1" aria-labelledby="shortcuts-modal-label" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="shortcuts-modal-label">
          <i class="fas fa-keyboard me-2"></i>Keyboard Shortcuts
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6">
            <h6 class="text-primary"><i class="fas fa-save me-2"></i>File Operations</h6>
            <table class="table table-sm">
              <tbody>
                <tr><td><kbd>Ctrl+S</kbd></td><td>Save current section</td></tr>
                <tr><td><kbd>Ctrl+Shift+X</kbd></td><td>Compile manuscript PDF</td></tr>
              </tbody>
            </table>

            <h6 class="text-primary mt-3"><i class="fas fa-edit me-2"></i>Editing</h6>
            <table class="table table-sm">
              <tbody>
                <tr><td><kbd>Ctrl+Z</kbd></td><td>Undo</td></tr>
                <tr><td><kbd>Ctrl+Y</kbd></td><td>Redo</td></tr>
                <tr><td><kbd>Ctrl+F</kbd></td><td>Find</td></tr>
                <tr><td><kbd>Ctrl+H</kbd></td><td>Find and replace</td></tr>
                <tr><td><kbd>Ctrl+/</kbd></td><td>Toggle line comment</td></tr>
              </tbody>
            </table>
          </div>

          <div class="col-md-6">
            <h6 class="text-primary"><i class="fas fa-search me-2"></i>PDF Controls</h6>
            <table class="table table-sm">
              <tbody>
                <tr><td><kbd>Ctrl+Drag</kbd></td><td>Zoom PDF (vertical drag)</td></tr>
                <tr><td><kbd>Ctrl++</kbd></td><td>Zoom in</td></tr>
                <tr><td><kbd>Ctrl+-</kbd></td><td>Zoom out</td></tr>
                <tr><td><kbd>Ctrl+0</kbd></td><td>Reset zoom</td></tr>
              </tbody>
            </table>

            <h6 class="text-primary mt-3"><i class="fas fa-text-height me-2"></i>Editor Font Size</h6>
            <table class="table table-sm">
              <tbody>
                <tr><td><kbd>Ctrl+Wheel</kbd></td><td>Adjust font size (over editor)</td></tr>
                <tr><td><kbd>Ctrl++</kbd></td><td>Increase font size</td></tr>
                <tr><td><kbd>Ctrl+-</kbd></td><td>Decrease font size</td></tr>
                <tr><td><kbd>Ctrl+0</kbd></td><td>Reset to default (14px)</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="alert alert-info mt-3" role="alert">
          <i class="fas fa-info-circle me-2"></i>
          <strong>Tip:</strong> Use <kbd>Ctrl+Wheel</kbd> over the editor to quickly adjust font size.
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
</div>
