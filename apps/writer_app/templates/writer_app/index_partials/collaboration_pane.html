<!-- Collaboration View (matches History panel structure) -->
<div id="collaboration-view" class="right-panel-content" hidden>
    <!-- Collaboration Panel Header -->
    <div class="panel-header" style="display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid var(--color-border-default);background:var(--bg-canvas-inset)">
        <div class="header-left" style="display: flex; align-items: center; gap: 0.5rem">
            <div class="view-switcher me-2" role="group">
                <button type="button"
                        class="view-switch-btn"
                        onclick="switchRightPanel('pdf')"
                        title="Back to PDF Preview (Ctrl+2)">
                    <i class="fas fa-file-pdf"></i>
                    <span class="visually-hidden">PDF Pane</span>
                </button>
                <button type="button"
                        class="view-switch-btn"
                        onclick="switchRightPanel('citations')"
                        title="Citations (Ctrl+3)">
                    <i class="fas fa-book"></i>
                    <span class="visually-hidden">Citations Pane</span>
                </button>
                <button type="button"
                        class="view-switch-btn"
                        onclick="switchRightPanel('figures')"
                        title="Figures (Ctrl+4)">
                    <i class="fas fa-image"></i>
                    <span class="visually-hidden">Figures Pane</span>
                </button>
                <button type="button"
                        class="view-switch-btn"
                        onclick="switchRightPanel('tables')"
                        title="Tables (Ctrl+5)">
                    <i class="fas fa-table"></i>
                    <span class="visually-hidden">Tables Pane</span>
                </button>
                <button type="button"
                        class="view-switch-btn"
                        onclick="switchRightPanel('history')"
                        title="Version History (Ctrl+6)">
                    <i class="fas fa-history"></i>
                    <span class="visually-hidden">History Pane</span>
                </button>
                <button type="button"
                        id="show-collaboration-btn"
                        class="view-switch-btn active"
                        onclick="switchRightPanel('collaboration')"
                        title="Collaboration (Ctrl+7)">
                    <i class="fas fa-users"></i>
                    <span class="visually-hidden">Collaboration Pane</span>
                </button>
            </div>
            <h6 class="mb-0" style="font-size: 0.9rem; font-weight: 600; color: var(--color-fg-default)">Collaboration</h6>
        </div>
        <div class="header-right" style="display: flex; align-items: center; gap: 0.5rem">
            <!-- Connection Status -->
            <div class="connection-status-badge" id="collab-connection-badge">
                <span class="status-dot offline" id="collab-status-dot"></span>
                <span class="status-text" id="collab-status-text">Not connected</span>
            </div>
            <!-- Enable/Disable Button -->
            <button id="collab-enable-btn" class="btn btn-sm btn-primary">
                <i class="fas fa-plug me-1"></i>Connect
            </button>
        </div>
    </div>

    <!-- Collaboration Content - Modernized -->
    <div class="collaboration-content-modern">

        <!-- Compact Invite Bar -->
        <div class="collab-section-compact invite-bar">
            <div class="input-group input-group-sm">
                <span class="input-group-text">
                    <i class="fas fa-user-plus"></i>
                </span>
                <input type="text"
                       id="invite-username"
                       class="form-control"
                       placeholder="Invite collaborator..."
                       style="font-size: 12px;">
                <select id="invite-role" class="form-select" style="max-width: 90px; font-size: 12px;">
                    <option value="editor">Edit</option>
                    <option value="viewer">View</option>
                    <option value="admin">Admin</option>
                </select>
                <button id="send-invite-btn" class="btn btn-primary" type="button" style="font-size: 12px;">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
            <div id="pending-invitations" class="pending-invites-compact"></div>
        </div>

        <!-- Two Column Layout -->
        <div class="collab-two-column">
            <!-- Left Column: People -->
            <div class="collab-column">
                <!-- Active Now -->
                <div class="collab-section-modern">
                    <div class="section-title-modern">
                        <i class="fas fa-circle text-success" style="font-size: 8px;"></i>
                        <span>Active Now</span>
                        <span class="badge-count" id="collab-count-badge">0</span>
                    </div>
                    <div id="collaborators-list-main" class="collaborators-grid"></div>
                </div>
            </div>

            <!-- Right Column: Communication -->
            <div class="collab-column">
                <!-- Chat -->
                <div class="collab-section-modern chat-modern">
                    <div class="section-title-modern">
                        <i class="fas fa-comments"></i>
                        <span>Chat</span>
                        <button id="clear-chat-btn" class="btn-icon-sm">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                    <div id="chat-messages" class="chat-messages-modern"></div>
                    <div class="chat-input-modern">
                        <textarea id="chat-input"
                                  placeholder="Message... (Ctrl+Enter)"
                                  rows="1"></textarea>
                        <button id="send-chat-btn" class="btn-send-modern">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>

                <!-- Activity -->
                <div class="collab-section-modern activity-modern">
                    <div class="section-title-modern">
                        <i class="fas fa-stream"></i>
                        <span>Activity</span>
                        <button id="clear-activity-btn" class="btn-icon-sm">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                    <div id="activity-feed" class="activity-feed-modern"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Modern Collaboration Styles */
.collaboration-content-modern {
    padding: 0;
    background: var(--color-canvas-default);
    height: 100%;
    display: flex;
    flex-direction: column;
}

/* Compact Invite Bar */
.invite-bar {
    padding: 12px;
    background: var(--color-canvas-subtle);
    border-bottom: 1px solid var(--color-border-muted);
}

.pending-invites-compact {
    margin-top: 8px;
}

/* Two Column Layout */
.collab-two-column {
    display: grid;
    grid-template-columns: 1fr 1.5fr;
    gap: 1px;
    background: var(--color-border-muted);
    flex: 1;
    overflow: hidden;
}

.collab-column {
    background: var(--color-canvas-default);
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

/* Modern Sections */
.collab-section-modern {
    background: var(--color-canvas-default);
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.chat-modern {
    flex: 1.5;
    border-bottom: 1px solid var(--color-border-muted);
}

.activity-modern {
    flex: 1;
}

.section-title-modern {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    background: var(--color-canvas-subtle);
    border-bottom: 1px solid var(--color-border-muted);
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--color-fg-muted);
    user-select: none;
}

.section-title-modern span {
    flex: 1;
}

.section-title-modern i {
    font-size: 10px;
}

.badge-count {
    background: var(--color-accent-emphasis);
    color: white;
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: 600;
}

.btn-icon-sm {
    background: none;
    border: none;
    color: var(--color-fg-muted);
    padding: 2px 6px;
    cursor: pointer;
    font-size: 10px;
    border-radius: 3px;
}

.btn-icon-sm:hover {
    background: var(--color-neutral-muted);
    color: var(--color-fg-default);
}

/* Collaborators Grid */
.collaborators-grid {
    padding: 8px;
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    overflow-y: auto;
    max-height: 200px;
}

/* Modern Chat */
.chat-messages-modern {
    flex: 1;
    overflow-y: auto;
    padding: 8px;
    background: var(--color-canvas-inset);
    min-height: 150px;
    max-height: 250px;
}

.chat-input-modern {
    display: flex;
    gap: 6px;
    padding: 8px;
    background: var(--color-canvas-subtle);
    border-top: 1px solid var(--color-border-muted);
}

.chat-input-modern textarea {
    flex: 1;
    border: 1px solid var(--color-border-default);
    border-radius: 4px;
    padding: 6px 8px;
    font-size: 12px;
    resize: none;
    background: var(--color-canvas-default);
    color: var(--color-fg-default);
    font-family: inherit;
}

.chat-input-modern textarea:focus {
    outline: none;
    border-color: var(--color-accent-emphasis);
}

.btn-send-modern {
    background: var(--color-accent-emphasis);
    color: white;
    border: none;
    border-radius: 4px;
    padding: 6px 12px;
    cursor: pointer;
    font-size: 12px;
}

.btn-send-modern:hover {
    opacity: 0.9;
}

/* Modern Activity Feed */
.activity-feed-modern {
    overflow-y: auto;
    padding: 8px;
    font-size: 11px;
    max-height: 150px;
    background: var(--color-canvas-inset);
}

.section-title {
    margin: 0;
    font-size: 14px;
    font-weight: 600;
    color: var(--color-fg-default, #24292e);
    display: flex;
    align-items: center;
}

.section-body {
    padding: 12px;
    max-height: 300px;
    overflow-y: auto;
}

.collaborators-section .section-body {
    max-height: 250px;
}

.activity-section .section-body {
    max-height: 200px;
}

/* Connection Status Badge */
.connection-status-badge {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 4px 10px;
    background: var(--color-canvas-subtle, #f6f8fa);
    border-radius: 12px;
    font-size: 12px;
}

.status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
}

.status-dot.online {
    background: #28a745;
    animation: pulse-green 2s infinite;
}

.status-dot.offline {
    background: #d73a49;
}

.status-dot.connecting {
    background: #ffa500;
    animation: pulse-orange 1s infinite;
}

@keyframes pulse-green {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.6; transform: scale(1.1); }
}

@keyframes pulse-orange {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.status-text {
    color: var(--color-fg-default, #24292e);
    font-weight: 500;
}

/* Chat Styles */
.chat-messages {
    background: var(--color-canvas-subtle, #f6f8fa);
    border-radius: 6px;
    padding: 12px;
    margin-bottom: 12px;
}

.chat-empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 40px 20px;
    text-align: center;
}

.chat-message {
    margin-bottom: 12px;
    padding: 8px 12px;
    background: white;
    border-radius: 8px;
    border-left: 3px solid #0366d6;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    cursor: pointer;
    user-select: text;
    transition: background-color 0.2s;
}

.chat-message:hover {
    background: rgba(3, 102, 214, 0.05);
}

.chat-message.own-message {
    border-left-color: #28a745;
    background: #f0fff4;
}

.chat-message.own-message:hover {
    background: rgba(40, 167, 69, 0.1);
}

.chat-message-content {
    user-select: text;
    cursor: text;
}

.chat-message-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 4px;
}

.chat-message-author {
    font-weight: 600;
    font-size: 13px;
    color: var(--color-fg-default, #24292e);
}

.chat-message-time {
    font-size: 11px;
    color: var(--color-fg-muted, #586069);
}

.chat-message-content {
    font-size: 13px;
    color: var(--color-fg-default, #24292e);
    line-height: 1.5;
    word-wrap: break-word;
}

.chat-input-container {
    display: flex;
    gap: 8px;
    align-items: flex-end;
}

.chat-input {
    flex: 1;
    border: 1px solid var(--color-border-default, #d1d5da);
    border-radius: 6px;
    padding: 8px 12px;
    font-size: 13px;
    resize: vertical;
    min-height: 40px;
    max-height: 120px;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
}

.chat-input:focus {
    outline: none;
    border-color: #0366d6;
    box-shadow: 0 0 0 3px rgba(3, 102, 214, 0.1);
}

.btn-send {
    padding: 8px 16px;
    border-radius: 6px;
    height: 40px;
}

/* Activity Feed */
.activity-feed {
    font-size: 12px;
}

.activity-empty-state {
    text-align: center;
    padding: 20px;
}

.activity-item {
    padding: 8px 12px;
    border-left: 2px solid #e1e4e8;
    margin-bottom: 8px;
    background: var(--color-canvas-subtle, #f6f8fa);
    border-radius: 4px;
}

.activity-item.user-joined {
    border-left-color: #28a745;
}

.activity-item.user-left {
    border-left-color: #d73a49;
}

.activity-item.text-changed {
    border-left-color: #0366d6;
}

.activity-item.section-locked {
    border-left-color: #ffa500;
}

.activity-item-icon {
    margin-right: 6px;
    color: var(--color-fg-muted, #586069);
}

.activity-item-text {
    color: var(--color-fg-default, #24292e);
}

.activity-item-time {
    font-size: 10px;
    color: var(--color-fg-muted, #586069);
    margin-left: 6px;
}

/* Invitation Items */
.invitation-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    background: var(--color-canvas-subtle, #f6f8fa);
    border-radius: 4px;
    margin-bottom: 6px;
    border-left: 3px solid #0366d6;
}

.invitation-info {
    display: flex;
    align-items: center;
    gap: 8px;
    flex: 1;
}

.invitation-info strong {
    font-size: 13px;
    color: var(--color-fg-default, #24292e);
}

.invitation-item .badge {
    font-size: 10px;
    padding: 2px 6px;
}

.invitations-list {
    margin-top: 8px;
}

/* Empty States */
.empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 40px 20px;
    text-align: center;
    color: var(--color-fg-muted, #586069);
}

.empty-state i {
    font-size: 48px;
    margin-bottom: 16px;
    opacity: 0.3;
}

/* Scrollbar Styling */
.chat-messages::-webkit-scrollbar,
.activity-feed::-webkit-scrollbar,
.section-body::-webkit-scrollbar {
    width: 8px;
}

.chat-messages::-webkit-scrollbar-track,
.activity-feed::-webkit-scrollbar-track,
.section-body::-webkit-scrollbar-track {
    background: var(--color-canvas-subtle, #f6f8fa);
}

.chat-messages::-webkit-scrollbar-thumb,
.activity-feed::-webkit-scrollbar-thumb,
.section-body::-webkit-scrollbar-thumb {
    background: var(--color-border-default, #d1d5da);
    border-radius: 4px;
}

.chat-messages::-webkit-scrollbar-thumb:hover,
.activity-feed::-webkit-scrollbar-thumb:hover,
.section-body::-webkit-scrollbar-thumb:hover {
    background: var(--color-fg-muted, #586069);
}

/* Dark mode */
@media (prefers-color-scheme: dark) {
    .chat-message {
        background: var(--color-canvas-subtle, #161b22);
        border-left-color: #58a6ff;
    }

    .chat-message.own-message {
        border-left-color: #3fb950;
        background: #0d3818;
    }

    .activity-item {
        background: var(--color-canvas-subtle, #161b22);
    }
}
</style>

<script>
// Modern Collaboration Pane Initialization
document.addEventListener('DOMContentLoaded', () => {
    // Initialize empty states
    const chatMessages = document.getElementById('chat-messages');
    const activityFeed = document.getElementById('activity-feed');

    if (chatMessages && chatMessages.children.length === 0) {
        chatMessages.innerHTML = `
            <div style="text-align: center; padding: 40px 20px; color: var(--color-fg-muted);">
                <i class="fas fa-comments" style="font-size: 32px; opacity: 0.3; margin-bottom: 8px;"></i>
                <p style="margin: 0; font-size: 12px;">No messages yet</p>
            </div>
        `;
    }

    if (activityFeed && activityFeed.children.length === 0) {
        activityFeed.innerHTML = `
            <div style="text-align: center; padding: 20px; color: var(--color-fg-muted); font-size: 11px;">
                Activity will appear here
            </div>
        `;
    }

    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-chat-btn');
    const clearChatBtn = document.getElementById('clear-chat-btn');
    const clearActivityBtn = document.getElementById('clear-activity-btn');
    const collabEnableBtn = document.getElementById('collab-enable-btn');

    // Send message on button click
    if (sendBtn && chatInput) {
        console.log('[CollabPane] Chat controls found, adding event listeners');

        sendBtn.addEventListener('click', (e) => {
            console.log('[CollabPane] Send button clicked');
            e.preventDefault();
            sendChatMessage();
        });

        // Send on Ctrl+Enter
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && e.ctrlKey) {
                console.log('[CollabPane] Ctrl+Enter pressed');
                e.preventDefault();
                sendChatMessage();
            }
        });

        console.log('[CollabPane] Chat event listeners registered');
    } else {
        console.error('[CollabPane] Chat controls not found:', { sendBtn, chatInput });
    }

    // Clear chat
    if (clearChatBtn) {
        clearChatBtn.addEventListener('click', () => {
            if (confirm('Clear all chat messages?')) {
                const chatMessages = document.getElementById('chat-messages');
                if (chatMessages) {
                    chatMessages.innerHTML = `
                        <div class="chat-empty-state">
                            <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No messages yet</p>
                            <small class="text-muted">Start a conversation with your team</small>
                        </div>
                    `;
                }
            }
        });
    }

    // Clear activity
    if (clearActivityBtn) {
        clearActivityBtn.addEventListener('click', () => {
            if (confirm('Clear activity feed?')) {
                const activityFeed = document.getElementById('activity-feed');
                if (activityFeed) {
                    activityFeed.innerHTML = `
                        <div class="activity-empty-state">
                            <p class="text-muted small">Activity will appear here</p>
                        </div>
                    `;
                }
            }
        });
    }

    // Enable/Disable collaboration
    if (collabEnableBtn) {
        collabEnableBtn.addEventListener('click', () => {
            console.log('[CollabPane] Connect button clicked');

            const manager = window.collaborativeEditorManager;
            if (!manager) {
                console.error('[CollabPane] collaborativeEditorManager not found');
                alert('Collaborative editor not initialized. Please refresh the page.');
                return;
            }

            const isEnabled = manager.isCollaborationActive();
            console.log('[CollabPane] Current collaboration state:', isEnabled);

            if (isEnabled) {
                manager.disableCollaborationMode();
            } else {
                manager.enableCollaborationMode();
            }
        });
    }

    function sendChatMessage() {
        console.log('[CollabPane] sendChatMessage called');

        const input = document.getElementById('chat-input');
        if (!input) {
            console.error('[CollabPane] Chat input not found');
            return;
        }

        const message = input.value.trim();
        console.log('[CollabPane] Message:', message);

        if (!message) {
            console.warn('[CollabPane] Empty message');
            return;
        }

        // Send via WebSocket
        const manager = window.collaborativeEditorManager;
        console.log('[CollabPane] Manager:', manager);

        if (!manager) {
            console.error('[CollabPane] Manager not found');
            alert('Collaborative editor not initialized. Please refresh the page.');
            return;
        }

        const wsClient = manager.getWebSocketClient();
        console.log('[CollabPane] WebSocket client:', wsClient);

        if (!wsClient) {
            console.error('[CollabPane] WebSocket client not found');
            alert('WebSocket not initialized. Click "Connect" first.');
            return;
        }

        console.log('[CollabPane] Sending chat message...');

        try {
            wsClient.send({
                type: 'chat_message',
                message: message,
            });
            console.log('[CollabPane] Message sent successfully');
        } catch (error) {
            console.error('[CollabPane] Error sending message:', error);
            alert('Failed to send message. Please check connection.');
            return;
        }

        // Clear input
        input.value = '';
        input.style.height = 'auto';
        console.log('[CollabPane] Message sent, input cleared');
    }

    // Auto-resize chat input
    if (chatInput) {
        chatInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // Enable OS clipboard integration
        chatInput.addEventListener('paste', async (e) => {
            // Allow default paste behavior (uses OS clipboard)
            console.log('[CollabPane] Paste event from OS clipboard');
        });

        chatInput.addEventListener('copy', (e) => {
            // Allow default copy behavior (uses OS clipboard)
            console.log('[CollabPane] Copy event to OS clipboard');
        });

        chatInput.addEventListener('cut', (e) => {
            // Allow default cut behavior (uses OS clipboard)
            console.log('[CollabPane] Cut event to OS clipboard');
        });
    }

    // Make chat messages copyable
    const chatMessages = document.getElementById('chat-messages');
    if (chatMessages) {
        chatMessages.addEventListener('click', (e) => {
            const target = e.target;
            const messageEl = target.closest('.chat-message');

            if (messageEl) {
                const contentEl = messageEl.querySelector('.chat-message-content');
                if (contentEl && contentEl.textContent) {
                    const text = contentEl.textContent;

                    // Try modern Clipboard API first
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(text).then(() => {
                            console.log('[CollabPane] Message copied to OS clipboard (Clipboard API)');
                            showCopyFeedback(messageEl);
                        }).catch((err) => {
                            console.error('[CollabPane] Clipboard API failed:', err);
                            fallbackCopy(text, messageEl);
                        });
                    } else {
                        // Fallback to execCommand
                        fallbackCopy(text, messageEl);
                    }
                }
            }
        });
    }

    // Fallback copy using execCommand
    function fallbackCopy(text, messageEl) {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.select();

        try {
            document.execCommand('copy');
            console.log('[CollabPane] Message copied to OS clipboard (execCommand)');
            showCopyFeedback(messageEl);
        } catch (err) {
            console.error('[CollabPane] Failed to copy:', err);
        } finally {
            document.body.removeChild(textarea);
        }
    }

    // Visual feedback for copy
    function showCopyFeedback(messageEl) {
        const originalBg = (messageEl).style.backgroundColor;
        (messageEl).style.backgroundColor = 'rgba(40, 167, 69, 0.2)';
        setTimeout(() => {
            (messageEl).style.backgroundColor = originalBg;
        }, 300);
    }

    // Invite functionality
    const inviteBtn = document.getElementById('send-invite-btn');
    const inviteInput = document.getElementById('invite-username');
    const inviteRole = document.getElementById('invite-role');

    if (inviteBtn && inviteInput && inviteRole) {
        inviteBtn.addEventListener('click', async () => {
            const usernameOrEmail = inviteInput.value.trim();
            if (!usernameOrEmail) {
                alert('Please enter a username or email');
                return;
            }

            const role = inviteRole.value;
            const config = window.WRITER_CONFIG;

            if (!config?.manuscriptId) {
                alert('No manuscript ID available');
                return;
            }

            try {
                const response = await fetch(`/writer/collaboration/api/manuscript/${config.manuscriptId}/invite/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken(),
                    },
                    body: JSON.stringify({
                        username: usernameOrEmail.includes('@') ? '' : usernameOrEmail,
                        email: usernameOrEmail.includes('@') ? usernameOrEmail : '',
                        role: role,
                    }),
                });

                const data = await response.json();

                if (data.success) {
                    alert(`âœ“ Invitation sent to ${data.invitation.invitee}!`);
                    inviteInput.value = '';
                    loadInvitations();
                } else {
                    alert(`Error: ${data.error}`);
                }
            } catch (error) {
                console.error('[CollabPane] Error sending invitation:', error);
                alert('Failed to send invitation');
            }
        });

        console.log('[CollabPane] Invite functionality initialized');
    }

    // Load invitations
    async function loadInvitations() {
        const config = window.WRITER_CONFIG;
        if (!config?.manuscriptId) return;

        try {
            const response = await fetch(`/writer/collaboration/api/manuscript/${config.manuscriptId}/invitations/`);
            const data = await response.json();

            if (data.success) {
                displayInvitations(data.invitations);
            }
        } catch (error) {
            console.error('[CollabPane] Error loading invitations:', error);
        }
    }

    function displayInvitations(invitations) {
        const container = document.getElementById('pending-invitations');
        if (!container) return;

        const pending = invitations.filter(inv => inv.status === 'pending');

        if (pending.length === 0) {
            container.innerHTML = '';
            return;
        }

        container.innerHTML = `
            <div class="invitations-list">
                <small class="text-muted d-block mb-2">Pending Invitations:</small>
                ${pending.map(inv => `
                    <div class="invitation-item" data-invitation-id="${inv.id}">
                        <div class="invitation-info">
                            <strong>${inv.invitee}</strong>
                            <span class="badge bg-secondary">${inv.role}</span>
                        </div>
                        <button class="btn btn-sm btn-outline-danger cancel-invitation-btn"
                                data-id="${inv.id}"
                                title="Cancel invitation">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `).join('')}
            </div>
        `;

        // Add cancel handlers
        container.querySelectorAll('.cancel-invitation-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                const invId = e.target.closest('button').dataset.id;
                if (confirm('Cancel this invitation?')) {
                    await cancelInvitation(invId);
                }
            });
        });
    }

    async function cancelInvitation(invitationId) {
        try {
            const response = await fetch(`/writer/collaboration/api/invitation/${invitationId}/cancel/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken(),
                },
            });

            const data = await response.json();
            if (data.success) {
                loadInvitations();
            } else {
                alert(`Error: ${data.error}`);
            }
        } catch (error) {
            console.error('[CollabPane] Error cancelling invitation:', error);
        }
    }

    function getCsrfToken() {
        const name = 'csrftoken';
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Load invitations on init
    setTimeout(() => {
        loadInvitations();
    }, 1500);

    // Debug initialization check
    setTimeout(() => {
        const config = window.WRITER_CONFIG;
        const manager = window.collaborativeEditorManager;

        console.log('[CollabPane] Initialization check:');
        console.log('  - WRITER_CONFIG:', config);
        console.log('  - manuscriptId:', config?.manuscriptId);
        console.log('  - collaborativeEditorManager:', manager);
        console.log('  - wsClient:', manager?.getWebSocketClient?.());
        console.log('  - isActive:', manager?.isCollaborationActive?.());

        if (config?.manuscriptId) {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/writer/manuscript/${config.manuscriptId}/`;
            console.log('  - WebSocket URL:', wsUrl);
        }
    }, 1000); // Wait for initialization
});

// Note: Chat and activity functions are now handled by CollaborativeEditorManager
</script>
