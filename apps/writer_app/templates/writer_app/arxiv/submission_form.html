{% extends "writer_app/base_writer.html" %}
{% load static %}

{% block title %}Submit to arXiv: {{ manuscript.title }} - SciTeX Writer{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'writer_app/css/arxiv.css' %}">
<link rel="stylesheet" href="{% static 'writer_app/css/select2.min.css' %}">
{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-upload"></i>
                        Submit to arXiv
                    </h4>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Manuscript:</strong> {{ manuscript.title }}
                        <br>
                        <small class="text-muted">
                            Submitting from project: {{ manuscript.project.name|default:"Standalone manuscript" }}
                        </small>
                    </div>

                    <form method="post" id="submission-form">
                        {% csrf_token %}
                        
                        <!-- Title and Abstract -->
                        <div class="mb-4">
                            <h5>Manuscript Details</h5>
                            
                            <div class="mb-3">
                                <label for="title" class="form-label">
                                    Title <span class="text-danger">*</span>
                                </label>
                                <input type="text" 
                                       class="form-control" 
                                       id="title" 
                                       name="title" 
                                       value="{{ manuscript.title }}" 
                                       maxlength="256"
                                       required>
                                <div class="form-text">
                                    Maximum 256 characters. Current: <span id="title-count">{{ manuscript.title|length }}</span>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="abstract" class="form-label">
                                    Abstract <span class="text-danger">*</span>
                                </label>
                                <textarea class="form-control" 
                                          id="abstract" 
                                          name="abstract" 
                                          rows="8" 
                                          maxlength="1920"
                                          required>{{ manuscript.abstract }}</textarea>
                                <div class="form-text">
                                    Maximum 1920 characters. Current: <span id="abstract-count">{{ manuscript.abstract|length }}</span>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="authors" class="form-label">
                                    Authors <span class="text-danger">*</span>
                                </label>
                                <textarea class="form-control" 
                                          id="authors" 
                                          name="authors" 
                                          rows="3" 
                                          placeholder="First Author, Second Author, Third Author"
                                          required></textarea>
                                <div class="form-text">
                                    Comma-separated list of author names as they should appear on arXiv.
                                </div>
                            </div>
                        </div>

                        <!-- Categories -->
                        <div class="mb-4">
                            <h5>Subject Categories</h5>
                            
                            <div class="mb-3">
                                <label for="primary_category" class="form-label">
                                    Primary Category <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" id="primary_category" name="primary_category" required>
                                    <option value="">Select primary category</option>
                                    {% for category in categories %}
                                    <option value="{{ category.id }}" 
                                            data-code="{{ category.code }}" 
                                            data-description="{{ category.description }}">
                                        {{ category.code }} - {{ category.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">
                                    The primary subject classification for your paper.
                                </div>
                            </div>

                            {% if suggested_categories %}
                            <div class="mb-3">
                                <label class="form-label">Suggested Categories</label>
                                <div class="d-flex flex-wrap gap-2">
                                    {% for category in suggested_categories %}
                                    <button type="button" 
                                            class="btn btn-outline-primary btn-sm suggestion-btn" 
                                            data-category-id="{{ category.id }}">
                                        {{ category.code }}
                                    </button>
                                    {% endfor %}
                                </div>
                                <div class="form-text">
                                    Click to select as primary category based on your manuscript content.
                                </div>
                            </div>
                            {% endif %}

                            <div class="mb-3">
                                <label for="secondary_categories" class="form-label">
                                    Secondary Categories (Optional)
                                </label>
                                <select class="form-select" 
                                        id="secondary_categories" 
                                        name="secondary_categories" 
                                        multiple>
                                    {% for category in categories %}
                                    <option value="{{ category.id }}">
                                        {{ category.code }} - {{ category.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">
                                    Additional subject classifications (maximum 3).
                                </div>
                            </div>
                        </div>

                        <!-- Additional Information -->
                        <div class="mb-4">
                            <h5>Additional Information</h5>
                            
                            <div class="mb-3">
                                <label for="comments" class="form-label">
                                    Comments (Optional)
                                </label>
                                <textarea class="form-control" 
                                          id="comments" 
                                          name="comments" 
                                          rows="3" 
                                          placeholder="e.g., 25 pages, 10 figures, submitted to Journal X"></textarea>
                                <div class="form-text">
                                    Brief description of the paper (length, figures, submission status).
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="journal_reference" class="form-label">
                                            Journal Reference (Optional)
                                        </label>
                                        <input type="text" 
                                               class="form-control" 
                                               id="journal_reference" 
                                               name="journal_reference" 
                                               placeholder="J. Example 123, 456-789 (2023)">
                                        <div class="form-text">
                                            If published, provide journal citation.
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="doi" class="form-label">
                                            DOI (Optional)
                                        </label>
                                        <input type="text" 
                                               class="form-control" 
                                               id="doi" 
                                               name="doi" 
                                               placeholder="10.1000/journal.example.123">
                                        <div class="form-text">
                                            Digital Object Identifier if available.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Submission Agreement -->
                        <div class="mb-4">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6>Submission Agreement</h6>
                                    <div class="form-check">
                                        <input class="form-check-input" 
                                               type="checkbox" 
                                               id="agree_terms" 
                                               required>
                                        <label class="form-check-label" for="agree_terms">
                                            I agree to the <a href="https://arxiv.org/help/policies" target="_blank">arXiv submission policies</a> 
                                            and confirm that this work is original and appropriate for arXiv.
                                        </label>
                                    </div>
                                    <div class="form-check mt-2">
                                        <input class="form-check-input" 
                                               type="checkbox" 
                                               id="confirm_rights" 
                                               required>
                                        <label class="form-check-label" for="confirm_rights">
                                            I confirm that I have the right to submit this work and that it complies 
                                            with copyright requirements.
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between">
                            <a href="{% url 'writer:arxiv-dashboard' %}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Cancel
                            </a>
                            <button type="submit" class="btn btn-primary" id="submit-button">
                                <i class="fas fa-check"></i> Create Submission
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Sidebar with Guidelines -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">Submission Guidelines</h6>
                </div>
                <div class="card-body">
                    <h6><i class="fas fa-check-circle text-success"></i> Before Submitting</h6>
                    <ul class="small">
                        <li>Ensure your manuscript is complete and polished</li>
                        <li>Check that all figures and references are included</li>
                        <li>Verify author names and affiliations</li>
                        <li>Review the abstract for clarity and completeness</li>
                    </ul>

                    <h6 class="mt-3"><i class="fas fa-info-circle text-info"></i> Category Selection</h6>
                    <ul class="small">
                        <li>Choose the most appropriate primary category</li>
                        <li>Add secondary categories if your work spans multiple fields</li>
                        <li>Use our suggestions based on your content</li>
                    </ul>

                    <h6 class="mt-3"><i class="fas fa-clock text-warning"></i> Processing Time</h6>
                    <ul class="small">
                        <li>Initial validation: ~5 minutes</li>
                        <li>arXiv review: 1-3 business days</li>
                        <li>Publication: Daily at 20:00 UTC</li>
                    </ul>
                </div>
            </div>

            <!-- Account Info -->
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0">Account Information</h6>
                </div>
                <div class="card-body">
                    <p class="small mb-1">
                        <strong>Username:</strong> {{ arxiv_account.arxiv_username }}
                    </p>
                    <p class="small mb-1">
                        <strong>Daily Limit:</strong> {{ arxiv_account.daily_submission_limit }}
                    </p>
                    <p class="small mb-0">
                        <strong>Used Today:</strong> {{ arxiv_account.submissions_today }}
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'writer_app/js/select2.min.js' %}"></script>
<script>
$(document).ready(function() {
    // Initialize Select2 for categories
    $('#primary_category').select2({
        placeholder: 'Select primary category',
        allowClear: true
    });
    
    $('#secondary_categories').select2({
        placeholder: 'Select secondary categories',
        maximumSelectionLength: 3
    });

    // Character counters
    function updateCounter(inputId, counterId, maxLength) {
        const input = document.getElementById(inputId);
        const counter = document.getElementById(counterId);
        
        function update() {
            const current = input.value.length;
            counter.textContent = current;
            
            if (current > maxLength * 0.9) {
                counter.parentElement.classList.add('text-warning');
            } else {
                counter.parentElement.classList.remove('text-warning');
            }
            
            if (current >= maxLength) {
                counter.parentElement.classList.add('text-danger');
                counter.parentElement.classList.remove('text-warning');
            } else {
                counter.parentElement.classList.remove('text-danger');
            }
        }
        
        input.addEventListener('input', update);
        update();
    }
    
    updateCounter('title', 'title-count', 256);
    updateCounter('abstract', 'abstract-count', 1920);

    // Suggestion buttons
    $('.suggestion-btn').click(function() {
        const categoryId = $(this).data('category-id');
        $('#primary_category').val(categoryId).trigger('change');
        $(this).addClass('btn-primary').removeClass('btn-outline-primary');
        $(this).siblings().addClass('btn-outline-primary').removeClass('btn-primary');
    });

    // Form submission
    $('#submission-form').submit(function(e) {
        const button = $('#submit-button');
        button.prop('disabled', true);
        button.html('<i class="fas fa-spinner fa-spin"></i> Creating...');
    });
});
</script>
{% endblock %}