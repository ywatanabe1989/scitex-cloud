{% extends "writer_app/base.html" %}
{% load static %}

{% block title %}SciTeX Writer - Modular Editor{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'common/css/hero-gradients.css' %}">
<style>
    /* SciTeX Writer - Modular approach with text components and word counts */
    body {
        background-color: var(--scitex-color-07);
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }
    
    .writer-container {
        min-height: 100vh;
        background-color: var(--scitex-color-07);
    }
    
    .writer-header {
        background-color: var(--scitex-color-01);
        color: var(--white);
        padding: 1rem 0;
        margin-bottom: 2rem;
    }
    
    .manuscript-title {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }
    
    .manuscript-meta {
        font-size: 0.9rem;
        opacity: 0.8;
    }
    
    .action-bar {
        background-color: var(--white);
        border-bottom: 1px solid var(--scitex-color-06);
        padding: 1rem 0;
        margin-bottom: 2rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .manuscript-section {
        background-color: var(--white);
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
        overflow: hidden;
    }
    
    .section-header {
        background-color: var(--scitex-color-02);
        color: var(--white);
        padding: 1rem 1.5rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .section-title {
        font-weight: 600;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .section-stats {
        display: flex;
        gap: 1rem;
        font-size: 0.9rem;
    }
    
    .word-count {
        background-color: rgba(255,255,255,0.2);
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
    }
    
    .section-content {
        padding: 1.5rem;
    }
    
    .text-editor {
        width: 100%;
        min-height: 200px;
        border: 2px solid var(--scitex-color-06);
        border-radius: 6px;
        padding: 1rem;
        font-size: 1rem;
        line-height: 1.6;
        resize: vertical;
        font-family: Georgia, "Times New Roman", serif;
        transition: border-color 0.3s ease;
    }
    
    .text-editor:focus {
        outline: none;
        border-color: var(--scitex-color-02);
        box-shadow: 0 0 0 3px rgba(26, 35, 50, 0.1);
    }
    
    .section-help {
        background-color: var(--scitex-color-07);
        padding: 1rem;
        margin-top: 1rem;
        border-radius: 6px;
        font-size: 0.9rem;
        color: var(--scitex-color-03);
    }
    
    .citations-list {
        background-color: var(--scitex-color-07);
        border-radius: 6px;
        padding: 1rem;
        margin-top: 1rem;
    }
    
    .citation-item {
        background-color: var(--white);
        border: 1px solid var(--scitex-color-06);
        border-radius: 4px;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        display: flex;
        justify-content: between;
        align-items: center;
    }
    
    .citation-text {
        flex: 1;
        font-size: 0.9rem;
    }
    
    .citation-key {
        background-color: var(--scitex-color-02);
        color: var(--white);
        padding: 0.25rem 0.5rem;
        border-radius: 3px;
        font-family: monospace;
        font-size: 0.8rem;
        margin-left: 1rem;
    }
    
    .btn-primary {
        background-color: var(--scitex-color-02);
        border-color: var(--scitex-color-02);
        color: var(--white);
    }
    
    .btn-primary:hover {
        background-color: var(--scitex-color-01);
        border-color: var(--scitex-color-01);
    }
    
    .btn-outline-primary {
        border-color: var(--scitex-color-02);
        color: var(--scitex-color-02);
    }
    
    .btn-outline-primary:hover {
        background-color: var(--scitex-color-02);
        border-color: var(--scitex-color-02);
        color: var(--white);
    }
    
    .progress-bar {
        background-color: var(--scitex-color-02);
    }
    
    .alert-info {
        background-color: rgba(26, 35, 50, 0.1);
        border-color: var(--scitex-color-02);
        color: var(--scitex-color-01);
    }
    
    .manuscript-summary {
        background-color: var(--white);
        border-radius: 8px;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }
    
    .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .summary-item {
        text-align: center;
        padding: 1rem;
        background-color: var(--scitex-color-07);
        border-radius: 6px;
    }
    
    .summary-number {
        font-size: 2rem;
        font-weight: 700;
        color: var(--scitex-color-02);
        display: block;
    }
    
    .summary-label {
        font-size: 0.9rem;
        color: var(--scitex-color-03);
        margin-top: 0.25rem;
    }
    
    .latex-toggle {
        background-color: var(--scitex-color-06);
        border: 1px solid var(--scitex-color-05);
        border-radius: 6px;
        padding: 1rem;
        margin-top: 1rem;
    }
    
    .latex-editor {
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        background-color: var(--scitex-color-01);
        color: var(--scitex-color-06);
        border: none;
        width: 100%;
        min-height: 300px;
        padding: 1rem;
        border-radius: 6px;
        font-size: 0.9rem;
        line-height: 1.4;
    }
    
    .section-toggle {
        background: none;
        border: none;
        color: var(--white);
        font-size: 0.9rem;
        cursor: pointer;
        opacity: 0.8;
        transition: opacity 0.3s ease;
    }
    
    .section-toggle:hover {
        opacity: 1;
    }
</style>
{% endblock %}

{% block content %}
<div class="writer-container">
    <!-- Header -->
    <div class="writer-header">
        <div class="container">
            <div class="manuscript-title" contenteditable="true" id="manuscript-title">
                Quantum Entanglement and Its Applications in Quantum Computing
            </div>
            <div class="manuscript-meta">
                Authors: <span contenteditable="true" id="manuscript-authors">Jane Smith, University of Science</span>
            </div>
        </div>
    </div>
    
    <!-- Action Bar -->
    <div class="action-bar">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary" id="save-btn">
                            <i class="fas fa-save"></i> Save
                        </button>
                        <button type="button" class="btn btn-outline-primary" id="export-btn">
                            <i class="fas fa-download"></i> Export
                        </button>
                        <button type="button" class="btn btn-primary" id="compile-btn">
                            <i class="fas fa-file-pdf"></i> Generate PDF
                        </button>
                    </div>
                </div>
                <div class="col-md-6 text-end">
                    <span class="text-muted">
                        <i class="fas fa-clock"></i> Last saved: <span id="last-saved">Never</span>
                    </span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="container">
        <!-- Manuscript Summary -->
        <div class="manuscript-summary">
            <h5><i class="fas fa-chart-bar"></i> Manuscript Overview</h5>
            <div class="summary-grid">
                <div class="summary-item">
                    <span class="summary-number" id="total-words">0</span>
                    <div class="summary-label">Total Words</div>
                </div>
                <div class="summary-item">
                    <span class="summary-number" id="abstract-words">0</span>
                    <div class="summary-label">Abstract Words</div>
                </div>
                <div class="summary-item">
                    <span class="summary-number" id="main-words">0</span>
                    <div class="summary-label">Main Text (IMRD)</div>
                </div>
                <div class="summary-item">
                    <span class="summary-number" id="citation-count">0</span>
                    <div class="summary-label">Citations</div>
                </div>
                <div class="summary-item">
                    <span class="summary-number" id="unique-citations">0</span>
                    <div class="summary-label">Unique References</div>
                </div>
            </div>
        </div>
        
        <!-- Abstract Section -->
        <div class="manuscript-section">
            <div class="section-header">
                <h4 class="section-title">
                    <i class="fas fa-file-alt"></i> Abstract
                </h4>
                <div class="section-stats">
                    <div class="word-count">
                        <span id="abstract-count">0</span> words
                    </div>
                    <button class="section-toggle" onclick="toggleLatex('abstract')">
                        <i class="fas fa-code"></i> LaTeX
                    </button>
                </div>
            </div>
            <div class="section-content">
                <textarea class="text-editor" id="abstract-editor" 
                          placeholder="Write your abstract here. Focus on the main findings, methods, and conclusions of your research."
                          data-section="abstract">This paper explores the phenomenon of quantum entanglement and its role in quantum computing. We discuss the fundamental principles of entanglement, review recent experimental advances, and analyze potential applications in quantum algorithms and information processing.</textarea>
                <div class="section-help">
                    <strong>Abstract Guidelines:</strong> Summarize your research in 150-300 words. Include the problem, methods, key results, and conclusions.
                </div>
                <div class="latex-toggle d-none" id="abstract-latex">
                    <label class="form-label">LaTeX Code:</label>
                    <textarea class="latex-editor" id="abstract-latex-editor" readonly></textarea>
                </div>
            </div>
        </div>
        
        <!-- Introduction Section -->
        <div class="manuscript-section">
            <div class="section-header">
                <h4 class="section-title">
                    <i class="fas fa-play"></i> Introduction
                </h4>
                <div class="section-stats">
                    <div class="word-count">
                        <span id="introduction-count">0</span> words
                    </div>
                    <button class="section-toggle" onclick="toggleLatex('introduction')">
                        <i class="fas fa-code"></i> LaTeX
                    </button>
                </div>
            </div>
            <div class="section-content">
                <textarea class="text-editor" id="introduction-editor" 
                          placeholder="Introduce your research topic, provide background, and state your objectives."
                          data-section="introduction">Quantum entanglement is a physical phenomenon that occurs when pairs or groups of particles interact in ways such that the quantum state of each particle cannot be described independently of the others. Instead, a quantum state must be described for the system as a whole.

Einstein famously referred to quantum entanglement as "spooky action at a distance" because of its seemingly non-local nature. When particles are entangled, measuring the state of one particle instantaneously affects the state of its entangled partner, regardless of the distance separating them.</textarea>
                <div class="section-help">
                    <strong>Introduction Guidelines:</strong> Provide background, state the problem, review relevant literature, and clearly state your research objectives.
                </div>
                <div class="latex-toggle d-none" id="introduction-latex">
                    <label class="form-label">LaTeX Code:</label>
                    <textarea class="latex-editor" id="introduction-latex-editor" readonly></textarea>
                </div>
            </div>
        </div>
        
        <!-- Methods Section -->
        <div class="manuscript-section">
            <div class="section-header">
                <h4 class="section-title">
                    <i class="fas fa-cogs"></i> Methods
                </h4>
                <div class="section-stats">
                    <div class="word-count">
                        <span id="methods-count">0</span> words
                    </div>
                    <button class="section-toggle" onclick="toggleLatex('methods')">
                        <i class="fas fa-code"></i> LaTeX
                    </button>
                </div>
            </div>
            <div class="section-content">
                <textarea class="text-editor" id="methods-editor" 
                          placeholder="Describe your methodology, experimental setup, and analytical approaches."
                          data-section="methods">The mathematical formulation of entanglement relies on the tensor product structure of quantum mechanics. For a system of two qubits, the general state can be written as a superposition of basis states.

We employed quantum state tomography to characterize entangled states and used Bell inequality measurements to verify non-local correlations.</textarea>
                <div class="section-help">
                    <strong>Methods Guidelines:</strong> Provide enough detail for reproducibility. Include experimental design, data collection, and analysis methods.
                </div>
                <div class="latex-toggle d-none" id="methods-latex">
                    <label class="form-label">LaTeX Code:</label>
                    <textarea class="latex-editor" id="methods-latex-editor" readonly></textarea>
                </div>
            </div>
        </div>
        
        <!-- Results Section -->
        <div class="manuscript-section">
            <div class="section-header">
                <h4 class="section-title">
                    <i class="fas fa-chart-line"></i> Results
                </h4>
                <div class="section-stats">
                    <div class="word-count">
                        <span id="results-count">0</span> words
                    </div>
                    <button class="section-toggle" onclick="toggleLatex('results')">
                        <i class="fas fa-code"></i> LaTeX
                    </button>
                </div>
            </div>
            <div class="section-content">
                <textarea class="text-editor" id="results-editor" 
                          placeholder="Present your findings clearly and objectively."
                          data-section="results">Recent experiments have conclusively demonstrated the non-local nature of quantum entanglement, confirming Bell's inequality violations. These experiments use photon pairs created through spontaneous parametric down-conversion and measured at different polarization angles.

Our measurements showed a Bell parameter of 2.85 Â± 0.03, clearly violating the classical limit of 2.0 and confirming quantum mechanical predictions.</textarea>
                <div class="section-help">
                    <strong>Results Guidelines:</strong> Present findings objectively without interpretation. Use figures and tables to support your text.
                </div>
                <div class="latex-toggle d-none" id="results-latex">
                    <label class="form-label">LaTeX Code:</label>
                    <textarea class="latex-editor" id="results-latex-editor" readonly></textarea>
                </div>
            </div>
        </div>
        
        <!-- Discussion Section -->
        <div class="manuscript-section">
            <div class="section-header">
                <h4 class="section-title">
                    <i class="fas fa-comments"></i> Discussion
                </h4>
                <div class="section-stats">
                    <div class="word-count">
                        <span id="discussion-count">0</span> words
                    </div>
                    <button class="section-toggle" onclick="toggleLatex('discussion')">
                        <i class="fas fa-code"></i> LaTeX
                    </button>
                </div>
            </div>
            <div class="section-content">
                <textarea class="text-editor" id="discussion-editor" 
                          placeholder="Interpret your results, discuss implications, and address limitations."
                          data-section="discussion">Quantum entanglement serves as a fundamental resource for many quantum algorithms including quantum teleportation, quantum cryptography, quantum error correction, and various quantum algorithms that provide computational speedup.

These results have significant implications for the development of quantum computing technologies and our understanding of quantum mechanics fundamentals.</textarea>
                <div class="section-help">
                    <strong>Discussion Guidelines:</strong> Interpret results, compare with previous work, discuss implications, and acknowledge limitations.
                </div>
                <div class="latex-toggle d-none" id="discussion-latex">
                    <label class="form-label">LaTeX Code:</label>
                    <textarea class="latex-editor" id="discussion-latex-editor" readonly></textarea>
                </div>
            </div>
        </div>
        
        <!-- Conclusion Section -->
        <div class="manuscript-section">
            <div class="section-header">
                <h4 class="section-title">
                    <i class="fas fa-flag-checkered"></i> Conclusion
                </h4>
                <div class="section-stats">
                    <div class="word-count">
                        <span id="conclusion-count">0</span> words
                    </div>
                    <button class="section-toggle" onclick="toggleLatex('conclusion')">
                        <i class="fas fa-code"></i> LaTeX
                    </button>
                </div>
            </div>
            <div class="section-content">
                <textarea class="text-editor" id="conclusion-editor" 
                          placeholder="Summarize your main findings and their significance."
                          data-section="conclusion">Quantum entanglement remains one of the most fascinating and counterintuitive aspects of quantum mechanics. As we continue to develop quantum computing technologies, understanding and harnessing entanglement will be crucial for realizing the full potential of quantum information processing.</textarea>
                <div class="section-help">
                    <strong>Conclusion Guidelines:</strong> Summarize key findings, state their significance, and suggest future research directions.
                </div>
                <div class="latex-toggle d-none" id="conclusion-latex">
                    <label class="form-label">LaTeX Code:</label>
                    <textarea class="latex-editor" id="conclusion-latex-editor" readonly></textarea>
                </div>
            </div>
        </div>
        
        <!-- References Section -->
        <div class="manuscript-section">
            <div class="section-header">
                <h4 class="section-title">
                    <i class="fas fa-book"></i> References
                </h4>
                <div class="section-stats">
                    <div class="word-count">
                        <span id="references-count">1</span> citations
                    </div>
                    <button class="btn btn-sm btn-light" onclick="addCitation()">
                        <i class="fas fa-plus"></i> Add
                    </button>
                </div>
            </div>
            <div class="section-content">
                <div class="citations-list" id="citations-list">
                    <div class="citation-item">
                        <div class="citation-text">
                            Aspect, A., Dalibard, J., & Roger, G. (1982). Experimental Test of Bell's Inequalities Using Time-Varying Analyzers. Physical Review Letters, 49(25), 1804-1807.
                        </div>
                        <div class="citation-key">aspect1982</div>
                    </div>
                </div>
                <div class="section-help">
                    <strong>Citation Guidelines:</strong> Include all references cited in your text. Use a consistent citation style (APA, Nature, etc.).
                </div>
            </div>
        </div>
        
        <!-- Status and Progress -->
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            <strong>Document Status:</strong> <span id="document-status">Draft</span>
            <div class="progress mt-2" style="height: 6px;">
                <div class="progress-bar" role="progressbar" id="completion-progress" style="width: 75%"></div>
            </div>
            <small class="text-muted">Progress based on section completion and word count targets</small>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Word counting and document management
    const sections = ['abstract', 'introduction', 'methods', 'results', 'discussion', 'conclusion'];
    let manuscriptData = {
        title: '',
        authors: '',
        sections: {},
        citations: []
    };
    
    // Initialize word counting for all sections
    sections.forEach(section => {
        const editor = document.getElementById(`${section}-editor`);
        const counter = document.getElementById(`${section}-count`);
        
        if (editor && counter) {
            // Initial count
            updateWordCount(section);
            
            // Real-time counting
            editor.addEventListener('input', function() {
                updateWordCount(section);
                updateSummary();
                autoSave();
            });
        }
    });
    
    // Title and authors editing
    document.getElementById('manuscript-title').addEventListener('input', function() {
        manuscriptData.title = this.textContent;
        autoSave();
    });
    
    document.getElementById('manuscript-authors').addEventListener('input', function() {
        manuscriptData.authors = this.textContent;
        autoSave();
    });
    
    function updateWordCount(section) {
        const editor = document.getElementById(`${section}-editor`);
        const counter = document.getElementById(`${section}-count`);
        
        if (editor && counter) {
            const text = editor.value.trim();
            const wordCount = text ? text.split(/\s+/).length : 0;
            counter.textContent = wordCount;
            
            // Store in manuscript data
            manuscriptData.sections[section] = {
                content: text,
                wordCount: wordCount
            };
        }
    }
    
    function updateSummary() {
        let totalWords = 0;
        let abstractWords = 0;
        let mainWords = 0; // IMRD sections
        
        // Calculate word counts
        abstractWords = manuscriptData.sections.abstract?.wordCount || 0;
        
        const mainSections = ['introduction', 'methods', 'results', 'discussion'];
        mainSections.forEach(section => {
            const count = manuscriptData.sections[section]?.wordCount || 0;
            mainWords += count;
            totalWords += count;
        });
        
        totalWords += abstractWords;
        totalWords += (manuscriptData.sections.conclusion?.wordCount || 0);
        
        // Update summary display
        document.getElementById('total-words').textContent = totalWords;
        document.getElementById('abstract-words').textContent = abstractWords;
        document.getElementById('main-words').textContent = mainWords;
        
        // Update citation counts
        const citationCount = manuscriptData.citations.length;
        const uniqueCitations = new Set(manuscriptData.citations.map(c => c.key)).size;
        document.getElementById('citation-count').textContent = citationCount;
        document.getElementById('unique-citations').textContent = uniqueCitations;
        
        // Update progress bar
        updateProgress();
    }
    
    function updateProgress() {
        const totalWords = parseInt(document.getElementById('total-words').textContent);
        const abstractWords = parseInt(document.getElementById('abstract-words').textContent);
        const mainWords = parseInt(document.getElementById('main-words').textContent);
        const citationCount = parseInt(document.getElementById('citation-count').textContent);
        
        // Calculate progress based on typical targets
        let progress = 0;
        
        // Abstract: 150-300 words (target: 200)
        if (abstractWords >= 150) progress += 20;
        else if (abstractWords >= 100) progress += 15;
        else if (abstractWords >= 50) progress += 10;
        
        // Main text: 3000-6000 words (target: 4000)
        if (mainWords >= 3000) progress += 40;
        else if (mainWords >= 2000) progress += 30;
        else if (mainWords >= 1000) progress += 20;
        else if (mainWords >= 500) progress += 10;
        
        // Citations: 15-30 references (target: 20)
        if (citationCount >= 15) progress += 20;
        else if (citationCount >= 10) progress += 15;
        else if (citationCount >= 5) progress += 10;
        else if (citationCount >= 1) progress += 5;
        
        // All sections have content
        const sectionsWithContent = sections.filter(section => 
            manuscriptData.sections[section]?.wordCount > 0
        ).length;
        progress += (sectionsWithContent / sections.length) * 20;
        
        progress = Math.min(100, Math.round(progress));
        
        const progressBar = document.getElementById('completion-progress');
        progressBar.style.width = progress + '%';
        
        // Update status
        let status = 'Draft';
        if (progress >= 90) status = 'Ready for Review';
        else if (progress >= 70) status = 'Near Completion';
        else if (progress >= 40) status = 'In Progress';
        
        document.getElementById('document-status').textContent = status;
    }
    
    function autoSave() {
        // Save to localStorage
        localStorage.setItem('scitex-manuscript', JSON.stringify(manuscriptData));
        
        // Update last saved time
        const now = new Date();
        document.getElementById('last-saved').textContent = now.toLocaleTimeString();
    }
    
    function loadManuscript() {
        const saved = localStorage.getItem('scitex-manuscript');
        if (saved) {
            try {
                manuscriptData = JSON.parse(saved);
                
                // Restore title and authors
                if (manuscriptData.title) {
                    document.getElementById('manuscript-title').textContent = manuscriptData.title;
                }
                if (manuscriptData.authors) {
                    document.getElementById('manuscript-authors').textContent = manuscriptData.authors;
                }
                
                // Restore section content
                sections.forEach(section => {
                    if (manuscriptData.sections[section]) {
                        const editor = document.getElementById(`${section}-editor`);
                        if (editor) {
                            editor.value = manuscriptData.sections[section].content || '';
                            updateWordCount(section);
                        }
                    }
                });
                
                updateSummary();
            } catch (e) {
                console.error('Error loading saved manuscript:', e);
            }
        }
    }
    
    // Toggle LaTeX view
    window.toggleLatex = function(section) {
        const latexDiv = document.getElementById(`${section}-latex`);
        const latexEditor = document.getElementById(`${section}-latex-editor`);
        const textEditor = document.getElementById(`${section}-editor`);
        
        if (latexDiv.classList.contains('d-none')) {
            // Show LaTeX view
            const text = textEditor.value;
            const latexCode = convertToLatex(section, text);
            latexEditor.value = latexCode;
            latexDiv.classList.remove('d-none');
        } else {
            // Hide LaTeX view
            latexDiv.classList.add('d-none');
        }
    };
    
    function convertToLatex(section, text) {
        // Convert plain text to LaTeX
        let latex = text
            .replace(/\n\s*\n/g, '\n\n\\par\n') // Paragraph breaks
            .replace(/\*\*(.*?)\*\*/g, '\\textbf{$1}') // Bold
            .replace(/\*(.*?)\*/g, '\\textit{$1}') // Italic
            .replace(/\[cite:(.*?)\]/g, '\\cite{$1}'); // Citations
        
        return `\\section{${section.charAt(0).toUpperCase() + section.slice(1)}}\n${latex}`;
    }
    
    // Add citation
    window.addCitation = function() {
        const citationText = prompt('Enter citation (Author, Year, Title, Journal):');
        const citationKey = prompt('Enter citation key (e.g., author2023):');
        
        if (citationText && citationKey) {
            manuscriptData.citations.push({
                text: citationText,
                key: citationKey
            });
            
            renderCitations();
            updateSummary();
            autoSave();
        }
    };
    
    function renderCitations() {
        const container = document.getElementById('citations-list');
        container.innerHTML = '';
        
        manuscriptData.citations.forEach((citation, index) => {
            const div = document.createElement('div');
            div.className = 'citation-item';
            div.innerHTML = `
                <div class="citation-text">${citation.text}</div>
                <div class="citation-key">${citation.key}</div>
                <button class="btn btn-sm btn-outline-danger ms-2" onclick="removeCitation(${index})">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            container.appendChild(div);
        });
    }
    
    window.removeCitation = function(index) {
        manuscriptData.citations.splice(index, 1);
        renderCitations();
        updateSummary();
        autoSave();
    };
    
    // Save button
    document.getElementById('save-btn').addEventListener('click', function() {
        autoSave();
        
        // Show feedback
        const originalText = this.innerHTML;
        this.innerHTML = '<i class="fas fa-check"></i> Saved';
        setTimeout(() => {
            this.innerHTML = originalText;
        }, 2000);
    });
    
    // Export button
    document.getElementById('export-btn').addEventListener('click', function() {
        const dataStr = JSON.stringify(manuscriptData, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'manuscript-data.json';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    });
    
    // Compile button
    document.getElementById('compile-btn').addEventListener('click', function() {
        generateLatexAndCompile();
    });
    
    function generateLatexAndCompile() {
        // Generate full LaTeX document
        const title = manuscriptData.title || 'Untitled Manuscript';
        const authors = manuscriptData.authors || 'Unknown Author';
        
        let latex = `\\documentclass{article}
\\usepackage[utf8]{inputenc}
\\usepackage{amsmath}
\\usepackage{graphicx}
\\usepackage[margin=1in]{geometry}

\\title{${title}}
\\author{${authors}}
\\date{\\today}

\\begin{document}

\\maketitle

`;
        
        // Add abstract
        if (manuscriptData.sections.abstract?.content) {
            latex += `\\begin{abstract}\n${manuscriptData.sections.abstract.content}\n\\end{abstract}\n\n`;
        }
        
        // Add main sections
        const mainSections = ['introduction', 'methods', 'results', 'discussion', 'conclusion'];
        mainSections.forEach(section => {
            if (manuscriptData.sections[section]?.content) {
                const sectionTitle = section.charAt(0).toUpperCase() + section.slice(1);
                latex += `\\section{${sectionTitle}}\n${manuscriptData.sections[section].content}\n\n`;
            }
        });
        
        // Add references
        if (manuscriptData.citations.length > 0) {
            latex += `\\begin{thebibliography}{99}\n`;
            manuscriptData.citations.forEach(citation => {
                latex += `\\bibitem{${citation.key}}\n${citation.text}\n\n`;
            });
            latex += `\\end{thebibliography}\n`;
        }
        
        latex += `\\end{document}`;
        
        // Send to compilation endpoint
        fetch('/writer/api/compile/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                content: latex,
                title: title
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('PDF compilation started! Job ID: ' + data.job_id);
                // Could implement status checking here
            } else {
                alert('Compilation failed: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Compilation error:', error);
            alert('Network error: ' + error.message);
        });
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Initialize citations display
    manuscriptData.citations = [{
        text: 'Aspect, A., Dalibard, J., & Roger, G. (1982). Experimental Test of Bell\'s Inequalities Using Time-Varying Analyzers. Physical Review Letters, 49(25), 1804-1807.',
        key: 'aspect1982'
    }];
    
    // Load saved manuscript on page load
    loadManuscript();
    updateSummary();
    renderCitations();
});
</script>
{% endblock %}