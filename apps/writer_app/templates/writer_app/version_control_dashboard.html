{% extends "writer_app/writer_base.html" %}
{% load static %}

{% block title %}Version Control - {{ manuscript.title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'common/css/hero-gradients.css' %}">
<style>
    /* Version Control Dashboard Styles */
    body {
        background-color: var(--scitex-color-07);
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }
    
    .version-control-container {
        min-height: 100vh;
        background-color: var(--scitex-color-07);
    }
    
    .version-control-header {
        background-color: var(--scitex-color-01);
        color: var(--white);
        padding: 2rem 0;
        margin-bottom: 2rem;
    }
    
    .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .manuscript-info h1 {
        font-size: 1.8rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }
    
    .manuscript-meta {
        font-size: 0.9rem;
        opacity: 0.8;
        display: flex;
        gap: 2rem;
    }
    
    .header-actions {
        display: flex;
        gap: 1rem;
    }
    
    .btn-primary {
        background-color: var(--scitex-color-02);
        border: none;
        color: var(--white);
        padding: 0.75rem 1.5rem;
        border-radius: 6px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
    }
    
    .btn-primary:hover {
        background-color: var(--scitex-color-03);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        color: var(--white);
    }
    
    .btn-secondary {
        background-color: transparent;
        border: 2px solid var(--white);
        color: var(--white);
        padding: 0.75rem 1.5rem;
        border-radius: 6px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
    }
    
    .btn-secondary:hover {
        background-color: var(--white);
        color: var(--scitex-color-01);
    }
    
    .dashboard-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-bottom: 2rem;
    }
    
    .dashboard-section {
        background-color: var(--white);
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .section-header {
        background-color: var(--scitex-color-02);
        color: var(--white);
        padding: 1rem 1.5rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .section-title {
        font-weight: 600;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .section-content {
        padding: 1.5rem;
    }
    
    .version-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .version-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem;
        border-bottom: 1px solid var(--scitex-color-06);
        transition: background-color 0.2s ease;
    }
    
    .version-item:hover {
        background-color: var(--scitex-color-07);
    }
    
    .version-item:last-child {
        border-bottom: none;
    }
    
    .version-info {
        flex: 1;
    }
    
    .version-number {
        font-weight: 600;
        color: var(--scitex-color-02);
        font-size: 1.1rem;
    }
    
    .version-meta {
        font-size: 0.9rem;
        color: var(--scitex-color-03);
        margin-top: 0.25rem;
    }
    
    .version-message {
        font-size: 0.85rem;
        color: var(--scitex-color-04);
        margin-top: 0.25rem;
        font-style: italic;
    }
    
    .version-stats {
        display: flex;
        gap: 1rem;
        font-size: 0.8rem;
        color: var(--scitex-color-04);
    }
    
    .stat-item {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }
    
    .stat-positive {
        color: #28a745;
    }
    
    .stat-negative {
        color: #dc3545;
    }
    
    .version-actions {
        display: flex;
        gap: 0.5rem;
    }
    
    .btn-sm {
        padding: 0.5rem 1rem;
        font-size: 0.8rem;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .btn-outline {
        background: transparent;
        border: 1px solid var(--scitex-color-04);
        color: var(--scitex-color-04);
    }
    
    .btn-outline:hover {
        background: var(--scitex-color-04);
        color: var(--white);
    }
    
    .branch-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .branch-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem;
        border-bottom: 1px solid var(--scitex-color-06);
        transition: background-color 0.2s ease;
    }
    
    .branch-item:hover {
        background-color: var(--scitex-color-07);
    }
    
    .branch-item:last-child {
        border-bottom: none;
    }
    
    .branch-info {
        flex: 1;
    }
    
    .branch-name {
        font-weight: 600;
        color: var(--scitex-color-02);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .branch-badge {
        background: var(--scitex-color-06);
        color: var(--scitex-color-03);
        padding: 0.2rem 0.5rem;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: 500;
    }
    
    .branch-badge.main {
        background: var(--scitex-color-02);
        color: var(--white);
    }
    
    .branch-meta {
        font-size: 0.9rem;
        color: var(--scitex-color-03);
        margin-top: 0.25rem;
    }
    
    .branch-description {
        font-size: 0.85rem;
        color: var(--scitex-color-04);
        margin-top: 0.25rem;
    }
    
    .branch-stats {
        display: flex;
        gap: 1rem;
        font-size: 0.8rem;
        color: var(--scitex-color-04);
        margin-top: 0.5rem;
    }
    
    .merge-request-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem;
        border-bottom: 1px solid var(--scitex-color-06);
        transition: background-color 0.2s ease;
    }
    
    .merge-request-item:hover {
        background-color: var(--scitex-color-07);
    }
    
    .merge-request-item:last-child {
        border-bottom: none;
    }
    
    .merge-request-info {
        flex: 1;
    }
    
    .merge-request-title {
        font-weight: 600;
        color: var(--scitex-color-02);
        margin-bottom: 0.25rem;
    }
    
    .merge-request-meta {
        font-size: 0.9rem;
        color: var(--scitex-color-03);
    }
    
    .merge-request-branches {
        font-size: 0.85rem;
        color: var(--scitex-color-04);
        margin-top: 0.25rem;
    }
    
    .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
    }
    
    .status-open {
        background: #e3f2fd;
        color: #1976d2;
    }
    
    .status-review {
        background: #fff3e0;
        color: #f57c00;
    }
    
    .status-approved {
        background: #e8f5e8;
        color: #2e7d32;
    }
    
    .status-conflict {
        background: #ffebee;
        color: #c62828;
    }
    
    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: var(--scitex-color-04);
    }
    
    .empty-state-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
    
    .empty-state-message {
        font-size: 1.1rem;
        margin-bottom: 0.5rem;
    }
    
    .empty-state-hint {
        font-size: 0.9rem;
        opacity: 0.8;
    }
    
    /* Diff viewer styles */
    .diff-viewer {
        background: var(--white);
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-top: 2rem;
        overflow: hidden;
    }
    
    .diff-header {
        background: var(--scitex-color-02);
        color: var(--white);
        padding: 1rem 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .diff-content {
        padding: 1.5rem;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.9rem;
        line-height: 1.4;
        overflow-x: auto;
    }
    
    .diff-addition {
        background: #e8f5e8;
        color: #2e7d32;
        padding: 0.1rem 0.3rem;
    }
    
    .diff-deletion {
        background: #ffebee;
        color: #c62828;
        padding: 0.1rem 0.3rem;
        text-decoration: line-through;
    }
    
    .diff-equal {
        background: transparent;
    }
    
    /* Modal styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }
    
    .modal-content {
        background-color: var(--white);
        margin: 5% auto;
        padding: 0;
        border-radius: 8px;
        width: 90%;
        max-width: 600px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    
    .modal-header {
        background: var(--scitex-color-02);
        color: var(--white);
        padding: 1rem 1.5rem;
        border-radius: 8px 8px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .modal-body {
        padding: 1.5rem;
    }
    
    .form-group {
        margin-bottom: 1rem;
    }
    
    .form-label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: var(--scitex-color-02);
    }
    
    .form-control {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--scitex-color-06);
        border-radius: 6px;
        font-size: 1rem;
        transition: border-color 0.3s ease;
    }
    
    .form-control:focus {
        outline: none;
        border-color: var(--scitex-color-02);
        box-shadow: 0 0 0 3px rgba(26, 35, 50, 0.1);
    }
    
    .close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--white);
    }
    
    /* Mobile responsive */
    @media (max-width: 768px) {
        .dashboard-grid {
            grid-template-columns: 1fr;
        }
        
        .header-content {
            flex-direction: column;
            gap: 1rem;
            align-items: flex-start;
        }
        
        .header-actions {
            width: 100%;
            justify-content: space-between;
        }
        
        .manuscript-meta {
            flex-direction: column;
            gap: 0.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Hidden data attributes for JavaScript -->
<div style="display: none;">
    <span data-manuscript-id="{{ manuscript.id }}" id="manuscript-data"></span>
    <span data-user-id="{{ user.id }}" id="user-data"></span>
</div>

<div class="version-control-container">
    <!-- Header -->
    <div class="version-control-header hero-gradient-silverish">
        <div class="container">
            <div class="header-content">
                <div class="manuscript-info">
                    <h1><i class="fas fa-code-branch"></i> Version Control</h1>
                    <div class="manuscript-meta">
                        <span><strong>{{ manuscript.title }}</strong></span>
                        <span>Current Version: {{ manuscript.version }}</span>
                        <span>Last Updated: {{ manuscript.updated_at|date:"M d, Y H:i" }}</span>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="btn-primary" onclick="createVersion()">
                        <i class="fas fa-tag"></i> Create Version
                    </button>
                    <button class="btn-secondary" onclick="createBranch()">
                        <i class="fas fa-code-branch"></i> New Branch
                    </button>
                    <a href="{% url 'writer:collaborative-editor' manuscript.id %}" class="btn-secondary">
                        <i class="fas fa-edit"></i> Edit
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Dashboard Grid -->
        <div class="dashboard-grid">
            <!-- Version History -->
            <div class="dashboard-section">
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="fas fa-history"></i> Recent Versions
                    </h3>
                    <button class="btn-sm btn-outline" onclick="loadVersionHistory()">
                        View All
                    </button>
                </div>
                <div class="section-content">
                    {% if recent_versions %}
                        <ul class="version-list" id="version-list">
                            {% for version in recent_versions %}
                                <li class="version-item">
                                    <div class="version-info">
                                        <div class="version-number">
                                            v{{ version.version_number }}
                                            {% if version.version_tag %}
                                                <span class="branch-badge">{{ version.version_tag }}</span>
                                            {% endif %}
                                        </div>
                                        <div class="version-meta">
                                            {{ version.created_by.username }} • 
                                            {{ version.created_at|date:"M d, Y H:i" }} • 
                                            {{ version.branch_name }} branch
                                        </div>
                                        {% if version.commit_message %}
                                            <div class="version-message">{{ version.commit_message }}</div>
                                        {% endif %}
                                        <div class="version-stats">
                                            <span class="stat-item">
                                                <i class="fas fa-edit"></i> {{ version.total_changes }} changes
                                            </span>
                                            {% if version.word_count_delta > 0 %}
                                                <span class="stat-item stat-positive">
                                                    <i class="fas fa-plus"></i> {{ version.word_count_delta }} words
                                                </span>
                                            {% elif version.word_count_delta < 0 %}
                                                <span class="stat-item stat-negative">
                                                    <i class="fas fa-minus"></i> {{ version.word_count_delta|abs }} words
                                                </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="version-actions">
                                        <button class="btn-sm btn-outline" onclick="viewDiff('{{ version.id }}')">
                                            <i class="fas fa-eye"></i> Diff
                                        </button>
                                        <button class="btn-sm btn-outline" onclick="rollbackToVersion('{{ version.id }}')">
                                            <i class="fas fa-undo"></i> Rollback
                                        </button>
                                    </div>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <div class="empty-state">
                            <div class="empty-state-icon">
                                <i class="fas fa-history"></i>
                            </div>
                            <div class="empty-state-message">No versions yet</div>
                            <div class="empty-state-hint">Create your first version to start tracking changes</div>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Branches -->
            <div class="dashboard-section">
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="fas fa-code-branch"></i> Branches
                    </h3>
                    <button class="btn-sm btn-outline" onclick="createBranch()">
                        New Branch
                    </button>
                </div>
                <div class="section-content">
                    {% if branches %}
                        <ul class="branch-list" id="branch-list">
                            {% for branch in branches %}
                                <li class="branch-item">
                                    <div class="branch-info">
                                        <div class="branch-name">
                                            {{ branch.name }}
                                            {% if branch.name == 'main' %}
                                                <span class="branch-badge main">main</span>
                                            {% else %}
                                                <span class="branch-badge">feature</span>
                                            {% endif %}
                                        </div>
                                        <div class="branch-meta">
                                            Created by {{ branch.created_by.username }} • 
                                            {{ branch.created_at|date:"M d, Y" }}
                                        </div>
                                        {% if branch.description %}
                                            <div class="branch-description">{{ branch.description }}</div>
                                        {% endif %}
                                        <div class="branch-stats">
                                            <span class="stat-item">
                                                <i class="fas fa-code-commit"></i> {{ branch.total_commits }} commits
                                            </span>
                                            <span class="stat-item">
                                                <i class="fas fa-clock"></i> {{ branch.last_updated|date:"M d" }}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="version-actions">
                                        {% if branch.name != 'main' %}
                                            <button class="btn-sm btn-outline" onclick="createMergeRequest('{{ branch.id }}')">
                                                <i class="fas fa-code-merge"></i> Merge
                                            </button>
                                        {% endif %}
                                        <button class="btn-sm btn-outline" onclick="viewBranch('{{ branch.id }}')">
                                            <i class="fas fa-eye"></i> View
                                        </button>
                                    </div>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <div class="empty-state">
                            <div class="empty-state-icon">
                                <i class="fas fa-code-branch"></i>
                            </div>
                            <div class="empty-state-message">Only main branch</div>
                            <div class="empty-state-hint">Create feature branches for parallel development</div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Merge Requests -->
        {% if merge_requests %}
        <div class="dashboard-section">
            <div class="section-header">
                <h3 class="section-title">
                    <i class="fas fa-code-merge"></i> Open Merge Requests
                </h3>
            </div>
            <div class="section-content">
                <ul class="branch-list">
                    {% for mr in merge_requests %}
                        <li class="merge-request-item">
                            <div class="merge-request-info">
                                <div class="merge-request-title">{{ mr.title }}</div>
                                <div class="merge-request-meta">
                                    Created by {{ mr.created_by.username }} • 
                                    {{ mr.created_at|date:"M d, Y H:i" }}
                                </div>
                                <div class="merge-request-branches">
                                    {{ mr.source_branch.name }} → {{ mr.target_branch.name }}
                                </div>
                            </div>
                            <div class="version-actions">
                                <span class="status-badge status-{{ mr.status }}">{{ mr.get_status_display }}</span>
                                {% if mr.has_conflicts %}
                                    <span class="status-badge status-conflict">Conflicts</span>
                                {% endif %}
                                <button class="btn-sm btn-outline" onclick="viewMergeRequest('{{ mr.id }}')">
                                    <i class="fas fa-eye"></i> Review
                                </button>
                            </div>
                        </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        {% endif %}

        <!-- Diff Viewer (Hidden by default) -->
        <div class="diff-viewer" id="diff-viewer" style="display: none;">
            <div class="diff-header">
                <h4>Version Comparison</h4>
                <div>
                    <select id="diff-type" onchange="changeDiffType()">
                        <option value="unified">Unified Diff</option>
                        <option value="side_by_side">Side by Side</option>
                        <option value="word_level">Word Level</option>
                        <option value="semantic">Semantic</option>
                    </select>
                    <button class="btn-sm btn-outline" onclick="closeDiffViewer()">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
            </div>
            <div class="diff-content" id="diff-content">
                <!-- Diff content will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Create Version Modal -->
<div id="createVersionModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h4>Create New Version</h4>
            <button class="close" onclick="closeModal('createVersionModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="createVersionForm">
                <div class="form-group">
                    <label class="form-label">Commit Message</label>
                    <input type="text" class="form-control" id="commitMessage" placeholder="Describe your changes..." required>
                </div>
                <div class="form-group">
                    <label class="form-label">Version Tag (optional)</label>
                    <input type="text" class="form-control" id="versionTag" placeholder="e.g., Initial Draft, Final Version">
                </div>
                <div class="form-group">
                    <label class="form-label">Branch</label>
                    <select class="form-control" id="branchName">
                        <option value="main">main</option>
                        {% for branch in branches %}
                            {% if branch.name != 'main' %}
                                <option value="{{ branch.name }}">{{ branch.name }}</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="isMajor"> Major Version
                    </label>
                </div>
                <div style="text-align: right; margin-top: 1.5rem;">
                    <button type="button" class="btn-secondary" onclick="closeModal('createVersionModal')">Cancel</button>
                    <button type="submit" class="btn-primary">Create Version</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Create Branch Modal -->
<div id="createBranchModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h4>Create New Branch</h4>
            <button class="close" onclick="closeModal('createBranchModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="createBranchForm">
                <div class="form-group">
                    <label class="form-label">Branch Name</label>
                    <input type="text" class="form-control" id="branchNameInput" placeholder="feature/new-section" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-control" id="branchDescription" rows="3" placeholder="Describe the purpose of this branch..."></textarea>
                </div>
                <div style="text-align: right; margin-top: 1.5rem;">
                    <button type="button" class="btn-secondary" onclick="closeModal('createBranchModal')">Cancel</button>
                    <button type="submit" class="btn-primary">Create Branch</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Version Control Dashboard JavaScript
const manuscriptId = {{ manuscript.id }};
let currentDiffVersions = null;

// Modal functions
function openModal(modalId) {
    document.getElementById(modalId).style.display = 'block';
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

// Version management functions
function createVersion() {
    openModal('createVersionModal');
}

function createBranch() {
    openModal('createBranchModal');
}

function loadVersionHistory() {
    window.location.href = `{% url 'writer:version-history' manuscript.id %}`;
}

function viewDiff(versionId) {
    // For simplicity, compare with previous version
    // In a full implementation, you'd have a version selection interface
    const versionItems = document.querySelectorAll('.version-item');
    const currentIndex = Array.from(versionItems).findIndex(item => 
        item.querySelector('.version-actions button').onclick.toString().includes(versionId)
    );
    
    if (currentIndex < versionItems.length - 1) {
        const previousVersionButton = versionItems[currentIndex + 1].querySelector('.version-actions button');
        const previousVersionId = previousVersionButton.onclick.toString().match(/'([^']+)'/)[1];
        
        loadDiff(previousVersionId, versionId);
    } else {
        alert('No previous version to compare with');
    }
}

function loadDiff(fromVersionId, toVersionId) {
    currentDiffVersions = { from: fromVersionId, to: toVersionId };
    
    const diffType = document.getElementById('diff-type').value;
    
    fetch(`/writer/api/version/${manuscriptId}/diff/${fromVersionId}/${toVersionId}/?type=${diffType}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('diff-content').innerHTML = data.diff.html;
                document.getElementById('diff-viewer').style.display = 'block';
            } else {
                alert('Error loading diff: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading diff');
        });
}

function changeDiffType() {
    if (currentDiffVersions) {
        loadDiff(currentDiffVersions.from, currentDiffVersions.to);
    }
}

function closeDiffViewer() {
    document.getElementById('diff-viewer').style.display = 'none';
    currentDiffVersions = null;
}

function rollbackToVersion(versionId) {
    if (confirm('Are you sure you want to rollback to this version? This will create a new version with the content from the selected version.')) {
        fetch(`/writer/api/version/${manuscriptId}/rollback/${versionId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Rollback successful! New version created: ' + data.rollback_version.version_number);
                location.reload();
            } else {
                alert('Error during rollback: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error during rollback');
        });
    }
}

function createMergeRequest(sourceBranchId) {
    // Simplified - in a full implementation, you'd have a modal for merge request details
    const title = prompt('Enter merge request title:');
    if (title) {
        fetch(`/writer/api/merge/${manuscriptId}/create/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                title: title,
                source_branch_id: sourceBranchId,
                target_branch_id: 'main',  // Assuming merge to main
                description: ''
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Merge request created successfully!');
                location.reload();
            } else {
                alert('Error creating merge request: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error creating merge request');
        });
    }
}

function viewBranch(branchId) {
    // Navigate to branch view
    alert('Branch view not implemented yet');
}

function viewMergeRequest(mergeRequestId) {
    // Navigate to merge request view
    alert('Merge request view not implemented yet');
}

// Form submissions
document.getElementById('createVersionForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = {
        commit_message: document.getElementById('commitMessage').value,
        version_tag: document.getElementById('versionTag').value,
        branch_name: document.getElementById('branchName').value,
        is_major: document.getElementById('isMajor').checked
    };
    
    fetch(`/writer/api/version/${manuscriptId}/create/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Version created successfully: v' + data.version.version_number);
            closeModal('createVersionModal');
            location.reload();
        } else {
            alert('Error creating version: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error creating version');
    });
});

document.getElementById('createBranchForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = {
        name: document.getElementById('branchNameInput').value,
        description: document.getElementById('branchDescription').value
    };
    
    fetch(`/writer/api/branch/${manuscriptId}/create/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Branch created successfully: ' + data.branch.name);
            closeModal('createBranchModal');
            location.reload();
        } else {
            alert('Error creating branch: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error creating branch');
    });
});

// Utility function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Close modals when clicking outside
window.onclick = function(event) {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    });
}
</script>
{% endblock %}