{% extends "cloud_app/base.html" %}
{% load static %}

{% block title %}Reset Password - SciTeX{% endblock %}

{% block meta_description %}Reset your SciTeX account password{% endblock %}

{% block extra_css %}
<style>
  .login-header {
    background-color: #eef2ff;
    padding: 3rem 0;
    margin-bottom: 3rem;
    border-radius: 0 0 8px 8px;
  }

  .login-container {
    max-width: 500px;
    margin: 0 auto;
    padding-bottom: 4rem;
  }

  .auth-form {
    background-color: #fff;
    border-radius: 8px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    padding: 2rem;
    margin-bottom: 2rem;
  }

  .form-message {
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1.5rem;
    display: none;
  }

  .form-message.success {
    background-color: rgba(46, 204, 113, 0.1);
    color: #27ae60;
    border: 1px solid rgba(46, 204, 113, 0.3);
  }

  .form-message.error {
    background-color: rgba(231, 76, 60, 0.1);
    color: #e74c3c;
    border: 1px solid rgba(231, 76, 60, 0.3);
  }

  .form-message.warning {
    background-color: rgba(241, 196, 15, 0.1);
    color: #f39c12;
    border: 1px solid rgba(241, 196, 15, 0.3);
  }
</style>
{% endblock %}

{% block cloud_content %}
<div class="login-header">
  <div class="container">
    <h1 class="display-4 text-center">Reset Your Password</h1>
    <p class="lead text-center">{% if valid_link %}Enter your new password below{% else %}This link is invalid or has expired{% endif %}</p>
  </div>
</div>

<div class="container login-container">
  <div class="auth-form">
    {% if valid_link %}
    <h2 class="mb-4">Set New Password</h2>

    <div class="form-message success" id="successMessage">
      <p><strong>Success!</strong> Password reset successful! Redirecting to login...</p>
    </div>

    <div class="form-message error" id="errorMessage">
      <p><strong>Error:</strong> <span id="error-text"></span></p>
    </div>

    <form id="reset-password-form" method="post" onsubmit="return handleResetPassword(event)">
      {% csrf_token %}
      <input type="hidden" name="uidb64" value="{{ uidb64 }}">
      <input type="hidden" name="token" value="{{ token }}">

      <div class="form-group mb-3">
        <label for="password" class="form-label">New Password <span class="text-danger">*</span></label>
        <div class="input-group">
          <input type="password" class="form-control" id="password" name="password" minlength="8" required>
          <button class="btn btn-outline-secondary" type="button" id="togglePassword">
            <i class="fas fa-eye" id="togglePasswordIcon"></i>
          </button>
        </div>
        <small class="form-text text-muted">Minimum 8 characters</small>
      </div>

      <div class="form-group mb-3">
        <label for="confirm_password" class="form-label">Confirm Password <span class="text-danger">*</span></label>
        <div class="input-group">
          <input type="password" class="form-control" id="confirm_password" name="confirm_password" required>
          <button class="btn btn-outline-secondary" type="button" id="toggleConfirmPassword">
            <i class="fas fa-eye" id="toggleConfirmPasswordIcon"></i>
          </button>
        </div>
      </div>

      <button type="submit" class="btn btn-primary w-100">
        <i class="fas fa-key"></i> Reset Password
      </button>
    </form>

    {% else %}
    <div class="form-message warning" style="display: block;">
      <p><strong>Invalid Link:</strong> This password reset link is invalid or has expired.</p>
      <p class="mb-0">Please request a new password reset.</p>
    </div>
    {% endif %}

    <div class="text-center mt-3">
      <p>Remember your password? <a href="{% url 'cloud_app:login' %}">Log In</a></p>
      <p>Need a new reset link? <a href="{% url 'cloud_app:forgot-password' %}">Request Password Reset</a></p>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function handleResetPassword(event) {
    event.preventDefault();

    const form = event.target;
    const password = form.password.value;
    const confirmPassword = form.confirm_password.value;
    const uidb64 = form.uidb64.value;
    const token = form.token.value;
    const successMessage = document.getElementById('successMessage');
    const errorMessage = document.getElementById('errorMessage');
    const errorText = document.getElementById('error-text');

    // Hide messages
    successMessage.style.display = 'none';
    errorMessage.style.display = 'none';

    // Validate passwords match
    if (password !== confirmPassword) {
        errorText.textContent = 'Passwords do not match';
        errorMessage.style.display = 'block';
        return false;
    }

    // Disable submit button
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Resetting...';
    submitBtn.disabled = true;

    // Call API to reset password
    fetch('/api/v1/auth/reset-password/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            uidb64: uidb64,
            token: token,
            password: password
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            successMessage.style.display = 'block';
            form.reset();

            // Redirect to login after 2 seconds
            setTimeout(() => {
                window.location.href = '{% url "cloud_app:login" %}';
            }, 2000);
        } else {
            // Show error message
            errorText.textContent = data.error || 'An error occurred. Please try again.';
            errorMessage.style.display = 'block';
        }
    })
    .catch(error => {
        errorText.textContent = 'An error occurred. Please try again.';
        errorMessage.style.display = 'block';
    })
    .finally(() => {
        // Re-enable submit button
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });

    return false;
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Password visibility toggle
document.addEventListener('DOMContentLoaded', function() {
    const togglePassword = document.getElementById('togglePassword');
    const passwordInput = document.getElementById('password');
    const togglePasswordIcon = document.getElementById('togglePasswordIcon');

    if (togglePassword && passwordInput && togglePasswordIcon) {
        togglePassword.addEventListener('click', function() {
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);

            if (type === 'password') {
                togglePasswordIcon.classList.remove('fa-eye-slash');
                togglePasswordIcon.classList.add('fa-eye');
            } else {
                togglePasswordIcon.classList.remove('fa-eye');
                togglePasswordIcon.classList.add('fa-eye-slash');
            }
        });
    }

    const toggleConfirmPassword = document.getElementById('toggleConfirmPassword');
    const confirmPasswordInput = document.getElementById('confirm_password');
    const toggleConfirmPasswordIcon = document.getElementById('toggleConfirmPasswordIcon');

    if (toggleConfirmPassword && confirmPasswordInput && toggleConfirmPasswordIcon) {
        toggleConfirmPassword.addEventListener('click', function() {
            const type = confirmPasswordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            confirmPasswordInput.setAttribute('type', type);

            if (type === 'password') {
                toggleConfirmPasswordIcon.classList.remove('fa-eye-slash');
                toggleConfirmPasswordIcon.classList.add('fa-eye');
            } else {
                toggleConfirmPasswordIcon.classList.remove('fa-eye');
                toggleConfirmPasswordIcon.classList.add('fa-eye-slash');
            }
        });
    }
});
</script>
{% endblock %}
