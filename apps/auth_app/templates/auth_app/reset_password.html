{% extends "auth_app/auth_base.html" %}
{% load static %}
{% block title %}
    Reset
    Password - SciTeX
{% endblock %}
{% block meta_description %}
    Reset your SciTeX
    account password
{% endblock %}
{% block auth_extra_css %}{% endblock %}
{%
block auth_content %}
<div class="auth-header">
    <div class="container">
        <h1 class="display-4 text-center">Reset Your Password</h1>
        <p class="lead text-center">
            {% if valid_link %}
                Enter your new password below
            {% else %}
                This link is
                invalid or has expired
            {% endif %}
        </p>
    </div>
</div>
<div class="container auth-container">
    <div class="auth-form">
        {% if valid_link %}
            <h2 class="mb-4">Set New Password</h2>
            <div class="alert-banner alert-banner-success"
                 id="successMessage"
                 style="display: none;
                        margin-bottom: var(--spacing-md)">
                <div class="warning-banner-container">
                    <div class="warning-banner-content">
                        <i class="warning-banner-icon fas fa-check-circle"></i>
                        <div class="warning-banner-text">
                            <div class="warning-banner-title">Success!</div>
                            <div class="warning-banner-description">Password reset successful! Redirecting to login...</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="alert-banner alert-banner-danger"
                 id="errorMessage"
                 style="display: none;
                        margin-bottom: var(--spacing-md)">
                <div class="warning-banner-container">
                    <div class="warning-banner-content">
                        <i class="warning-banner-icon fas fa-exclamation-circle"></i>
                        <div class="warning-banner-text">
                            <div class="warning-banner-title">Error</div>
                            <div class="warning-banner-description" id="error-text"></div>
                        </div>
                    </div>
                </div>
            </div>
            <form id="reset-password-form" method="post">
                {% csrf_token %}
                <div class="form-group mb-2">
                    <label for="new_password" class="form-label">
                        New Password <span class="text-danger">*</span>
                    </label>
                    <div class="input-group">
                        <input type="password"
                               class="form-control"
                               id="new_password"
                               name="new_password"
                               minlength="8"
                               required />
                        <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                            <i class="fas fa-eye" id="togglePasswordIcon"></i>
                        </button>
                    </div>
                </div>
                <div class="form-group mb-2">
                    <label for="confirm_password" class="form-label">
                        Confirm Password <span class="text-danger">*</span>
                    </label>
                    <div class="input-group">
                        <input type="password"
                               class="form-control"
                               id="confirm_password"
                               name="confirm_password"
                               minlength="8"
                               required />
                        <button class="btn btn-outline-secondary"
                                type="button"
                                id="toggleConfirmPassword">
                            <i class="fas fa-eye" id="toggleConfirmPasswordIcon"></i>
                        </button>
                    </div>
                </div>
                <!-- Password Requirements -->
                <div class="password-rules mb-3">
                    <div class="password-rules-title">Password Requirements:</div>
                    <div class="password-rule invalid" id="rule-length">
                        <i class="fas fa-times"></i> At least 8 characters
                    </div>
                    <div class="password-rule invalid" id="rule-lowercase">
                        <i class="fas fa-times"></i> At least one lowercase letter
                    </div>
                    <div class="password-rule invalid" id="rule-uppercase">
                        <i class="fas fa-times"></i> At least one uppercase letter
                    </div>
                    <div class="password-rule invalid" id="rule-number">
                        <i class="fas fa-times"></i> At least one number
                    </div>
                    <div class="password-rule invalid" id="rule-special">
                        <i class="fas fa-times"></i> At least one special character (!@#$%^&*)
                    </div>
                    <div class="password-rule invalid" id="rule-match">
                        <i class="fas fa-times"></i> Passwords match
                    </div>
                </div>
                <button type="submit" class="btn btn-primary w-100">
                    <i class="fas fa-key"></i> Reset Password
                </button>
            </form>
        {% else %}
            <div class="alert-banner alert-banner-warning"
                 style="margin-bottom: var(--spacing-md)">
                <div class="warning-banner-container">
                    <div class="warning-banner-content">
                        <i class="warning-banner-icon fas fa-exclamation-triangle"></i>
                        <div class="warning-banner-text">
                            <div class="warning-banner-title">Invalid Link</div>
                            <div class="warning-banner-description">
                                This password reset link is invalid or has expired.
                                <br />
                                Please request a new password reset.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
        <div class="text-center mt-3">
            <p>
                Remember your password? <a href="{% url 'auth_app:login' %}">Log In</a>
            </p>
            <p>
                Need a new reset link?
                <a href="{% url 'auth_app:forgot-password' %}">Request Password Reset</a>
            </p>
        </div>
    </div>
</div>
{% endblock %}
{% block auth_extra_js %}
    <script>
  document.addEventListener("DOMContentLoaded", function () {
    // Password visibility toggles
    const togglePassword = document.getElementById("togglePassword");
    const passwordInput = document.getElementById("new_password");
    const togglePasswordIcon = document.getElementById("togglePasswordIcon");

    const toggleConfirmPassword = document.getElementById(
      "toggleConfirmPassword",
    );
    const confirmPasswordInput = document.getElementById("confirm_password");
    const toggleConfirmPasswordIcon = document.getElementById(
      "toggleConfirmPasswordIcon",
    );

    // Main password toggle
    if (togglePassword && passwordInput && togglePasswordIcon) {
      togglePassword.addEventListener("click", function () {
        const type =
          passwordInput.getAttribute("type") === "password"
            ? "text"
            : "password";
        passwordInput.setAttribute("type", type);

        // Toggle the eye icon
        if (type === "password") {
          togglePasswordIcon.classList.remove("fa-eye-slash");
          togglePasswordIcon.classList.add("fa-eye");
        } else {
          togglePasswordIcon.classList.remove("fa-eye");
          togglePasswordIcon.classList.add("fa-eye-slash");
        }
      });
    }

    // Confirm password toggle
    if (
      toggleConfirmPassword &&
      confirmPasswordInput &&
      toggleConfirmPasswordIcon
    ) {
      toggleConfirmPassword.addEventListener("click", function () {
        const type =
          confirmPasswordInput.getAttribute("type") === "password"
            ? "text"
            : "password";
        confirmPasswordInput.setAttribute("type", type);

        // Toggle the eye icon
        if (type === "password") {
          toggleConfirmPasswordIcon.classList.remove("fa-eye-slash");
          toggleConfirmPasswordIcon.classList.add("fa-eye");
        } else {
          toggleConfirmPasswordIcon.classList.remove("fa-eye");
          toggleConfirmPasswordIcon.classList.add("fa-eye-slash");
        }
      });
    }

    // Password requirements validation
    const ruleLength = document.getElementById("rule-length");
    const ruleLowercase = document.getElementById("rule-lowercase");
    const ruleUppercase = document.getElementById("rule-uppercase");
    const ruleNumber = document.getElementById("rule-number");
    const ruleSpecial = document.getElementById("rule-special");
    const ruleMatch = document.getElementById("rule-match");

    // Helper function to update rule state
    function updatePasswordRule(element, isValid) {
      element.classList.remove("valid", "invalid");
      if (isValid) {
        element.classList.add("valid");
        element.querySelector("i").className = "fas fa-check";
      } else {
        // Invalid state: red X (default)
        element.classList.add("invalid");
        element.querySelector("i").className = "fas fa-times";
      }
    }

    // Helper function to check password match
    function checkPasswordMatch() {
      const password = passwordInput.value;
      const confirmPass = confirmPasswordInput.value;
      const hasInput = password.length > 0 && confirmPass.length > 0;
      const passwordsMatch = password === confirmPass && password.length > 0;

      updatePasswordRule(ruleMatch, passwordsMatch);
    }

    // Check password strength
    if (passwordInput) {
      passwordInput.addEventListener("input", function () {
        const password = this.value;

        // Check each requirement
        updatePasswordRule(ruleLength, password.length >= 8);
        updatePasswordRule(ruleLowercase, /[a-z]/.test(password));
        updatePasswordRule(ruleUppercase, /[A-Z]/.test(password));
        updatePasswordRule(ruleNumber, /\d/.test(password));
        updatePasswordRule(
          ruleSpecial,
          /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password),
        );

        // Check if passwords match
        checkPasswordMatch();
      });
    }

    // Check password match when confirm password changes
    if (confirmPasswordInput) {
      confirmPasswordInput.addEventListener("input", function () {
        checkPasswordMatch();
      });
    }
  });
    </script>
{% endblock %}
