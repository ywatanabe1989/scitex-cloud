{% extends "auth_app/auth_base.html" %}
{% load static %}

{% block title %}Create an Account - SciTeX{% endblock %}

{% block meta_description %}Join SciTeX - the open-source platform for scientific research. Create your free account to get started with managing, analyzing, and publishing your research.{% endblock %}

{% block auth_extra_css %}
<style>
  .benefits-list {
    margin-top: 3rem;
  }

  .col-lg-5 h3 {
    color: var(--text-800);
  }
  
  .benefit-item {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
    align-items: flex-start;
  }

  .benefit-item h4 {
    color: var(--text-800);
  }

  .benefit-item p {
    color: var(--text-700);
  }
  
  .benefit-icon {
    font-size: 1.5rem;
    color: var(--btn-primary-bg);
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: var(--bg-300);
    border-radius: 50%;
    flex-shrink: 0;
  }
  
  .password-rules {
    background-color: var(--color-canvas-subtle);
    border: 1px solid var(--color-border-default);
    border-radius: 8px;
    padding: 1rem;
    font-size: 0.9rem;
  }

  .password-rules-title {
    font-weight: 600;
    color: var(--color-fg-default);
    margin-bottom: 0.5rem;
    font-size: 0.95rem;
  }

  .password-rule {
    margin-bottom: 0.4rem;
    color: var(--color-fg-muted);
    display: flex;
    align-items: center;
  }

  .password-rule.valid {
    color: var(--scitex-success);
  }

  .password-rule i {
    margin-right: 0.5rem;
    width: 16px;
    font-size: 0.75rem;
  }
</style>
{% endblock %}

{% block auth_content %}
<div class="auth-header">
  <div class="container">
    <h1 class="display-4 text-center">Create Your SciTeX Account</h1>
    <p class="lead text-center">Join our open-source scientific research platform - completely free</p>
  </div>
</div>

<div class="container auth-container" style="max-width: 900px;">
  <div class="row">
    <div class="col-lg-7">
      <div class="auth-form">
        <h2 class="mb-4">Sign Up</h2>
        
        <div class="form-message success">
          <p><strong>Account created successfully!</strong> You can now log in and start using SciTeX.</p>
        </div>
        
        {% if form.errors %}
        <div class="form-message error" style="display: block;">
          <p><strong>Error:</strong></p>
          <ul class="mb-0">
            {% for field, errors in form.errors.items %}
              {% for error in errors %}
                <li>{{ error }}</li>
              {% endfor %}
            {% endfor %}
          </ul>
        </div>
        {% endif %}
        
        {% if messages %}
          {% for message in messages %}
            <div class="form-message {% if message.tags == 'error' %}error{% else %}success{% endif %}" style="display: block;">
              <p>{{ message }}</p>
            </div>
          {% endfor %}
        {% endif %}
        
        <div class="form-message error" id="js-error-message">
          <p><strong>Error:</strong> <span id="error-message">Something went wrong. Please try again.</span></p>
        </div>
        
        <form id="signup-form" method="post" action="{% url 'auth_app:signup' %}" autocomplete="on">
          {% csrf_token %}
          <div class="form-group mb-3">
            <label for="{{ form.username.id_for_label }}" class="form-label">Username <span class="text-danger">*</span></label>
            {{ form.username }}
            <div class="form-text">
              <strong>Choose a unique username</strong> (like GitHub: letters, numbers, hyphens, underscores).<br>
              <small class="text-muted">Your profile URL will be: scitex.ai/<span id="username-preview">username</span></small>
            </div>
            {% if form.username.errors %}
              <div class="text-danger small">{{ form.username.errors.0 }}</div>
            {% endif %}
          </div>
          
          <div class="form-group mb-3">
            <label for="{{ form.email.id_for_label }}" class="form-label">Email <span class="text-danger">*</span></label>
            {{ form.email }}
            <div class="form-text">We'll never share your email with anyone else.</div>
            {% if form.email.errors %}
              <div class="text-danger small">{{ form.email.errors.0 }}</div>
            {% endif %}
            
            <!-- Japanese Academic Benefits Alert -->
            <div class="alert alert-info academic-benefits" style="display: none; margin-top: 0.75rem;">
              <h6 class="alert-heading mb-2">
                <i class="fas fa-graduation-cap me-2"></i>日本の学術機関の特典 (Japanese Academic Benefits)
              </h6>
              <div class="small">
                <strong>Japanese academic email detected!</strong> You'll receive:
                <ul class="mb-1 mt-1">
                  <li>Priority support in Japanese (日本語サポート)</li>
                  <li>Early access to new features</li>
                  <li>Special academic collaboration features</li>
                  <li>Enhanced storage limits</li>
                </ul>
                <em>Recognized domains: .ac.jp (academic), .go.jp (government research), .riken.jp, .jaxa.jp, and more</em>
              </div>
            </div>
          </div>
          
          <div class="form-group mb-2">
            <label for="{{ form.password.id_for_label }}" class="form-label">Password <span class="text-danger">*</span></label>
            <div class="input-group">
              {{ form.password }}
              <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                <i class="fas fa-eye" id="togglePasswordIcon"></i>
              </button>
            </div>
            {% if form.password.errors %}
              <div class="text-danger small">{{ form.password.errors.0 }}</div>
            {% endif %}
          </div>

          <div class="form-group mb-2">
            <label for="{{ form.password2.id_for_label }}" class="form-label">Confirm Password <span class="text-danger">*</span></label>
            <div class="input-group">
              {{ form.password2 }}
              <button class="btn btn-outline-secondary" type="button" id="toggleConfirmPassword">
                <i class="fas fa-eye" id="toggleConfirmPasswordIcon"></i>
              </button>
            </div>
            {% if form.password2.errors %}
              <div class="text-danger small">{{ form.password2.errors.0 }}</div>
            {% endif %}
          </div>

          <!-- Password Requirements -->
          <div class="password-rules mb-3">
            <div class="password-rules-title">Password Requirements:</div>
            <div class="password-rule" id="rule-length"><i class="fas fa-circle"></i> At least 8 characters</div>
            <div class="password-rule" id="rule-lowercase"><i class="fas fa-circle"></i> At least one lowercase letter</div>
            <div class="password-rule" id="rule-uppercase"><i class="fas fa-circle"></i> At least one uppercase letter</div>
            <div class="password-rule" id="rule-number"><i class="fas fa-circle"></i> At least one number</div>
            <div class="password-rule" id="rule-special"><i class="fas fa-circle"></i> At least one special character (!@#$%^&*)</div>
          </div>

          <div class="form-check mb-3">
            {{ form.agree_terms }}
            <label class="form-check-label" for="{{ form.agree_terms.id_for_label }}">
              I agree to the <a href="/terms/" target="_blank">Terms of Use</a> and <a href="/privacy/" target="_blank">Privacy Policy</a>
            </label>
            {% if form.agree_terms.errors %}
              <div class="text-danger small">{{ form.agree_terms.errors.0 }}</div>
            {% endif %}
          </div>
          
          <button type="submit" class="btn btn-primary w-100">Create Account</button>
        </form>
        
        <div class="text-center mt-3">
          <p>Already have an account? <a href="{% url 'auth_app:login' %}">Log In</a></p>
        </div>
      </div>
    </div>
    
    <div class="col-lg-5">
      <h3>Why Join SciTeX?</h3>
      <div class="benefits-list">
        <div class="benefit-item">
          <div class="benefit-icon"><i class="fas fa-infinity"></i></div>
          <div>
            <h4>100% Free & Open Source</h4>
            <p>SciTeX is completely free to use and all our code is open source. No hidden fees or paid tiers.</p>
          </div>
        </div>
        
        <div class="benefit-item">
          <div class="benefit-icon"><i class="fas fa-tools"></i></div>
          <div>
            <h4>Complete Research Toolkit</h4>
            <p>Access our integrated suite of tools for document management, data analysis, and publishing.</p>
          </div>
        </div>
        
        <div class="benefit-item">
          <div class="benefit-icon"><i class="fas fa-users"></i></div>
          <div>
            <h4>Join the Community</h4>
            <p>Become part of a growing community of researchers sharing knowledge and collaborating.</p>
          </div>
        </div>
        
        <div class="benefit-item">
          <div class="benefit-icon"><i class="fas fa-code-branch"></i></div>
          <div>
            <h4>Contribute & Customize</h4>
            <p>Help shape the platform by contributing or customize it to fit your specific research needs.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block auth_extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('signup-form');
    const passwordInput = document.getElementById('id_password');
    const confirmPassword = document.getElementById('id_password2');
    const usernameInput = document.getElementById('id_username');
    const emailInput = document.getElementById('id_email');
    const successMessage = document.querySelector('.form-message.success');
    const errorMessage = document.getElementById('js-error-message');
    const errorText = document.getElementById('error-message');
    const academicBenefits = document.querySelector('.academic-benefits');
    const usernamePreview = document.getElementById('username-preview');

    // Update username preview as user types
    usernameInput.addEventListener('input', function() {
      const username = this.value || 'username';
      usernamePreview.textContent = username;
    });
    
    // Japanese academic domains (synced with backend)
    const japaneseAcademicDomains = [
      // Japanese Academic (.ac.jp) - All academic institutions
      '.ac.jp',
      '.u-tokyo.ac.jp', '.kyoto-u.ac.jp', '.osaka-u.ac.jp',
      '.tohoku.ac.jp', '.nagoya-u.ac.jp', '.kyushu-u.ac.jp',
      '.hokudai.ac.jp', '.tsukuba.ac.jp', '.hiroshima-u.ac.jp',
      '.kobe-u.ac.jp', '.waseda.jp', '.keio.ac.jp',
      
      // Government Research Institutions (.go.jp)
      '.go.jp',  // Broader government research support
      '.riken.jp', '.aist.go.jp', '.nict.go.jp', '.jaxa.jp',
      '.jst.go.jp', '.nims.go.jp', '.nies.go.jp'
    ];
    
    // Check if email is Japanese academic (synced with backend logic)
    function isJapaneseAcademicEmail(email) {
      if (!email || !email.includes('@')) return false;
      const domain = email.toLowerCase().split('@')[1];
      
      // Check if domain matches exactly or ends with the academic domain
      for (const acadDomain of japaneseAcademicDomains) {
        const cleanDomain = acadDomain.replace(/^\./, '');
        if (domain === cleanDomain || domain.endsWith(acadDomain)) {
          return true;
        }
      }
      return false;
    }
    
    // Check email for Japanese academic domains
    emailInput.addEventListener('input', function() {
      const email = this.value;
      if (isJapaneseAcademicEmail(email)) {
        academicBenefits.style.display = 'block';
        academicBenefits.classList.add('animate__animated', 'animate__slideInDown');
      } else {
        academicBenefits.style.display = 'none';
      }
    });
    
    // Password validation rules
    const ruleLength = document.getElementById('rule-length');
    const ruleLowercase = document.getElementById('rule-lowercase');
    const ruleUppercase = document.getElementById('rule-uppercase');
    const ruleNumber = document.getElementById('rule-number');
    const ruleSpecial = document.getElementById('rule-special');
    
    // Check password strength
    passwordInput.addEventListener('input', function() {
      const password = this.value;
      
      // Check length
      if (password.length >= 8) {
        ruleLength.classList.add('valid');
        ruleLength.querySelector('i').className = 'fas fa-check';
      } else {
        ruleLength.classList.remove('valid');
        ruleLength.querySelector('i').className = 'fas fa-circle';
      }
      
      // Check for lowercase letters
      if (/[a-z]/.test(password)) {
        ruleLowercase.classList.add('valid');
        ruleLowercase.querySelector('i').className = 'fas fa-check';
      } else {
        ruleLowercase.classList.remove('valid');
        ruleLowercase.querySelector('i').className = 'fas fa-circle';
      }
      
      // Check for uppercase letters
      if (/[A-Z]/.test(password)) {
        ruleUppercase.classList.add('valid');
        ruleUppercase.querySelector('i').className = 'fas fa-check';
      } else {
        ruleUppercase.classList.remove('valid');
        ruleUppercase.querySelector('i').className = 'fas fa-circle';
      }
      
      // Check for numbers
      if (/\d/.test(password)) {
        ruleNumber.classList.add('valid');
        ruleNumber.querySelector('i').className = 'fas fa-check';
      } else {
        ruleNumber.classList.remove('valid');
        ruleNumber.querySelector('i').className = 'fas fa-circle';
      }
      
      // Check for special characters
      if (/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)) {
        ruleSpecial.classList.add('valid');
        ruleSpecial.querySelector('i').className = 'fas fa-check';
      } else {
        ruleSpecial.classList.remove('valid');
        ruleSpecial.querySelector('i').className = 'fas fa-circle';
      }
    });
    
    // Form submission validation
    form.addEventListener('submit', function(e) {
      // Hide previous messages
      successMessage.style.display = 'none';
      errorMessage.style.display = 'none';
      
      // Password strength validation
      const password = passwordInput.value;
      const passwordErrors = [];
      
      if (password.length < 8) {
        passwordErrors.push('at least 8 characters');
      }
      if (!/[a-z]/.test(password)) {
        passwordErrors.push('at least one lowercase letter');
      }
      if (!/[A-Z]/.test(password)) {
        passwordErrors.push('at least one uppercase letter');
      }
      if (!/\d/.test(password)) {
        passwordErrors.push('at least one number');
      }
      if (!/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)) {
        passwordErrors.push('at least one special character');
      }
      
      if (passwordErrors.length > 0) {
        e.preventDefault();
        errorText.textContent = `Password must contain ${passwordErrors.join(', ')}.`;
        errorMessage.style.display = 'block';
        return;
      }
      
      // Password match validation
      if (password !== confirmPassword.value) {
        e.preventDefault();
        errorText.textContent = 'Passwords do not match.';
        errorMessage.style.display = 'block';
        return;
      }
      
      // If validation passes, allow form to submit normally to Django
    });
  });
  
  // Password visibility toggles - separate event listener
  document.addEventListener('DOMContentLoaded', function() {
    const togglePassword = document.getElementById('togglePassword');
    const passwordInput = document.getElementById('id_password');
    const togglePasswordIcon = document.getElementById('togglePasswordIcon');
    
    const toggleConfirmPassword = document.getElementById('toggleConfirmPassword');
    const confirmPasswordInput = document.getElementById('id_password2');
    const toggleConfirmPasswordIcon = document.getElementById('toggleConfirmPasswordIcon');
    
    // Main password toggle
    if (togglePassword && passwordInput && togglePasswordIcon) {
      togglePassword.addEventListener('click', function() {
        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordInput.setAttribute('type', type);
        
        // Toggle the eye icon
        if (type === 'password') {
          togglePasswordIcon.classList.remove('fa-eye-slash');
          togglePasswordIcon.classList.add('fa-eye');
        } else {
          togglePasswordIcon.classList.remove('fa-eye');
          togglePasswordIcon.classList.add('fa-eye-slash');
        }
      });
    }
    
    // Confirm password toggle
    if (toggleConfirmPassword && confirmPasswordInput && toggleConfirmPasswordIcon) {
      toggleConfirmPassword.addEventListener('click', function() {
        const type = confirmPasswordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        confirmPasswordInput.setAttribute('type', type);
        
        // Toggle the eye icon
        if (type === 'password') {
          toggleConfirmPasswordIcon.classList.remove('fa-eye-slash');
          toggleConfirmPasswordIcon.classList.add('fa-eye');
        } else {
          toggleConfirmPasswordIcon.classList.remove('fa-eye');
          toggleConfirmPasswordIcon.classList.add('fa-eye-slash');
        }
      });
    }
  });
</script>
{% endblock %}