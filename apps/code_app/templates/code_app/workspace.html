{% extends "global_base.html" %}
{% load static %}

{% block title %}SciTeX Code{% if current_project %} - {{ current_project.name }}{% endif %}{% endblock %}

{% block extra_head %}
  <!-- Disable caching for development -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
{% endblock %}

{% block extra_css %}
  <!-- Shared sidebar styles from project_app for consistency -->
  <link rel="stylesheet" href="{% static 'project_app/css/shared/sidebar.css' %}" />
  <!-- Shared workspace files tree component -->
  <link rel="stylesheet" href="{% static 'shared/css/components/workspace-files-tree.css' %}" />

  <!-- Code Workspace CSS Modules (refactored from monolithic workspace.css) -->
  <link rel="stylesheet" href="{% static 'code_app/css/workspace/00-workspace.css' %}" />
  <link rel="stylesheet" href="{% static 'code_app/css/workspace/01-theme-colors.css' %}" />
  <link rel="stylesheet" href="{% static 'code_app/css/workspace/02-layout.css' %}" />
  <link rel="stylesheet" href="{% static 'code_app/css/workspace/03-sidebar.css' %}" />
  <link rel="stylesheet" href="{% static 'code_app/css/workspace/04-editor-area.css' %}" />
  <link rel="stylesheet" href="{% static 'code_app/css/workspace/05-file-tabs.css' %}" />
  <link rel="stylesheet" href="{% static 'code_app/css/workspace/06-terminal-panel.css' %}" />
  <link rel="stylesheet" href="{% static 'code_app/css/workspace/07-sidebar-header.css' %}" />
  <link rel="stylesheet" href="{% static 'code_app/css/workspace/08-sidebar-signup.css' %}" />
  <link rel="stylesheet" href="{% static 'code_app/css/workspace/09-toolbar.css' %}" />
  <link rel="stylesheet" href="{% static 'code_app/css/workspace/10-terminal-header.css' %}" />
  <link rel="stylesheet" href="{% static 'code_app/css/workspace/11-terminal-tabs.css' %}" />
  <link rel="stylesheet" href="{% static 'code_app/css/workspace/12-terminal-instances.css' %}" />
  <link rel="stylesheet" href="{% static 'code_app/css/workspace/13-toolbar-buttons.css' %}" />
  <link rel="stylesheet" href="{% static 'code_app/css/workspace/14-monaco-editor.css' %}" />
  <link rel="stylesheet" href="{% static 'code_app/css/workspace/15-xterm.css' %}" />
  <link rel="stylesheet" href="{% static 'code_app/css/workspace/16-welcome-screen.css' %}" />
  <link rel="stylesheet" href="{% static 'code_app/css/workspace/17-folder-actions.css' %}" />
  <link rel="stylesheet" href="{% static 'code_app/css/workspace/18-dark-theme.css' %}" />
  <link rel="stylesheet" href="{% static 'code_app/css/workspace/19-folder-icon.css' %}" />
  <link rel="stylesheet" href="{% static 'code_app/css/workspace/20-file-tree.css' %}" />
  <link rel="stylesheet" href="{% static 'code_app/css/workspace/21-terminal-links.css' %}" />
  <link rel="stylesheet" href="{% static 'code_app/css/workspace/22-responsive.css' %}" />
  <link rel="stylesheet" href="{% static 'code_app/css/workspace/23-git-gutter.css' %}" />
  <link rel="stylesheet" href="{% static 'code_app/css/workspace/24-git-status.css' %}" />
  <link rel="stylesheet" href="{% static 'code_app/css/workspace/25-modal.css' %}" />

  <link rel="stylesheet" href="{% static 'code_app/css/workspace-inline.css' %}" />
  <link rel="stylesheet" href="{% static 'code_app/css/context-menu.css' %}" />
  <link rel="stylesheet" href="{% static 'code_app/css/file-modal.css' %}" />
  <!-- Monaco Editor CSS - Use cdnjs like writer app -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/editor/editor.main.min.css" />
  <!-- xterm.js for real PTY terminal -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
{% endblock %}

{% block extra_js %}
  <!-- Monaco Editor - Load with proper AMD handling -->
  <script>
    (function() {
      'use strict';

      // Save any existing AMD loaders
      var savedDefine = window.define;
      var savedRequire = window.require;

      // Clear AMD environment for Monaco
      delete window.define;
      delete window.require;

      // Load Monaco loader
      var loaderScript = document.createElement('script');
      loaderScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js';
      loaderScript.onload = function() {
        console.log('[Monaco] Loader loaded, configuring...');

        // Now require should be available from Monaco's loader
        if (typeof require === 'undefined') {
          console.error('[Monaco] require is still undefined after loader');
          return;
        }

        // Configure Monaco paths
        require.config({
          paths: {
            'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs'
          }
        });

        // Load Monaco editor main module with timeout and error handling
        var monacoLoadTimeout = setTimeout(function() {
          console.error('[Monaco] Loading timeout - require might have failed');
        }, 5000);

        try {
          require(['vs/editor/editor.main'], function() {
            clearTimeout(monacoLoadTimeout);
            console.log('[Monaco] Loaded successfully - window.monaco:', !!window.monaco);

            if (window.monaco) {
              window.monacoReady = true;
              window.dispatchEvent(new Event('monaco-ready'));
            } else {
              console.error('[Monaco] Loaded but window.monaco is undefined');
            }
          }, function(err) {
            clearTimeout(monacoLoadTimeout);
            console.error('[Monaco] Failed to load editor.main:', err);
          });
        } catch (err) {
          clearTimeout(monacoLoadTimeout);
          console.error('[Monaco] Exception during require call:', err);
        }
      };

      loaderScript.onerror = function() {
        console.error('[Monaco] Failed to load loader.min.js');
        // Restore original AMD loaders if Monaco fails
        if (savedDefine) window.define = savedDefine;
        if (savedRequire) window.require = savedRequire;
      };

      document.head.appendChild(loaderScript);
    })();
  </script>
{% endblock %}

{% block content %}
  <!-- Config data for TypeScript -->
  <div id="project-data"
       {% if current_project %}
       data-project-id="{{ current_project.id }}"
       data-project-name="{{ current_project.name }}"
       data-project-owner="{{ current_project.owner.username }}"
       data-project-slug="{{ current_project.slug }}"
       data-workspace-tree-url="/{{ current_project.owner.username }}/{{ current_project.slug }}/api/file-tree/"
       {% endif %}>
  </div>
  <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

  {% if pool_exhausted %}
    <!-- Visitor pool exhausted message -->
    <div class="code-workspace pool-message-wrapper">
      <div class="pool-message-content">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="pool-message-icon">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
        </svg>
        <h2 class="pool-message-title">Visitor Slots Full</h2>
        <p class="pool-message-text">
          All visitor demo slots are currently in use. Please try again in a few minutes, or <a href="/accounts/signup/" class="pool-message-link">sign up for a free account</a> to get full access.
        </p>
      </div>
    </div>
  {% elif pool_error %}
    <!-- Visitor pool error message -->
    <div class="code-workspace pool-message-wrapper">
      <div class="pool-message-content">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="pool-message-icon">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
        </svg>
        <h2 class="pool-message-title">Service Temporarily Unavailable</h2>
        <p class="pool-message-text">
          {{ pool_error_message }}
        </p>
        <p class="pool-message-text">
          Please <a href="/accounts/signup/" class="pool-message-link">sign up for a free account</a> to access the code workspace.
        </p>
      </div>
    </div>
  {% else %}
    <div class="code-workspace">
      <!-- Left Sidebar: File Tree -->
      <aside id="code-sidebar" class="code-sidebar repo-sidebar">
        <div class="sidebar-header">
          {% if current_project %}
            {% if current_project.owner.username|slice:":8" == "visitor-" %}
              <!-- Visitor: Show non-clickable project name with signup prompt -->
              <div class="sidebar-title-link sidebar-title-visitor">
                <div class="sidebar-visitor-project">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16">
                    <path fill="currentColor" d="M1.75 1A1.75 1.75 0 0 0 0 2.75v10.5C0 14.216.784 15 1.75 15h12.5A1.75 1.75 0 0 0 16 13.25v-8.5A1.75 1.75 0 0 0 14.25 3H7.5a.25.25 0 0 1-.2-.1l-.9-1.2C6.07 1.26 5.55 1 5 1H1.75Z"></path>
                  </svg>
                  <span>{{ current_project.name }}</span>
                </div>
                <a href="/accounts/signup/" class="sidebar-signup-link">
                  Create account to save files â†’
                </a>
              </div>
            {% else %}
              <!-- Authenticated user: Show clickable link -->
              <a href="/{{ current_project.owner.username }}/{{ current_project.slug }}/"
                 class="sidebar-title-link sidebar-title-auth"
                 title="{{ current_project.name }}">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16">
                  <path fill="currentColor" d="M1.75 1A1.75 1.75 0 0 0 0 2.75v10.5C0 14.216.784 15 1.75 15h12.5A1.75 1.75 0 0 0 16 13.25v-8.5A1.75 1.75 0 0 0 14.25 3H7.5a.25.25 0 0 1-.2-.1l-.9-1.2C6.07 1.26 5.55 1 5 1H1.75Z"></path>
                </svg>
                <span>{{ current_project.name }}</span>
              </a>
            {% endif %}
          {% else %}
            <div class="sidebar-title-link">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16">
                <path fill="currentColor" d="M1.75 1A1.75 1.75 0 0 0 0 2.75v10.5C0 14.216.784 15 1.75 15h12.5A1.75 1.75 0 0 0 16 13.25v-8.5A1.75 1.75 0 0 0 14.25 3H7.5a.25.25 0 0 1-.2-.1l-.9-1.2C6.07 1.26 5.55 1 5 1H1.75Z"></path>
              </svg>
              <span>No Project Selected</span>
            </div>
          {% endif %}
        </div>
      <div id="file-tree" class="file-tree-container">
        <div class="tree-loading">
          <i class="fas fa-spinner fa-spin"></i> Loading file tree...
        </div>
      </div>
    </aside>

    <!-- Resizer between sidebar and editor -->
    <div class="panel-resizer" id="sidebar-resizer"></div>

    <!-- Center: Editor Area -->
    <div class="code-editor-area">
      <!-- Toolbar -->
      <div class="code-toolbar">
        <button id="btn-save" class="btn-code-action" disabled title="Save (Ctrl+S)">
          <i class="fas fa-save"></i>
          <span>Save</span>
        </button>
        <button id="btn-commit" class="btn-code-action" title="Commit changes">
          <i class="fas fa-code-branch"></i>
          <span>Commit</span>
        </button>
        <button id="btn-run" class="btn-code-action" disabled title="Run Python script (Ctrl+Enter)">
          <i class="fas fa-play"></i>
          <span>Run</span>
        </button>
        <button id="btn-delete" class="btn-code-action" disabled title="Delete current file">
          <i class="fas fa-trash"></i>
        </button>
        <div class="code-toolbar-spacer"></div>
        <select id="keybinding-mode" class="btn-code-action" title="Editor keybindings">
          <option value="vscode">VS Code</option>
          <option value="vim">Vim</option>
          <option value="emacs" selected>Emacs</option>
        </select>
        <button id="monaco-theme-toggle" class="btn-code-action" title="Toggle editor theme">
          <span class="theme-icon">ðŸŒ™</span>
        </button>
        <button id="btn-editor-shortcuts" class="btn-code-action" title="Emacs Shortcuts">
          <i class="fas fa-keyboard"></i>
        </button>
      </div>

      <!-- File Tabs (below toolbar) -->
      <div id="file-tabs" class="file-tabs">
        <button id="btn-new-file-tab" class="file-tabs-plus-btn" title="New file">+</button>
      </div>

      <!-- Editor Container -->
      <div id="editor-container" class="code-editor-container">
        <!-- Welcome Screen (hidden by default - scratch buffer shown instead) -->
        <div id="welcome-screen" class="code-welcome">
          <svg class="code-welcome-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z" />
          </svg>
          <h2 class="code-welcome-title">Welcome to Code Workspace</h2>
          <p class="code-welcome-subtitle">A powerful editor with integrated terminal for your research projects</p>

          <div class="welcome-features-container">
            <div class="welcome-features-grid">
              <div class="welcome-feature-card">
                <div class="welcome-feature-header">
                  <i class="fas fa-file-code welcome-feature-icon"></i>
                  <strong>Multi-Language Support</strong>
                </div>
                <p class="welcome-feature-text">
                  Python, JavaScript, TypeScript, HTML, CSS, JSON, Markdown, and more
                </p>
              </div>

              <div class="welcome-feature-card">
                <div class="welcome-feature-header">
                  <i class="fas fa-terminal welcome-feature-icon"></i>
                  <strong>Integrated Terminal</strong>
                </div>
                <p class="welcome-feature-text">
                  Run scripts, manage files, and execute commands directly
                </p>
              </div>

              <div class="welcome-feature-card">
                <div class="welcome-feature-header">
                  <i class="fas fa-keyboard welcome-feature-icon"></i>
                  <strong>Flexible Keybindings</strong>
                </div>
                <p class="welcome-feature-text">
                  Choose VS Code, Vim, or Emacs keybindings to match your workflow
                </p>
              </div>

              <div class="welcome-feature-card">
                <div class="welcome-feature-header">
                  <i class="fas fa-save welcome-feature-icon"></i>
                  <strong>Auto-Save</strong>
                </div>
                <p class="welcome-feature-text">
                  Your changes are automatically saved to your project
                </p>
              </div>
            </div>

            <div class="welcome-quickstart">
              <strong class="welcome-quickstart-title">
                <i class="fas fa-lightbulb"></i> Quick Start
              </strong>
              <ul class="welcome-quickstart-list">
                <li>Click <strong>+ File</strong> or <strong>+ Folder</strong> to create new items</li>
                <li>Select a file from the sidebar to start editing</li>
                <li>Use <kbd>Ctrl+S</kbd> to save, <kbd>Ctrl+Enter</kbd> to run Python scripts</li>
                <li>Click âŒ¨ button to view all keyboard shortcuts</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Monaco Editor -->
        <div id="monaco-editor"></div>
      </div>
    </div>

    <!-- Resizer between editor and terminal -->
    <div class="panel-resizer" id="editor-resizer"></div>

    <!-- Right: Terminal Panel (PTY with xterm.js) -->
    <div id="code-terminal-panel" class="code-terminal-panel">
      <!-- Terminal Header -->
      <div class="terminal-header">
        <div class="terminal-title">
          <i class="fas fa-terminal" title="Terminal"></i>
          <button id="btn-terminal-shortcuts" class="btn-code-action" title="Terminal Shortcuts">
            <i class="fas fa-keyboard"></i>
          </button>
        </div>
      </div>

      <!-- Terminal Tabs -->
      <div id="terminal-tabs-container" class="terminal-tabs-container">
        <div id="terminal-tabs" class="terminal-tabs">
          <!-- Tabs will be dynamically added here -->
        </div>
      </div>

      <!-- PTY Terminal Container (xterm.js with inline image support) -->
      <div id="pty-terminal" class="terminal-body"></div>
    </div>
  </div>
  {% endif %}

  <!-- Shortcuts Help Modal (Editor) -->
  <div id="shortcuts-modal-overlay" class="file-modal-overlay">
    <div class="file-modal shortcuts-modal">
      <div class="file-modal-header">
        <span id="shortcuts-modal-title" class="file-modal-title"><i class="fas fa-keyboard"></i> Confirmed Shortcuts</span>
        <button class="file-modal-close" onclick="document.getElementById('shortcuts-modal-overlay').classList.remove('active')">Ã—</button>
      </div>
      <div class="file-modal-body shortcuts-modal-body" id="shortcuts-modal-body">
        <!-- Content will be dynamically populated by JavaScript based on keybinding mode -->
      </div>
      <div class="file-modal-footer">
        <button class="file-modal-btn file-modal-btn-primary" onclick="document.getElementById('shortcuts-modal-overlay').classList.remove('active')">Close</button>
      </div>
    </div>
  </div>

  <!-- Terminal Shortcuts Modal -->
  <div id="terminal-shortcuts-modal" class="file-modal-overlay">
    <div class="file-modal terminal-shortcuts-modal">
      <div class="file-modal-header">
        <span class="file-modal-title"><i class="fas fa-terminal"></i> Terminal Shortcuts</span>
        <button class="file-modal-close" onclick="document.getElementById('terminal-shortcuts-modal').classList.remove('active')">Ã—</button>
      </div>
      <div class="file-modal-body terminal-shortcuts-body">
        <table class="terminal-shortcuts-table">
          <thead>
            <tr>
              <th>Shortcut</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody>
            <tr class="section-header"><td colspan="2">Navigation</td></tr>
            <tr><td><kbd>C-a</kbd> / <kbd>C-e</kbd></td><td>Beginning/End of line</td></tr>
            <tr><td><kbd>C-f</kbd> / <kbd>C-b</kbd></td><td>Forward/Backward character</td></tr>
            <tr class="section-header"><td colspan="2">History</td></tr>
            <tr><td><kbd>M-p</kbd> / <kbd>M-n</kbd></td><td>Previous/Next command</td></tr>
            <tr><td><kbd>â†‘</kbd> / <kbd>â†“</kbd></td><td>Previous/Next command (alternative)</td></tr>
            <tr class="section-header"><td colspan="2">Editing</td></tr>
            <tr><td><kbd>C-d</kbd></td><td>Delete character at cursor</td></tr>
            <tr><td><kbd>C-k</kbd></td><td>Kill line (delete to end, copy to clipboard)</td></tr>
            <tr><td><kbd>C-y</kbd></td><td>Yank (paste from clipboard)</td></tr>
            <tr><td><kbd>Tab</kbd></td><td>File/command completion</td></tr>
            <tr class="section-header"><td colspan="2">Other</td></tr>
            <tr><td><kbd>C-l</kbd></td><td>Clear terminal screen</td></tr>
            <tr><td><kbd>C-m</kbd> or <kbd>Enter</kbd></td><td>Execute command</td></tr>
          </tbody>
        </table>
      </div>
      <div class="file-modal-footer">
        <button class="file-modal-btn file-modal-btn-primary" onclick="document.getElementById('terminal-shortcuts-modal').classList.remove('active')">Close</button>
      </div>
    </div>
  </div>

  <!-- File Modal (for smooth CRUD operations) -->
  <div id="file-modal-overlay" class="file-modal-overlay">
    <div class="file-modal">
      <div class="file-modal-header">
        <span id="file-modal-title" class="file-modal-title">New File</span>
        <button class="file-modal-close" onclick="document.getElementById('file-modal-overlay').classList.remove('active')">Ã—</button>
      </div>
      <div class="file-modal-body">
        <div class="file-modal-input-group">
          <label class="file-modal-label" id="file-modal-label">File name:</label>
          <input type="text"
                 id="file-modal-input"
                 class="file-modal-input"
                 placeholder="example.py"
                 autocomplete="off" />
        </div>
      </div>
      <div class="file-modal-footer">
        <button class="file-modal-btn" onclick="document.getElementById('file-modal-overlay').classList.remove('active')">Cancel</button>
        <button id="file-modal-submit" class="file-modal-btn file-modal-btn-primary">Create</button>
      </div>
    </div>
  </div>

  <!-- Commit Modal -->
  <div id="commit-modal-overlay" class="file-modal-overlay">
    <div class="file-modal commit-modal">
      <div class="file-modal-header">
        <span class="file-modal-title"><i class="fas fa-code-branch"></i> Commit Changes</span>
        <button class="file-modal-close" onclick="document.getElementById('commit-modal-overlay').classList.remove('active')">Ã—</button>
      </div>
      <div class="file-modal-body">
        <div class="commit-message-group">
          <label for="commit-message" class="commit-message-label">Commit message:</label>
          <textarea id="commit-message" class="file-modal-input commit-message-textarea" rows="4" placeholder="Brief description of changes..."></textarea>
        </div>
        <div class="commit-preview-group">
          <div id="commit-files-preview" class="commit-files-preview">
            Loading changed files...
          </div>
        </div>
        <div class="commit-checkbox-container">
          <input type="checkbox" id="commit-and-push" checked class="commit-checkbox">
          <label for="commit-and-push" class="commit-checkbox-label">Push to remote after commit</label>
        </div>
      </div>
      <div class="file-modal-footer">
        <button class="file-modal-btn" onclick="document.getElementById('commit-modal-overlay').classList.remove('active')">Cancel</button>
        <button id="commit-modal-submit" class="file-modal-btn file-modal-btn-primary commit-submit-btn">
          <i class="fas fa-code-branch"></i> Commit
        </button>
      </div>
    </div>
  </div>

  <!-- Signup Warning Modal (for visitor users) -->
  <div id="signup-warning-modal" class="file-modal-overlay">
    <div class="file-modal signup-warning-modal">
      <div class="file-modal-header">
        <span class="file-modal-title">
          <i class="fas fa-save signup-modal-title-icon"></i>
          Save Your Work
        </span>
        <button class="file-modal-close" onclick="document.getElementById('signup-warning-modal').classList.remove('active')">Ã—</button>
      </div>
      <div class="file-modal-body">
        <div class="signup-warning-content">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="signup-warning-icon">
            <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/>
            <polyline points="17 21 17 13 7 13 7 21" class="signup-modal-svg-stroke"/>
            <polyline points="7 3 7 8 15 8" class="signup-modal-svg-stroke"/>
          </svg>

          <h3 class="signup-warning-title">
            Create an Account to Save Files
          </h3>

          <p class="signup-warning-text">
            You're currently using a guest session. To create files, save your work,
            and access your projects anytime, you'll need a free SciTeX account.
          </p>

          <div class="signup-benefits-box">
            <strong class="signup-benefits-title">
              <i class="fas fa-check-circle signup-benefits-icon"></i> With a free account you get:
            </strong>
            <ul class="signup-benefits-list">
              <li>Save and organize your code files</li>
              <li>Create unlimited projects</li>
              <li>Access your work from anywhere</li>
              <li>Collaborate with your team</li>
            </ul>
          </div>
        </div>
      </div>
      <div class="file-modal-footer signup-warning-footer">
        <button class="file-modal-btn" onclick="document.getElementById('signup-warning-modal').classList.remove('active')">
          Continue Browsing
        </button>
        <a href="/accounts/signup/" class="file-modal-btn file-modal-btn-primary signup-warning-link">
          <i class="fas fa-user-plus signup-warning-link-icon"></i>
          Sign Up Free
        </a>
      </div>
    </div>
  </div>

  <!-- xterm.js for real PTY terminal with addons -->
  <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xterm-addon-image@0.6.0/lib/xterm-addon-image.js"></script>

  <!-- Panel Resizer for sidebar/editor/terminal -->
  <script src="{% static 'code_app/js/resizer-manager.js' %}?v=2.1.4"></script>

  <!-- Load compiled TypeScript with cache-busting -->
  <script>
    // Force reload JS module by appending timestamp
    const timestamp = new Date().getTime();
    const script = document.createElement('script');
    script.type = 'module';
    script.src = '{% static "code_app/js/workspace.js" %}?v=2.1.5&t=' + timestamp;
    document.currentScript.parentNode.insertBefore(script, document.currentScript.nextSibling);
  </script>
{% endblock %}
