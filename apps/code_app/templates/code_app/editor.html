{% extends "code_app/code_base.html" %}
{% load static %}
{% block extra_css %}
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/codemirror.min.css" />
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/theme/default.min.css" />
    <style>
  .editor-container {
    height: 100%; /* Fill parent container (flex: 1 from global-base.css) */
    display: flex;
  }

  .editor-sidebar {
    width: 300px;
    background-color: var(--gray-100);
    border-right: 1px solid var(--gray-300);
    padding: var(--spacing-md);
    overflow-y: auto;
  }

  .editor-main {
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  .editor-toolbar {
    background-color: var(--gray-50);
    padding: var(--spacing-sm) var(--spacing-md);
    border-bottom: 1px solid var(--gray-300);
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
  }

  .code-editor {
    flex: 1;
    border: none;
  }

  .CodeMirror {
    height: 100%;
    font-family: "Fira Code", "Monaco", "Menlo", monospace;
  }

  .output-panel {
    height: 300px;
    background-color: var(--gray-900);
    color: var(--light-color);
    font-family: monospace;
    padding: var(--spacing-md);
    overflow-y: auto;
    border-top: 1px solid var(--gray-300);
    white-space: pre-wrap;
  }

  .job-item {
    padding: var(--spacing-sm);
    border: 1px solid var(--gray-300);
    border-radius: var(--border-radius);
    margin-bottom: var(--spacing-sm);
    cursor: pointer;
  }

  .job-item:hover {
    background-color: var(--gray-50);
  }

  .job-status {
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 500;
  }

  .job-status.queued {
    background-color: #fef3c7;
    color: #92400e;
  }
  .job-status.running {
    background-color: #dbeafe;
    color: #1e40af;
  }
  .job-status.completed {
    background-color: #d1fae5;
    color: #065f46;
  }
  .job-status.failed {
    background-color: #fee2e2;
    color: #991b1b;
  }

  .progress-bar {
    height: 4px;
    background-color: var(--gray-300);
    border-radius: 2px;
    overflow: hidden;
    margin-top: var(--spacing-xs);
  }

  .progress-fill {
    height: 100%;
    background-color: var(--primary-color);
    transition: width 0.3s ease;
  }

  .execution-settings {
    display: none;
    position: absolute;
    top: 100%;
    right: 0;
    background: white;
    border: 1px solid var(--gray-300);
    border-radius: var(--border-radius);
    padding: var(--spacing-md);
    box-shadow: var(--box-shadow);
    z-index: 1000;
    min-width: 300px;
  }

  .settings-toggle {
    position: relative;
  }
    </style>
{% endblock %}
{% block extra_js %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/addon/edit/matchbrackets.min.js"></script>
{% endblock %}
{% block code_content %}
    <div class="editor-container">
        <!-- Sidebar -->
        <div class="editor-sidebar">
            <h5>
                <i class="fas fa-history me-2"></i>Recent Jobs
            </h5>
            <div id="recent-jobs">
                {% for job in recent_jobs %}
                    <div class="job-item" onclick="loadJobCode('{{ job.job_id }}')">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="job-status {{ job.status }}">{{ job.get_status_display }}</span>
                            <small class="text-muted">{{ job.created_at|timesince }} ago</small>
                        </div>
                        <div class="mt-1">
                            <small>{{ job.execution_type|capfirst }}</small>
                        </div>
                        {% if job.status == 'running' %}
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 50%"></div>
                            </div>
                        {% endif %}
                    </div>
                {% empty %}
                    <p class="text-muted">No recent jobs</p>
                {% endfor %}
            </div>
            <hr class="my-4" />
            <h5>
                <i class="fas fa-book me-2"></i>Notebooks
            </h5>
            <div>
                {% for notebook in user_notebooks %}
                    <div class="job-item" onclick="loadNotebook('{{ notebook.notebook_id }}')">
                        <div class="fw-bold">{{ notebook.title }}</div>
                        <small class="text-muted">{{ notebook.updated_at|timesince }} ago</small>
                    </div>
                {% empty %}
                    <p class="text-muted">No notebooks</p>
                {% endfor %}
            </div>
            <div class="mt-3">
                <a href="{% url 'code:notebooks' %}"
                   class="btn btn-sm btn-outline-primary w-100">
                    <i class="fas fa-plus me-1"></i>Manage Notebooks
                </a>
            </div>
        </div>
        <!-- Main Editor -->
        <div class="editor-main">
            <!-- Toolbar -->
            <div class="editor-toolbar">
                <div class="me-3">
                    <a href="{% url 'code:templates' %}"
                       class="btn btn-sm btn-outline-secondary me-2">
                        <i class="fas fa-file-code me-1"></i>Templates
                    </a>
                    <a href="{% url 'code:analysis' %}"
                       class="btn btn-sm btn-outline-secondary">
                        <i class="fas fa-chart-bar me-1"></i>Analysis
                    </a>
                </div>
                <button id="run-btn" class="btn btn-success">
                    <i class="fas fa-play me-1"></i>Run Code
                </button>
                <button id="stop-btn" class="btn btn-danger" style="display: none">
                    <i class="fas fa-stop me-1"></i>Stop
                </button>
                <div class="settings-toggle">
                    <button id="settings-btn" class="btn btn-outline-secondary">
                        <i class="fas fa-cog me-1"></i>Settings
                    </button>
                    <div id="execution-settings" class="execution-settings">
                        <div class="mb-3">
                            <label for="execution-type" class="form-label">Execution Type</label>
                            <select id="execution-type" class="form-select">
                                <option value="script">Python Script</option>
                                <option value="notebook">Notebook Cell</option>
                                <option value="analysis">Data Analysis</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="timeout" class="form-label">Timeout (seconds)</label>
                            <input type="number"
                                   id="timeout"
                                   class="form-control"
                                   value="300"
                                   min="10"
                                   max="600" />
                        </div>
                        <div class="mb-3">
                            <label for="max-memory" class="form-label">Max Memory (MB)</label>
                            <input type="number"
                                   id="max-memory"
                                   class="form-control"
                                   value="512"
                                   min="128"
                                   max="2048" />
                        </div>
                    </div>
                </div>
                <div class="ms-auto">
                    <span id="status-text" class="text-muted">Ready</span>
                </div>
            </div>
            <!-- Code Editor -->
            <div class="code-editor">
                <textarea id="code-editor"
                          placeholder="# Write your Python code here... import numpy as np import pandas as pd import matplotlib.pyplot as plt  # Your code here print('Hello, SciTeX!')"></textarea>
            </div>
            <!-- Output Panel -->
            <div class="output-panel" id="output-panel">
                <div class="text-muted">Output will appear here when you run code...</div>
            </div>
        </div>
    </div>
    <script>
  document.addEventListener("DOMContentLoaded", function () {
    // Initialize CodeMirror
    const editor = CodeMirror.fromTextArea(
      document.getElementById("code-editor"),
      {
        mode: "python",
        theme: "default",
        lineNumbers: true,
        autoCloseBrackets: true,
        matchBrackets: true,
        indentUnit: 4,
        indentWithTabs: false,
        lineWrapping: true,
      },
    );

    // Load template code if coming from templates page
    const templateCode = localStorage.getItem("templateCode");
    if (templateCode) {
      editor.setValue(templateCode);
      localStorage.removeItem("templateCode");
      statusText.textContent = "Template loaded successfully";
    }

    const runBtn = document.getElementById("run-btn");
    const stopBtn = document.getElementById("stop-btn");
    const statusText = document.getElementById("status-text");
    const outputPanel = document.getElementById("output-panel");
    const settingsBtn = document.getElementById("settings-btn");
    const executionSettings = document.getElementById("execution-settings");

    let currentJobId = null;
    let statusCheckInterval = null;

    // Settings toggle
    settingsBtn.addEventListener("click", function () {
      executionSettings.style.display =
        executionSettings.style.display === "block" ? "none" : "block";
    });

    // Close settings when clicking outside
    document.addEventListener("click", function (e) {
      if (
        !settingsBtn.contains(e.target) &&
        !executionSettings.contains(e.target)
      ) {
        executionSettings.style.display = "none";
      }
    });

    // Run code
    runBtn.addEventListener("click", function () {
      const code = editor.getValue().trim();
      if (!code) {
        alert("Please enter some code to execute.");
        return;
      }

      const executionType = document.getElementById("execution-type").value;
      const timeout = parseInt(document.getElementById("timeout").value);
      const maxMemory = parseInt(document.getElementById("max-memory").value);

      runBtn.style.display = "none";
      stopBtn.style.display = "inline-block";
      statusText.textContent = "Starting execution...";
      outputPanel.innerHTML =
        '<div class="text-info">Starting code execution...</div>';

      fetch('{% url "code:execute_code" %}', {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]")
            .value,
        },
        body: JSON.stringify({
          code: code,
          type: executionType,
          timeout: timeout,
          max_memory: maxMemory,
        }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            currentJobId = data.job_id;
            statusText.textContent = "Executing...";
            startStatusChecking();
          } else {
            handleError(data.error || "Failed to start execution");
          }
        })
        .catch((error) => {
          handleError("Network error: " + error.message);
        });
    });

    // Check job status
    function startStatusChecking() {
      if (statusCheckInterval) {
        clearInterval(statusCheckInterval);
      }

      statusCheckInterval = setInterval(function () {
        if (!currentJobId) return;

        fetch(`/code/jobs/${currentJobId}/status/`)
          .then((response) => response.json())
          .then((data) => {
            updateJobStatus(data);

            if (
              data.status === "completed" ||
              data.status === "failed" ||
              data.status === "timeout"
            ) {
              clearInterval(statusCheckInterval);
              resetUI();
            }
          })
          .catch((error) => {
            console.error("Status check error:", error);
          });
      }, 1000);
    }

    function updateJobStatus(data) {
      statusText.textContent = `${data.status} (${data.progress}%)`;

      let output = "";
      if (data.output) {
        output += `<div class="text-success">${escapeHtml(data.output)}</div>`;
      }
      if (data.error_output) {
        output += `<div class="text-danger mt-2">${escapeHtml(data.error_output)}</div>`;
      }
      if (data.execution_time) {
        output += `<div class="text-info mt-2">Execution time: ${data.execution_time.toFixed(2)}s</div>`;
      }

      if (output) {
        outputPanel.innerHTML = output;
      }
    }

    function resetUI() {
      runBtn.style.display = "inline-block";
      stopBtn.style.display = "none";
      currentJobId = null;
    }

    function handleError(message) {
      statusText.textContent = "Error";
      outputPanel.innerHTML = `<div class="text-danger">Error: ${escapeHtml(message)}</div>`;
      resetUI();
    }

    function escapeHtml(text) {
      const div = document.createElement("div");
      div.textContent = text;
      return div.innerHTML;
    }

    // Load job code
    window.loadJobCode = function (jobId) {
      fetch(`/code/jobs/${jobId}/status/`)
        .then((response) => response.json())
        .then((data) => {
          if (data.source_code) {
            editor.setValue(data.source_code);
          }
        });
    };

    // Load notebook
    window.loadNotebook = function (notebookId) {
      // This would load notebook content
      console.log("Loading notebook:", notebookId);
    };
  });
    </script>
    <!-- CSRF token -->
    {% csrf_token %}
{% endblock %}
