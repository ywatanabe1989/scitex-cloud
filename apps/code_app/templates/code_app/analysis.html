{% extends "code_app/base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'common/css/hero-gradients.css' %}">
<style>
    .analysis-hero {
        background: linear-gradient(135deg, var(--scitex-primary) 0%, var(--scitex-secondary) 100%);
        color: white;
        padding: 3rem 0;
        margin-bottom: 2rem;
    }
    
    .analysis-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-bottom: 2rem;
    }
    
    .analysis-panel {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 16px rgba(26, 35, 50, 0.1);
        border: 1px solid rgba(52, 73, 94, 0.1);
    }
    
    .template-card {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        border: 1px solid #e9ecef;
        margin-bottom: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .template-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(0,0,0,0.1);
        border-color: var(--scitex-accent);
    }
    
    .template-card.selected {
        border-color: var(--scitex-accent);
        background: rgba(52, 152, 219, 0.05);
    }
    
    .template-icon {
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, var(--scitex-primary), var(--scitex-secondary));
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.25rem;
        margin-bottom: 1rem;
    }
    
    .code-preview {
        background: #1a1a1a;
        color: #f8f8f2;
        padding: 1rem;
        border-radius: 8px;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.875rem;
        overflow-x: auto;
        max-height: 300px;
        overflow-y: auto;
    }
    
    .parameter-input {
        margin-bottom: 1rem;
    }
    
    .run-analysis-btn {
        background: var(--scitex-accent);
        color: white;
        border: none;
        padding: 0.75rem 2rem;
        border-radius: 8px;
        font-weight: bold;
        width: 100%;
        transition: all 0.3s ease;
    }
    
    .run-analysis-btn:hover {
        background: #2980b9;
        transform: translateY(-1px);
    }
    
    .job-history {
        max-height: 400px;
        overflow-y: auto;
    }
    
    .job-item {
        padding: 1rem;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        margin-bottom: 0.5rem;
        transition: all 0.3s ease;
    }
    
    .job-item:hover {
        background: #f8f9fa;
    }
    
    .job-status {
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: bold;
        text-transform: uppercase;
    }
    
    .status-completed { background: #d4edda; color: #155724; }
    .status-running { background: #cce5ff; color: #004085; }
    .status-failed { background: #f8d7da; color: #721c24; }
    .status-queued { background: #fff3cd; color: #856404; }
</style>
{% endblock %}

{% block code_content %}
<div class="analysis-hero silverish-ai-gradient">
    <div class="container">
        <div class="text-center">
            <h1 class="display-4 fw-bold mb-3">SciTeX Data Analysis</h1>
            <p class="lead mb-0">
                Automated scientific data analysis with SCITEX framework templates
            </p>
        </div>
    </div>
</div>

<div class="container">
    <div class="analysis-grid">
        <!-- Left Panel: Analysis Templates -->
        <div class="analysis-panel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0">
                    <i class="fas fa-flask me-2"></i>
                    Analysis Templates
                </h4>
                <div>
                    <a href="{% url 'code:templates' %}" class="btn btn-sm btn-outline-secondary me-2">
                        <i class="fas fa-file-code me-1"></i>All Templates
                    </a>
                    <a href="{% url 'code:editor' %}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-code me-1"></i>Editor
                    </a>
                </div>
            </div>
            
            <div id="analysis-templates">
                <div class="template-card" data-type="statistical_analysis" onclick="selectTemplate(this)">
                    <div class="template-icon">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    <h5>Statistical Analysis</h5>
                    <p class="text-muted mb-2">Descriptive statistics, normality tests, correlation analysis</p>
                    <div class="small">
                        <span class="badge bg-primary">Pandas</span>
                        <span class="badge bg-secondary">SciPy</span>
                        <span class="badge bg-success">SCITEX</span>
                    </div>
                </div>
                
                <div class="template-card" data-type="machine_learning" onclick="selectTemplate(this)">
                    <div class="template-icon">
                        <i class="fas fa-brain"></i>
                    </div>
                    <h5>Machine Learning</h5>
                    <p class="text-muted mb-2">Classification, regression, clustering with model evaluation</p>
                    <div class="small">
                        <span class="badge bg-primary">Scikit-learn</span>
                        <span class="badge bg-secondary">NumPy</span>
                        <span class="badge bg-success">SCITEX</span>
                    </div>
                </div>
                
                <div class="template-card" data-type="time_series" onclick="selectTemplate(this)">
                    <div class="template-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <h5>Time Series Analysis</h5>
                    <p class="text-muted mb-2">Trend analysis, forecasting, seasonal decomposition</p>
                    <div class="small">
                        <span class="badge bg-primary">Pandas</span>
                        <span class="badge bg-secondary">Statsmodels</span>
                        <span class="badge bg-success">SCITEX</span>
                    </div>
                </div>
                
                <div class="template-card" data-type="image_analysis" onclick="selectTemplate(this)">
                    <div class="template-icon">
                        <i class="fas fa-image"></i>
                    </div>
                    <h5>Image Analysis</h5>
                    <p class="text-muted mb-2">Image processing, feature extraction, computer vision</p>
                    <div class="small">
                        <span class="badge bg-primary">OpenCV</span>
                        <span class="badge bg-secondary">PIL</span>
                        <span class="badge bg-success">SCITEX</span>
                    </div>
                </div>
                
                <div class="template-card" data-type="custom" onclick="selectTemplate(this)">
                    <div class="template-icon">
                        <i class="fas fa-code"></i>
                    </div>
                    <h5>Custom Analysis</h5>
                    <p class="text-muted mb-2">Custom analysis with full SCITEX framework</p>
                    <div class="small">
                        <span class="badge bg-success">SCITEX</span>
                        <span class="badge bg-warning">Custom</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Right Panel: Configuration & Preview -->
        <div class="analysis-panel">
            <h4 class="mb-3">
                <i class="fas fa-cogs me-2"></i>
                Configuration
            </h4>
            
            <div id="analysis-config">
                <div class="parameter-input">
                    <label for="data-source" class="form-label">Data Source</label>
                    <select id="data-source" class="form-select">
                        <option value="upload">Upload File</option>
                        <option value="sample">Sample Dataset</option>
                        <option value="url">URL</option>
                        <option value="database">Database Connection</option>
                    </select>
                </div>
                
                <div class="parameter-input">
                    <label for="data-path" class="form-label">Data Path/URL</label>
                    <input type="text" id="data-path" class="form-control" placeholder="Enter file path or URL">
                </div>
                
                <div id="specific-parameters">
                    <!-- Dynamic parameters based on selected template -->
                </div>
                
                <button class="run-analysis-btn" onclick="runAnalysis()">
                    <i class="fas fa-play me-2"></i>
                    Run Analysis
                </button>
            </div>
            
            <!-- Code Preview -->
            <div class="mt-4">
                <h5>Generated Code Preview</h5>
                <div id="code-preview" class="code-preview">
# Select an analysis template to see generated code...
                </div>
            </div>
        </div>
    </div>
    
    <!-- Analysis History -->
    <div class="analysis-panel">
        <h4 class="mb-3">
            <i class="fas fa-history me-2"></i>
            Recent Analysis Jobs
        </h4>
        
        <div class="job-history">
            {% for job in analysis_jobs %}
            <div class="job-item">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                        <strong>{{ job.analysis_type|capfirst }} Analysis</strong>
                        <span class="job-status status-{{ job.status }}">{{ job.get_status_display }}</span>
                    </div>
                    <small class="text-muted">{{ job.created_at|timesince }} ago</small>
                </div>
                <div class="small text-muted">
                    Data: {{ job.input_data_path|default:"No data specified" }}
                </div>
                {% if job.code_job %}
                <div class="mt-2">
                    <a href="{% url 'code:job_detail' job.code_job.job_id %}" class="btn btn-sm btn-outline-primary">
                        View Results
                    </a>
                </div>
                {% endif %}
            </div>
            {% empty %}
            <p class="text-muted text-center py-4">
                No analysis jobs yet. Select a template above to get started!
            </p>
            {% endfor %}
        </div>
    </div>
</div>

<script>
let selectedTemplate = null;

const analysisTemplates = {
    statistical_analysis: {
        parameters: [
            { name: 'target_column', label: 'Target Column', type: 'text', placeholder: 'e.g., price, score' },
            { name: 'group_by', label: 'Group By Column', type: 'text', placeholder: 'Optional grouping column' },
            { name: 'confidence_level', label: 'Confidence Level', type: 'number', value: 0.95, step: 0.01 }
        ],
        code: `import pandas as pd
import numpy as np
from scipy import stats
from scitex import io, stats as scistats, plt as splt

# Load data with SCITEX framework
data = io.load_data('{data_path}')

# Statistical analysis
results = scistats.descriptive_statistics(data['{target_column}'])
normality_test = scistats.test_normality(data['{target_column}'])

# Correlation analysis
correlations = scistats.correlation_matrix(data.select_dtypes(include=[np.number]))

# Generate publication-ready visualizations
fig = splt.create_figure(figsize=(12, 8))
splt.plot_distribution(data['{target_column}'], title='Distribution Analysis')
splt.save_figure('statistical_analysis.png', dpi=300)

print("Statistical Analysis Results:")
print(f"Mean: {results['mean']:.3f}")
print(f"Std Dev: {results['std']:.3f}")
print(f"Normality p-value: {normality_test['p_value']:.3f}")
`
    },
    machine_learning: {
        parameters: [
            { name: 'target_column', label: 'Target Column', type: 'text', placeholder: 'Dependent variable' },
            { name: 'feature_columns', label: 'Feature Columns', type: 'text', placeholder: 'Comma-separated list' },
            { name: 'model_type', label: 'Model Type', type: 'select', options: ['classification', 'regression', 'clustering'] },
            { name: 'test_size', label: 'Test Size', type: 'number', value: 0.2, step: 0.1 }
        ],
        code: `import pandas as pd
import numpy as np
from sklearn.model_selection import train_test_split
from sklearn.ensemble import RandomForestClassifier, RandomForestRegressor
from sklearn.metrics import classification_report, mean_squared_error
from scitex import io, ml, plt as splt

# Load data
data = io.load_data('{data_path}')

# Prepare features and target
features = data[{feature_columns}]
target = data['{target_column}']

# Split data
X_train, X_test, y_train, y_test = train_test_split(
    features, target, test_size={test_size}, random_state=42
)

# Train model using SCITEX ML utilities
model = ml.create_model('{model_type}')
model.fit(X_train, y_train)

# Evaluate model
predictions = model.predict(X_test)
results = ml.evaluate_model(y_test, predictions, model_type='{model_type}')

# Generate model performance plots
fig = splt.create_figure(figsize=(15, 10))
splt.plot_model_performance(y_test, predictions, model_type='{model_type}')
splt.save_figure('ml_analysis.png', dpi=300)

print("Machine Learning Results:")
print(f"Model: {type(model).__name__}")
print(f"Performance: {results['primary_metric']:.3f}")
`
    },
    time_series: {
        parameters: [
            { name: 'date_column', label: 'Date Column', type: 'text', placeholder: 'Date/timestamp column' },
            { name: 'value_column', label: 'Value Column', type: 'text', placeholder: 'Numeric value column' },
            { name: 'frequency', label: 'Frequency', type: 'select', options: ['D', 'W', 'M', 'Q', 'Y'] },
            { name: 'forecast_periods', label: 'Forecast Periods', type: 'number', value: 30 }
        ],
        code: `import pandas as pd
import numpy as np
from statsmodels.tsa.seasonal import seasonal_decompose
from statsmodels.tsa.arima.model import ARIMA
from scitex import io, timeseries as ts, plt as splt

# Load and prepare time series data
data = io.load_data('{data_path}')
data['{date_column}'] = pd.to_datetime(data['{date_column}'])
data = data.set_index('{date_column}')

# Time series analysis using SCITEX
ts_data = data['{value_column}'].resample('{frequency}').mean()
decomposition = ts.decompose_series(ts_data)
trend_analysis = ts.analyze_trend(ts_data)

# Forecasting
forecast = ts.forecast_arima(ts_data, periods={forecast_periods})

# Visualization
fig = splt.create_figure(figsize=(15, 12))
splt.plot_timeseries_analysis(ts_data, decomposition, forecast)
splt.save_figure('timeseries_analysis.png', dpi=300)

print("Time Series Analysis Results:")
print(f"Trend direction: {trend_analysis['direction']}")
print(f"Seasonal period: {trend_analysis['seasonal_period']}")
print(f"Forecast RMSE: {forecast['rmse']:.3f}")
`
    },
    custom: {
        parameters: [
            { name: 'analysis_description', label: 'Analysis Description', type: 'textarea', placeholder: 'Describe your analysis goals...' }
        ],
        code: `import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from scitex import io, plt as splt, stats

# Load data with SCITEX framework
data = io.load_data('{data_path}')

# Custom analysis code here
# Use SCITEX utilities for standardized scientific computing

# Example: Basic data exploration
print("Data Overview:")
print(data.info())
print("\\nDescriptive Statistics:")
print(data.describe())

# Generate exploratory plots
fig = splt.create_figure(figsize=(12, 8))
splt.plot_data_overview(data)
splt.save_figure('custom_analysis.png', dpi=300)

print("Custom analysis complete!")
`
    }
};

function selectTemplate(element) {
    // Remove previous selection
    document.querySelectorAll('.template-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    // Select current template
    element.classList.add('selected');
    selectedTemplate = element.dataset.type;
    
    // Update configuration panel
    updateConfiguration();
    updateCodePreview();
}

function updateConfiguration() {
    if (!selectedTemplate) return;
    
    const template = analysisTemplates[selectedTemplate];
    const paramContainer = document.getElementById('specific-parameters');
    
    paramContainer.innerHTML = '';
    
    template.parameters.forEach(param => {
        const div = document.createElement('div');
        div.className = 'parameter-input';
        
        let inputHtml = '';
        if (param.type === 'select') {
            inputHtml = `<select id="${param.name}" class="form-select">
                ${param.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
            </select>`;
        } else if (param.type === 'textarea') {
            inputHtml = `<textarea id="${param.name}" class="form-control" rows="3" placeholder="${param.placeholder}"></textarea>`;
        } else {
            inputHtml = `<input type="${param.type}" id="${param.name}" class="form-control" 
                placeholder="${param.placeholder}" ${param.value ? `value="${param.value}"` : ''} 
                ${param.step ? `step="${param.step}"` : ''}>`;
        }
        
        div.innerHTML = `
            <label for="${param.name}" class="form-label">${param.label}</label>
            ${inputHtml}
        `;
        
        paramContainer.appendChild(div);
    });
    
    // Add event listeners for real-time code preview updates
    paramContainer.querySelectorAll('input, select, textarea').forEach(input => {
        input.addEventListener('input', updateCodePreview);
    });
}

function updateCodePreview() {
    if (!selectedTemplate) return;
    
    const template = analysisTemplates[selectedTemplate];
    let code = template.code;
    
    // Replace placeholders with actual values
    const dataPath = document.getElementById('data-path').value || 'your_data.csv';
    code = code.replace(/{data_path}/g, dataPath);
    
    // Replace parameter placeholders
    template.parameters.forEach(param => {
        const element = document.getElementById(param.name);
        if (element) {
            let value = element.value;
            if (param.name === 'feature_columns' && value) {
                // Format as Python list
                value = "['" + value.split(',').map(s => s.trim()).join("', '") + "']";
            }
            code = code.replace(new RegExp(`{${param.name}}`, 'g'), value);
        }
    });
    
    document.getElementById('code-preview').textContent = code;
}

function runAnalysis() {
    if (!selectedTemplate) {
        alert('Please select an analysis template first.');
        return;
    }
    
    const dataPath = document.getElementById('data-path').value;
    if (!dataPath) {
        alert('Please specify a data source.');
        return;
    }
    
    // Collect parameters
    const parameters = {};
    const template = analysisTemplates[selectedTemplate];
    
    template.parameters.forEach(param => {
        const element = document.getElementById(param.name);
        if (element) {
            parameters[param.name] = element.value;
        }
    });
    
    // Submit analysis job
    const formData = new FormData();
    formData.append('type', selectedTemplate);
    formData.append('data_path', dataPath);
    formData.append('parameters', JSON.stringify(parameters));
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch('{% url "code:run_analysis" %}', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok) {
            window.location.reload();
        } else {
            alert('Error starting analysis. Please try again.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Network error. Please try again.');
    });
}

// Initialize with first template selected
document.addEventListener('DOMContentLoaded', function() {
    const firstTemplate = document.querySelector('.template-card');
    if (firstTemplate) {
        selectTemplate(firstTemplate);
    }
});
</script>

<!-- CSRF token -->
{% csrf_token %}
{% endblock %}