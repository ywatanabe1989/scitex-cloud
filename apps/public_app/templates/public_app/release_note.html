{% extends 'global_base.html' %}
{% load static %}
{% block title %}
    Release
    Notes - SciTeX Cloud
{% endblock %}
{% block extra_js %}
    <!-- Chart.js libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <!-- TODO: Move inline script below to apps/public_app/static/public_app/js/release-timeline.js -->
    <!-- Currently inline due to permission issues on js/ directory (owned by root) -->
{% endblock %}
{% block extra_css %}
    <link rel="stylesheet"
          href="{% static 'public_app/css/release-notes.css' %}" />
{% endblock %}
{% block content %}
    <div class="release-notes-container">
        <div class="release-header">
            <h1>SciTeX Cloud Release Notes</h1>
            <p>Building the future of scientific research collaboration</p>
        </div>
        <div class="stats-box">
            <div class="stat-item">
                <span class="stat-number">970+</span>
                <span class="stat-label">Total Commits</span>
            </div>
            <div class="stat-item">
                <span class="stat-number">6</span>
                <span class="stat-label">Months of Development</span>
            </div>
            <div class="stat-item">
                <span class="stat-number">4</span>
                <span class="stat-label">Core Modules</span>
            </div>
            <div class="stat-item">
                <span class="stat-number">2</span>
                <span class="stat-label">Contributors</span>
            </div>
        </div>
        <!-- Development Timeline Chart -->
        <div class="chart-container">
            <h2>Development Timeline</h2>
            <div class="chart-wrapper">
                <canvas id="commitTimeline"></canvas>
            </div>
        </div>
        <div class="release-month">
            <div class="month-header">
                <h2>November 2025 ‚Äî v0.4.3</h2>
                <span class="month-badge">Latest Release</span>
            </div>
            <ul class="feature-list">
                <li class="feature-item">
                    <h3>üóÑÔ∏è Database Service Clarity</h3>
                    <p>
                        Renamed database service from generic "db" to explicit "postgres" across entire codebase.
                        Updated 20+ locations including Docker Compose files (dev/nas), environment variables,
                        Django settings, and entrypoint scripts. Improved service naming consistency and
                        reduced confusion in multi-database scenarios.
                    </p>
                </li>
                <li class="feature-item">
                    <h3>üê≥ Docker Configuration Consolidation</h3>
                    <p>
                        Merged docker-compose.override.yml patterns into main configuration files for both
                        development and NAS deployments. Eliminated separate override files while preserving
                        environment-specific debug settings. Simplified Docker architecture with single-file
                        configuration per environment.
                    </p>
                </li>
                <li class="feature-item">
                    <h3>‚öôÔ∏è Enhanced Development Environment</h3>
                    <p>
                        Integrated debug settings directly into development Docker Compose: PostgreSQL query
                        logging, Redis verbose logging, Gitea debug mode, and debugpy remote debugging port.
                        All development-specific settings now consolidated in one place for easier maintenance.
                    </p>
                </li>
                <li class="feature-item">
                    <h3>‚úÖ Infrastructure Health Monitoring</h3>
                    <p>
                        All 7 Docker services (postgres, redis, django, gitea, celery_worker, celery_beat, flower)
                        now running healthy with proper healthchecks. Fixed container recreation issues and
                        ensured consistent environment variable propagation across full container lifecycle.
                    </p>
                </li>
            </ul>
        </div>
        <div class="release-month">
            <div class="month-header">
                <h2>November 2025 ‚Äî v0.4.2</h2>
                <span class="month-badge">SLURM Terminal</span>
            </div>
            <ul class="feature-list">
                <li class="feature-item">
                    <h3>üñ•Ô∏è SLURM + Apptainer Terminal</h3>
                    <p>
                        Fully functional container-based terminal via SLURM job scheduler.
                        Terminal sessions run inside Apptainer containers with SciTeX 2.3.0 pre-installed.
                        User dotfiles (.bashrc, .bash_aliases, .inputrc) are mounted for personalized environments.
                        WebSocket connection to PTY provides real-time interactive shell access.
                        Docker container now builds SLURM from source to match host version exactly for munge authentication.
                    </p>
                </li>
                <li class="feature-item">
                    <h3>‚öôÔ∏è Configurable SLURM Infrastructure</h3>
                    <p>
                        SLURM version configurable via environment variables (SCITEX_CLOUD_SLURM_VERSION).
                        Host path configuration for SLURM jobs (SCITEX_SLURM_CONTAINER_PATH, SCITEX_SLURM_USER_DATA_ROOT).
                        Automatic munge authentication between Docker and host SLURM cluster.
                        Interactive terminal respects partition time limits (express: 59min max).
                    </p>
                </li>
            </ul>
        </div>
        <div class="release-month">
            <div class="month-header">
                <h2>November 2025 ‚Äî v0.4.1</h2>
                <span class="month-badge">Symlink UI</span>
            </div>
            <ul class="feature-list">
                <li class="feature-item">
                    <h3>üîó Workspace Symlink UI</h3>
                    <p>
                        Ctrl+Drag to create cross-module symlinks directly in the file tree.
                        Backend API with relative path support for portable symlinks.
                        Visual feedback with drag opacity, drop target border, and link cursor.
                        Perfect for sharing files between modules (vis/exports ‚Üí writer/figures).
                    </p>
                </li>
            </ul>
        </div>
        <div class="release-month">
            <div class="month-header">
                <h2>November 2025 ‚Äî v0.4.0</h2>
                <span class="month-badge">Celery Workers</span>
            </div>
            <ul class="feature-list">
                <li class="feature-item">
                    <h3>üë§ Visitor Mode UI Improvements</h3>
                    <p>
                        Completely redesigned visitor experience with distinct visual identity.
                        Visitors now see an orange menu icon instead of regular user avatar,
                        with dedicated dropdown showing Sign Up and Sign In CTAs. Clear warning
                        about temporary workspace encourages account creation to preserve work.
                        Visitor Mode badge with countdown timer shows session expiration in real-time.
                    </p>
                </li>
                <li class="feature-item">
                    <h3>üîß Auto-Allocation System</h3>
                    <p>
                        Fixed critical bug where authenticated visitors had no slot allocations,
                        leaving them in limbo state. Auto-allocation now triggers at 4 key entry
                        points: landing page (/), visitor status page (/visitor-status/), code
                        workspace (/code/), and writer workspace (/writer/). Context processor
                        detects authenticated visitors and provides is_visitor flag to all templates.
                    </p>
                </li>
                <li class="feature-item">
                    <h3>üì¶ TypeScript Refactoring</h3>
                    <p>
                        Major workspace modularization reducing workspace/index.ts from 607 to 320 lines
                        (47% reduction). Created three new managers: FileCommandHandler (178 lines)
                        for file CRUD operations, FileStateManager (201 lines) for state management,
                        and VisitorManager (103 lines) for visitor detection/warnings. Added comprehensive
                        REFACTORING_PLAN.md documenting modularization strategy and future steps.
                    </p>
                </li>
                <li class="feature-item">
                    <h3>üê≥ Docker Infrastructure</h3>
                    <p>
                        Pre-installed essential CLI tools (tree, htop, vim, nano) in both dev and
                        prod Docker images. Users maintain full apt package installation capability
                        by running 'apt update' first. Image size reduction through removal of
                        /var/lib/apt/lists/* while preserving package installation functionality.
                    </p>
                </li>
            </ul>
        </div>
        <div class="release-month">
            <div class="month-header">
                <h2>November 2025 ‚Äî v0.3.0</h2>
                <span class="month-badge">445+ commits</span>
            </div>
            <ul class="feature-list">
                <li class="feature-item">
                    <h3>üéâ Sigma Editor Integration</h3>
                    <p>
                        Major refactor introducing the Sigma editor for enhanced collaboration.
                        Real-time collaboration capabilities with improved text editing,
                        synchronization, and multi-user support across the platform.
                    </p>
                </li>
                <li class="feature-item">
                    <h3>üî• Hot Reload Development System</h3>
                    <p>
                        Implemented django-browser-reload for seamless Python and HTML hot reloading.
                        Development workflow dramatically improved with automatic browser refresh on
                        file changes. TypeScript watch mechanism with preventive build measures
                        ensures code quality and faster iteration.
                    </p>
                </li>
                <li class="feature-item">
                    <h3>üë• Visitor Pool System</h3>
                    <p>
                        Visitor visitor support with pre-configured demo accounts (visitor-001 to visitor-032).
                        Try SciTeX Cloud without registration. Seamless upgrade path from visitor to
                        full account while preserving your work and projects.
                    </p>
                </li>
                <li class="feature-item">
                    <h3>Git History & Version Control</h3>
                    <p>
                        Comprehensive git history feature with commit browsing and file diffs. View complete commit history for your projects, browse file changes over time, and examine detailed diffs. Integrated GitService provides seamless repository operations and history tracking directly in the editor.
                    </p>
                </li>
                <li class="feature-item">
                    <h3>Figures & Tables Management</h3>
                    <p>
                        Dedicated panels for managing document images and tables. Figures panel with hash-based deduplication prevents duplicate images. Tables panel with preview modal allows quick inspection of table content. Both panels integrate seamlessly with the Monaco editor for drag-and-drop insertion.
                    </p>
                </li>
                <li class="feature-item">
                    <h3>Content Indexer & Project Database</h3>
                    <p>
                        Background content indexer extracts and indexes document elements including figures, tables, references, and sections. Project database utilities provide efficient data management for writer projects with comprehensive querying capabilities.
                    </p>
                </li>
                <li class="feature-item">
                    <h3>SSH Support & Gitea Integration</h3>
                    <p>
                        Full SSH key management for secure git operations. Enhanced Gitea API client with SSH support, automated key deployment, and comprehensive SSH architecture documentation. Test scripts for SSH clone and sync operations ensure reliability.
                    </p>
                </li>
                <li class="feature-item">
                    <h3>PDF Viewer Enhancements</h3>
                    <p>
                        Advanced PDF viewer with text selection support using invisible text layer, pan mode with hand cursor for easy navigation, prefix key command system for keyboard shortcuts, and improved dark mode colors for better eye comfort. Smooth synchronization between scroll, zoom, and selection modes.
                    </p>
                </li>
                <li class="feature-item">
                    <h3>Smart Citation Autocomplete</h3>
                    <p>
                        Revolutionary citation management with intelligent autocomplete. Type
                        <code>\cite</code> and get instant suggestions with fuzzy search
                        across titles, authors, journals, and abstracts. Automatic detail
                        expansion, drag-and-drop citation insertion, atomic citation editing,
                        and rich metadata display showing impact factors, citation counts, and
                        abstracts. Citations are sorted by impact with the most cited papers
                        appearing first.
                    </p>
                </li>
                <li class="feature-item">
                    <h3>BibTeX Enrichment & Deduplication</h3>
                    <p>
                        Upload BibTeX files and automatically enrich them with citation
                        counts, impact factors, abstracts, and URLs. Intelligent deduplication
                        using DOI-based and metadata-based fingerprinting removes duplicate
                        entries. Real-time progress tracking with detailed processing logs
                        shows enrichment status for each paper.
                    </p>
                </li>
                <li class="feature-item">
                    <h3>Repository Browser Improvements</h3>
                    <p>
                        Enhanced project repository browser with improved UI and navigation. Updated browse header, directory browser, and file view templates for better user experience. New clone button partial for easier repository cloning.
                    </p>
                </li>
                <li class="feature-item">
                    <h3>Visitor Visitor Access</h3>
                    <p>
                        Try SciTeX Writer without creating an account. Visitor pool system
                        with 32 demo projects allows visitor users to experience the
                        platform. Automatic project allocation, seamless upgrade path to full
                        accounts, and comprehensive visitor documentation.
                    </p>
                </li>
                <li class="feature-item">
                    <h3>Emacs-Style Cursor Memory</h3>
                    <p>
                        Editor remembers your cursor position for each section. When switching
                        between sections, your cursor returns to exactly where you left off.
                        Content hash verification ensures positions are only restored when
                        content matches.
                    </p>
                </li>
                <li class="feature-item">
                    <h3>User Feedback Improvements</h3>
                    <p>
                        Visual feedback for all actions: loading states on buttons, success
                        alerts showing file paths when saving, download confirmations with
                        file sizes, and persistent alerts. No more silent operations!
                    </p>
                </li>
            </ul>
        </div>
        <div class="release-month">
            <div class="month-header">
                <h2>October 2025</h2>
                <span class="month-badge">447 commits</span>
            </div>
            <ul class="feature-list">
                <li class="feature-item">
                    <h3>Complete TypeScript Migration</h3>
                    <p>
                        100% migration from JavaScript to TypeScript across all apps. ES2022
                        modern syntax, full type safety with strict mode, comprehensive type
                        definitions, and automated build system with hot-reloading. Perfect
                        three-layer mirroring: Templates - CSS - TypeScript.
                    </p>
                </li>
                <li class="feature-item">
                    <h3>App-Centric Architecture Refactoring</h3>
                    <p>
                        Complete reorganization following Django best practices. Each app now
                        has clear templates, static, views, and services structure. Eliminated
                        4,500+ lines of duplicate code and consolidated CSS architecture.
                    </p>
                </li>
                <li class="feature-item">
                    <h3>Writer Editor Enhancements</h3>
                    <p>
                        Monaco Editor integration with LaTeX support, theme-aware syntax
                        highlighting, real-time PDF preview with auto-compilation, draggable
                        panel resizer, font size controls with keyboard shortcuts, and
                        section-specific preview compilation.
                    </p>
                </li>
                <li class="feature-item">
                    <h3>Advanced Theme System</h3>
                    <p>
                        System-wide light/dark theme support with instant switching,
                        theme-responsive components across all modules, persistent theme
                        preferences, and CodeMirror/Monaco theme synchronization.
                    </p>
                </li>
                <li class="feature-item">
                    <h3>UI/UX Overhaul</h3>
                    <p>
                        Modern alert components, improved button system with proper variants,
                        beautiful code blocks with syntax highlighting and copy buttons,
                        responsive tabs and navigation, and comprehensive design system
                        documentation.
                    </p>
                </li>
            </ul>
        </div>
        <div class="release-month">
            <div class="month-header">
                <h2>July 2025</h2>
                <span class="month-badge">6 commits</span>
            </div>
            <ul class="feature-list">
                <li class="feature-item">
                    <h3>Project-Centric Architecture</h3>
                    <p>
                        Redesigned navigation to be project-centric. All modules (Scholar,
                        Writer, Code, Viz) now link to specific projects, improving workflow
                        coherence and user experience.
                    </p>
                </li>
            </ul>
        </div>
        <div class="release-month">
            <div class="month-header">
                <h2>June 2025</h2>
                <span class="month-badge">21 commits</span>
            </div>
            <ul class="feature-list">
                <li class="feature-item">
                    <h3>SciTeX Cloud Platform Launch</h3>
                    <p>
                        Initial release of SciTeX Cloud - an integrated platform for
                        scientific research. Complete ecosystem with Scholar (literature
                        management), Writer (LaTeX collaboration), Code (analysis), and Viz
                        (visualization) modules.
                    </p>
                </li>
                <li class="feature-item">
                    <h3>Scholar Module Foundation</h3>
                    <p>
                        Advanced paper acquisition system with citation export, performance
                        optimization with caching, personal library management, and paper
                        similarity recommendations powered by ML.
                    </p>
                </li>
                <li class="feature-item">
                    <h3>Production Infrastructure</h3>
                    <p>
                        Docker-based deployment, database migrations, SSL/HTTPS support,
                        comprehensive logging infrastructure, and automatic cache table
                        creation for production stability.
                    </p>
                </li>
            </ul>
        </div>
        <div class="cta-section">
            <h2>Ready to Transform Your Research Workflow?</h2>
            <p>
                Join researchers worldwide using SciTeX Cloud for seamless scientific
                collaboration
            </p>
            <div class="cta-buttons">
                <a href="/signup/" class="btn btn-primary">Get Started Free</a>
                <a href="{% url 'public_app:index' %}#features"
                   class="btn btn-outline-primary">Learn More</a>
            </div>
        </div>
    </div>
    <script>
  // Create commit timeline chart
  document.addEventListener("DOMContentLoaded", function () {
    const ctx = document.getElementById("commitTimeline");
    if (!ctx) return;

    // Cumulative commit data by date
    const commitData = [
      {
        date: "2025-06-28",
        commits: 9,
        cumulative: 9,
        milestone: "Platform Launch",
      },
      { date: "2025-06-30", commits: 12, cumulative: 21, milestone: null },
      {
        date: "2025-07-01",
        commits: 6,
        cumulative: 27,
        milestone: "Project-Centric Architecture",
      },
      {
        date: "2025-10-16",
        commits: 45,
        cumulative: 73,
        milestone: "Design System",
      },
      {
        date: "2025-10-17",
        commits: 69,
        cumulative: 142,
        milestone: "Dark Mode & Templates",
      },
      { date: "2025-10-20", commits: 31, cumulative: 173, milestone: null },
      { date: "2025-10-22", commits: 57, cumulative: 230, milestone: null },
      { date: "2025-10-23", commits: 66, cumulative: 296, milestone: null },
      { date: "2025-10-24", commits: 39, cumulative: 335, milestone: null },
      { date: "2025-10-26", commits: 23, cumulative: 358, milestone: null },
      {
        date: "2025-10-27",
        commits: 39,
        cumulative: 397,
        milestone: "Code Blocks & Alerts",
      },
      { date: "2025-10-28", commits: 27, cumulative: 424, milestone: null },
      {
        date: "2025-10-29",
        commits: 7,
        cumulative: 431,
        milestone: "Writer API Layer",
      },
      {
        date: "2025-10-30",
        commits: 15,
        cumulative: 446,
        milestone: "Monaco Editor",
      },
      { date: "2025-11-01", commits: 10, cumulative: 456, milestone: null },
      {
        date: "2025-11-02",
        commits: 12,
        cumulative: 468,
        milestone: "SSL & Production",
      },
      {
        date: "2025-11-03",
        commits: 74,
        cumulative: 542,
        milestone: "Visitor Pool System",
      },
      {
        date: "2025-11-04",
        commits: 50,
        cumulative: 592,
        milestone: "TypeScript Migration",
      },
      {
        date: "2025-11-06",
        commits: 56,
        cumulative: 648,
        milestone: "Complete TS Migration",
      },
      {
        date: "2025-11-07",
        commits: 52,
        cumulative: 700,
        milestone: "Citation Autocomplete",
      },
      { date: "2025-11-08", commits: 13, cumulative: 713, milestone: null },
      { date: "2025-11-09", commits: 13, cumulative: 726, milestone: null },
      {
        date: "2025-11-11",
        commits: 43,
        cumulative: 769,
        milestone: "File Tree Modularization",
      },
      { date: "2025-11-12", commits: 30, cumulative: 799, milestone: null },
      { date: "2025-11-13", commits: 24, cumulative: 823, milestone: null },
      { date: "2025-11-14", commits: 21, cumulative: 844, milestone: null },
      { date: "2025-11-16", commits: 13, cumulative: 857, milestone: null },
      { date: "2025-11-17", commits: 14, cumulative: 871, milestone: null },
      { date: "2025-11-18", commits: 2, cumulative: 873, milestone: null },
      { date: "2025-11-19", commits: 1, cumulative: 874, milestone: null },
      {
        date: "2025-11-22",
        commits: 19,
        cumulative: 893,
        milestone: "Workspace Refactoring",
      },
      { date: "2025-11-23", commits: 19, cumulative: 912, milestone: null },
      { date: "2025-11-25", commits: 19, cumulative: 931, milestone: null },
      {
        date: "2025-11-26",
        commits: 14,
        cumulative: 945,
        milestone: "Symlink UI (v0.4.1-alpha)",
      },
      {
        date: "2025-11-27",
        commits: 15,
        cumulative: 960,
        milestone: "SLURM Terminal (v0.4.2-alpha)",
      },
      {
        date: "2025-11-28",
        commits: 12,
        cumulative: 972,
        milestone: "Database Renaming (v0.4.3-alpha)",
      },
    ];

    // Calculate true cumulative
    let cumulative = 0;
    const chartData = commitData.map((d) => {
      cumulative += d.commits;
      return {
        date: d.date,
        cumulative: cumulative,
        milestone: d.milestone,
        commits: d.commits,
      };
    });

    // Separate data for line and milestones
    const lineData = chartData.map((d) => ({ x: d.date, y: d.cumulative }));
    const milestoneData = chartData
      .filter((d) => d.milestone)
      .map((d) => ({
        x: d.date,
        y: d.cumulative,
        label: d.milestone,
        commits: d.commits,
      }));

    // Function to get theme-aware colors
    function getThemeColors() {
      const isDark =
        document.documentElement.getAttribute("data-theme") === "dark";
      return {
        lineColor: isDark ? "rgb(99, 179, 237)" : "rgb(59, 130, 246)",
        lineBgColor: isDark
          ? "rgba(99, 179, 237, 0.15)"
          : "rgba(59, 130, 246, 0.1)",
        milestoneColor: isDark ? "rgb(251, 146, 60)" : "rgb(249, 115, 22)",
        gridColor: isDark ? "rgba(255, 255, 255, 0.08)" : "rgba(0, 0, 0, 0.08)",
        textColor: isDark ? "rgb(226, 232, 240)" : "rgb(51, 65, 85)",
      };
    }

    let colors = getThemeColors();
    const isDark =
      document.documentElement.getAttribute("data-theme") === "dark";

    const chart = new Chart(ctx, {
      type: "line",
      data: {
        datasets: [
          {
            label: "Cumulative Commits",
            data: lineData,
            borderColor: colors.lineColor,
            backgroundColor: colors.lineBgColor,
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointRadius: 4,
            pointHoverRadius: 6,
            pointBackgroundColor: colors.lineColor,
            pointBorderColor: colors.lineColor,
          },
          {
            label: "Major Milestones",
            data: milestoneData,
            type: "scatter",
            backgroundColor: colors.milestoneColor,
            borderColor: isDark
              ? "rgba(0, 0, 0, 0.3)"
              : "rgba(255, 255, 255, 0.5)",
            borderWidth: 3,
            pointRadius: 8,
            pointHoverRadius: 12,
            pointStyle: "circle",
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: "index",
          intersect: false,
        },
        plugins: {
          legend: {
            display: true,
            position: "top",
            labels: {
              usePointStyle: true,
              padding: 20,
              font: {
                size: 16,
                weight: "600",
              },
              color: colors.textColor,
              boxWidth: 20,
              boxHeight: 20,
              generateLabels: function (chart) {
                const datasets = chart.data.datasets;
                const colors = getThemeColors();
                return datasets.map((dataset, i) => ({
                  text: dataset.label,
                  fillStyle: dataset.backgroundColor,
                  strokeStyle: dataset.borderColor,
                  lineWidth: dataset.borderWidth || 2,
                  hidden: !chart.isDatasetVisible(i),
                  index: i,
                  pointStyle: dataset.pointStyle || "circle",
                  color: colors.textColor,
                }));
              },
            },
          },
          tooltip: {
            callbacks: {
              title: function (context) {
                if (context[0].dataset.label === "Major Milestones") {
                  const point = milestoneData[context[0].dataIndex];
                  return point.label;
                }
                return context[0].label;
              },
              label: function (context) {
                if (context.dataset.label === "Major Milestones") {
                  const point = milestoneData[context.dataIndex];
                  return `${point.commits} commits ‚Ä¢ Total: ${point.y}`;
                }
                return `Total Commits: ${context.parsed.y}`;
              },
            },
          },
        },
        scales: {
          x: {
            type: "time",
            time: {
              unit: "month",
              displayFormats: {
                month: "MMM yyyy",
              },
            },
            title: {
              display: true,
              text: "Development Timeline",
              color: colors.textColor,
            },
            ticks: {
              color: colors.textColor,
            },
            grid: {
              color: colors.gridColor,
            },
          },
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: "Cumulative Commits",
              color: colors.textColor,
            },
            ticks: {
              color: colors.textColor,
            },
            grid: {
              color: colors.gridColor,
            },
          },
        },
      },
    });

    // Listen for theme changes and update chart colors
    const observer = new MutationObserver(function (mutations) {
      mutations.forEach(function (mutation) {
        if (
          mutation.type === "attributes" &&
          mutation.attributeName === "data-theme"
        ) {
          colors = getThemeColors();
          const isDark =
            document.documentElement.getAttribute("data-theme") === "dark";

          // Update dataset colors
          chart.data.datasets[0].borderColor = colors.lineColor;
          chart.data.datasets[0].backgroundColor = colors.lineBgColor;
          chart.data.datasets[0].pointBackgroundColor = colors.lineColor;
          chart.data.datasets[0].pointBorderColor = colors.lineColor;
          chart.data.datasets[1].backgroundColor = colors.milestoneColor;
          chart.data.datasets[1].borderColor = isDark
            ? "rgba(0, 0, 0, 0.3)"
            : "rgba(255, 255, 255, 0.5)";

          // Update legend labels with new theme colors
          chart.options.plugins.legend.labels.color = colors.textColor;
          chart.options.plugins.legend.labels.font = {
            size: 16,
            weight: "600",
          };
          // Regenerate labels to apply new colors to label text
          chart.options.plugins.legend.labels.generateLabels = function (
            chart
          ) {
            const datasets = chart.data.datasets;
            const themeColors = getThemeColors();
            return datasets.map((dataset, i) => ({
              text: dataset.label,
              fillStyle: dataset.backgroundColor,
              strokeStyle: dataset.borderColor,
              lineWidth: dataset.borderWidth || 2,
              hidden: !chart.isDatasetVisible(i),
              index: i,
              pointStyle: dataset.pointStyle || "circle",
              color: themeColors.textColor,
            }));
          };
          chart.options.scales.x.title.color = colors.textColor;
          chart.options.scales.x.ticks.color = colors.textColor;
          chart.options.scales.x.grid.color = colors.gridColor;
          chart.options.scales.y.title.color = colors.textColor;
          chart.options.scales.y.ticks.color = colors.textColor;
          chart.options.scales.y.grid.color = colors.gridColor;

          // Update the chart
          chart.update();
        }
      });
    });

    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ["data-theme"],
    });
  });
    </script>
{% endblock %}
