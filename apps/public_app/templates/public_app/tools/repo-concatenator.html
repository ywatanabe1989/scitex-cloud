{% extends "global_base.html" %}
{% block title %}GitHub Repository Concatenator - Browser Tool | SciTeX{% endblock %}
{% block meta_description %}Concatenate repository files into a single AI-ready document. Perfect for code review with AI assistants.{% endblock %}
{% block head_extra %}
    {% load static %}
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
{% endblock %}
{% block extra_css %}
    <style>
  .tool-detail-container { max-width: 1200px; margin: 0 auto; padding: 40px 20px; }
  .tool-header { text-align: center; padding: 40px 20px; margin-bottom: 40px; }
  .tool-title { font-size: 42px; font-weight: 700; margin-bottom: 16px; }
  .tool-breadcrumb { font-size: 14px; margin-bottom: 16px; }
  .tool-breadcrumb a { color: #4a9b7e; text-decoration: none; }
  .tool-app-container { background: var(--bg-secondary); border-radius: 12px; padding: 40px; }
  .upload-zone { border: 3px dashed #4a9b7e; border-radius: 8px; padding: 60px 20px; text-align: center; cursor: pointer; background: var(--bg-primary); }
  .controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }
  .control-group { display: flex; flex-direction: column; gap: 8px; }
  .control-label { font-size: 14px; font-weight: 600; }
  .control-input, .control-select { padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; }
  .extension-chips { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
  .chip { padding: 6px 12px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 4px; font-size: 12px; cursor: pointer; }
  .chip.active { background: #4a9b7e; color: white; border-color: #4a9b7e; }
  .preview { background: var(--bg-primary); padding: 20px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 12px; max-height: 400px; overflow: auto; white-space: pre-wrap; }
  .btn { padding: 12px 24px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; border: none; }
  .btn-primary { background: #4a9b7e; color: white; }
  .btn-primary:hover:not(:disabled) { background: #3a7c65; }
  .btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .stats { display: flex; gap: 20px; justify-content: center; margin: 20px 0; }
  .stat { text-align: center; }
  .stat-value { font-size: 24px; font-weight: 700; color: #4a9b7e; }
  .stat-label { font-size: 12px; color: var(--text-secondary); }
    </style>
{% endblock %}
{% block content %}
    <div class="tool-detail-container">
        <div class="tool-breadcrumb"><a href="{% url 'public_app:tools' %}">‚Üê Back to Tools</a></div>
        <div class="tool-header">
            <div style="font-size: 64px; margin-bottom: 20px;">üì¶</div>
            <h1 class="tool-title">Repository Concatenator</h1>
            <p style="font-size: 18px; color: var(--text-secondary);">Concatenate code files into AI-ready format</p>
        </div>
        <div class="tool-app-container">
            <div id="uploadZone" class="upload-zone">
                <div style="font-size: 48px; margin-bottom: 16px;">üì§</div>
                <div style="font-size: 18px; margin-bottom: 8px;">Drop repository .zip file</div>
                <div style="font-size: 14px; color: var(--text-secondary);">Or download from GitHub: Code ‚Üí Download ZIP</div>
                <input type="file" id="fileInput" accept=".zip" style="display: none" />
            </div>
            <div class="controls" id="controls" style="display: none;">
                <div class="control-group">
                    <label class="control-label">Max Lines per File</label>
                    <input type="number" id="maxLines" class="control-input" value="100" min="10" max="1000" />
                </div>
                <div class="control-group">
                    <label class="control-label">Max Depth</label>
                    <input type="number" id="maxDepth" class="control-input" value="5" min="1" max="10" />
                </div>
            </div>
            <div id="extensionSection" style="display: none; margin: 20px 0;">
                <label class="control-label">File Extensions (click to toggle)</label>
                <div class="extension-chips" id="extensionChips"></div>
            </div>
            <div id="stats" class="stats" style="display: none;">
                <div class="stat"><div class="stat-value" id="fileCount">0</div><div class="stat-label">Files</div></div>
                <div class="stat"><div class="stat-value" id="lineCount">0</div><div class="stat-label">Lines</div></div>
                <div class="stat"><div class="stat-value" id="charCount">0</div><div class="stat-label">Characters</div></div>
            </div>
            <div style="text-align: center; margin: 20px 0;">
                <button id="generateBtn" class="btn btn-primary" disabled>üéØ Generate Concatenated File</button>
            </div>
            <div id="preview" class="preview" style="display: none;"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button id="downloadBtn" class="btn btn-primary" style="display: none;">üíæ Download .md File</button>
                <button id="copyBtn" class="btn btn-primary" style="display: none;">üìã Copy to Clipboard</button>
            </div>
        </div>
    </div>
    <script>
  let zipData = null;
  let concatenatedContent = '';
  const commonExtensions = ['.py', '.js', '.ts', '.md', '.txt', '.json', '.yaml', '.yml', '.sh', '.html', '.css'];
  let selectedExtensions = new Set(commonExtensions);

  document.getElementById('uploadZone').addEventListener('click', () => document.getElementById('fileInput').click());

  document.getElementById('fileInput').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    zipData = await file.arrayBuffer();
    const zip = await JSZip.loadAsync(zipData);

    // Detect file extensions
    const extensions = new Set();
    zip.forEach((path, file) => {
      if (!file.dir) {
        const ext = path.substring(path.lastIndexOf('.')).toLowerCase();
        if (ext) extensions.add(ext);
      }
    });

    // Show extension selector
    const chips = document.getElementById('extensionChips');
    chips.innerHTML = '';
    Array.from(extensions).sort().forEach(ext => {
      const chip = document.createElement('div');
      chip.className = `chip ${selectedExtensions.has(ext) ? 'active' : ''}`;
      chip.textContent = ext;
      chip.addEventListener('click', () => {
        if (selectedExtensions.has(ext)) {
          selectedExtensions.delete(ext);
          chip.classList.remove('active');
        } else {
          selectedExtensions.add(ext);
          chip.classList.add('active');
        }
      });
      chips.appendChild(chip);
    });

    document.getElementById('controls').style.display = 'grid';
    document.getElementById('extensionSection').style.display = 'block';
    document.getElementById('generateBtn').disabled = false;
  });

  document.getElementById('generateBtn').addEventListener('click', async () => {
    if (!zipData) return;

    const maxLines = parseInt(document.getElementById('maxLines').value);
    const maxDepth = parseInt(document.getElementById('maxDepth').value);

    const zip = await JSZip.loadAsync(zipData);
    let output = '# Repository Contents\\n\\n';
    let fileCount = 0, lineCount = 0, charCount = 0;

    // Generate tree structure
    output += '## Directory Structure\\n```\\n';
    const tree = [];
    zip.forEach((path, file) => {
      const depth = path.split('/').length - 1;
      if (depth <= maxDepth && !shouldIgnore(path)) {
        tree.push(path);
      }
    });
    tree.sort().forEach(path => {
      const depth = path.split('/').length - 1;
      const indent = '  '.repeat(depth);
      const name = path.split('/').pop() || path;
      output += `${indent}${name}\\n`;
    });
    output += '```\\n\\n';

    // Concatenate files
    output += '## File Contents\\n\\n';

    for (const [path, file] of Object.entries(zip.files)) {
      if (file.dir) continue;

      const ext = path.substring(path.lastIndexOf('.')).toLowerCase();
      if (!selectedExtensions.has(ext)) continue;
      if (shouldIgnore(path)) continue;

      const depth = path.split('/').length - 1;
      if (depth > maxDepth) continue;

      try {
        let content = await file.async('string');
        const lines = content.split('\\n');

        output += `### ${path}\\n\`\`\`${ext.slice(1)}\\n`;

        if (lines.length <= maxLines) {
          output += content;
        } else {
          output += lines.slice(0, maxLines).join('\\n');
          output += `\\n... [${lines.length - maxLines} lines truncated]`;
        }

        output += '\\n\`\`\`\\n\\n';

        fileCount++;
        lineCount += Math.min(lines.length, maxLines);
        charCount += content.length;
      } catch (e) {
        console.error(`Error reading ${path}:`, e);
      }
    }

    concatenatedContent = output;

    document.getElementById('fileCount').textContent = fileCount;
    document.getElementById('lineCount').textContent = lineCount.toLocaleString();
    document.getElementById('charCount').textContent = charCount.toLocaleString();
    document.getElementById('stats').style.display = 'flex';
    document.getElementById('preview').textContent = output.substring(0, 5000) + (output.length > 5000 ? '\\n\\n... [Preview truncated]' : '');
    document.getElementById('preview').style.display = 'block';
    document.getElementById('downloadBtn').style.display = 'inline-block';
    document.getElementById('copyBtn').style.display = 'inline-block';
  });

  document.getElementById('downloadBtn').addEventListener('click', () => {
    const blob = new Blob([concatenatedContent], { type: 'text/markdown' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `repo-concatenated-${Date.now()}.md`;
    a.click();
    URL.revokeObjectURL(url);
  });

  document.getElementById('copyBtn').addEventListener('click', () => {
    navigator.clipboard.writeText(concatenatedContent);
    document.getElementById('copyBtn').textContent = '‚úì Copied!';
    setTimeout(() => document.getElementById('copyBtn').textContent = 'üìã Copy to Clipboard', 2000);
  });

  function shouldIgnore(path) {
    const ignorePatterns = ['node_modules', '__pycache__', '.git', 'dist', 'build', '.egg-info', 'htmlcov'];
    return ignorePatterns.some(pattern => path.includes(pattern));
  }
    </script>
{% endblock %}
