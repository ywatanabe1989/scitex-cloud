{% extends "global_base.html" %}
{% block title %}
    Image Concatenator -
    Browser Tool | SciTeX
{% endblock %}
{% block meta_description %}
    Concatenate multiple images into a single tiled image. Upload images, arrange in grid layout, customize spacing and background, download the result.
{% endblock %}
{% block head_extra %}
    {% load static %}
    <link rel="icon"
          type="image/png"
          sizes="192x192"
          href="{% static 'images/vectorstock_38853699/vectorstock_38853699-navy-inverted-192x192.png' %}?v=3" />
    <link rel="icon"
          type="image/png"
          sizes="48x48"
          href="{% static 'images/vectorstock_38853699/vectorstock_38853699-navy-inverted-48x48.png' %}?v=3" />
    <link rel="shortcut icon"
          href="{% static 'images/vectorstock_38853699/vectorstock_38853699-navy.ico' %}?v=3" />
{% endblock %}
{% block extra_css %}
    {% load static %}
    <style>
  .tool-detail-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 40px 20px;
  }

  .tool-header {
    text-align: center;
    padding: 40px 20px;
    margin-bottom: 40px;
  }

  .tool-icon-large {
    font-size: 64px;
    margin-bottom: 20px;
  }

  .tool-title {
    font-size: 42px;
    font-weight: 700;
    margin-bottom: 16px;
    color: var(--text-primary);
  }

  .tool-subtitle {
    font-size: 18px;
    color: var(--text-secondary);
    max-width: 600px;
    margin: 0 auto 30px;
    line-height: 1.6;
  }

  .tool-breadcrumb {
    font-size: 14px;
    color: var(--text-secondary);
    margin-bottom: 16px;
  }

  .tool-breadcrumb a {
    color: #4a9b7e;
    text-decoration: none;
  }

  .tool-breadcrumb a:hover {
    text-decoration: underline;
  }

  .tool-app-container {
    background: var(--bg-secondary);
    border-radius: 12px;
    padding: 40px;
    margin-bottom: 40px;
  }

  .upload-zone {
    border: 3px dashed #4a9b7e;
    border-radius: 8px;
    padding: 60px 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    background: var(--bg-primary);
  }

  .upload-zone:hover {
    border-color: #3a7c65;
    background: var(--bg-tertiary);
  }

  .upload-zone.dragging {
    border-color: #3a7c65;
    background: #f0fdf7;
  }

  .upload-icon {
    font-size: 48px;
    margin-bottom: 16px;
  }

  .upload-text {
    font-size: 18px;
    color: var(--text-primary);
    margin-bottom: 8px;
  }

  .upload-hint {
    font-size: 14px;
    color: var(--text-secondary);
  }

  .controls-panel {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin: 30px 0;
  }

  .control-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .control-label {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
  }

  .control-input {
    padding: 10px 14px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    font-size: 14px;
    background: var(--bg-primary);
    color: var(--text-primary);
  }

  .control-input:focus {
    outline: none;
    border-color: #4a9b7e;
  }

  .thumbnail-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 12px;
    margin: 20px 0;
  }

  .thumbnail-item {
    position: relative;
    aspect-ratio: 1;
    border-radius: 6px;
    overflow: hidden;
    border: 2px solid var(--border-color);
    cursor: move;
  }

  .thumbnail-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .thumbnail-remove {
    position: absolute;
    top: 4px;
    right: 4px;
    background: rgba(239, 68, 68, 0.9);
    color: white;
    border: none;
    border-radius: 4px;
    width: 24px;
    height: 24px;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .thumbnail-remove:hover {
    background: rgba(220, 38, 38, 1);
  }

  .preview-container {
    margin: 30px 0;
    text-align: center;
  }

  .preview-canvas {
    max-width: 100%;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background: white;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .action-buttons {
    display: flex;
    gap: 12px;
    justify-content: center;
    margin-top: 20px;
  }

  .btn {
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    border: none;
    transition: all 0.2s;
  }

  .btn-primary {
    background: #4a9b7e;
    color: white;
  }

  .btn-primary:hover:not(:disabled) {
    background: #3a7c65;
  }

  .btn-secondary {
    background: var(--bg-tertiary);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
  }

  .btn-secondary:hover:not(:disabled) {
    background: var(--bg-secondary);
  }

  .btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .tool-section {
    background: var(--bg-secondary);
    border-radius: 12px;
    padding: 30px;
    margin-bottom: 30px;
  }

  .tool-section-title {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 20px;
    color: var(--text-primary);
  }

  .tool-section-content {
    color: var(--text-secondary);
    line-height: 1.8;
  }

  .features-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-top: 20px;
  }

  .feature-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
  }

  .feature-icon {
    font-size: 20px;
    line-height: 1;
    margin-top: 2px;
  }

  .feature-text {
    flex: 1;
  }

  .feature-title {
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 4px;
  }

  .feature-desc {
    font-size: 14px;
    color: var(--text-secondary);
    line-height: 1.5;
  }

  .status-message {
    text-align: center;
    padding: 12px;
    border-radius: 6px;
    margin: 20px 0;
    font-size: 14px;
  }

  .status-message.info {
    background: #eff6ff;
    color: #1e40af;
    border: 1px solid #93c5fd;
  }

  .status-message.success {
    background: #f0fdf7;
    color: #15803d;
    border: 1px solid #86efac;
  }

  .status-message.error {
    background: #fef2f2;
    color: #991b1b;
    border: 1px solid #fca5a5;
  }
    </style>
{% endblock %}
{% block content %}
    <div class="tool-detail-container">
        <!-- Breadcrumb -->
        <div class="tool-breadcrumb">
            <a href="{% url 'public_app:tools' %}">‚Üê Back to Tools</a>
        </div>
        <!-- Header -->
        <div class="tool-header">
            <div class="tool-icon-large">üñºÔ∏è</div>
            <h1 class="tool-title">Image Concatenator</h1>
            <p class="tool-subtitle">
                Combine multiple images into a single tiled image. Upload your images, customize the layout, and download the result.
            </p>
        </div>
        <!-- Main Tool -->
        <div class="tool-app-container">
            <div id="uploadZone" class="upload-zone">
                <div class="upload-icon">üì§</div>
                <div class="upload-text">Drop images here or click to upload</div>
                <div class="upload-hint">Supports JPG, PNG, GIF, WebP</div>
                <input type="file"
                       id="fileInput"
                       accept="image/*"
                       multiple
                       style="display: none" />
            </div>
            <div id="statusMessage"></div>
            <div id="thumbnailContainer" style="display: none">
                <h3 style="margin: 20px 0 10px; font-size: 18px; font-weight: 600;">Uploaded Images (<span id="imageCount">0</span>)</h3>
                <div id="thumbnailGrid" class="thumbnail-grid"></div>
            </div>
            <div class="controls-panel">
                <div class="control-group">
                    <label class="control-label" for="columnsInput">Columns</label>
                    <input type="number"
                           id="columnsInput"
                           class="control-input"
                           value="3"
                           min="1"
                           max="10" />
                </div>
                <div class="control-group">
                    <label class="control-label" for="spacingInput">Spacing (px)</label>
                    <input type="number"
                           id="spacingInput"
                           class="control-input"
                           value="10"
                           min="0"
                           max="100" />
                </div>
                <div class="control-group">
                    <label class="control-label" for="bgColorInput">Background Color</label>
                    <input type="color"
                           id="bgColorInput"
                           class="control-input"
                           value="#ffffff" />
                </div>
                <div class="control-group">
                    <label class="control-label" for="formatInput">Output Format</label>
                    <select id="formatInput" class="control-input">
                        <option value="png">PNG (Best Quality)</option>
                        <option value="jpeg">JPEG (Smaller Size)</option>
                        <option value="webp">WebP (Modern)</option>
                    </select>
                </div>
            </div>
            <div class="action-buttons">
                <button id="generateBtn" class="btn btn-primary" disabled>
                    ‚ú® Generate Concatenated Image
                </button>
                <button id="clearBtn" class="btn btn-secondary" disabled>üóëÔ∏è Clear All</button>
            </div>
            <div id="previewContainer" class="preview-container" style="display: none">
                <h3 style="margin: 20px 0 10px; font-size: 18px; font-weight: 600;">Preview</h3>
                <canvas id="previewCanvas" class="preview-canvas"></canvas>
                <div class="action-buttons">
                    <button id="downloadBtn" class="btn btn-primary">üíæ Download Image</button>
                </div>
            </div>
        </div>
        <!-- Features -->
        <div class="tool-section">
            <h2 class="tool-section-title">‚ú® Features</h2>
            <div class="features-grid">
                <div class="feature-item">
                    <span class="feature-icon">üì§</span>
                    <div class="feature-text">
                        <div class="feature-title">Drag & Drop Upload</div>
                        <div class="feature-desc">Easily upload multiple images at once</div>
                    </div>
                </div>
                <div class="feature-item">
                    <span class="feature-icon">üé®</span>
                    <div class="feature-text">
                        <div class="feature-title">Customizable Layout</div>
                        <div class="feature-desc">Control columns, spacing, and background</div>
                    </div>
                </div>
                <div class="feature-item">
                    <span class="feature-icon">üîÑ</span>
                    <div class="feature-text">
                        <div class="feature-title">Reorder Images</div>
                        <div class="feature-desc">Drag thumbnails to rearrange</div>
                    </div>
                </div>
                <div class="feature-item">
                    <span class="feature-icon">üíæ</span>
                    <div class="feature-text">
                        <div class="feature-title">Multiple Formats</div>
                        <div class="feature-desc">Export as PNG, JPEG, or WebP</div>
                    </div>
                </div>
                <div class="feature-item">
                    <span class="feature-icon">üëÅÔ∏è</span>
                    <div class="feature-text">
                        <div class="feature-title">Live Preview</div>
                        <div class="feature-desc">See results before downloading</div>
                    </div>
                </div>
                <div class="feature-item">
                    <span class="feature-icon">üîí</span>
                    <div class="feature-text">
                        <div class="feature-title">100% Private</div>
                        <div class="feature-desc">All processing happens in your browser</div>
                    </div>
                </div>
            </div>
        </div>
        <!-- How to Use -->
        <div class="tool-section">
            <h2 class="tool-section-title">üìñ How to Use</h2>
            <div class="tool-section-content">
                <ol style="line-height: 2; padding-left: 20px;">
                    <li>
                        <strong>Upload images:</strong> Drag and drop images or click to browse
                    </li>
                    <li>
                        <strong>Arrange:</strong> Drag thumbnails to reorder them as needed
                    </li>
                    <li>
                        <strong>Customize:</strong> Adjust columns, spacing, and background color
                    </li>
                    <li>
                        <strong>Generate:</strong> Click "Generate Concatenated Image"
                    </li>
                    <li>
                        <strong>Download:</strong> Save the result to your computer
                    </li>
                </ol>
            </div>
        </div>
        <!-- Privacy -->
        <div class="tool-section">
            <h2 class="tool-section-title">üîí Privacy & Security</h2>
            <div class="tool-section-content">
                <ul style="line-height: 2; padding-left: 20px;">
                    <li>‚úÖ All processing happens locally in your browser</li>
                    <li>‚úÖ No images are uploaded to any server</li>
                    <li>‚úÖ No data is collected or stored</li>
                    <li>‚úÖ Works completely offline after page load</li>
                </ul>
            </div>
        </div>
    </div>
    <script>
  // State
  let images = [];
  let draggedIndex = null;

  // DOM elements
  const uploadZone = document.getElementById('uploadZone');
  const fileInput = document.getElementById('fileInput');
  const thumbnailContainer = document.getElementById('thumbnailContainer');
  const thumbnailGrid = document.getElementById('thumbnailGrid');
  const imageCount = document.getElementById('imageCount');
  const generateBtn = document.getElementById('generateBtn');
  const clearBtn = document.getElementById('clearBtn');
  const downloadBtn = document.getElementById('downloadBtn');
  const previewContainer = document.getElementById('previewContainer');
  const previewCanvas = document.getElementById('previewCanvas');
  const statusMessage = document.getElementById('statusMessage');
  const columnsInput = document.getElementById('columnsInput');
  const spacingInput = document.getElementById('spacingInput');
  const bgColorInput = document.getElementById('bgColorInput');
  const formatInput = document.getElementById('formatInput');

  // Upload zone interactions
  uploadZone.addEventListener('click', () => fileInput.click());

  uploadZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadZone.classList.add('dragging');
  });

  uploadZone.addEventListener('dragleave', () => {
    uploadZone.classList.remove('dragging');
  });

  uploadZone.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadZone.classList.remove('dragging');
    handleFiles(e.dataTransfer.files);
  });

  fileInput.addEventListener('change', (e) => {
    handleFiles(e.target.files);
  });

  // Handle file upload
  function handleFiles(files) {
    const fileArray = Array.from(files).filter(file => file.type.startsWith('image/'));

    if (fileArray.length === 0) {
      showStatus('No valid image files selected', 'error');
      return;
    }

    fileArray.forEach(file => {
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          images.push({ src: e.target.result, img: img, file: file });
          updateThumbnails();
          updateUI();
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    });

    showStatus(`Loading ${fileArray.length} image(s)...`, 'info');
  }

  // Update thumbnails
  function updateThumbnails() {
    thumbnailGrid.innerHTML = '';
    images.forEach((imageData, index) => {
      const div = document.createElement('div');
      div.className = 'thumbnail-item';
      div.draggable = true;
      div.innerHTML = `
        <img src="${imageData.src}" alt="Image ${index + 1}">
        <button class="thumbnail-remove" data-index="${index}">√ó</button>
      `;

      // Drag and drop for reordering
      div.addEventListener('dragstart', (e) => {
        draggedIndex = index;
        e.dataTransfer.effectAllowed = 'move';
      });

      div.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
      });

      div.addEventListener('drop', (e) => {
        e.preventDefault();
        if (draggedIndex !== null && draggedIndex !== index) {
          const draggedItem = images[draggedIndex];
          images.splice(draggedIndex, 1);
          images.splice(index, 0, draggedItem);
          updateThumbnails();
          draggedIndex = null;
        }
      });

      thumbnailGrid.appendChild(div);
    });

    // Remove button handlers
    document.querySelectorAll('.thumbnail-remove').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const index = parseInt(btn.dataset.index);
        images.splice(index, 1);
        updateThumbnails();
        updateUI();
      });
    });

    imageCount.textContent = images.length;
  }

  // Update UI state
  function updateUI() {
    const hasImages = images.length > 0;
    thumbnailContainer.style.display = hasImages ? 'block' : 'none';
    generateBtn.disabled = !hasImages;
    clearBtn.disabled = !hasImages;

    if (hasImages) {
      showStatus(`${images.length} image(s) ready`, 'success');
    }
  }

  // Show status message
  function showStatus(message, type = 'info') {
    statusMessage.className = `status-message ${type}`;
    statusMessage.textContent = message;
    statusMessage.style.display = 'block';
  }

  // Generate concatenated image
  generateBtn.addEventListener('click', () => {
    if (images.length === 0) return;

    const columns = parseInt(columnsInput.value) || 3;
    const spacing = parseInt(spacingInput.value) || 10;
    const bgColor = bgColorInput.value;

    showStatus('Generating concatenated image...', 'info');

    // Calculate layout
    const rows = Math.ceil(images.length / columns);

    // Find max width and height in each row/column
    const colWidths = new Array(columns).fill(0);
    const rowHeights = new Array(rows).fill(0);

    images.forEach((imageData, index) => {
      const col = index % columns;
      const row = Math.floor(index / columns);
      colWidths[col] = Math.max(colWidths[col], imageData.img.width);
      rowHeights[row] = Math.max(rowHeights[row], imageData.img.height);
    });

    // Calculate canvas size
    const canvasWidth = colWidths.reduce((sum, w) => sum + w, 0) + spacing * (columns + 1);
    const canvasHeight = rowHeights.reduce((sum, h) => sum + h, 0) + spacing * (rows + 1);

    // Set canvas size
    previewCanvas.width = canvasWidth;
    previewCanvas.height = canvasHeight;

    // Draw
    const ctx = previewCanvas.getContext('2d');
    ctx.fillStyle = bgColor;
    ctx.fillRect(0, 0, canvasWidth, canvasHeight);

    let currentY = spacing;
    for (let row = 0; row < rows; row++) {
      let currentX = spacing;
      for (let col = 0; col < columns; col++) {
        const index = row * columns + col;
        if (index >= images.length) break;

        const imageData = images[index];
        const img = imageData.img;

        // Center image in cell
        const cellWidth = colWidths[col];
        const cellHeight = rowHeights[row];
        const x = currentX + (cellWidth - img.width) / 2;
        const y = currentY + (cellHeight - img.height) / 2;

        ctx.drawImage(img, x, y);
        currentX += cellWidth + spacing;
      }
      currentY += rowHeights[row] + spacing;
    }

    previewContainer.style.display = 'block';
    showStatus('Image generated successfully!', 'success');

    // Scroll to preview
    previewContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  });

  // Download image
  downloadBtn.addEventListener('click', () => {
    const format = formatInput.value;
    const mimeType = format === 'jpeg' ? 'image/jpeg' : format === 'webp' ? 'image/webp' : 'image/png';
    const extension = format;

    previewCanvas.toBlob((blob) => {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `concatenated-image-${Date.now()}.${extension}`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showStatus('Image downloaded!', 'success');
    }, mimeType, 0.95);
  });

  // Clear all
  clearBtn.addEventListener('click', () => {
    if (confirm('Are you sure you want to clear all images?')) {
      images = [];
      updateThumbnails();
      updateUI();
      previewContainer.style.display = 'none';
      statusMessage.style.display = 'none';
      fileInput.value = '';
    }
  });

  // Auto-regenerate on control change
  [columnsInput, spacingInput, bgColorInput].forEach(input => {
    input.addEventListener('change', () => {
      if (images.length > 0 && previewContainer.style.display !== 'none') {
        generateBtn.click();
      }
    });
  });
    </script>
{% endblock %}
