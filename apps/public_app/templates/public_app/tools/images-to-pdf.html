{% extends "global_base.html" %}
{% block title %}Images to PDF - Browser Tool | SciTeX{% endblock %}
{% block meta_description %}Convert multiple images into a single PDF document. Perfect for creating figure compilations and supplements.{% endblock %}
{% block head_extra %}
    {% load static %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
{% endblock %}
{% block extra_css %}
    <style>
  .tool-detail-container { max-width: 1200px; margin: 0 auto; padding: 40px 20px; }
  .tool-header { text-align: center; padding: 40px 20px; margin-bottom: 40px; }
  .tool-title { font-size: 42px; font-weight: 700; margin-bottom: 16px; }
  .tool-breadcrumb { font-size: 14px; margin-bottom: 16px; }
  .tool-breadcrumb a { color: #4a9b7e; text-decoration: none; }
  .tool-app-container { background: var(--bg-secondary); border-radius: 12px; padding: 40px; }
  .upload-zone { border: 3px dashed #4a9b7e; border-radius: 8px; padding: 60px 20px; text-align: center; cursor: pointer; background: var(--bg-primary); }
  .upload-zone:hover { border-color: #3a7c65; background: var(--bg-tertiary); }
  .controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }
  .control-group { display: flex; flex-direction: column; gap: 8px; }
  .control-label { font-size: 14px; font-weight: 600; }
  .control-select { padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); }
  .thumbnail-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 12px; margin: 20px 0; }
  .thumbnail-item { position: relative; aspect-ratio: 1; border-radius: 6px; overflow: hidden; border: 2px solid var(--border-color); cursor: move; }
  .thumbnail-item img { width: 100%; height: 100%; object-fit: cover; }
  .thumbnail-remove { position: absolute; top: 4px; right: 4px; background: #ef4444; color: white; border: none; border-radius: 4px; width: 24px; height: 24px; cursor: pointer; }
  .btn { padding: 12px 24px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; border: none; }
  .btn-primary { background: #4a9b7e; color: white; }
  .btn-primary:hover:not(:disabled) { background: #3a7c65; }
  .btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .status-message { text-align: center; padding: 12px; border-radius: 6px; margin: 20px 0; }
  .status-message.success { background: #f0fdf7; color: #15803d; }
    </style>
{% endblock %}
{% block content %}
    <div class="tool-detail-container">
        <div class="tool-breadcrumb"><a href="{% url 'public_app:tools' %}">‚Üê Back to Tools</a></div>
        <div class="tool-header">
            <div style="font-size: 64px; margin-bottom: 20px;">üìÑ</div>
            <h1 class="tool-title">Images to PDF</h1>
            <p style="font-size: 18px; color: var(--text-secondary);">Convert multiple images into a single PDF document</p>
        </div>
        <div class="tool-app-container">
            <div id="uploadZone" class="upload-zone">
                <div style="font-size: 48px; margin-bottom: 16px;">üì§</div>
                <div style="font-size: 18px; margin-bottom: 8px;">Drop images or click to upload</div>
                <div style="font-size: 14px; color: var(--text-secondary);">PNG, JPG, WebP</div>
                <input type="file" id="fileInput" accept="image/*" multiple style="display: none" />
            </div>
            <div id="statusMessage"></div>
            <div id="thumbnailContainer" style="display: none">
                <h3>Images (<span id="imageCount">0</span>) - Drag to reorder</h3>
                <div id="thumbnailGrid" class="thumbnail-grid"></div>
            </div>
            <div class="controls" id="controls" style="display: none;">
                <div class="control-group">
                    <label class="control-label">Page Size</label>
                    <select id="pageSizeSelect" class="control-select">
                        <option value="A4">A4 (210 √ó 297 mm)</option>
                        <option value="Letter">Letter (8.5 √ó 11 in)</option>
                        <option value="Legal">Legal (8.5 √ó 14 in)</option>
                        <option value="Fit">Fit to Image</option>
                    </select>
                </div>
                <div class="control-group">
                    <label class="control-label">Orientation</label>
                    <select id="orientationSelect" class="control-select">
                        <option value="portrait">Portrait</option>
                        <option value="landscape">Landscape</option>
                    </select>
                </div>
                <div class="control-group">
                    <label class="control-label">Margin (pt)</label>
                    <select id="marginSelect" class="control-select">
                        <option value="0">None</option>
                        <option value="36" selected>0.5 inch</option>
                        <option value="72">1 inch</option>
                    </select>
                </div>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button id="generateBtn" class="btn btn-primary" disabled>üìÑ Generate PDF</button>
            </div>
        </div>
    </div>
    <script>
  const { PDFDocument } = PDFLib;
  let images = [];
  let draggedIndex = null;

  document.getElementById('uploadZone').addEventListener('click', () => document.getElementById('fileInput').click());

  document.getElementById('fileInput').addEventListener('change', (e) => {
    handleFiles(e.target.files);
  });

  function handleFiles(files) {
    const fileArray = Array.from(files).filter(f => f.type.startsWith('image/'));
    if (fileArray.length === 0) return;

    fileArray.forEach(file => {
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          images.push({ src: e.target.result, img: img });
          updateThumbnails();
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    });
  }

  function updateThumbnails() {
    const grid = document.getElementById('thumbnailGrid');
    grid.innerHTML = '';
    images.forEach((imageData, index) => {
      const div = document.createElement('div');
      div.className = 'thumbnail-item';
      div.draggable = true;
      div.innerHTML = `<img src="${imageData.src}" /><button class="thumbnail-remove" data-index="${index}">√ó</button>`;

      div.addEventListener('dragstart', (e) => { draggedIndex = index; });
      div.addEventListener('dragover', (e) => { e.preventDefault(); });
      div.addEventListener('drop', (e) => {
        e.preventDefault();
        if (draggedIndex !== null && draggedIndex !== index) {
          const item = images[draggedIndex];
          images.splice(draggedIndex, 1);
          images.splice(index, 0, item);
          updateThumbnails();
          draggedIndex = null;
        }
      });

      grid.appendChild(div);
    });

    document.querySelectorAll('.thumbnail-remove').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        images.splice(parseInt(btn.dataset.index), 1);
        updateThumbnails();
      });
    });

    document.getElementById('imageCount').textContent = images.length;
    document.getElementById('thumbnailContainer').style.display = images.length > 0 ? 'block' : 'none';
    document.getElementById('controls').style.display = images.length > 0 ? 'grid' : 'none';
    document.getElementById('generateBtn').disabled = images.length === 0;
  }

  document.getElementById('generateBtn').addEventListener('click', async () => {
    if (images.length === 0) return;

    const pdfDoc = await PDFDocument.create();
    const pageSize = document.getElementById('pageSizeSelect').value;
    const orientation = document.getElementById('orientationSelect').value;
    const margin = parseInt(document.getElementById('marginSelect').value);

    const pageSizes = {
      'A4': [595, 842],
      'Letter': [612, 792],
      'Legal': [612, 1008]
    };

    for (const imageData of images) {
      const imgBytes = await fetch(imageData.src).then(r => r.arrayBuffer());
      const img = await pdfDoc.embedPng(imgBytes).catch(() => pdfDoc.embedJpg(imgBytes));

      let [pageWidth, pageHeight] = pageSize === 'Fit' ? [img.width, img.height] : pageSizes[pageSize];
      if (orientation === 'landscape') [pageWidth, pageHeight] = [pageHeight, pageWidth];

      const page = pdfDoc.addPage([pageWidth, pageHeight]);
      const availWidth = pageWidth - (2 * margin);
      const availHeight = pageHeight - (2 * margin);

      const scale = Math.min(availWidth / img.width, availHeight / img.height);
      const scaledWidth = img.width * scale;
      const scaledHeight = img.height * scale;

      const x = (pageWidth - scaledWidth) / 2;
      const y = (pageHeight - scaledHeight) / 2;

      page.drawImage(img, { x, y, width: scaledWidth, height: scaledHeight });
    }

    const pdfBytes = await pdfDoc.save();
    const blob = new Blob([pdfBytes], { type: 'application/pdf' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `images-to-pdf-${Date.now()}.pdf`;
    a.click();
    URL.revokeObjectURL(url);

    showStatus('PDF created successfully!', 'success');
  });

  function showStatus(message, type) {
    const status = document.getElementById('statusMessage');
    status.className = `status-message ${type}`;
    status.textContent = message;
    status.style.display = 'block';
  }
    </script>
{% endblock %}
