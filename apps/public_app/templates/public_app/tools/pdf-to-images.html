{% extends "global_base.html" %}
{% block title %}PDF to Images - Browser Tool | SciTeX{% endblock %}
{% block meta_description %}Extract pages from PDF as PNG or JPG images. Perfect for extracting figures from papers.{% endblock %}
{% block head_extra %}
    {% load static %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
{% endblock %}
{% block extra_css %}
    <style>
  .tool-detail-container { max-width: 1200px; margin: 0 auto; padding: 40px 20px; }
  .tool-header { text-align: center; padding: 40px 20px; margin-bottom: 40px; }
  .tool-title { font-size: 42px; font-weight: 700; margin-bottom: 16px; }
  .tool-breadcrumb { font-size: 14px; margin-bottom: 16px; }
  .tool-breadcrumb a { color: #4a9b7e; text-decoration: none; }
  .tool-app-container { background: var(--bg-secondary); border-radius: 12px; padding: 40px; }
  .upload-zone { border: 3px dashed #4a9b7e; border-radius: 8px; padding: 60px 20px; text-align: center; cursor: pointer; background: var(--bg-primary); }
  .controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }
  .control-group { display: flex; flex-direction: column; gap: 8px; }
  .control-label { font-size: 14px; font-weight: 600; }
  .control-select, .control-input { padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); }
  .preview-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; margin: 20px 0; }
  .preview-item { border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; background: white; }
  .preview-item img { width: 100%; display: block; }
  .preview-info { padding: 10px; text-align: center; font-size: 12px; background: var(--bg-tertiary); }
  .btn { padding: 12px 24px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; border: none; }
  .btn-primary { background: #4a9b7e; color: white; }
  .btn-primary:hover:not(:disabled) { background: #3a7c65; }
  .btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .status-message { text-align: center; padding: 12px; border-radius: 6px; margin: 20px 0; }
  .status-message.info { background: #eff6ff; color: #1e40af; }
  .status-message.success { background: #f0fdf7; color: #15803d; }
    </style>
{% endblock %}
{% block content %}
    <div class="tool-detail-container">
        <div class="tool-breadcrumb"><a href="{% url 'public_app:tools' %}">‚Üê Back to Tools</a></div>
        <div class="tool-header">
            <div style="font-size: 64px; margin-bottom: 20px;">üñºÔ∏è</div>
            <h1 class="tool-title">PDF to Images</h1>
            <p style="font-size: 18px; color: var(--text-secondary);">Extract pages from PDF as images</p>
        </div>
        <div class="tool-app-container">
            <div id="uploadZone" class="upload-zone">
                <div style="font-size: 48px; margin-bottom: 16px;">üì§</div>
                <div style="font-size: 18px;">Drop PDF or click to upload</div>
                <input type="file" id="fileInput" accept=".pdf" style="display: none" />
            </div>
            <div id="statusMessage"></div>
            <div class="controls" id="controls" style="display: none;">
                <div class="control-group">
                    <label class="control-label">Output Format</label>
                    <select id="formatSelect" class="control-select">
                        <option value="png">PNG (Best Quality)</option>
                        <option value="jpeg">JPEG (Smaller Size)</option>
                    </select>
                </div>
                <div class="control-group">
                    <label class="control-label">Scale (DPI)</label>
                    <select id="scaleSelect" class="control-select">
                        <option value="1">72 DPI (Screen)</option>
                        <option value="2" selected>144 DPI (High)</option>
                        <option value="3">216 DPI (Print)</option>
                        <option value="4">288 DPI (Max)</option>
                    </select>
                </div>
            </div>
            <div id="previewGrid" class="preview-grid"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button id="downloadAllBtn" class="btn btn-primary" style="display: none;">üíæ Download All Images</button>
            </div>
        </div>
    </div>
    <script>
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
  let extractedImages = [];

  document.getElementById('uploadZone').addEventListener('click', () => document.getElementById('fileInput').click());

  document.getElementById('fileInput').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file || file.type !== 'application/pdf') return;

    showStatus('Loading PDF...', 'info');
    const arrayBuffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

    document.getElementById('controls').style.display = 'grid';
    extractPages(pdf);
  });

  async function extractPages(pdf) {
    const scale = parseInt(document.getElementById('scaleSelect').value);
    const format = document.getElementById('formatSelect').value;
    const grid = document.getElementById('previewGrid');
    grid.innerHTML = '';
    extractedImages = [];

    showStatus(`Extracting ${pdf.numPages} pages...`, 'info');

    for (let i = 1; i <= pdf.numPages; i++) {
      const page = await pdf.getPage(i);
      const viewport = page.getViewport({ scale });
      const canvas = document.createElement('canvas');
      canvas.width = viewport.width;
      canvas.height = viewport.height;

      await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;

      const dataUrl = canvas.toDataURL(`image/${format}`, 0.95);
      extractedImages.push({ dataUrl, pageNum: i });

      const div = document.createElement('div');
      div.className = 'preview-item';
      div.innerHTML = `<img src="${dataUrl}" /><div class="preview-info">Page ${i}</div>`;
      grid.appendChild(div);
    }

    document.getElementById('downloadAllBtn').style.display = 'inline-block';
    showStatus(`${pdf.numPages} pages extracted!`, 'success');
  }

  document.getElementById('scaleSelect').addEventListener('change', async () => {
    const file = document.getElementById('fileInput').files[0];
    if (file) {
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      extractPages(pdf);
    }
  });

  document.getElementById('formatSelect').addEventListener('change', async () => {
    const file = document.getElementById('fileInput').files[0];
    if (file) {
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      extractPages(pdf);
    }
  });

  document.getElementById('downloadAllBtn').addEventListener('click', () => {
    extractedImages.forEach(({ dataUrl, pageNum }) => {
      const a = document.createElement('a');
      a.href = dataUrl;
      const ext = document.getElementById('formatSelect').value;
      a.download = `page-${pageNum}.${ext}`;
      a.click();
    });
    showStatus('Downloaded all images!', 'success');
  });

  function showStatus(message, type) {
    const status = document.getElementById('statusMessage');
    status.className = `status-message ${type}`;
    status.textContent = message;
    status.style.display = 'block';
  }
    </script>
{% endblock %}
