{% extends "global_base.html" %}
{% block title %}PDF Compressor - Browser Tool | SciTeX{% endblock %}
{% block meta_description %}Reduce PDF file size while maintaining quality. Perfect for email attachments and uploads.{% endblock %}
{% block head_extra %}
    {% load static %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
{% endblock %}
{% block extra_css %}
    <style>
  .tool-detail-container { max-width: 1000px; margin: 0 auto; padding: 40px 20px; }
  .tool-header { text-align: center; padding: 40px 20px; margin-bottom: 40px; }
  .tool-title { font-size: 42px; font-weight: 700; margin-bottom: 16px; }
  .tool-breadcrumb { font-size: 14px; margin-bottom: 16px; }
  .tool-breadcrumb a { color: #4a9b7e; text-decoration: none; }
  .tool-app-container { background: var(--bg-secondary); border-radius: 12px; padding: 40px; }
  .upload-zone { border: 3px dashed #4a9b7e; border-radius: 8px; padding: 60px 20px; text-align: center; cursor: pointer; background: var(--bg-primary); }
  .file-info { background: var(--bg-primary); padding: 20px; border-radius: 8px; margin: 20px 0; }
  .size-comparison { display: flex; justify-content: space-around; text-align: center; margin: 20px 0; }
  .size-box { padding: 20px; }
  .size-label { font-size: 14px; color: var(--text-secondary); margin-bottom: 8px; }
  .size-value { font-size: 32px; font-weight: 700; color: #4a9b7e; }
  .compression-ratio { font-size: 18px; font-weight: 600; color: #4a9b7e; margin-top: 10px; }
  .btn { padding: 12px 24px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; border: none; }
  .btn-primary { background: #4a9b7e; color: white; }
  .btn-primary:hover:not(:disabled) { background: #3a7c65; }
  .btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .status-message { text-align: center; padding: 12px; border-radius: 6px; margin: 20px 0; }
  .status-message.info { background: #eff6ff; color: #1e40af; }
  .status-message.success { background: #f0fdf7; color: #15803d; }
    </style>
{% endblock %}
{% block content %}
    <div class="tool-detail-container">
        <div class="tool-breadcrumb"><a href="{% url 'public_app:tools' %}">‚Üê Back to Tools</a></div>
        <div class="tool-header">
            <div style="font-size: 64px; margin-bottom: 20px;">üóúÔ∏è</div>
            <h1 class="tool-title">PDF Compressor</h1>
            <p style="font-size: 18px; color: var(--text-secondary);">Reduce PDF file size for easier sharing</p>
        </div>
        <div class="tool-app-container">
            <div id="uploadZone" class="upload-zone">
                <div style="font-size: 48px; margin-bottom: 16px;">üì§</div>
                <div style="font-size: 18px;">Drop PDF or click to upload</div>
                <input type="file" id="fileInput" accept=".pdf" style="display: none" />
            </div>
            <div id="statusMessage"></div>
            <div id="fileInfo" class="file-info" style="display: none;">
                <div class="size-comparison">
                    <div class="size-box">
                        <div class="size-label">Original Size</div>
                        <div class="size-value" id="originalSize">0</div>
                    </div>
                    <div class="size-box">
                        <div style="font-size: 32px; color: var(--text-secondary);">‚Üí</div>
                    </div>
                    <div class="size-box">
                        <div class="size-label">Compressed Size</div>
                        <div class="size-value" id="compressedSize">0</div>
                    </div>
                </div>
                <div class="compression-ratio" id="compressionRatio"></div>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button id="downloadBtn" class="btn btn-primary" style="display: none;">üíæ Download Compressed PDF</button>
            </div>
        </div>
    </div>
    <script>
  const { PDFDocument } = PDFLib;
  let compressedPdfBytes = null;
  let originalFileName = '';

  document.getElementById('uploadZone').addEventListener('click', () => document.getElementById('fileInput').click());

  document.getElementById('fileInput').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file || file.type !== 'application/pdf') return;

    originalFileName = file.name;
    const originalSize = file.size;

    showStatus('Compressing PDF...', 'info');

    const arrayBuffer = await file.arrayBuffer();
    const pdfDoc = await PDFDocument.load(arrayBuffer);

    // Basic compression by re-saving
    compressedPdfBytes = await pdfDoc.save({
      useObjectStreams: true,
      addDefaultPage: false,
      objectsPerTick: 50
    });

    const compressedSize = compressedPdfBytes.length;
    const reduction = ((originalSize - compressedSize) / originalSize * 100).toFixed(1);

    document.getElementById('originalSize').textContent = formatSize(originalSize);
    document.getElementById('compressedSize').textContent = formatSize(compressedSize);
    document.getElementById('compressionRatio').textContent = `${reduction}% smaller`;

    document.getElementById('fileInfo').style.display = 'block';
    document.getElementById('downloadBtn').style.display = 'inline-block';

    showStatus('PDF compressed successfully!', 'success');
  });

  document.getElementById('downloadBtn').addEventListener('click', () => {
    const blob = new Blob([compressedPdfBytes], { type: 'application/pdf' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    const name = originalFileName.replace('.pdf', '');
    a.download = `${name}-compressed.pdf`;
    a.click();
    URL.revokeObjectURL(url);
  });

  function formatSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
  }

  function showStatus(message, type) {
    const status = document.getElementById('statusMessage');
    status.className = `status-message ${type}`;
    status.textContent = message;
    status.style.display = 'block';
  }
    </script>
{% endblock %}
