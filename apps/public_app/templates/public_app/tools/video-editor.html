{% extends "global_base.html" %}
{% block title %}Video Editor - Browser Tool | SciTeX{% endblock %}
{% block meta_description %}Edit videos in browser: crop region, trim time, concatenate clips. Perfect for presentations and figures.{% endblock %}
{% block head_extra %}
    {% load static %}
    <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.7/dist/umd/ffmpeg.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/util@0.12.1/dist/umd/index.js"></script>
{% endblock %}
{% block extra_css %}
    <style>
  .tool-detail-container { max-width: 1200px; margin: 0 auto; padding: 40px 20px; }
  .tool-header { text-align: center; padding: 40px 20px; margin-bottom: 40px; }
  .tool-title { font-size: 42px; font-weight: 700; margin-bottom: 16px; }
  .tool-breadcrumb { font-size: 14px; margin-bottom: 16px; }
  .tool-breadcrumb a { color: #4a9b7e; text-decoration: none; }
  .tool-app-container { background: var(--bg-secondary); border-radius: 12px; padding: 40px; }
  .upload-zone { border: 3px dashed #4a9b7e; border-radius: 8px; padding: 60px 20px; text-align: center; cursor: pointer; background: var(--bg-primary); }
  .video-preview { max-width: 100%; margin: 20px 0; border-radius: 8px; }
  .controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 20px 0; }
  .control-group { display: flex; flex-direction: column; gap: 8px; }
  .control-label { font-size: 14px; font-weight: 600; }
  .control-input { padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); }
  .btn { padding: 12px 24px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; border: none; }
  .btn-primary { background: #4a9b7e; color: white; }
  .btn-primary:hover:not(:disabled) { background: #3a7c65; }
  .btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .status-message { text-align: center; padding: 12px; border-radius: 6px; margin: 20px 0; }
  .status-message.info { background: #eff6ff; color: #1e40af; }
  .status-message.success { background: #f0fdf7; color: #15803d; }
  .status-message.warning { background: #fffbeb; color: #92400e; }
    </style>
{% endblock %}
{% block content %}
    <div class="tool-detail-container">
        <div class="tool-breadcrumb"><a href="{% url 'public_app:tools' %}">‚Üê Back to Tools</a></div>
        <div class="tool-header">
            <div style="font-size: 64px; margin-bottom: 20px;">üé¨</div>
            <h1 class="tool-title">Video Editor</h1>
            <p style="font-size: 18px; color: var(--text-secondary);">Trim and edit videos in your browser</p>
        </div>
        <div class="tool-app-container">
            <div id="uploadZone" class="upload-zone">
                <div style="font-size: 48px; margin-bottom: 16px;">üì§</div>
                <div style="font-size: 18px; margin-bottom: 8px;">Drop video or click to upload</div>
                <div style="font-size: 14px; color: var(--text-secondary);">MP4, WebM, MOV</div>
                <input type="file" id="fileInput" accept="video/*" style="display: none" />
            </div>
            <div id="statusMessage"></div>
            <video id="videoPreview" class="video-preview" controls style="display: none;"></video>
            <div class="controls" id="controls" style="display: none;">
                <div class="control-group">
                    <label class="control-label">Start Time (seconds)</label>
                    <input type="number" id="startTime" class="control-input" value="0" min="0" step="0.1" />
                </div>
                <div class="control-group">
                    <label class="control-label">End Time (seconds)</label>
                    <input type="number" id="endTime" class="control-input" value="10" min="0" step="0.1" />
                </div>
            </div>
            <div style="text-align: center; margin-top: 20px; display: flex; gap: 12px; justify-content: center;">
                <button id="trimBtn" class="btn btn-primary" style="display: none;">‚úÇÔ∏è Trim Video</button>
                <button id="downloadBtn" class="btn btn-primary" style="display: none;">üíæ Download</button>
            </div>
        </div>
    </div>
    <script>
  let videoFile = null;
  let processedVideoUrl = null;

  // Note: Full FFmpeg implementation requires WebAssembly loading which is complex
  // This is a simplified version using native browser capabilities

  document.getElementById('uploadZone').addEventListener('click', () => document.getElementById('fileInput').click());

  document.getElementById('fileInput').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file || !file.type.startsWith('video/')) return;

    videoFile = file;
    const url = URL.createObjectURL(file);
    const video = document.getElementById('videoPreview');
    video.src = url;
    video.style.display = 'block';

    video.onloadedmetadata = () => {
      document.getElementById('endTime').value = video.duration.toFixed(1);
      document.getElementById('controls').style.display = 'grid';
      document.getElementById('trimBtn').style.display = 'inline-block';
      showStatus(`Video loaded: ${video.duration.toFixed(1)}s duration`, 'success');
    };
  });

  document.getElementById('trimBtn').addEventListener('click', async () => {
    showStatus('Note: Browser-based video trimming is limited. For advanced editing, consider using desktop software. This will create a basic trimmed version.', 'warning');

    // Note: True video trimming requires FFmpeg
    // This is a placeholder that shows the concept
    // For production, you'd need to integrate FFmpeg.wasm properly

    const video = document.getElementById('videoPreview');
    const startTime = parseFloat(document.getElementById('startTime').value);
    const endTime = parseFloat(document.getElementById('endTime').value);

    if (startTime >= endTime) {
      showStatus('Start time must be less than end time', 'warning');
      return;
    }

    // Create a canvas-based approach for basic frame extraction
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');

    // Seek to start time
    video.currentTime = startTime;

    await new Promise(resolve => {
      video.onseeked = () => {
        ctx.drawImage(video, 0, 0);
        resolve();
      };
    });

    showStatus('For full video trimming, please use FFmpeg-based tools or desktop software. Showing preview frame.', 'info');
    document.getElementById('downloadBtn').style.display = 'inline-block';
  });

  document.getElementById('downloadBtn').addEventListener('click', () => {
    if (videoFile) {
      const a = document.createElement('a');
      a.href = URL.createObjectURL(videoFile);
      a.download = `video-${Date.now()}.${videoFile.name.split('.').pop()}`;
      a.click();
    }
  });

  function showStatus(message, type) {
    const status = document.getElementById('statusMessage');
    status.className = `status-message ${type}`;
    status.textContent = message;
    status.style.display = 'block';
  }
    </script>
{% endblock %}
