{% extends "global_base.html" %}
{% block title %}Image & PDF Viewer - Dimension Inspector | SciTeX{% endblock %}
{% block meta_description %}View image and PDF dimensions, DPI, and unit conversions (mm/inch) for publication figures{% endblock %}
{% block extra_css %}
<style>
  .tool-detail-container { max-width: 1400px; margin: 0 auto; padding: 40px 20px; }
  .tool-header { text-align: center; padding: 40px 20px; margin-bottom: 40px; }
  .tool-title { font-size: 42px; font-weight: 700; margin-bottom: 16px; }
  .tool-breadcrumb { font-size: 14px; margin-bottom: 16px; }
  .tool-breadcrumb a { color: #4a9b7e; text-decoration: none; }
  .tool-app-container { background: var(--bg-secondary); border-radius: 12px; padding: 40px; }
  .upload-zone { border: 3px dashed #4a9b7e; border-radius: 8px; padding: 60px 20px; text-align: center; cursor: pointer; background: var(--bg-primary); transition: all 0.3s; }
  .upload-zone:hover { border-color: #3a7c65; background: var(--bg-hover); }
  .content-grid { display: grid; grid-template-columns: 1fr 400px; gap: 30px; margin-top: 30px; }
  .image-display { background: var(--bg-primary); border-radius: 8px; padding: 20px; text-align: center; }
  .image-display img, .image-display canvas, .image-display iframe { max-width: 100%; border: 1px solid var(--border-color); border-radius: 4px; }
  .info-panel { background: var(--bg-primary); border-radius: 8px; padding: 20px; }
  .info-section { margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid var(--border-color); }
  .info-section:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
  .info-title { font-size: 16px; font-weight: 700; margin-bottom: 12px; color: #4a9b7e; }
  .info-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
  .info-label { font-size: 14px; color: var(--text-secondary); }
  .info-value { font-size: 14px; font-weight: 600; font-family: monospace; }
  .dpi-input-group { display: flex; gap: 10px; align-items: center; margin-top: 12px; }
  .dpi-input { flex: 1; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; }
  .dpi-btn { padding: 8px 16px; background: #4a9b7e; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; }
  .dpi-btn:hover { background: #3a7c65; }
  .alert { padding: 12px; border-radius: 6px; margin-bottom: 16px; font-size: 14px; }
  .alert-info { background: #e3f2fd; color: #1976d2; border: 1px solid #90caf9; }
  .btn { padding: 12px 24px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; border: none; margin: 5px; }
  .btn-primary { background: #4a9b7e; color: white; }
  .btn-primary:hover:not(:disabled) { background: #3a7c65; }
  .btn-secondary { background: #6c757d; color: white; }
  .btn-secondary:hover:not(:disabled) { background: #5a6268; }
  .pdf-embed { width: 100%; height: 600px; border: 1px solid var(--border-color); border-radius: 4px; }
  @media (max-width: 768px) {
    .content-grid { grid-template-columns: 1fr; }
  }
</style>
<!-- PDF.js library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
</script>
{% endblock %}
{% block content %}
<div class="tool-detail-container">
  <div class="tool-breadcrumb"><a href="{% url 'public_app:tools' %}">‚Üê Back to Tools</a></div>
  <div class="tool-header">
    <div style="font-size: 64px; margin-bottom: 20px;">üìê</div>
    <h1 class="tool-title">Image & PDF Viewer</h1>
    <p style="font-size: 18px; color: var(--text-secondary);">View image and PDF dimensions, DPI, and unit conversions for publication figures</p>
  </div>
  <div class="tool-app-container">
    <div id="uploadZone" class="upload-zone">
      <div style="font-size: 48px; margin-bottom: 16px;">üì§</div>
      <div style="font-size: 18px;">Drop file or click to upload</div>
      <div style="font-size: 14px; color: var(--text-secondary); margin-top: 8px;">Supports: PNG, JPG, WEBP, GIF, TIFF, BMP, PDF</div>
      <input type="file" id="fileInput" accept="image/*,application/pdf" style="display: none" />
    </div>

    <div id="contentArea" style="display: none;">
      <div class="content-grid">
        <div class="image-display">
          <div style="margin-bottom: 12px; font-weight: 600;" id="previewTitle">Preview</div>
          <img id="imagePreview" src="" alt="Uploaded file" style="display: none;" />
          <canvas id="pdfCanvas" style="display: none;"></canvas>
          <div id="pdfControls" style="display: none; margin-top: 16px;">
            <button id="prevPage" class="btn btn-primary">‚Üê Previous</button>
            <span style="margin: 0 16px;">Page <span id="currentPage">1</span> / <span id="totalPages">1</span></span>
            <button id="nextPage" class="btn btn-primary">Next ‚Üí</button>
          </div>
          <div style="margin-top: 16px;">
            <button id="clearBtn" class="btn btn-secondary">Clear File</button>
          </div>
        </div>

        <div class="info-panel">
          <div class="info-section" id="dimensionsSection">
            <div class="info-title">Dimensions</div>
            <div class="info-row">
              <span class="info-label">Width:</span>
              <span class="info-value" id="pixelWidth">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">Height:</span>
              <span class="info-value" id="pixelHeight">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">Aspect Ratio:</span>
              <span class="info-value" id="aspectRatio">-</span>
            </div>
            <div class="info-row" id="pdfPageCountRow" style="display: none;">
              <span class="info-label">Total Pages:</span>
              <span class="info-value" id="pdfPageCount">-</span>
            </div>
          </div>

          <div class="info-section">
            <div class="info-title">DPI (Dots Per Inch)</div>
            <div class="alert alert-info" id="dpiAlert" style="display: none;">
              DPI metadata not found. Using default or custom value.
            </div>
            <div class="info-row">
              <span class="info-label">Horizontal DPI:</span>
              <span class="info-value" id="dpiX">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">Vertical DPI:</span>
              <span class="info-value" id="dpiY">-</span>
            </div>
            <div class="dpi-input-group">
              <input type="number" id="customDpi" class="dpi-input" placeholder="Custom DPI (e.g., 300)" value="300" />
              <button id="applyDpiBtn" class="dpi-btn">Apply DPI</button>
            </div>
          </div>

          <div class="info-section">
            <div class="info-title">Physical Size (@ <span id="usedDpi">300</span> DPI)</div>
            <div class="info-row">
              <span class="info-label">Width (mm):</span>
              <span class="info-value" id="widthMm">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">Height (mm):</span>
              <span class="info-value" id="heightMm">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">Width (inch):</span>
              <span class="info-value" id="widthInch">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">Height (inch):</span>
              <span class="info-value" id="heightInch">-</span>
            </div>
          </div>

          <div class="info-section">
            <div class="info-title">File Information</div>
            <div class="info-row">
              <span class="info-label">File Name:</span>
              <span class="info-value" id="fileName">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">File Size:</span>
              <span class="info-value" id="fileSize">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">File Type:</span>
              <span class="info-value" id="fileType">-</span>
            </div>
          </div>

          <div class="info-section">
            <div class="info-title">Journal Standards (Single Column)</div>
            <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">Common journal widths @ 300 DPI</div>
            <div class="info-row">
              <span class="info-label">Nature/Science:</span>
              <span class="info-value">89mm (1051px)</span>
            </div>
            <div class="info-row">
              <span class="info-label">Cell:</span>
              <span class="info-value">85mm (1004px)</span>
            </div>
            <div class="info-row">
              <span class="info-label">PNAS:</span>
              <span class="info-value">87mm (1028px)</span>
            </div>
          </div>

          <div class="info-section" id="metadataSection" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <div class="info-title" style="margin-bottom: 0;">SciTeX Embedded Metadata</div>
              <button id="copyMetadataBtn" class="dpi-btn" style="display: none;">
                <span id="copyBtnText">üìã Copy</span>
              </button>
            </div>
            <div id="metadataStatus" style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">
              Loading...
            </div>
            <pre id="metadataContent" style="background: var(--bg-secondary); padding: 12px; border-radius: 4px; font-size: 12px; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word; max-height: 300px; overflow-y: auto;"></pre>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let currentImage = null;
let currentFile = null;
let currentDpi = 300; // Default DPI
let currentPdf = null;
let currentPdfPage = 1;
let totalPdfPages = 0;
let isPdfFile = false;
let currentDimensions = null;

const uploadZone = document.getElementById('uploadZone');
const fileInput = document.getElementById('fileInput');
const contentArea = document.getElementById('contentArea');
const imagePreview = document.getElementById('imagePreview');
const pdfCanvas = document.getElementById('pdfCanvas');
const pdfControls = document.getElementById('pdfControls');

// Upload zone interactions
uploadZone.addEventListener('click', () => fileInput.click());
uploadZone.addEventListener('dragover', (e) => {
  e.preventDefault();
  uploadZone.style.borderColor = '#3a7c65';
});
uploadZone.addEventListener('dragleave', () => {
  uploadZone.style.borderColor = '#4a9b7e';
});
uploadZone.addEventListener('drop', (e) => {
  e.preventDefault();
  uploadZone.style.borderColor = '#4a9b7e';
  const file = e.dataTransfer.files[0];
  if (file && (file.type.startsWith('image/') || file.type === 'application/pdf')) {
    loadFile(file);
  }
});

fileInput.addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (file) loadFile(file);
});

document.getElementById('clearBtn').addEventListener('click', () => {
  contentArea.style.display = 'none';
  uploadZone.style.display = 'block';
  currentImage = null;
  currentFile = null;
  currentPdf = null;
  isPdfFile = false;
  fileInput.value = '';
  imagePreview.style.display = 'none';
  pdfCanvas.style.display = 'none';
  pdfControls.style.display = 'none';
  document.getElementById('metadataSection').style.display = 'none';
  document.getElementById('metadataContent').textContent = '';
  document.getElementById('copyMetadataBtn').style.display = 'none';
  document.getElementById('pdfPageCountRow').style.display = 'none';
});

// PDF navigation controls
document.getElementById('prevPage').addEventListener('click', () => {
  if (currentPdfPage > 1) {
    currentPdfPage--;
    renderPdfPage(currentPdfPage);
  }
});

document.getElementById('nextPage').addEventListener('click', () => {
  if (currentPdfPage < totalPdfPages) {
    currentPdfPage++;
    renderPdfPage(currentPdfPage);
  }
});

document.getElementById('applyDpiBtn').addEventListener('click', () => {
  const customDpiValue = parseInt(document.getElementById('customDpi').value);
  if (customDpiValue > 0 && customDpiValue <= 10000) {
    currentDpi = customDpiValue;
    updatePhysicalSize();
  } else {
    alert('Please enter a valid DPI value (1-10000)');
  }
});

// Copy metadata button
document.getElementById('copyMetadataBtn').addEventListener('click', async () => {
  const metadataContent = document.getElementById('metadataContent').textContent;
  const copyBtn = document.getElementById('copyMetadataBtn');
  const copyBtnText = document.getElementById('copyBtnText');

  try {
    await navigator.clipboard.writeText(metadataContent);
    copyBtnText.textContent = '‚úì Copied!';
    copyBtn.style.background = '#4a9b7e';

    setTimeout(() => {
      copyBtnText.textContent = 'üìã Copy';
      copyBtn.style.background = '#4a9b7e';
    }, 2000);
  } catch (err) {
    console.error('Failed to copy:', err);
    copyBtnText.textContent = '‚úó Failed';
    setTimeout(() => {
      copyBtnText.textContent = 'üìã Copy';
    }, 2000);
  }
});

function loadFile(file) {
  currentFile = file;
  isPdfFile = file.type === 'application/pdf';

  if (isPdfFile) {
    loadPdf(file);
  } else {
    loadImage(file);
  }

  // Load metadata and dimensions from backend
  loadMetadata(file);
}

function loadImage(file) {
  const reader = new FileReader();

  reader.onload = (e) => {
    const img = new Image();
    img.onload = () => {
      currentImage = img;
      imagePreview.src = e.target.result;
      imagePreview.style.display = 'block';
      pdfCanvas.style.display = 'none';
      pdfControls.style.display = 'none';
      uploadZone.style.display = 'none';
      contentArea.style.display = 'block';
      document.getElementById('previewTitle').textContent = 'Image Preview';
      document.getElementById('pdfPageCountRow').style.display = 'none';
      document.getElementById('dpiAlert').style.display = 'block';

      // Store dimensions for later use
      currentDimensions = {
        width: img.width,
        height: img.height,
      };
    };
    img.src = e.target.result;
  };

  reader.readAsDataURL(file);
}

function loadPdf(file) {
  const reader = new FileReader();

  reader.onload = async (e) => {
    const typedArray = new Uint8Array(e.target.result);

    try {
      const pdf = await pdfjsLib.getDocument(typedArray).promise;
      currentPdf = pdf;
      totalPdfPages = pdf.numPages;
      currentPdfPage = 1;

      imagePreview.style.display = 'none';
      pdfCanvas.style.display = 'block';
      pdfControls.style.display = 'block';
      uploadZone.style.display = 'none';
      contentArea.style.display = 'block';
      document.getElementById('previewTitle').textContent = 'PDF Preview';
      document.getElementById('pdfPageCountRow').style.display = 'flex';

      document.getElementById('totalPages').textContent = totalPdfPages;
      document.getElementById('pdfPageCount').textContent = totalPdfPages;

      // Get first page dimensions
      const page = await pdf.getPage(1);
      const viewport = page.getViewport({ scale: 1 });
      currentDimensions = {
        width_pt: viewport.width,
        height_pt: viewport.height,
      };

      await renderPdfPage(1);
    } catch (error) {
      console.error('Error loading PDF:', error);
      alert('Failed to load PDF file');
    }
  };

  reader.readAsArrayBuffer(file);
}

async function renderPdfPage(pageNum) {
  try {
    const page = await currentPdf.getPage(pageNum);
    const viewport = page.getViewport({ scale: 1.5 });

    const canvas = pdfCanvas;
    const context = canvas.getContext('2d');
    canvas.height = viewport.height;
    canvas.width = viewport.width;

    const renderContext = {
      canvasContext: context,
      viewport: viewport
    };

    await page.render(renderContext).promise;

    document.getElementById('currentPage').textContent = pageNum;

    // Update prev/next button states
    document.getElementById('prevPage').disabled = pageNum === 1;
    document.getElementById('nextPage').disabled = pageNum === totalPdfPages;
  } catch (error) {
    console.error('Error rendering PDF page:', error);
  }
}

function loadMetadata(file) {
  // Show metadata section
  const metadataSection = document.getElementById('metadataSection');
  const metadataStatus = document.getElementById('metadataStatus');
  const metadataContent = document.getElementById('metadataContent');

  metadataSection.style.display = 'block';
  metadataStatus.textContent = 'Checking for embedded metadata...';
  metadataContent.textContent = '';

  // Create form data
  const formData = new FormData();
  formData.append('image', file);

  // Call API to read metadata (works for both images and PDFs via scitex.io)
  fetch('/api/read-image-metadata/', {
    method: 'POST',
    body: formData,
  })
    .then(response => response.json())
    .then(data => {
      console.log('Metadata response:', data);

      // Update file info
      document.getElementById('fileName').textContent = file.name;
      document.getElementById('fileSize').textContent = formatFileSize(file.size);
      document.getElementById('fileType').textContent = data.file_type || file.type || 'Unknown';

      // Update dimensions based on file type
      if (data.file_type === 'pdf') {
        // For PDFs, use point dimensions (72 points = 1 inch)
        if (currentDimensions) {
          const widthPt = currentDimensions.width_pt;
          const heightPt = currentDimensions.height_pt;
          const aspectRatio = (widthPt / heightPt).toFixed(3);

          document.getElementById('pixelWidth').textContent = `${Math.round(widthPt)} pt`;
          document.getElementById('pixelHeight').textContent = `${Math.round(heightPt)} pt`;
          document.getElementById('aspectRatio').textContent = aspectRatio;

          // For PDFs, physical size is based on points (72 points = 1 inch)
          const widthInch = widthPt / 72;
          const heightInch = heightPt / 72;
          const widthMm = widthInch * 25.4;
          const heightMm = heightInch * 25.4;

          document.getElementById('widthMm').textContent = `${widthMm.toFixed(2)} mm`;
          document.getElementById('heightMm').textContent = `${heightMm.toFixed(2)} mm`;
          document.getElementById('widthInch').textContent = `${widthInch.toFixed(3)} in`;
          document.getElementById('heightInch').textContent = `${heightInch.toFixed(3)} in`;
          document.getElementById('usedDpi').textContent = '72 (PDF native)';
        }

        document.getElementById('dpiAlert').style.display = 'block';
        document.getElementById('dpiAlert').textContent = 'PDF uses vector graphics. DPI setting for rasterization only.';
        document.getElementById('dpiX').textContent = '72 dpi (native)';
        document.getElementById('dpiY').textContent = '72 dpi (native)';
      } else {
        // For images
        if (currentDimensions) {
          const width = currentDimensions.width;
          const height = currentDimensions.height;
          const aspectRatio = (width / height).toFixed(3);

          document.getElementById('pixelWidth').textContent = `${width} px`;
          document.getElementById('pixelHeight').textContent = `${height} px`;
          document.getElementById('aspectRatio').textContent = `${aspectRatio} (${width}:${height})`;

          updatePhysicalSize();
        }
      }

      // Display metadata
      const copyBtn = document.getElementById('copyMetadataBtn');
      if (data.has_metadata) {
        metadataStatus.textContent = '‚úì Metadata found';
        metadataStatus.style.color = '#4a9b7e';
        metadataContent.textContent = JSON.stringify(data.metadata, null, 2);
        copyBtn.style.display = 'inline-block';
      } else {
        metadataStatus.textContent = '‚óã No SciTeX metadata found';
        metadataStatus.style.color = 'var(--text-secondary)';
        metadataContent.textContent = data.message || 'This file does not contain embedded SciTeX metadata.';
        copyBtn.style.display = 'none';
      }
    })
    .catch(error => {
      metadataStatus.textContent = '‚úó Error reading metadata';
      metadataStatus.style.color = '#d32f2f';
      metadataContent.textContent = `Error: ${error.message}`;
      console.error('Error loading metadata:', error);

      // Still show basic file info
      document.getElementById('fileName').textContent = file.name;
      document.getElementById('fileSize').textContent = formatFileSize(file.size);
      document.getElementById('fileType').textContent = file.type || 'Unknown';

      // Show dimensions from client-side if available
      if (currentDimensions) {
        if (isPdfFile) {
          document.getElementById('pixelWidth').textContent = `${Math.round(currentDimensions.width_pt)} pt`;
          document.getElementById('pixelHeight').textContent = `${Math.round(currentDimensions.height_pt)} pt`;
          document.getElementById('aspectRatio').textContent = (currentDimensions.width_pt / currentDimensions.height_pt).toFixed(3);
        } else {
          document.getElementById('pixelWidth').textContent = `${currentDimensions.width} px`;
          document.getElementById('pixelHeight').textContent = `${currentDimensions.height} px`;
          document.getElementById('aspectRatio').textContent = (currentDimensions.width / currentDimensions.height).toFixed(3);
          updatePhysicalSize();
        }
      }
    });
}

function updatePhysicalSize() {
  if (!currentDimensions || isPdfFile) return;

  const width = currentDimensions.width;
  const height = currentDimensions.height;

  // Calculate physical size
  const widthInch = width / currentDpi;
  const heightInch = height / currentDpi;
  const widthMm = widthInch * 25.4;
  const heightMm = heightInch * 25.4;

  document.getElementById('widthMm').textContent = `${widthMm.toFixed(2)} mm`;
  document.getElementById('heightMm').textContent = `${heightMm.toFixed(2)} mm`;
  document.getElementById('widthInch').textContent = `${widthInch.toFixed(3)} in`;
  document.getElementById('heightInch').textContent = `${heightInch.toFixed(3)} in`;
  document.getElementById('usedDpi').textContent = currentDpi;
  document.getElementById('dpiX').textContent = `${currentDpi} dpi`;
  document.getElementById('dpiY').textContent = `${currentDpi} dpi`;
}

function formatFileSize(bytes) {
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
}
</script>
{% endblock %}
