{% extends "global_base.html" %}
{% block title %}
    PDF Merger -
    Browser Tool | SciTeX
{% endblock %}
{% block meta_description %}
    Merge multiple PDF files into one. Drag to reorder pages, preview thumbnails, download combined PDF.
{% endblock %}
{% block head_extra %}
    {% load static %}
    <link rel="icon"
          type="image/png"
          sizes="192x192"
          href="{% static 'images/vectorstock_38853699/vectorstock_38853699-navy-inverted-192x192.png' %}?v=3" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
{% endblock %}
{% block extra_css %}
    <style>
  .tool-detail-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 40px 20px;
  }

  .tool-header {
    text-align: center;
    padding: 40px 20px;
    margin-bottom: 40px;
  }

  .tool-title {
    font-size: 42px;
    font-weight: 700;
    margin-bottom: 16px;
  }

  .tool-breadcrumb {
    font-size: 14px;
    margin-bottom: 16px;
  }

  .tool-breadcrumb a {
    color: #4a9b7e;
    text-decoration: none;
  }

  .tool-app-container {
    background: var(--bg-secondary);
    border-radius: 12px;
    padding: 40px;
    margin-bottom: 40px;
  }

  .upload-zone {
    border: 3px dashed #4a9b7e;
    border-radius: 8px;
    padding: 60px 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    background: var(--bg-primary);
  }

  .upload-zone:hover {
    border-color: #3a7c65;
    background: var(--bg-tertiary);
  }

  .pdf-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 15px;
    margin: 30px 0;
  }

  .pdf-item {
    background: var(--bg-primary);
    border-radius: 8px;
    padding: 15px;
    text-align: center;
    cursor: move;
    border: 2px solid var(--border-color);
    transition: all 0.2s;
    position: relative;
  }

  .pdf-item:hover {
    border-color: #4a9b7e;
  }

  .pdf-icon {
    font-size: 48px;
    margin-bottom: 10px;
  }

  .pdf-name {
    font-size: 12px;
    font-weight: 600;
    margin-bottom: 5px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .pdf-pages {
    font-size: 11px;
    color: var(--text-secondary);
  }

  .pdf-remove {
    position: absolute;
    top: 8px;
    right: 8px;
    background: #ef4444;
    color: white;
    border: none;
    border-radius: 4px;
    width: 24px;
    height: 24px;
    cursor: pointer;
    font-size: 14px;
  }

  .pdf-order {
    position: absolute;
    top: 8px;
    left: 8px;
    background: #4a9b7e;
    color: white;
    border-radius: 4px;
    padding: 4px 8px;
    font-size: 11px;
    font-weight: 600;
  }

  .btn {
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    border: none;
    transition: all 0.2s;
  }

  .btn-primary {
    background: #4a9b7e;
    color: white;
  }

  .btn-primary:hover:not(:disabled) {
    background: #3a7c65;
  }

  .btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .action-buttons {
    display: flex;
    gap: 12px;
    justify-content: center;
  }

  .status-message {
    text-align: center;
    padding: 12px;
    border-radius: 6px;
    margin: 20px 0;
    font-size: 14px;
  }

  .status-message.info {
    background: #eff6ff;
    color: #1e40af;
  }

  .status-message.success {
    background: #f0fdf7;
    color: #15803d;
  }
    </style>
{% endblock %}
{% block content %}
    <div class="tool-detail-container">
        <div class="tool-breadcrumb">
            <a href="{% url 'public_app:tools' %}">‚Üê Back to Tools</a>
        </div>
        <div class="tool-header">
            <div style="font-size: 64px; margin-bottom: 20px;">üìë</div>
            <h1 class="tool-title">PDF Merger</h1>
            <p style="font-size: 18px; color: var(--text-secondary);">
                Combine multiple PDF files into one document
            </p>
        </div>
        <div class="tool-app-container">
            <div id="uploadZone" class="upload-zone">
                <div style="font-size: 48px; margin-bottom: 16px;">üì§</div>
                <div style="font-size: 18px; margin-bottom: 8px;">Drop PDF files or click to upload</div>
                <div style="font-size: 14px; color: var(--text-secondary);">Drag to reorder after upload</div>
                <input type="file"
                       id="fileInput"
                       accept=".pdf"
                       multiple
                       style="display: none" />
            </div>
            <div id="statusMessage"></div>
            <div id="pdfList" class="pdf-list" style="display: none;"></div>
            <div class="action-buttons">
                <button id="mergeBtn" class="btn btn-primary" disabled>
                    ‚ú® Merge PDFs
                </button>
                <button id="clearBtn" class="btn btn-primary" disabled style="background: #6b8fb3;">
                    üóëÔ∏è Clear All
                </button>
            </div>
        </div>
    </div>
    <script>
  const { PDFDocument } = PDFLib;
  let pdfs = [];
  let draggedIndex = null;

  const uploadZone = document.getElementById('uploadZone');
  const fileInput = document.getElementById('fileInput');
  const pdfList = document.getElementById('pdfList');
  const mergeBtn = document.getElementById('mergeBtn');
  const clearBtn = document.getElementById('clearBtn');
  const statusMessage = document.getElementById('statusMessage');

  uploadZone.addEventListener('click', () => fileInput.click());

  uploadZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadZone.style.borderColor = '#3a7c65';
  });

  uploadZone.addEventListener('dragleave', () => {
    uploadZone.style.borderColor = '#4a9b7e';
  });

  uploadZone.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadZone.style.borderColor = '#4a9b7e';
    handleFiles(e.dataTransfer.files);
  });

  fileInput.addEventListener('change', (e) => {
    handleFiles(e.target.files);
  });

  async function handleFiles(files) {
    const fileArray = Array.from(files).filter(f => f.type === 'application/pdf');

    if (fileArray.length === 0) {
      showStatus('No valid PDF files selected', 'info');
      return;
    }

    showStatus(`Loading ${fileArray.length} PDF(s)...`, 'info');

    for (const file of fileArray) {
      const arrayBuffer = await file.arrayBuffer();
      const pdfDoc = await PDFDocument.load(arrayBuffer);
      const pageCount = pdfDoc.getPageCount();

      pdfs.push({
        name: file.name,
        file: file,
        arrayBuffer: arrayBuffer,
        pageCount: pageCount
      });
    }

    updatePdfList();
    showStatus(`${pdfs.length} PDF(s) ready to merge`, 'success');
  }

  function updatePdfList() {
    if (pdfs.length === 0) {
      pdfList.style.display = 'none';
      mergeBtn.disabled = true;
      clearBtn.disabled = true;
      return;
    }

    pdfList.style.display = 'grid';
    mergeBtn.disabled = false;
    clearBtn.disabled = false;

    pdfList.innerHTML = '';
    pdfs.forEach((pdf, index) => {
      const div = document.createElement('div');
      div.className = 'pdf-item';
      div.draggable = true;
      div.innerHTML = `
        <span class="pdf-order">${index + 1}</span>
        <button class="pdf-remove" data-index="${index}">√ó</button>
        <div class="pdf-icon">üìÑ</div>
        <div class="pdf-name" title="${pdf.name}">${pdf.name}</div>
        <div class="pdf-pages">${pdf.pageCount} page${pdf.pageCount !== 1 ? 's' : ''}</div>
      `;

      div.addEventListener('dragstart', (e) => {
        draggedIndex = index;
        e.dataTransfer.effectAllowed = 'move';
      });

      div.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
      });

      div.addEventListener('drop', (e) => {
        e.preventDefault();
        if (draggedIndex !== null && draggedIndex !== index) {
          const draggedItem = pdfs[draggedIndex];
          pdfs.splice(draggedIndex, 1);
          pdfs.splice(index, 0, draggedItem);
          updatePdfList();
          draggedIndex = null;
        }
      });

      div.querySelector('.pdf-remove').addEventListener('click', (e) => {
        e.stopPropagation();
        pdfs.splice(index, 1);
        updatePdfList();
        if (pdfs.length > 0) {
          showStatus(`${pdfs.length} PDF(s) ready to merge`, 'success');
        } else {
          statusMessage.style.display = 'none';
        }
      });

      pdfList.appendChild(div);
    });
  }

  mergeBtn.addEventListener('click', async () => {
    if (pdfs.length === 0) return;

    showStatus('Merging PDFs...', 'info');
    mergeBtn.disabled = true;

    try {
      const mergedPdf = await PDFDocument.create();

      for (const pdf of pdfs) {
        const pdfDoc = await PDFDocument.load(pdf.arrayBuffer);
        const copiedPages = await mergedPdf.copyPages(pdfDoc, pdfDoc.getPageIndices());
        copiedPages.forEach(page => mergedPdf.addPage(page));
      }

      const mergedPdfBytes = await mergedPdf.save();
      const blob = new Blob([mergedPdfBytes], { type: 'application/pdf' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = `merged-${Date.now()}.pdf`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showStatus('PDF merged successfully!', 'success');
      mergeBtn.disabled = false;
    } catch (error) {
      console.error('Error merging PDFs:', error);
      showStatus('Error merging PDFs. Please try again.', 'info');
      mergeBtn.disabled = false;
    }
  });

  clearBtn.addEventListener('click', () => {
    if (confirm('Clear all PDFs?')) {
      pdfs = [];
      fileInput.value = '';
      updatePdfList();
      statusMessage.style.display = 'none';
    }
  });

  function showStatus(message, type) {
    statusMessage.className = `status-message ${type}`;
    statusMessage.textContent = message;
    statusMessage.style.display = 'block';
  }
    </script>
{% endblock %}
