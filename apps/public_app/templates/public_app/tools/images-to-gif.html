{% extends "global_base.html" %}
{% block title %}
    Images to GIF -
    Browser Tool | SciTeX
{% endblock %}
{% block meta_description %}
    Convert multiple images into animated GIF. Customize frame duration, quality, and loop settings. Perfect for creating animations from image sequences.
{% endblock %}
{% block head_extra %}
    {% load static %}
    <link rel="icon"
          type="image/png"
          sizes="192x192"
          href="{% static 'images/vectorstock_38853699/vectorstock_38853699-navy-inverted-192x192.png' %}?v=3" />
    <!-- GIF.js library - load with defer to ensure it's available -->
    <script src="https://cdn.jsdelivr.net/npm/gif.js@0.2.0/dist/gif.js" defer></script>
{% endblock %}
{% block extra_css %}
    <style>
  .tool-detail-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 40px 20px;
  }

  .tool-header {
    text-align: center;
    padding: 40px 20px;
    margin-bottom: 40px;
  }

  .tool-title {
    font-size: 42px;
    font-weight: 700;
    margin-bottom: 16px;
  }

  .tool-breadcrumb {
    font-size: 14px;
    margin-bottom: 16px;
  }

  .tool-breadcrumb a {
    color: #4a9b7e;
    text-decoration: none;
  }

  .tool-app-container {
    background: var(--bg-secondary);
    border-radius: 12px;
    padding: 40px;
    margin-bottom: 40px;
  }

  .upload-zone {
    border: 3px dashed #4a9b7e;
    border-radius: 8px;
    padding: 60px 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    background: var(--bg-primary);
  }

  .upload-zone:hover {
    border-color: #3a7c65;
    background: var(--bg-tertiary);
  }

  .upload-zone.dragging {
    border-color: #3a7c65;
    background: #f0fdf7;
  }

  .controls-panel {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin: 30px 0;
  }

  .control-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .control-label {
    font-size: 14px;
    font-weight: 600;
  }

  .control-input, .control-select {
    padding: 10px 14px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    font-size: 14px;
    background: var(--bg-primary);
    color: var(--text-primary);
  }

  .thumbnail-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 12px;
    margin: 20px 0;
  }

  .thumbnail-item {
    position: relative;
    aspect-ratio: 1;
    border-radius: 6px;
    overflow: hidden;
    border: 2px solid var(--border-color);
    cursor: move;
  }

  .thumbnail-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .thumbnail-remove {
    position: absolute;
    top: 4px;
    right: 4px;
    background: rgba(239, 68, 68, 0.9);
    color: white;
    border: none;
    border-radius: 4px;
    width: 24px;
    height: 24px;
    cursor: pointer;
  }

  .frame-number {
    position: absolute;
    bottom: 4px;
    left: 4px;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 11px;
  }

  .preview-container {
    text-align: center;
    margin: 30px 0;
  }

  .preview-image {
    max-width: 100%;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background: white;
  }

  .btn {
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    border: none;
    transition: all 0.2s;
  }

  .btn-primary {
    background: #4a9b7e;
    color: white;
  }

  .btn-primary:hover:not(:disabled) {
    background: #3a7c65;
  }

  .btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .action-buttons {
    display: flex;
    gap: 12px;
    justify-content: center;
    flex-wrap: wrap;
  }

  .status-message {
    text-align: center;
    padding: 12px;
    border-radius: 6px;
    margin: 20px 0;
    font-size: 14px;
  }

  .status-message.info {
    background: #eff6ff;
    color: #1e40af;
  }

  .status-message.success {
    background: #f0fdf7;
    color: #15803d;
  }

  .status-message.error {
    background: #fef2f2;
    color: #991b1b;
  }

  .progress-bar {
    width: 100%;
    height: 8px;
    background: var(--bg-tertiary);
    border-radius: 4px;
    overflow: hidden;
    margin-top: 10px;
  }

  .progress-fill {
    height: 100%;
    background: #4a9b7e;
    transition: width 0.3s;
  }
    </style>
{% endblock %}
{% block content %}
    <div class="tool-detail-container">
        <div class="tool-breadcrumb">
            <a href="{% url 'public_app:tools' %}">‚Üê Back to Tools</a>
        </div>
        <div class="tool-header">
            <div style="font-size: 64px; margin-bottom: 20px;">üé¨</div>
            <h1 class="tool-title">Images to GIF</h1>
            <p style="font-size: 18px; color: var(--text-secondary);">
                Convert multiple images into an animated GIF
            </p>
        </div>
        <div class="tool-app-container">
            <div id="uploadZone" class="upload-zone">
                <div style="font-size: 48px; margin-bottom: 16px;">üì§</div>
                <div style="font-size: 18px; margin-bottom: 8px;">Drop images here or click to upload</div>
                <div style="font-size: 14px; color: var(--text-secondary);">Supports JPG, PNG, GIF, WebP</div>
                <input type="file"
                       id="fileInput"
                       accept="image/*"
                       multiple
                       style="display: none" />
            </div>
            <div id="statusMessage"></div>
            <div id="thumbnailContainer" style="display: none">
                <h3 style="margin: 20px 0 10px;">Images (<span id="imageCount">0</span>)</h3>
                <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 10px;">
                    Drag to reorder frames
                </p>
                <div id="thumbnailGrid" class="thumbnail-grid"></div>
            </div>
            <div class="controls-panel">
                <div class="control-group">
                    <label class="control-label">Frame Duration (ms)</label>
                    <input type="number"
                           id="delayInput"
                           class="control-input"
                           value="500"
                           min="50"
                           max="5000"
                           step="50" />
                </div>
                <div class="control-group">
                    <label class="control-label">Quality</label>
                    <select id="qualityInput" class="control-select">
                        <option value="1">Best (Slow)</option>
                        <option value="10" selected>High</option>
                        <option value="20">Medium (Fast)</option>
                    </select>
                </div>
                <div class="control-group">
                    <label class="control-label">Loop</label>
                    <select id="loopInput" class="control-select">
                        <option value="0">Forever</option>
                        <option value="1">Once</option>
                        <option value="3">3 times</option>
                        <option value="5">5 times</option>
                    </select>
                </div>
                <div class="control-group">
                    <label class="control-label">Resize</label>
                    <select id="resizeInput" class="control-select">
                        <option value="original">Original Size</option>
                        <option value="480" selected>480px width</option>
                        <option value="640">640px width</option>
                        <option value="800">800px width</option>
                    </select>
                </div>
            </div>
            <div class="action-buttons">
                <button id="generateBtn" class="btn btn-primary" disabled>
                    ‚ú® Generate GIF
                </button>
                <button id="clearBtn" class="btn btn-primary" disabled style="background: #6b8fb3;">
                    üóëÔ∏è Clear All
                </button>
            </div>
            <div id="progressContainer" style="display: none;">
                <div style="text-align: center; margin: 20px 0;">
                    <div id="progressText">Processing...</div>
                    <div class="progress-bar">
                        <div id="progressFill" class="progress-fill" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            <div id="previewContainer" class="preview-container" style="display: none">
                <h3>Preview</h3>
                <img id="previewImage" class="preview-image" />
                <div class="action-buttons" style="margin-top: 20px;">
                    <button id="downloadBtn" class="btn btn-primary">üíæ Download GIF</button>
                </div>
            </div>
        </div>
    </div>
    <script>
  let images = [];
  let draggedIndex = null;
  let generatedGif = null;

  const uploadZone = document.getElementById('uploadZone');
  const fileInput = document.getElementById('fileInput');
  const thumbnailContainer = document.getElementById('thumbnailContainer');
  const thumbnailGrid = document.getElementById('thumbnailGrid');
  const imageCount = document.getElementById('imageCount');
  const generateBtn = document.getElementById('generateBtn');
  const clearBtn = document.getElementById('clearBtn');
  const downloadBtn = document.getElementById('downloadBtn');
  const previewContainer = document.getElementById('previewContainer');
  const previewImage = document.getElementById('previewImage');
  const statusMessage = document.getElementById('statusMessage');
  const progressContainer = document.getElementById('progressContainer');
  const progressFill = document.getElementById('progressFill');
  const progressText = document.getElementById('progressText');
  const delayInput = document.getElementById('delayInput');
  const qualityInput = document.getElementById('qualityInput');
  const loopInput = document.getElementById('loopInput');
  const resizeInput = document.getElementById('resizeInput');

  uploadZone.addEventListener('click', () => fileInput.click());

  uploadZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadZone.classList.add('dragging');
  });

  uploadZone.addEventListener('dragleave', () => {
    uploadZone.classList.remove('dragging');
  });

  uploadZone.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadZone.classList.remove('dragging');
    handleFiles(e.dataTransfer.files);
  });

  fileInput.addEventListener('change', (e) => {
    handleFiles(e.target.files);
  });

  function handleFiles(files) {
    const fileArray = Array.from(files).filter(file => file.type.startsWith('image/'));

    if (fileArray.length === 0) {
      showStatus('No valid image files selected', 'error');
      return;
    }

    fileArray.forEach(file => {
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          images.push({ src: e.target.result, img: img });
          updateThumbnails();
          updateUI();
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    });

    showStatus(`Loading ${fileArray.length} image(s)...`, 'info');
  }

  function updateThumbnails() {
    thumbnailGrid.innerHTML = '';
    images.forEach((imageData, index) => {
      const div = document.createElement('div');
      div.className = 'thumbnail-item';
      div.draggable = true;
      div.innerHTML = `
        <img src="${imageData.src}" />
        <button class="thumbnail-remove" data-index="${index}">√ó</button>
        <span class="frame-number">${index + 1}</span>
      `;

      div.addEventListener('dragstart', (e) => {
        draggedIndex = index;
        e.dataTransfer.effectAllowed = 'move';
      });

      div.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
      });

      div.addEventListener('drop', (e) => {
        e.preventDefault();
        if (draggedIndex !== null && draggedIndex !== index) {
          const draggedItem = images[draggedIndex];
          images.splice(draggedIndex, 1);
          images.splice(index, 0, draggedItem);
          updateThumbnails();
          draggedIndex = null;
        }
      });

      thumbnailGrid.appendChild(div);
    });

    document.querySelectorAll('.thumbnail-remove').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const index = parseInt(btn.dataset.index);
        images.splice(index, 1);
        updateThumbnails();
        updateUI();
      });
    });

    imageCount.textContent = images.length;
  }

  function updateUI() {
    const hasImages = images.length > 0;
    thumbnailContainer.style.display = hasImages ? 'block' : 'none';
    generateBtn.disabled = !hasImages;
    clearBtn.disabled = !hasImages;

    if (hasImages) {
      showStatus(`${images.length} image(s) ready`, 'success');
    }
  }

  function showStatus(message, type = 'info') {
    statusMessage.className = `status-message ${type}`;
    statusMessage.textContent = message;
    statusMessage.style.display = 'block';
  }

  generateBtn.addEventListener('click', async () => {
    if (images.length === 0) return;

    const delay = parseInt(delayInput.value) || 500;
    const quality = parseInt(qualityInput.value) || 10;
    const repeat = parseInt(loopInput.value) || 0;
    const resizeWidth = resizeInput.value === 'original' ? null : parseInt(resizeInput.value);

    progressContainer.style.display = 'block';
    previewContainer.style.display = 'none';
    generateBtn.disabled = true;

    try {
      // Check if GIF library is loaded
      if (typeof GIF === 'undefined') {
        throw new Error('GIF library not loaded. Please refresh the page.');
      }

      const gif = new GIF({
        workers: 2,
        quality: quality,
        workerScript: 'https://cdn.jsdelivr.net/npm/gif.js@0.2.0/dist/gif.worker.js',
        repeat: repeat,
        debug: false
      });

      for (let i = 0; i < images.length; i++) {
        const img = images[i].img;
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');

        if (resizeWidth) {
          const ratio = img.height / img.width;
          canvas.width = resizeWidth;
          canvas.height = resizeWidth * ratio;
        } else {
          canvas.width = img.width;
          canvas.height = img.height;
        }

        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        gif.addFrame(ctx, { delay: delay });

        progressText.textContent = `Adding frame ${i + 1}/${images.length}...`;
        progressFill.style.width = `${(i + 1) / images.length * 50}%`;
      }

      gif.on('progress', (p) => {
        const progress = 50 + (p * 50);
        progressFill.style.width = `${progress}%`;
        progressText.textContent = `Rendering GIF: ${Math.round(progress)}%`;
      });

      gif.on('finished', (blob) => {
        generatedGif = blob;
        const url = URL.createObjectURL(blob);
        previewImage.src = url;
        previewContainer.style.display = 'block';
        progressContainer.style.display = 'none';
        generateBtn.disabled = false;
        showStatus('GIF generated successfully!', 'success');
      });

      gif.render();
    } catch (error) {
      console.error('Error generating GIF:', error);
      showStatus(`Error generating GIF: ${error.message}. Try reducing quality or number of images.`, 'error');
      progressContainer.style.display = 'none';
      generateBtn.disabled = false;
    }
  });

  downloadBtn.addEventListener('click', () => {
    if (!generatedGif) return;

    const url = URL.createObjectURL(generatedGif);
    const a = document.createElement('a');
    a.href = url;
    a.download = `animation-${Date.now()}.gif`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showStatus('GIF downloaded!', 'success');
  });

  clearBtn.addEventListener('click', () => {
    if (confirm('Clear all images?')) {
      images = [];
      updateThumbnails();
      updateUI();
      previewContainer.style.display = 'none';
      statusMessage.style.display = 'none';
      fileInput.value = '';
    }
  });

  // Wait for GIF library to load
  window.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
      if (typeof GIF === 'undefined') {
        console.error('‚ùå GIF.js library not loaded');
        showStatus('GIF library failed to load. Try refreshing the page or check your internet connection.', 'error');
        generateBtn.disabled = true;
      } else {
        console.log('‚úÖ GIF.js library loaded successfully');
      }
    }, 1000);
  });
    </script>
{% endblock %}
