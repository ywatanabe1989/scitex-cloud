{% extends "global_base.html" %}
{% block title %}
    Image Converter -
    Browser Tool | SciTeX
{% endblock %}
{% block meta_description %}
    Convert images between PNG, JPG, WEBP, and other formats. Batch conversion with quality control.
{% endblock %}
{% block head_extra %}
    {% load static %}
    <link rel="icon"
          type="image/png"
          sizes="192x192"
          href="{% static 'images/vectorstock_38853699/vectorstock_38853699-navy-inverted-192x192.png' %}?v=3" />
{% endblock %}
{% block extra_css %}
    <style>
  .tool-detail-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 40px 20px;
  }

  .tool-header {
    text-align: center;
    padding: 40px 20px;
    margin-bottom: 40px;
  }

  .tool-title {
    font-size: 42px;
    font-weight: 700;
    margin-bottom: 16px;
  }

  .tool-breadcrumb {
    font-size: 14px;
    margin-bottom: 16px;
  }

  .tool-breadcrumb a {
    color: #4a9b7e;
    text-decoration: none;
  }

  .tool-app-container {
    background: var(--bg-secondary);
    border-radius: 12px;
    padding: 40px;
    margin-bottom: 40px;
  }

  .upload-zone {
    border: 3px dashed #4a9b7e;
    border-radius: 8px;
    padding: 60px 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    background: var(--bg-primary);
  }

  .upload-zone:hover {
    border-color: #3a7c65;
    background: var(--bg-tertiary);
  }

  .controls-panel {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin: 30px 0;
  }

  .control-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .control-label {
    font-size: 14px;
    font-weight: 600;
  }

  .control-select {
    padding: 10px 14px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    font-size: 14px;
    background: var(--bg-primary);
    color: var(--text-primary);
  }

  .file-list {
    margin: 20px 0;
  }

  .file-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px;
    background: var(--bg-primary);
    border-radius: 8px;
    margin-bottom: 10px;
  }

  .file-thumbnail {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: 6px;
  }

  .file-info {
    flex: 1;
  }

  .file-name {
    font-weight: 600;
    margin-bottom: 4px;
  }

  .file-size {
    font-size: 13px;
    color: var(--text-secondary);
  }

  .file-remove {
    padding: 8px 12px;
    background: #ef4444;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }

  .btn {
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    border: none;
    transition: all 0.2s;
  }

  .btn-primary {
    background: #4a9b7e;
    color: white;
  }

  .btn-primary:hover:not(:disabled) {
    background: #3a7c65;
  }

  .btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .action-buttons {
    display: flex;
    gap: 12px;
    justify-content: center;
  }

  .status-message {
    text-align: center;
    padding: 12px;
    border-radius: 6px;
    margin: 20px 0;
    font-size: 14px;
  }

  .status-message.success {
    background: #f0fdf7;
    color: #15803d;
  }
    </style>
{% endblock %}
{% block content %}
    <div class="tool-detail-container">
        <div class="tool-breadcrumb">
            <a href="{% url 'public_app:tools' %}">‚Üê Back to Tools</a>
        </div>
        <div class="tool-header">
            <div style="font-size: 64px; margin-bottom: 20px;">üîÑ</div>
            <h1 class="tool-title">Image Converter</h1>
            <p style="font-size: 18px; color: var(--text-secondary);">
                Convert images between PNG, JPG, WEBP formats with quality control
            </p>
        </div>
        <div class="tool-app-container">
            <div id="uploadZone" class="upload-zone">
                <div style="font-size: 48px; margin-bottom: 16px;">üì§</div>
                <div style="font-size: 18px; margin-bottom: 8px;">Drop images or click to upload</div>
                <div style="font-size: 14px; color: var(--text-secondary);">PNG, JPG, WEBP</div>
                <input type="file"
                       id="fileInput"
                       accept="image/*"
                       multiple
                       style="display: none" />
            </div>
            <div id="statusMessage"></div>
            <div class="controls-panel">
                <div class="control-group">
                    <label class="control-label">Output Format</label>
                    <select id="formatSelect" class="control-select">
                        <option value="png">PNG</option>
                        <option value="jpeg">JPEG</option>
                        <option value="webp">WebP</option>
                    </select>
                </div>
                <div class="control-group">
                    <label class="control-label">Quality (for JPEG/WebP)</label>
                    <select id="qualitySelect" class="control-select">
                        <option value="1.0">Maximum (100%)</option>
                        <option value="0.92" selected>High (92%)</option>
                        <option value="0.85">Medium (85%)</option>
                        <option value="0.75">Low (75%)</option>
                    </select>
                </div>
            </div>
            <div id="fileList" class="file-list" style="display: none;"></div>
            <div class="action-buttons">
                <button id="convertBtn" class="btn btn-primary" disabled>
                    ‚ú® Convert Images
                </button>
                <button id="clearBtn" class="btn btn-primary" disabled style="background: #6b8fb3;">
                    üóëÔ∏è Clear All
                </button>
            </div>
        </div>
    </div>
    <script>
  let files = [];

  const uploadZone = document.getElementById('uploadZone');
  const fileInput = document.getElementById('fileInput');
  const fileList = document.getElementById('fileList');
  const formatSelect = document.getElementById('formatSelect');
  const qualitySelect = document.getElementById('qualitySelect');
  const convertBtn = document.getElementById('convertBtn');
  const clearBtn = document.getElementById('clearBtn');
  const statusMessage = document.getElementById('statusMessage');

  uploadZone.addEventListener('click', () => fileInput.click());

  uploadZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadZone.style.borderColor = '#3a7c65';
  });

  uploadZone.addEventListener('dragleave', () => {
    uploadZone.style.borderColor = '#4a9b7e';
  });

  uploadZone.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadZone.style.borderColor = '#4a9b7e';
    handleFiles(e.dataTransfer.files);
  });

  fileInput.addEventListener('change', (e) => {
    handleFiles(e.target.files);
  });

  function handleFiles(fileArray) {
    files = Array.from(fileArray).filter(f => f.type.startsWith('image/'));
    updateFileList();
  }

  function updateFileList() {
    if (files.length === 0) {
      fileList.style.display = 'none';
      convertBtn.disabled = true;
      clearBtn.disabled = true;
      return;
    }

    fileList.style.display = 'block';
    convertBtn.disabled = false;
    clearBtn.disabled = false;

    fileList.innerHTML = '';
    files.forEach((file, index) => {
      const div = document.createElement('div');
      div.className = 'file-item';

      const reader = new FileReader();
      reader.onload = (e) => {
        div.innerHTML = `
          <img src="${e.target.result}" class="file-thumbnail" />
          <div class="file-info">
            <div class="file-name">${file.name}</div>
            <div class="file-size">${(file.size / 1024).toFixed(1)} KB</div>
          </div>
          <button class="file-remove" data-index="${index}">Remove</button>
        `;

        div.querySelector('.file-remove').addEventListener('click', () => {
          files.splice(index, 1);
          updateFileList();
        });
      };
      reader.readAsDataURL(file);

      fileList.appendChild(div);
    });
  }

  convertBtn.addEventListener('click', async () => {
    if (files.length === 0) return;

    const format = formatSelect.value;
    const quality = parseFloat(qualitySelect.value);
    const mimeType = format === 'png' ? 'image/png' : format === 'jpeg' ? 'image/jpeg' : 'image/webp';

    showStatus(`Converting ${files.length} image(s)...`);
    convertBtn.disabled = true;

    for (let i = 0; i < files.length; i++) {
      const file = files[i];
      const img = new Image();
      const reader = new FileReader();

      reader.onload = (e) => {
        img.onload = () => {
          const canvas = document.createElement('canvas');
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0);

          canvas.toBlob((blob) => {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const originalName = file.name.replace(/\\.[^.]+$/, '');
            a.href = url;
            a.download = `${originalName}.${format}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            if (i === files.length - 1) {
              showStatus(`Successfully converted ${files.length} image(s)!`);
              convertBtn.disabled = false;
            }
          }, mimeType, quality);
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }
  });

  clearBtn.addEventListener('click', () => {
    if (confirm('Clear all images?')) {
      files = [];
      fileInput.value = '';
      updateFileList();
      statusMessage.style.display = 'none';
    }
  });

  function showStatus(message) {
    statusMessage.className = 'status-message success';
    statusMessage.textContent = message;
    statusMessage.style.display = 'block';
  }
    </script>
{% endblock %}
