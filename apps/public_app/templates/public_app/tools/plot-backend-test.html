{% extends "global_base.html" %}
{% block title %}
    Backend Plot Renderer Test - Browser Tool | SciTeX
{% endblock %}
{% block meta_description %}
    Test the matplotlib/scitex.plt backend plot renderer with JSON specifications. Supports all 40+ plot types with Nature journal standards.
{% endblock %}
{% block head_extra %}
    {% load static %}
    <link rel="icon"
          type="image/png"
          sizes="192x192"
          href="{% static 'images/vectorstock_38853699/vectorstock_38853699-navy-inverted-192x192.png' %}?v=3" />
{% endblock %}

{% block extra_css %}
<style>
  .test-container {
    max-width: 1400px;
    margin: 40px auto;
    padding: 20px;
  }

  .test-section {
    background: var(--card-background);
    border-radius: 8px;
    padding: 24px;
    margin-bottom: 24px;
    border: 1px solid var(--border-color);
  }

  .test-section h2 {
    margin: 0 0 16px 0;
    color: var(--text-primary);
    font-size: 18px;
    font-weight: 600;
  }

  .json-editor {
    width: 100%;
    min-height: 300px;
    font-family: 'Courier New', monospace;
    font-size: 13px;
    padding: 12px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    background: var(--input-background);
    color: var(--text-primary);
    resize: vertical;
  }

  .test-button {
    background: #4a9b7e;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    cursor: pointer;
    margin-top: 12px;
  }

  .test-button:hover {
    background: #3d8268;
  }

  .result-container {
    margin-top: 20px;
    padding: 16px;
    background: var(--hover-background);
    border-radius: 4px;
    min-height: 400px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .error-message {
    color: #ff4444;
    padding: 12px;
    background: rgba(255, 68, 68, 0.1);
    border-radius: 4px;
    margin-top: 12px;
  }

  .success-message {
    color: #4a9b7e;
    padding: 12px;
    background: rgba(74, 155, 126, 0.1);
    border-radius: 4px;
    margin-top: 12px;
  }

  .example-buttons {
    display: flex;
    gap: 8px;
    margin-bottom: 12px;
    flex-wrap: wrap;
  }

  .example-button {
    background: var(--button-background);
    color: var(--text-primary);
    padding: 6px 12px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-size: 12px;
    cursor: pointer;
  }

  .example-button:hover {
    background: var(--hover-background);
  }
</style>
{% endblock %}

{% block content %}
<div class="test-container">
  <div class="tool-breadcrumb">
    <a href="{% url 'public_app:tools' %}">Tools</a> / Backend Plot Renderer Test
  </div>

  <h1 style="margin: 20px 0 10px 0; color: var(--text-primary);">Backend Plot Renderer Test</h1>
  <p style="color: var(--text-secondary); margin-bottom: 30px;">
    Test the matplotlib/scitex.plt backend plot renderer with JSON specifications.
  </p>

  <div class="test-section">
    <h2>Load Example</h2>
    <div class="example-buttons">
      <button class="example-button" onclick="loadExample('line')">Line Plot</button>
      <button class="example-button" onclick="loadExample('scatter')">Scatter Plot</button>
      <button class="example-button" onclick="loadExample('bar')">Bar Plot</button>
      <button class="example-button" onclick="loadExample('multipanel2')">2-Panel (A/B)</button>
      <button class="example-button" onclick="loadExample('multipanel4')">4-Panel (A/B/C/D)</button>
    </div>
  </div>

  <div class="test-section">
    <h2>JSON Specification</h2>
    <textarea class="json-editor" id="jsonSpec">{
  "figure": {
    "width_mm": 35,
    "height_mm": 24.5,
    "dpi": 300
  },
  "style": {
    "tick_length_mm": 0.8,
    "tick_thickness_mm": 0.2,
    "axis_thickness_mm": 0.2,
    "trace_thickness_mm": 0.12,
    "axis_font_size_pt": 8,
    "tick_font_size_pt": 7,
    "title_font_size_pt": 8
  },
  "plot": {
    "kind": "line",
    "csv_path": "/scitex-code/tests/custom/test_export_as_csv_all_out/png/plot_test.csv",
    "x_column": "ax_00_plot_test_plot_x",
    "y_column": "ax_00_plot_test_plot_y",
    "color": "blue",
    "xlabel": "X axis",
    "ylabel": "Y axis",
    "title": "Test Plot"
  }
}</textarea>
    <button class="test-button" onclick="renderPlot()">Render Plot</button>
    <div id="status"></div>
  </div>

  <div class="test-section">
    <h2>Result</h2>
    <div class="result-container" id="resultContainer">
      <p style="color: var(--text-tertiary);">Click "Render Plot" to see the result</p>
    </div>
  </div>
</div>

<script>
const examples = {
  line: {
    "figure": {
      "width_mm": 35,
      "height_mm": 24.5,
      "dpi": 300
    },
    "style": {
      "tick_length_mm": 0.8,
      "tick_thickness_mm": 0.2,
      "axis_thickness_mm": 0.2,
      "trace_thickness_mm": 0.12,
      "axis_font_size_pt": 8,
      "tick_font_size_pt": 7
    },
    "plot": {
      "kind": "line",
      "csv_path": "/scitex-code/tests/custom/test_export_as_csv_all_out/png/plot_test.csv",
      "x_column": "ax_00_plot_test_plot_x",
      "y_column": "ax_00_plot_test_plot_y",
      "color": "#0080C0",
      "xlabel": "Time (s)",
      "ylabel": "Amplitude"
    }
  },
  scatter: {
    "figure": {
      "width_mm": 35,
      "height_mm": 24.5,
      "dpi": 300
    },
    "style": {
      "tick_length_mm": 0.8,
      "tick_thickness_mm": 0.2,
      "axis_thickness_mm": 0.2,
      "dot_size_mm": 0.8,
      "axis_font_size_pt": 8,
      "tick_font_size_pt": 7
    },
    "plot": {
      "kind": "scatter",
      "csv_path": "/scitex-code/tests/custom/test_export_as_csv_all_out/png/scatter_test.csv",
      "x_column": "ax_00_scatter_test_scatter_x",
      "y_column": "ax_00_scatter_test_scatter_y",
      "color": "#FF4632",
      "xlabel": "X values",
      "ylabel": "Y values"
    }
  },
  bar: {
    "figure": {
      "width_mm": 35,
      "height_mm": 24.5,
      "dpi": 300
    },
    "style": {
      "tick_length_mm": 0.8,
      "tick_thickness_mm": 0.2,
      "axis_thickness_mm": 0.2,
      "axis_font_size_pt": 8,
      "tick_font_size_pt": 7
    },
    "plot": {
      "kind": "bar",
      "csv_path": "/scitex-code/tests/custom/test_export_as_csv_all_out/png/bar_test.csv",
      "x_column": "ax_00_bar_test_x",
      "y_column": "ax_00_bar_test_y",
      "color": "#14B414",
      "xlabel": "Categories",
      "ylabel": "Values"
    }
  },
  multipanel2: {
    "figure": {
      "width_mm": 89,
      "height_mm": 35,
      "dpi": 300
    },
    "style": {
      "tick_length_mm": 0.8,
      "tick_thickness_mm": 0.2,
      "axis_thickness_mm": 0.2,
      "trace_thickness_mm": 0.12,
      "axis_font_size_pt": 8,
      "tick_font_size_pt": 7,
      "title_font_size_pt": 8
    },
    "panels": [
      {
        "id": "A",
        "x_mm": 5,
        "y_mm": 5,
        "width_mm": 35,
        "height_mm": 24.5,
        "plot": {
          "kind": "line",
          "csv_path": "/scitex-code/tests/custom/test_export_as_csv_all_out/png/plot_test.csv",
          "x_column": "ax_00_plot_test_plot_x",
          "y_column": "ax_00_plot_test_plot_y",
          "color": "#0080C0",
          "xlabel": "Time (s)",
          "ylabel": "Signal A"
        }
      },
      {
        "id": "B",
        "x_mm": 49,
        "y_mm": 5,
        "width_mm": 35,
        "height_mm": 24.5,
        "plot": {
          "kind": "scatter",
          "csv_path": "/scitex-code/tests/custom/test_export_as_csv_all_out/png/scatter_test.csv",
          "x_column": "ax_00_scatter_test_scatter_x",
          "y_column": "ax_00_scatter_test_scatter_y",
          "color": "#FF4632",
          "xlabel": "X values",
          "ylabel": "Y values"
        }
      }
    ]
  },
  multipanel4: {
    "figure": {
      "width_mm": 89,
      "height_mm": 60,
      "dpi": 300
    },
    "style": {
      "tick_length_mm": 0.8,
      "tick_thickness_mm": 0.2,
      "axis_thickness_mm": 0.2,
      "trace_thickness_mm": 0.12,
      "dot_size_mm": 0.8,
      "axis_font_size_pt": 8,
      "tick_font_size_pt": 7,
      "title_font_size_pt": 8
    },
    "panels": [
      {
        "id": "A",
        "x_mm": 5,
        "y_mm": 31,
        "width_mm": 35,
        "height_mm": 24.5,
        "plot": {
          "kind": "line",
          "csv_path": "/scitex-code/tests/custom/test_export_as_csv_all_out/png/plot_test.csv",
          "x_column": "ax_00_plot_test_plot_x",
          "y_column": "ax_00_plot_test_plot_y",
          "color": "#0080C0",
          "xlabel": "Time (s)",
          "ylabel": "Amplitude"
        }
      },
      {
        "id": "B",
        "x_mm": 49,
        "y_mm": 31,
        "width_mm": 35,
        "height_mm": 24.5,
        "plot": {
          "kind": "scatter",
          "csv_path": "/scitex-code/tests/custom/test_export_as_csv_all_out/png/scatter_test.csv",
          "x_column": "ax_00_scatter_test_scatter_x",
          "y_column": "ax_00_scatter_test_scatter_y",
          "color": "#FF4632",
          "xlabel": "X values",
          "ylabel": "Y values"
        }
      },
      {
        "id": "C",
        "x_mm": 5,
        "y_mm": 2,
        "width_mm": 35,
        "height_mm": 24.5,
        "plot": {
          "kind": "bar",
          "csv_path": "/scitex-code/tests/custom/test_export_as_csv_all_out/png/bar_test.csv",
          "x_column": "ax_00_bar_test_x",
          "y_column": "ax_00_bar_test_y",
          "color": "#14B414",
          "xlabel": "Categories",
          "ylabel": "Values"
        }
      },
      {
        "id": "D",
        "x_mm": 49,
        "y_mm": 2,
        "width_mm": 35,
        "height_mm": 24.5,
        "plot": {
          "kind": "line",
          "csv_path": "/scitex-code/tests/custom/test_export_as_csv_all_out/png/plot_line_test.csv",
          "x_column": "ax_00_plot_line_test_line_x",
          "y_column": "ax_00_plot_line_test_line_y",
          "color": "#E6A014",
          "xlabel": "Time",
          "ylabel": "Response"
        }
      }
    ]
  }
};

function loadExample(type) {
  const spec = examples[type];
  document.getElementById('jsonSpec').value = JSON.stringify(spec, null, 2);
  document.getElementById('status').innerHTML =
    `<div class="success-message">Loaded ${type} plot example</div>`;
}

async function renderPlot() {
  const jsonSpec = document.getElementById('jsonSpec').value;
  const statusDiv = document.getElementById('status');
  const resultContainer = document.getElementById('resultContainer');

  try {
    // Parse JSON to validate
    const spec = JSON.parse(jsonSpec);

    statusDiv.innerHTML = '<div class="success-message">Rendering plot...</div>';
    resultContainer.innerHTML = '<p style="color: var(--text-tertiary);">Rendering...</p>';

    // Send to backend
    const response = await fetch('/vis/api/plot/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: jsonSpec
    });

    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error || 'Failed to render plot');
    }

    // Get SVG
    const svgText = await response.text();

    // Display SVG
    resultContainer.innerHTML = svgText;
    statusDiv.innerHTML = '<div class="success-message">Plot rendered successfully!</div>';

  } catch (error) {
    statusDiv.innerHTML = `<div class="error-message">Error: ${error.message}</div>`;
    resultContainer.innerHTML = `<p style="color: #ff4444;">Failed to render plot</p>`;
  }
}
</script>
{% endblock %}
