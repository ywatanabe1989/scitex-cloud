{% extends "global_base.html" %}
{% block title %}PDF Splitter - Browser Tool | SciTeX{% endblock %}
{% block meta_description %}Extract specific pages from PDF files. Select page ranges and download individual pages or custom sections.{% endblock %}
{% block head_extra %}
    {% load static %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
{% endblock %}
{% block extra_css %}
    <style>
  .tool-detail-container { max-width: 1200px; margin: 0 auto; padding: 40px 20px; }
  .tool-header { text-align: center; padding: 40px 20px; margin-bottom: 40px; }
  .tool-title { font-size: 42px; font-weight: 700; margin-bottom: 16px; }
  .tool-breadcrumb { font-size: 14px; margin-bottom: 16px; }
  .tool-breadcrumb a { color: #4a9b7e; text-decoration: none; }
  .tool-app-container { background: var(--bg-secondary); border-radius: 12px; padding: 40px; }
  .upload-zone { border: 3px dashed #4a9b7e; border-radius: 8px; padding: 60px 20px; text-align: center; cursor: pointer; background: var(--bg-primary); }
  .page-selector { margin: 30px 0; }
  .page-input { padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; width: 100%; margin-top: 10px; }
  .btn { padding: 12px 24px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; border: none; }
  .btn-primary { background: #4a9b7e; color: white; }
  .btn-primary:hover:not(:disabled) { background: #3a7c65; }
  .btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .status-message { text-align: center; padding: 12px; border-radius: 6px; margin: 20px 0; }
  .status-message.success { background: #f0fdf7; color: #15803d; }
    </style>
{% endblock %}
{% block content %}
    <div class="tool-detail-container">
        <div class="tool-breadcrumb"><a href="{% url 'public_app:tools' %}">‚Üê Back to Tools</a></div>
        <div class="tool-header">
            <div style="font-size: 64px; margin-bottom: 20px;">‚úÇÔ∏è</div>
            <h1 class="tool-title">PDF Splitter</h1>
            <p style="font-size: 18px; color: var(--text-secondary);">Extract specific pages from PDF files</p>
        </div>
        <div class="tool-app-container">
            <div id="uploadZone" class="upload-zone">
                <div style="font-size: 48px; margin-bottom: 16px;">üì§</div>
                <div style="font-size: 18px; margin-bottom: 8px;">Drop PDF file or click to upload</div>
                <input type="file" id="fileInput" accept=".pdf" style="display: none" />
            </div>
            <div id="statusMessage"></div>
            <div id="pageSelector" class="page-selector" style="display: none;">
                <h3>Select Pages to Extract</h3>
                <p style="color: var(--text-secondary); font-size: 14px;">Enter page numbers or ranges (e.g., "1,3,5-8")</p>
                <input type="text" id="pageInput" class="page-input" placeholder="1,3,5-8" />
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button id="splitBtn" class="btn btn-primary" disabled>‚úÇÔ∏è Split PDF</button>
            </div>
        </div>
    </div>
    <script>
  const { PDFDocument } = PDFLib;
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
  let pdfData = null;
  let totalPages = 0;

  document.getElementById('uploadZone').addEventListener('click', () => document.getElementById('fileInput').click());
  document.getElementById('fileInput').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file || file.type !== 'application/pdf') return;

    const arrayBuffer = await file.arrayBuffer();
    pdfData = arrayBuffer;
    const pdfDoc = await PDFDocument.load(arrayBuffer);
    totalPages = pdfDoc.getPageCount();

    document.getElementById('pageSelector').style.display = 'block';
    document.getElementById('splitBtn').disabled = false;
    showStatus(`PDF loaded: ${totalPages} pages`, 'success');
  });

  document.getElementById('splitBtn').addEventListener('click', async () => {
    const pageInput = document.getElementById('pageInput').value;
    const pages = parsePageRange(pageInput, totalPages);

    if (pages.length === 0) {
      alert('Please enter valid page numbers');
      return;
    }

    showStatus('Extracting pages...', 'success');
    const pdfDoc = await PDFDocument.load(pdfData);
    const newPdf = await PDFDocument.create();

    for (const pageNum of pages) {
      const [copiedPage] = await newPdf.copyPages(pdfDoc, [pageNum - 1]);
      newPdf.addPage(copiedPage);
    }

    const pdfBytes = await newPdf.save();
    const blob = new Blob([pdfBytes], { type: 'application/pdf' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `extracted-pages-${Date.now()}.pdf`;
    a.click();
    URL.revokeObjectURL(url);

    showStatus('Pages extracted successfully!', 'success');
  });

  function parsePageRange(input, maxPages) {
    const pages = new Set();
    const parts = input.split(',');

    parts.forEach(part => {
      part = part.trim();
      if (part.includes('-')) {
        const [start, end] = part.split('-').map(n => parseInt(n.trim()));
        for (let i = start; i <= Math.min(end, maxPages); i++) {
          if (i >= 1) pages.add(i);
        }
      } else {
        const num = parseInt(part);
        if (num >= 1 && num <= maxPages) pages.add(num);
      }
    });

    return Array.from(pages).sort((a, b) => a - b);
  }

  function showStatus(message, type) {
    const status = document.getElementById('statusMessage');
    status.className = `status-message ${type}`;
    status.textContent = message;
    status.style.display = 'block';
  }
    </script>
{% endblock %}
