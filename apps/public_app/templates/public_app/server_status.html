{% extends "global_base.html" %}
{% load static %}

{% block title %}Server Status - SciTeX Cloud{% endblock %}

{% block meta_description %}
Check the current status of SciTeX Cloud services and infrastructure.
{% endblock %}

{% block extra_css %}
<style>
.server-status-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 4rem 2rem;
}

.status-hero {
    text-align: center;
    margin-bottom: 3rem;
}

.status-hero-title {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 1rem;
    color: var(--text-primary);
}

.status-hero-subtitle {
    font-size: 1.1rem;
    color: var(--text-muted);
    max-width: 600px;
    margin: 0 auto;
}

.status-section {
    margin-bottom: 3rem;
}

.section-title {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 1.5rem;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.section-title i {
    color: var(--scitex-color-04);
}

.services-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1.5rem;
}

.service-card {
    background: var(--bg-surface);
    border: 2px solid var(--border-default);
    border-radius: 12px;
    padding: 1.5rem;
    transition: all 0.3s ease;
}

.service-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
}

.service-card.running {
    border-color: var(--status-success);
    background: linear-gradient(135deg, var(--bg-surface) 0%, rgba(76, 175, 80, 0.05) 100%);
}

.service-card.down {
    border-color: var(--status-error);
    background: linear-gradient(135deg, var(--bg-surface) 0%, rgba(244, 67, 54, 0.05) 100%);
}

.service-card.warning {
    border-color: var(--status-warning);
    background: linear-gradient(135deg, var(--bg-surface) 0%, rgba(255, 152, 0, 0.05) 100%);
}

.service-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
}

.service-name {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-primary);
}

.status-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 500;
}

.status-badge.running {
    background: var(--status-success);
    color: white;
}

.status-badge.down {
    background: var(--status-error);
    color: white;
}

.status-badge.error {
    background: var(--status-warning);
    color: white;
}

.status-badge i {
    font-size: 0.75rem;
}

.service-details {
    font-size: 0.9rem;
    color: var(--text-muted);
}

.service-details div {
    margin: 0.5rem 0;
}

.metric-card {
    background: var(--bg-surface);
    border: 1px solid var(--border-default);
    border-radius: 12px;
    padding: 1.5rem;
    text-align: center;
}

.metric-value {
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
}

.metric-label {
    font-size: 0.9rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.progress-bar {
    height: 8px;
    background: var(--border-default);
    border-radius: 4px;
    overflow: hidden;
    margin-top: 1rem;
}

.progress-fill {
    height: 100%;
    background: var(--status-success);
    transition: width 0.3s ease;
}

.progress-fill.warning {
    background: var(--status-warning);
}

.progress-fill.critical {
    background: var(--status-error);
}

.info-box {
    background: var(--color-attention-subtle);
    border-left: 3px solid var(--scitex-color-04);
    border-radius: 6px;
    padding: 1rem 1.5rem;
    margin-top: 2rem;
}

.info-box p {
    margin: 0;
    color: var(--text-primary);
}

.info-box a {
    color: var(--scitex-color-04);
    text-decoration: none;
    font-weight: 500;
}

.info-box a:hover {
    text-decoration: underline;
}
</style>
{% endblock %}

{% block extra_js %}
<!-- Chart.js for time-series graphs -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}
<div class="server-status-container">
    <!-- Hero Section -->
    <div class="status-hero">
        <h1 class="status-hero-title">
            <i class="fas fa-server"></i> Server Status
        </h1>
        <p class="status-hero-subtitle">
            Real-time monitoring of SciTeX Cloud infrastructure and services
        </p>

        <!-- Export Controls -->
        <div style="margin-top: 2rem; display: flex; gap: 1rem; justify-content: center; align-items: center; flex-wrap: wrap;">
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-clock" style="color: var(--scitex-color-04);"></i>
                <select id="exportTimeRange" class="form-select" style="width: auto;">
                    <option value="1">Last 1 hour</option>
                    <option value="6">Last 6 hours</option>
                    <option value="24" selected>Last 24 hours</option>
                    <option value="168">Last 7 days</option>
                    <option value="720">Last 30 days</option>
                </select>
            </div>
            <a href="/api/server-metrics/export/?hours=24" id="exportButton" class="btn btn-primary" download>
                <i class="fas fa-download me-2"></i>Export Metrics as CSV
            </a>
        </div>
    </div>

    <!-- Real-Time Charts -->
    <div class="status-section">
        <h2 class="section-title">
            <i class="fas fa-chart-area"></i> Real-Time Metrics
        </h2>
        <div class="services-grid" style="grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));">
            <!-- CPU Chart -->
            <div class="metric-card">
                <div class="metric-label" style="margin-bottom: 1rem;">
                    <i class="fas fa-microchip" style="color: rgb(54, 162, 235);"></i> CPU Usage Over Time
                </div>
                <canvas id="cpuChart" style="max-height: 200px;"></canvas>
            </div>

            <!-- Memory Chart -->
            <div class="metric-card">
                <div class="metric-label" style="margin-bottom: 1rem;">
                    <i class="fas fa-memory" style="color: rgb(255, 99, 132);"></i> Memory Usage Over Time
                </div>
                <canvas id="memoryChart" style="max-height: 200px;"></canvas>
            </div>

            <!-- Disk Chart -->
            <div class="metric-card">
                <div class="metric-label" style="margin-bottom: 1rem;">
                    <i class="fas fa-hdd" style="color: rgb(75, 192, 192);"></i> Disk Usage Over Time
                </div>
                <canvas id="diskChart" style="max-height: 200px;"></canvas>
            </div>

            <!-- GPU Chart -->
            <div class="metric-card">
                <div class="metric-label" style="margin-bottom: 1rem;">
                    <i class="fas fa-desktop" style="color: rgb(153, 102, 255);"></i> GPU Usage Over Time
                </div>
                <canvas id="gpuChart" style="max-height: 200px;"></canvas>
                <div id="gpuStatus" style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-muted); text-align: center;">
                    <i class="fas fa-circle-notch fa-spin"></i> Detecting GPU...
                </div>
            </div>
        </div>
    </div>

    <!-- System Resources -->
    <div class="status-section">
        <h2 class="section-title">
            <i class="fas fa-chart-line"></i> System Resources
        </h2>
        <div class="services-grid">
            <!-- CPU Information -->
            {% if status_data.system.cpu_percent %}
            <div class="metric-card">
                <div class="metric-value">
                    <i class="fas fa-microchip" style="font-size: 1.2rem; color: var(--scitex-color-04); margin-right: 0.5rem;"></i>
                    {{ status_data.system.cpu_percent|floatformat:1 }}%
                </div>
                <div class="metric-label"><i class="fas fa-microchip"></i> CPU Usage</div>
                <div class="progress-bar">
                    <div class="progress-fill {% if status_data.system.cpu_percent > 90 %}critical{% elif status_data.system.cpu_percent > 75 %}warning{% endif %}"
                         style="width: {{ status_data.system.cpu_percent }}%"></div>
                </div>
                <div style="margin-top: 1rem; font-size: 0.85rem; color: var(--text-muted);">
                    {% if status_data.system.cpu_cores %}
                    <div><i class="fas fa-layer-group"></i> <strong>Cores:</strong> {{ status_data.system.cpu_cores }} physical ({{ status_data.system.cpu_cores_logical }} logical)</div>
                    {% endif %}
                    {% if status_data.system.cpu_name %}
                    <div style="margin-top: 0.5rem;"><i class="fas fa-tag"></i> <strong>Model:</strong> {{ status_data.system.cpu_name|truncatechars:40 }}</div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Memory Usage -->
            {% if status_data.system.memory_percent %}
            <div class="metric-card">
                <div class="metric-value">
                    <i class="fas fa-memory" style="font-size: 1.2rem; color: var(--scitex-color-04); margin-right: 0.5rem;"></i>
                    {{ status_data.system.memory_percent|floatformat:1 }}%
                </div>
                <div class="metric-label"><i class="fas fa-memory"></i> Memory Usage</div>
                <div class="progress-bar">
                    <div class="progress-fill {% if status_data.system.memory_percent > 90 %}critical{% elif status_data.system.memory_percent > 75 %}warning{% endif %}"
                         style="width: {{ status_data.system.memory_percent }}%"></div>
                </div>
                <div style="margin-top: 1rem; font-size: 0.9rem; color: var(--text-muted);">
                    <i class="fas fa-database"></i> {{ status_data.system.memory_available_gb }} GB / {{ status_data.system.memory_total_gb }} GB available
                </div>
            </div>
            {% endif %}

            <!-- Disk Usage -->
            {% if status_data.disk.total_gb %}
            <div class="metric-card">
                <div class="metric-value">
                    <i class="fas fa-hdd" style="font-size: 1.2rem; color: var(--scitex-color-04); margin-right: 0.5rem;"></i>
                    {{ status_data.disk.percent_used|floatformat:1 }}%
                </div>
                <div class="metric-label"><i class="fas fa-hdd"></i> Disk Usage</div>
                <div class="progress-bar">
                    <div class="progress-fill {% if status_data.disk.percent_used > 90 %}critical{% elif status_data.disk.percent_used > 75 %}warning{% endif %}"
                         style="width: {{ status_data.disk.percent_used }}%"></div>
                </div>
                <div style="margin-top: 1rem; font-size: 0.9rem; color: var(--text-muted);">
                    <i class="fas fa-chart-pie"></i> {{ status_data.disk.used_gb }} GB / {{ status_data.disk.total_gb }} GB used
                </div>
            </div>
            {% endif %}

            <!-- GPU Information -->
            {% if status_data.system.gpu_info %}
            <div class="metric-card">
                <div class="metric-value" style="font-size: 1.8rem;">
                    {% if status_data.system.gpu_info == "None available" %}
                    <i class="fas fa-times-circle" style="color: var(--text-muted);"></i>
                    {% else %}
                    <i class="fas fa-desktop" style="color: var(--status-success);"></i>
                    {% endif %}
                </div>
                <div class="metric-label"><i class="fas fa-desktop"></i> GPU</div>
                <div style="margin-top: 1rem; font-size: 0.9rem; color: var(--text-muted);">
                    {% if status_data.system.gpu_info == "None available" %}
                    <i class="fas fa-info-circle"></i> {{ status_data.system.gpu_info }}
                    {% else %}
                    <i class="fas fa-check-circle" style="color: var(--status-success);"></i> {{ status_data.system.gpu_info }}
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Disk I/O -->
            {% if status_data.system.disk_read_mb %}
            <div class="metric-card">
                <div class="metric-value" style="font-size: 1.5rem; color: var(--scitex-color-04);">
                    <i class="fas fa-exchange-alt"></i>
                </div>
                <div class="metric-label"><i class="fas fa-hdd"></i> Disk I/O (Total)</div>
                <div style="margin-top: 1rem; font-size: 0.9rem; color: var(--text-muted);">
                    <div><i class="fas fa-download"></i> <strong>Read:</strong> {{ status_data.system.disk_read_mb }} MB</div>
                    <div style="margin-top: 0.3rem;"><i class="fas fa-upload"></i> <strong>Write:</strong> {{ status_data.system.disk_write_mb }} MB</div>
                </div>
            </div>
            {% endif %}

            <!-- Network I/O -->
            {% if status_data.system.net_sent_mb %}
            <div class="metric-card">
                <div class="metric-value" style="font-size: 1.5rem; color: var(--scitex-color-04);">
                    <i class="fas fa-network-wired"></i>
                </div>
                <div class="metric-label"><i class="fas fa-network-wired"></i> Network I/O (Total)</div>
                <div style="margin-top: 1rem; font-size: 0.9rem; color: var(--text-muted);">
                    <div><i class="fas fa-arrow-up"></i> <strong>Sent:</strong> {{ status_data.system.net_sent_mb }} MB</div>
                    <div style="margin-top: 0.3rem;"><i class="fas fa-arrow-down"></i> <strong>Received:</strong> {{ status_data.system.net_recv_mb }} MB</div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Docker Services -->
    <div class="status-section">
        <h2 class="section-title">
            <i class="fab fa-docker"></i> Docker Services
        </h2>
        <div class="services-grid">
            {% for service in status_data.services %}
            <div class="service-card {% if service.is_running %}running{% else %}down{% endif %}">
                <div class="service-header">
                    <div class="service-name">
                        <i class="fas fa-cube"></i> {{ service.name|title }}
                    </div>
                    <span class="status-badge {% if service.is_running %}running{% else %}down{% endif %}">
                        <i class="fas fa-circle"></i>
                        {{ service.status|upper }}
                    </span>
                </div>
                <div class="service-details">
                    {% if service.image %}
                    <div><strong>Image:</strong> {{ service.image }}</div>
                    {% endif %}
                    {% if service.error %}
                    <div style="color: var(--status-error);"><strong>Error:</strong> {{ service.error }}</div>
                    {% endif %}
                </div>
            </div>
            {% empty %}
            <div class="service-card warning">
                <p>No Docker services detected</p>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- SSH Services -->
    <div class="status-section">
        <h2 class="section-title">
            <i class="fas fa-key"></i> SSH Services
        </h2>
        <div class="services-grid">
            {% for ssh in status_data.ssh_services %}
            <div class="service-card {% if ssh.is_running %}running{% else %}down{% endif %}">
                <div class="service-header">
                    <div class="service-name">
                        <i class="fas fa-terminal"></i> {{ ssh.name }}
                    </div>
                    <span class="status-badge {% if ssh.is_running %}running{% else %}down{% endif %}">
                        <i class="fas fa-circle"></i>
                        {{ ssh.status|upper }}
                    </span>
                </div>
                <div class="service-details">
                    <div><strong>Port:</strong> {{ ssh.port }}</div>
                    <div><strong>Auth:</strong> SSH Key Only</div>
                    {% if ssh.error %}
                    <div style="color: var(--status-error);"><strong>Error:</strong> {{ ssh.error }}</div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Database & Cache -->
    <div class="status-section">
        <h2 class="section-title">
            <i class="fas fa-database"></i> Database & Cache
        </h2>
        <div class="services-grid">
            <!-- PostgreSQL -->
            <div class="service-card {% if status_data.database.is_running %}running{% else %}down{% endif %}">
                <div class="service-header">
                    <div class="service-name">
                        <i class="fas fa-database"></i> PostgreSQL
                    </div>
                    <span class="status-badge {% if status_data.database.is_running %}running{% else %}down{% endif %}">
                        <i class="fas fa-circle"></i>
                        {{ status_data.database.status|upper }}
                    </span>
                </div>
                <div class="service-details">
                    {% if status_data.database.backend %}
                    <div><strong>Backend:</strong> {{ status_data.database.backend }}</div>
                    {% endif %}
                    {% if status_data.database.name %}
                    <div><strong>Database:</strong> {{ status_data.database.name }}</div>
                    {% endif %}
                    {% if status_data.database.error %}
                    <div style="color: var(--status-error);"><strong>Error:</strong> {{ status_data.database.error }}</div>
                    {% endif %}
                </div>
            </div>

            <!-- Redis -->
            <div class="service-card {% if status_data.redis.is_running %}running{% else %}down{% endif %}">
                <div class="service-header">
                    <div class="service-name">
                        <i class="fas fa-memory"></i> Redis Cache
                    </div>
                    <span class="status-badge {% if status_data.redis.is_running %}running{% else %}down{% endif %}">
                        <i class="fas fa-circle"></i>
                        {{ status_data.redis.status|upper }}
                    </span>
                </div>
                <div class="service-details">
                    <div><strong>Purpose:</strong> Session & Cache</div>
                    {% if status_data.redis.error %}
                    <div style="color: var(--status-error);"><strong>Error:</strong> {{ status_data.redis.error }}</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Info Box -->
    <div class="info-box">
        <p>
            <i class="fas fa-info-circle"></i>
            <strong>SSH Authentication:</strong> All SSH services use key-based authentication only.
            <a href="/accounts/settings/ssh-keys/">Manage your SSH keys â†’</a>
        </p>
    </div>
</div>

<script>
// Real-time metrics charts with Chart.js
(function() {
    const MAX_DATA_POINTS = 60; // Keep last 60 data points (1 minute if polling every second)
    const UPDATE_INTERVAL = 2000; // Update every 2 seconds

    // Chart configuration
    const chartConfig = {
        type: 'line',
        options: {
            responsive: true,
            maintainAspectRatio: true,
            animation: {
                duration: 300
            },
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: 'second',
                        displayFormats: {
                            second: 'HH:mm:ss'
                        }
                    },
                    title: {
                        display: true,
                        text: 'Time'
                    },
                    ticks: {
                        maxRotation: 0,
                        autoSkipPadding: 20
                    }
                },
                y: {
                    beginAtZero: true,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Usage (%)'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    };

    // Initialize CPU chart
    const cpuCtx = document.getElementById('cpuChart').getContext('2d');
    const cpuChart = new Chart(cpuCtx, {
        ...chartConfig,
        data: {
            datasets: [{
                label: 'CPU Usage',
                data: [],
                borderColor: 'rgb(54, 162, 235)',
                backgroundColor: 'rgba(54, 162, 235, 0.1)',
                borderWidth: 2,
                tension: 0.4,
                fill: true,
                spanGaps: false  // Don't connect points when there are null values
            }]
        }
    });

    // Initialize Memory chart
    const memoryCtx = document.getElementById('memoryChart').getContext('2d');
    const memoryChart = new Chart(memoryCtx, {
        ...chartConfig,
        data: {
            datasets: [{
                label: 'Memory Usage',
                data: [],
                borderColor: 'rgb(255, 99, 132)',
                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                borderWidth: 2,
                tension: 0.4,
                fill: true,
                spanGaps: false  // Don't connect points when there are null values
            }]
        }
    });

    // Initialize Disk chart
    const diskCtx = document.getElementById('diskChart').getContext('2d');
    const diskChart = new Chart(diskCtx, {
        ...chartConfig,
        data: {
            datasets: [{
                label: 'Disk Usage',
                data: [],
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                borderWidth: 2,
                tension: 0.4,
                fill: true,
                spanGaps: false  // Don't connect points when there are null values
            }]
        }
    });

    // Initialize GPU chart
    const gpuCtx = document.getElementById('gpuChart').getContext('2d');
    const gpuChart = new Chart(gpuCtx, {
        ...chartConfig,
        data: {
            datasets: [{
                label: 'GPU Usage',
                data: [],
                borderColor: 'rgb(153, 102, 255)',
                backgroundColor: 'rgba(153, 102, 255, 0.1)',
                borderWidth: 2,
                tension: 0.4,
                fill: true,
                spanGaps: false  // Don't connect points when there are null values
            }]
        }
    });

    let gpuAvailable = null;  // Track GPU availability

    // Fetch and update metrics
    async function updateMetrics() {
        try {
            const response = await fetch('/api/server-status/');
            const data = await response.json();

            const timestamp = data.timestamp;

            // Update CPU chart (handle NaN/null values)
            const cpuValue = (data.cpu_percent !== null && data.cpu_percent !== undefined && !isNaN(data.cpu_percent))
                ? data.cpu_percent : null;
            cpuChart.data.datasets[0].data.push({
                x: timestamp,
                y: cpuValue
            });
            if (cpuChart.data.datasets[0].data.length > MAX_DATA_POINTS) {
                cpuChart.data.datasets[0].data.shift();
            }
            cpuChart.update('none'); // 'none' mode for better performance

            // Update Memory chart (handle NaN/null values)
            const memoryValue = (data.memory_percent !== null && data.memory_percent !== undefined && !isNaN(data.memory_percent))
                ? data.memory_percent : null;
            memoryChart.data.datasets[0].data.push({
                x: timestamp,
                y: memoryValue
            });
            if (memoryChart.data.datasets[0].data.length > MAX_DATA_POINTS) {
                memoryChart.data.datasets[0].data.shift();
            }
            memoryChart.update('none');

            // Update Disk chart (handle NaN/null values)
            const diskValue = (data.disk_percent !== null && data.disk_percent !== undefined && !isNaN(data.disk_percent))
                ? data.disk_percent : null;
            diskChart.data.datasets[0].data.push({
                x: timestamp,
                y: diskValue
            });
            if (diskChart.data.datasets[0].data.length > MAX_DATA_POINTS) {
                diskChart.data.datasets[0].data.shift();
            }
            diskChart.update('none');

            // Update GPU chart and status
            const gpuStatusEl = document.getElementById('gpuStatus');
            if (data.gpu_percent !== null && data.gpu_percent !== undefined) {
                // GPU is available
                if (gpuAvailable === null) {
                    gpuAvailable = true;
                    gpuStatusEl.innerHTML = '<i class="fas fa-check-circle" style="color: var(--status-success);"></i> GPU detected';
                }

                gpuChart.data.datasets[0].data.push({
                    x: timestamp,
                    y: data.gpu_percent
                });
                if (gpuChart.data.datasets[0].data.length > MAX_DATA_POINTS) {
                    gpuChart.data.datasets[0].data.shift();
                }
                gpuChart.update('none');
            } else {
                // GPU is not available
                if (gpuAvailable === null) {
                    gpuAvailable = false;
                    gpuStatusEl.innerHTML = '<i class="fas fa-times-circle" style="color: var(--text-muted);"></i> No GPU available';
                }

                // Add null data point to maintain time continuity but don't display
                gpuChart.data.datasets[0].data.push({
                    x: timestamp,
                    y: null
                });
                if (gpuChart.data.datasets[0].data.length > MAX_DATA_POINTS) {
                    gpuChart.data.datasets[0].data.shift();
                }
                gpuChart.update('none');
            }

        } catch (error) {
            console.error('Error fetching metrics:', error);
        }
    }

    // Initial update
    updateMetrics();

    // Set up periodic updates
    setInterval(updateMetrics, UPDATE_INTERVAL);
})();

// Export button time range selector
document.getElementById('exportTimeRange').addEventListener('change', function(e) {
    const hours = e.target.value;
    document.getElementById('exportButton').href = `/api/server-metrics/export/?hours=${hours}`;
});
</script>

{% endblock %}
