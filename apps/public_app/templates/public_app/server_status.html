{% extends "global_base.html" %}
{% load static %}

{% block title %}Server Status - SciTeX Cloud{% endblock %}

{% block meta_description %}
Check the current status of SciTeX Cloud services and infrastructure.
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'public_app/css/server-status.css' %}">
{% endblock %}

{% block extra_js %}
<!-- Chart.js for time-series graphs -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
{% endblock %}

{% block content %}
<div class="server-status-container">
    <!-- Hero Section -->
    <div class="status-hero">
        <h1 class="status-hero-title">
            <i class="fas fa-server"></i> Server Status
        </h1>
        <p class="status-hero-subtitle">
            Real-time monitoring of SciTeX Cloud infrastructure and services
        </p>

        <!-- Health Status Legend -->
        <div class="health-legend">
            <div class="has-tooltip health-legend-item" data-tooltip="Green = Service is running and passes its health check (e.g., HTTP 200, database query succeeds, port is open).">
                <div class="health-indicator health-indicator-success"></div>
                <span class="health-legend-text">
                    <strong>Healthy:</strong> Running normally
                </span>
            </div>
            <div class="has-tooltip health-legend-item" data-tooltip="Orange = Service is running but health check not yet passing (within start_period grace period).">
                <div class="health-indicator health-indicator-warning"></div>
                <span class="health-legend-text">
                    <strong>Starting:</strong> Initializing
                </span>
            </div>
            <div class="has-tooltip health-legend-item" data-tooltip="Red = Service is stopped, crashed, or health check failing (e.g., HTTP 500, database unreachable, port closed).">
                <div class="health-indicator health-indicator-error"></div>
                <span class="health-legend-text">
                    <strong>Unhealthy:</strong> Service down
                </span>
            </div>
        </div>
    </div>

    <!-- Unified System Metrics -->
    <div class="status-section">
        <h2 class="section-title has-tooltip" id="metricsTitle" data-tooltip="Real-time metrics from the entire host computer (all processes, not just SciTeX). Charts update every 2 seconds.">
            <i class="fas fa-chart-area"></i> System Metrics (Last 1 Hour)
        </h2>
        <div class="services-grid metrics-grid">
            <!-- CPU Chart -->
            <div class="metric-card">
                <div class="metric-label">
                    <span>
                        <i class="fas fa-microchip metric-icon-cpu"></i> CPU Usage
                    </span>
                    <span id="cpuCurrentValue" class="metric-current-value metric-current-value-cpu">--</span>
                </div>
                <canvas id="cpuChart" class="metric-chart"></canvas>
                {% if status_data.system.cpu_cores %}
                <div class="metric-info">
                    {{ status_data.system.cpu_cores }} cores ({{ status_data.system.cpu_cores_logical }} logical)
                    {% if status_data.system.cpu_name %}
                    <br>{{ status_data.system.cpu_name|truncatechars:50 }}
                    {% endif %}
                </div>
                {% endif %}
            </div>

            <!-- Memory Chart -->
            <div class="metric-card">
                <div class="metric-label">
                    <span>
                        <i class="fas fa-memory metric-icon-memory"></i> Memory Usage
                    </span>
                    <span id="memoryCurrentValue" class="metric-current-value metric-current-value-memory">--</span>
                </div>
                <canvas id="memoryChart" class="metric-chart"></canvas>
                {% if status_data.system.memory_total_gb %}
                <div class="metric-info">
                    {{ status_data.system.memory_available_gb }} GB / {{ status_data.system.memory_total_gb }} GB available
                </div>
                {% endif %}
            </div>

            <!-- Disk Chart -->
            <div class="metric-card">
                <div class="metric-label">
                    <span>
                        <i class="fas fa-hdd metric-icon-disk"></i> Disk Usage
                    </span>
                    <span id="diskCurrentValue" class="metric-current-value metric-current-value-disk">--</span>
                </div>
                <canvas id="diskChart" class="metric-chart"></canvas>
                {% if status_data.disk.total_tb %}
                <div class="metric-info">
                    {{ status_data.disk.used_tb }} TB / {{ status_data.disk.total_tb }} TB used
                </div>
                {% endif %}
            </div>

            <!-- GPU Chart -->
            <div class="metric-card">
                <div class="metric-label">
                    <span>
                        <i class="fas fa-desktop metric-icon-gpu"></i> GPU Usage
                    </span>
                    <span id="gpuCurrentValue" class="metric-current-value metric-current-value-gpu">--</span>
                </div>
                <canvas id="gpuChart" class="metric-chart"></canvas>
                <div id="gpuStatus" class="metric-info">
                    <i class="fas fa-circle-notch fa-spin"></i> Detecting GPU...
                </div>
            </div>

            <!-- Disk I/O Chart -->
            <div class="metric-card">
                <div class="metric-label">
                    <span>
                        <i class="fas fa-exchange-alt metric-icon-disk-io"></i> Disk I/O Rate
                    </span>
                    <span id="diskIoCurrentValue" class="metric-current-value metric-current-value-disk-io">--</span>
                </div>
                <canvas id="diskIoChart" class="metric-chart"></canvas>
                {% if status_data.system.disk_read_mb %}
                <div class="metric-info">
                    Total: ↓{{ status_data.system.disk_read_mb }} MB read, ↑{{ status_data.system.disk_write_mb }} MB written
                </div>
                {% endif %}
            </div>

            <!-- Network I/O Chart -->
            <div class="metric-card">
                <div class="metric-label">
                    <span>
                        <i class="fas fa-network-wired metric-icon-network"></i> Network I/O Rate
                    </span>
                    <span id="netIoCurrentValue" class="metric-current-value metric-current-value-network">--</span>
                </div>
                <canvas id="netIoChart" class="metric-chart"></canvas>
                {% if status_data.system.net_sent_mb %}
                <div class="metric-info">
                    Total: ↑{{ status_data.system.net_sent_mb }} MB sent, ↓{{ status_data.system.net_recv_mb }} MB received
                </div>
                {% endif %}
            </div>

            <!-- Visitor Pool Chart -->
            <div class="metric-card">
                <div class="metric-label">
                    <span class="has-tooltip" data-tooltip="Shows how many visitor slots are currently allocated. When full, new anonymous users must wait for a slot to free up (sessions expire after 60 minutes).">
                        <i class="fas fa-users metric-icon-visitor-pool"></i> Visitor Pool Status
                    </span>
                    <span id="visitorPoolCurrentValue" class="metric-current-value metric-current-value-visitor-pool">--</span>
                </div>
                <canvas id="visitorPoolChart" class="metric-chart"></canvas>
                <div class="metric-info">
                    Anonymous visitor sessions (1h lifetime each)
                </div>
            </div>

            <!-- Active Users Chart -->
            <div class="metric-card">
                <div class="metric-label">
                    <span class="has-tooltip" data-tooltip="Registered users with active sessions (not visitors). Counted based on Django session activity within the last 15 minutes.">
                        <i class="fas fa-user-check metric-icon-users"></i> Active Users
                    </span>
                    <span id="activeUsersCurrentValue" class="metric-current-value metric-current-value-users">--</span>
                </div>
                <canvas id="activeUsersChart" class="metric-chart"></canvas>
                <div class="metric-info">
                    Currently logged-in users with active sessions
                </div>
            </div>
        </div>
    </div>

    <!-- Docker Services -->
    <div class="status-section">
        <h2 class="section-title has-tooltip" data-tooltip="Containers managed by docker-compose. Health determined by Docker's built-in healthcheck commands (e.g., 'curl http://localhost:PORT/' for web services).">
            <i class="fab fa-docker"></i> Docker Services
        </h2>
        <div class="services-grid">
            {% for service in status_data.services %}
            <div class="service-card {{ service.health_class }} has-tooltip"
                 data-tooltip="Health Check: Docker healthcheck command verifies service is responding. {% if 'django' in service.name|lower %}curl http://localhost:8000/{% elif 'nginx' in service.name|lower %}curl http://localhost:80/{% elif 'postgres' in service.name|lower or 'db' in service.name|lower %}pg_isready command{% elif 'redis' in service.name|lower %}redis-cli ping{% elif 'gitea' in service.name|lower %}curl http://localhost:3000/{% elif 'flower' in service.name|lower %}curl http://localhost:5555/{% elif 'celery' in service.name|lower %}Python redis ping test{% elif 'cloudflared' in service.name|lower %}cloudflared version check{% endif %}">
                <div class="service-header">
                    <div class="service-name">
                        <i class="fas fa-cube"></i> {{ service.name|title }}
                    </div>
                    <span class="status-badge {{ service.health_class }}">
                        <i class="fas fa-circle"></i>
                        {% if service.health_status %}
                            {{ service.health_status|upper }}
                        {% else %}
                            {{ service.status|upper }}
                        {% endif %}
                    </span>
                </div>
                <div class="service-details">
                    {% if service.health_status and service.health_status != 'healthy' %}
                    <div><strong>Container:</strong> {{ service.status }}</div>
                    {% endif %}
                    {% if service.image %}
                    <div><strong>Image:</strong> {{ service.image }}</div>
                    {% endif %}
                    {% if service.error %}
                    <div class="error-message"><strong>Error:</strong> {{ service.error }}</div>
                    {% endif %}
                </div>
            </div>
            {% empty %}
            <div class="service-card warning">
                <p>No Docker services detected</p>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- SSH Services -->
    <div class="status-section">
        <h2 class="section-title has-tooltip" data-tooltip="SSH gateways for terminal access. Health checked by TCP socket connection test. All services use key-based authentication only (no passwords).">
            <i class="fas fa-key"></i> SSH Services
        </h2>
        <div class="services-grid">
            {% for ssh in status_data.ssh_services %}
            <div class="service-card {{ ssh.health_class }} has-tooltip"
                 data-tooltip="Health Check: TCP socket connection test to port {{ ssh.port }}. Returns healthy if port is open and accepting connections.">
                <div class="service-header">
                    <div class="service-name">
                        <i class="fas fa-terminal"></i> {{ ssh.name }}
                    </div>
                    <span class="status-badge {{ ssh.health_class }}">
                        <i class="fas fa-circle"></i>
                        {% if ssh.health_class == 'healthy' %}HEALTHY{% elif ssh.health_class == 'unhealthy' %}UNHEALTHY{% else %}{{ ssh.status|upper }}{% endif %}
                    </span>
                </div>
                <div class="service-details">
                    <div><strong>Port:</strong> {{ ssh.port }}</div>
                    <div><strong>Auth:</strong> SSH Key Only</div>
                    {% if ssh.error %}
                    <div class="error-message"><strong>Error:</strong> {{ ssh.error }}</div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- SSH Authentication Info -->
        <div class="info-box info-box-with-margin">
            <p>
                <i class="fas fa-info-circle"></i>
                <strong>SSH Authentication:</strong> All SSH services use key-based authentication only.
                <a href="/accounts/settings/ssh-keys/">Manage your SSH keys →</a>
            </p>
        </div>
    </div>

    <!-- Database & Cache -->
    <div class="status-section">
        <h2 class="section-title has-tooltip" data-tooltip="PostgreSQL: Main database (health = 'SELECT 1' query succeeds). Redis: Session storage and cache (health = cache.set/get works).">
            <i class="fas fa-database"></i> Database & Cache
        </h2>
        <div class="services-grid">
            <!-- PostgreSQL -->
            <div class="service-card {{ status_data.database.health_class }} has-tooltip"
                 data-tooltip="Health Check: Executes 'SELECT 1' query. Returns healthy if database connection succeeds and query returns result.">
                <div class="service-header">
                    <div class="service-name">
                        <i class="fas fa-database"></i> PostgreSQL
                    </div>
                    <span class="status-badge {{ status_data.database.health_class }}">
                        <i class="fas fa-circle"></i>
                        {% if status_data.database.health_class == 'healthy' %}HEALTHY{% elif status_data.database.health_class == 'unhealthy' %}UNHEALTHY{% else %}{{ status_data.database.status|upper }}{% endif %}
                    </span>
                </div>
                <div class="service-details">
                    {% if status_data.database.backend %}
                    <div><strong>Backend:</strong> {{ status_data.database.backend }}</div>
                    {% endif %}
                    {% if status_data.database.name %}
                    <div><strong>Database:</strong> {{ status_data.database.name }}</div>
                    {% endif %}
                    {% if status_data.database.error %}
                    <div class="error-message"><strong>Error:</strong> {{ status_data.database.error }}</div>
                    {% endif %}
                </div>
            </div>

            <!-- Redis -->
            <div class="service-card {{ status_data.redis.health_class }} has-tooltip"
                 data-tooltip="Health Check: Performs cache.set() and cache.get() operations. Returns healthy if both operations succeed.">
                <div class="service-header">
                    <div class="service-name">
                        <i class="fas fa-memory"></i> Redis Cache
                    </div>
                    <span class="status-badge {{ status_data.redis.health_class }}">
                        <i class="fas fa-circle"></i>
                        {% if status_data.redis.health_class == 'healthy' %}HEALTHY{% elif status_data.redis.health_class == 'unhealthy' %}UNHEALTHY{% else %}{{ status_data.redis.status|upper }}{% endif %}
                    </span>
                </div>
                <div class="service-details">
                    <div><strong>Purpose:</strong> Session & Cache</div>
                    {% if status_data.redis.error %}
                    <div class="error-message"><strong>Error:</strong> {{ status_data.redis.error }}</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Computational Services (SLURM & Apptainer) -->
    <div class="status-section">
        <h2 class="section-title has-tooltip" data-tooltip="SLURM: Job scheduler and resource manager (health = 'sinfo' command returns partitions). Apptainer: Secure container runtime for user code execution (health = version command succeeds).">
            <i class="fas fa-server"></i> Computational Services
        </h2>
        <div class="services-grid">
            <!-- SLURM -->
            <div class="service-card {{ status_data.slurm.health_class }} has-tooltip"
                 data-tooltip="Health Check: Executes 'sinfo' command. Returns healthy if command succeeds and returns partition information.">
                <div class="service-header">
                    <div class="service-name">
                        <i class="fas fa-tasks"></i> Slurm
                    </div>
                    <span class="status-badge {{ status_data.slurm.health_class }}">
                        <i class="fas fa-circle"></i>
                        {% if status_data.slurm.health_class == 'healthy' %}HEALTHY{% elif status_data.slurm.health_class == 'unhealthy' %}DOWN{% else %}{{ status_data.slurm.status|upper }}{% endif %}
                    </span>
                </div>
                <div class="service-details">
                    <div><strong>Purpose:</strong> Job Scheduling & Resource Management</div>
                    {% if status_data.slurm.partitions %}
                    <div><strong>Partitions:</strong> {{ status_data.slurm.partitions }}</div>
                    {% endif %}
                    {% if status_data.slurm.error %}
                    <div class="error-message"><strong>Error:</strong> {{ status_data.slurm.error }}</div>
                    {% endif %}
                    {% if not status_data.slurm.is_running and not status_data.slurm.error %}
                    <div class="warning-message"><strong>Hint:</strong> Run <code>make slurm-start</code> to start</div>
                    {% endif %}
                </div>
            </div>

            <!-- Apptainer/Singularity -->
            <div class="service-card {{ status_data.apptainer.health_class }} has-tooltip"
                 data-tooltip="Health Check: Executes 'apptainer --version' command. Returns healthy if command succeeds and returns version string.">
                <div class="service-header">
                    <div class="service-name">
                        <i class="fas fa-box"></i> {{ status_data.apptainer.command|default:"Apptainer"|title }}
                    </div>
                    <span class="status-badge {{ status_data.apptainer.health_class }}">
                        <i class="fas fa-circle"></i>
                        {% if status_data.apptainer.health_class == 'healthy' %}HEALTHY{% elif status_data.apptainer.health_class == 'unhealthy' %}ERROR{% else %}{{ status_data.apptainer.status|upper }}{% endif %}
                    </span>
                </div>
                <div class="service-details">
                    <div><strong>Purpose:</strong> Secure Container Runtime</div>
                    {% if status_data.apptainer.version %}
                    <div><strong>Version:</strong> {{ status_data.apptainer.version }}</div>
                    {% endif %}
                    {% if status_data.apptainer.error %}
                    <div class="error-message"><strong>Error:</strong> {{ status_data.apptainer.error }}</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- HPC Info -->
        <div class="info-box info-box-with-margin">
            <p>
                <i class="fas fa-info-circle"></i>
                <strong>HPC Terminal:</strong> User terminals run inside Apptainer containers via SLURM for security and resource management.
            </p>
        </div>
    </div>

    <!-- Visitor Pool Slots -->
    <div class="status-section">
        <h2 class="section-title has-tooltip" data-tooltip="Anonymous users get temporary visitor slots (visitor-001, visitor-002, etc.) with 60-minute sessions. Pool size configured via SCITEX_VISITOR_POOL_SIZE in .env file.">
            <i class="fas fa-users"></i> Visitor Pool Status
            {% if status_data.visitor_pool.pool_status %}
            <span class="visitor-pool-status-count">
                {{ status_data.visitor_pool.pool_status.allocated }}/{{ status_data.visitor_pool.pool_status.total }} slots allocated
            </span>
            {% endif %}
        </h2>

        {% if status_data.visitor_pool.allocations %}
        <div class="slots-grid">
            {% for allocation in status_data.visitor_pool.allocations %}
            <div class="slot-card {{ allocation.status }} {% if allocation.is_current_user %}current-user{% endif %}">
                <div class="slot-header">
                    <div class="slot-number">
                        <i class="fas fa-cube allocation-project-icon"></i>
                        Slot #{{ allocation.slot_number }}
                    </div>
                    <span class="slot-status-badge {{ allocation.status }}">
                        {{ allocation.status|upper }}
                    </span>
                </div>

                {% if allocation.status == "allocated" %}
                <div class="slot-info">
                    <i class="fas fa-user allocation-visitor-icon"></i>
                    {{ allocation.visitor_username }}{% if allocation.is_current_user %} <strong class="allocation-current-user">(You)</strong>{% endif %}
                </div>
                <div class="slot-time-remaining" data-expires="{{ allocation.expires_at|date:'c' }}">
                    <i class="fas fa-clock"></i>
                    <span>
                        Expires in {{ allocation.minutes_remaining }} min
                    </span>
                </div>
                {% else %}
                <div class="slot-info">
                    <i class="fas fa-check-circle allocation-active-icon"></i>
                    Available
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="info-box info-box-with-margin">
            <p>
                <i class="fas fa-exclamation-triangle"></i>
                Could not load visitor pool status.
            </p>
        </div>
        {% endif %}

        <!-- How It Works -->
        <div class="visitor-pool-section">
            <h3 class="visitor-pool-title">
                <i class="fas fa-info-circle"></i> How Visitor Mode Works
            </h3>

            <div class="visitor-pool-grid">
                <!-- Slot Allocation -->
                <div class="info-card">
                    <h4 class="visitor-pool-card-title">
                        <i class="fas fa-user-tag visitor-pool-icon"></i>
                        Slot Allocation
                    </h4>
                    <p class="visitor-pool-card-text">
                        Navigate to any workspace to get assigned a visitor slot (e.g., <code>visitor-001</code>). First-come, first-served.
                    </p>
                </div>

                <!-- Data Separation -->
                <div class="info-card">
                    <h4 class="visitor-pool-card-title">
                        <i class="fas fa-shield-alt visitor-pool-icon"></i>
                        Data Privacy
                    </h4>
                    <p class="visitor-pool-card-text">
                        Your data is completely isolated. Each visitor has a private workspace. No one else can see your work.
                    </p>
                </div>

                <!-- Session Duration -->
                <div class="info-card">
                    <h4 class="visitor-pool-card-title">
                        <i class="fas fa-clock visitor-pool-icon"></i>
                        60-Minute Sessions
                    </h4>
                    <p class="visitor-pool-card-text">
                        Slots expire after 1 hour. Sign up to migrate your data and get unlimited access.
                    </p>
                </div>

                <!-- Sign Up -->
                <div class="info-card">
                    <h4 class="visitor-pool-card-title">
                        <i class="fas fa-user-plus visitor-pool-icon"></i>
                        Keep Your Work
                    </h4>
                    <p class="visitor-pool-card-text">
                        <a href="{% url 'auth_app:signup' %}" class="visitor-pool-link">Sign up</a> anytime to save your work permanently. All data auto-migrates.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="{% static 'public_app/js/server-status.js' %}"></script>
{% endblock %}
