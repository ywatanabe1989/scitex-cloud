{% extends 'global_base.html' %}
{% load static %}

{% block title %}Vis - Scientific Figure Editor | SciTeX{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'vis_app/css/vis.css' %}?v={{ request.timestamp|default:'9' }}">
{% endblock %}

{% block content %}
<div class="vis-container" data-figure-id="{% if figure %}{{ figure.id }}{% endif %}">
    <!-- Left Toolbar - Compact (Tools Only) -->
    <div class="vis-toolbar">
        <div class="toolbar-section collapsed">
            <h3 class="toolbar-title collapsible-header">
                <span>Annotate</span>
                <i class="fas fa-chevron-right collapse-icon"></i>
            </h3>
            <div class="toolbar-content">
                <button class="tool-btn-compact" data-tool="text" title="Text (T)">
                    <i class="fas fa-font"></i>
                    <span class="toolbar-label">Text</span>
                </button>
                <button class="tool-btn-compact" data-tool="significance" title="Significance (***)">
                    <i class="fas fa-asterisk"></i>
                    <span class="toolbar-label">***</span>
                </button>
                <button class="tool-btn-compact" data-tool="scientific-notation" title="Scientific Notation (√ó10‚Åª¬≥)">
                    <i class="fas fa-superscript"></i>
                    <span class="toolbar-label">√ó10‚Åª¬≥</span>
                </button>
                <button class="tool-btn-compact" data-tool="scalebar" title="Scale Bar (S)">
                    <i class="fas fa-ruler-horizontal"></i>
                    <span class="toolbar-label">Scale</span>
                </button>
            </div>
        </div>

        <div class="toolbar-section collapsed">
            <h3 class="toolbar-title collapsible-header">
                <span>Shapes</span>
                <i class="fas fa-chevron-right collapse-icon"></i>
            </h3>
            <div class="toolbar-content">
                <button class="tool-btn-compact" data-tool="rect-white" title="Rectangle (W)">
                    <i class="fas fa-square"></i>
                    <span class="toolbar-label">Rectangle</span>
                </button>
                <button class="tool-btn-compact" data-tool="arrow" title="Arrow (A)">
                    <i class="fas fa-arrow-right"></i>
                    <span class="toolbar-label">Arrow</span>
                </button>
            </div>
        </div>

        <div class="toolbar-section collapsed">
            <h3 class="toolbar-title collapsible-header">
                <span>Colors</span>
                <i class="fas fa-chevron-right collapse-icon"></i>
            </h3>
            <div class="toolbar-content">
                <div class="color-palette">
                    <button class="color-swatch" data-color="rgb(0,128,192)" style="background: rgb(0,128,192);" title="Blue (0, 128, 192)"></button>
                    <button class="color-swatch" data-color="rgb(255,70,50)" style="background: rgb(255,70,50);" title="Red (255, 70, 50)"></button>
                    <button class="color-swatch" data-color="rgb(20,180,20)" style="background: rgb(20,180,20);" title="Green (20, 180, 20)"></button>
                    <button class="color-swatch" data-color="rgb(230,160,20)" style="background: rgb(230,160,20);" title="Yellow (230, 160, 20)"></button>
                    <button class="color-swatch" data-color="rgb(200,50,255)" style="background: rgb(200,50,255);" title="Purple (200, 50, 255)"></button>
                    <button class="color-swatch" data-color="rgb(20,200,200)" style="background: rgb(20,200,200);" title="Lightblue (20, 200, 200)"></button>
                    <button class="color-swatch" data-color="rgb(255,150,200)" style="background: rgb(255,150,200);" title="Pink (255, 150, 200)"></button>
                    <button class="color-swatch" data-color="rgb(128,0,0)" style="background: rgb(128,0,0);" title="Brown (128, 0, 0)"></button>
                    <button class="color-swatch" data-color="rgb(0,0,100)" style="background: rgb(0,0,100);" title="Navy (0, 0, 100)"></button>
                    <button class="color-swatch" data-color="rgb(228,94,50)" style="background: rgb(228,94,50);" title="Orange (228, 94, 50)"></button>
                    <button class="color-swatch" data-color="rgb(255,255,255)" style="background: rgb(255,255,255); border: 1px solid var(--border-muted);" title="White (255, 255, 255)"></button>
                    <button class="color-swatch" data-color="rgb(128,128,128)" style="background: rgb(128,128,128);" title="Gray (128, 128, 128)"></button>
                    <button class="color-swatch" data-color="rgb(0,0,0)" style="background: rgb(0,0,0);" title="Black (0, 0, 0)"></button>
                    <label class="color-picker-wrapper" title="Color Picker">
                        <input type="color" id="customColorPicker" class="color-picker-input" value="#0080c0">
                        <div class="color-picker-button">
                            <i class="fas fa-eyedropper"></i>
                        </div>
                    </label>
                </div>
            </div>
        </div>

        <div class="toolbar-section collapsed">
            <h3 class="toolbar-title collapsible-header">
                <span>Reference Objects</span>
                <i class="fas fa-chevron-right collapse-icon"></i>
            </h3>
            <div class="toolbar-content">
                <button class="tool-btn-compact" data-tool="ref-rect-1" title="Reference Rectangles (30mm, 40mm, 50mm)">
                    <i class="fas fa-layer-group"></i>
                    <span class="toolbar-label">Rectangles</span>
                </button>
                <button class="tool-btn-compact" data-tool="col-ruler" title="Column Width Ruler (0.5, 1.0, 1.5, 2.0)">
                    <i class="fas fa-ruler-horizontal"></i>
                    <span class="toolbar-label">Column Rules</span>
                </button>
            </div>
        </div>

        <div class="toolbar-section collapsed">
            <h3 class="toolbar-title collapsible-header">
                <span>Labels</span>
                <i class="fas fa-chevron-right collapse-icon"></i>
            </h3>
            <div class="toolbar-content">
                <select id="label-style" class="toolbar-select" title="Label case">
                    <option value="uppercase">A, B, C</option>
                    <option value="lowercase">a, b, c</option>
                    <option value="numbers">1, 2, 3</option>
                </select>
                <select id="label-order" class="toolbar-select" title="Label order">
                    <option value="horizontal">Horizontal</option>
                    <option value="vertical">Vertical</option>
                    <option value="original">Original</option>
                    <option value="custom">Custom</option>
                </select>
            </div>
        </div>

        <div class="toolbar-section collapsed">
            <h3 class="toolbar-title collapsible-header">
                <span>View</span>
                <i class="fas fa-chevron-right collapse-icon"></i>
            </h3>
            <div class="toolbar-content">
                <label class="toolbar-checkbox">
                    <input type="checkbox" id="ruler-toggle" checked>
                    <span>Ruler</span>
                </label>
                <select id="ruler-unit" class="toolbar-select-sm">
                    <option value="mm">mm</option>
                    <option value="inches">in</option>
                </select>
                <label class="toolbar-checkbox">
                    <input type="checkbox" id="grid-toggle" checked>
                    <span>Grid</span>
                </label>
                <label class="toolbar-checkbox">
                    <input type="checkbox" id="snap-toggle" checked>
                    <span>Snap</span>
                </label>
                <label class="toolbar-checkbox">
                    <input type="checkbox" id="crosshair-toggle">
                    <span>Crosshair</span>
                </label>
                <label class="toolbar-checkbox">
                    <input type="checkbox" id="dark-canvas-toggle">
                    <span>Dark</span>
                </label>

                <!-- Version comparison -->
                <label class="toolbar-label">Version:</label>
                <select id="comparison-mode" class="toolbar-select-sm">
                    <option value="edited">Edited</option>
                    <option value="original">Original</option>
                    <option value="split">Split</option>
                </select>
                <button class="tool-btn-compact" id="save-as-original-btn" title="Save current state as Original">
                    <i class="fas fa-bookmark"></i>
                    <span class="toolbar-label">Save Original</span>
                </button>
                <button class="tool-btn-compact" id="versions-btn" title="Version History">
                    <i class="fas fa-history"></i>
                    <span class="toolbar-label">History</span>
                </button>

                <!-- Journal preset -->
                <label class="toolbar-label">Journal:</label>
                <select id="journal-preset-header" class="toolbar-select-sm">
                    <option value="">Custom</option>
                    {% for preset in journal_presets %}
                    <option value="{{ preset.id }}">{{ preset.name }} {{ preset.get_column_type_display }}</option>
                    {% endfor %}
                </select>

                <!-- Canvas size -->
                <div class="toolbar-info">
                    <i class="fas fa-ruler"></i>
                    <span id="canvas-size">89mm √ó 60mm</span>
                </div>
            </div>
        </div>

        <!-- Tips Section -->
        <div class="toolbar-section collapsed">
            <h3 class="toolbar-title collapsible-header">
                <span>Tips</span>
                <i class="fas fa-chevron-right collapse-icon"></i>
            </h3>
            <div class="toolbar-content">
                <div class="tips-list">
                    <div class="tip-item">
                        <div class="tip-title">
                            <i class="fas fa-mouse-pointer"></i>
                            <strong>Skewer Selection</strong>
                        </div>
                        <p class="tip-desc">Press <kbd>Alt</kbd> + <kbd>Click</kbd> on overlapping objects to choose which one to select. Drag to reorder layers!</p>
                    </div>
                    <div class="tip-item">
                        <div class="tip-title">
                            <i class="fas fa-copy"></i>
                            <strong>Quick Duplicate</strong>
                        </div>
                        <p class="tip-desc">Hold <kbd>Ctrl</kbd> while dragging to duplicate objects on the fly.</p>
                    </div>
                    <div class="tip-item">
                        <div class="tip-title">
                            <i class="fas fa-layer-group"></i>
                            <strong>Layer Order</strong>
                        </div>
                        <p class="tip-desc">New objects appear in front. Use <kbd>Ctrl</kbd> + <kbd>]</kbd> / <kbd>[</kbd> to bring forward/backward.</p>
                    </div>
                    <div class="tip-item">
                        <div class="tip-title">
                            <i class="fas fa-th"></i>
                            <strong>Snap to Grid</strong>
                        </div>
                        <p class="tip-desc">Enable "Snap" in VIEW section for precise alignment to grid points.</p>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Main Canvas Area -->
    <div class="vis-main">
        <div class="vis-header">
            <div class="vis-header-info">
                <!-- Mode Switcher -->
                <div class="view-switcher">
                    <button class="view-switch-btn active" data-mode="canvas">
                        <i class="fas fa-paint-brush"></i> Canvas
                    </button>
                    <button class="view-switch-btn" data-mode="backend">
                        <i class="fas fa-code"></i> Plot
                    </button>
                </div>

                <!-- Plot Type Wizard Buttons (SigmaPlot-style, shown in Plot mode) -->
                <div class="plot-type-buttons" id="plot-type-buttons" style="display: none;">
                    <div class="plot-type-group">
                        <button class="plot-type-btn" data-plot-type="line" title="Line Plot">
                            <i class="fas fa-chart-line"></i>
                            <span>Line</span>
                        </button>
                        <button class="plot-type-btn" data-plot-type="scatter" title="Scatter Plot">
                            <i class="fas fa-braille"></i>
                            <span>Scatter</span>
                        </button>
                        <button class="plot-type-btn" data-plot-type="bar" title="Bar Chart">
                            <i class="fas fa-chart-bar"></i>
                            <span>Bar</span>
                        </button>
                        <button class="plot-type-btn" data-plot-type="heatmap" title="Heatmap">
                            <i class="fas fa-th"></i>
                            <span>Heatmap</span>
                        </button>
                        <button class="plot-type-btn" data-plot-type="box" title="Box Plot">
                            <i class="fas fa-box"></i>
                            <span>Box</span>
                        </button>
                        <button class="plot-type-btn" data-plot-type="violin" title="Violin Plot">
                            <i class="fas fa-guitar"></i>
                            <span>Violin</span>
                        </button>
                        <button class="plot-type-btn" data-plot-type="histogram" title="Histogram">
                            <i class="fas fa-chart-area"></i>
                            <span>Histogram</span>
                        </button>
                        <button class="plot-type-btn" id="plot-gallery-toggle" title="Browse Plot Gallery">
                            <i class="fas fa-th-large"></i>
                            <span>Gallery</span>
                        </button>
                    </div>
                </div>

                <!-- Plot Gallery Dropdown (integrated into toolbar) -->
                <div class="plot-gallery-dropdown" id="plot-gallery-dropdown" style="display: none;">
                    <div class="gallery-dropdown-content">
                        <div class="gallery-tabs">
                            <button class="gallery-tab active" data-category="basic" title="Matplotlib Basic">Basic</button>
                            <button class="gallery-tab" data-category="custom" title="SciTeX Custom">Custom</button>
                            <button class="gallery-tab" data-category="seaborn" title="Seaborn Integration">Seaborn</button>
                            <button class="gallery-tab" data-category="multi" title="Multi-Panel">Multi</button>
                        </div>
                        <div class="gallery-thumbnails" id="gallery-thumbnails">
                            <!-- Thumbnails will be dynamically loaded here -->
                        </div>
                        <div class="gallery-info" id="gallery-info" style="display: none;">
                            <div class="gallery-info-header">
                                <h4 id="gallery-plot-name"></h4>
                                <button class="gallery-info-close" title="Close">&times;</button>
                            </div>
                            <p class="gallery-plot-desc" id="gallery-plot-desc"></p>
                            <div class="gallery-plot-details">
                                <div class="gallery-detail-section">
                                    <strong>Required:</strong>
                                    <span id="gallery-required-cols"></span>
                                </div>
                                <div class="gallery-detail-section">
                                    <strong>Optional:</strong>
                                    <span id="gallery-optional-cols"></span>
                                </div>
                            </div>
                            <button class="btn btn-sm btn-primary gallery-use-btn" id="gallery-use-btn">
                                <i class="fas fa-plus"></i> Add to Canvas
                            </button>
                        </div>
                    </div>
                </div>

                <div class="vis-header-controls" id="canvas-mode-controls">
                    <!-- Panel Controls -->
                    <div class="header-control-group">
                        <select id="panel-select" class="toolbar-select-sm">
                            <option value="" selected>Panels...</option>
                            <option value="split-horizontal">Split Horizontal</option>
                            <option value="split-vertical">Split Vertical</option>
                            <option value="remove-panel">Remove Panel</option>
                            <option value="reset-layout">Reset Layout</option>
                            <option value="2x2">2√ó2 Grid</option>
                            <option value="1x3">1√ó3 Stack</option>
                        </select>
                    </div>
                    <!-- Alignment & Distribution tools -->
                    <div class="header-control-group">
                        <select id="align-select" class="toolbar-select-sm">
                            <option value="" selected>Align...</option>
                            <optgroup label="Align">
                                <option value="left">‚¨ÖÔ∏è Left</option>
                                <option value="center">‚ÜîÔ∏è Center</option>
                                <option value="right">‚û°Ô∏è Right</option>
                                <option value="top">‚¨ÜÔ∏è Top</option>
                                <option value="middle">‚ÜïÔ∏è Middle</option>
                                <option value="bottom">‚¨áÔ∏è Bottom</option>
                            </optgroup>
                            <optgroup label="Distribute">
                                <option value="distribute-h">‚ÜîÔ∏è Horizontal</option>
                                <option value="distribute-v">‚ÜïÔ∏è Vertical</option>
                            </optgroup>
                        </select>
                    </div>
                    <!-- Zoom controls -->
                    <div class="header-control-group">
                        <span id="zoom-level" class="zoom-display" title="Zoom level (Ctrl+Scroll to zoom)">100%</span>
                        <button class="btn-icon" id="zoom-fit" title="Fit to Window (0)">
                            <i class="fas fa-compress-arrows-alt"></i>
                        </button>
                        <button class="btn-icon" id="shortcuts-btn" title="Keyboard Shortcuts (?)">
                            <i class="fas fa-keyboard"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="vis-header-actions">
                <button class="btn btn-secondary btn-sm" id="undo-btn" title="Undo (Ctrl+Z)" disabled>
                    <i class="fas fa-undo"></i>
                </button>
                <button class="btn btn-secondary btn-sm" id="redo-btn" title="Redo (Ctrl+Y)" disabled>
                    <i class="fas fa-redo"></i>
                </button>
                <button class="btn btn-secondary" id="save-btn" title="Auto-save enabled">
                    <i class="fas fa-save"></i>
                    Save
                </button>
                <button class="btn btn-primary btn-export" id="export-png" title="Export as PNG (300 DPI, white background)">
                    <i class="fas fa-download"></i>
                    PNG
                </button>
                <button class="btn btn-primary btn-export" id="export-tiff" title="Export as TIFF (300 DPI, publication quality)" style="background: var(--status-success);">
                    <i class="fas fa-download"></i>
                    TIFF
                </button>
            </div>
        </div>

        <div class="vis-canvas-wrapper" id="canvas-mode-content">
            <!-- Rulers -->
            <div class="vis-rulers-area">
                <div class="ruler-corner ruler-corner-tl"></div>
                <svg class="ruler ruler-horizontal ruler-top" id="ruler-horizontal"></svg>
                <div class="ruler-corner ruler-corner-tr"></div>
                <svg class="ruler ruler-vertical ruler-left" id="ruler-vertical"></svg>
                <div class="vis-canvas-container">
                    <canvas id="vis-canvas"></canvas>
                </div>
                <svg class="ruler ruler-vertical ruler-right" id="ruler-vertical-right"></svg>
                <div class="ruler-corner ruler-corner-bl"></div>
                <svg class="ruler ruler-horizontal ruler-bottom" id="ruler-horizontal-bottom"></svg>
                <div class="ruler-corner ruler-corner-br"></div>
            </div>
        </div>

        <!-- Backend Plot Renderer Mode -->
        <div class="backend-renderer-wrapper" id="backend-mode-content" style="display: none;">
            <!-- Tab Switcher - Full Width Dedicated Row -->
            <div style="padding: 0 20px;">
                <nav class="plot-data-tabs">
                    <button id="user-data-tab" class="data-tab-btn active" data-tab="user-data">
                        <i class="fas fa-upload"></i>
                        <span>From Your Data</span>
                    </button>
                    <button id="demo-gallery-tab" class="data-tab-btn" data-tab="demo-gallery">
                        <i class="fas fa-book"></i>
                        <span>From Demo Data</span>
                    </button>
                </nav>
            </div>

            <!-- Main Content Grid: Left Side + Right Side -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; flex: 1; min-height: 0; padding: 20px;">
                <!-- Left Side: Data Input + Data Table + Rendering Area -->
                <div style="display: flex; flex-direction: column; gap: 16px; overflow-y: auto; overflow-x: hidden;">

                    <!-- FROM YOUR DATA TAB -->
                    <div id="user-data-section" class="data-section" style="display: block;">
                        <!-- [TOP] Drag and Drop Area -->
                        <div id="upload-section" class="data-input-section" style="display: block; margin-bottom: 16px;">
                            <div id="plot-drop-area" class="plot-drop-area">
                                <input type="file" id="plot-data-file-input" accept=".csv,.xlsx,.xls" style="display: none;" multiple>
                                <div class="plot-drop-content">
                                    <div style="color: var(--text-secondary); font-size: 2.5rem; margin-bottom: 0.75rem;">üìä</div>
                                    <p style="color: var(--text-primary); font-weight: 600; margin-bottom: 0.5rem;">Drag and drop data files</p>
                                    <p style="color: var(--text-secondary); font-size: 0.9rem; margin: 0.5rem 0;">or click to browse files</p>
                                    <p style="color: var(--text-muted); font-size: 0.75rem; margin-top: 0.75rem;">
                                        CSV, Excel (.xlsx, .xls)
                                    </p>
                                </div>
                                <div id="plot-uploaded-files" class="plot-uploaded-files" style="display: none;">
                                    <!-- Uploaded files will be listed here -->
                                </div>
                            </div>
                        </div>

                        <!-- [SECOND TOP] Plot Data Table (Imported/Manual) -->
                        <div style="background: var(--bg-surface); border: 2px solid var(--border-color); border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <h4 style="margin: 0; font-size: 13px; font-weight: 600; color: var(--text-primary);">
                                    <i class="fas fa-table"></i> Plot Data Table
                                </h4>
                                <div style="display: flex; gap: 8px;">
                                    <button id="paste-data-btn" title="Paste from clipboard" style="padding: 4px 8px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-surface); color: var(--text-primary); cursor: pointer; font-size: 11px;">
                                        <i class="fas fa-clipboard"></i> Paste
                                    </button>
                                    <button id="clear-table-btn" title="Clear all data" style="padding: 4px 8px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-surface); color: var(--text-primary); cursor: pointer; font-size: 11px;">
                                        <i class="fas fa-eraser"></i> Clear
                                    </button>
                                </div>
                            </div>
                            <div id="data-table-container" style="width: 100%; height: 250px; overflow: auto; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-surface);"></div>
                            <input type="file" id="csv-file-input" accept=".csv,.txt" style="display: none;">
                        </div>

                        <!-- [THIRD TOP] Rendering Area -->
                        <div style="background: var(--bg-surface); border: 2px solid var(--border-color); border-radius: 8px; padding: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <h4 style="margin: 0; font-size: 13px; font-weight: 600; color: var(--text-primary);">
                                    <i class="fas fa-image"></i> Plot Preview
                                </h4>
                                <button id="backend-render-btn" style="padding: 6px 16px; background: var(--status-success); color: var(--text-inverse); border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer;">
                                    <i class="fas fa-play"></i> Render
                                </button>
                            </div>
                            <div id="backend-result-container" style="padding: 12px; background: var(--bg-muted); border-radius: 6px; display: flex; align-items: center; justify-content: center; min-height: 250px; max-height: 400px; overflow: auto; border: 1px solid var(--border-color);">
                                <p style="color: var(--text-muted); font-size: 12px;">Upload data and click Render to see preview</p>
                            </div>
                            <div id="backend-status" style="margin-top: 8px; min-height: 20px;"></div>
                        </div>
                    </div>
                    <!-- End FROM YOUR DATA TAB -->

                    <!-- FROM DEMO DATA TAB -->
                    <div id="demo-gallery-section" class="data-section" style="display: none;">
                        <!-- [TOP] Demo Gallery - Aligned with drag-and-drop area height -->
                        <div style="background: var(--bg-surface); border: 2px dashed var(--border-color); border-radius: 8px; padding: 1.5rem; margin-bottom: 16px; display: flex; flex-direction: column; min-height: 200px;">
                            <h4 style="margin: 0 0 16px 0; color: var(--text-primary); font-size: 13px; font-weight: 600;">
                                <i class="fas fa-images"></i> Select a Demo Plot
                            </h4>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; flex: 1; overflow-y: auto; padding: 4px; align-content: start;">
                            <!-- Line Plot -->
                            <div class="demo-gallery-item" data-demo="01_matplotlib_basic/01_plot" style="background: var(--bg-surface); border: 1px solid var(--border-color); border-radius: 6px; padding: 8px; cursor: pointer; transition: all 0.2s; position: relative;">
                                <div style="aspect-ratio: 4/3; background: var(--bg-muted); border-radius: 4px; overflow: hidden; margin-bottom: 6px;">
                                    <img src="{% static 'vis_app/img/plot_gallery/01_matplotlib_basic/01_plot.jpg' %}" alt="Line Plot" style="width: 100%; height: 100%; object-fit: cover;">
                                </div>
                                <p style="margin: 0; font-size: 10px; font-weight: 600; color: var(--text-primary); text-align: center;">Line</p>
                            </div>

                            <!-- Scatter Plot -->
                            <div class="demo-gallery-item" data-demo="01_matplotlib_basic/02_scatter" style="background: var(--bg-surface); border: 1px solid var(--border-color); border-radius: 6px; padding: 8px; cursor: pointer; transition: all 0.2s;">
                                <div style="aspect-ratio: 4/3; background: var(--bg-muted); border-radius: 4px; overflow: hidden; margin-bottom: 6px;">
                                    <img src="{% static 'vis_app/img/plot_gallery/01_matplotlib_basic/02_scatter.jpg' %}" alt="Scatter" style="width: 100%; height: 100%; object-fit: cover;">
                                </div>
                                <p style="margin: 0; font-size: 10px; font-weight: 600; color: var(--text-primary); text-align: center;">Scatter</p>
                            </div>

                            <!-- Bar Plot -->
                            <div class="demo-gallery-item" data-demo="01_matplotlib_basic/03_bar" style="background: var(--bg-surface); border: 1px solid var(--border-color); border-radius: 6px; padding: 8px; cursor: pointer; transition: all 0.2s;">
                                <div style="aspect-ratio: 4/3; background: var(--bg-muted); border-radius: 4px; overflow: hidden; margin-bottom: 6px;">
                                    <img src="{% static 'vis_app/img/plot_gallery/01_matplotlib_basic/03_bar.jpg' %}" alt="Bar" style="width: 100%; height: 100%; object-fit: cover;">
                                </div>
                                <p style="margin: 0; font-size: 10px; font-weight: 600; color: var(--text-primary); text-align: center;">Bar</p>
                            </div>

                            <!-- Errorbar Plot -->
                            <div class="demo-gallery-item" data-demo="01_matplotlib_basic/06_errorbar" style="background: var(--bg-surface); border: 1px solid var(--border-color); border-radius: 6px; padding: 8px; cursor: pointer; transition: all 0.2s;">
                                <div style="aspect-ratio: 4/3; background: var(--bg-muted); border-radius: 4px; overflow: hidden; margin-bottom: 6px;">
                                    <img src="{% static 'vis_app/img/plot_gallery/01_matplotlib_basic/06_errorbar.jpg' %}" alt="Errorbar" style="width: 100%; height: 100%; object-fit: cover;">
                                </div>
                                <p style="margin: 0; font-size: 10px; font-weight: 600; color: var(--text-primary); text-align: center;">Errorbar</p>
                            </div>

                            <!-- Heatmap -->
                            <div class="demo-gallery-item" data-demo="02_custom_scitex/01_plot_heatmap" style="background: var(--bg-surface); border: 1px solid var(--border-color); border-radius: 6px; padding: 8px; cursor: pointer; transition: all 0.2s;">
                                <div style="aspect-ratio: 4/3; background: var(--bg-muted); border-radius: 4px; overflow: hidden; margin-bottom: 6px;">
                                    <img src="{% static 'vis_app/img/plot_gallery/02_custom_scitex/01_plot_heatmap.jpg' %}" alt="Heatmap" style="width: 100%; height: 100%; object-fit: cover;">
                                </div>
                                <p style="margin: 0; font-size: 10px; font-weight: 600; color: var(--text-primary); text-align: center;">Heatmap</p>
                            </div>

                            <!-- Violin Plot -->
                            <div class="demo-gallery-item" data-demo="02_custom_scitex/04_plot_violin" style="background: var(--bg-surface); border: 1px solid var(--border-color); border-radius: 6px; padding: 8px; cursor: pointer; transition: all 0.2s;">
                                <div style="aspect-ratio: 4/3; background: var(--bg-muted); border-radius: 4px; overflow: hidden; margin-bottom: 6px;">
                                    <img src="{% static 'vis_app/img/plot_gallery/02_custom_scitex/04_plot_violin.jpg' %}" alt="Violin" style="width: 100%; height: 100%; object-fit: cover;">
                                </div>
                                <p style="margin: 0; font-size: 10px; font-weight: 600; color: var(--text-primary); text-align: center;">Violin</p>
                            </div>
                            </div>
                        </div>

                        <!-- [SECOND TOP] Plot Data Table (From Demo Data) -->
                        <div style="background: var(--bg-surface); border: 2px solid var(--border-color); border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                            <h4 style="margin: 0 0 12px 0; color: var(--text-primary); font-size: 13px; font-weight: 600;">
                                <i class="fas fa-database"></i> Demo Data Table
                            </h4>
                            <div id="demo-data-table-container" style="width: 100%; max-height: 250px; overflow: auto; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-surface);">
                                <p style="padding: 30px 20px; text-align: center; color: var(--text-muted); font-size: 11px;">
                                    Select a demo from the gallery above to view data
                                </p>
                            </div>
                        </div>

                        <!-- [THIRD TOP] Rendering Area -->
                        <div style="background: var(--bg-surface); border: 2px solid var(--border-color); border-radius: 8px; padding: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <h4 style="margin: 0; font-size: 13px; font-weight: 600; color: var(--text-primary);">
                                    <i class="fas fa-image"></i> Plot Preview
                                </h4>
                                <button id="demo-render-btn" style="padding: 6px 16px; background: var(--status-success); color: var(--text-inverse); border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer;">
                                    <i class="fas fa-play"></i> Render
                                </button>
                            </div>
                            <div id="demo-result-container" style="padding: 12px; background: var(--bg-muted); border-radius: 6px; display: flex; align-items: center; justify-content: center; min-height: 250px; max-height: 400px; overflow: auto; border: 1px solid var(--border-color);">
                                <p style="color: var(--text-tertiary); font-size: 12px;">Select a demo and click Render to see preview</p>
                            </div>
                            <div id="demo-status" style="margin-top: 8px; min-height: 20px;"></div>
                        </div>
                    </div>
                    <!-- End FROM DEMO DATA TAB -->

                    <!-- Hidden JSON textarea for compatibility -->
                    <textarea id="backend-json-spec" style="display: none;"></textarea>
                </div>
                <!-- End Left Side -->

                <!-- Right Side: Plot Settings + Visual Style Editor -->
                <div style="display: flex; flex-direction: column; overflow-y: auto; overflow-x: hidden; gap: 16px;">
                    <!-- Plot Settings -->
                    <div style="background: var(--bg-surface); border: 2px solid var(--border-color); border-radius: 8px; padding: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h4 style="margin: 0; font-size: 13px; font-weight: 600; color: var(--text-primary);">
                                <i class="fas fa-cog"></i> Plot Settings
                            </h4>
                            <button id="backend-show-json-btn" style="padding: 4px 12px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-surface); color: var(--text-primary); cursor: pointer; font-size: 11px;">
                                <i class="fas fa-code"></i> JSON
                            </button>
                        </div>
                        <div id="backend-form-controls" style="display: flex; flex-direction: column; gap: 16px;">
                            <!-- 1. Axis Settings -->
                            <div class="plot-settings-category">
                                <h5 style="margin: 0 0 8px 0; font-size: 12px; font-weight: 600; color: var(--status-success); display: flex; align-items: center; gap: 6px;">
                                    <i class="fas fa-arrows-alt"></i> Axis Settings
                                </h5>
                                <table class="backend-settings-table">
                                    <tr>
                                        <td class="setting-label">Title</td>
                                        <td class="setting-control" colspan="2">
                                            <input type="text" id="plot-title" value="Line Plot Example" class="form-control" style="width: 100%; padding: 6px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-surface); color: var(--text-primary);">
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="setting-label">X Label</td>
                                        <td class="setting-control" colspan="2">
                                            <input type="text" id="plot-xlabel" value="X axis" class="form-control" style="width: 100%; padding: 6px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-surface); color: var(--text-primary);">
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="setting-label">Y Label</td>
                                        <td class="setting-control" colspan="2">
                                            <input type="text" id="plot-ylabel" value="Y axis" class="form-control" style="width: 100%; padding: 6px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-surface); color: var(--text-primary);">
                                        </td>
                                    </tr>
                                </table>
                            </div>

                            <!-- 2. Element Settings -->
                            <div class="plot-settings-category">
                                <h5 style="margin: 0 0 8px 0; font-size: 12px; font-weight: 600; color: var(--status-success); display: flex; align-items: center; gap: 6px;">
                                    <i class="fas fa-shapes"></i> Element Settings
                                </h5>
                                <table class="backend-settings-table">
                                    <tr>
                                        <td class="setting-label">Plot Type</td>
                                        <td class="setting-control" colspan="2">
                                            <select id="plot-kind" style="width: 100%; padding: 6px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-surface); color: var(--text-primary);">
                                                <optgroup label="üìä Basic">
                                                    <option value="line">Line</option>
                                                    <option value="scatter">Scatter</option>
                                                    <option value="bar">Bar</option>
                                                </optgroup>
                                                <optgroup label="üìà Statistical">
                                                    <option value="boxplot">Box Plot</option>
                                                    <option value="violin">Violin</option>
                                                    <option value="hist">Histogram</option>
                                                </optgroup>
                                                <optgroup label="üìâ Error">
                                                    <option value="errorbar">Error Bar</option>
                                                </optgroup>
                                            </select>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="setting-label">Color</td>
                                        <td class="setting-control" colspan="2">
                                            <input type="text" id="plot-color" value="blue" class="form-control" style="width: 100%; padding: 6px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-surface); color: var(--text-primary);">
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                        <input type="file" id="csv-file-input" accept=".csv,.txt" style="display: none;">
                    </div>

                    <!-- Visual Style Editor -->
                    <div class="visual-style-editor">
                        <div style="background: linear-gradient(135deg, #6c8ba0 0%, #506b7a 100%); padding: 16px; border-radius: 8px 8px 0 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <h3 style="margin: 0; color: var(--text-inverse); font-size: 15px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-paint-brush"></i>
                                <span>Visual Style Editor</span>
                                <span style="margin-left: auto; font-size: 11px; opacity: 0.9; font-weight: 400;">Apply to Your Data</span>
                            </h3>
                        </div>

                        <!-- Style Management Toolbar -->
                        <div style="background: var(--bg-muted); border: 2px solid var(--vis-border); border-top: none; padding: 16px; display: flex; flex-direction: column; gap: 12px;">
                            <!-- Import/Export Section - Full Width -->
                            <div style="display: flex; gap: 12px; align-items: center;">
                                <button id="import-style-json-btn" style="padding: 8px 16px; background: var(--bg-surface); border: 2px solid var(--border-default); color: var(--text-primary); border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s;">
                                    <i class="fas fa-file-import"></i>
                                    <span>Import Style JSON</span>
                                </button>
                                <button id="export-style-json-btn" style="padding: 8px 16px; background: var(--bg-surface); border: 2px solid var(--border-default); color: var(--text-primary); border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s;">
                                    <i class="fas fa-file-export"></i>
                                    <span>Export Style JSON</span>
                                </button>
                            </div>

                            <!-- Presets Section - Next Line -->
                            <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                                <span style="font-size: 11px; color: var(--text-secondary); font-weight: 600;">Presets:</span>
                                <button class="preset-btn" data-preset="SCITEX_STYLE" style="padding: 6px 12px; background: var(--status-success); color: var(--text-inverse); border: none; border-radius: 4px; font-size: 11px; font-weight: 600; cursor: pointer;">SciTeX</button>
                                <button class="preset-btn" data-preset="NATURE_STYLE" style="padding: 6px 12px; background: var(--bg-surface); border: 1px solid var(--border-muted); color: var(--text-secondary); border-radius: 4px; font-size: 11px; font-weight: 600; cursor: pointer;">Nature</button>
                                <button class="preset-btn" data-preset="SCIENCE_STYLE" style="padding: 6px 12px; background: var(--bg-surface); border: 1px solid var(--border-muted); color: var(--text-secondary); border-radius: 4px; font-size: 11px; font-weight: 600; cursor: pointer;">Science</button>
                                <button class="preset-btn" data-preset="CELL_STYLE" style="padding: 6px 12px; background: var(--bg-surface); border: 1px solid var(--border-muted); color: var(--text-secondary); border-radius: 4px; font-size: 11px; font-weight: 600; cursor: pointer;">Cell</button>
                                <button class="preset-btn" data-preset="PNAS_STYLE" style="padding: 6px 12px; background: var(--bg-surface); border: 1px solid var(--border-muted); color: var(--text-secondary); border-radius: 4px; font-size: 11px; font-weight: 600; cursor: pointer;">PNAS</button>
                            </div>
                        </div>

                        <!-- Control Sections Container -->
                        <div style="background: var(--bg-muted); border: 2px solid var(--vis-border); border-top: none; border-radius: 0 0 8px 8px; padding: 20px;">
                            <!-- Organized Control Sections -->
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                                <!-- Dimensions Section -->
                                <div class="style-card" data-card="dimensions" style="background: var(--bg-surface); border-radius: 6px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                    <h4 class="style-card-header" data-toggle="dimensions" style="margin: 0 0 12px 0; color: var(--status-success); font-size: 12px; font-weight: 600; border-bottom: 2px solid var(--status-success); padding-bottom: 6px; display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
                                        <span><i class="fas fa-ruler-combined"></i> Dimensions</span>
                                        <i class="fas fa-chevron-right" style="transition: transform 0.2s; font-size: 10px;"></i>
                                    </h4>
                                    <div class="style-card-content" data-content="dimensions" style="display: none; margin-top: 12px;">
                                        <table class="backend-settings-table" style="width: 100%;">
                                            <tr>
                                                <td class="setting-label" style="font-size: 11px; color: var(--text-secondary); padding: 6px 0;">X-Axis Width</td>
                                                <td class="setting-control" style="padding: 6px 0;">
                                                    <input type="number" id="fig-width-inline" min="10" max="200" value="35" step="1" data-default="35"
                                                           style="width: 100%; padding: 6px 8px; border: 1px solid var(--border-muted); border-radius: 4px; font-size: 11px; background: var(--bg-surface); color: var(--text-primary);">
                                                </td>
                                                <td class="setting-value" style="padding: 6px 0 6px 8px; font-size: 11px; color: var(--text-muted); white-space: nowrap;">
                                                    mm
                                                    <button class="setting-reset-btn" data-target="fig-width-inline" title="Reset" style="margin-left: 4px; padding: 4px 8px; font-size: 10px;">
                                                        <i class="fas fa-undo"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td class="setting-label" style="font-size: 11px; color: var(--text-secondary); padding: 6px 0;">Y-Axis Height</td>
                                                <td class="setting-control" style="padding: 6px 0;">
                                                    <input type="number" id="fig-height-inline" min="10" max="200" value="24.5" step="0.5" data-default="24.5"
                                                           style="width: 100%; padding: 6px 8px; border: 1px solid var(--border-muted); border-radius: 4px; font-size: 11px; background: var(--bg-surface); color: var(--text-primary);">
                                                </td>
                                                <td class="setting-value" style="padding: 6px 0 6px 8px; font-size: 11px; color: var(--text-muted); white-space: nowrap;">
                                                    mm
                                                    <button class="setting-reset-btn" data-target="fig-height-inline" title="Reset" style="margin-left: 4px; padding: 4px 8px; font-size: 10px;">
                                                        <i class="fas fa-undo"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>

                                <!-- Typography Section -->
                                <div class="style-card" data-card="typography" style="background: var(--bg-surface); border-radius: 6px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                    <h4 class="style-card-header" data-toggle="[^"]*" style="margin: 0 0 12px 0; color: var(--status-success); font-size: 12px; font-weight: 600; border-bottom: 2px solid var(--status-success); padding-bottom: 6px; display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
                                        <span><i class="fas fa-font"></i> Typography</span>
                                        <i class="fas fa-chevron-right" style="transition: transform 0.2s; font-size: 10px;"></i>
                                    </h4>
                                    <div class="style-card-content" data-content="typography" style="display: none; margin-top: 12px;">
                                        <table class="backend-settings-table" style="width: 100%;">
                                            <tr>
                                                <td class="setting-label" style="font-size: 11px; color: var(--text-secondary); padding: 6px 0;">Title Font</td>
                                                <td class="setting-control" style="padding: 6px 0;">
                                                    <input type="number" id="style-title-font-main" min="4" max="16" value="8" step="1" data-default="8"
                                                           style="width: 100%; padding: 6px 8px; border: 1px solid var(--border-muted); border-radius: 4px; font-size: 11px; background: var(--bg-surface); color: var(--text-primary);">
                                                </td>
                                                <td class="setting-value" style="padding: 6px 0 6px 8px; font-size: 11px; color: var(--text-muted); white-space: nowrap;">
                                                    pt
                                                    <button class="setting-reset-btn" data-target="style-title-font-main" title="Reset" style="margin-left: 4px; padding: 4px 8px; font-size: 10px;">
                                                        <i class="fas fa-undo"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td class="setting-label" style="font-size: 11px; color: var(--text-secondary); padding: 6px 0;">Axis Font</td>
                                                <td class="setting-control" style="padding: 6px 0;">
                                                    <input type="number" id="style-axis-font-main" min="4" max="16" value="8" step="1" data-default="8"
                                                           style="width: 100%; padding: 6px 8px; border: 1px solid var(--border-muted); border-radius: 4px; font-size: 11px; background: var(--bg-surface); color: var(--text-primary);">
                                                </td>
                                                <td class="setting-value" style="padding: 6px 0 6px 8px; font-size: 11px; color: var(--text-muted); white-space: nowrap;">
                                                    pt
                                                    <button class="setting-reset-btn" data-target="style-axis-font-main" title="Reset" style="margin-left: 4px; padding: 4px 8px; font-size: 10px;">
                                                        <i class="fas fa-undo"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td class="setting-label" style="font-size: 11px; color: var(--text-secondary); padding: 6px 0;">Tick Font</td>
                                                <td class="setting-control" style="padding: 6px 0;">
                                                    <input type="number" id="style-tick-font-main" min="4" max="16" value="7" step="1" data-default="7"
                                                           style="width: 100%; padding: 6px 8px; border: 1px solid var(--border-muted); border-radius: 4px; font-size: 11px; background: var(--bg-surface); color: var(--text-primary);">
                                                </td>
                                                <td class="setting-value" style="padding: 6px 0 6px 8px; font-size: 11px; color: var(--text-muted); white-space: nowrap;">
                                                    pt
                                                    <button class="setting-reset-btn" data-target="style-tick-font-main" title="Reset" style="margin-left: 4px; padding: 4px 8px; font-size: 10px;">
                                                        <i class="fas fa-undo"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>

                                <!-- Line Properties Section -->
                                <div class="style-card" data-card="line-properties" style="background: var(--bg-surface); border-radius: 6px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                    <h4 class="style-card-header" data-toggle="[^"]*" style="margin: 0 0 12px 0; color: var(--status-success); font-size: 12px; font-weight: 600; border-bottom: 2px solid var(--status-success); padding-bottom: 6px; display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
                                        <span><i class="fas fa-grip-lines"></i> Line Properties</span>
                                        <i class="fas fa-chevron-right" style="transition: transform 0.2s; font-size: 10px;"></i>
                                    </h4>
                                    <div class="style-card-content" data-content="line-properties" style="display: none; margin-top: 12px;">
                                        <table class="backend-settings-table" style="width: 100%;">
                                            <tr>
                                                <td class="setting-label" style="font-size: 11px; color: var(--text-secondary); padding: 6px 0;">Line Thickness</td>
                                                <td class="setting-control" style="padding: 6px 0;">
                                                    <input type="number" id="style-trace-thickness-main" min="0.05" max="1" value="0.12" step="0.01" data-default="0.12"
                                                           style="width: 100%; padding: 6px 8px; border: 1px solid var(--border-muted); border-radius: 4px; font-size: 11px; background: var(--bg-surface); color: var(--text-primary);">
                                                </td>
                                                <td class="setting-value" style="padding: 6px 0 6px 8px; font-size: 11px; color: var(--text-muted); white-space: nowrap;">
                                                    mm
                                                    <button class="setting-reset-btn" data-target="style-trace-thickness-main" title="Reset" style="margin-left: 4px; padding: 4px 8px; font-size: 10px;">
                                                        <i class="fas fa-undo"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td class="setting-label" style="font-size: 11px; color: var(--text-secondary); padding: 6px 0;">Axis Thickness</td>
                                                <td class="setting-control" style="padding: 6px 0;">
                                                    <input type="number" id="style-axis-thickness-main" min="0.05" max="1" value="0.2" step="0.05" data-default="0.2"
                                                           style="width: 100%; padding: 6px 8px; border: 1px solid var(--border-muted); border-radius: 4px; font-size: 11px; background: var(--bg-surface); color: var(--text-primary);">
                                                </td>
                                                <td class="setting-value" style="padding: 6px 0 6px 8px; font-size: 11px; color: var(--text-muted); white-space: nowrap;">
                                                    mm
                                                    <button class="setting-reset-btn" data-target="style-axis-thickness-main" title="Reset" style="margin-left: 4px; padding: 4px 8px; font-size: 10px;">
                                                        <i class="fas fa-undo"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td class="setting-label" style="font-size: 11px; color: var(--text-secondary); padding: 6px 0;">Tick Length</td>
                                                <td class="setting-control" style="padding: 6px 0;">
                                                    <input type="number" id="style-tick-length-main" min="0.1" max="3" value="0.8" step="0.1" data-default="0.8"
                                                           style="width: 100%; padding: 6px 8px; border: 1px solid var(--border-muted); border-radius: 4px; font-size: 11px; background: var(--bg-surface); color: var(--text-primary);">
                                                </td>
                                                <td class="setting-value" style="padding: 6px 0 6px 8px; font-size: 11px; color: var(--text-muted); white-space: nowrap;">
                                                    mm
                                                    <button class="setting-reset-btn" data-target="style-tick-length-main" title="Reset" style="margin-left: 4px; padding: 4px 8px; font-size: 10px;">
                                                        <i class="fas fa-undo"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td class="setting-label" style="font-size: 11px; color: var(--text-secondary); padding: 6px 0;">Tick Thickness</td>
                                                <td class="setting-control" style="padding: 6px 0;">
                                                    <input type="number" id="style-tick-thickness-main" min="0.05" max="1" value="0.2" step="0.05" data-default="0.2"
                                                           style="width: 100%; padding: 6px 8px; border: 1px solid var(--border-muted); border-radius: 4px; font-size: 11px; background: var(--bg-surface); color: var(--text-primary);">
                                                </td>
                                                <td class="setting-value" style="padding: 6px 0 6px 8px; font-size: 11px; color: var(--text-muted); white-space: nowrap;">
                                                    mm
                                                    <button class="setting-reset-btn" data-target="style-tick-thickness-main" title="Reset" style="margin-left: 4px; padding: 4px 8px; font-size: 10px;">
                                                        <i class="fas fa-undo"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>

                                <!-- Additional Fonts Section -->
                                <div class="style-card" data-card="additional-fonts" style="background: var(--bg-surface); border-radius: 6px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                    <h4 class="style-card-header" data-toggle="[^"]*" style="margin: 0 0 12px 0; color: var(--status-success); font-size: 12px; font-weight: 600; border-bottom: 2px solid var(--status-success); padding-bottom: 6px; display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
                                        <span><i class="fas fa-text-height"></i> Additional Fonts</span>
                                        <i class="fas fa-chevron-right" style="transition: transform 0.2s; font-size: 10px;"></i>
                                    </h4>
                                    <div class="style-card-content" data-content="additional-fonts" style="display: none; margin-top: 12px;">
                                        <table class="backend-settings-table" style="width: 100%;">
                                            <tr>
                                                <td class="setting-label" style="font-size: 11px; color: var(--text-secondary); padding: 6px 0;">Suptitle Font</td>
                                                <td class="setting-control" style="padding: 6px 0;">
                                                    <input type="number" id="style-suptitle-font-main" min="4" max="16" value="8" step="1" data-default="8"
                                                           style="width: 100%; padding: 6px 8px; border: 1px solid var(--border-muted); border-radius: 4px; font-size: 11px; background: var(--bg-surface); color: var(--text-primary);">
                                                </td>
                                                <td class="setting-value" style="padding: 6px 0 6px 8px; font-size: 11px; color: var(--text-muted); white-space: nowrap;">
                                                    pt
                                                    <button class="setting-reset-btn" data-target="style-suptitle-font-main" title="Reset" style="margin-left: 4px; padding: 4px 8px; font-size: 10px;">
                                                        <i class="fas fa-undo"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td class="setting-label" style="font-size: 11px; color: var(--text-secondary); padding: 6px 0;">Legend Font</td>
                                                <td class="setting-control" style="padding: 6px 0;">
                                                    <input type="number" id="style-legend-font-main" min="4" max="16" value="6" step="1" data-default="6"
                                                           style="width: 100%; padding: 6px 8px; border: 1px solid var(--border-muted); border-radius: 4px; font-size: 11px; background: var(--bg-surface); color: var(--text-primary);">
                                                </td>
                                                <td class="setting-value" style="padding: 6px 0 6px 8px; font-size: 11px; color: var(--text-muted); white-space: nowrap;">
                                                    pt
                                                    <button class="setting-reset-btn" data-target="style-legend-font-main" title="Reset" style="margin-left: 4px; padding: 4px 8px; font-size: 10px;">
                                                        <i class="fas fa-undo"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>

                                <!-- Plot Elements Section -->
                                <div class="style-card" data-card="plot-elements" style="background: var(--bg-surface); border-radius: 6px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                    <h4 class="style-card-header" data-toggle="[^"]*" style="margin: 0 0 12px 0; color: var(--status-success); font-size: 12px; font-weight: 600; border-bottom: 2px solid var(--status-success); padding-bottom: 6px; display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
                                        <span><i class="fas fa-chart-bar"></i> Plot Elements</span>
                                        <i class="fas fa-chevron-right" style="transition: transform 0.2s; font-size: 10px;"></i>
                                    </h4>
                                    <div class="style-card-content" data-content="plot-elements" style="display: none; margin-top: 12px;">
                                        <table class="backend-settings-table" style="width: 100%;">
                                        <tr>
                                            <td class="setting-label" style="font-size: 11px; color: var(--text-secondary); padding: 6px 0;">Error Bar Thickness</td>
                                            <td class="setting-control" style="padding: 6px 0;">
                                                <input type="number" id="style-errorbar-thickness-main" min="0.05" max="1" value="0.2" step="0.05" data-default="0.2"
                                                       style="width: 100%; padding: 6px 8px; border: 1px solid var(--border-muted); border-radius: 4px; font-size: 11px; background: var(--bg-surface); color: var(--text-primary);">
                                            </td>
                                            <td class="setting-value" style="padding: 6px 0 6px 8px; font-size: 11px; color: var(--text-muted); white-space: nowrap;">
                                                mm
                                                <button class="setting-reset-btn" data-target="style-errorbar-thickness-main" title="Reset" style="margin-left: 4px; padding: 4px 8px; font-size: 10px;">
                                                    <i class="fas fa-undo"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="setting-label" style="font-size: 11px; color: var(--text-secondary); padding: 6px 0;">Error Bar Cap</td>
                                            <td class="setting-control" style="padding: 6px 0;">
                                                <input type="number" id="style-errorbar-cap-main" min="0.1" max="3" value="0.8" step="0.1" data-default="0.8"
                                                       style="width: 100%; padding: 6px 8px; border: 1px solid var(--border-muted); border-radius: 4px; font-size: 11px; background: var(--bg-surface); color: var(--text-primary);">
                                            </td>
                                            <td class="setting-value" style="padding: 6px 0 6px 8px; font-size: 11px; color: var(--text-muted); white-space: nowrap;">
                                                mm
                                                <button class="setting-reset-btn" data-target="style-errorbar-cap-main" title="Reset" style="margin-left: 4px; padding: 4px 8px; font-size: 10px;">
                                                    <i class="fas fa-undo"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="setting-label" style="font-size: 11px; color: var(--text-secondary); padding: 6px 0;">Bar Edge Thickness</td>
                                            <td class="setting-control" style="padding: 6px 0;">
                                                <input type="number" id="style-bar-edge-thickness-main" min="0.05" max="1" value="0.2" step="0.05" data-default="0.2"
                                                       style="width: 100%; padding: 6px 8px; border: 1px solid var(--border-muted); border-radius: 4px; font-size: 11px; background: var(--bg-surface); color: var(--text-primary);">
                                            </td>
                                            <td class="setting-value" style="padding: 6px 0 6px 8px; font-size: 11px; color: var(--text-muted); white-space: nowrap;">
                                                mm
                                                <button class="setting-reset-btn" data-target="style-bar-edge-thickness-main" title="Reset" style="margin-left: 4px; padding: 4px 8px; font-size: 10px;">
                                                    <i class="fas fa-undo"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="setting-label" style="font-size: 11px; color: var(--text-secondary); padding: 6px 0;">KDE Line Thickness</td>
                                            <td class="setting-control" style="padding: 6px 0;">
                                                <input type="number" id="style-kde-thickness-main" min="0.05" max="1" value="0.2" step="0.05" data-default="0.2"
                                                       style="width: 100%; padding: 6px 8px; border: 1px solid var(--border-muted); border-radius: 4px; font-size: 11px; background: var(--bg-surface); color: var(--text-primary);">
                                            </td>
                                            <td class="setting-value" style="padding: 6px 0 6px 8px; font-size: 11px; color: var(--text-muted); white-space: nowrap;">
                                                mm
                                                <button class="setting-reset-btn" data-target="style-kde-thickness-main" title="Reset" style="margin-left: 4px; padding: 4px 8px; font-size: 10px;">
                                                    <i class="fas fa-undo"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="setting-label" style="font-size: 11px; color: var(--text-secondary); padding: 6px 0;">Scatter Size</td>
                                            <td class="setting-control" style="padding: 6px 0;">
                                                <input type="number" id="style-scatter-size-main" min="0.1" max="5" value="0.8" step="0.1" data-default="0.8"
                                                       style="width: 100%; padding: 6px 8px; border: 1px solid var(--border-muted); border-radius: 4px; font-size: 11px; background: var(--bg-surface); color: var(--text-primary);">
                                            </td>
                                            <td class="setting-value" style="padding: 6px 0 6px 8px; font-size: 11px; color: var(--text-muted); white-space: nowrap;">
                                                mm
                                                <button class="setting-reset-btn" data-target="style-scatter-size-main" title="Reset" style="margin-left: 4px; padding: 4px 8px; font-size: 10px;">
                                                    <i class="fas fa-undo"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    </table>
                                    </div>
                                </div>

                                <!-- Spacing Section -->
                                <div class="style-card" data-card="spacing" style="background: var(--bg-surface); border-radius: 6px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); grid-column: span 2;">
                                    <h4 class="style-card-header" data-toggle="[^"]*" style="margin: 0 0 12px 0; color: var(--status-success); font-size: 12px; font-weight: 600; border-bottom: 2px solid var(--status-success); padding-bottom: 6px; display: flex; justify-content: space-between; cursor: pointer;">
                                        <span><i class="fas fa-expand-arrows-alt"></i> Spacing</span>
                                        <i class="fas fa-chevron-right" style="transition: transform 0.2s; font-size: 10px;"></i>
                                    </h4>
                                    <div class="style-card-content" data-content="spacing" style="display: none; margin-top: 12px;">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                        <!-- Padding Controls -->
                                        <div>
                                            <h5 style="margin: 0 0 8px 0; color: var(--text-secondary); font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Padding (pt)</h5>
                                            <table class="backend-settings-table" style="width: 100%;">
                                                <tr>
                                                    <td class="setting-label" style="font-size: 11px; color: var(--text-secondary); padding: 6px 0;">Title</td>
                                                    <td class="setting-control" style="padding: 6px 0;">
                                                        <input type="number" id="style-title-pad-main" min="0" max="10" value="1" step="0.5" data-default="1"
                                                               style="width: 100%; padding: 6px 8px; border: 1px solid var(--border-muted); border-radius: 4px; font-size: 11px; background: var(--bg-surface); color: var(--text-primary);">
                                                    </td>
                                                    <td class="setting-value" style="padding: 6px 0 6px 8px; white-space: nowrap;">
                                                        <button class="setting-reset-btn" data-target="style-title-pad-main" title="Reset" style="padding: 4px 8px; font-size: 10px;">
                                                            <i class="fas fa-undo"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td class="setting-label" style="font-size: 11px; color: var(--text-secondary); padding: 6px 0;">Label</td>
                                                    <td class="setting-control" style="padding: 6px 0;">
                                                        <input type="number" id="style-label-pad-main" min="0" max="10" value="0.5" step="0.5" data-default="0.5"
                                                               style="width: 100%; padding: 6px 8px; border: 1px solid var(--border-muted); border-radius: 4px; font-size: 11px; background: var(--bg-surface); color: var(--text-primary);">
                                                    </td>
                                                    <td class="setting-value" style="padding: 6px 0 6px 8px; white-space: nowrap;">
                                                        <button class="setting-reset-btn" data-target="style-label-pad-main" title="Reset" style="padding: 4px 8px; font-size: 10px;">
                                                            <i class="fas fa-undo"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td class="setting-label" style="font-size: 11px; color: var(--text-secondary); padding: 6px 0;">Tick</td>
                                                    <td class="setting-control" style="padding: 6px 0;">
                                                        <input type="number" id="style-tick-pad-main" min="0" max="10" value="2" step="0.5" data-default="2"
                                                               style="width: 100%; padding: 6px 8px; border: 1px solid var(--border-muted); border-radius: 4px; font-size: 11px; background: var(--bg-surface); color: var(--text-primary);">
                                                    </td>
                                                    <td class="setting-value" style="padding: 6px 0 6px 8px; white-space: nowrap;">
                                                        <button class="setting-reset-btn" data-target="style-tick-pad-main" title="Reset" style="padding: 4px 8px; font-size: 10px;">
                                                            <i class="fas fa-undo"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            </table>
                                        </div>

                                        <!-- Margin Controls -->
                                        <div>
                                            <h5 style="margin: 0 0 8px 0; color: var(--text-secondary); font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Margins (mm)</h5>
                                            <table class="backend-settings-table" style="width: 100%;">
                                                <tr>
                                                    <td class="setting-label" style="font-size: 11px; color: var(--text-secondary); padding: 6px 0;">Left</td>
                                                    <td class="setting-control" style="padding: 6px 0;">
                                                        <input type="number" id="margin-left-main" min="0" max="100" value="20" step="1" data-default="20"
                                                               style="width: 100%; padding: 6px 8px; border: 1px solid var(--border-muted); border-radius: 4px; font-size: 11px; background: var(--bg-surface); color: var(--text-primary);">
                                                    </td>
                                                    <td class="setting-value" style="padding: 6px 0 6px 8px; white-space: nowrap;">
                                                        <button class="setting-reset-btn" data-target="margin-left-main" title="Reset" style="padding: 4px 8px; font-size: 10px;">
                                                            <i class="fas fa-undo"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td class="setting-label" style="font-size: 11px; color: var(--text-secondary); padding: 6px 0;">Right</td>
                                                    <td class="setting-control" style="padding: 6px 0;">
                                                        <input type="number" id="margin-right-main" min="0" max="100" value="20" step="1" data-default="20"
                                                               style="width: 100%; padding: 6px 8px; border: 1px solid var(--border-muted); border-radius: 4px; font-size: 11px; background: var(--bg-surface); color: var(--text-primary);">
                                                    </td>
                                                    <td class="setting-value" style="padding: 6px 0 6px 8px; white-space: nowrap;">
                                                        <button class="setting-reset-btn" data-target="margin-right-main" title="Reset" style="padding: 4px 8px; font-size: 10px;">
                                                            <i class="fas fa-undo"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td class="setting-label" style="font-size: 11px; color: var(--text-secondary); padding: 6px 0;">Top</td>
                                                    <td class="setting-control" style="padding: 6px 0;">
                                                        <input type="number" id="margin-top-main" min="0" max="100" value="20" step="1" data-default="20"
                                                               style="width: 100%; padding: 6px 8px; border: 1px solid var(--border-muted); border-radius: 4px; font-size: 11px; background: var(--bg-surface); color: var(--text-primary);">
                                                    </td>
                                                    <td class="setting-value" style="padding: 6px 0 6px 8px; white-space: nowrap;">
                                                        <button class="setting-reset-btn" data-target="margin-top-main" title="Reset" style="padding: 4px 8px; font-size: 10px;">
                                                            <i class="fas fa-undo"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td class="setting-label" style="font-size: 11px; color: var(--text-secondary); padding: 6px 0;">Bottom</td>
                                                    <td class="setting-control" style="padding: 6px 0;">
                                                        <input type="number" id="margin-bottom-main" min="0" max="100" value="20" step="1" data-default="20"
                                                               style="width: 100%; padding: 6px 8px; border: 1px solid var(--border-muted); border-radius: 4px; font-size: 11px; background: var(--bg-surface); color: var(--text-primary);">
                                                    </td>
                                                    <td class="setting-value" style="padding: 6px 0 6px 8px; white-space: nowrap;">
                                                        <button class="setting-reset-btn" data-target="margin-bottom-main" title="Reset" style="padding: 4px 8px; font-size: 10px;">
                                                            <i class="fas fa-undo"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            </table>
                                        </div>

                                        <!-- Multi-Panel Spacing -->
                                        <div>
                                            <h5 style="margin: 16px 0 8px 0; color: var(--text-secondary); font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Multi-Panel (mm)</h5>
                                            <table class="backend-settings-table" style="width: 100%;">
                                                <tr>
                                                    <td class="setting-label" style="font-size: 11px; color: var(--text-secondary); padding: 6px 0;">Horizontal Space</td>
                                                    <td class="setting-control" style="padding: 6px 0;">
                                                        <input type="number" id="space-w-main" min="0" max="50" value="8" step="1" data-default="8"
                                                               style="width: 100%; padding: 6px 8px; border: 1px solid var(--border-muted); border-radius: 4px; font-size: 11px; background: var(--bg-surface); color: var(--text-primary);">
                                                    </td>
                                                    <td class="setting-value" style="padding: 6px 0 6px 8px; white-space: nowrap;">
                                                        <button class="setting-reset-btn" data-target="space-w-main" title="Reset" style="padding: 4px 8px; font-size: 10px;">
                                                            <i class="fas fa-undo"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td class="setting-label" style="font-size: 11px; color: var(--text-secondary); padding: 6px 0;">Vertical Space</td>
                                                    <td class="setting-control" style="padding: 6px 0;">
                                                        <input type="number" id="space-h-main" min="0" max="50" value="10" step="1" data-default="10"
                                                               style="width: 100%; padding: 6px 8px; border: 1px solid var(--border-muted); border-radius: 4px; font-size: 11px; background: var(--bg-surface); color: var(--text-primary);">
                                                    </td>
                                                    <td class="setting-value" style="padding: 6px 0 6px 8px; white-space: nowrap;">
                                                        <button class="setting-reset-btn" data-target="space-h-main" title="Reset" style="padding: 4px 8px; font-size: 10px;">
                                                            <i class="fas fa-undo"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            </table>
                                        </div>
                                    </div>
                                    </div>
                                </div>

                                <!-- Advanced Settings Section -->
                                <div class="style-card" data-card="advanced-settings" style="background: var(--bg-surface); border-radius: 6px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); grid-column: span 2;">
                                    <h4 class="style-card-header" data-toggle="[^"]*" style="margin: 0 0 12px 0; color: var(--status-success); font-size: 12px; font-weight: 600; border-bottom: 2px solid var(--status-success); padding-bottom: 6px; display: flex; justify-content: space-between; align-items: center; cursor: pointer;">
                                        <span><i class="fas fa-cog"></i> Advanced Settings</span>
                                        <i class="fas fa-chevron-right" style="transition: transform 0.2s; font-size: 10px;"></i>
                                    </h4>
                                    <div class="style-card-content" data-content="advanced-settings" style="display: none; margin-top: 12px;">
                                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px;">
                                        <!-- N Ticks -->
                                        <div>
                                            <label style="display: block; font-size: 11px; color: var(--text-secondary); font-weight: 600; margin-bottom: 6px;">Target Ticks</label>
                                            <div style="display: flex; gap: 4px; align-items: center;">
                                                <input type="number" id="n-ticks-main" min="2" max="10" value="4" step="1" data-default="4"
                                                       style="width: 100%; padding: 6px 8px; border: 1px solid var(--border-muted); border-radius: 4px; font-size: 11px; background: var(--bg-surface); color: var(--text-primary);">
                                                <button class="setting-reset-btn" data-target="n-ticks-main" title="Reset" style="padding: 4px 8px; font-size: 10px;">
                                                    <i class="fas fa-undo"></i>
                                                </button>
                                            </div>
                                        </div>

                                        <!-- DPI -->
                                        <div>
                                            <label style="display: block; font-size: 11px; color: var(--text-secondary); font-weight: 600; margin-bottom: 6px;">DPI</label>
                                            <div style="display: flex; gap: 4px; align-items: center;">
                                                <input type="number" id="dpi-main" min="72" max="600" value="300" step="1" data-default="300"
                                                       style="width: 100%; padding: 6px 8px; border: 1px solid var(--border-muted); border-radius: 4px; font-size: 11px; background: var(--bg-surface); color: var(--text-primary);">
                                                <button class="setting-reset-btn" data-target="dpi-main" title="Reset" style="padding: 4px 8px; font-size: 10px;">
                                                    <i class="fas fa-undo"></i>
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Mode -->
                                        <div>
                                            <label style="display: block; font-size: 11px; color: var(--text-secondary); font-weight: 600; margin-bottom: 6px;">Mode</label>
                                            <select id="mode-main" data-default="publication" style="width: 100%; padding: 6px 8px; border: 1px solid var(--border-muted); border-radius: 4px; font-size: 11px; background: var(--bg-surface);">
                                                <option value="publication" selected>Publication</option>
                                                <option value="presentation">Presentation</option>
                                                <option value="draft">Draft</option>
                                            </select>
                                        </div>

                                        <!-- Transparent Background -->
                                        <div>
                                            <label style="display: block; font-size: 11px; color: var(--text-secondary); font-weight: 600; margin-bottom: 6px;">Transparent BG</label>
                                            <div style="display: flex; align-items: center; gap: 8px; height: 34px;">
                                                <input type="checkbox" id="transparent-main" checked data-default="true" style="width: 18px; height: 18px; cursor: pointer;">
                                                <span style="font-size: 11px; color: var(--text-muted);">Enabled</span>
                                            </div>
                                        </div>

                                        <!-- Auto Scale Axes -->
                                        <div>
                                            <label style="display: block; font-size: 11px; color: var(--text-secondary); font-weight: 600; margin-bottom: 6px;">Auto Scale Axes</label>
                                            <div style="display: flex; align-items: center; gap: 8px; height: 34px;">
                                                <input type="checkbox" id="auto-scale-axes-main" checked data-default="true" style="width: 18px; height: 18px; cursor: pointer;">
                                                <span style="font-size: 11px; color: var(--text-muted);">Enabled</span>
                                            </div>
                                        </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="dark-canvas-warning" class="dark-canvas-warning" style="display: none;">
                    <i class="fas fa-eye"></i>
                    <span>Export: WHITE bg</span>
                </div>
            </div>
            <div style="display: flex; align-items: center; gap: 6px;">
                <i class="fas fa-search" style="font-size: 10px; color: var(--vis-text-secondary);"></i>
                <span style="font-size: 11px; color: var(--vis-text-secondary);">Zoom:</span>
                <span id="canvas-zoom" style="font-family: 'Courier New', monospace; font-weight: 600;">100%</span>
            </div>
        </div>
    </div>

    <!-- Right Properties Panel -->
    <div class="vis-properties">
        <!-- Canvas Mode: Properties -->
        <div id="canvas-properties-panel">
            <div class="properties-header">
                <i class="fas fa-sliders-h"></i> Properties
            </div>
            <div id="properties-content" class="properties-content">
                <p class="properties-empty">Select an object to edit properties</p>
            </div>
        </div>

    </div>
</div>

<!-- New Figure Modal -->
<div id="new-figure-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Create New Figure</h2>
            <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <form id="new-figure-form" method="post" action="{% url 'vis:create_figure' %}">
                {% csrf_token %}
                <div class="form-group">
                    <label for="figure-title">Title</label>
                    <input type="text" id="figure-title" name="title" class="form-control" placeholder="Untitled Figure" required>
                </div>
                <div class="form-group">
                    <label for="figure-layout">Initial Layout</label>
                    <select id="figure-layout" name="layout" class="form-control">
                        <option value="1x1">Single Panel (1√ó1)</option>
                        <option value="2x1">Two Horizontal (2√ó1)</option>
                        <option value="1x2">Two Vertical (1√ó2)</option>
                        <option value="2x2" selected>Four Panels (2√ó2)</option>
                        <option value="1x3">Three Horizontal (1√ó3)</option>
                        <option value="3x1">Three Vertical (3√ó1)</option>
                    </select>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary modal-close">Cancel</button>
            <button type="submit" form="new-figure-form" class="btn btn-primary">Create Figure</button>
        </div>
    </div>
</div>

<!-- Version History Modal -->
<div id="version-history-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h2>Version History</h2>
            <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <div style="margin-bottom: 16px;">
                <button id="create-snapshot-btn" class="btn btn-primary btn-sm">
                    <i class="fas fa-camera"></i>
                    Create Snapshot
                </button>
            </div>
            <div id="versions-list" class="versions-list">
                <p class="text-muted">Loading versions...</p>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary modal-close">Close</button>
        </div>
    </div>
</div>

<!-- Keyboard Shortcuts Modal -->
<div id="keyboard-shortcuts-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h2>Keyboard Shortcuts</h2>
            <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <div class="shortcuts-grid">
                <div class="shortcuts-section">
                    <h3>Selection</h3>
                    <div class="shortcut-row">
                        <kbd>Alt+Click</kbd>
                        <span>Select from overlapping objects</span>
                    </div>
                    <div class="shortcut-row">
                        <kbd>Shift+Click</kbd>
                        <span>Multi-select</span>
                    </div>
                </div>

                <div class="shortcuts-section">
                    <h3>Editing</h3>
                    <div class="shortcut-row">
                        <kbd>Ctrl+D</kbd>
                        <span>Duplicate</span>
                    </div>
                    <div class="shortcut-row">
                        <kbd>Del</kbd> / <kbd>Backspace</kbd>
                        <span>Delete</span>
                    </div>
                    <div class="shortcut-row">
                        <kbd>Ctrl+Z</kbd>
                        <span>Undo</span>
                    </div>
                    <div class="shortcut-row">
                        <kbd>Ctrl+Y</kbd>
                        <span>Redo</span>
                    </div>
                </div>

                <div class="shortcuts-section">
                    <h3>Grouping</h3>
                    <div class="shortcut-row">
                        <kbd>Ctrl+G</kbd>
                        <span>Group objects</span>
                    </div>
                    <div class="shortcut-row">
                        <kbd>Ctrl+Shift+G</kbd>
                        <span>Ungroup</span>
                    </div>
                    <div class="shortcut-row">
                        <kbd>Enter</kbd>
                        <span>Enter group (edit contents)</span>
                    </div>
                </div>

                <div class="shortcuts-section">
                    <h3>Layer Order</h3>
                    <div class="shortcut-row">
                        <kbd>Ctrl+Shift+]</kbd>
                        <span>Bring to front</span>
                    </div>
                    <div class="shortcut-row">
                        <kbd>Ctrl+]</kbd>
                        <span>Bring forward</span>
                    </div>
                    <div class="shortcut-row">
                        <kbd>Ctrl+[</kbd>
                        <span>Send backward</span>
                    </div>
                    <div class="shortcut-row">
                        <kbd>Ctrl+Shift+[</kbd>
                        <span>Send to back</span>
                    </div>
                </div>

                <div class="shortcuts-section">
                    <h3>View</h3>
                    <div class="shortcut-row">
                        <kbd>+</kbd> / <kbd>=</kbd>
                        <span>Zoom in</span>
                    </div>
                    <div class="shortcut-row">
                        <kbd>-</kbd>
                        <span>Zoom out</span>
                    </div>
                    <div class="shortcut-row">
                        <kbd>0</kbd>
                        <span>Fit to window</span>
                    </div>
                    <div class="shortcut-row">
                        <kbd>Ctrl+Scroll</kbd>
                        <span>Zoom in/out</span>
                    </div>
                </div>

                <div class="shortcuts-section">
                    <h3>Save & Export</h3>
                    <div class="shortcut-row">
                        <kbd>Ctrl+S</kbd>
                        <span>Save figure</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary modal-close">Close</button>
        </div>
    </div>
</div>

<!-- Skewer Selection Modal -->
<div id="skewer-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h2>Select Object</h2>
            <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <p style="margin-bottom: 12px; color: var(--text-secondary); font-size: 13px;">
                Multiple overlapping objects at this position. Drag to reorder (top = front):
            </p>
            <div id="skewer-list" class="skewer-list">
                <!-- Objects will be dynamically inserted here -->
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary modal-close">Cancel</button>
            <button type="button" id="skewer-select-btn" class="btn btn-primary">Select</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Load Fabric.js from CDN first -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>

<!-- Handsontable for data grid -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@13.1.0/dist/handsontable.full.min.css">
<script src="https://cdn.jsdelivr.net/npm/handsontable@13.1.0/dist/handsontable.full.min.js"></script>

<!-- Load our editor (no module type needed, uses global fabric) -->
<script src="{% static 'vis_app/js/editor.js' %}"></script>
{% endblock %}
<!-- test -->
