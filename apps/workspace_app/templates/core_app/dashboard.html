{% extends "global_base.html" %}
{% load static %}

{% block title %}Dashboard{% endblock %}

{% block extra_css %}
<style>
/* Minimal SciTeX Dashboard */
:root {
    --scitex-primary: #1a2332;
    --scitex-secondary: #34495e;
    --scitex-accent: #506b7a;
    --scitex-light: #f8f9fa;
    --scitex-white: #ffffff;
    --border-radius: 8px;
    --transition: all 0.2s ease;
}

body {
    background: #f8f9fa;
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    color: var(--scitex-primary);
}

/* Minimal Header */
.minimal-header {
    background: var(--scitex-white);
    border-bottom: 1px solid #e9ecef;
    color: var(--scitex-primary);
}

/* File Browser Hero */
.file-browser-hero {
    background: var(--scitex-white);
    border: 1px solid #e9ecef;
    border-radius: var(--border-radius);
    min-height: 70vh;
}

/* Simple File Tree */
.simple-file-tree {
    padding: 1rem;
}

.simple-file-list {
    padding: 1rem;
    min-height: 400px;
}

/* Directory Items */
.directory-item {
    display: flex;
    align-items: center;
    padding: 0.5rem;
    cursor: pointer;
    border-radius: var(--border-radius);
    transition: var(--transition);
}

.directory-item:hover {
    background: var(--scitex-light);
}

.directory-item.active {
    background: var(--scitex-primary);
    color: white;
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 3rem 2rem;
    color: var(--scitex-accent);
}

.empty-state h3 {
    margin-bottom: 1rem;
}

.empty-state p {
    margin-bottom: 1.5rem;
}







.file-manager-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 90%;
    max-width: 1200px;
    height: 80%;
    background: var(--scitex-white);
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow-medium);
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.file-manager-header {
    background: var(--scitex-primary);
    color: var(--scitex-white);
    padding: 1rem 1.5rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.file-manager-title {
    font-size: 1.2rem;
    font-weight: 600;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.file-manager-close {
    background: none;
    border: none;
    color: var(--scitex-white);
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0.25rem;
    border-radius: var(--border-radius);
    transition: var(--transition);
}

.file-manager-close:hover {
    background: rgba(255, 255, 255, 0.1);
}

.file-manager-body {
    display: flex;
    flex: 1;
    overflow: hidden;
}

.file-manager-sidebar {
    width: 250px;
    background: var(--scitex-light);
    border-right: 1px solid rgba(26, 35, 50, 0.06);
    padding: 1rem;
    overflow-y: auto;
}

.file-manager-main {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.file-manager-toolbar {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid rgba(26, 35, 50, 0.06);
    display: flex;
    align-items: center;
    gap: 1rem;
    background: var(--scitex-white);
}

.file-manager-breadcrumb {
    flex: 1;
    font-size: 0.9rem;
    color: var(--scitex-accent);
    font-family: 'Courier New', monospace;
}

.file-manager-actions {
    display: flex;
    gap: 0.5rem;
}

.file-manager-btn {
    padding: 0.5rem 1rem;
    border: 1px solid var(--scitex-accent);
    background: transparent;
    color: var(--scitex-accent);
    border-radius: var(--border-radius);
    font-size: 0.85rem;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.file-manager-btn:hover {
    background: var(--scitex-accent);
    color: var(--scitex-white);
}

.file-manager-btn.primary {
    background: var(--scitex-primary);
    color: var(--scitex-white);
    border-color: var(--scitex-primary);
}

.file-manager-btn.primary:hover {
    background: var(--scitex-secondary);
}

.file-manager-files {
    flex: 1;
    padding: 1rem 1.5rem;
    overflow-y: auto;
}

.file-tree {
    list-style: none;
    padding: 0;
    margin: 0;
}

.file-tree-item {
    padding: 0.5rem 0;
    border-bottom: 1px solid rgba(26, 35, 50, 0.06);
    cursor: pointer;
    transition: var(--transition);
}

.file-tree-item:hover {
    background: rgba(26, 35, 50, 0.02);
    margin: 0 -1rem;
    padding-left: 1rem;
    padding-right: 1rem;
    border-radius: var(--border-radius);
}

.file-tree-item.directory {
    font-weight: 600;
    color: var(--scitex-primary);
}

.file-tree-item.file {
    color: var(--scitex-accent);
}

.file-item {
    display: flex;
    align-items: center;
    padding: 0.75rem 0;
    border-bottom: 1px solid rgba(26, 35, 50, 0.06);
    transition: var(--transition);
}

.file-item:hover {
    background: rgba(26, 35, 50, 0.02);
    margin: 0 -1.5rem;
    padding-left: 1.5rem;
    padding-right: 1.5rem;
    border-radius: var(--border-radius);
}

.file-item-icon {
    width: 40px;
    height: 40px;
    border-radius: var(--border-radius);
    background: var(--scitex-light);
    color: var(--scitex-accent);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
    flex-shrink: 0;
}

.file-item-icon.directory {
    background: var(--scitex-primary);
    color: var(--scitex-white);
}

.file-item-content {
    flex: 1;
    min-width: 0;
}

.file-item-name {
    font-weight: 500;
    margin-bottom: 0.25rem;
    color: var(--scitex-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.file-item-meta {
    font-size: 0.8rem;
    color: var(--scitex-accent);
}

.file-item-actions {
    display: flex;
    gap: 0.5rem;
    opacity: 0;
    transition: var(--transition);
}

.file-item:hover .file-item-actions {
    opacity: 1;
}

.file-item-action {
    padding: 0.25rem;
    border: none;
    background: transparent;
    color: var(--scitex-accent);
    cursor: pointer;
    border-radius: var(--border-radius);
    transition: var(--transition);
}

.file-item-action:hover {
    background: var(--scitex-accent);
    color: var(--scitex-white);
}

.script-execution-status {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: var(--border-radius);
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.script-execution-status.running {
    background: var(--scitex-warning);
    color: var(--scitex-white);
}

.script-execution-status.success {
    background: var(--scitex-success);
    color: var(--scitex-white);
}

.script-execution-status.error {
    background: #e74c3c;
    color: var(--scitex-white);
}

.folder-structure {
    list-style: none;
    padding: 0;
    margin: 0;
}

.folder-item {
    display: flex;
    align-items: center;
    padding: 0.5rem 0.75rem;
    cursor: pointer;
    border-radius: var(--border-radius);
    transition: var(--transition);
    font-size: 0.9rem;
    color: var(--scitex-accent);
}

.folder-item:hover {
    background: rgba(26, 35, 50, 0.05);
    color: var(--scitex-primary);
}

.folder-item.active {
    background: var(--scitex-primary);
    color: var(--scitex-white);
}

.folder-item i {
    margin-right: 0.5rem;
    width: 16px;
}

.upload-zone {
    border: 2px dashed var(--scitex-accent);
    border-radius: var(--border-radius);
    padding: 2rem;
    text-align: center;
    color: var(--scitex-accent);
    margin: 1rem 0;
    transition: var(--transition);
}

.upload-zone.dragover {
    border-color: var(--scitex-primary);
    background: rgba(26, 35, 50, 0.02);
    color: var(--scitex-primary);
}

.upload-zone input[type="file"] {
    display: none;
}

/* GitHub Integration Styles */
.github-integration-panel {
    background: rgba(0, 123, 255, 0.02);
    border-color: rgba(0, 123, 255, 0.2) !important;
}

.github-status-indicator .badge {
    font-size: 0.75rem;
}

.git-files-list {
    max-height: 200px;
    overflow-y: auto;
}

.git-file-item {
    display: flex;
    align-items: center;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    margin-bottom: 0.25rem;
    font-size: 0.85rem;
}

.git-file-item:hover {
    background: rgba(0, 123, 255, 0.05);
}

.git-status-icon {
    width: 16px;
    text-align: center;
    margin-right: 0.5rem;
}

/* Project tabs and file manager styles */
.project-tabs-container {
    margin: 0 -1.5rem;
}

.project-tabs-container .nav-tabs {
    border-bottom: 1px solid #dee2e6;
    background: #f8f9fa;
    padding: 0 1.5rem;
}

.project-tabs-container .nav-link {
    border: none;
    border-radius: 0;
    color: var(--scitex-accent);
    font-weight: 500;
    font-size: 0.9rem;
    padding: 1rem 1.5rem;
}

.project-tabs-container .nav-link.active {
    background: var(--scitex-white);
    color: var(--scitex-primary);
    border-bottom: 3px solid var(--scitex-primary);
}

.project-tabs-container .nav-link:hover {
    background: rgba(26, 35, 50, 0.05);
    color: var(--scitex-primary);
}

.embedded-file-manager {
    min-height: 500px;
    border: 1px solid rgba(26, 35, 50, 0.06);
    border-radius: var(--border-radius);
    overflow: hidden;
}

.directory-tree {
    max-height: 400px;
    overflow-y: auto;
}

.tree-item {
    padding: 0.5rem 0.75rem;
    cursor: pointer;
    border-radius: var(--border-radius);
    transition: var(--transition);
    font-size: 0.9rem;
    margin-bottom: 0.25rem;
}

.tree-item:hover {
    background: rgba(26, 35, 50, 0.05);
    color: var(--scitex-primary);
}

.tree-item.active {
    background: var(--scitex-primary);
    color: var(--scitex-white);
}

.tree-children {
    border-left: 2px solid rgba(26, 35, 50, 0.1);
    margin-left: 0.5rem;
    padding-left: 0.5rem;
}

.file-list {
    min-height: 350px;
    max-height: 400px;
    overflow-y: auto;
}

.file-item-small {
    display: flex;
    align-items: center;
    padding: 0.5rem;
    border-bottom: 1px solid rgba(26, 35, 50, 0.06);
    transition: var(--transition);
    font-size: 0.9rem;
}

.file-item-small:hover {
    background: rgba(26, 35, 50, 0.02);
    border-radius: var(--border-radius);
    margin: 0 -0.5rem;
    padding-left: 0.5rem;
    padding-right: 0.5rem;
}

.file-item-small .file-icon {
    width: 30px;
    height: 30px;
    border-radius: var(--border-radius);
    background: var(--scitex-light);
    color: var(--scitex-accent);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 0.75rem;
    flex-shrink: 0;
    font-size: 0.8rem;
}

.file-item-small .file-content {
    flex: 1;
    min-width: 0;
}

.file-item-small .file-name {
    font-weight: 500;
    color: var(--scitex-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-bottom: 0.1rem;
}

.file-item-small .file-meta {
    font-size: 0.75rem;
    color: var(--scitex-accent);
}

.file-item-small .file-actions {
    display: flex;
    gap: 0.25rem;
    opacity: 0;
    transition: var(--transition);
}

.file-item-small:hover .file-actions {
    opacity: 1;
}

.file-action-btn {
    padding: 0.25rem;
    border: none;
    background: transparent;
    color: var(--scitex-accent);
    cursor: pointer;
    border-radius: var(--border-radius);
    transition: var(--transition);
    font-size: 0.75rem;
}

.file-action-btn:hover {
    background: var(--scitex-accent);
    color: var(--scitex-white);
}

/* Tool Grid Styles */
.tool-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.5rem;
    padding: 1rem;
}

.tool-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    padding: 1rem 0.5rem;
    border: 1px solid rgba(26, 35, 50, 0.1);
    border-radius: var(--border-radius);
    color: var(--scitex-accent);
    text-decoration: none;
    transition: var(--transition);
    font-size: 0.85rem;
}

.tool-item:hover {
    background: var(--scitex-primary);
    color: var(--scitex-white);
    text-decoration: none;
    transform: translateY(-2px);
}

.tool-item i {
    font-size: 1.2rem;
    margin-bottom: 0.5rem;
}

/* Enhanced File Manager Styles */
.enhanced-file-manager {
    border-radius: var(--border-radius);
    overflow: hidden;
    box-shadow: var(--shadow-soft);
}

.enhanced-file-item {
    transition: var(--transition);
    border-radius: var(--border-radius);
    margin: 0.25rem 0;
}

.enhanced-file-item:hover {
    background: rgba(26, 35, 50, 0.03);
    transform: translateY(-1px);
    box-shadow: var(--shadow-soft);
}

.file-icon-container {
    width: 40px;
    display: flex;
    justify-content: center;
    align-items: center;
}

.file-item-hover {
    transition: all 0.2s ease;
}

.file-item-hover:hover {
    background: rgba(26, 35, 50, 0.05) !important;
}

.file-actions {
    opacity: 0;
    transition: var(--transition);
}

.enhanced-file-item:hover .file-actions {
    opacity: 1;
}

.file-list-enhanced.grid-view {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1rem;
    padding: 1rem;
}

.file-list-enhanced.grid-view .enhanced-file-item {
    flex-direction: column;
    text-align: center;
    padding: 1.5rem;
    border: 1px solid rgba(26, 35, 50, 0.1);
    border-radius: var(--border-radius);
    background: var(--scitex-white);
}

.file-list-enhanced.grid-view .file-icon-container {
    margin-bottom: 1rem;
}

.file-list-enhanced.grid-view .file-icon-container i {
    font-size: 2rem;
}

.file-search-container {
    position: relative;
}

.file-search-container::after {
    content: "\f002";
    font-family: "Font Awesome 5 Free";
    font-weight: 900;
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--scitex-accent);
    pointer-events: none;
}

.file-filter {
    transition: var(--transition);
}

.file-filter.active {
    background: var(--scitex-primary);
    color: var(--scitex-white);
    border-color: var(--scitex-primary);
}

.file-stats {
    font-size: 0.85rem;
}

.tree-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.5rem 0.75rem;
    cursor: pointer;
    border-radius: var(--border-radius);
    transition: var(--transition);
    font-size: 0.9rem;
    color: var(--scitex-accent);
    margin-bottom: 0.25rem;
}

.tree-item:hover {
    background: rgba(26, 35, 50, 0.05);
    color: var(--scitex-primary);
}

.tree-item.active {
    background: var(--scitex-primary);
    color: var(--scitex-white);
}

.tree-item .file-count {
    font-size: 0.8rem;
    opacity: 0.7;
}

.file-preview-container {
    padding: 0;
}

.file-content-preview pre {
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    line-height: 1.4;
    white-space: pre-wrap;
    word-wrap: break-word;
}

.file-actions-preview .btn {
    font-size: 0.8rem;
}

/* View mode controls */
.view-mode {
    transition: var(--transition);
}

.view-mode.active {
    background: var(--scitex-primary);
    color: var(--scitex-white);
    border-color: var(--scitex-primary);
}

/* Breadcrumb styling */
.breadcrumb-path {
    font-family: 'Courier New', monospace;
    background: rgba(26, 35, 50, 0.03);
    padding: 0.5rem 0.75rem;
    border-radius: var(--border-radius);
    font-size: 0.85rem;
}

/* Enhanced directory tree */
.directory-tree {
    max-height: none;
}

.tree-children {
    border-left: 2px solid rgba(26, 35, 50, 0.1);
    margin-left: 0.5rem;
    padding-left: 0.5rem;
}

/* Project Templates and Enhanced Empty State */
.hero-empty-state {
    min-height: 60vh;
    display: flex;
    flex-direction: column;
    justify-content: center;
}

.template-card {
    cursor: pointer;
    transition: var(--transition);
    background: var(--scitex-white);
    border: 1px solid rgba(26, 35, 50, 0.1) !important;
}

.template-hover:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-medium);
    border-color: var(--scitex-primary) !important;
}

.template-icon {
    opacity: 0.8;
}

.template-title {
    color: var(--scitex-primary);
    font-weight: 600;
    margin-bottom: 0.75rem;
}

.template-desc {
    line-height: 1.5;
    margin-bottom: 1rem;
}

.template-features {
    margin-top: auto;
}

.template-features .badge {
    font-size: 0.7rem;
    font-weight: 500;
}

.project-templates {
    max-width: 900px;
    margin: 0 auto;
}

.quick-start-actions {
    margin-top: 2rem;
}

/* Compact Statistics */
.compact-stats {
    background: rgba(26, 35, 50, 0.02);
    border-radius: var(--border-radius);
    padding: 1rem;
    margin: 1rem 0;
}

.compact-stats .fw-bold {
    font-size: 1.1rem;
}

/* Script Status Indicators */
.script-status {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    font-size: 0.8rem;
}

.status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    display: inline-block;
}

.status-dot.running {
    background: var(--scitex-warning);
    animation: pulse 1.5s infinite;
}

.status-dot.completed {
    background: var(--scitex-success);
}

.status-dot.error {
    background: #e74c3c;
}

.status-dot.pending {
    background: #bdc3c7;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

/* Enhanced Project Headers */
.project-header-enhanced {
    background: linear-gradient(135deg, var(--scitex-primary), var(--scitex-secondary));
    color: var(--scitex-white);
    padding: 1.5rem;
    border-radius: var(--border-radius) var(--border-radius) 0 0;
}

.project-status-summary {
    display: flex;
    align-items: center;
    gap: 1rem;
    font-size: 0.9rem;
    opacity: 0.9;
}

.file-with-status {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem;
    border-bottom: 1px solid rgba(26, 35, 50, 0.06);
    transition: var(--transition);
}

.file-with-status:hover {
    background: rgba(26, 35, 50, 0.02);
}

.file-info {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.file-status-indicator {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.8rem;
    color: var(--scitex-accent);
}

/* File manager responsiveness */
@media (max-width: 992px) {
    .enhanced-file-manager .col-3 {
        flex: 0 0 25%;
        max-width: 25%;
    }
    
    .enhanced-file-manager .col-6 {
        flex: 0 0 50%;
        max-width: 50%;
    }
    
    .project-templates .col-md-4 {
        flex: 0 0 50%;
        max-width: 50%;
    }
}

@media (max-width: 768px) {
    .enhanced-file-manager .row {
        flex-direction: column;
    }
    
    .enhanced-file-manager .col-3,
    .enhanced-file-manager .col-6 {
        flex: 0 0 100%;
        max-width: 100%;
        min-height: 200px;
    }
    
    .file-search-container {
        width: 100% !important;
        margin-bottom: 1rem;
    }
    
    .project-templates .col-md-4 {
        flex: 0 0 100%;
        max-width: 100%;
    }
    
    .quick-start-actions .btn {
        display: block;
        width: 100%;
        margin-bottom: 0.5rem;
    }
}

.embedded-file-manager {
    min-height: 500px;
    border: 1px solid rgba(26, 35, 50, 0.06);
    border-radius: var(--border-radius);
    overflow: hidden;
}

.directory-tree {
    max-height: 400px;
    overflow-y: auto;
}

.tree-item {
    padding: 0.5rem 0.75rem;
    cursor: pointer;
    border-radius: var(--border-radius);
    transition: var(--transition);
    font-size: 0.9rem;
    margin-bottom: 0.25rem;
}

.tree-item:hover {
    background: rgba(26, 35, 50, 0.05);
    color: var(--scitex-primary);
}

.tree-item.active {
    background: var(--scitex-primary);
    color: var(--scitex-white);
}

.tree-children {
    border-left: 2px solid rgba(26, 35, 50, 0.1);
    margin-left: 0.5rem;
    padding-left: 0.5rem;
}

.file-list {
    min-height: 350px;
    max-height: 400px;
    overflow-y: auto;
}

.file-item-small {
    display: flex;
    align-items: center;
    padding: 0.5rem;
    border-bottom: 1px solid rgba(26, 35, 50, 0.06);
    transition: var(--transition);
    font-size: 0.9rem;
}

.file-item-small:hover {
    background: rgba(26, 35, 50, 0.02);
    border-radius: var(--border-radius);
    margin: 0 -0.5rem;
    padding-left: 0.5rem;
    padding-right: 0.5rem;
}

.file-item-small .file-icon {
    width: 30px;
    height: 30px;
    border-radius: var(--border-radius);
    background: var(--scitex-light);
    color: var(--scitex-accent);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 0.75rem;
    flex-shrink: 0;
}

.file-item-small .file-content {
    flex: 1;
    min-width: 0;
}

.file-item-small .file-name {
    font-weight: 500;
    margin-bottom: 0.125rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.file-item-small .file-meta {
    font-size: 0.75rem;
    color: var(--scitex-accent);
}

@media (max-width: 768px) {
    .quick-start-actions .btn {
        display: block;
        width: 100%;
        margin-bottom: 0.5rem;
    }
}
</style>
{% endblock %}

{% block content %}
<!-- Minimal Header -->
<div class="minimal-header py-2">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="h5 mb-0">Dashboard</h1>
                <small class="text-muted">Welcome back, {{ user.get_full_name|default:user.username }}!</small>
            </div>
            <div class="d-flex gap-2">
                <a href="{%url'core:dashboard_react_tree' %}" class="btn btn-outline-primary btn-sm">
                    <i class="fas fa-folder-tree me-1"></i>File Manager
                </a>
                <button class="btn btn-primary btn-sm" onclick="console.log('Button clicked'); createNewProject();">
                    <i class="fas fa-plus me-1"></i>New Project
                </button>
            </div>
        </div>
    </div>
</div>

<!-- File Browser Hero -->
<div class="container-fluid px-3">
    <div class="file-browser-hero">
        {% if projects %}
        <!-- Project Selection -->
        <div class="border-bottom">
            <div class="simple-file-tree">
                <h6 class="mb-3">Projects</h6>
                {% for project in projects %}
                <div class="directory-item {% if forloop.first %}active{% endif %}" 
                     onclick="selectProject({{ project.id }}, '{{ project.name|escapejs }}')">
                    <i class="fas fa-folder me-2"></i>
                    <span>{{ project.name }}</span>
                    {% if project.is_github_connected %}
                        <i class="fab fa-github ms-2 text-success" title="GitHub Connected"></i>
                    {% else %}
                        <i class="fab fa-github ms-2 text-muted" title="GitHub Not Connected"></i>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Simple File Browser -->
        <div class="row g-0">
            <!-- Directory Tree -->
            <div class="col-3 border-end">
                <div class="simple-file-tree">
                    <h6 class="mb-3">{{ projects.0.name|default:"Project" }} Structure</h6>
                    <div class="directory-item active" onclick="navigateToFolder('')">
                        <i class="fas fa-home me-2"></i>
                        <span>Project Root</span>
                    </div>
                    <div class="directory-item" onclick="navigateToFolder('paper')">
                        <i class="fas fa-file-alt me-2 text-danger"></i>
                        <span>paper/</span>
                    </div>
                    <div class="ms-3">
                        <div class="directory-item" onclick="navigateToFolder('paper/manuscript')">
                            <i class="fas fa-file-pdf me-2 text-danger"></i>
                            <span>manuscript/</span>
                        </div>
                        <div class="directory-item" onclick="navigateToFolder('paper/figures')">
                            <i class="fas fa-chart-bar me-2 text-warning"></i>
                            <span>figures/</span>
                        </div>
                    </div>
                    <div class="directory-item" onclick="navigateToFolder('data')">
                        <i class="fas fa-database me-2 text-info"></i>
                        <span>data/</span>
                    </div>
                    <div class="directory-item" onclick="navigateToFolder('code')">
                        <i class="fas fa-code me-2 text-success"></i>
                        <span>code/</span>
                    </div>
                </div>
            </div>
            
            <!-- File List -->
            <div class="col-9">
                <div class="simple-file-list">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="text-muted">~/{{ projects.0.name|default:"project" }}/</span>
                        <div>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="uploadFiles()">
                                <i class="fas fa-upload"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary me-1" onclick="refreshFiles()">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-info" onclick="showGitHubPanel()">
                                <i class="fab fa-github"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- GitHub Integration Panel -->
                    <div id="githubPanel" class="github-integration-panel border rounded p-3 mb-3" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0"><i class="fab fa-github me-2"></i>GitHub Integration</h6>
                            <button class="btn btn-sm btn-outline-secondary" onclick="hideGitHubPanel()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div id="githubStatus" class="mb-3">
                            <div class="github-status-indicator">
                                <span class="badge bg-secondary">Not Connected</span>
                                <small class="text-muted ms-2">Connect your project to GitHub for version control</small>
                            </div>
                        </div>
                        <div class="github-actions">
                            <button class="btn btn-sm btn-success me-2" onclick="connectGitHub()">
                                <i class="fab fa-github me-1"></i>Connect GitHub
                            </button>
                            <button class="btn btn-sm btn-outline-primary me-2" onclick="createGitHubRepo()" style="display: none;" id="createRepoBtn">
                                <i class="fas fa-plus me-1"></i>Create Repository
                            </button>
                            <button class="btn btn-sm btn-outline-info me-2" onclick="linkGitHubRepo()" style="display: none;" id="linkRepoBtn">
                                <i class="fas fa-link me-1"></i>Link Repository
                            </button>
                            <button class="btn btn-sm btn-outline-warning me-2" onclick="syncGitStatus()" style="display: none;" id="syncBtn">
                                <i class="fas fa-sync me-1"></i>Sync Status
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="commitChanges()" style="display: none;" id="commitBtn">
                                <i class="fas fa-check me-1"></i>Commit & Push
                            </button>
                        </div>
                        <div id="gitStatusFiles" class="mt-3" style="display: none;">
                            <h6 class="text-muted">Git Status</h6>
                            <div id="gitFilesList" class="git-files-list">
                                <!-- Git file statuses will be populated here -->
                            </div>
                        </div>
                    </div>
                    <div class="text-center text-muted py-5" id="fileListContent">
                        <i class="fas fa-folder-open fa-3x mb-3"></i>
                        <h5>Select a directory to view files</h5>
                        <p>Choose a folder from the directory tree to browse files</p>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <!-- Simple Empty State -->
        <div class="empty-state">
            <i class="fas fa-folder-open fa-3x text-primary mb-4"></i>
            <h3>No projects yet</h3>
            <p class="text-muted mb-4">Create your first project to get started</p>
            
            <!-- Primary Action -->
            <div class="mb-4">
                <button class="btn btn-primary btn-lg" onclick="createNewProject();">
                    <i class="fas fa-plus me-2"></i>Create New Project
                </button>
            </div>
            
            <!-- Quick Links -->
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="d-flex justify-content-center gap-3 text-muted small">
                        <a href="#" onclick="showOnboardingVideo()" class="text-decoration-none">
                            <i class="fas fa-video me-1"></i>Watch Demo
                        </a>
                        <a href="#" onclick="openDocumentation()" class="text-decoration-none">
                            <i class="fas fa-book me-1"></i>Documentation
                        </a>
                        <a href="#" onclick="showExampleProjects()" class="text-decoration-none">
                            <i class="fas fa-eye me-1"></i>View Examples
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Create Project Modal -->
<div id="createProjectModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4);">
    <div class="modal-content" style="background-color: #fefefe; margin: 5% auto; padding: 0; border-radius: 16px; width: 90%; max-width: 700px; box-shadow: 0 4px 30px rgba(0,0,0,0.3);">
        <div class="modal-header" style="background: var(--scitex-primary); color: white; padding: 1.5rem; border-radius: 16px 16px 0 0; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-plus-circle"></i> Create New Research Project
            </h3>
            <button type="button" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;" onclick="closeCreateProjectModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="modal-body" style="padding: 2rem;">
            <form id="createProjectForm">
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--scitex-primary);">
                        Project Name <span style="color: red;">*</span>
                    </label>
                    <input type="text" name="name" required 
                           style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;" 
                           placeholder="Enter a descriptive project name">
                    <small style="color: #666; font-size: 0.85rem;">
                        Choose a clear, descriptive name for your research project.
                    </small>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--scitex-primary);">
                        Project Description <span style="color: red;">*</span>
                    </label>
                    <textarea name="description" required rows="4" 
                              style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; resize: vertical;" 
                              placeholder="Describe your research project, goals, and methodology"></textarea>
                    <small style="color: #666; font-size: 0.85rem;">
                        Provide a comprehensive description of your research objectives and approach.
                    </small>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--scitex-primary);">
                        Research Hypotheses <span style="color: red;">*</span>
                    </label>
                    <textarea name="hypotheses" required rows="3" 
                              style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; resize: vertical;" 
                              placeholder="State your research hypotheses clearly"></textarea>
                    <small style="color: #666; font-size: 0.85rem;">
                        Define your testable hypotheses clearly.
                    </small>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--scitex-primary);">
                        Source Code Repository <span style="color: #666; font-size: 0.9rem;">(Optional)</span>
                    </label>
                    <input type="url" name="source_code_url" 
                           style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;" 
                           placeholder="https://github.com/username/project">
                    <small style="color: #666; font-size: 0.85rem;">
                        Link to GitHub/GitLab repository for version control integration.
                    </small>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <div style="display: flex; align-items: flex-start; gap: 0.5rem;">
                        <input type="checkbox" name="create_default_structure" checked style="margin-top: 0.25rem;">
                        <div>
                            <label style="font-weight: 600; color: var(--scitex-primary); cursor: pointer;">
                                Create Default Directory Structure
                            </label>
                            <div style="color: #666; font-size: 0.85rem; margin-top: 0.25rem;">
                                Automatically create standardized research project folders:<br>
                                <code style="background: #f5f5f5; padding: 0.2rem 0.4rem; border-radius: 4px; font-size: 0.8rem;">
                                config/, data/{raw,processed,figures,models}, scripts/, docs/{manuscripts,notes,references}, results/{outputs,reports,analysis}, temp/{cache,logs,tmp}
                                </code>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        
        <div class="modal-footer" style="padding: 1.5rem; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 1rem;">
            <button type="button" onclick="closeCreateProjectModal()" 
                    style="padding: 0.75rem 1.5rem; border: 1px solid #ddd; background: white; border-radius: 8px; cursor: pointer;">
                Cancel
            </button>
            <button type="button" onclick="submitCreateProject()" 
                    style="padding: 0.75rem 1.5rem; border: none; background: var(--scitex-primary); color: white; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-plus"></i> Create Project
            </button>
        </div>
    </div>
</div>

<!-- File Manager Modal - REMOVED -->
<div id="fileManagerModal" class="file-manager-modal" style="display: none !important;">
    <div class="file-manager-content">
        <div class="file-manager-header">
            <h3 class="file-manager-title">
                <i class="fas fa-folder-open"></i>
                <span id="fileManagerProjectName">Project Files</span>
            </h3>
            <button class="file-manager-close" onclick="closeFileManager()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="file-manager-body">
            <!-- Sidebar with folder structure -->
            <div class="file-manager-sidebar">
                <h4 style="margin-top: 0; color: var(--scitex-primary); font-size: 0.95rem;">Directory Structure</h4>
                <ul id="folderStructure" class="folder-structure">
                    <!-- Will be populated dynamically -->
                </ul>
            </div>
            
            <!-- Main file area -->
            <div class="file-manager-main">
                <div class="file-manager-toolbar">
                    <div class="file-manager-breadcrumb" id="breadcrumb">
                        ~/projects/
                    </div>
                    <div class="file-manager-actions">
                        <button class="file-manager-btn" onclick="refreshFiles()">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                        <button class="file-manager-btn" onclick="downloadProject()">
                            <i class="fas fa-download"></i>
                            Download ZIP
                        </button>
                        <button class="file-manager-btn" onclick="syncWithGithub()">
                            <i class="fab fa-github"></i>
                            Sync GitHub
                        </button>
                        <button class="file-manager-btn primary" onclick="showUploadZone()">
                            <i class="fas fa-upload"></i>
                            Upload
                        </button>
                    </div>
                </div>
                
                <div class="file-manager-files" id="fileList">
                    <!-- Upload zone -->
                    <div id="uploadZone" class="upload-zone" style="display: none;">
                        <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                        <p>Drop files here or click to browse</p>
                        <input type="file" id="fileInput" multiple>
                        <button class="file-manager-btn primary" onclick="document.getElementById('fileInput').click()">
                            Choose Files
                        </button>
                    </div>
                    
                    <!-- File list will be populated here -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function createNewProject() {
    // Create project directly without modal
    const projectName = prompt('Enter project name:');
    if (projectName && projectName.trim()) {
        const formData = new FormData();
        formData.append('name', projectName.trim());
        formData.append('description', '');
        formData.append('research_field', 'general');
        
        fetch('/core/api/v1/projects/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCsrfToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload(); // Reload to show new project
            } else {
                alert('Error creating project: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error creating project');
        });
    }
}

function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
           document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
}

function closeCreateProjectModal() {
    document.getElementById('createProjectModal').style.display = 'none';
    document.getElementById('createProjectForm').reset();
}

function submitCreateProject() {
    const form = document.getElementById('createProjectForm');
    const formData = new FormData(form);
    
    const projectData = {
        name: formData.get('name'),
        description: formData.get('description'),
        hypotheses: formData.get('hypotheses'),
        source_code_url: formData.get('source_code_url'),
        status: 'planning',
        progress: 0,
        create_default_structure: formData.get('create_default_structure') === 'on'
    };
    
    if (!projectData.name || !projectData.description || !projectData.hypotheses) {
        alert('Please fill in all required fields (Name, Description, and Hypotheses)');
        return;
    }
    
    fetch('/core/api/v1/projects/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(projectData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeCreateProjectModal();
            location.reload();
        } else {
            alert('Error creating project: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error creating project');
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// File Manager Functions
let currentProject = null;
let currentPath = '';

function openProjectFileManager(projectId, projectName) {
    currentProject = projectId;
    currentPath = '';
    
    document.getElementById('fileManagerProjectName').textContent = projectName;
    document.getElementById('fileManagerModal').style.display = 'block';
    
    // Load project structure and files
    loadProjectStructure();
    loadProjectFiles();
}

// New functions for embedded file manager in dashboard
function loadProjectFiles(projectId) {
    if (!projectId) return;
    
    const url = currentPath 
        ? `/core/directory/projects/${projectId}/files/?category=${currentPath.split('/')[0]}`
        : `/core/directory/projects/${projectId}/files/`;
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                renderFileListForProject(projectId, data.files);
            }
        })
        .catch(error => {
            console.error('Error loading project files:', error);
        });
}

function renderFileListForProject(projectId, files) {
    const fileListContainer = document.getElementById(`fileList-${projectId}`);
    if (!fileListContainer) return;
    
    // Update file stats
    updateFileStats(projectId, files);
    
    if (files.length === 0) {
        fileListContainer.innerHTML = `
            <div class="text-center text-muted py-5">
                <i class="fas fa-folder-open fa-3x mb-3"></i>
                <h5>No files in this directory</h5>
                <p>Upload files or create new ones to get started</p>
                <button class="btn btn-outline-primary btn-sm me-2" onclick="uploadToProject(${projectId})">
                    <i class="fas fa-upload"></i> Upload Files/Directory
                </button>
                <button class="btn btn-outline-success btn-sm me-2" onclick="createNewFile(${projectId})">
                    <i class="fas fa-plus"></i> New File
                </button>
                <button class="btn btn-outline-warning btn-sm me-2" onclick="openProjectWriter(${projectId})">
                    <i class="fas fa-file-alt"></i> Write Manuscript
                </button>
                <button class="btn btn-outline-info btn-sm" onclick="showGitHubSync(${projectId})">
                    <i class="fab fa-github"></i> GitHub Sync
                </button>
            </div>
        `;
        return;
    }
    
    // Apply search and filter
    let filteredFiles = files;
    
    // Apply file type filter
    if (currentFileFilter !== 'all') {
        filteredFiles = files.filter(file => {
            const ext = file.name.toLowerCase().split('.').pop();
            switch (currentFileFilter) {
                case 'code':
                    return ['py', 'js', 'ts', 'r', 'ipynb', 'html', 'css', 'json', 'xml', 'yml', 'yaml'].includes(ext);
                case 'data':
                    return ['csv', 'xlsx', 'json', 'xml', 'pkl', 'h5', 'parquet', 'db'].includes(ext);
                case 'docs':
                    return ['md', 'txt', 'pdf', 'doc', 'docx', 'tex', 'rtf'].includes(ext);
                default:
                    return true;
            }
        });
    }
    
    // Apply search filter
    if (currentSearchTerm) {
        filteredFiles = filteredFiles.filter(file => 
            file.name.toLowerCase().includes(currentSearchTerm)
        );
    }
    
    let html = '';
    filteredFiles.forEach(file => {
        const icon = getFileIcon(file.name);
        const sizeFormatted = formatFileSize(file.size);
        const modifiedFormatted = new Date(file.modified).toLocaleDateString();
        
        html += `
            <div class="enhanced-file-item d-flex align-items-center p-3 border-bottom file-item-hover" 
                 onclick="previewFileContent(${projectId}, '${file.path}', '${file.name}')" 
                 style="cursor: pointer;">
                <div class="file-icon-container me-3">
                    <i class="${icon} fa-lg"></i>
                </div>
                <div class="flex-grow-1">
                    <div class="file-name fw-semibold">${file.name}</div>
                    <div class="file-meta text-muted small">${sizeFormatted} â€¢ ${modifiedFormatted}</div>
                </div>
                <div class="file-actions" onclick="event.stopPropagation();">
                    <button class="btn btn-sm btn-outline-info me-1" onclick="previewFileContent(${projectId}, '${file.path}', '${file.name}')" title="Preview">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-primary me-1" onclick="downloadFile(${projectId}, '${file.path}')" title="Download">
                        <i class="fas fa-download"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteFile(${projectId}, '${file.path}')" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
    });
    
    fileListContainer.innerHTML = html || `
        <div class="text-center text-muted py-4">
            <i class="fas fa-search fa-2x mb-2"></i>
            <p>No files match your search criteria</p>
        </div>
    `;
}

function updateFileStats(projectId, files) {
    const fileCountEl = document.getElementById(`fileCount-${projectId}`);
    const totalSizeEl = document.getElementById(`totalSize-${projectId}`);
    
    if (fileCountEl) {
        fileCountEl.textContent = files.length;
    }
    
    if (totalSizeEl) {
        const totalSize = files.reduce((sum, file) => sum + (file.size || 0), 0);
        totalSizeEl.textContent = formatFileSize(totalSize);
    }
}

function getFileIcon(filename) {
    const ext = filename.split('.').pop().toLowerCase();
    const iconMap = {
        'pdf': 'fas fa-file-pdf text-danger',
        'doc': 'fas fa-file-word text-primary',
        'docx': 'fas fa-file-word text-primary',
        'xls': 'fas fa-file-excel text-success',
        'xlsx': 'fas fa-file-excel text-success',
        'csv': 'fas fa-file-csv text-success',
        'txt': 'fas fa-file-alt text-secondary',
        'md': 'fas fa-file-alt text-info',
        'py': 'fas fa-file-code text-warning',
        'r': 'fas fa-file-code text-info',
        'js': 'fas fa-file-code text-warning',
        'html': 'fas fa-file-code text-danger',
        'css': 'fas fa-file-code text-primary',
        'json': 'fas fa-file-code text-secondary',
        'xml': 'fas fa-file-code text-secondary',
        'yml': 'fas fa-file-code text-secondary',
        'yaml': 'fas fa-file-code text-secondary',
        'png': 'fas fa-file-image text-success',
        'jpg': 'fas fa-file-image text-success',
        'jpeg': 'fas fa-file-image text-success',
        'gif': 'fas fa-file-image text-success',
        'svg': 'fas fa-file-image text-success',
        'zip': 'fas fa-file-archive text-warning',
        'gz': 'fas fa-file-archive text-warning',
        'tar': 'fas fa-file-archive text-warning'
    };
    return iconMap[ext] || 'fas fa-file text-secondary';
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

function navigateToProjectFolder(projectId, path) {
    currentPath = path;
    loadProjectFiles(projectId);
    
    // Update breadcrumb
    const breadcrumbEl = document.getElementById(`currentPath-${projectId}`);
    if (breadcrumbEl) {
        breadcrumbEl.textContent = path || 'root';
    }
    
    // Update active folder
    document.querySelectorAll(`#project-${projectId} .tree-item`).forEach(item => {
        item.classList.remove('active');
    });
    const activeItem = document.querySelector(`#project-${projectId} [data-path="${path}"]`);
    if (activeItem) {
        activeItem.classList.add('active');
    }
}

function uploadToProject(projectId) {
    // Show upload options
    showUploadOptions(projectId);
}

function showUploadOptions(projectId) {
    // Create modal with upload options
    const modalHtml = `
        <div class="modal fade" id="uploadModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Upload Files or Directory</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="d-grid gap-3">
                            <button class="btn btn-outline-primary" onclick="uploadFiles_modal(${projectId}, false)">
                                <i class="fas fa-file me-2"></i>Upload Files
                                <div class="small text-muted">Select individual files</div>
                            </button>
                            <button class="btn btn-outline-success" onclick="uploadFiles_modal(${projectId}, true)">
                                <i class="fas fa-folder me-2"></i>Upload Directory
                                <div class="small text-muted">Upload entire directory structure</div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if present
    const existingModal = document.getElementById('uploadModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('uploadModal'));
    modal.show();
}

function uploadFiles_modal(projectId, isDirectory) {
    // Hide modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('uploadModal'));
    modal.hide();
    
    // Create file input dynamically
    const input = document.createElement('input');
    input.type = 'file';
    input.multiple = true;
    
    if (isDirectory) {
        input.webkitdirectory = true;
        input.directory = true;
    }
    
    input.onchange = (e) => {
        const files = e.target.files;
        if (files.length > 0) {
            uploadFiles(projectId, files, isDirectory);
        }
    };
    input.click();
}

function uploadFiles(projectId, files, isDirectory = false) {
    const formData = new FormData();
    
    // Show progress notification
    const progressMessage = isDirectory ? 
        `Uploading directory with ${files.length} files...` :
        `Uploading ${files.length} file(s)...`;
    showNotification(progressMessage, 'info');
    
    Array.from(files).forEach(file => {
        formData.append('files', file);
    });
    
    formData.append('category', currentPath ? currentPath.split('/')[0] : 'data');
    
    // Add preserve_structure flag for directory uploads
    if (isDirectory) {
        formData.append('preserve_structure', 'true');
    }
    
    fetch(`/core/directory/projects/${projectId}/upload/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            loadProjectFiles(projectId);
            
            let successMessage = data.message;
            if (data.directories_created && data.directories_created.length > 0) {
                successMessage += `\\nDirectories created: ${data.directories_created.length}`;
            }
            
            showNotification(successMessage, 'success');
        } else {
            showNotification('Error uploading files: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error uploading files:', error);
        showNotification('Error uploading files', 'error');
    });
}

function downloadFile(projectId, filePath) {
    window.open(`/core/directory/projects/${projectId}/download/?file=${encodeURIComponent(filePath)}`, '_blank');
}

function downloadProjectZip(projectId) {
    window.open(`/core/directory/projects/${projectId}/download/?format=zip`, '_blank');
}

function deleteFile(projectId, filePath) {
    if (confirm('Are you sure you want to delete this file?')) {
        fetch(`/core/directory/projects/${projectId}/delete-file/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                file_path: filePath
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                loadProjectFiles(projectId);
                showNotification('File deleted successfully!', 'success');
            } else {
                showNotification('Error deleting file: ' + data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error deleting file:', error);
            showNotification('Error deleting file', 'error');
        });
    }
}

function refreshProjectFiles(projectId) {
    loadProjectFiles(projectId);
    showNotification('Files refreshed', 'info');
}

function openProjectSettings(projectId) {
    // TODO: Open project settings modal
    showNotification('Project settings - Coming soon!', 'info');
}

function showNotification(message, type = 'info') {
    // Simple notification system
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'error' ? 'danger' : type} position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
    `;
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentElement) {
            notification.remove();
        }
    }, 5000);
}

// Enhanced file search and filtering functionality
let currentFileFilter = 'all';
let currentSearchTerm = '';

function initializeFileSearch() {
    // File search functionality
    const searchInput = document.getElementById('fileSearch');
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            currentSearchTerm = e.target.value.toLowerCase();
            applyFileFilters();
        });
    }
    
    // File type filters
    document.querySelectorAll('.file-filter').forEach(button => {
        button.addEventListener('click', (e) => {
            // Remove active class from all filters
            document.querySelectorAll('.file-filter').forEach(btn => btn.classList.remove('active'));
            // Add active class to clicked filter
            e.target.classList.add('active');
            
            currentFileFilter = e.target.getAttribute('data-filter');
            applyFileFilters();
        });
    });
    
    // View mode controls
    document.querySelectorAll('.view-mode').forEach(button => {
        button.addEventListener('click', (e) => {
            document.querySelectorAll('.view-mode').forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');
            
            const viewMode = e.target.getAttribute('data-view');
            switchViewMode(viewMode);
        });
    });
}

function applyFileFilters() {
    const activeProject = document.querySelector('.nav-tabs .nav-link.active');
    if (!activeProject) return;
    
    const projectId = activeProject.getAttribute('data-bs-target').replace('#project-', '');
    if (projectId) {
        loadProjectFiles(parseInt(projectId));
    }
}

function switchViewMode(mode) {
    // Toggle between list and grid view
    const fileLists = document.querySelectorAll('.file-list-enhanced');
    fileLists.forEach(list => {
        if (mode === 'grid') {
            list.classList.add('grid-view');
        } else {
            list.classList.remove('grid-view');
        }
    });
}

function previewFileContent(projectId, filePath, fileName) {
    const previewContainer = document.getElementById(`filePreview-${projectId}`);
    if (!previewContainer) return;
    
    // Show loading state
    previewContainer.innerHTML = `
        <div class="text-center p-4">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>Loading preview...</p>
        </div>
    `;
    
    // Get file extension
    const ext = fileName.toLowerCase().split('.').pop();
    const isImage = ['png', 'jpg', 'jpeg', 'gif', 'svg'].includes(ext);
    const isText = ['txt', 'md', 'py', 'js', 'css', 'html', 'json', 'xml', 'yml', 'yaml', 'csv', 'r'].includes(ext);
    
    if (isImage) {
        // Preview image files
        previewContainer.innerHTML = `
            <div class="p-3">
                <h6 class="mb-3">${fileName}</h6>
                <div class="text-center">
                    <img src="/core/directory/projects/${projectId}/download/?file=${encodeURIComponent(filePath)}" 
                         class="img-fluid border rounded" style="max-height: 300px;" alt="${fileName}">
                </div>
                <div class="mt-3">
                    <button class="btn btn-sm btn-outline-primary w-100" onclick="downloadFile(${projectId}, '${filePath}')">
                        <i class="fas fa-download"></i> Download
                    </button>
                </div>
            </div>
        `;
    } else if (isText) {
        // Preview text files
        fetch(`/core/directory/projects/${projectId}/preview/?file=${encodeURIComponent(filePath)}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    previewContainer.innerHTML = `
                        <div class="p-3">
                            <h6 class="mb-3">${fileName}</h6>
                            <div class="file-content-preview">
                                <pre class="bg-light p-3 border rounded" style="max-height: 400px; overflow: auto; font-size: 0.8rem;">${data.content}</pre>
                            </div>
                            <div class="mt-3">
                                <button class="btn btn-sm btn-outline-primary w-100" onclick="downloadFile(${projectId}, '${filePath}')">
                                    <i class="fas fa-download"></i> Download
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    showFileInfo(projectId, filePath, fileName);
                }
            })
            .catch(error => {
                console.error('Error loading preview:', error);
                showFileInfo(projectId, filePath, fileName);
            });
    } else {
        // Show file info for unsupported types
        showFileInfo(projectId, filePath, fileName);
    }
}

function showFileInfo(projectId, filePath, fileName) {
    const previewContainer = document.getElementById(`filePreview-${projectId}`);
    if (!previewContainer) return;
    
    const ext = fileName.toLowerCase().split('.').pop();
    const icon = getFileIcon(fileName);
    
    previewContainer.innerHTML = `
        <div class="p-3">
            <div class="text-center mb-4">
                <i class="${icon} fa-3x mb-3"></i>
                <h6>${fileName}</h6>
                <small class="text-muted">.${ext.toUpperCase()} file</small>
            </div>
            <div class="file-actions-preview">
                <button class="btn btn-sm btn-outline-primary w-100 mb-2" onclick="downloadFile(${projectId}, '${filePath}')">
                    <i class="fas fa-download"></i> Download
                </button>
                <button class="btn btn-sm btn-outline-secondary w-100 mb-2" onclick="copyFilePath('${filePath}')">
                    <i class="fas fa-copy"></i> Copy Path
                </button>
                <button class="btn btn-sm btn-outline-danger w-100" onclick="deleteFile(${projectId}, '${filePath}')">
                    <i class="fas fa-trash"></i> Delete
                </button>
            </div>
        </div>
    `;
}

function copyFilePath(filePath) {
    navigator.clipboard.writeText(filePath).then(() => {
        showNotification('File path copied to clipboard!', 'success');
    }).catch(err => {
        console.error('Failed to copy: ', err);
        showNotification('Failed to copy file path', 'error');
    });
}

function createNewFile(projectId) {
    const fileName = prompt('Enter file name (with extension):');
    if (!fileName) return;
    
    const activeTab = document.querySelector(`#project-${projectId} .tree-item.active`);
    const currentPath = activeTab ? activeTab.getAttribute('data-path') : '';
    
    fetch(`/core/directory/projects/${projectId}/create-file/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            file_name: fileName,
            path: currentPath,
            content: ''
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            loadProjectFiles(projectId);
            showNotification('File created successfully!', 'success');
        } else {
            showNotification('Error creating file: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error creating file:', error);
        showNotification('Error creating file', 'error');
    });
}

function createNewFolder(projectId) {
    const folderName = prompt('Enter folder name:');
    if (!folderName) return;
    
    const activeTab = document.querySelector(`#project-${projectId} .tree-item.active`);
    const currentPath = activeTab ? activeTab.getAttribute('data-path') : '';
    
    fetch(`/core/directory/projects/${projectId}/create-folder/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            folder_name: folderName,
            path: currentPath
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            loadProjectFiles(projectId);
            showNotification('Folder created successfully!', 'success');
        } else {
            showNotification('Error creating folder: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error creating folder:', error);
        showNotification('Error creating folder', 'error');
    });
}

function openProjectWriter(projectId) {
    // Open the project-linked Writer interface
    window.open(`/writer/project/${projectId}/`, '_blank');
}

// Create example projects
function createExampleProject(template) {
    let projectData;
    
    switch (template) {
        case 'mnist':
            projectData = {
                name: 'MNIST Classification',
                description: 'Complete machine learning example with MNIST digit classification using SVM, including data processing, model training, and comprehensive visualization.',
                hypotheses: 'Support Vector Machines can effectively classify handwritten digits with high accuracy. Data preprocessing and dimensionality reduction will improve classification performance.',
                source_code_url: '',
                status: 'active',
                progress: 0,
                create_default_structure: true,
                template_type: 'mnist_example'
            };
            break;
        case 'research':
            projectData = {
                name: 'Academic Research Project',
                description: 'Standard academic research project structure with data collection, analysis, and publication workflow.',
                hypotheses: 'Structured research methodology will lead to reproducible results and clear publication pathway.',
                source_code_url: '',
                status: 'planning',
                progress: 0,
                create_default_structure: true,
                template_type: 'research_template'
            };
            break;
        default:
            createNewProject();
            return;
    }
    
    fetch('/core/api/v1/projects/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(projectData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(`${projectData.name} created successfully!`, 'success');
            // If MNIST example, populate with demo files
            if (template === 'mnist') {
                populateMNISTExample(data.project_id);
            }
            setTimeout(() => location.reload(), 1500);
        } else {
            showNotification('Error creating project: ' + (data.error || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error creating project', 'error');
    });
}

function populateMNISTExample(projectId) {
    // Create example files for the MNIST project
    const exampleFiles = [
        {
            path: 'config/MNIST.yaml',
            content: `# MNIST Dataset Configuration
dataset: MNIST
batch_size: 64
epochs: 10
learning_rate: 0.001
test_split: 0.2
random_state: 42

# SVM Parameters
svm:
  C: 1.0
  kernel: rbf
  gamma: scale

# UMAP Parameters
umap:
  n_neighbors: 15
  min_dist: 0.1
  n_components: 2
`
        },
        {
            path: 'config/PATH.yaml',
            content: `# Path Configuration
data_root: ./data/mnist
output_root: ./scripts/mnist
figures_root: ./data/mnist/figures
raw_data: ./data/mnist/raw
processed_data: ./data/mnist/processed

# Script Outputs
script_outputs:
  download: ./scripts/mnist/download_out
  classification: ./scripts/mnist/clf_svm_out
  confusion_matrix: ./scripts/mnist/plot_conf_mat_out
  digits_plot: ./scripts/mnist/plot_digits_out
  umap_plot: ./scripts/mnist/plot_umap_space_out
`
        },
        {
            path: 'scripts/mnist/download.py',
            content: `#!/usr/bin/env python3
"""
MNIST Data Download and Preprocessing Script
Downloads MNIST dataset and prepares it for analysis.
"""
import os
import numpy as np
from sklearn.datasets import fetch_openml
import yaml

def load_config():
    """Load configuration from YAML files."""
    with open('config/MNIST.yaml', 'r') as f:
        mnist_config = yaml.safe_load(f)
    with open('config/PATH.yaml', 'r') as f:
        path_config = yaml.safe_load(f)
    return mnist_config, path_config

def download_mnist_data():
    """Download and save MNIST dataset."""
    print("Downloading MNIST dataset...")
    mnist = fetch_openml('mnist_784', version=1, as_frame=False)
    
    # Create directories
    os.makedirs('data/mnist/raw', exist_ok=True)
    os.makedirs('data/mnist/processed', exist_ok=True)
    
    # Save raw data
    np.save('data/mnist/raw/mnist_data.npy', mnist.data)
    np.save('data/mnist/raw/mnist_target.npy', mnist.target.astype(int))
    
    print(f"Dataset shape: {mnist.data.shape}")
    print(f"Labels shape: {mnist.target.shape}")
    print("MNIST data saved successfully!")
    
    return mnist.data, mnist.target.astype(int)

if __name__ == "__main__":
    # Create output directory
    os.makedirs('scripts/mnist/download_out', exist_ok=True)
    
    # Load configuration
    mnist_config, path_config = load_config()
    
    # Download data
    X, y = download_mnist_data()
    
    # Create completion marker
    with open('scripts/mnist/download_out/FINISHED_SUCCESS', 'w') as f:
        f.write(f"Download completed at: {np.datetime64('now')}\\n")
        f.write(f"Dataset size: {X.shape[0]} samples\\n")
        f.write(f"Feature dimensions: {X.shape[1]}\\n")
    
    print("âœ… Download script completed successfully!")
`
        },
        {
            path: 'scripts/mnist/clf_svm.py',
            content: `#!/usr/bin/env python3
"""
MNIST SVM Classification Script
Trains SVM classifier on MNIST data and evaluates performance.
"""
import os
import numpy as np
import yaml
from sklearn.svm import SVC
from sklearn.model_selection import train_test_split
from sklearn.metrics import accuracy_score, classification_report
import joblib

def load_mnist_data():
    """Load preprocessed MNIST data."""
    X = np.load('data/mnist/raw/mnist_data.npy')
    y = np.load('data/mnist/raw/mnist_target.npy')
    return X, y

def train_svm_classifier(X, y, config):
    """Train SVM classifier."""
    print("Training SVM classifier...")
    
    # Split data
    X_train, X_test, y_train, y_test = train_test_split(
        X, y, test_size=config['test_split'], 
        random_state=config['random_state']
    )
    
    # Normalize data
    X_train = X_train / 255.0
    X_test = X_test / 255.0
    
    # Train SVM
    svm = SVC(**config['svm'])
    svm.fit(X_train, y_train)
    
    # Evaluate
    train_acc = accuracy_score(y_train, svm.predict(X_train))
    test_acc = accuracy_score(y_test, svm.predict(X_test))
    
    print(f"Training Accuracy: {train_acc:.4f}")
    print(f"Test Accuracy: {test_acc:.4f}")
    
    # Save model
    os.makedirs('data/mnist/models', exist_ok=True)
    joblib.dump(svm, 'data/mnist/models/svm_classifier.pkl')
    
    return svm, X_test, y_test, test_acc

if __name__ == "__main__":
    # Create output directory
    os.makedirs('scripts/mnist/clf_svm_out', exist_ok=True)
    
    # Load data and config
    X, y = load_mnist_data()
    with open('config/MNIST.yaml', 'r') as f:
        config = yaml.safe_load(f)
    
    # Train classifier
    model, X_test, y_test, accuracy = train_svm_classifier(X, y, config)
    
    # Create completion marker
    with open('scripts/mnist/clf_svm_out/FINISHED_SUCCESS', 'w') as f:
        f.write(f"Classification completed at: {np.datetime64('now')}\\n")
        f.write(f"Test Accuracy: {accuracy:.4f}\\n")
        f.write(f"Model saved: data/mnist/models/svm_classifier.pkl\\n")
    
    print("âœ… SVM classification completed successfully!")
`
        }
    ];
    
    // Upload example files
    exampleFiles.forEach(file => {
        fetch(`/core/directory/projects/${projectId}/create-file/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                file_name: file.path.split('/').pop(),
                path: file.path.substring(0, file.path.lastIndexOf('/')),
                content: file.content
            })
        })
        .catch(error => console.log('File creation error:', error));
    });
}

function getScriptStatus(projectId, scriptPath) {
    // Check for script execution status
    fetch(`/core/directory/projects/${projectId}/script-status/?script=${encodeURIComponent(scriptPath)}`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                updateScriptStatusUI(projectId, scriptPath, data.execution_status);
            }
        })
        .catch(error => console.log('Status check error:', error));
}

function updateScriptStatusUI(projectId, scriptPath, status) {
    const statusElement = document.querySelector(`[data-script="${scriptPath}"] .script-status`);
    if (!statusElement) return;
    
    let statusHtml = '';
    switch (status) {
        case 'running':
            statusHtml = '<span class="status-dot running"></span><span>Running</span>';
            break;
        case 'completed':
            statusHtml = '<span class="status-dot completed"></span><span>Completed</span>';
            break;
        case 'error':
            statusHtml = '<span class="status-dot error"></span><span>Error</span>';
            break;
        default:
            statusHtml = '<span class="status-dot pending"></span><span>Not run</span>';
    }
    
    statusElement.innerHTML = statusHtml;
}

function runScript(projectId, scriptPath) {
    showNotification(`Running ${scriptPath}...`, 'info');
    
    fetch(`/core/directory/projects/${projectId}/run-script/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            script_path: scriptPath
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showNotification('Script execution started!', 'success');
            updateScriptStatusUI(projectId, scriptPath, 'running');
            // Poll for completion
            setTimeout(() => getScriptStatus(projectId, scriptPath), 2000);
        } else {
            showNotification('Error running script: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error running script', 'error');
    });
}

// Load files for all visible projects on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM Content Loaded');
    
    // Check if modal exists
    const modal = document.getElementById('createProjectModal');
    console.log('Create Project Modal on DOM load:', modal);
    
    // Initialize file search and filtering
    initializeFileSearch();
    
    // Load files for each project tab
    const projectTabs = document.querySelectorAll('[data-bs-toggle="tab"]');
    projectTabs.forEach(tab => {
        const projectId = tab.getAttribute('data-bs-target').replace('#project-', '');
        if (projectId) {
            loadProjectFiles(parseInt(projectId));
            // Check script statuses
            setTimeout(() => checkAllScriptStatuses(parseInt(projectId)), 1000);
        }
    });
});

function checkAllScriptStatuses(projectId) {
    // Check status for common script types
    const commonScripts = [
        'scripts/mnist/download.py',
        'scripts/mnist/clf_svm.py',
        'scripts/mnist/plot_conf_mat.py',
        'scripts/mnist/plot_digits.py',
        'scripts/mnist/plot_umap_space.py'
    ];
    
    commonScripts.forEach(script => {
        getScriptStatus(projectId, script);
    });
}

function closeFileManager() {
    document.getElementById('fileManagerModal').style.display = 'none';
    currentProject = null;
    currentPath = '';
}

function loadProjectStructure() {
    if (!currentProject) return;
    
    fetch(`/core/directory/projects/${currentProject}/structure/`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                renderFolderStructure(data.structure);
            }
        })
        .catch(error => {
            console.error('Error loading project structure:', error);
        });
}

function renderFolderStructure(structure) {
    const container = document.getElementById('folderStructure');
    container.innerHTML = '';
    
    // Standard project folders
    const folders = [
        { name: 'config', icon: 'fas fa-cog', desc: 'Configuration files' },
        { name: 'data', icon: 'fas fa-database', desc: 'Research data', 
          subfolders: ['raw', 'processed', 'figures', 'models'] },
        { name: 'scripts', icon: 'fas fa-file-code', desc: 'Source code' },
        { name: 'docs', icon: 'fas fa-book', desc: 'Documentation',
          subfolders: ['manuscripts', 'notes', 'references'] },
        { name: 'results', icon: 'fas fa-chart-line', desc: 'Analysis results',
          subfolders: ['outputs', 'reports', 'analysis'] },
        { name: 'temp', icon: 'fas fa-clock', desc: 'Temporary files',
          subfolders: ['cache', 'logs', 'tmp'] }
    ];
    
    folders.forEach(folder => {
        const li = document.createElement('li');
        li.className = 'folder-item' + (currentPath === folder.name ? ' active' : '');
        li.innerHTML = `
            <i class="${folder.icon}"></i>
            ${folder.name}
        `;
        li.onclick = () => navigateToFolder(folder.name);
        container.appendChild(li);
        
        // Add subfolders if they exist
        if (folder.subfolders) {
            folder.subfolders.forEach(subfolder => {
                const subLi = document.createElement('li');
                subLi.className = 'folder-item';
                subLi.style.paddingLeft = '2rem';
                subLi.innerHTML = `
                    <i class="fas fa-folder"></i>
                    ${subfolder}
                `;
                subLi.onclick = () => navigateToFolder(`${folder.name}/${subfolder}`);
                container.appendChild(subLi);
            });
        }
    });
}

function navigateToFolder(path) {
    currentPath = path;
    updateBreadcrumb();
    loadProjectFiles();
    
    // Update active folder in sidebar
    document.querySelectorAll('.folder-item').forEach(item => {
        item.classList.remove('active');
    });
    event.target.classList.add('active');
}

function updateBreadcrumb() {
    const breadcrumb = document.getElementById('breadcrumb');
    if (currentPath) {
        breadcrumb.textContent = `~/projects/${currentPath}/`;
    } else {
        breadcrumb.textContent = '~/projects/';
    }
}

function loadProjectFiles() {
    if (!currentProject) return;
    
    const url = currentPath 
        ? `/core/directory/projects/${currentProject}/files/?category=${currentPath.split('/')[0]}`
        : `/core/directory/projects/${currentProject}/files/`;
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                renderFileList(data.files);
            }
        })
        .catch(error => {
            console.error('Error loading project files:', error);
        });
}

function renderFileList(files) {
    const container = document.getElementById('fileList');
    const uploadZone = container.querySelector('#uploadZone');
    
    // Clear existing files (but keep upload zone)
    const existingFiles = container.querySelectorAll('.file-item');
    existingFiles.forEach(item => item.remove());
    
    if (files.length === 0) {
        const emptyState = document.createElement('div');
        emptyState.className = 'empty-state';
        emptyState.innerHTML = `
            <div class="empty-state-icon">
                <i class="fas fa-folder-open"></i>
            </div>
            <h3 class="empty-state-title">No files in this directory</h3>
            <p class="empty-state-desc">Upload files or create new ones to get started.</p>
        `;
        container.appendChild(emptyState);
        return;
    }
    
    files.forEach(file => {
        const fileElement = document.createElement('div');
        fileElement.className = 'file-item';
        
        const icon = getFileIcon(file.name, file.category);
        const size = formatFileSize(file.size);
        const date = new Date(file.modified).toLocaleDateString();
        
        let statusBadge = '';
        if (file.category === 'scripts' && file.name.endsWith('.py')) {
            // Check for execution status (would need to be provided by backend)
            statusBadge = `<span class="script-execution-status success">Ready</span>`;
        }
        
        fileElement.innerHTML = `
            <div class="file-item-icon ${file.category === 'scripts' ? 'directory' : ''}">
                <i class="${icon}"></i>
            </div>
            <div class="file-item-content">
                <div class="file-item-name">${file.name} ${statusBadge}</div>
                <div class="file-item-meta">${size} â€¢ ${date} â€¢ ${file.category}</div>
            </div>
            <div class="file-item-actions">
                <button class="file-item-action" onclick="downloadFile('${file.path}')" title="Download">
                    <i class="fas fa-download"></i>
                </button>
                <button class="file-item-action" onclick="previewFile('${file.path}')" title="Preview">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="file-item-action" onclick="deleteFile('${file.path}')" title="Delete">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        
        container.appendChild(fileElement);
    });
}

function getFileIcon(filename, category) {
    const ext = filename.toLowerCase().split('.').pop();
    
    const iconMap = {
        // Code files
        'py': 'fab fa-python',
        'js': 'fab fa-js-square',
        'ts': 'fab fa-js-square',
        'r': 'fab fa-r-project',
        'ipynb': 'fas fa-file-code',
        
        // Data files
        'csv': 'fas fa-table',
        'xlsx': 'fas fa-file-excel',
        'json': 'fas fa-file-code',
        'xml': 'fas fa-file-code',
        'pkl': 'fas fa-database',
        'h5': 'fas fa-database',
        
        // Images
        'png': 'fas fa-image',
        'jpg': 'fas fa-image',
        'jpeg': 'fas fa-image',
        'svg': 'fas fa-image',
        'pdf': 'fas fa-file-pdf',
        
        // Documents
        'md': 'fab fa-markdown',
        'tex': 'fas fa-file-alt',
        'txt': 'fas fa-file-alt',
        'doc': 'fas fa-file-word',
        'docx': 'fas fa-file-word',
        
        // Config
        'yaml': 'fas fa-cog',
        'yml': 'fas fa-cog',
        'ini': 'fas fa-cog',
        'conf': 'fas fa-cog',
        
        // Logs
        'log': 'fas fa-file-alt'
    };
    
    return iconMap[ext] || 'fas fa-file';
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

function refreshFiles() {
    loadProjectFiles();
}

function downloadProject() {
    if (!currentProject) return;
    
    // Create a download link for the project ZIP
    window.location.href = `/core/directory/projects/${currentProject}/download/?format=zip`;
}

function syncWithGithub() {
    if (!currentProject) return;
    
    // Get GitHub URL from user
    const githubUrl = prompt('Enter GitHub repository URL (optional for init):');
    const action = prompt('Enter action (init, clone, push, pull):', 'init');
    
    if (!action) return;
    
    fetch(`/core/directory/projects/${currentProject}/github/sync/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            github_url: githubUrl,
            action: action
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            let message = `${data.message}\n\nProject path: ${data.project_path}\n\n`;
            message += `${data.instructions}\n\n`;
            data.git_commands.forEach((cmd, index) => {
                message += `${index + 1}. ${cmd}\n`;
            });
            alert(message);
        } else {
            alert('Error: ' + (data.message || 'GitHub sync failed'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error syncing with GitHub');
    });
}

function showUploadZone() {
    const uploadZone = document.getElementById('uploadZone');
    uploadZone.style.display = uploadZone.style.display === 'none' ? 'block' : 'none';
}

function downloadFile(filePath) {
    if (!currentProject) return;
    window.location.href = `/core/directory/projects/${currentProject}/download/?file=${encodeURIComponent(filePath)}`;
}

function previewFile(filePath) {
    // This would open a file preview modal
    alert(`Preview for ${filePath} coming soon!`);
}

function deleteFile(filePath) {
    if (!currentProject) return;
    
    if (confirm(`Are you sure you want to delete ${filePath}?`)) {
        fetch(`/core/directory/projects/${currentProject}/delete-file/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                file_path: filePath
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                loadProjectFiles(); // Refresh the file list
            } else {
                alert('Error deleting file: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting file');
        });
    }
}

// File upload handling
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('fileInput');
    const uploadZone = document.getElementById('uploadZone');
    
    if (fileInput) {
        fileInput.addEventListener('change', handleFileUpload);
    }
    
    if (uploadZone) {
        // Drag and drop functionality
        uploadZone.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });
        
        uploadZone.addEventListener('dragleave', function(e) {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
        });
        
        uploadZone.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            
            const files = Array.from(e.dataTransfer.files);
            uploadFiles(files);
        });
    }
});

function handleFileUpload(event) {
    const files = Array.from(event.target.files);
    uploadFiles(files);
}

function uploadFiles(files) {
    if (!currentProject || files.length === 0) return;
    
    const formData = new FormData();
    files.forEach(file => {
        formData.append('files', file);
    });
    formData.append('category', currentPath.split('/')[0] || 'data');
    
    fetch(`/core/directory/projects/${currentProject}/upload/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            loadProjectFiles(); // Refresh the file list
            showUploadZone(); // Hide upload zone
            document.getElementById('fileInput').value = ''; // Reset file input
        } else {
            alert('Error uploading files: ' + (data.message || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error uploading files');
    });
}

// Close modals when clicking outside
document.addEventListener('click', function(event) {
    const fileManagerModal = document.getElementById('fileManagerModal');
    const createProjectModal = document.getElementById('createProjectModal');
    
    if (event.target === fileManagerModal) {
        closeFileManager();
    }
    
    if (event.target === createProjectModal) {
        closeCreateProjectModal();
    }
});

// GitHub Integration Functions
let currentSelectedProject = null;

function showGitHubPanel() {
    const panel = document.getElementById('githubPanel');
    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    
    // Load GitHub status for current project
    if (currentSelectedProject) {
        loadGitHubStatus(currentSelectedProject);
    }
}

function hideGitHubPanel() {
    document.getElementById('githubPanel').style.display = 'none';
}

function selectProject(projectId, projectName) {
    currentSelectedProject = projectId;
    
    // Update UI to show selected project
    document.querySelectorAll('.directory-item').forEach(item => {
        item.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Load files for selected project
    loadProjectFiles(projectId);
    
    // If GitHub panel is open, update status
    const panel = document.getElementById('githubPanel');
    if (panel.style.display !== 'none') {
        loadGitHubStatus(projectId);
    }
}

function loadGitHubStatus(projectId) {
    fetch(`/core/api/v1/github/projects/${projectId}/status/`)
        .then(response => response.json())
        .then(data => {
            updateGitHubStatusUI(data);
        })
        .catch(error => {
            console.error('Error loading GitHub status:', error);
            updateGitHubStatusUI({connected: false, status: 'error'});
        });
}

function updateGitHubStatusUI(statusData) {
    const statusDiv = document.getElementById('githubStatus');
    const connectBtn = document.querySelector('[onclick="connectGitHub()"]');
    const createRepoBtn = document.getElementById('createRepoBtn');
    const linkRepoBtn = document.getElementById('linkRepoBtn');
    const syncBtn = document.getElementById('syncBtn');
    const commitBtn = document.getElementById('commitBtn');
    const gitStatusFiles = document.getElementById('gitStatusFiles');
    
    if (statusData.connected) {
        statusDiv.innerHTML = `
            <div class="github-status-indicator">
                <span class="badge bg-success">Connected</span>
                <small class="text-muted ms-2">
                    <i class="fab fa-github me-1"></i>
                    <a href="${statusData.repository_url}" target="_blank" class="text-decoration-none">
                        ${statusData.repository_url.split('/').slice(-2).join('/')}
                    </a>
                    â€¢ Branch: ${statusData.current_branch}
                </small>
            </div>
        `;
        
        connectBtn.style.display = 'none';
        createRepoBtn.style.display = 'none';
        linkRepoBtn.style.display = 'none';
        syncBtn.style.display = 'inline-block';
        commitBtn.style.display = 'inline-block';
        
        // Show file stats if available
        if (statusData.file_stats) {
            gitStatusFiles.style.display = 'block';
            updateGitFilesList(statusData.file_stats);
        }
    } else {
        statusDiv.innerHTML = `
            <div class="github-status-indicator">
                <span class="badge bg-secondary">Not Connected</span>
                <small class="text-muted ms-2">Connect your project to GitHub for version control</small>
            </div>
        `;
        
        connectBtn.style.display = 'inline-block';
        createRepoBtn.style.display = 'none';
        linkRepoBtn.style.display = 'none';
        syncBtn.style.display = 'none';
        commitBtn.style.display = 'none';
        gitStatusFiles.style.display = 'none';
    }
}

function updateGitFilesList(fileStats) {
    const filesList = document.getElementById('gitFilesList');
    let html = `
        <div class="row text-center mb-2">
            <div class="col-3"><small class="text-muted">Total: ${fileStats.total_files}</small></div>
            <div class="col-3"><small class="text-warning">Modified: ${fileStats.modified}</small></div>
            <div class="col-3"><small class="text-info">Untracked: ${fileStats.untracked}</small></div>
            <div class="col-3"><small class="text-success">Staged: ${fileStats.staged}</small></div>
        </div>
    `;
    filesList.innerHTML = html;
}

function connectGitHub() {
    if (!currentSelectedProject) {
        showNotification('Please select a project first', 'warning');
        return;
    }
    
    fetch('/core/api/v1/github/oauth/initiate/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: new URLSearchParams({
            'project_id': currentSelectedProject
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Redirect to GitHub OAuth
            window.location.href = data.oauth_url;
        } else {
            showNotification('Error initiating GitHub connection: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error connecting to GitHub', 'error');
    });
}

function createGitHubRepo() {
    if (!currentSelectedProject) {
        showNotification('Please select a project first', 'warning');
        return;
    }
    
    const repoName = prompt('Enter repository name:');
    const isPrivate = confirm('Make repository private?');
    const description = prompt('Enter repository description (optional):');
    
    if (!repoName) return;
    
    fetch('/core/api/v1/github/create-repo/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: new URLSearchParams({
            'project_id': currentSelectedProject,
            'repo_name': repoName,
            'is_private': isPrivate,
            'description': description || ''
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Repository created successfully!', 'success');
            loadGitHubStatus(currentSelectedProject);
        } else {
            showNotification('Error creating repository: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error creating repository', 'error');
    });
}

function linkGitHubRepo() {
    if (!currentSelectedProject) {
        showNotification('Please select a project first', 'warning');
        return;
    }
    
    const repoUrl = prompt('Enter GitHub repository URL:');
    if (!repoUrl) return;
    
    fetch('/core/api/v1/github/link-repo/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: new URLSearchParams({
            'project_id': currentSelectedProject,
            'repo_url': repoUrl
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Repository linked successfully!', 'success');
            loadGitHubStatus(currentSelectedProject);
        } else {
            showNotification('Error linking repository: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error linking repository', 'error');
    });
}

function syncGitStatus() {
    if (!currentSelectedProject) {
        showNotification('Please select a project first', 'warning');
        return;
    }
    
    showNotification('Syncing Git status...', 'info');
    
    fetch(`/core/api/v1/github/projects/${currentSelectedProject}/sync/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(`Git status synced! ${data.files_updated} files updated`, 'success');
            loadGitHubStatus(currentSelectedProject);
            
            // Update file list with git status indicators
            if (data.files && data.files.length > 0) {
                updateFileListWithGitStatus(data.files);
            }
        } else {
            showNotification('Error syncing Git status: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error syncing Git status', 'error');
    });
}

function updateFileListWithGitStatus(gitFiles) {
    // Add git status indicators to file items in the file list
    gitFiles.forEach(file => {
        const fileItems = document.querySelectorAll('.enhanced-file-item');
        fileItems.forEach(item => {
            const fileName = item.querySelector('.file-name');
            if (fileName && fileName.textContent.includes(file.path.split('/').pop())) {
                const statusIcon = document.createElement('i');
                statusIcon.className = file.icon + ' ms-2';
                statusIcon.title = `Git status: ${file.status}`;
                fileName.appendChild(statusIcon);
            }
        });
    });
}

function commitChanges() {
    if (!currentSelectedProject) {
        showNotification('Please select a project first', 'warning');
        return;
    }
    
    const commitMessage = prompt('Enter commit message:');
    if (!commitMessage) return;
    
    showNotification('Committing changes...', 'info');
    
    fetch(`/core/api/v1/github/projects/${currentSelectedProject}/commit/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: new URLSearchParams({
            'commit_message': commitMessage
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Changes committed successfully!', 'success');
            
            // Ask if user wants to push
            if (confirm('Commit successful! Push changes to GitHub?')) {
                pushChanges();
            } else {
                loadGitHubStatus(currentSelectedProject);
            }
        } else {
            showNotification('Error committing changes: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error committing changes', 'error');
    });
}

function pushChanges() {
    if (!currentSelectedProject) {
        showNotification('Please select a project first', 'warning');
        return;
    }
    
    showNotification('Pushing changes to GitHub...', 'info');
    
    fetch(`/core/api/v1/github/projects/${currentSelectedProject}/push/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Changes pushed to GitHub successfully!', 'success');
            loadGitHubStatus(currentSelectedProject);
        } else {
            showNotification('Error pushing changes: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error pushing changes', 'error');
    });
}

// GitHub Sync Functionality
function showGitHubSync(projectId) {
    // Create GitHub sync modal
    const modalHtml = `
        <div class="modal fade" id="githubSyncModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fab fa-github me-2"></i>GitHub Sync
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div id="githubSyncContent">
                            <div class="text-center">
                                <div class="spinner-border text-primary mb-3" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p>Checking Git status...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if present
    const existingModal = document.getElementById('githubSyncModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('githubSyncModal'));
    modal.show();
    
    // Load Git status
    loadGitStatus(projectId);
}

function loadGitStatus(projectId) {
    fetch(`/core/directory/projects/${projectId}/github/sync/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            action: 'status'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            renderGitHubInterface(projectId, data);
        } else {
            renderGitHubInterface(projectId, null, data.message);
        }
    })
    .catch(error => {
        console.error('Error loading Git status:', error);
        renderGitHubInterface(projectId, null, 'Error loading Git status');
    });
}

function renderGitHubInterface(projectId, gitData, errorMessage) {
    const content = document.getElementById('githubSyncContent');
    
    if (errorMessage) {
        content.innerHTML = `
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                ${errorMessage}
            </div>
            <div class="text-center">
                <button class="btn btn-primary" onclick="initializeGitRepo(${projectId})">
                    <i class="fas fa-rocket me-2"></i>Initialize Git Repository
                </button>
            </div>
        `;
        return;
    }
    
    const isGitRepo = gitData && gitData.git_status !== 'Not initialized';
    const hasRemote = gitData && gitData.remote_url;
    
    content.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Repository Status</h6>
                    </div>
                    <div class="card-body">
                        <p><strong>Status:</strong> <span class="badge ${isGitRepo ? 'bg-success' : 'bg-secondary'}">${isGitRepo ? 'Initialized' : 'Not initialized'}</span></p>
                        ${isGitRepo ? `
                            <p><strong>Branch:</strong> ${gitData.current_branch || 'main'}</p>
                            <p><strong>Changes:</strong> ${gitData.git_status || 'Working directory clean'}</p>
                            ${hasRemote ? `<p><strong>Remote:</strong> <a href="${gitData.remote_url}" target="_blank">${gitData.remote_url}</a></p>` : '<p><strong>Remote:</strong> Not configured</p>'}
                        ` : ''}
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-cogs me-2"></i>Actions</h6>
                    </div>
                    <div class="card-body">
                        ${!isGitRepo ? `
                            <button class="btn btn-primary w-100 mb-2" onclick="initializeGitRepo(${projectId})">
                                <i class="fas fa-rocket me-2"></i>Initialize Git
                            </button>
                        ` : `
                            <button class="btn btn-success w-100 mb-2" onclick="commitAndPush(${projectId})" ${!hasRemote ? 'disabled' : ''}>
                                <i class="fas fa-upload me-2"></i>Commit & Push
                            </button>
                            <button class="btn btn-info w-100 mb-2" onclick="pullChanges(${projectId})" ${!hasRemote ? 'disabled' : ''}>
                                <i class="fas fa-download me-2"></i>Pull Changes
                            </button>
                            <button class="btn btn-secondary w-100 mb-2" onclick="loadGitStatus(${projectId})">
                                <i class="fas fa-sync me-2"></i>Refresh Status
                            </button>
                        `}
                    </div>
                </div>
            </div>
        </div>
        
        ${!hasRemote && isGitRepo ? `
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fab fa-github me-2"></i>Connect to GitHub</h6>
                </div>
                <div class="card-body">
                    <div class="input-group mb-3">
                        <input type="url" id="githubUrl" class="form-control" 
                               placeholder="https://github.com/username/repository.git">
                        <button class="btn btn-outline-primary" onclick="addRemote(${projectId})">
                            <i class="fas fa-link me-2"></i>Add Remote
                        </button>
                    </div>
                    <small class="text-muted">Enter your GitHub repository URL to connect this project.</small>
                </div>
            </div>
        ` : ''}
    `;
}

function initializeGitRepo(projectId) {
    const githubUrl = document.getElementById('githubUrl')?.value || '';
    
    showNotification('Initializing Git repository...', 'info');
    
    fetch(`/core/directory/projects/${projectId}/github/sync/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            action: 'init',
            github_url: githubUrl
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showNotification('Git repository initialized successfully!', 'success');
            loadGitStatus(projectId);
        } else {
            showNotification('Error initializing Git: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error initializing Git repository', 'error');
    });
}

function commitAndPush(projectId) {
    const commitMessage = prompt('Enter commit message:', 'Update project files');
    if (!commitMessage) return;
    
    showNotification('Committing and pushing changes...', 'info');
    
    fetch(`/core/directory/projects/${projectId}/github/sync/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            action: 'push',
            commit_message: commitMessage
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showNotification(data.message, 'success');
            loadGitStatus(projectId);
        } else {
            showNotification('Error: ' + data.message, 'error');
            if (data.suggestion) {
                showNotification('Suggestion: ' + data.suggestion, 'warning');
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error pushing changes', 'error');
    });
}

function pullChanges(projectId) {
    showNotification('Pulling changes from GitHub...', 'info');
    
    fetch(`/core/directory/projects/${projectId}/github/sync/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            action: 'pull'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showNotification(data.message, 'success');
            loadGitStatus(projectId);
            loadProjectFiles(projectId); // Refresh file list
        } else {
            showNotification('Error: ' + data.message, 'error');
            if (data.suggestion) {
                showNotification('Suggestion: ' + data.suggestion, 'warning');
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error pulling changes', 'error');
    });
}

function addRemote(projectId) {
    const githubUrl = document.getElementById('githubUrl').value;
    if (!githubUrl) {
        showNotification('Please enter a GitHub URL', 'warning');
        return;
    }
    
    showNotification('Adding GitHub remote...', 'info');
    
    fetch(`/core/directory/projects/${projectId}/github/sync/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            action: 'init',
            github_url: githubUrl
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showNotification('GitHub remote added successfully!', 'success');
            loadGitStatus(projectId);
        } else {
            showNotification('Error adding remote: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error adding GitHub remote', 'error');
    });
}

// Onboarding System Functions
function startTutorial() {
    showNotification('ðŸŽ“ Welcome to the SciTeX Tutorial!', 'info');
    
    // Start interactive tutorial
    const steps = [
        {
            title: 'Welcome to SciTeX!',
            content: 'Let\'s take a quick tour of the SciTeX platform. This tutorial will show you the key features.',
            target: null,
            position: 'center'
        },
        {
            title: 'Create Your First Project',
            content: 'Click here to create a new research project. Projects help organize your work.',
            target: '.btn-primary',
            position: 'bottom'
        },
        {
            title: 'File Management',
            content: 'Use the file manager to organize your research files, data, and manuscripts.',
            target: '.btn-outline-primary',
            position: 'bottom'
        }
    ];
    
    runTutorialSteps(steps, 0);
}

function runTutorialSteps(steps, currentStep) {
    if (currentStep >= steps.length) {
        showNotification('ðŸŽ‰ Tutorial complete! You\'re ready to start your research.', 'success');
        return;
    }
    
    const step = steps[currentStep];
    const modalHtml = `
        <div id="tutorialModal" class="modal fade show" style="display: block; background: rgba(0,0,0,0.7);">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">${step.title}</h5>
                        <button type="button" class="btn-close btn-close-white" onclick="closeTutorial()"></button>
                    </div>
                    <div class="modal-body">
                        <p>${step.content}</p>
                        <div class="d-flex justify-content-between align-items-center mt-4">
                            <span class="text-muted">Step ${currentStep + 1} of ${steps.length}</span>
                            <div>
                                ${currentStep > 0 ? '<button class="btn btn-outline-secondary me-2" onclick="previousTutorialStep()">Previous</button>' : ''}
                                <button class="btn btn-primary" onclick="nextTutorialStep()">${currentStep === steps.length - 1 ? 'Finish' : 'Next'}</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing tutorial modal
    const existingModal = document.getElementById('tutorialModal');
    if (existingModal) existingModal.remove();
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Store tutorial state
    window.tutorialState = { steps, currentStep };
}

function nextTutorialStep() {
    if (window.tutorialState) {
        runTutorialSteps(window.tutorialState.steps, window.tutorialState.currentStep + 1);
    }
}

function previousTutorialStep() {
    if (window.tutorialState && window.tutorialState.currentStep > 0) {
        runTutorialSteps(window.tutorialState.steps, window.tutorialState.currentStep - 1);
    }
}

function closeTutorial() {
    const modal = document.getElementById('tutorialModal');
    if (modal) modal.remove();
    window.tutorialState = null;
}

function showTemplateSelector() {
    // No popup - just create a simple project
    createNewProject();
}

function closeTemplateSelector() {
    const modal = document.getElementById('templateModal');
    if (modal) modal.remove();
}

function selectTemplate(templateType) {
    closeTemplateSelector();
    showNotification(`Creating project from ${templateType} template...`, 'info');
    createProjectFromTemplate(templateType);
}

function showOnboardingVideo() {
    const modalHtml = `
        <div id="videoModal" class="modal fade show" style="display: block; background: rgba(0,0,0,0.7);">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="fas fa-video me-2"></i>SciTeX Demo</h5>
                        <button type="button" class="btn-close" onclick="closeVideoModal()"></button>
                    </div>
                    <div class="modal-body text-center">
                        <div style="padding: 2rem;">
                            <i class="fas fa-play-circle fa-4x text-primary mb-3"></i>
                            <h5>Demo Video Coming Soon</h5>
                            <p class="text-muted">We're preparing an interactive demo video to showcase SciTeX features.</p>
                            <div class="mt-4">
                                <button class="btn btn-primary me-2" onclick="startTutorial(); closeVideoModal();">Take Interactive Tour Instead</button>
                                <button class="btn btn-outline-secondary" onclick="closeVideoModal();">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function closeVideoModal() {
    const modal = document.getElementById('videoModal');
    if (modal) modal.remove();
}

function openDocumentation() {
    showNotification('ðŸ“š Opening SciTeX documentation...', 'info');
    window.open('/api-docs/', '_blank');
}

function showExampleProjects() {
    const examples = [
        {
            name: 'MNIST Classification',
            description: 'Machine learning project with SVM classification',
            icon: 'fas fa-brain',
            files: ['Python scripts', 'Configuration files', 'Data processing']
        },
        {
            name: 'Research Paper Template',
            description: 'Academic paper with LaTeX structure',
            icon: 'fas fa-file-alt',
            files: ['LaTeX templates', 'Bibliography', 'Figure placeholders']
        },
        {
            name: 'Data Analysis Pipeline',
            description: 'Complete data science workflow',
            icon: 'fas fa-chart-line',
            files: ['Jupyter notebooks', 'Data cleaning', 'Visualization']
        }
    ];
    
    const modalHtml = `
        <div id="examplesModal" class="modal fade show" style="display: block; background: rgba(0,0,0,0.5);">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="fas fa-eye me-2"></i>Example Projects</h5>
                        <button type="button" class="btn-close" onclick="closeExamplesModal()"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row g-3">
                            ${examples.map((example, index) => `
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <div class="d-flex align-items-center mb-3">
                                                <i class="${example.icon} fa-2x text-primary me-3"></i>
                                                <h6 class="card-title mb-0">${example.name}</h6>
                                            </div>
                                            <p class="card-text text-muted small">${example.description}</p>
                                            <div class="mb-3">
                                                <small class="text-muted">Includes:</small>
                                                ${example.files.map(file => `<span class="badge bg-light text-dark ms-1">${file}</span>`).join('')}
                                            </div>
                                            <button class="btn btn-outline-primary btn-sm" onclick="createExampleProject(${index})">
                                                Create This Example
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function closeExamplesModal() {
    const modal = document.getElementById('examplesModal');
    if (modal) modal.remove();
}

function createExampleProject(exampleIndex) {
    const examples = ['mnist', 'research_paper', 'data_analysis'];
    const templateType = examples[exampleIndex];
    
    closeExamplesModal();
    showNotification('Creating example project...', 'info');
    createProjectFromTemplate(templateType);
}
</script>
{% endblock %}