{% load static %}
<!-- GitHub-Style Global Header -->
<header class="github-header">
  <div class="github-header-inner">
    <!-- Left: Logo + Main Navigation -->
    <div class="header-left">
      <!-- Logo -->
      <a href="/" class="header-logo">
        <i class="fas fa-flask"></i>
        <span>SciTeX</span>
      </a>

      <!-- Primary Navigation -->
      <nav class="header-nav">
        {% if user.is_authenticated %}
        <a href="/{{ user.username }}/?tab=repositories"
           class="header-nav-item {% if 'repositories' in request.path or request.GET.tab == 'repositories' %}active{% endif %}">
          <i class="fas fa-book"></i>
          <span class="nav-label">Repositories</span>
        </a>
        {% else %}
        <a href="/explore/?tab=repositories"
           class="header-nav-item {% if 'repositories' in request.path or request.GET.tab == 'repositories' %}active{% endif %}">
          <i class="fas fa-book"></i>
          <span class="nav-label">Repositories</span>
        </a>
        {% endif %}
        {% comment %}
        Module links - Project-centric behavior:
        - If in project context: use ?mode= to switch modules within project
        - If logged in but no project: redirect to repositories page
        - If not logged in: redirect to module landing page
        {% endcomment %}
        {% if user.is_authenticated %}
          {% if project %}
            {# User is in a project - switch modes within project #}
            <a href="/{{ project.owner.username }}/{{ project.slug }}/?mode=scholar"
               class="header-nav-item {% if request.GET.mode == 'scholar' %}active{% endif %}">
              <i class="fas fa-graduation-cap"></i>
              <span class="nav-label">Scholar</span>
            </a>
            <a href="/{{ project.owner.username }}/{{ project.slug }}/?mode=code"
               class="header-nav-item {% if request.GET.mode == 'code' %}active{% endif %}">
              <i class="fas fa-code"></i>
              <span class="nav-label">Code</span>
            </a>
            <a href="/{{ project.owner.username }}/{{ project.slug }}/?mode=viz"
               class="header-nav-item {% if request.GET.mode == 'viz' %}active{% endif %}">
              <i class="fas fa-chart-bar"></i>
              <span class="nav-label">Viz</span>
            </a>
            <a href="/{{ project.owner.username }}/{{ project.slug }}/?mode=writer"
               class="header-nav-item {% if request.GET.mode == 'writer' %}active{% endif %}">
              <i class="fas fa-pen-nib"></i>
              <span class="nav-label">Writer</span>
            </a>
          {% else %}
            {# No repository context - use last active repository if available #}
            {% if user.profile.last_active_repository %}
              <a href="/{{ user.profile.last_active_repository.owner.username }}/{{ user.profile.last_active_repository.slug }}/?mode=scholar"
                 class="header-nav-item">
                <i class="fas fa-graduation-cap"></i>
                <span class="nav-label">Scholar</span>
              </a>
              <a href="/{{ user.profile.last_active_repository.owner.username }}/{{ user.profile.last_active_repository.slug }}/?mode=code"
                 class="header-nav-item">
                <i class="fas fa-code"></i>
                <span class="nav-label">Code</span>
              </a>
              <a href="/{{ user.profile.last_active_repository.owner.username }}/{{ user.profile.last_active_repository.slug }}/?mode=viz"
                 class="header-nav-item">
                <i class="fas fa-chart-bar"></i>
                <span class="nav-label">Viz</span>
              </a>
              <a href="/{{ user.profile.last_active_repository.owner.username }}/{{ user.profile.last_active_repository.slug }}/?mode=writer"
                 class="header-nav-item">
                <i class="fas fa-pen-nib"></i>
                <span class="nav-label">Writer</span>
              </a>
            {% else %}
              {# No last active repository - redirect to repositories #}
              <a href="/{{ user.username }}/?tab=repositories"
                 class="header-nav-item"
                 title="Select a project to use Scholar">
                <i class="fas fa-graduation-cap"></i>
                <span class="nav-label">Scholar</span>
              </a>
              <a href="/{{ user.username }}/?tab=repositories"
                 class="header-nav-item"
                 title="Select a project to use Code">
                <i class="fas fa-code"></i>
                <span class="nav-label">Code</span>
              </a>
              <a href="/{{ user.username }}/?tab=repositories"
                 class="header-nav-item"
                 title="Select a project to use Viz">
                <i class="fas fa-chart-bar"></i>
                <span class="nav-label">Viz</span>
              </a>
              <a href="/{{ user.username }}/?tab=repositories"
                 class="header-nav-item"
                 title="Select a project to use Writer">
                <i class="fas fa-pen-nib"></i>
                <span class="nav-label">Writer</span>
              </a>
            {% endif %}
          {% endif %}
        {% else %}
        <a href="/scholar/"
           class="header-nav-item {% if 'scholar' in request.path %}active{% endif %}">
          <i class="fas fa-graduation-cap"></i>
          <span class="nav-label">Scholar</span>
        </a>
        <a href="/code/"
           class="header-nav-item {% if 'code' in request.path %}active{% endif %}">
          <i class="fas fa-code"></i>
          <span class="nav-label">Code</span>
        </a>
        <a href="/viz/"
           class="header-nav-item {% if 'viz' in request.path %}active{% endif %}">
          <i class="fas fa-chart-bar"></i>
          <span class="nav-label">Viz</span>
        </a>
        <a href="/writer/"
           class="header-nav-item {% if 'writer' in request.path %}active{% endif %}">
          <i class="fas fa-pen-nib"></i>
          <span class="nav-label">Writer</span>
        </a>
        {% endif %}
      </nav>
    </div>

    <!-- Center: Search -->
    <div class="header-center">
      <div class="header-search">
        <i class="fas fa-search header-search-icon"></i>
        <input type="text" placeholder="Search repositories, users..." id="global-search" autocomplete="off">
      </div>
    </div>

    <!-- Right: Actions + User Menu -->
    <div class="header-right">
      <!-- Theme Toggle (always visible) -->
      <button id="theme-toggle" class="theme-toggle" title="Toggle theme">
        ☀️
      </button>

      {% if user.is_authenticated %}
        <!-- New Repository Button (GitHub-style: /new) -->
        <a href="/new/" class="header-btn header-btn-primary" title="Create new repository">
          <i class="fas fa-plus"></i>
          <span class="btn-label">New</span>
        </a>

        <!-- Notifications (future) -->
        <a href="#" class="header-icon-btn" title="Notifications">
          <i class="fas fa-bell"></i>
        </a>

        <!-- User Menu -->
        <div class="header-user-menu">
          <button class="header-user-toggle" id="user-menu-toggle">
            <div class="header-avatar">
              {% if user.profile.avatar %}
                <img src="{{ user.profile.avatar.url }}" alt="{{ user.username }}">
              {% else %}
                {{ user.username|slice:":1"|upper }}
              {% endif %}
            </div>
            <i class="fas fa-caret-down" style="font-size: 12px; margin-left: 4px;"></i>
          </button>

          <div class="header-dropdown" id="user-menu-dropdown" style="display: none;">
            <!-- User Info Header -->
            <div class="dropdown-header">
              <div class="dropdown-user-info">
                <strong>{{ user.get_full_name|default:user.username }}</strong>
                <div class="dropdown-user-username">@{{ user.username }}</div>
              </div>
            </div>
            <div class="dropdown-divider"></div>

            <!-- Settings -->
            <a href="{% url 'profile_app:profile_edit' %}" class="dropdown-item">
              <i class="fas fa-cog"></i>
              Settings
            </a>
            <div class="dropdown-divider"></div>

            <!-- Developer Tools -->
            <a href="/dev/" class="dropdown-item">
              <i class="fas fa-tools"></i>
              Developer Tools
            </a>
            <a href="/dev/design/" class="dropdown-item">
              <i class="fas fa-palette"></i>
              Design System
            </a>
            <div class="dropdown-divider"></div>

            <!-- Support & Community -->
            <a href="https://github.com/SciTeX-AI" class="dropdown-item" target="_blank">
              <i class="fab fa-github"></i>
              GitHub
            </a>
            <a href="{% url 'cloud_app:donate' %}" class="dropdown-item">
              <i class="fas fa-heart"></i>
              Support SciTeX
            </a>
            <div class="dropdown-divider"></div>

            <!-- Sign Out -->
            <a href="{% url 'auth_app:logout' %}" class="dropdown-item">
              <i class="fas fa-sign-out-alt"></i>
              Sign out
            </a>
          </div>
        </div>
      {% else %}
        <!-- Not logged in -->
        <a href="{% url 'auth_app:login' %}" class="header-btn">
          Sign in
        </a>
        <a href="{% url 'auth_app:signup' %}" class="header-btn header-btn-primary">
          Sign up
        </a>
      {% endif %}
    </div>
  </div>
</header>

<!-- JavaScript for dropdown menu -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const userMenuToggle = document.getElementById('user-menu-toggle');
  const userMenuDropdown = document.getElementById('user-menu-dropdown');

  if (userMenuToggle && userMenuDropdown) {
    userMenuToggle.addEventListener('click', function(e) {
      e.stopPropagation();
      const isVisible = userMenuDropdown.style.display !== 'none';
      userMenuDropdown.style.display = isVisible ? 'none' : 'block';
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
      if (!userMenuToggle.contains(e.target) && !userMenuDropdown.contains(e.target)) {
        userMenuDropdown.style.display = 'none';
      }
    });

    // Close dropdown when pressing Escape
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        userMenuDropdown.style.display = 'none';
      }
    });
  }

  // Global search functionality with autocomplete
  const globalSearch = document.getElementById('global-search');
  if (globalSearch) {
    // Submit on Enter
    globalSearch.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        const query = this.value.trim();
        if (query) {
          window.location.href = `/search/?q=${encodeURIComponent(query)}`;
        }
      }
    });

    // Autocomplete (debounced)
    let autocompleteTimeout;
    globalSearch.addEventListener('input', function(e) {
      clearTimeout(autocompleteTimeout);
      const query = this.value.trim();

      if (query.length < 2) {
        hideAutocomplete();
        return;
      }

      autocompleteTimeout = setTimeout(async () => {
        try {
          const response = await fetch(`/search/api/autocomplete/?q=${encodeURIComponent(query)}`);
          const data = await response.json();
          showAutocomplete(data.suggestions);
        } catch (err) {
          console.error('Autocomplete error:', err);
        }
      }, 300); // 300ms debounce
    });
  }

  // Autocomplete UI helpers
  function showAutocomplete(suggestions) {
    let dropdown = document.getElementById('search-autocomplete');
    if (!dropdown) {
      dropdown = document.createElement('div');
      dropdown.id = 'search-autocomplete';
      dropdown.style.cssText = `
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: var(--color-canvas-default);
        border: 1px solid var(--color-border-default);
        border-radius: 6px;
        box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        max-height: 400px;
        overflow-y: auto;
        z-index: 1000;
        margin-top: 4px;
      `;
      document.querySelector('.header-search').appendChild(dropdown);
    }

    if (suggestions.length === 0) {
      hideAutocomplete();
      return;
    }

    dropdown.innerHTML = suggestions.map(s => `
      <a href="${s.url}" style="
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        color: var(--color-fg-default);
        text-decoration: none;
        border-bottom: 1px solid var(--color-border-muted);
      " onmouseover="this.style.background='var(--color-canvas-subtle)'"
         onmouseout="this.style.background='transparent'">
        <span style="font-size: 20px;">${s.icon}</span>
        <div style="flex: 1;">
          <div style="font-weight: 500;">${s.title}</div>
          <div style="font-size: 12px; color: var(--color-fg-muted);">${s.subtitle}</div>
        </div>
      </a>
    `).join('');

    dropdown.style.display = 'block';
  }

  function hideAutocomplete() {
    const dropdown = document.getElementById('search-autocomplete');
    if (dropdown) {
      dropdown.style.display = 'none';
    }
  }

  // Close autocomplete on click outside
  document.addEventListener('click', function(e) {
    if (!document.querySelector('.header-search')?.contains(e.target)) {
      hideAutocomplete();
    }
  });

  // Note: Theme toggle functionality is handled by /static/js/theme-switcher.js
});
</script>
