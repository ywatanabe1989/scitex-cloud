{% load static %}
<!-- GitHub-Style Global Header -->
<header class="github-header">
  <div class="github-header-inner">
    <!-- Left: Logo + Main Navigation -->
    <div class="header-left">
      <!-- Logo -->
      <a href="{% if user.is_authenticated %}/{{ user.username }}/{% else %}/{% endif %}" class="header-logo">
        <img src="{% static 'images/scitex-logo-cropped.png' %}" alt="SciTeX" class="header-logo-img">
      </a>

      <!-- Primary Navigation -->
      <nav class="header-nav">
        <a href="/social/explore/"
           class="header-nav-item {% if 'explore' in request.path %}active{% endif %}"
           title="Explore repositories and projects">
          <img src="{% static 'images/scitex-explore-icon.svg' %}" alt="" class="nav-icon">
          <span class="nav-label">Explore</span>
        </a>
        {% comment %}
        Module links - All users now navigate to dedicated module endpoints:
        - /scholar/ - Scholar app with project selector
        - /code/ - Code module (project-centric via sessionStorage)
        - /viz/ - Viz module (project-centric via sessionStorage)
        - /writer/ - Writer module (project-centric via sessionStorage)
        {% endcomment %}
        <a href="/scholar/"
           class="header-nav-item {% if 'scholar' in request.path %}active{% endif %}"
           title="Literature review and research">
          <img src="{% static 'images/scitex-scholar-icon.svg' %}" alt="" class="nav-icon">
          <span class="nav-label">Scholar</span>
        </a>
        <span class="header-nav-item header-nav-item-disabled"
              title="Coming soon"
              data-message="Code module coming soon">
          <img src="{% static 'images/scitex-code-icon.svg' %}" alt="" class="nav-icon">
          <span class="nav-label">Code</span>
        </span>
        <span class="header-nav-item header-nav-item-disabled"
              title="Coming soon"
              data-message="Viz module coming soon">
          <img src="{% static 'images/scitex-viz-icon.svg' %}" alt="" class="nav-icon">
          <span class="nav-label">Viz</span>
        </span>
        <a href="/writer/"
           class="header-nav-item {% if 'writer' in request.path %}active{% endif %}"
           title="Manuscript writing">
          <img src="{% static 'images/scitex-writer-icon.svg' %}" alt="" class="nav-icon">
          <span class="nav-label">Writer</span>
        </a>
      </nav>
    </div>

    <!-- Project Selector (for authenticated users) -->
    {% if user.is_authenticated %}
    <div class="header-project-selector">
      <select id="project-selector" class="project-selector-input" title="Switch between your projects">
        {% for project in user.profile.get_user_projects %}
          <option value="{{ project.id }}" data-url="{% url 'user_projects:detail' username=project.owner.username slug=project.slug %}" {% if user.profile.last_active_repository and user.profile.last_active_repository.id == project.id %}selected{% endif %}>
            {{ project.name }}
          </option>
        {% endfor %}
      </select>
      <a href="/new/" class="header-project-new-btn" title="Create new project">
        <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor" style="display: inline-block; vertical-align: text-bottom;">
          <path d="M8 0a1 1 0 0 1 1 1v6h6a1 1 0 1 1 0 2H9v6a1 1 0 1 1-2 0V9H1a1 1 0 0 1 0-2h6V1a1 1 0 0 1 1-1z"/>
        </svg>
      </a>
    </div>
    {% endif %}

    <!-- Center: Search -->
    <div class="header-center">
      <div class="header-search">
        <img src="{% static 'images/scitex-search-icon.svg' %}" alt="" class="header-search-icon">
        <input type="text" placeholder="Search repositories, users..." id="global-search" autocomplete="off">
      </div>
    </div>

    <!-- Right: Actions + User Menu -->
    <div class="header-right">
      <!-- Design System Link (always visible) -->
      <a href="/dev/design/" class="header-icon-btn" title="Design System">
        <svg width="18" height="18" viewBox="0 0 16 16" fill="currentColor" style="display: inline-block; vertical-align: text-bottom;">
          <!-- Color palette icon -->
          <path d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zm0 1.5a6.5 6.5 0 0 1 6.429 5.5h-1.286a.5.5 0 1 0 0 1h1.286A6.5 6.5 0 0 1 8 14.5a.5.5 0 0 1-.5-.5v-1.286a.5.5 0 1 0-1 0V14a.5.5 0 0 1-.5.5 6.5 6.5 0 0 1-5.429-7h1.286a.5.5 0 0 0 0-1H.571A6.5 6.5 0 0 1 8 1.5z"/>
          <circle cx="5" cy="5" r="1.5" fill="currentColor"/>
          <circle cx="11" cy="5" r="1.5" fill="currentColor"/>
          <circle cx="8" cy="10" r="1.5" fill="currentColor"/>
        </svg>
      </a>

      <!-- Theme Toggle (always visible) -->
      <button id="theme-toggle" class="theme-toggle" title="Toggle theme">
        ☀️
      </button>

      {% if user.is_authenticated %}
        <!-- New Repository Button (GitHub-style: /new) -->
        <a href="/new/" class="header-btn header-btn-primary" title="Create new repository">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="display: inline-block; vertical-align: text-bottom;">
            <path d="M8 0a1 1 0 0 1 1 1v6h6a1 1 0 1 1 0 2H9v6a1 1 0 1 1-2 0V9H1a1 1 0 0 1 0-2h6V1a1 1 0 0 1 1-1z"/>
          </svg>
          <span class="btn-label">New</span>
        </a>

        <!-- User Menu -->
        <div class="header-user-menu">
          <button class="header-user-toggle" id="user-menu-toggle">
            <div class="header-avatar">
              {% if user.profile.avatar %}
                <img src="{{ user.profile.avatar.url }}" alt="{{ user.username }}">
              {% else %}
                {{ user.username|slice:":1"|upper }}
              {% endif %}
            </div>
            <svg width="12" height="12" viewBox="0 0 16 16" fill="currentColor" style="margin-left: 4px;">
              <path d="M4 6l4 4 4-4H4z"/>
            </svg>
          </button>

          <div class="header-dropdown" id="user-menu-dropdown" style="display: none;">
            <!-- User Info Header -->
            <div class="dropdown-header">
              <div class="dropdown-user-info">
                <strong>{{ user.get_full_name|default:user.username }}</strong>
                <div class="dropdown-user-username">@{{ user.username }}</div>
              </div>
            </div>
            <div class="dropdown-divider"></div>

            <!-- Settings -->
            <a href="{% url 'accounts_app:profile_edit' %}" class="dropdown-item">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="display: inline-block; vertical-align: text-bottom; margin-right: 8px;">
                <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"/>
                <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319z"/>
              </svg>
              Settings
            </a>
            <div class="dropdown-divider"></div>

            <!-- Developer Tools -->
            <a href="/dev/" class="dropdown-item">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="display: inline-block; vertical-align: text-bottom; margin-right: 8px;">
                <path d="M15 5a1 1 0 0 0-1-1H2a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V5zM0 5a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V5zm3.5 1a.5.5 0 0 0 0 1h1a.5.5 0 0 0 0-1h-1zM5 8.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 0 1h-1a.5.5 0 0 1-.5-.5zm2 1.5a.5.5 0 0 0 0 1h1a.5.5 0 0 0 0-1h-1z"/>
              </svg>
              Developer Tools
            </a>
            <a href="/dev/design/" class="dropdown-item">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="display: inline-block; vertical-align: text-bottom; margin-right: 8px;">
                <path d="M8 5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3zm4 3a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3zM5.5 7a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm.5 6a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3z"/>
                <path d="M16 8c0 3.15-1.866 2.585-3.567 2.07C11.42 9.763 10.465 9.473 10 10c-.603.683-.475 1.819-.351 2.92C9.826 14.495 9.996 16 8 16a8 8 0 1 1 8-8zm-8 7c.611 0 .654-.171.655-.176.078-.146.124-.464.07-1.119-.014-.168-.037-.37-.061-.591-.052-.464-.112-1.005-.118-1.462-.01-.707.083-1.61.704-2.314.417-.469.923-.707 1.455-.832.532-.125 1.09-.14 1.617-.157.526-.016 1.004-.032 1.388-.21.37-.17.699-.4.96-.757.272-.373.447-.834.47-1.423.001-.006.003-.01.003-.016a6.976 6.976 0 0 0-2.334-5.166 7.004 7.004 0 0 0-10.027 1.27 7.004 7.004 0 0 0 1.928 9.727A6.976 6.976 0 0 0 8 15z"/>
              </svg>
              Design System
            </a>
            <div class="dropdown-divider"></div>

            <!-- Support & Community -->
            <a href="https://github.com/SciTeX-AI" class="dropdown-item" target="_blank">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="display: inline-block; vertical-align: text-bottom; margin-right: 8px;">
                <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"/>
              </svg>
              GitHub
            </a>
            <a href="{% url 'public_app:donate' %}" class="dropdown-item">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="display: inline-block; vertical-align: text-bottom; margin-right: 8px;">
                <path d="m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523 1.023-.641 2.5.314 4.385.92 1.815 2.834 3.989 6.286 6.357 3.452-2.368 5.365-4.542 6.286-6.357.955-1.886.838-3.362.314-4.385C13.486.878 10.4.28 8.717 2.01L8 2.748zM8 15C-7.333 4.868 3.279-3.04 7.824 1.143c.06.055.119.112.176.171a3.12 3.12 0 0 1 .176-.17C12.72-3.042 23.333 4.867 8 15z"/>
              </svg>
              Support SciTeX
            </a>
            <div class="dropdown-divider"></div>

            <!-- Sign Out -->
            <a href="{% url 'auth_app:logout' %}" class="dropdown-item">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="display: inline-block; vertical-align: text-bottom; margin-right: 8px;">
                <path fill-rule="evenodd" d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0v2z"/>
                <path fill-rule="evenodd" d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z"/>
              </svg>
              Sign out
            </a>
          </div>
        </div>
      {% else %}
        <!-- Not logged in -->
        <a href="{% url 'auth_app:login' %}" class="header-btn">
          Sign in
        </a>
        <a href="{% url 'auth_app:signup' %}" class="header-btn header-btn-primary">
          Sign up
        </a>
      {% endif %}
    </div>
  </div>
</header>

<!-- JavaScript for dropdown menu -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const userMenuToggle = document.getElementById('user-menu-toggle');
  const userMenuDropdown = document.getElementById('user-menu-dropdown');

  if (userMenuToggle && userMenuDropdown) {
    userMenuToggle.addEventListener('click', function(e) {
      e.stopPropagation();
      const isVisible = userMenuDropdown.style.display !== 'none';
      userMenuDropdown.style.display = isVisible ? 'none' : 'block';
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
      if (!userMenuToggle.contains(e.target) && !userMenuDropdown.contains(e.target)) {
        userMenuDropdown.style.display = 'none';
      }
    });

    // Close dropdown when pressing Escape
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        userMenuDropdown.style.display = 'none';
      }
    });
  }

  // Global search functionality with autocomplete
  const globalSearch = document.getElementById('global-search');
  if (globalSearch) {
    // Submit on Enter
    globalSearch.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        const query = this.value.trim();
        if (query) {
          window.location.href = `/search/?q=${encodeURIComponent(query)}`;
        }
      }
    });

    // Autocomplete (debounced)
    let autocompleteTimeout;
    globalSearch.addEventListener('input', function(e) {
      clearTimeout(autocompleteTimeout);
      const query = this.value.trim();

      if (query.length < 2) {
        hideAutocomplete();
        return;
      }

      autocompleteTimeout = setTimeout(async () => {
        try {
          const response = await fetch(`/search/api/autocomplete/?q=${encodeURIComponent(query)}`);
          const data = await response.json();
          showAutocomplete(data.suggestions);
        } catch (err) {
          console.error('Autocomplete error:', err);
        }
      }, 300); // 300ms debounce
    });
  }

  // Autocomplete UI helpers
  function showAutocomplete(suggestions) {
    let dropdown = document.getElementById('search-autocomplete');
    if (!dropdown) {
      dropdown = document.createElement('div');
      dropdown.id = 'search-autocomplete';
      dropdown.style.cssText = `
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: var(--color-canvas-default);
        border: 1px solid var(--color-border-default);
        border-radius: 6px;
        box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        max-height: 400px;
        overflow-y: auto;
        z-index: 1000;
        margin-top: 4px;
      `;
      document.querySelector('.header-search').appendChild(dropdown);
    }

    if (suggestions.length === 0) {
      hideAutocomplete();
      return;
    }

    dropdown.innerHTML = suggestions.map(s => `
      <a href="${s.url}" style="
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        color: var(--color-fg-default);
        text-decoration: none;
        border-bottom: 1px solid var(--color-border-muted);
      " onmouseover="this.style.background='var(--color-canvas-subtle)'"
         onmouseout="this.style.background='transparent'">
        <span style="font-size: 20px;">${s.icon}</span>
        <div style="flex: 1;">
          <div style="font-weight: 500;">${s.title}</div>
          <div style="font-size: 12px; color: var(--color-fg-muted);">${s.subtitle}</div>
        </div>
      </a>
    `).join('');

    dropdown.style.display = 'block';
  }

  function hideAutocomplete() {
    const dropdown = document.getElementById('search-autocomplete');
    if (dropdown) {
      dropdown.style.display = 'none';
    }
  }

  // Close autocomplete on click outside
  document.addEventListener('click', function(e) {
    if (!document.querySelector('.header-search')?.contains(e.target)) {
      hideAutocomplete();
    }
  });

  // Note: Theme toggle functionality is handled by /static/js/theme-switcher.js

  // Project selector functionality
  const projectSelector = document.getElementById('project-selector');
  if (projectSelector) {
    projectSelector.addEventListener('change', function(e) {
      const selectedOption = this.options[this.selectedIndex];
      const projectUrl = selectedOption.getAttribute('data-url');

      if (projectUrl) {
        // Store selected project ID in sessionStorage for Scholar app
        sessionStorage.setItem('scholar_selected_project_id', this.value);

        // Navigate to the project
        window.location.href = projectUrl;
      }
    });

    // Restore selected project from sessionStorage if available and is a valid option
    const savedProjectId = sessionStorage.getItem('scholar_selected_project_id');
    if (savedProjectId && projectSelector.value !== savedProjectId) {
      const option = projectSelector.querySelector(`option[value="${savedProjectId}"]`);
      if (option && option.hasAttribute('data-url')) {
        projectSelector.value = savedProjectId;
      }
    }

    // Keyboard navigation: Alt+P to focus project selector
    document.addEventListener('keydown', function(e) {
      if ((e.altKey || e.metaKey) && e.key === 'p') {
        e.preventDefault();
        projectSelector.focus();
      }
    });
  }
});
</script>
