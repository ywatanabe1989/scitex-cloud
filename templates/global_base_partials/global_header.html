{% load static %}
<!-- GitHub-Style Global Header -->
<style>
@keyframes pulse {
    0%, 100% {
        transform: scale(1);
        opacity: 1;
    }
    50% {
        transform: scale(1.3);
        opacity: 0.8;
    }
}
</style>
<header class="global-header">
    <div class="global-header-inner">
        <!-- Left: Logo + Main Navigation -->
        <div class="header-left">
            <!-- Logo -->
            <a href="/"
               class="header-logo"
               data-tooltip="Go to home page">
                <img src="{% static 'shared/images/scitex_logos/scitex-logo.png' %}"
                     alt="SciTeX"
                     class="header-logo-img" />
            </a>
            <!-- Project Selector (moved here for better visibility) -->
            <div class="header-project-selector-inline">
                <button id="project-selector-toggle"
                        class="project-selector-btn"
                        title="{% if user.is_authenticated %}Switch projects{% else %}Current project{% endif %}">
                    <span id="project-selector-text" class="project-selector-text">
                        {% if user.is_authenticated %}
                            {% if user.profile.last_active_repository %}
                                {{ user.profile.last_active_repository.name }}
                            {% else %}
                                {% with projects=user.profile.get_user_projects %}
                                    {% if projects|length > 0 %}
                                        {% for project in projects %}
                                            {% if forloop.first %}{{ project.name }}{% endif %}
                                        {% endfor %}
                                    {% else %}
                                        Projects
                                    {% endif %}
                                {% endwith %}
                            {% endif %}
                        {% else %}
                            {% if project %}
                                {{ project.name }}
                            {% else %}
                                default-project
                            {% endif %}
                        {% endif %}
                    </span>
                    <svg width="12"
                         height="12"
                         viewBox="0 0 16 16"
                         fill="currentColor"
                         style="margin-left: 4px">
                        <path d="M4 6l4 4 4-4H4z" />
                    </svg>
                </button>
                <!-- Project Dropdown Menu -->
                <div id="project-selector-dropdown"
                     class="project-selector-dropdown"
                     style="display: none">
                    {% if user.is_authenticated %}
                        {% if user.profile.get_user_projects %}
                            <div class="dropdown-section">
                                {% for project in user.profile.get_user_projects %}
                                    <button type="button"
                                            class="dropdown-project-item"
                                            data-project-id="{{ project.id }}"
                                            data-project-name="{{ project.name }}"
                                            data-project-slug="{{ project.slug }}"
                                            data-project-owner="{{ project.owner.username }}">
                                        <span class="project-item-name">{{ project.name }}</span>
                                        <div style="display: flex;
                                                    align-items: center;
                                                    gap: 4px;
                                                    margin-left: auto">
                                            <a href="/{{ project.owner.username }}/{{ project.slug }}/"
                                               class="project-item-jump-btn"
                                               title="Go to {{ project.name }} repository"
                                               onclick="event.stopPropagation();"
                                               target="_blank"
                                               style="display: inline-flex;
                                                      align-items: center;
                                                      justify-content: center;
                                                      width: 20px;
                                                      height: 20px;
                                                      border-radius: 3px;
                                                      color: var(--text-muted);
                                                      text-decoration: none;
                                                      transition: all 0.15s ease">
                                                <i class="fas fa-folder-open" style="font-size: 11px"></i>
                                            </a>
                                            <span class="project-item-check"
                                                  style="display: {% if user.profile.last_active_repository and user.profile.last_active_repository.id == project.id %}inline-flex{% else %}none{% endif %};
                                                         align-items: center;
                                                         justify-content: center">
                                                <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
                                                    <path d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 11-1.06-1.06L12.72 4.22a.75.75 0 011.06 0z" />
                                                </svg>
                                            </span>
                                        </div>
                                    </button>
                                {% endfor %}
                            </div>
                            <div class="dropdown-divider"></div>
                        {% endif %}
                        <a href="/new/" class="dropdown-project-item dropdown-create-new">
                            <svg width="14"
                                 height="14"
                                 viewBox="0 0 16 16"
                                 fill="currentColor"
                                 style="margin-right: 6px">
                                <path d="M8 0a1 1 0 0 1 1 1v6h6a1 1 0 1 1 0 2H9v6a1 1 0 1 1-2 0V9H1a1 1 0 0 1 0-2h6V1a1 1 0 0 1 1-1z" />
                            </svg>
                            <span>Create New Project</span>
                        </a>
                    {% else %}
                        <div class="dropdown-section">
                            <div class="dropdown-section-title">Current Project</div>
                            <div class="dropdown-project-item" style="cursor: default; opacity: 0.9">
                                <span class="project-item-name">{{ project.name|default:"default-project" }}</span>
                            </div>
                        </div>
                        <div class="dropdown-divider"></div>
                        <a href="/auth/signup/"
                           class="dropdown-project-item dropdown-create-new">
                            <svg width="14"
                                 height="14"
                                 viewBox="0 0 16 16"
                                 fill="currentColor"
                                 style="margin-right: 6px">
                                <path d="M8 0a1 1 0 0 1 1 1v6h6a1 1 0 1 1 0 2H9v6a1 1 0 1 1-2 0V9H1a1 1 0 0 1 0-2h6V1a1 1 0 0 1 1-1z" />
                            </svg>
                            <span>Sign up to save your work</span>
                        </a>
                    {% endif %}
                </div>
            </div>
            <!-- Primary Navigation -->
            <nav class="header-nav">
                <!-- Files - Direct link to user's repositories -->
                {% if user.is_authenticated %}
                    <a href="/{{ user.username }}/"
                       class="header-nav-item {% if user.username in request.path and 'explore' not in request.path %}active{% endif %}"
                       data-tooltip="Your repositories">
                        <i class="fas fa-book-open nav-icon-fa" style="font-size: 16px"></i>
                        <span class="nav-label">Files</span>
                    </a>
                {% else %}
                    {% if visitor_username %}
                        <a href="/{{ visitor_username }}/"
                           class="header-nav-item"
                           data-tooltip="Your files">
                            <i class="fas fa-book-open nav-icon-fa" style="font-size: 16px"></i>
                            <span class="nav-label">Files</span>
                        </a>
                    {% else %}
                        <a href="{% url 'auth_app:signup' %}"
                           class="header-nav-item"
                           data-tooltip="Sign up to access files">
                            <i class="fas fa-book-open nav-icon-fa" style="font-size: 16px; opacity: 0.5;"></i>
                            <span class="nav-label">Files</span>
                        </a>
                    {% endif %}
                {% endif %}
                {% comment %} Module links - All users now navigate to dedicated module
        endpoints: - /scholar/ - Scholar app with project selector - /code/ -
        Code module (project-centric via sessionStorage) - /viz/ - Viz module
        (project-centric via sessionStorage) - /writer/ - Writer module
                (project-centric via sessionStorage) {% endcomment %}
                <!-- Scholar Module -->
                <a href="/scholar/"
                   class="header-nav-item {% if 'scholar' in request.path %}active{% endif %}"
                   data-tooltip="Citation Management">
                    <i class="fas fa-graduation-cap nav-icon-fa" style="font-size: 16px"></i>
                    <span class="nav-label">Scholar</span>
                </a>
                <a href="/code/"
                   class="header-nav-item {% if 'code' in request.path %}active{% endif %}"
                   data-tooltip="Code workspace">
                    <i class="fas fa-terminal nav-icon-fa" style="font-size: 16px"></i>
                    <span class="nav-label">Code</span>
                </a>
                <a href="/vis/"
                   class="header-nav-item {% if 'vis' in request.path %}active{% endif %}"
                   data-tooltip="Scientific Figure Editor">
                    <i class="fas fa-chart-line nav-icon-fa" style="font-size: 16px"></i>
                    <span class="nav-label">Vis</span>
                </a>                
                <a href="/writer/"
                   class="header-nav-item {% if 'writer' in request.path %}active{% endif %}"
                   data-tooltip="Manuscript writing">
                    <i class="fas fa-pen nav-icon-fa" style="font-size: 16px"></i>
                    <span class="nav-label">Writer</span>
                </a>
                <a href="/tools/"
                   class="header-nav-item {% if 'tools' in request.path %}active{% endif %}"
                   data-tooltip="Research tools and bookmarklets">
                    <i class="fas fa-toolbox nav-icon-fa" style="font-size: 16px"></i>
                    <span class="nav-label">Tools</span>
                </a>
                <!-- Explore - Browse other users' work -->
                <a href="/social/explore/"
                   class="header-nav-item {% if 'explore' in request.path %}active{% endif %}"
                   data-tooltip="Explore other users' work">
                    <i class="fas fa-compass nav-icon-fa" style="font-size: 16px"></i>
                    <span class="nav-label">Explore</span>
                </a>
            </nav>
        </div>
        <!-- Project Selector (for all users) - Custom Dropdown Menu -->
        <div class="header-project-selector">
            <!-- Project Dropdown Button -->
            <button id="project-selector-toggle"
                    class="project-selector-btn"
                    title="{% if user.is_authenticated %}Switch projects{% else %}Current project{% endif %}">
                <span id="project-selector-text" class="project-selector-text">
                    {% if user.is_authenticated %}
                        {% if user.profile.last_active_repository %}
                            {{ user.profile.last_active_repository.name }}
                        {% else %}
                            {% with projects=user.profile.get_user_projects %}
                                {% if projects|length > 0 %}
                                    {% for project in projects %}
                                        {% if forloop.first %}{{ project.name }}{% endif %}
                                    {% endfor %}
                                {% else %}
                                    Projects
                                {% endif %}
                            {% endwith %}
                        {% endif %}
                    {% else %}
                        {% comment %}Visitor mode - show allocated default project from context{% endcomment %}
                        {% if project %}
                            {{ project.name }}
                        {% else %}
                            default-project
                        {% endif %}
                    {% endif %}
                </span>
                <svg width="12"
                     height="12"
                     viewBox="0 0 16 16"
                     fill="currentColor"
                     style="margin-left: 4px">
                    <path d="M4 6l4 4 4-4H4z" />
                </svg>
            </button>
            <!-- Project Dropdown Menu -->
            <div id="project-selector-dropdown"
                 class="project-selector-dropdown"
                 style="display: none">
                {% if user.is_authenticated %}
                    {% if user.profile.get_user_projects %}
                        <div class="dropdown-section">
                            {% for project in user.profile.get_user_projects %}
                                <button type="button"
                                        class="dropdown-project-item"
                                        data-project-id="{{ project.id }}"
                                        data-project-name="{{ project.name }}"
                                        data-project-slug="{{ project.slug }}"
                                        data-project-owner="{{ project.owner.username }}">
                                    <span class="project-item-name">{{ project.name }}</span>
                                    <div style="display: flex;
                                                align-items: center;
                                                gap: 4px;
                                                margin-left: auto">
                                        <a href="/{{ project.owner.username }}/{{ project.slug }}/"
                                           class="project-item-jump-btn"
                                           title="Go to {{ project.name }} repository"
                                           onclick="event.stopPropagation();"
                                           target="_blank"
                                           style="display: inline-flex;
                                                  align-items: center;
                                                  justify-content: center;
                                                  width: 20px;
                                                  height: 20px;
                                                  border-radius: 3px;
                                                  color: var(--text-muted);
                                                  text-decoration: none;
                                                  transition: all 0.15s ease">
                                            <i class="fas fa-folder-open" style="font-size: 11px"></i>
                                        </a>
                                        <span class="project-item-check"
                                              style="display: {% if user.profile.last_active_repository and user.profile.last_active_repository.id == project.id %}inline-flex{% else %}none{% endif %};
                                                     align-items: center;
                                                     justify-content: center">
                                            <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
                                                <path d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 11-1.06-1.06L12.72 4.22a.75.75 0 011.06 0z" />
                                            </svg>
                                        </span>
                                    </div>
                                </button>
                            {% endfor %}
                        </div>
                        <div class="dropdown-divider"></div>
                    {% endif %}
                    <!-- Create New Project Option (authenticated users only) -->
                    <a href="/new/" class="dropdown-project-item dropdown-create-new">
                        <svg width="14"
                             height="14"
                             viewBox="0 0 16 16"
                             fill="currentColor"
                             style="margin-right: 6px">
                            <path d="M8 0a1 1 0 0 1 1 1v6h6a1 1 0 1 1 0 2H9v6a1 1 0 1 1-2 0V9H1a1 1 0 0 1 0-2h6V1a1 1 0 0 1 1-1z" />
                        </svg>
                        <span>Create New Project</span>
                    </a>
                {% else %}
                    <!-- Visitor mode - show current project info -->
                    {% if project %}
                        <div class="dropdown-section">
                            <div class="dropdown-section-title">Current Project</div>
                            <div class="dropdown-project-item" style="cursor: default; opacity: 0.9">
                                <span class="project-item-name">{{ project.name }}</span>
                                <span class="project-item-check" style="display: inline">
                                    <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
                                        <path d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 11-1.06-1.06L12.72 4.22a.75.75 0 011.06 0z" />
                                    </svg>
                                </span>
                            </div>
                            <div style="padding: 12px;
                                        font-size: 12px;
                                        color: var(--text-muted);
                                        line-height: 1.5">
                                <svg width="14"
                                     height="14"
                                     viewBox="0 0 16 16"
                                     fill="currentColor"
                                     style="margin-right: 4px;
                                            vertical-align: text-bottom">
                                    <path d="M8 1a.5.5 0 0 1 .5.5v.518A7.001 7.001 0 0 1 14.954 7.5h.518a.5.5 0 0 1 0 1h-.518A7.001 7.001 0 0 1 8.5 14.482v.518a.5.5 0 0 1-1 0v-.518A7.001 7.001 0 0 1 1.046 8.5H.528a.5.5 0 0 1 0-1h.518A7.001 7.001 0 0 1 7.5 2.018V1.5A.5.5 0 0 1 8 1zm-.5 2.02A6.001 6.001 0 0 0 2.02 7.5h.48a.5.5 0 0 1 0 1h-.48A6.001 6.001 0 0 0 7.5 13.98v-.48a.5.5 0 0 1 1 0v.48A6.001 6.001 0 0 0 13.98 8.5h-.48a.5.5 0 0 1 0-1h.48A6.001 6.001 0 0 0 8.5 3.02v.48a.5.5 0 0 1-1 0v-.48z" />
                                </svg>
                                Visitor mode: Your work won't be saved permanently. Sign up to keep
                                it!
                            </div>
                        </div>
                        <div class="dropdown-divider"></div>
                    {% endif %}
                    <!-- Sign up to save (visitors) -->
                    <a href="/auth/signup/"
                       class="dropdown-project-item dropdown-create-new">
                        <svg width="14"
                             height="14"
                             viewBox="0 0 16 16"
                             fill="currentColor"
                             style="margin-right: 6px">
                            <path d="M8 0a1 1 0 0 1 1 1v6h6a1 1 0 1 1 0 2H9v6a1 1 0 1 1-2 0V9H1a1 1 0 0 1 0-2h6V1a1 1 0 0 1 1-1z" />
                        </svg>
                        <span>Sign up to save your work</span>
                    </a>
                {% endif %}
            </div>
        </div>
        <!-- Center: Search -->
        <div class="header-center">
            <div class="header-search">
                <img src="{% static 'shared/images/icons_svg/scitex-search-icon.svg' %}"
                     alt=""
                     class="header-search-icon" />
                <input type="text"
                       placeholder="Search or jump to..."
                       id="global-search"
                       autocomplete="off"
                       readonly />
                <kbd class="search-shortcut-badge">/</kbd>
            </div>
        </div>
        <!-- Search Modal (GitHub-style) -->
        <div id="search-modal" class="search-modal" style="display: none">
            <div class="search-modal-backdrop"></div>
            <div class="search-modal-content">
                <div class="search-modal-header">
                    <div class="search-modal-input-wrapper">
                        <img src="{% static 'shared/images/icons_svg/scitex-search-icon.svg' %}"
                             alt=""
                             class="search-modal-icon" />
                        <input type="text"
                               id="search-modal-input"
                               class="search-modal-input"
                               placeholder="Search or jump to..."
                               autocomplete="off"
                               autofocus />
                    </div>
                </div>
                <div class="search-modal-results" id="search-modal-results">
                    <!-- Results will be populated here -->
                </div>
                <div class="search-modal-footer">
                    <a href="#" class="search-modal-footer-link">Search syntax tips</a>
                    <a href="#" class="search-modal-footer-link">Give feedback</a>
                </div>
            </div>
        </div>
        <!-- Right: Actions + User Menu -->
        <div class="header-right">
            <!-- Theme Toggle (always visible) -->
            <button id="theme-toggle"
                    class="theme-toggle"
                    data-tooltip="Toggle light/dark theme">üåì</button>
            <!-- Refresh Button (Ctrl+Shift+R alternative) -->
            <button id="page-refresh-btn"
                    class="theme-toggle"
                    data-tooltip="Refresh page (Ctrl+Shift+R)">
                <i class="fas fa-sync-alt"></i>
            </button>
            <!-- Clear LocalStorage Button -->
            <button id="clear-localstorage-btn"
                    class="theme-toggle"
                    data-tooltip="Clear localStorage cache"
                    onclick="if(confirm('Clear all localStorage? This will reset theme preferences and cached data.')) { localStorage.clear(); location.reload(); }">
                <i class="fas fa-eraser"></i>
            </button>
            <!-- Server Status with live health indicator -->
            <a href="/server-status/"
               id="server-status-btn"
               class="theme-toggle"
               data-tooltip="System Status"
               style="font-size: 18px; position: relative;">
                <span id="server-status-indicator"
                      class="status-dot"
                      style="position: absolute;
                             top: 8px;
                             right: 8px;
                             width: 8px;
                             height: 8px;
                             border-radius: 50%;
                             background: #4caf50;
                             border: 2px solid var(--bg-page);
                             box-shadow: 0 0 4px rgba(76, 175, 80, 0.6);"></span>
                <i class="fas fa-server"></i>
            </a>
            {% if is_visitor %}
                <!-- Visitor Menu (Integrated badge + dropdown) -->
                <div class="header-user-menu">
                    <button class="header-user-toggle visitor-button"
                            id="visitor-menu-toggle"
                            {% if visitor_expires_at %}
                            data-expires-at="{{ visitor_expires_at.isoformat }}"
                            {% endif %}>
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="margin-right: 6px;">
                            <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/>
                            <path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1z"/>
                        </svg>
                        <span id="visitor-mode-text">
                            {% if visitor_username %}
                                Visitor #{{ visitor_username|slice:"8:" }}
                            {% else %}
                                Visitor Mode
                            {% endif %}
                        </span>
                        {% if visitor_expires_at %}
                        <span id="visitor-countdown" style="margin-left: 6px; font-family: 'JetBrains Mono', monospace; font-weight: 600; font-size: 0.9em;">
                            ‚è∞ --:--
                        </span>
                        {% endif %}
                        <svg width="12"
                             height="12"
                             viewBox="0 0 16 16"
                             fill="currentColor"
                             style="margin-left: 6px">
                            <path d="M4 6l4 4 4-4H4z" />
                        </svg>
                    </button>
                    <div class="header-dropdown" id="visitor-menu-dropdown" style="display: none">
                        <!-- Visitor Info Header -->
                        <div class="dropdown-header">
                            <div class="dropdown-user-info">
                                <strong>Visitor Mode</strong>
                                <div class="dropdown-user-username">{{ user.username }}</div>
                            </div>
                        </div>
                        <div style="padding: 12px 16px; font-size: 13px; color: var(--text-muted); line-height: 1.5; background: var(--color-attention-subtle); border-radius: 6px; margin: 8px;">
                            <svg width="14"
                                 height="14"
                                 viewBox="0 0 16 16"
                                 fill="currentColor"
                                 style="margin-right: 4px; vertical-align: text-bottom; color: var(--color-attention-fg);">
                                <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/>
                                <path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1z"/>
                            </svg>
                            Your work won't be saved permanently. Create an account to keep it!
                        </div>
                        <div class="dropdown-divider"></div>
                        <!-- Primary CTA: Sign Up -->
                        <a href="/auth/signup/" class="dropdown-item" style="background: var(--color-accent-emphasis); color: white; font-weight: 600; text-align: center;">
                            <svg width="16"
                                 height="16"
                                 viewBox="0 0 16 16"
                                 fill="currentColor"
                                 style="margin-right: 8px; vertical-align: text-bottom;">
                                <path d="M8 0a1 1 0 0 1 1 1v6h6a1 1 0 1 1 0 2H9v6a1 1 0 1 1-2 0V9H1a1 1 0 0 1 0-2h6V1a1 1 0 0 1 1-1z" />
                            </svg>
                            Sign Up (Free)
                        </a>
                        <a href="/auth/signin/" class="dropdown-item" style="text-align: center;">
                            <svg width="16"
                                 height="16"
                                 viewBox="0 0 16 16"
                                 fill="currentColor"
                                 style="margin-right: 8px; vertical-align: text-bottom;">
                                <path fill-rule="evenodd" d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0v2z" />
                                <path fill-rule="evenodd" d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z" />
                            </svg>
                            Already have an account? Sign In
                        </a>
                        <div class="dropdown-divider"></div>
                        <a href="{% url 'public_app:server_status' %}" class="dropdown-item">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="margin-right: 8px; vertical-align: text-bottom;">
                                <path d="M0 1.5A.5.5 0 0 1 .5 1h15a.5.5 0 0 1 0 1h-.5v13a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5V14h-1v.5a.5.5 0 0 1-.5.5H9a.5.5 0 0 1-.5-.5V14H8v.5a.5.5 0 0 1-.5.5H5a.5.5 0 0 1-.5-.5V14H4v.5a.5.5 0 0 1-.5.5H.5a.5.5 0 0 1-.5-.5V2H0v-.5zM2 2v12h1v-3a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 .5.5v3h1V2H2zm7 12h1V2H9v12zm4 0v-3h-1v3h1zM4.5 4h-1a.5.5 0 0 0-.5.5v2a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-2A.5.5 0 0 0 4.5 4zm2 0h-1a.5.5 0 0 0-.5.5v2a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-2A.5.5 0 0 0 6.5 4zm2 0h-1a.5.5 0 0 0-.5.5v2a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-2A.5.5 0 0 0 8.5 4zm2 0h-1a.5.5 0 0 0-.5.5v2a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-2A.5.5 0 0 0 10.5 4zm2 0h-1a.5.5 0 0 0-.5.5v2a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 0-.5-.5z" />
                            </svg>
                            Server Status
                        </a>
                    </div>
                </div>
            {% elif user.is_authenticated %}
                <!-- User Menu -->
                <div class="header-user-menu">
                    <button class="header-user-toggle" id="user-menu-toggle">
                        <div class="header-avatar">
                            {% if user.profile.avatar %}
                                <img src="{{ user.profile.avatar.url }}" alt="{{ user.username }}" />
                            {% else %}
                                {{ user.username|slice:":1"|upper }}
                            {% endif %}
                        </div>
                        <svg width="12"
                             height="12"
                             viewBox="0 0 16 16"
                             fill="currentColor"
                             style="margin-left: 4px">
                            <path d="M4 6l4 4 4-4H4z" />
                        </svg>
                    </button>
                    <div class="header-dropdown" id="user-menu-dropdown" style="display: none">
                        <!-- User Info Header -->
                        <div class="dropdown-header">
                            <div class="dropdown-user-info">
                                <strong>{{ user.get_full_name|default:user.username }}</strong>
                                <div class="dropdown-user-username">@{{ user.username }}</div>
                            </div>
                        </div>
                        <!-- Account Switcher (Multi-account support) -->
                        <div class="dropdown-divider"></div>
                        <div id="account-switcher-container" style="padding: 8px 16px">
                            <!-- Switcher dropdown (only shown when multiple accounts) -->
                            <div id="account-switcher-dropdown-wrapper" style="display: none">
                                <div style="font-size: 12px;
                                            color: var(--text-muted);
                                            margin-bottom: 8px;
                                            font-weight: 600">
                                    <svg width="14"
                                         height="14"
                                         viewBox="0 0 16 16"
                                         fill="currentColor"
                                         style="margin-right: 4px;
                                                vertical-align: text-bottom">
                                        <path d="M10.5 5a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0zm.061 3.073a4 4 0 1 0-5.123 0 6.004 6.004 0 0 0-3.431 5.142.75.75 0 0 0 1.498.07 4.5 4.5 0 0 1 8.99 0 .75.75 0 1 0 1.498-.07 6.005 6.005 0 0 0-3.432-5.142z" />
                                    </svg>
                                    Switch Account
                                </div>
                                <select id="account-switcher"
                                        style="width: 100%;
                                               padding: 6px 8px;
                                               border: 1px solid var(--border-default);
                                               border-radius: 6px;
                                               background: var(--bg-page);
                                               color: var(--text-primary);
                                               margin-bottom: 8px">
                                    <option value="">Loading...</option>
                                </select>
                            </div>
                            <!-- Add account link (always visible) -->
                            <a href="/auth/login/?next={{ request.path }}"
                               class="dropdown-item"
                               style="padding: 4px 0;
                                      font-size: 13px">
                                <svg width="14"
                                     height="14"
                                     viewBox="0 0 16 16"
                                     fill="currentColor"
                                     style="margin-right: 6px;
                                            vertical-align: text-bottom">
                                    <path d="M8 0a1 1 0 0 1 1 1v6h6a1 1 0 1 1 0 2H9v6a1 1 0 1 1-2 0V9H1a1 1 0 0 1 0-2h6V1a1 1 0 0 1 1-1z" />
                                </svg>
                                Add another account
                            </a>
                        </div>
                        <div class="dropdown-divider"></div>
                        <!-- Settings -->
                        <a href="{% url 'accounts_app:profile_edit' %}" class="dropdown-item">
                            <svg width="16"
                                 height="16"
                                 viewBox="0 0 16 16"
                                 fill="currentColor"
                                 style="display: inline-block;
                                        vertical-align: text-bottom;
                                        margin-right: 8px">
                                <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z" />
                                <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319z" />
                            </svg>
                            Settings
                        </a>
                        <div class="dropdown-divider"></div>
                        <!-- Developer Tools -->
                        <a href="/dev/" class="dropdown-item">
                            <svg width="16"
                                 height="16"
                                 viewBox="0 0 16 16"
                                 fill="currentColor"
                                 style="display: inline-block;
                                        vertical-align: text-bottom;
                                        margin-right: 8px">
                                <path d="M15 5a1 1 0 0 0-1-1H2a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V5zM0 5a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V5zm3.5 1a.5.5 0 0 0 0 1h1a.5.5 0 0 0 0-1h-1zM5 8.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 0 1h-1a.5.5 0 0 1-.5-.5zm2 1.5a.5.5 0 0 0 0 1h1a.5.5 0 0 0 0-1h-1z" />
                            </svg>
                            Developer Tools
                        </a>
                        <a href="/dev/design/" class="dropdown-item">
                            <svg width="16"
                                 height="16"
                                 viewBox="0 0 16 16"
                                 fill="currentColor"
                                 style="display: inline-block;
                                        vertical-align: text-bottom;
                                        margin-right: 8px">
                                <path d="M8 5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3zm4 3a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3zM5.5 7a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm.5 6a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3z" />
                                <path d="M16 8c0 3.15-1.866 2.585-3.567 2.07C11.42 9.763 10.465 9.473 10 10c-.603.683-.475 1.819-.351 2.92C9.826 14.495 9.996 16 8 16a8 8 0 1 1 8-8zm-8 7c.611 0 .654-.171.655-.176.078-.146.124-.464.07-1.119-.014-.168-.037-.37-.061-.591-.052-.464-.112-1.005-.118-1.462-.01-.707.083-1.61.704-2.314.417-.469.923-.707 1.455-.832.532-.125 1.09-.14 1.617-.157.526-.016 1.004-.032 1.388-.21.37-.17.699-.4.96-.757.272-.373.447-.834.47-1.423.001-.006.003-.01.003-.016a6.976 6.976 0 0 0-2.334-5.166 7.004 7.004 0 0 0-10.027 1.27 7.004 7.004 0 0 0 1.928 9.727A6.976 6.976 0 0 0 8 15z" />
                            </svg>
                            Design System
                        </a>
                        <div class="dropdown-divider"></div>
                        <!-- Support & Community -->
                        <a href="https://github.com/SciTeX-AI"
                           class="dropdown-item"
                           target="_blank">
                            <img src="{% static 'shared/images/scitex_logos/vectorstock/vectorstock_38853699-navy-inverted.svg' %}"
                                 alt=""
                                 style="display: inline-block;
                                        vertical-align: text-bottom;
                                        margin-right: 8px;
                                        width: 16px;
                                        height: 16px;
                                        opacity: 0.85" />
                            GitHub
                        </a>
                        <a href="{% url 'public_app:donate' %}" class="dropdown-item">
                            <svg width="16"
                                 height="16"
                                 viewBox="0 0 16 16"
                                 fill="currentColor"
                                 style="display: inline-block;
                                        vertical-align: text-bottom;
                                        margin-right: 8px">
                                <path d="m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523 1.023-.641 2.5.314 4.385.92 1.815 2.834 3.989 6.286 6.357 3.452-2.368 5.365-4.542 6.286-6.357.955-1.886.838-3.362.314-4.385C13.486.878 10.4.28 8.717 2.01L8 2.748zM8 15C-7.333 4.868 3.279-3.04 7.824 1.143c.06.055.119.112.176.171a3.12 3.12 0 0 1 .176-.17C12.72-3.042 23.333 4.867 8 15z" />
                            </svg>
                            Support SciTeX
                        </a>
                        <div class="dropdown-divider"></div>
                        <!-- Sign Out -->
                        <a href="/auth/logout/" class="dropdown-item">
                            <svg width="16"
                                 height="16"
                                 viewBox="0 0 16 16"
                                 fill="currentColor"
                                 style="display: inline-block;
                                        vertical-align: text-bottom;
                                        margin-right: 8px">
                                <path fill-rule="evenodd" d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0v2z" />
                                <path fill-rule="evenodd" d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z" />
                            </svg>
                            Sign out
                        </a>
                    </div>
                </div>
            {% else %}
                <!-- Not logged in -->
                <a href="/auth/signin/"
                   class="header-btn"
                   data-tooltip="Sign in to your account">Sign in</a>
                <a href="/auth/signup/"
                   class="header-btn"
                   data-tooltip="Create a new account">Sign up</a>
            {% endif %}
        </div>
    </div>
</header>
<!-- JavaScript for dropdown menu -->

{% comment %} JavaScript functionality extracted to separate partial {% endcomment %}
{% include 'global_base_partials/global_header/scripts.html' %}
