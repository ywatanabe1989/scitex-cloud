{% load static %}
<!-- GitHub-Style Global Header -->
<header class="global-header">
    <div class="global-header-inner">
        <!-- Left: Logo + Main Navigation -->
        <div class="header-left">
            <!-- Logo -->
            <a href="/"
               class="header-logo"
               data-tooltip="Go to home page">
                <img src="{% static 'shared/images/scitex_logos/scitex-logo-cropped.png' %}"
                     alt="SciTeX"
                     class="header-logo-img" />
            </a>
            <!-- Primary Navigation -->
            <nav class="header-nav">
                <!-- Files - Direct link to user's repositories -->
                {% if user.is_authenticated %}
                    <a href="/{{ user.username }}/"
                       class="header-nav-item {% if user.username in request.path and 'explore' not in request.path %}active{% endif %}"
                       data-tooltip="Your repositories">
                        <i class="fas fa-book-open nav-icon-fa" style="font-size: 16px"></i>
                        <span class="nav-label">Files</span>
                    </a>
                {% else %}
                    <a href="/auth/signup/"
                       class="header-nav-item"
                       data-tooltip="Sign up to manage your files">
                        <i class="fas fa-book-open nav-icon-fa" style="font-size: 16px"></i>
                        <span class="nav-label">Files</span>
                    </a>
                {% endif %}
                {% comment %} Module links - All users now navigate to dedicated module
        endpoints: - /scholar/ - Scholar app with project selector - /code/ -
        Code module (project-centric via sessionStorage) - /viz/ - Viz module
        (project-centric via sessionStorage) - /writer/ - Writer module
                (project-centric via sessionStorage) {% endcomment %}
                <!-- Scholar Module -->
                <a href="/scholar/bibtex/"
                   class="header-nav-item {% if 'scholar' in request.path %}active{% endif %}"
                   data-tooltip="Citation Management">
                    <img src="{% static 'shared/images/icons_svg/scitex-scholar-icon.svg' %}"
                         alt=""
                         class="nav-icon" />
                    <span class="nav-label">Scholar</span>
                </a>
                <a href="/code/"
                   class="header-nav-item {% if 'code' in request.path %}active{% endif %}"
                   data-tooltip="Code workspace">
                    <img src="{% static 'shared/images/icons_svg/scitex-code-icon.svg' %}"
                         alt=""
                         class="nav-icon" />
                    <span class="nav-label">Code</span>
                </a>
                <a href="/vis/"
                   class="header-nav-item {% if 'vis' in request.path %}active{% endif %}"
                   data-tooltip="Scientific Figure Editor">
                    <img src="{% static 'shared/images/icons_svg/scitex-viz-icon.svg' %}"
                         alt=""
                         class="nav-icon" />
                    <span class="nav-label">Vis</span>
                </a>
                <a href="/writer/"
                   class="header-nav-item {% if 'writer' in request.path %}active{% endif %}"
                   data-tooltip="Manuscript writing">
                    <i class="fas fa-pen-nib nav-icon-fa" style="font-size: 16px"></i>
                    <span class="nav-label">Writer</span>
                </a>
                <a href="/tools/"
                   class="header-nav-item {% if 'tools' in request.path %}active{% endif %}"
                   data-tooltip="Research tools and bookmarklets">
                    <i class="fas fa-toolbox nav-icon-fa" style="font-size: 16px"></i>
                    <span class="nav-label">Tools</span>
                </a>
                <!-- Explore - Browse other users' work -->
                <a href="/social/explore/"
                   class="header-nav-item {% if 'explore' in request.path %}active{% endif %}"
                   data-tooltip="Explore other users' work">
                    <img src="{% static 'shared/images/icons_svg/scitex-explore-icon-v2.svg' %}"
                         alt=""
                         class="nav-icon-svg" />
                    <span class="nav-label">Explore</span>
                </a>
            </nav>
        </div>
        <!-- Project Selector (for all users) - Custom Dropdown Menu -->
        <div class="header-project-selector">
            <!-- Project Dropdown Button -->
            <button id="project-selector-toggle"
                    class="project-selector-btn"
                    title="{% if user.is_authenticated %}Switch projects{% else %}Current project{% endif %}">
                <span id="project-selector-text" class="project-selector-text">
                    {% if user.is_authenticated %}
                        {% if user.profile.last_active_repository %}
                            {{ user.profile.last_active_repository.name }}
                        {% else %}
                            {% with projects=user.profile.get_user_projects %}
                                {% if projects|length > 0 %}
                                    {% for project in projects %}
                                        {% if forloop.first %}{{ project.name }}{% endif %}
                                    {% endfor %}
                                {% else %}
                                    Projects
                                {% endif %}
                            {% endwith %}
                        {% endif %}
                    {% else %}
                        {% comment %}Visitor mode - show allocated default project from context{% endcomment %}
                        {% if project %}
                            {{ project.name }}
                        {% else %}
                            default-project
                        {% endif %}
                    {% endif %}
                </span>
                <svg width="12"
                     height="12"
                     viewBox="0 0 16 16"
                     fill="currentColor"
                     style="margin-left: 4px">
                    <path d="M4 6l4 4 4-4H4z" />
                </svg>
            </button>
            <!-- Project Dropdown Menu -->
            <div id="project-selector-dropdown"
                 class="project-selector-dropdown"
                 style="display: none">
                {% if user.is_authenticated %}
                    {% if user.profile.get_user_projects %}
                        <div class="dropdown-section">
                            {% for project in user.profile.get_user_projects %}
                                <button type="button"
                                        class="dropdown-project-item"
                                        data-project-id="{{ project.id }}"
                                        data-project-name="{{ project.name }}"
                                        data-project-slug="{{ project.slug }}"
                                        data-project-owner="{{ project.owner.username }}">
                                    <span class="project-item-name">{{ project.name }}</span>
                                    <div style="display: flex;
                                                align-items: center;
                                                gap: 4px;
                                                margin-left: auto">
                                        <a href="/{{ project.owner.username }}/{{ project.slug }}/"
                                           class="project-item-jump-btn"
                                           title="Go to {{ project.name }} repository"
                                           onclick="event.stopPropagation();"
                                           target="_blank"
                                           style="display: inline-flex;
                                                  align-items: center;
                                                  justify-content: center;
                                                  width: 20px;
                                                  height: 20px;
                                                  border-radius: 3px;
                                                  color: var(--color-fg-muted);
                                                  text-decoration: none;
                                                  transition: all 0.15s ease">
                                            <i class="fas fa-folder-open" style="font-size: 11px"></i>
                                        </a>
                                        <span class="project-item-check"
                                              style="display: {% if user.profile.last_active_repository and user.profile.last_active_repository.id == project.id %}inline-flex{% else %}none{% endif %};
                                                     align-items: center;
                                                     justify-content: center">
                                            <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
                                                <path d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 11-1.06-1.06L12.72 4.22a.75.75 0 011.06 0z" />
                                            </svg>
                                        </span>
                                    </div>
                                </button>
                            {% endfor %}
                        </div>
                        <div class="dropdown-divider"></div>
                    {% endif %}
                    <!-- Create New Project Option (authenticated users only) -->
                    <a href="/new/" class="dropdown-project-item dropdown-create-new">
                        <svg width="14"
                             height="14"
                             viewBox="0 0 16 16"
                             fill="currentColor"
                             style="margin-right: 6px">
                            <path d="M8 0a1 1 0 0 1 1 1v6h6a1 1 0 1 1 0 2H9v6a1 1 0 1 1-2 0V9H1a1 1 0 0 1 0-2h6V1a1 1 0 0 1 1-1z" />
                        </svg>
                        <span>Create New Project</span>
                    </a>
                {% else %}
                    <!-- Visitor mode - show current project info -->
                    {% if project %}
                        <div class="dropdown-section">
                            <div class="dropdown-section-title">Current Project</div>
                            <div class="dropdown-project-item" style="cursor: default; opacity: 0.9">
                                <span class="project-item-name">{{ project.name }}</span>
                                <span class="project-item-check" style="display: inline">
                                    <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
                                        <path d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 11-1.06-1.06L12.72 4.22a.75.75 0 011.06 0z" />
                                    </svg>
                                </span>
                            </div>
                            <div style="padding: 12px;
                                        font-size: 12px;
                                        color: var(--color-fg-muted);
                                        line-height: 1.5">
                                <svg width="14"
                                     height="14"
                                     viewBox="0 0 16 16"
                                     fill="currentColor"
                                     style="margin-right: 4px;
                                            vertical-align: text-bottom">
                                    <path d="M8 1a.5.5 0 0 1 .5.5v.518A7.001 7.001 0 0 1 14.954 7.5h.518a.5.5 0 0 1 0 1h-.518A7.001 7.001 0 0 1 8.5 14.482v.518a.5.5 0 0 1-1 0v-.518A7.001 7.001 0 0 1 1.046 8.5H.528a.5.5 0 0 1 0-1h.518A7.001 7.001 0 0 1 7.5 2.018V1.5A.5.5 0 0 1 8 1zm-.5 2.02A6.001 6.001 0 0 0 2.02 7.5h.48a.5.5 0 0 1 0 1h-.48A6.001 6.001 0 0 0 7.5 13.98v-.48a.5.5 0 0 1 1 0v.48A6.001 6.001 0 0 0 13.98 8.5h-.48a.5.5 0 0 1 0-1h.48A6.001 6.001 0 0 0 8.5 3.02v.48a.5.5 0 0 1-1 0v-.48z" />
                                </svg>
                                Visitor mode: Your work won't be saved permanently. Sign up to keep
                                it!
                            </div>
                        </div>
                        <div class="dropdown-divider"></div>
                    {% endif %}
                    <!-- Sign up to save (visitors) -->
                    <a href="/auth/signup/"
                       class="dropdown-project-item dropdown-create-new">
                        <svg width="14"
                             height="14"
                             viewBox="0 0 16 16"
                             fill="currentColor"
                             style="margin-right: 6px">
                            <path d="M8 0a1 1 0 0 1 1 1v6h6a1 1 0 1 1 0 2H9v6a1 1 0 1 1-2 0V9H1a1 1 0 0 1 0-2h6V1a1 1 0 0 1 1-1z" />
                        </svg>
                        <span>Sign up to save your work</span>
                    </a>
                {% endif %}
            </div>
        </div>
        <!-- Center: Search -->
        <div class="header-center">
            <div class="header-search">
                <img src="{% static 'shared/images/icons_svg/scitex-search-icon.svg' %}"
                     alt=""
                     class="header-search-icon" />
                <input type="text"
                       placeholder="Search or jump to..."
                       id="global-search"
                       autocomplete="off"
                       readonly />
                <kbd class="search-shortcut-badge">/</kbd>
            </div>
        </div>
        <!-- Search Modal (GitHub-style) -->
        <div id="search-modal" class="search-modal" style="display: none">
            <div class="search-modal-backdrop"></div>
            <div class="search-modal-content">
                <div class="search-modal-header">
                    <div class="search-modal-input-wrapper">
                        <img src="{% static 'shared/images/icons_svg/scitex-search-icon.svg' %}"
                             alt=""
                             class="search-modal-icon" />
                        <input type="text"
                               id="search-modal-input"
                               class="search-modal-input"
                               placeholder="Search or jump to..."
                               autocomplete="off"
                               autofocus />
                    </div>
                </div>
                <div class="search-modal-results" id="search-modal-results">
                    <!-- Results will be populated here -->
                </div>
                <div class="search-modal-footer">
                    <a href="#" class="search-modal-footer-link">Search syntax tips</a>
                    <a href="#" class="search-modal-footer-link">Give feedback</a>
                </div>
            </div>
        </div>
        <!-- Right: Actions + User Menu -->
        <div class="header-right">
            <!-- Theme Toggle (always visible) -->
            <button id="theme-toggle"
                    class="theme-toggle"
                    data-tooltip="Toggle light/dark theme">ðŸŒ“</button>
            <!-- Refresh Button (Ctrl+Shift+R alternative) -->
            <button id="page-refresh-btn"
                    class="theme-toggle"
                    data-tooltip="Refresh page (Ctrl+Shift+R)"
                    style="font-size: 18px;">
                <i class="fas fa-sync-alt"></i>
            </button>
            {% if not user.is_authenticated %}
                <!-- Visitor Mode indicator -->
                <span class="header-visitor-badge"
                      data-tooltip="Your work won't be saved. Sign up to save permanently.">
                    <svg width="14"
                         height="14"
                         viewBox="0 0 16 16"
                         fill="currentColor"
                         style="margin-right: 4px;
                                vertical-align: text-bottom">
                        <path d="M8 1a.5.5 0 0 1 .5.5v.518A7.001 7.001 0 0 1 14.954 7.5h.518a.5.5 0 0 1 0 1h-.518A7.001 7.001 0 0 1 8.5 14.482v.518a.5.5 0 0 1-1 0v-.518A7.001 7.001 0 0 1 1.046 8.5H.528a.5.5 0 0 1 0-1h.518A7.001 7.001 0 0 1 7.5 2.018V1.5A.5.5 0 0 1 8 1zm-.5 2.02A6.001 6.001 0 0 0 2.02 7.5h.48a.5.5 0 0 1 0 1h-.48A6.001 6.001 0 0 0 7.5 13.98v-.48a.5.5 0 0 1 1 0v.48A6.001 6.001 0 0 0 13.98 8.5h-.48a.5.5 0 0 1 0-1h.48A6.001 6.001 0 0 0 8.5 3.02v.48a.5.5 0 0 1-1 0v-.48z" />
                    </svg>
                    Visitor Mode
                </span>
            {% endif %}
            {% if user.is_authenticated %}
                <!-- User Menu -->
                <div class="header-user-menu">
                    <button class="header-user-toggle" id="user-menu-toggle">
                        <div class="header-avatar">
                            {% if user.profile.avatar %}
                                <img src="{{ user.profile.avatar.url }}" alt="{{ user.username }}" />
                            {% else %}
                                {{ user.username|slice:":1"|upper }}
                            {% endif %}
                        </div>
                        <svg width="12"
                             height="12"
                             viewBox="0 0 16 16"
                             fill="currentColor"
                             style="margin-left: 4px">
                            <path d="M4 6l4 4 4-4H4z" />
                        </svg>
                    </button>
                    <div class="header-dropdown" id="user-menu-dropdown" style="display: none">
                        <!-- User Info Header -->
                        <div class="dropdown-header">
                            <div class="dropdown-user-info">
                                <strong>{{ user.get_full_name|default:user.username }}</strong>
                                <div class="dropdown-user-username">@{{ user.username }}</div>
                            </div>
                        </div>
                        <!-- Account Switcher (Multi-account support) -->
                        <div class="dropdown-divider"></div>
                        <div id="account-switcher-container" style="padding: 8px 16px">
                            <!-- Switcher dropdown (only shown when multiple accounts) -->
                            <div id="account-switcher-dropdown-wrapper" style="display: none">
                                <div style="font-size: 12px;
                                            color: var(--color-fg-muted);
                                            margin-bottom: 8px;
                                            font-weight: 600">
                                    <svg width="14"
                                         height="14"
                                         viewBox="0 0 16 16"
                                         fill="currentColor"
                                         style="margin-right: 4px;
                                                vertical-align: text-bottom">
                                        <path d="M10.5 5a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0zm.061 3.073a4 4 0 1 0-5.123 0 6.004 6.004 0 0 0-3.431 5.142.75.75 0 0 0 1.498.07 4.5 4.5 0 0 1 8.99 0 .75.75 0 1 0 1.498-.07 6.005 6.005 0 0 0-3.432-5.142z" />
                                    </svg>
                                    Switch Account
                                </div>
                                <select id="account-switcher"
                                        style="width: 100%;
                                               padding: 6px 8px;
                                               border: 1px solid var(--color-border-default);
                                               border-radius: 6px;
                                               background: var(--color-canvas-default);
                                               color: var(--color-fg-default);
                                               margin-bottom: 8px">
                                    <option value="">Loading...</option>
                                </select>
                            </div>
                            <!-- Add account link (always visible) -->
                            <a href="/auth/login/?next={{ request.path }}"
                               class="dropdown-item"
                               style="padding: 4px 0;
                                      font-size: 13px">
                                <svg width="14"
                                     height="14"
                                     viewBox="0 0 16 16"
                                     fill="currentColor"
                                     style="margin-right: 6px;
                                            vertical-align: text-bottom">
                                    <path d="M8 0a1 1 0 0 1 1 1v6h6a1 1 0 1 1 0 2H9v6a1 1 0 1 1-2 0V9H1a1 1 0 0 1 0-2h6V1a1 1 0 0 1 1-1z" />
                                </svg>
                                Add another account
                            </a>
                        </div>
                        <div class="dropdown-divider"></div>
                        <!-- Settings -->
                        <a href="{% url 'accounts_app:profile_edit' %}" class="dropdown-item">
                            <svg width="16"
                                 height="16"
                                 viewBox="0 0 16 16"
                                 fill="currentColor"
                                 style="display: inline-block;
                                        vertical-align: text-bottom;
                                        margin-right: 8px">
                                <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z" />
                                <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319z" />
                            </svg>
                            Settings
                        </a>
                        <div class="dropdown-divider"></div>
                        <!-- Developer Tools -->
                        <a href="/dev/" class="dropdown-item">
                            <svg width="16"
                                 height="16"
                                 viewBox="0 0 16 16"
                                 fill="currentColor"
                                 style="display: inline-block;
                                        vertical-align: text-bottom;
                                        margin-right: 8px">
                                <path d="M15 5a1 1 0 0 0-1-1H2a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V5zM0 5a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V5zm3.5 1a.5.5 0 0 0 0 1h1a.5.5 0 0 0 0-1h-1zM5 8.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 0 1h-1a.5.5 0 0 1-.5-.5zm2 1.5a.5.5 0 0 0 0 1h1a.5.5 0 0 0 0-1h-1z" />
                            </svg>
                            Developer Tools
                        </a>
                        <a href="/dev/design/" class="dropdown-item">
                            <svg width="16"
                                 height="16"
                                 viewBox="0 0 16 16"
                                 fill="currentColor"
                                 style="display: inline-block;
                                        vertical-align: text-bottom;
                                        margin-right: 8px">
                                <path d="M8 5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3zm4 3a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3zM5.5 7a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm.5 6a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3z" />
                                <path d="M16 8c0 3.15-1.866 2.585-3.567 2.07C11.42 9.763 10.465 9.473 10 10c-.603.683-.475 1.819-.351 2.92C9.826 14.495 9.996 16 8 16a8 8 0 1 1 8-8zm-8 7c.611 0 .654-.171.655-.176.078-.146.124-.464.07-1.119-.014-.168-.037-.37-.061-.591-.052-.464-.112-1.005-.118-1.462-.01-.707.083-1.61.704-2.314.417-.469.923-.707 1.455-.832.532-.125 1.09-.14 1.617-.157.526-.016 1.004-.032 1.388-.21.37-.17.699-.4.96-.757.272-.373.447-.834.47-1.423.001-.006.003-.01.003-.016a6.976 6.976 0 0 0-2.334-5.166 7.004 7.004 0 0 0-10.027 1.27 7.004 7.004 0 0 0 1.928 9.727A6.976 6.976 0 0 0 8 15z" />
                            </svg>
                            Design System
                        </a>
                        <div class="dropdown-divider"></div>
                        <!-- Support & Community -->
                        <a href="https://github.com/SciTeX-AI"
                           class="dropdown-item"
                           target="_blank">
                            <img src="{% static 'shared/images/scitex_logos/vectorstock/vectorstock_38853699-navy-inverted.svg' %}"
                                 alt=""
                                 style="display: inline-block;
                                        vertical-align: text-bottom;
                                        margin-right: 8px;
                                        width: 16px;
                                        height: 16px;
                                        opacity: 0.85" />
                            GitHub
                        </a>
                        <a href="{% url 'public_app:donate' %}" class="dropdown-item">
                            <svg width="16"
                                 height="16"
                                 viewBox="0 0 16 16"
                                 fill="currentColor"
                                 style="display: inline-block;
                                        vertical-align: text-bottom;
                                        margin-right: 8px">
                                <path d="m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523 1.023-.641 2.5.314 4.385.92 1.815 2.834 3.989 6.286 6.357 3.452-2.368 5.365-4.542 6.286-6.357.955-1.886.838-3.362.314-4.385C13.486.878 10.4.28 8.717 2.01L8 2.748zM8 15C-7.333 4.868 3.279-3.04 7.824 1.143c.06.055.119.112.176.171a3.12 3.12 0 0 1 .176-.17C12.72-3.042 23.333 4.867 8 15z" />
                            </svg>
                            Support SciTeX
                        </a>
                        <div class="dropdown-divider"></div>
                        <!-- Sign Out -->
                        <a href="/auth/logout/" class="dropdown-item">
                            <svg width="16"
                                 height="16"
                                 viewBox="0 0 16 16"
                                 fill="currentColor"
                                 style="display: inline-block;
                                        vertical-align: text-bottom;
                                        margin-right: 8px">
                                <path fill-rule="evenodd" d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0v2z" />
                                <path fill-rule="evenodd" d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z" />
                            </svg>
                            Sign out
                        </a>
                    </div>
                </div>
            {% else %}
                <!-- Not logged in -->
                <a href="/auth/signin/"
                   class="header-btn"
                   data-tooltip="Sign in to your account">Sign in</a>
                <a href="/auth/signup/"
                   class="header-btn"
                   data-tooltip="Create a new account">Sign up</a>
            {% endif %}
        </div>
    </div>
</header>
<!-- JavaScript for dropdown menu -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Generic dropdown functionality for all header nav dropdowns
    const dropdownGroups = document.querySelectorAll(".header-dropdown-group");

    dropdownGroups.forEach((group) => {
      const toggle = group.querySelector(".header-dropdown-toggle");
      const dropdown = group.querySelector(".header-nav-dropdown");

      if (toggle && dropdown) {
        let hideTimeout;

        // Show dropdown on hover over toggle
        toggle.addEventListener("mouseenter", function () {
          clearTimeout(hideTimeout);

          // Close other dropdowns first
          document
            .querySelectorAll(".header-nav-dropdown")
            .forEach((otherDropdown) => {
              if (otherDropdown !== dropdown) {
                otherDropdown.style.display = "none";
              }
            });

          dropdown.style.display = "block";
        });

        // Keep dropdown open when hovering over it
        dropdown.addEventListener("mouseenter", function () {
          clearTimeout(hideTimeout);
          dropdown.style.display = "block";
        });

        // Start hide timer when leaving toggle
        toggle.addEventListener("mouseleave", function () {
          hideTimeout = setTimeout(() => {
            dropdown.style.display = "none";
          }, 200);
        });

        // Start hide timer when leaving dropdown
        dropdown.addEventListener("mouseleave", function () {
          hideTimeout = setTimeout(() => {
            dropdown.style.display = "none";
          }, 200);
        });
      }
    });

    // Close all dropdowns when clicking outside
    document.addEventListener("click", function (e) {
      if (!e.target.closest(".header-dropdown-group")) {
        document
          .querySelectorAll(".header-nav-dropdown")
          .forEach((dropdown) => {
            dropdown.style.display = "none";
          });
      }
    });

    // Close all dropdowns when pressing Escape
    document.addEventListener("keydown", function (e) {
      if (e.key === "Escape") {
        document
          .querySelectorAll(".header-nav-dropdown")
          .forEach((dropdown) => {
            dropdown.style.display = "none";
          });
      }
    });

    const userMenuToggle = document.getElementById("user-menu-toggle");
    const userMenuDropdown = document.getElementById("user-menu-dropdown");

    if (userMenuToggle && userMenuDropdown) {
      userMenuToggle.addEventListener("click", function (e) {
        e.stopPropagation();
        const isVisible = userMenuDropdown.style.display !== "none";
        userMenuDropdown.style.display = isVisible ? "none" : "block";
      });

      // Close dropdown when clicking outside
      document.addEventListener("click", function (e) {
        if (
          !userMenuToggle.contains(e.target) &&
          !userMenuDropdown.contains(e.target)
        ) {
          userMenuDropdown.style.display = "none";
        }
      });

      // Close dropdown when pressing Escape
      document.addEventListener("keydown", function (e) {
        if (e.key === "Escape") {
          userMenuDropdown.style.display = "none";
        }
      });
    }

    // Global search functionality with autocomplete
    const globalSearch = document.getElementById("global-search");
    if (globalSearch) {
      // Submit on Enter
      globalSearch.addEventListener("keypress", function (e) {
        if (e.key === "Enter") {
          const query = this.value.trim();
          if (query) {
            window.location.href = `/search/?q=${encodeURIComponent(query)}`;
          }
        }
      });

      // Autocomplete (debounced)
      let autocompleteTimeout;
      globalSearch.addEventListener("input", function (e) {
        clearTimeout(autocompleteTimeout);
        const query = this.value.trim();

        if (query.length < 2) {
          hideAutocomplete();
          return;
        }

        autocompleteTimeout = setTimeout(async () => {
          try {
            const response = await fetch(
              `/search/api/autocomplete/?q=${encodeURIComponent(query)}`,
            );
            const data = await response.json();
            showAutocomplete(data.suggestions);
          } catch (err) {
            console.error("Autocomplete error:", err);
          }
        }, 300); // 300ms debounce
      });
    }

    // Autocomplete UI helpers - GitHub-style grouped results
    function showAutocomplete(suggestions) {
      let dropdown = document.getElementById("search-autocomplete");
      if (!dropdown) {
        dropdown = document.createElement("div");
        dropdown.id = "search-autocomplete";
        dropdown.style.cssText = `
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: var(--color-canvas-default);
        border: 1px solid var(--color-border-default);
        border-radius: 6px;
        box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        max-height: 500px;
        overflow-y: auto;
        z-index: 1000;
        margin-top: 8px;
      `;
        document.querySelector(".header-search").appendChild(dropdown);
      }

      if (suggestions.length === 0) {
        hideAutocomplete();
        return;
      }

      // Group suggestions by type
      const grouped = suggestions.reduce((acc, item) => {
        const type = item.type || "other";
        if (!acc[type]) acc[type] = [];
        acc[type].push(item);
        return acc;
      }, {});

      // Render grouped results
      let html = "";
      const typeLabels = {
        users: "Owners",
        repositories: "Repositories",
        other: "Other",
      };

      Object.keys(grouped).forEach((type) => {
        const label = typeLabels[type] || type;
        html += `
        <div style="padding: 8px 12px 4px; font-size: 11px; font-weight: 600; color: var(--color-fg-muted); text-transform: uppercase; letter-spacing: 0.5px;">
          ${label}
        </div>
      `;

        grouped[type].forEach((s) => {
          html += `
          <a href="${s.url}" class="search-result-item" style=" display: flex; align-items: center; gap: 12px; padding: 8px 12px; color: var(--color-fg-default); text-decoration: none; border-bottom: 1px solid var(--color-border-muted); " onmouseover="this.style.background='var(--color-canvas-subtle)'" onmouseout="this.style.background='transparent'">
            <span style="font-size: 16px; opacity: 0.7;">${s.icon || "ðŸ“„"}</span>
            <div style="flex: 1; min-width: 0;">
              <div style="font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${s.title}</div>
              ${s.subtitle ? `<div style="font-size: 12px; color: var(--color-fg-muted); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${s.subtitle}</div>` : ""}
            </div>
            <div style="font-size: 12px; color: var(--color-fg-muted); white-space: nowrap;">Jump to</div>
          </a>
        `;
        });
      });

      dropdown.innerHTML = html;
      dropdown.style.display = "block";
    }

    function hideAutocomplete() {
      const dropdown = document.getElementById("search-autocomplete");
      if (dropdown) {
        dropdown.style.display = "none";
      }
    }

    // Close autocomplete on click outside
    document.addEventListener("click", function (e) {
      if (!document.querySelector(".header-search")?.contains(e.target)) {
        hideAutocomplete();
      }
    });

    // Note: Theme toggle functionality is handled by /static/js/theme-switcher.js

    // Project selector dropdown functionality
    const projectToggle = document.getElementById("project-selector-toggle");
    const projectDropdown = document.getElementById(
      "project-selector-dropdown",
    );
    const projectItems = document.querySelectorAll(
      ".dropdown-project-item:not(.dropdown-create-new)",
    );
    const projectSelectorText = document.getElementById(
      "project-selector-text",
    );

    let currentProjectSlug = null;
    let currentProjectOwner = null;

    if (projectToggle && projectDropdown) {
      // Toggle dropdown visibility
      projectToggle.addEventListener("click", function (e) {
        e.stopPropagation();
        const isVisible = projectDropdown.style.display !== "none";
        projectDropdown.style.display = isVisible ? "none" : "block";
      });

      // Handle project selection
      projectItems.forEach((item) => {
        item.addEventListener("click", function (e) {
          e.preventDefault();
          const projectId = this.getAttribute("data-project-id");
          const projectName = this.getAttribute("data-project-name");
          const projectSlug = this.getAttribute("data-project-slug");
          const projectOwner = this.getAttribute("data-project-owner");

          // Update selected state
          projectItems.forEach((i) => i.classList.remove("active"));
          this.classList.add("active");

          // Update the check marks
          document.querySelectorAll(".project-item-check").forEach((check) => {
            check.style.display = "none";
          });
          this.querySelector(".project-item-check").style.display = "inline";

          // Update button text
          projectSelectorText.textContent = projectName;

          // Store selected project ID, slug, and owner
          sessionStorage.setItem("scholar_selected_project_id", projectId);
          currentProjectSlug = projectSlug;
          currentProjectOwner = projectOwner;

          // Close dropdown
          projectDropdown.style.display = "none";
        });
      });

      // Close dropdown when clicking outside
      document.addEventListener("click", function (e) {
        if (
          !projectToggle.contains(e.target) &&
          !projectDropdown.contains(e.target)
        ) {
          projectDropdown.style.display = "none";
        }
      });

      // Keyboard navigation: Alt+P removed to avoid conflict with Emacs C-p/M-p
      // Users can click the project selector button directly

      // Initialize current project info
      const selectedItem = document.querySelector(
        ".dropdown-project-item:not(.dropdown-create-new).active",
      );
      if (selectedItem || projectItems.length > 0) {
        const currentItem = selectedItem || projectItems[0];
        const projectSlug = currentItem.getAttribute("data-project-slug");
        const projectOwner = currentItem.getAttribute("data-project-owner");
        currentProjectSlug = projectSlug;
        currentProjectOwner = projectOwner;
      }
    }

    // Account Switcher (Multi-account support)
    const accountSwitcher = document.getElementById("account-switcher");
    const accountSwitcherDropdownWrapper = document.getElementById(
      "account-switcher-dropdown-wrapper",
    );

    if (accountSwitcher) {
      // Load authenticated accounts
      fetch("/auth/api/authenticated-accounts/")
        .then((response) => response.json())
        .then((data) => {
          const accounts = data.accounts || [];
          const currentUserId = data.current_user_id;

          if (accounts.length <= 1) {
            // Hide dropdown selector if only one account, but keep "Add another account" visible
            if (accountSwitcherDropdownWrapper) {
              accountSwitcherDropdownWrapper.style.display = "none";
            }
            return;
          }

          // Show dropdown wrapper
          if (accountSwitcherDropdownWrapper) {
            accountSwitcherDropdownWrapper.style.display = "block";
          }

          accountSwitcher.innerHTML =
            '<option value="">-- Switch to --</option>';
          accounts.forEach((account) => {
            const isCurrentUser = account.user_id === currentUserId;
            const displayName = account.full_name || account.username;

            const option = document.createElement("option");
            option.value = account.user_id;
            option.textContent = `${displayName} ${isCurrentUser ? "(current)" : ""}`;
            option.disabled = isCurrentUser;
            accountSwitcher.appendChild(option);
          });

          // Handle account switch
          accountSwitcher.addEventListener("change", function () {
            const userId = this.value;
            if (userId) {
              const currentUrl = window.location.href;
              window.location.href = `/auth/switch/${userId}/?next=${encodeURIComponent(currentUrl)}`;
            }
          });
        })
        .catch((err) => {
          console.error("Failed to load authenticated accounts:", err);
          if (accountSwitcherDropdownWrapper) {
            accountSwitcherDropdownWrapper.style.display = "none";
          }
        });
    }

    // Search Modal Management
    const searchModal = document.getElementById("search-modal");
    const searchModalInput = document.getElementById("search-modal-input");
    const searchModalResults = document.getElementById("search-modal-results");
    const globalSearchInput = document.getElementById("global-search");

    // Open modal when clicking header search or pressing "/"
    function openSearchModal() {
      if (searchModal) {
        searchModal.style.display = "block";
        document.body.style.overflow = "hidden";
        setTimeout(() => {
          if (searchModalInput) {
            searchModalInput.focus();
          }
        }, 100);
      }
    }

    // Close modal
    function closeSearchModal() {
      if (searchModal) {
        searchModal.style.display = "none";
        document.body.style.overflow = "";
        if (searchModalInput) {
          searchModalInput.value = "";
        }
        if (searchModalResults) {
          searchModalResults.innerHTML = "";
        }
      }
    }

    // Click on header search input
    if (globalSearchInput) {
      globalSearchInput.addEventListener("click", function (e) {
        e.preventDefault();
        openSearchModal();
      });
    }

    // Search keyboard shortcuts: only "/" to open global modal
    // Note: Ctrl+K is reserved for page-specific search (browse, profile, etc.)
    document.addEventListener("keydown", function (e) {
      // "/" to open modal (only if not in an input/textarea)
      if (
        e.key === "/" &&
        !["INPUT", "TEXTAREA"].includes(document.activeElement.tagName)
      ) {
        e.preventDefault();
        openSearchModal();
      }

      // Close modal on Escape
      if (
        e.key === "Escape" &&
        searchModal &&
        searchModal.style.display === "block"
      ) {
        closeSearchModal();
      }
    });

    // Close modal when clicking backdrop
    if (searchModal) {
      searchModal.addEventListener("click", function (e) {
        if (
          e.target.classList.contains("search-modal-backdrop") ||
          e.target.classList.contains("search-modal")
        ) {
          closeSearchModal();
        }
      });
    }

    // Search modal input handler
    if (searchModalInput) {
      let searchTimeout;
      searchModalInput.addEventListener("input", function () {
        clearTimeout(searchTimeout);
        const query = this.value.trim();

        if (query.length < 2) {
          searchModalResults.innerHTML = "";
          return;
        }

        searchTimeout = setTimeout(async () => {
          try {
            const response = await fetch(
              `/search/api/autocomplete/?q=${encodeURIComponent(query)}`,
            );
            const data = await response.json();
            showModalResults(data.suggestions || []);
          } catch (err) {
            console.error("Search error:", err);
          }
        }, 200);
      });
    }

    // Show results in modal
    function showModalResults(suggestions) {
      if (!searchModalResults) return;

      if (suggestions.length === 0) {
        searchModalResults.innerHTML =
          '<div style="padding: 24px; text-align: center; color: var(--color-fg-muted);">No results found</div>';
        return;
      }

      // Group suggestions by type
      const grouped = suggestions.reduce((acc, item) => {
        const type = item.type || "other";
        if (!acc[type]) acc[type] = [];
        acc[type].push(item);
        return acc;
      }, {});

      // Render grouped results
      let html = "";
      const typeLabels = {
        users: "Owners",
        repositories: "Repositories",
        other: "Other",
      };

      Object.keys(grouped).forEach((type) => {
        const label = typeLabels[type] || type;
        html += `
        <div class="search-modal-section-header">${label}</div>
      `;

        grouped[type].forEach((s) => {
          html += `
          <a href="${s.url}" class="search-modal-result-item">
            <span class="search-modal-result-icon">${s.icon || "ðŸ“„"}</span>
            <div class="search-modal-result-content">
              <div class="search-modal-result-title">${s.title}</div>
              ${s.subtitle ? `<div class="search-modal-result-subtitle">${s.subtitle}</div>` : ""}
            </div>
            <div class="search-modal-result-action">Jump to</div>
          </a>
        `;
        });
      });

      searchModalResults.innerHTML = html;
    }

    // Page refresh button handler
    const pageRefreshBtn = document.getElementById("page-refresh-btn");
    if (pageRefreshBtn) {
      pageRefreshBtn.addEventListener("click", function (e) {
        e.preventDefault();

        // Add spinning animation
        const icon = this.querySelector("i");
        if (icon) {
          icon.classList.add("fa-spin");
        }

        // Hard refresh (bypass cache) like Ctrl+Shift+R
        window.location.reload(true);
      });
    }
  });
</script>
