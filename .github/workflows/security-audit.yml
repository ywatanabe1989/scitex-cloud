name: Security Audit

on:
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday at midnight
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'requirements.txt'
      - 'requirements/*.txt'

jobs:
  safety-check:
    name: Python Dependency Security Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install safety
        run: pip install safety

      - name: Run safety check
        run: |
          if [ -f requirements.txt ]; then
            safety check --file requirements.txt --json || true
          fi

  bandit:
    name: Python Security Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install bandit
        run: pip install bandit

      - name: Run bandit
        run: |
          bandit -r apps/ config/ -f json -o bandit-report.json || true
          cat bandit-report.json

      - name: Upload bandit results
        uses: actions/upload-artifact@v3
        with:
          name: bandit-security-report
          path: bandit-report.json

  django-check:
    name: Django Security Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt || true

      - name: Run Django security checks
        env:
          SCITEX_CLOUD_DJANGO_SECRET_KEY: 'test-secret-key-for-ci'
          SCITEX_CLOUD_DJANGO_SETTINGS_MODULE: 'config.settings.settings_dev'
        run: |
          python manage.py check --deploy || true
