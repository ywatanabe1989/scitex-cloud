# ============================================
# SciTeX Cloud - Docker Development Environment
# ============================================
# Location: /containers/docker_dev/Makefile.dev

.PHONY: help setup build build-ts start restart stop down logs ps clean rebuild test migrate makemigrations shell createsuperuser collectstatic db-shell db-reset verify-env docker-check-health logs-web logs-db logs-gitea logs-redis exec-web exec-db exec-gitea gitea-token verify-gitea recreate-testuser list-env clean-python dev update reset

.DEFAULT_GOAL := help

# ============================================
# Variables
# ============================================
COMPOSE := docker compose -f docker-compose.yml
WEB_CONTAINER := scitex-cloud-dev-web-1
DB_CONTAINER := scitex-cloud-dev-db-1
GITEA_CONTAINER := scitex-cloud-dev-gitea-1
REDIS_CONTAINER := scitex-cloud-dev-redis-1
SCRIPTS_DIR := .

# Colors for output
GREEN := \033[0;32m
YELLOW := \033[0;33m
RED := \033[0;31m
CYAN := \033[0;36m
NC := \033[0m

# ============================================
# Help (default target)
# ============================================
help:
	@echo ""
	@echo "$(GREEN)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(GREEN)â•‘          SciTeX Cloud - Development Mode              â•‘$(NC)"
	@echo "$(GREEN)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@echo "$(CYAN)ğŸš€ Quick Start:$(NC)"
	@echo "  make start              - Full setup from scratch (recommended)"
	@echo "  make restart            - Quick restart of web container"
	@echo "  make reload             - Super quick reload (for scitex changes)"
	@echo "  make logs               - View all service logs"
	@echo "  make stop               - Stop all services"
	@echo ""
	@echo "$(CYAN)ğŸ³ Docker Services:$(NC)"
	@echo "  make build              - Build Docker images"
	@echo "  make up                 - Start all services (no rebuild)"
	@echo "  make down               - Stop and remove containers"
	@echo "  make ps                 - Show service status"
	@echo "  make rebuild            - Clean rebuild (stops, builds, starts)"
	@echo "  make clean              - Remove containers and volumes (âš ï¸  DANGEROUS)"
	@echo ""
	@echo "$(CYAN)ğŸ Django Management:$(NC)"
	@echo "  make migrate            - Run database migrations"
	@echo "  make makemigrations     - Create new migrations"
	@echo "  make shell              - Open Django shell"
	@echo "  make createsuperuser    - Create superuser account"
	@echo "  make build-ts           - Compile TypeScript to JavaScript"
	@echo "  make collectstatic      - Collect static files (includes compiled JS)"
	@echo "  make test               - Run test suite"
	@echo ""
	@echo "$(CYAN)ğŸ—„ï¸  Database:$(NC)"
	@echo "  make db-shell           - PostgreSQL shell"
	@echo "  make db-reset           - Reset database (âš ï¸  DELETES ALL DATA)"
	@echo ""
	@echo "$(CYAN)ğŸ“‹ Logs & Monitoring:$(NC)"
	@echo "  make logs               - View all service logs"
	@echo "  make logs-web           - View web container logs"
	@echo "  make logs-db            - View database logs"
	@echo "  make logs-gitea         - View Gitea logs"
	@echo "  make logs-redis         - View Redis logs"
	@echo ""
	@echo "$(CYAN)ğŸ”§ Shell Access:$(NC)"
	@echo "  make exec-web           - Shell into web container"
	@echo "  make exec-db            - Shell into database container"
	@echo "  make exec-gitea         - Shell into Gitea container"
	@echo ""
	@echo "$(CYAN)ğŸ”‘ Gitea Management:$(NC)"
	@echo "  make gitea-token        - Generate/verify Gitea API token"
	@echo "  make verify-gitea       - Verify Gitea API access"
	@echo "  make recreate-testuser  - Recreate test user"
	@echo ""
	@echo "$(CYAN)ğŸ§ª Development Shortcuts:$(NC)"
	@echo "  make dev                - Full dev cycle (start + migrate + collectstatic)"
	@echo "  make update             - Quick update (restart)"
	@echo "  make reset              - Full reset (down + clean + start)"
	@echo ""
	@echo "$(YELLOW)Access URLs:$(NC)"
	@echo "  ğŸ“ Django: http://localhost:8000"
	@echo "  ğŸ“ Gitea:  http://localhost:3000"
	@echo ""

# ============================================
# Setup & Build Commands
# ============================================
setup: start migrate build-ts collectstatic
	@echo "$(GREEN)âœ… Development setup complete!$(NC)"

start:
	@echo "$(CYAN)ğŸš€ Starting development environment...$(NC)"
	cd $(CURDIR) && bash $(CURDIR)/start.sh -a start

restart:
	@echo "$(CYAN)ğŸ”„ Restarting web container...$(NC)"
	cd $(CURDIR) && bash $(CURDIR)/start.sh -a restart

reload:
	@echo "$(CYAN)âš¡ Quick reload (for scitex code changes)...$(NC)"
	$(COMPOSE) restart web
	@echo "$(GREEN)âœ… Reloaded!$(NC)"

build:
	@echo "$(CYAN)ğŸ—ï¸  Building Docker images...$(NC)"
	DOCKER_BUILDKIT=1 COMPOSE_DOCKER_CLI_BUILD=1 $(COMPOSE) build --parallel

up:
	@echo "$(CYAN)â¬†ï¸  Starting services...$(NC)"
	$(COMPOSE) up -d
	@echo "$(GREEN)âœ… Services started$(NC)"

down:
	@echo "$(YELLOW)â¬‡ï¸  Stopping services...$(NC)"
	$(COMPOSE) down
	@echo "$(GREEN)âœ… Services stopped$(NC)"

stop: down

ps:
	@echo "$(CYAN)ğŸ“Š Service Status:$(NC)"
	$(COMPOSE) ps

rebuild: down build up migrate build-ts collectstatic
	@echo "$(GREEN)âœ… Rebuild complete!$(NC)"

clean:
	@echo "$(RED)âš ï¸  WARNING: This will remove ALL containers and volumes!$(NC)"
	@read -p "Are you absolutely sure? Type 'yes' to confirm: " confirm && \
	[ "$$confirm" = "yes" ] && \
	(echo "$(RED)ğŸ—‘ï¸  Removing containers and volumes...$(NC)" && \
	$(COMPOSE) down -v && \
	echo "$(GREEN)âœ… Cleanup complete$(NC)") || \
	echo "$(YELLOW)âŒ Cleanup cancelled$(NC)"

# ============================================
# Docker Health Check
# ============================================
docker-check-health:
	@if ! docker ps | grep -q $(WEB_CONTAINER); then \
		echo "$(RED)âŒ Web container ($(WEB_CONTAINER)) is not running!$(NC)"; \
		echo "$(YELLOW)Run 'make start' first.$(NC)"; \
		exit 1; \
	fi

# ============================================
# Django Management Commands
# ============================================
migrate: docker-check-health
	@echo "$(CYAN)ğŸ”„ Running migrations...$(NC)"
	$(COMPOSE) exec -T web python manage.py migrate
	@echo "$(GREEN)âœ… Migrations applied$(NC)"

makemigrations: docker-check-health
	@echo "$(CYAN)ğŸ“ Creating migrations...$(NC)"
	$(COMPOSE) exec -T web python manage.py makemigrations
	@echo "$(GREEN)âœ… Migrations created$(NC)"

shell: docker-check-health
	@echo "$(CYAN)ğŸ Opening Django shell...$(NC)"
	$(COMPOSE) exec web python manage.py shell

createsuperuser: docker-check-health
	@echo "$(CYAN)ğŸ‘¤ Creating superuser...$(NC)"
	$(COMPOSE) exec web python manage.py createsuperuser

build-ts:
	@echo "$(CYAN)ğŸ”¨ Building TypeScript...$(NC)"
	@cd ../../.. && cd frontend && npm run build:writer
	@echo "$(GREEN)âœ… TypeScript compiled$(NC)"

collectstatic: docker-check-health
	@echo "$(CYAN)ğŸ“¦ Collecting static files...$(NC)"
	$(COMPOSE) exec -T web python manage.py collectstatic --noinput
	@echo "$(GREEN)âœ… Static files collected$(NC)"

test: docker-check-health
	@echo "$(CYAN)ğŸ§ª Running tests...$(NC)"
	$(COMPOSE) exec -T web python manage.py test
	@echo "$(GREEN)âœ… Tests completed$(NC)"

# ============================================
# Database Commands
# ============================================
db-shell: docker-check-health
	@echo "$(CYAN)ğŸ—„ï¸  Opening PostgreSQL shell...$(NC)"
	@$(COMPOSE) exec db psql -U $${SCITEX_CLOUD_POSTGRES_USER:-scitex_dev} -d $${SCITEX_CLOUD_POSTGRES_DB:-scitex_cloud_dev}

db-reset: docker-check-health
	@echo "$(RED)âš ï¸  WARNING: This will DELETE ALL DATA in the database!$(NC)"
	@read -p "Are you absolutely sure? Type 'yes' to confirm: " confirm && \
	[ "$$confirm" = "yes" ] && \
	(echo "$(RED)ğŸ”„ Resetting database...$(NC)" && \
	$(COMPOSE) exec -T web python manage.py flush --noinput && \
	$(COMPOSE) exec -T web python manage.py migrate && \
	echo "$(GREEN)âœ… Database reset complete$(NC)") || \
	echo "$(YELLOW)âŒ Database reset cancelled$(NC)"

# ============================================
# Logs & Monitoring
# ============================================
logs:
	@echo "$(CYAN)ğŸ“‹ Showing all service logs (Ctrl+C to exit)...$(NC)"
	$(COMPOSE) logs -f

logs-web:
	@echo "$(CYAN)ğŸ“‹ Showing web container logs...$(NC)"
	$(COMPOSE) logs -f web

logs-db:
	@echo "$(CYAN)ğŸ“‹ Showing database logs...$(NC)"
	$(COMPOSE) logs -f db

logs-gitea:
	@echo "$(CYAN)ğŸ“‹ Showing Gitea logs...$(NC)"
	$(COMPOSE) logs -f gitea

logs-redis:
	@echo "$(CYAN)ğŸ“‹ Showing Redis logs...$(NC)"
	$(COMPOSE) logs -f redis

# ============================================
# Shell Access
# ============================================
exec-web: docker-check-health
	@echo "$(CYAN)ğŸ³ Opening shell in web container...$(NC)"
	$(COMPOSE) exec web /bin/bash

exec-db: docker-check-health
	@echo "$(CYAN)ğŸ³ Opening shell in database container...$(NC)"
	$(COMPOSE) exec db /bin/sh

exec-gitea: docker-check-health
	@echo "$(CYAN)ğŸ³ Opening shell in Gitea container...$(NC)"
	$(COMPOSE) exec gitea /bin/sh

# ============================================
# Gitea Management
# ============================================
gitea-token: docker-check-health
	@echo "$(CYAN)ğŸ”‘ Setting up Gitea API token...$(NC)"
	cd $(CURDIR) && bash $(CURDIR)/start.sh -a setup_gitea_token

verify-gitea: docker-check-health
	@echo "$(CYAN)ğŸ” Verifying Gitea API access...$(NC)"
	cd $(CURDIR) && bash $(CURDIR)/start.sh -a verify_gitea_api

recreate-testuser: docker-check-health
	@echo "$(CYAN)ğŸ‘¤ Recreating test user...$(NC)"
	cd $(CURDIR) && bash $(CURDIR)/start.sh -a recreate_test_user

# ============================================
# Environment & Utilities
# ============================================
verify-env:
	@echo "$(CYAN)ğŸ” Verifying environment setup...$(NC)"
	cd $(CURDIR) && bash $(CURDIR)/start.sh -a verify_env_setup

list-env:
	@echo "$(CYAN)ğŸ“ Environment Variables:$(NC)"
	cd $(CURDIR) && bash $(CURDIR)/start.sh -a list_env

clean-python:
	@echo "$(CYAN)ğŸ§¹ Cleaning Python cache files...$(NC)"
	find ../../ -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
	find ../../ -type f -name "*.pyc" -delete
	find ../../ -type d -name .pytest_cache -exec rm -rf {} + 2>/dev/null || true
	@echo "$(GREEN)âœ… Python cache cleaned$(NC)"

# ============================================
# Development Workflow Shortcuts
# ============================================
dev: start migrate collectstatic
	@echo "$(GREEN)âœ… Development environment ready!$(NC)"
	@echo "$(GREEN)ğŸ“ Django: http://localhost:8000$(NC)"
	@echo "$(GREEN)ğŸ“ Gitea:  http://localhost:3000$(NC)"

update: restart
	@echo "$(GREEN)âœ… Services updated$(NC)"

reset: down clean start migrate collectstatic
	@echo "$(GREEN)âœ… Environment reset complete$(NC)"

# EOF
