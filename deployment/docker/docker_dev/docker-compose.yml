# Timestamp: "2025-11-01 16:05:04 (ywatanabe)"
# File: ./deployment/docker/docker_dev/docker-compose.yml
# ============================================
# SciTeX Cloud - Development Environment
# ============================================

# Set project name with environment for clear identification
name: scitex-cloud-dev

services:
  # ============================================
  # Django Application
  # ============================================
  web:
    build:
      context: ../../..
      dockerfile: deployment/docker/docker_dev/Dockerfile
      cache_from:
        - scitex-cloud-dev-web:latest
      args:
        BUILDKIT_INLINE_CACHE: 1
    image: scitex-cloud-dev-web:latest

    # Volumes - Live code reload
    volumes:
      # Main application code (hot reload with cached mode for performance)
      - ../../..:/app:cached

      # scitex-code package (editable mode) - must exist in parent directory of scitex-cloud
      - ../../../../scitex-code:/scitex-code:cached

      # Centralized logging - all container logs go here
      - ../../../logs:/app/logs

      # Persistent data
      - static_volume:/app/staticfiles
      - media_volume:/app/media

      # Cache volumes (speed up rebuilds) - exclude from host mount
      - uv_cache:/root/.cache/uv
      - playwright_cache:/root/.cache/ms-playwright

      # scitex.writer container cache (optional but recommended)
      - ../../../.cache/containers:/app/.cache/containers

      # Docker socket for user workspace management
      - /var/run/docker.sock:/var/run/docker.sock

      # User workspace data directory (also serves as user home via symlink)
      - ../../../data/users:/app/data/users

      # Explicitly exclude generated files from host mount (performance)
      - /app/staticfiles
      - /app/.cache
    
    # Port mapping
    ports:
      - "${SCITEX_CLOUD_HTTP_PORT_DEV:-8000}:8000"
      - "${SCITEX_CLOUD_SSH_PORT_DEV:-2200}:2200"  # SSH gateway for user workspaces
    
    # Environment
    env_file:
      - .env
    
    environment:
      - SCITEX_CLOUD_DJANGO_SETTINGS_MODULE=config.settings.settings_dev
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      # scitex.writer specific
      - SCITEX_WRITER_CACHE_DIR=/app/.cache
    
    # Service dependencies
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started
    
    # Use Django's runserver with Daphne integration (see settings_dev.py)
    # Daphne in INSTALLED_APPS makes runserver use ASGI automatically
    # Hot reload works natively with Django's autoreload + django-browser-reload
    # "from_docker" argument bypasses the manage.py wrapper safety check
    command: ["python", "manage.py", "runserver", "0.0.0.0:8000", "from_docker"]

    # Allow access to host hardware for monitoring
    privileged: true

    # Allow access to host services (SSH, etc.)
    extra_hosts:
      - "host.docker.internal:host-gateway"

    # Restart policy
    restart: unless-stopped

    # Health check (faster intervals for dev)
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 60s
    
    # Network
    networks:
      - scitex-dev

  # ============================================
  # PostgreSQL Database
  # ============================================
  db:
    image: postgres:15-alpine

    volumes:
      - postgres_data:/var/lib/postgresql/data

    # Shared memory for Postgres performance (prevents "out of shared memory" errors)
    shm_size: 256mb

    # Port mapping (avoid conflict with host postgres)
    ports:
      - "5433:5432"

    env_file:
      - .env

    environment:
      # PostgreSQL expects POSTGRES_* variables (not SCITEX_CLOUD_POSTGRES_*)
      - POSTGRES_DB=${SCITEX_CLOUD_POSTGRES_DB:-scitex_cloud_dev}
      - POSTGRES_USER=${SCITEX_CLOUD_POSTGRES_USER:-scitex_dev}
      - POSTGRES_PASSWORD=${SCITEX_CLOUD_POSTGRES_PASSWORD:-scitex_dev_2025}

    restart: unless-stopped
    
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${SCITEX_CLOUD_POSTGRES_USER:-scitex_dev} -d ${SCITEX_CLOUD_POSTGRES_DB:-scitex_cloud_dev}"]
      interval: 10s
      timeout: 3s
      retries: 5
    
    networks:
      - scitex-dev

  # ============================================
  # Redis Cache
  # ============================================
  redis:
    image: redis:7-alpine
    
    volumes:
      - redis_data:/data
    
    ports:
      - "6379:6379"
    
    command: redis-server --appendonly yes
    
    restart: unless-stopped
    
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    
    networks:
      - scitex-dev

  # ============================================
  # Celery Worker (Async Task Processing)
  # ============================================
  celery_worker:
    build:
      context: ../../..
      dockerfile: deployment/docker/docker_dev/Dockerfile
      cache_from:
        - scitex-cloud-dev-web:latest
    image: scitex-cloud-dev-web:latest

    volumes:
      - ../../..:/app:cached
      - ../../../../scitex-code:/scitex-code:cached
      - ../../../logs:/app/logs

    env_file:
      - .env

    environment:
      - SCITEX_CLOUD_DJANGO_SETTINGS_MODULE=config.settings.settings_dev
      - PYTHONUNBUFFERED=1

    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started

    # Run Celery worker with all queues
    command: >
      celery -A config worker
      --loglevel=info
      --queues=celery,ai_queue,search_queue,compute_queue,vis_queue
      --concurrency=4
      --prefetch-multiplier=1

    restart: unless-stopped

    networks:
      - scitex-dev

  # ============================================
  # Celery Beat (Periodic Task Scheduler)
  # ============================================
  celery_beat:
    build:
      context: ../../..
      dockerfile: deployment/docker/docker_dev/Dockerfile
      cache_from:
        - scitex-cloud-dev-web:latest
    image: scitex-cloud-dev-web:latest

    volumes:
      - ../../..:/app:cached
      - ../../../../scitex-code:/scitex-code:cached
      - ../../../logs:/app/logs

    env_file:
      - .env

    environment:
      - SCITEX_CLOUD_DJANGO_SETTINGS_MODULE=config.settings.settings_dev
      - PYTHONUNBUFFERED=1

    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started

    # Run Celery beat scheduler
    command: celery -A config beat --loglevel=info --scheduler=django_celery_beat.schedulers:DatabaseScheduler

    restart: unless-stopped

    networks:
      - scitex-dev

  # ============================================
  # Flower (Celery Monitoring Dashboard)
  # ============================================
  flower:
    build:
      context: ../../..
      dockerfile: deployment/docker/docker_dev/Dockerfile
      cache_from:
        - scitex-cloud-dev-web:latest
    image: scitex-cloud-dev-web:latest

    volumes:
      - ../../..:/app:cached
      - ../../../../scitex-code:/scitex-code:cached

    ports:
      - "5555:5555"

    env_file:
      - .env

    environment:
      - SCITEX_CLOUD_DJANGO_SETTINGS_MODULE=config.settings.settings_dev
      - PYTHONUNBUFFERED=1

    depends_on:
      - redis
      - celery_worker

    # Run Flower monitoring
    command: celery -A config flower --port=5555 --broker=redis://redis:6379/1

    restart: unless-stopped

    networks:
      - scitex-dev

  # ============================================
  # Gitea Git Server
  # ============================================
  gitea:
    image: gitea/gitea:latest
    
    volumes:
      - gitea_data:/data
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    
    ports:
      - "${SCITEX_CLOUD_GITEA_HTTP_PORT_DEV:-3001}:3000"
      - "${SCITEX_CLOUD_GITEA_SSH_PORT_DEV:-2222}:22"
    
    env_file:
      - .env
    
    environment:
      # User/Group
      - USER_UID=1000
      - USER_GID=1000
      
      # Admin account (auto-created)
      - GITEA_ADMIN_USER=${SCITEX_CLOUD_GITEA_ADMIN_USERNAME:-scitex_admin}
      - GITEA_ADMIN_PASSWD=${SCITEX_CLOUD_GITEA_ADMIN_PASSWORD:-scitex_admin_2025}
      - GITEA_ADMIN_EMAIL=${SCITEX_CLOUD_GITEA_ADMIN_EMAIL:-admin@scitex.local}
      
      # Database connection
      - GITEA__database__DB_TYPE=postgres
      - GITEA__database__HOST=db:5432
      - GITEA__database__NAME=${SCITEX_CLOUD_POSTGRES_DB:-scitex_cloud_dev}
      - GITEA__database__USER=${SCITEX_CLOUD_POSTGRES_USER:-scitex_dev}
      - GITEA__database__PASSWD=${SCITEX_CLOUD_POSTGRES_PASSWORD:-scitex_dev_2025}
      
      # Server configuration
      - GITEA__server__DOMAIN=gitea
      - GITEA__server__ROOT_URL=http://gitea:3000/
      - GITEA__server__HTTP_PORT=3000

      # Security
      - GITEA__security__INSTALL_LOCK=true
      - GITEA__service__DISABLE_REGISTRATION=false
    
    depends_on:
      db:
        condition: service_healthy
    
    restart: unless-stopped
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 30s
    
    networks:
      - scitex-dev

# ============================================
# Volumes
# ============================================
volumes:
  # Persistent data
  postgres_data:
    driver: local
  
  redis_data:
    driver: local
  
  gitea_data:
    driver: local
  
  # Application data
  static_volume:
    driver: local
  
  media_volume:
    driver: local
  
  # Cache volumes (can be deleted safely)
  uv_cache:
    driver: local
  
  playwright_cache:
    driver: local

# ============================================
# Networks
# ============================================
networks:
  scitex-dev:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

