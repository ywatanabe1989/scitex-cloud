#!/bin/bash
set -e

# ============================================
# SciTeX Package Installation
# ============================================
# Dev: Install from mounted /scitex-code (editable mode)
# Prod/NAS: Already installed from PyPI in Dockerfile

if [ -d "/scitex-code" ]; then
    echo "ğŸ“¦ Development mode: Installing scitex from /scitex-code (editable)..."
    pip install --user -e /scitex-code
    echo "âœ… Scitex package installed in editable mode!"
else
    echo "ğŸ“¦ Production mode: Using scitex from PyPI (installed in Dockerfile)"
    python -c "import scitex; print(f'âœ… Scitex {scitex.__version__} available')"
fi

# ============================================
# Database Connection
# ============================================
echo "â³ Waiting for database..."
while ! nc -z db 5432; do
  sleep 0.1
done
echo "âœ… Database is ready!"

# ============================================
# Django Setup
# ============================================
echo "ğŸ”„ Running migrations..."
python manage.py migrate --noinput

echo "ğŸ“¦ Collecting static files..."
python manage.py collectstatic --noinput

# ============================================
# Start Application
# ============================================
echo "ğŸš€ Starting application..."
exec "$@"
