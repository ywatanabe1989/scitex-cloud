# ============================================
# SciTeX Cloud - Docker Production Environment
# ============================================
# Location: /containers/docker_prod/Makefile.prod

.PHONY: help setup build build-ts start restart stop down logs ps status rebuild migrate makemigrations shell collectstatic db-shell db-backup verify-health logs-django logs-db logs-redis logs-nginx exec-django exec-db clean-python ssl-setup ssl-check ssl-create ssl-renew ssl-verify ssl-auto list-envs

.DEFAULT_GOAL := help

# ============================================
# Variables
# ============================================
COMPOSE := docker compose -f docker-compose.yml
DJANGO_CONTAINER := scitex-cloud-prod-django-1
DB_CONTAINER := scitex-cloud-prod-db-1
REDIS_CONTAINER := scitex-cloud-prod-redis-1
NGINX_CONTAINER := scitex-cloud-prod-nginx-1

# Colors for output
GREEN := \033[0;32m
YELLOW := \033[0;33m
RED := \033[0;31m
CYAN := \033[0;36m
NC := \033[0m

# ============================================
# Help (default target)
# ============================================
help:
	@echo ""
	@echo "$(GREEN)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(GREEN)â•‘          SciTeX Cloud - Production Mode               â•‘$(NC)"
	@echo "$(GREEN)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@echo "$(RED)âš ï¸  PRODUCTION ENVIRONMENT - USE WITH CAUTION âš ï¸$(NC)"
	@echo ""
	@echo "$(CYAN)ğŸš€ Deployment:$(NC)"
	@echo "  make start              - Start production services"
	@echo "  make restart            - Restart services"
	@echo "  make stop               - Stop all services"
	@echo "  make status             - Show service status"
	@echo ""
	@echo "$(CYAN)ğŸ³ Docker Management:$(NC)"
	@echo "  make build              - Build Docker images"
	@echo "  make up                 - Start services (no rebuild)"
	@echo "  make down               - Stop and remove containers"
	@echo "  make ps                 - Show container status"
	@echo "  make rebuild            - Clean rebuild (âš ï¸  CAUSES DOWNTIME)"
	@echo ""
	@echo "$(CYAN)ğŸ Django Management:$(NC)"
	@echo "  make migrate            - Run database migrations"
	@echo "  make makemigrations     - Create new migrations (dev only)"
	@echo "  make shell              - Open Django shell"
	@echo "  make collectstatic      - Collect static files"
	@echo ""
	@echo "$(CYAN)ğŸ—„ï¸  Database:$(NC)"
	@echo "  make db-shell           - PostgreSQL shell"
	@echo "  make db-backup          - Backup database"
	@echo ""
	@echo "$(CYAN)ğŸ“‹ Logs & Monitoring:$(NC)"
	@echo "  make logs               - View all service logs"
	@echo "  make logs-django        - View Django container logs"
	@echo "  make logs-db            - View database logs"
	@echo "  make logs-redis         - View Redis logs"
	@echo "  make logs-nginx         - View Nginx logs"
	@echo ""
	@echo "$(CYAN)ğŸ”§ Shell Access & Debug:$(NC)"
	@echo "  make exec-django        - Shell into Django container"
	@echo "  make exec-db            - Shell into database container"
	@echo "  make list-envs          - List environment variables"
	@echo ""
	@echo "$(CYAN)ğŸ” Health & Monitoring:$(NC)"
	@echo "  make verify-health      - Check all services health"
	@echo ""
	@echo "$(CYAN)ğŸ”’ SSL/HTTPS Management:$(NC)"
	@echo "  make ssl-auto           - Automatic SSL management (runs in start/restart)"
	@echo "  make ssl-verify         - Verify HTTPS is working"
	@echo "  make ssl-check          - Check certificate status"
	@echo "  make ssl-renew          - Renew certificates"
	@echo ""

# ============================================
# Health Check
# ============================================
docker-check-health:
	@if ! docker ps | grep -q "$(DJANGO_CONTAINER)"; then \
		echo "$(RED)âŒ Django container not running!$(NC)"; \
		echo "$(YELLOW)Run 'make start' first.$(NC)"; \
		exit 1; \
	fi

# ============================================
# Deployment Commands
# ============================================
setup: build up migrate collectstatic ssl-auto
	@echo "$(GREEN)âœ… Production setup complete!$(NC)"

start: up ssl-auto
	@echo "$(GREEN)âœ… Production services started$(NC)"

restart:
	@echo "$(CYAN)ğŸ”„ Restarting production services...$(NC)"
	$(COMPOSE) restart
	@$(MAKE) ssl-verify || true
	@echo "$(GREEN)âœ… Services restarted$(NC)"

stop: down

build:
	@echo "$(CYAN)ğŸ—ï¸  Building production images...$(NC)"
	$(COMPOSE) build --no-cache
	@echo "$(GREEN)âœ… Build complete$(NC)"

up:
	@echo "$(CYAN)â¬†ï¸  Starting production services...$(NC)"
	$(COMPOSE) up -d
	@echo "$(GREEN)âœ… Services started$(NC)"

down:
	@echo "$(YELLOW)â¬‡ï¸  Stopping production services...$(NC)"
	$(COMPOSE) down
	@echo "$(GREEN)âœ… Services stopped$(NC)"

ps:
	@echo "$(CYAN)ğŸ“Š Container Status:$(NC)"
	$(COMPOSE) ps

status: ps verify-health

rebuild:
	@echo "$(RED)âš ï¸  WARNING: This will cause production downtime!$(NC)"
	@read -p "Are you absolutely sure? Type 'yes' to confirm: " confirm && \
	[ "$$confirm" = "yes" ] && \
	(echo "$(CYAN)ğŸ”„ Rebuilding production environment...$(NC)" && \
	$(COMPOSE) down && \
	$(COMPOSE) build --no-cache && \
	$(COMPOSE) up -d && \
	make migrate && \
	make collectstatic && \
	echo "$(GREEN)âœ… Rebuild complete$(NC)") || \
	echo "$(YELLOW)âŒ Rebuild cancelled$(NC)"

# ============================================
# Django Management
# ============================================
migrate: docker-check-health
	@echo "$(CYAN)ğŸ”„ Running migrations (production)...$(NC)"
	$(COMPOSE) exec -T django python manage.py migrate
	@echo "$(GREEN)âœ… Migrations applied$(NC)"

makemigrations: docker-check-health
	@echo "$(RED)âš ï¸  WARNING: This should be done in development!$(NC)"
	@read -p "Continue anyway? Type 'yes' to confirm: " confirm && \
	[ "$$confirm" = "yes" ] && \
	$(COMPOSE) exec -T django python manage.py makemigrations || \
	echo "$(YELLOW)âŒ Cancelled$(NC)"

shell: docker-check-health
	@echo "$(CYAN)ğŸ Opening Django shell (production)...$(NC)"
	@echo "$(YELLOW)âš ï¸  BE CAREFUL - This is production!$(NC)"
	$(COMPOSE) exec django python manage.py shell

build-ts:
	@echo "$(CYAN)ğŸ”¨ Building TypeScript...$(NC)"
	@cd ../../.. && cd tsconfig && npm install --silent && npm run build:all
	@echo "$(GREEN)âœ… TypeScript compiled$(NC)"

collectstatic: docker-check-health build-ts
	@echo "$(CYAN)ğŸ“¦ Collecting static files...$(NC)"
	$(COMPOSE) exec -T django python manage.py collectstatic --noinput
	@echo "$(GREEN)âœ… Static files collected$(NC)"

# ============================================
# Database Commands
# ============================================
db-shell: docker-check-health
	@echo "$(CYAN)ğŸ—„ï¸  Opening PostgreSQL shell (production)...$(NC)"
	@echo "$(YELLOW)âš ï¸  BE CAREFUL - This is production!$(NC)"
	@$(COMPOSE) exec db psql -U $${SCITEX_CLOUD_POSTGRES_USER} -d $${SCITEX_CLOUD_POSTGRES_DB}

db-backup: docker-check-health
	@echo "$(CYAN)ğŸ’¾ Backing up production database...$(NC)"
	@mkdir -p ../../backups
	@BACKUP_FILE="../../backups/scitex_prod_$$(date +%Y%m%d_%H%M%S).sql" && \
	$(COMPOSE) exec -T db pg_dump -U $${SCITEX_CLOUD_POSTGRES_USER} $${SCITEX_CLOUD_POSTGRES_DB} > $$BACKUP_FILE && \
	gzip $$BACKUP_FILE && \
	echo "$(GREEN)âœ… Backup saved to: $$BACKUP_FILE.gz$(NC)"

# ============================================
# Logs & Monitoring
# ============================================
logs:
	@echo "$(CYAN)ğŸ“‹ Showing production logs (Ctrl+C to exit)...$(NC)"
	$(COMPOSE) logs -f --tail=100

logs-django:
	@echo "$(CYAN)ğŸ“‹ Showing Django logs...$(NC)"
	$(COMPOSE) logs -f --tail=100 django

logs-db:
	@echo "$(CYAN)ğŸ“‹ Showing database logs...$(NC)"
	$(COMPOSE) logs -f --tail=100 db

logs-redis:
	@echo "$(CYAN)ğŸ“‹ Showing Redis logs...$(NC)"
	$(COMPOSE) logs -f --tail=100 redis

logs-nginx:
	@echo "$(CYAN)ğŸ“‹ Showing Nginx logs...$(NC)"
	$(COMPOSE) logs -f --tail=100 nginx 2>/dev/null || echo "$(YELLOW)Nginx not configured$(NC)"

# ============================================
# Shell Access
# ============================================
exec-django: docker-check-health
	@echo "$(CYAN)ğŸ³ Opening shell in Django container...$(NC)"
	$(COMPOSE) exec django /bin/bash

exec-db: docker-check-health
	@echo "$(CYAN)ğŸ³ Opening shell in database container...$(NC)"
	$(COMPOSE) exec db /bin/sh

# ============================================
# Health & Monitoring
# ============================================
verify-health:
	@echo "$(CYAN)ğŸ” Checking service health...$(NC)"
	@$(COMPOSE) ps | grep -E "(healthy|Up)" && \
		echo "$(GREEN)âœ… All services healthy$(NC)" || \
		echo "$(RED)âŒ Some services unhealthy$(NC)"

# ============================================
# Utilities
# ============================================
clean-python:
	@echo "$(CYAN)ğŸ§¹ Cleaning Python cache files...$(NC)"
	find ../../ -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
	find ../../ -type f -name "*.pyc" -delete
	@echo "$(GREEN)âœ… Python cache cleaned$(NC)"

# ============================================
# SSL/HTTPS Management (Automatic)
# ============================================

# Check if SSL certificates exist and are valid
ssl-check:
	@echo "$(CYAN)ğŸ” Checking SSL certificates...$(NC)"
	@bash -c 'if [ -f ".env" ]; then source .env; fi; \
	DOMAIN=$${SCITEX_CLOUD_DOMAIN:-scitex.ai}; \
	if docker exec scitex-cloud-prod-nginx test -f /etc/nginx/ssl/live/$$DOMAIN/fullchain.pem 2>/dev/null; then \
		echo "âœ… Certificates exist for $$DOMAIN"; \
		$(COMPOSE) run --rm --entrypoint "certbot" certbot certificates 2>/dev/null | grep -E "Certificate Name|Expiry Date" || true; \
	else \
		echo "âš ï¸  No certificates found for $$DOMAIN"; \
		exit 1; \
	fi'

# Create new SSL certificates (non-interactive)
ssl-create:
	@echo "$(CYAN)ğŸ”’ Creating SSL certificates...$(NC)"
	@bash -c 'if [ -f ".env" ]; then source .env; fi && \
	$(COMPOSE) run --rm --entrypoint "certbot" certbot certonly \
		--webroot -w /var/www/certbot \
		--email $${SCITEX_CLOUD_EMAIL_ADMIN:-admin@$${SCITEX_CLOUD_DOMAIN:-scitex.ai}} \
		--agree-tos --no-eff-email --non-interactive \
		-d $${SCITEX_CLOUD_DOMAIN:-scitex.ai} \
		-d $${SCITEX_CLOUD_GIT_DOMAIN:-git.scitex.ai} && \
	echo "$(GREEN)âœ… Certificates created$(NC)" || \
	echo "$(RED)âŒ Certificate creation failed$(NC)"'

# Enable HTTPS in nginx configuration
ssl-enable:
	@echo "$(CYAN)ğŸ”§ Enabling HTTPS in nginx configuration...$(NC)"
	@bash nginx/enable_https.sh
	@echo "$(CYAN)â³ Waiting for nginx to be ready...$(NC)"
	@for i in 1 2 3 4 5; do \
		if docker ps --filter "name=scitex-cloud-prod-nginx" --filter "status=running" | grep -q scitex-cloud-prod-nginx; then \
			break; \
		fi; \
		echo "  Waiting... ($$i/5)"; \
		sleep 2; \
	done
	@if docker ps --filter "name=scitex-cloud-prod-nginx" --filter "status=running" | grep -q scitex-cloud-prod-nginx; then \
		$(COMPOSE) exec nginx nginx -t && \
		$(COMPOSE) exec nginx nginx -s reload && \
		echo "$(GREEN)âœ… HTTPS enabled$(NC)"; \
	else \
		echo "$(YELLOW)âš ï¸  Nginx not ready yet - config updated but not reloaded$(NC)"; \
		echo "$(YELLOW)Run 'make restart' to apply changes$(NC)"; \
	fi

# Renew SSL certificates
ssl-renew:
	@echo "$(CYAN)ğŸ”„ Renewing SSL certificates...$(NC)"
	@$(COMPOSE) run --rm --entrypoint "certbot" certbot renew && \
	$(COMPOSE) exec nginx nginx -s reload && \
	echo "$(GREEN)âœ… Certificates renewed$(NC)"

# Verify HTTPS is working
ssl-verify:
	@echo "$(CYAN)ğŸ” Verifying HTTPS...$(NC)"
	@bash -c 'set -e; \
	if [ -f ".env" ]; then source .env; fi; \
	MAIN_DOMAIN=$${SCITEX_CLOUD_DOMAIN:-scitex.ai}; \
	GIT_DOMAIN=$${SCITEX_CLOUD_GIT_DOMAIN:-git.scitex.ai}; \
	echo "  Testing https://$$MAIN_DOMAIN..."; \
	STATUS=$$(curl -sI https://$$MAIN_DOMAIN 2>/dev/null | head -1 | grep -o "[0-9]\{3\}"); \
	if [ "$$STATUS" = "200" ]; then \
		echo "  âœ… https://$$MAIN_DOMAIN â†’ $$STATUS"; \
	else \
		echo "  âŒ https://$$MAIN_DOMAIN â†’ $$STATUS"; \
	fi; \
	echo "  Testing https://$$GIT_DOMAIN..."; \
	STATUS=$$(curl -sI https://$$GIT_DOMAIN 2>/dev/null | head -1 | grep -o "[0-9]\{3\}"); \
	if [ "$$STATUS" = "200" ]; then \
		echo "  âœ… https://$$GIT_DOMAIN â†’ $$STATUS"; \
	else \
		echo "  âŒ https://$$GIT_DOMAIN â†’ $$STATUS"; \
	fi; \
	echo "  Testing HTTPâ†’HTTPS redirect..."; \
	REDIRECT=$$(curl -sI http://$$MAIN_DOMAIN 2>/dev/null | grep -o "301\|302"); \
	if [ -n "$$REDIRECT" ]; then \
		echo "  âœ… HTTP redirects to HTTPS ($$REDIRECT)"; \
	else \
		echo "  âš ï¸  No HTTP redirect"; \
	fi'

# Automatic SSL management (integrated into start/restart)
ssl-auto:
	@echo "$(CYAN)ğŸ¤– Automatic SSL management...$(NC)"
	@bash -c 'if [ -f ".env" ]; then source .env; fi; \
	MAIN_DOMAIN=$${SCITEX_CLOUD_DOMAIN:-scitex.ai}; \
	if ! docker exec scitex-cloud-prod-nginx test -f /etc/nginx/ssl/live/$$MAIN_DOMAIN/fullchain.pem 2>/dev/null; then \
		echo "âš ï¸  No certificates found - creating..."; \
		$(MAKE) ssl-create && $(MAKE) ssl-enable; \
	else \
		echo "âœ… Certificates already exist"; \
		$(MAKE) ssl-verify || true; \
	fi'

# Manual SSL setup (interactive - for initial setup)
ssl-setup:
	@echo "$(CYAN)ğŸ”’ Setting up SSL/HTTPS (interactive)...$(NC)"
	@bash $(CURDIR)/nginx/setup_nginx.sh

# ============================================
# Utilities
# ============================================

# List environment variables in Django container
list-envs:
	@echo "$(CYAN)ğŸ” Environment variables in Django container:$(NC)"
	@echo ""
	@echo "$(CYAN)â”â”â” SCITEX_CLOUD_* variables â”â”â”$(NC)"
	@$(COMPOSE) exec -T django env | grep "^SCITEX_CLOUD_" | sort || true
	@echo ""
	@echo "$(CYAN)â”â”â” SCITEX_* variables (non-CLOUD) â”â”â”$(NC)"
	@$(COMPOSE) exec -T django env | grep "^SCITEX_" | grep -v "^SCITEX_CLOUD_" | sort || true
	@echo ""
	@echo "$(CYAN)â”â”â” SCITEX_CLOUD_EMAIL_* variables â”â”â”$(NC)"
	@$(COMPOSE) exec -T django env | grep "^SCITEX_CLOUD_EMAIL_" | sort || true
	@echo ""
	@echo "$(CYAN)â”â”â” Django variables â”â”â”$(NC)"
	@$(COMPOSE) exec -T django env | grep -E "^(DEBUG|DJANGO_|SCITEX_CLOUD_DJANGO_SECRET_KEY|SCITEX_CLOUD_ALLOWED_HOSTS|SCITEX_CLOUD_POSTGRES_URL|SCITEX_CLOUD_REDIS_URL)" | sort || true
	@echo ""
	@echo "$(CYAN)â”â”â” Database variables â”â”â”$(NC)"
	@$(COMPOSE) exec -T django env | grep -E "^(POSTGRES_|DB_)" | sort || true

# EOF

