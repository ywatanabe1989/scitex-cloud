# ============================================
# SciTeX Cloud - Docker Production Environment
# ============================================
# Location: /containers/docker_prod/Makefile.prod

.PHONY: help setup build start restart stop down logs ps status rebuild migrate makemigrations shell collectstatic db-shell db-backup verify-health logs-web logs-db logs-redis logs-nginx exec-web exec-db clean-python

.DEFAULT_GOAL := help

# ============================================
# Variables
# ============================================
COMPOSE := docker compose -f docker-compose.yml
WEB_CONTAINER := scitex-cloud-prod-web-1
DB_CONTAINER := scitex-cloud-prod-db-1
REDIS_CONTAINER := scitex-cloud-prod-redis-1
NGINX_CONTAINER := scitex-cloud-prod-nginx-1

# Colors for output
GREEN := \033[0;32m
YELLOW := \033[0;33m
RED := \033[0;31m
CYAN := \033[0;36m
NC := \033[0m

# ============================================
# Help (default target)
# ============================================
help:
	@echo ""
	@echo "$(GREEN)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(GREEN)â•‘          SciTeX Cloud - Production Mode               â•‘$(NC)"
	@echo "$(GREEN)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@echo "$(RED)âš ï¸  PRODUCTION ENVIRONMENT - USE WITH CAUTION âš ï¸$(NC)"
	@echo ""
	@echo "$(CYAN)ðŸš€ Deployment:$(NC)"
	@echo "  make start              - Start production services"
	@echo "  make restart            - Restart services"
	@echo "  make stop               - Stop all services"
	@echo "  make status             - Show service status"
	@echo ""
	@echo "$(CYAN)ðŸ³ Docker Management:$(NC)"
	@echo "  make build              - Build Docker images"
	@echo "  make up                 - Start services (no rebuild)"
	@echo "  make down               - Stop and remove containers"
	@echo "  make ps                 - Show container status"
	@echo "  make rebuild            - Clean rebuild (âš ï¸  CAUSES DOWNTIME)"
	@echo ""
	@echo "$(CYAN)ðŸ Django Management:$(NC)"
	@echo "  make migrate            - Run database migrations"
	@echo "  make makemigrations     - Create new migrations (dev only)"
	@echo "  make shell              - Open Django shell"
	@echo "  make collectstatic      - Collect static files"
	@echo ""
	@echo "$(CYAN)ðŸ—„ï¸  Database:$(NC)"
	@echo "  make db-shell           - PostgreSQL shell"
	@echo "  make db-backup          - Backup database"
	@echo ""
	@echo "$(CYAN)ðŸ“‹ Logs & Monitoring:$(NC)"
	@echo "  make logs               - View all service logs"
	@echo "  make logs-web           - View web container logs"
	@echo "  make logs-db            - View database logs"
	@echo "  make logs-redis         - View Redis logs"
	@echo "  make logs-nginx         - View Nginx logs"
	@echo ""
	@echo "$(CYAN)ðŸ”§ Shell Access:$(NC)"
	@echo "  make exec-web           - Shell into web container"
	@echo "  make exec-db            - Shell into database container"
	@echo ""
	@echo "$(CYAN)ðŸ” Health & Monitoring:$(NC)"
	@echo "  make verify-health      - Check all services health"
	@echo ""

# ============================================
# Health Check
# ============================================
docker-check-health:
	@if ! docker ps | grep -q "$(WEB_CONTAINER)"; then \
		echo "$(RED)âŒ Web container not running!$(NC)"; \
		echo "$(YELLOW)Run 'make start' first.$(NC)"; \
		exit 1; \
	fi

# ============================================
# Deployment Commands
# ============================================
setup: build up migrate collectstatic
	@echo "$(GREEN)âœ… Production setup complete!$(NC)"
	@echo "$(YELLOW)âš ï¸  Remember to configure SSL and domain settings$(NC)"

start: up
	@echo "$(GREEN)âœ… Production services started$(NC)"

restart:
	@echo "$(CYAN)ðŸ”„ Restarting production services...$(NC)"
	$(COMPOSE) restart
	@echo "$(GREEN)âœ… Services restarted$(NC)"

stop: down

build:
	@echo "$(CYAN)ðŸ—ï¸  Building production images...$(NC)"
	$(COMPOSE) build --no-cache
	@echo "$(GREEN)âœ… Build complete$(NC)"

up:
	@echo "$(CYAN)â¬†ï¸  Starting production services...$(NC)"
	$(COMPOSE) up -d
	@echo "$(GREEN)âœ… Services started$(NC)"

down:
	@echo "$(YELLOW)â¬‡ï¸  Stopping production services...$(NC)"
	$(COMPOSE) down
	@echo "$(GREEN)âœ… Services stopped$(NC)"

ps:
	@echo "$(CYAN)ðŸ“Š Container Status:$(NC)"
	$(COMPOSE) ps

status: ps verify-health

rebuild:
	@echo "$(RED)âš ï¸  WARNING: This will cause production downtime!$(NC)"
	@read -p "Are you absolutely sure? Type 'yes' to confirm: " confirm && \
	[ "$$confirm" = "yes" ] && \
	(echo "$(CYAN)ðŸ”„ Rebuilding production environment...$(NC)" && \
	$(COMPOSE) down && \
	$(COMPOSE) build --no-cache && \
	$(COMPOSE) up -d && \
	make migrate && \
	make collectstatic && \
	echo "$(GREEN)âœ… Rebuild complete$(NC)") || \
	echo "$(YELLOW)âŒ Rebuild cancelled$(NC)"

# ============================================
# Django Management
# ============================================
migrate: docker-check-health
	@echo "$(CYAN)ðŸ”„ Running migrations (production)...$(NC)"
	$(COMPOSE) exec -T web python manage.py migrate
	@echo "$(GREEN)âœ… Migrations applied$(NC)"

makemigrations: docker-check-health
	@echo "$(RED)âš ï¸  WARNING: This should be done in development!$(NC)"
	@read -p "Continue anyway? Type 'yes' to confirm: " confirm && \
	[ "$$confirm" = "yes" ] && \
	$(COMPOSE) exec -T web python manage.py makemigrations || \
	echo "$(YELLOW)âŒ Cancelled$(NC)"

shell: docker-check-health
	@echo "$(CYAN)ðŸ Opening Django shell (production)...$(NC)"
	@echo "$(YELLOW)âš ï¸  BE CAREFUL - This is production!$(NC)"
	$(COMPOSE) exec web python manage.py shell

collectstatic: docker-check-health
	@echo "$(CYAN)ðŸ“¦ Collecting static files...$(NC)"
	$(COMPOSE) exec -T web python manage.py collectstatic --noinput
	@echo "$(GREEN)âœ… Static files collected$(NC)"

# ============================================
# Database Commands
# ============================================
db-shell: docker-check-health
	@echo "$(CYAN)ðŸ—„ï¸  Opening PostgreSQL shell (production)...$(NC)"
	@echo "$(YELLOW)âš ï¸  BE CAREFUL - This is production!$(NC)"
	@$(COMPOSE) exec db psql -U $${POSTGRES_USER} -d $${POSTGRES_DB}

db-backup: docker-check-health
	@echo "$(CYAN)ðŸ’¾ Backing up production database...$(NC)"
	@mkdir -p ../../backups
	@BACKUP_FILE="../../backups/scitex_prod_$$(date +%Y%m%d_%H%M%S).sql" && \
	$(COMPOSE) exec -T db pg_dump -U $${POSTGRES_USER} $${POSTGRES_DB} > $$BACKUP_FILE && \
	gzip $$BACKUP_FILE && \
	echo "$(GREEN)âœ… Backup saved to: $$BACKUP_FILE.gz$(NC)"

# ============================================
# Logs & Monitoring
# ============================================
logs:
	@echo "$(CYAN)ðŸ“‹ Showing production logs (Ctrl+C to exit)...$(NC)"
	$(COMPOSE) logs -f --tail=100

logs-web:
	@echo "$(CYAN)ðŸ“‹ Showing web logs...$(NC)"
	$(COMPOSE) logs -f --tail=100 web

logs-db:
	@echo "$(CYAN)ðŸ“‹ Showing database logs...$(NC)"
	$(COMPOSE) logs -f --tail=100 db

logs-redis:
	@echo "$(CYAN)ðŸ“‹ Showing Redis logs...$(NC)"
	$(COMPOSE) logs -f --tail=100 redis

logs-nginx:
	@echo "$(CYAN)ðŸ“‹ Showing Nginx logs...$(NC)"
	$(COMPOSE) logs -f --tail=100 nginx 2>/dev/null || echo "$(YELLOW)Nginx not configured$(NC)"

# ============================================
# Shell Access
# ============================================
exec-web: docker-check-health
	@echo "$(CYAN)ðŸ³ Opening shell in web container...$(NC)"
	$(COMPOSE) exec web /bin/bash

exec-db: docker-check-health
	@echo "$(CYAN)ðŸ³ Opening shell in database container...$(NC)"
	$(COMPOSE) exec db /bin/sh

# ============================================
# Health & Monitoring
# ============================================
verify-health:
	@echo "$(CYAN)ðŸ” Checking service health...$(NC)"
	@$(COMPOSE) ps | grep -E "(healthy|Up)" && \
		echo "$(GREEN)âœ… All services healthy$(NC)" || \
		echo "$(RED)âŒ Some services unhealthy$(NC)"

# ============================================
# Utilities
# ============================================
clean-python:
	@echo "$(CYAN)ðŸ§¹ Cleaning Python cache files...$(NC)"
	find ../../ -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
	find ../../ -type f -name "*.pyc" -delete
	@echo "$(GREEN)âœ… Python cache cleaned$(NC)"

# EOF
