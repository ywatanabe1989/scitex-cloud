#!/bin/bash

# SciTeX-Cloud Start Script
# Based on best practices from airight project

APP_HOME="/home/ywatanabe/proj/SciTeX-Cloud"
PYTHON_BIN="$APP_HOME/env/bin/python"
MANAGE_PY="$PYTHON_BIN manage.py"
LOG_DIR="$APP_HOME/logs"
PID_FILE="$APP_HOME/run/scitex.pid"

# Create necessary directories
mkdir -p "$LOG_DIR" "$APP_HOME/run"

usage() {
    echo "Usage: $0 [OPTIONS]"
    echo "Options:"
    echo "  -m, --migrate          Run database migrations"
    echo "  -c, --collect-static   Collect static files"
    echo "  -p, --production       Start in production mode"
    echo "  -d, --daemon           Run in background (daemon mode)"
    echo "  -h, --help             Show this help message"
    echo
    echo "Description:"
    echo "  This script manages Django project tasks and server startup."
    echo "  Without options, it starts the development server."
    echo
    echo "Examples:"
    echo "  $0                     # Start development server"
    echo "  $0 -m -c               # Migrate, collect static, start dev server"
    echo "  $0 -p                  # Start production server with uwsgi"
    echo "  $0 -d                  # Start dev server in background"
    exit 1
}

# Ensure proper file permissions
ensure_permissions() {
    chmod 755 "$APP_HOME/scripts"/*.sh 2>/dev/null || true
    chmod 755 "$APP_HOME/manage.py" 2>/dev/null || true
}

# Run database migrations
migrate() {
    echo "Running database migrations..."
    $MANAGE_PY makemigrations
    $MANAGE_PY migrate
}

# Collect static files
collect_static() {
    echo "Collecting static files..."
    $MANAGE_PY collectstatic --noinput
}

# Stop any existing servers
stop_existing() {
    # Kill existing Django processes
    lsof -ti:8000 | xargs kill -9 2>/dev/null || true
    
    # Kill existing uwsgi processes
    pkill -f "uwsgi.*scitex" 2>/dev/null || true
    
    # Remove PID file
    rm -f "$PID_FILE"
    
    # Remove uwsgi socket
    rm -f "$APP_HOME/run/uwsgi.sock"
    
    echo "Stopped existing processes"
}

# Start development server
start_dev() {
    echo "Starting SciTeX-Cloud development server..."
    
    if [[ "$1" == "daemon" ]]; then
        nohup $MANAGE_PY runserver 0.0.0.0:8000 > "$LOG_DIR/django.log" 2>&1 &
        echo $! > "$PID_FILE"
        echo "Development server started in background (PID: $(cat $PID_FILE))"
        echo "Logs: tail -f $LOG_DIR/django.log"
    else
        echo "Starting at http://localhost:8000"
        echo "Press Ctrl+C to stop"
        $MANAGE_PY runserver 0.0.0.0:8000
    fi
}

# Start production server with uwsgi
start_prod() {
    echo "Starting SciTeX-Cloud production server..."
    
    # Ensure nginx is configured
    if ! nginx -t 2>/dev/null; then
        echo "Warning: Nginx configuration not found or invalid"
        echo "Please configure nginx before running in production"
    fi
    
    # Start uwsgi
    "$APP_HOME/env/bin/uwsgi" --ini "$APP_HOME/config/uwsgi.ini" \
        --daemonize "$LOG_DIR/uwsgi.log" \
        --pidfile "$PID_FILE"
    
    echo "Production server started with uwsgi"
    echo "Logs: tail -f $LOG_DIR/uwsgi.log"
}

# Main function
main() {
    local do_migrate=false
    local do_collect_static=false
    local is_prod=false
    local is_daemon=false

    # Parse command line arguments
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -m|--migrate) do_migrate=true ;;
            -c|--collect-static) do_collect_static=true ;;
            -p|--production) is_prod=true ;;
            -d|--daemon) is_daemon=true ;;
            -h|--help) usage ;;
            *) echo "Unknown option: $1"; usage ;;
        esac
        shift
    done

    # Activate virtual environment
    source "$APP_HOME/env/bin/activate"
    
    # Ensure permissions
    ensure_permissions
    
    # Stop existing processes
    stop_existing
    
    # Run migrations if requested
    if $do_migrate; then
        migrate
    fi
    
    # Collect static files if requested
    if $do_collect_static; then
        collect_static
    fi
    
    # Start appropriate server
    if $is_prod; then
        # In production, always migrate and collect static
        if ! $do_migrate; then
            migrate
        fi
        if ! $do_collect_static; then
            collect_static
        fi
        start_prod
    else
        if $is_daemon; then
            start_dev "daemon"
        else
            start_dev
        fi
    fi
}

# Run main function with all arguments
main "$@"