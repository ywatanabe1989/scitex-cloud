# Timestamp: "2025-11-25 20:00:00 (ywatanabe)"
# File: ./deployment/singularity/scitex-user-workspace.def
# ============================================
# SciTeX User Workspace Container Definition
# ============================================
# This Singularity container provides a secure computational environment
# for SciTeX Cloud users. Superior to Docker for HPC integration.

Bootstrap: docker
From: python:3.11-slim

%labels
    Author SciTeX Cloud Team
    Version 1.0.0
    Description User computational workspace for SciTeX Cloud
    Documentation https://github.com/ywatanabe/scitex-cloud
    BuildDate 2025-11-25

%post
    echo "============================================"
    echo "Building SciTeX User Workspace Container"
    echo "============================================"

    # Update package lists
    apt-get update

    # Install system dependencies
    echo "Installing system dependencies..."
    apt-get install -y --no-install-recommends \
        # Development tools
        build-essential \
        git \
        wget \
        curl \
        # Text editors
        vim \
        nano \
        # Terminal utilities
        tmux \
        htop \
        tree \
        less \
        # Compression tools
        zip \
        unzip \
        bzip2 \
        # Other utilities
        ca-certificates \
        && rm -rf /var/lib/apt/lists/*

    echo "Installing Python packages..."
    # Upgrade pip
    pip install --no-cache-dir --upgrade pip setuptools wheel

    # Install Python scientific stack (pinned versions for reproducibility)
    pip install --no-cache-dir \
        # Core scientific computing
        numpy==1.26.4 \
        scipy==1.12.0 \
        pandas==2.2.0 \
        numba==0.59.0 \
        # Visualization
        matplotlib==3.8.2 \
        seaborn==0.13.2 \
        plotly==5.18.0 \
        # Machine learning
        scikit-learn==1.4.0 \
        # Interactive computing
        jupyter==1.0.0 \
        jupyterlab==4.0.11 \
        ipython==8.20.0 \
        ipdb==0.13.13 \
        # Utilities
        requests==2.31.0 \
        beautifulsoup4==4.12.3 \
        tqdm==4.66.1 \
        h5py==3.10.0 \
        PyYAML==6.0.1 \
        natsort==8.4.0 \
        # Configuration management
        hydra-core==1.3.2 \
        omegaconf==2.3.0 \
        # Development
        black==24.1.1 \
        flake8==7.0.0 \
        pytest==8.0.0 \
        icecream==2.1.3 \
        # SciTeX platform package
        scitex

    # Create workspace directory
    echo "Setting up workspace..."
    mkdir -p /workspace
    chmod 755 /workspace

    # Create logs directory
    mkdir -p /logs
    chmod 755 /logs

    echo "Build complete!"

%environment
    # Set locale
    export LC_ALL=C
    export LANG=C.UTF-8

    # Python configuration
    export PYTHONUNBUFFERED=1
    export PYTHONDONTWRITEBYTECODE=1
    export PYTHONPATH=/workspace:$PYTHONPATH

    # Path configuration
    export PATH=/usr/local/bin:$PATH

    # Workspace
    export WORKSPACE=/workspace

%runscript
    # Default: run Python script
    exec python "$@"

%startscript
    # For instance mode (if needed)
    echo "SciTeX User Workspace container started"
    exec /bin/bash

%test
    # Test the installation
    echo "Testing Python installation..."
    python --version

    echo "Testing installed packages..."
    python -c "import numpy, pandas, matplotlib; print('Core packages OK')"

    echo "Testing workspace..."
    ls -la /workspace

    echo "All tests passed!"

%help
    ========================================
    SciTeX User Workspace Container
    ========================================

    This container provides a secure Python execution environment
    for SciTeX Cloud users.

    USAGE:
        # Execute a Python script
        singularity exec scitex-user-workspace.sif python script.py

        # Execute with workspace binding
        singularity exec --bind /data:/workspace scitex-user-workspace.sif python analysis.py

        # Interactive shell
        singularity shell scitex-user-workspace.sif

    FEATURES:
        - Python 3.11 with full scientific stack
        - No root access required
        - Runs as your user (UID preserved)
        - Compatible with HPC clusters (SLURM, PBS)
        - Resource limits via cgroups

    SECURITY:
        - No daemon required
        - No privilege escalation
        - Isolated /tmp and /var/tmp (use --contain)
        - Clean environment (use --cleanenv)

    PACKAGES INCLUDED:
        - numpy, scipy, pandas
        - matplotlib, seaborn, plotly
        - scikit-learn, jupyter, ipython
        - requests, beautifulsoup4, tqdm
        - black, flake8, pytest

    BUILD:
        sudo singularity build scitex-user-workspace.sif scitex-user-workspace.def

    For more information, visit:
    https://scitex.ai/docs/user-workspace

# EOF
